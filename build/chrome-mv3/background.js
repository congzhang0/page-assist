var _background=function(){"use strict";function _mergeNamespaces(t,e){for(var s=0;s<e.length;s++){const n=e[s];if(typeof n!="string"&&!Array.isArray(n)){for(const r in n)if(r!=="default"&&!(r in t)){const a=Object.getOwnPropertyDescriptor(n,r);a&&Object.defineProperty(t,r,a.get?a:{enumerable:!0,get:()=>n[r]})}}}return Object.freeze(Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}))}function defineBackground(t){return t==null||typeof t=="function"?{main:t}:t}let currentLogLevel=1;const setLogLevel=t=>{currentLogLevel=t},formatLogMessage=(t,e,s)=>{const r=`[${new Date().toISOString()}] [${t}] [Page-Assist]`;if(s!==void 0)try{const a=typeof s=="object"?JSON.stringify(s):String(s);return`${r} ${e} - ${a}`}catch{return`${r} ${e} - [无法序列化的数据]`}return`${r} ${e}`},debug$1=(t,e)=>{currentLogLevel<=0&&console.debug(formatLogMessage("DEBUG",t,e))},info=(t,e)=>{currentLogLevel<=1&&console.info(formatLogMessage("INFO",t,e))},warn=(t,e)=>{currentLogLevel<=2&&console.warn(formatLogMessage("WARN",t,e))},error=(t,e)=>{currentLogLevel<=3&&(e instanceof Error?console.error(formatLogMessage("ERROR",t,{message:e.message,stack:e.stack,name:e.name})):console.error(formatLogMessage("ERROR",t,e)))},performance=(t,e)=>{currentLogLevel<=0&&(e==="start"?console.time(`⏱️ ${t}`):console.timeEnd(`⏱️ ${t}`))};setLogLevel(2);const logger$1={debug:debug$1,info,warn,error,performance,setLogLevel};var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function getAugmentedNamespace(t){if(t.__esModule)return t;var e=t.default;if(typeof e=="function"){var s=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};s.prototype=e.prototype}else s={};return Object.defineProperty(s,"__esModule",{value:!0}),Object.keys(t).forEach(function(n){var r=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(s,n,r.get?r:{enumerable:!0,get:function(){return t[n]}})}),s}var browserPolyfill={exports:{}};(function(t,e){(function(s,n){n(t)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:commonjsGlobal,function(s){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)s.exports=globalThis.browser;else{const n="The message port closed before a response was received.",r=a=>{const i={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(i).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class u extends WeakMap{constructor(D,F=void 0){super(F),this.createItem=D}get(D){return this.has(D)||this.set(D,this.createItem(D)),super.get(D)}}const f=S=>S&&typeof S=="object"&&typeof S.then=="function",c=(S,D)=>(...F)=>{a.runtime.lastError?S.reject(new Error(a.runtime.lastError.message)):D.singleCallbackArg||F.length<=1&&D.singleCallbackArg!==!1?S.resolve(F[0]):S.resolve(F)},d=S=>S==1?"argument":"arguments",h=(S,D)=>function(B,...W){if(W.length<D.minArgs)throw new Error(`Expected at least ${D.minArgs} ${d(D.minArgs)} for ${S}(), got ${W.length}`);if(W.length>D.maxArgs)throw new Error(`Expected at most ${D.maxArgs} ${d(D.maxArgs)} for ${S}(), got ${W.length}`);return new Promise((z,re)=>{if(D.fallbackToNoCallback)try{B[S](...W,c({resolve:z,reject:re},D))}catch(X){console.warn(`${S} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,X),B[S](...W),D.fallbackToNoCallback=!1,D.noCallback=!0,z()}else D.noCallback?(B[S](...W),z()):B[S](...W,c({resolve:z,reject:re},D))})},m=(S,D,F)=>new Proxy(D,{apply(B,W,z){return F.call(W,S,...z)}});let _=Function.call.bind(Object.prototype.hasOwnProperty);const p=(S,D={},F={})=>{let B=Object.create(null),W={has(re,X){return X in S||X in B},get(re,X,ne){if(X in B)return B[X];if(!(X in S))return;let ie=S[X];if(typeof ie=="function")if(typeof D[X]=="function")ie=m(S,S[X],D[X]);else if(_(F,X)){let te=h(X,F[X]);ie=m(S,S[X],te)}else ie=ie.bind(S);else if(typeof ie=="object"&&ie!==null&&(_(D,X)||_(F,X)))ie=p(ie,D[X],F[X]);else if(_(F,"*"))ie=p(ie,D[X],F["*"]);else return Object.defineProperty(B,X,{configurable:!0,enumerable:!0,get(){return S[X]},set(te){S[X]=te}}),ie;return B[X]=ie,ie},set(re,X,ne,ie){return X in B?B[X]=ne:S[X]=ne,!0},defineProperty(re,X,ne){return Reflect.defineProperty(B,X,ne)},deleteProperty(re,X){return Reflect.deleteProperty(B,X)}},z=Object.create(S);return new Proxy(z,W)},b=S=>({addListener(D,F,...B){D.addListener(S.get(F),...B)},hasListener(D,F){return D.hasListener(S.get(F))},removeListener(D,F){D.removeListener(S.get(F))}}),A=new u(S=>typeof S!="function"?S:function(F){const B=p(F,{},{getContent:{minArgs:0,maxArgs:0}});S(B)}),T=new u(S=>typeof S!="function"?S:function(F,B,W){let z=!1,re,X=new Promise(H=>{re=function(P){z=!0,H(P)}}),ne;try{ne=S(F,B,re)}catch(H){ne=Promise.reject(H)}const ie=ne!==!0&&f(ne);if(ne!==!0&&!ie&&!z)return!1;const te=H=>{H.then(P=>{W(P)},P=>{let C;P&&(P instanceof Error||typeof P.message=="string")?C=P.message:C="An unexpected error occurred",W({__mozWebExtensionPolyfillReject__:!0,message:C})}).catch(P=>{console.error("Failed to send onMessage rejected reply",P)})};return te(ie?ne:X),!0}),v=({reject:S,resolve:D},F)=>{a.runtime.lastError?a.runtime.lastError.message===n?D():S(new Error(a.runtime.lastError.message)):F&&F.__mozWebExtensionPolyfillReject__?S(new Error(F.message)):D(F)},N=(S,D,F,...B)=>{if(B.length<D.minArgs)throw new Error(`Expected at least ${D.minArgs} ${d(D.minArgs)} for ${S}(), got ${B.length}`);if(B.length>D.maxArgs)throw new Error(`Expected at most ${D.maxArgs} ${d(D.maxArgs)} for ${S}(), got ${B.length}`);return new Promise((W,z)=>{const re=v.bind(null,{resolve:W,reject:z});B.push(re),F.sendMessage(...B)})},x={devtools:{network:{onRequestFinished:b(A)}},runtime:{onMessage:b(T),onMessageExternal:b(T),sendMessage:N.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:N.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},y={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return i.privacy={network:{"*":y},services:{"*":y},websites:{"*":y}},p(a,x,i)};s.exports=r(chrome)}})})(browserPolyfill);var browserPolyfillExports=browserPolyfill.exports;const originalBrowser=getDefaultExportFromCjs(browserPolyfillExports),browser=originalBrowser,setTitle=({title:t})=>{chrome.action.setTitle({title:t})},setBadgeBackgroundColor=({color:t})=>{chrome.action.setBadgeBackgroundColor({color:t})},setBadgeText=({text:t})=>{chrome.action.setBadgeText({text:t})},setBadgeTextColor=({color:t})=>{chrome.action.setBadgeTextColor&&chrome.action.setBadgeTextColor({color:t})},processFunction=(t,e,s,n)=>function(...r){const a=e.promiseModule;return new a((i,u)=>{e.multiArgs?r.push((...c)=>{e.errorFirst?c[0]?u(c):(c.shift(),i(c)):i(c)}):e.errorFirst?r.push((c,d)=>{c?u(c):i(d)}):r.push(i),Reflect.apply(t,this===s?n:this,r)})},filterCache=new WeakMap;function pify(t,e){e={exclude:[/.+(?:Sync|Stream)$/],errorFirst:!0,promiseModule:Promise,...e};const s=typeof t;if(!(t!==null&&(s==="object"||s==="function")))throw new TypeError(`Expected \`input\` to be a \`Function\` or \`Object\`, got \`${t===null?"null":s}\``);const n=(i,u)=>{let f=filterCache.get(i);if(f||(f={},filterCache.set(i,f)),u in f)return f[u];const c=p=>typeof p=="string"||typeof u=="symbol"?u===p:p.test(u),d=Reflect.getOwnPropertyDescriptor(i,u),h=d===void 0||d.writable||d.configurable,_=(e.include?e.include.some(p=>c(p)):!e.exclude.some(p=>c(p)))&&h;return f[u]=_,_},r=new WeakMap,a=new Proxy(t,{apply(i,u,f){const c=r.get(i);if(c)return Reflect.apply(c,u,f);const d=e.excludeMain?i:processFunction(i,e,a,i);return r.set(i,d),Reflect.apply(d,u,f)},get(i,u){const f=i[u];if(!n(i,u)||f===Function.prototype[u])return f;const c=r.get(f);if(c)return c;if(typeof f=="function"){const d=processFunction(f,e,a,i);return r.set(f,d),d}return f}});return a}var l=()=>{try{let t=(globalThis.navigator?.userAgent).match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(t[1]==="Chrome")return parseInt(t[2])<100||globalThis.chrome.runtime?.getManifest()?.manifest_version===2}catch{return!1}return!1},o=class{#e;#t;get primaryClient(){return this.#t}#s;get secondaryClient(){return this.#s}#n;get area(){return this.#n}get hasWebApi(){try{return typeof window<"u"&&!!window.localStorage}catch(t){return console.error(t),!1}}#i=new Map;#o;get copiedKeySet(){return this.#o}isCopied=t=>this.hasWebApi&&(this.allCopied||this.copiedKeySet.has(t));#a=!1;get allCopied(){return this.#a}getExtStorageApi=()=>globalThis.browser?.storage||globalThis.chrome?.storage;get hasExtensionApi(){try{return!!this.getExtStorageApi()}catch(t){return console.error(t),!1}}isWatchSupported=()=>this.hasExtensionApi;keyNamespace="";isValidKey=t=>t.startsWith(this.keyNamespace);getNamespacedKey=t=>`${this.keyNamespace}${t}`;getUnnamespacedKey=t=>t.slice(this.keyNamespace.length);constructor({area:t="sync",allCopied:e=!1,copiedKeyList:s=[]}={}){this.setCopiedKeySet(s),this.#n=t,this.#a=e;try{this.hasWebApi&&(e||s.length>0)&&(this.#s=window.localStorage)}catch{}try{this.hasExtensionApi&&(this.#e=this.getExtStorageApi(),l()?this.#t=pify(this.#e[this.area],{exclude:["getBytesInUse"],errorFirst:!1}):this.#t=this.#e[this.area])}catch{}}setCopiedKeySet(t){this.#o=new Set(t)}rawGetAll=()=>this.#t?.get();getAll=async()=>{let t=await this.rawGetAll();return Object.entries(t).filter(([e])=>this.isValidKey(e)).reduce((e,[s,n])=>(e[this.getUnnamespacedKey(s)]=n,e),{})};copy=async t=>{let e=t===void 0;if(!e&&!this.copiedKeySet.has(t)||!this.allCopied||!this.hasExtensionApi)return!1;let s=this.allCopied?await this.rawGetAll():await this.#t.get((e?[...this.copiedKeySet]:[t]).map(this.getNamespacedKey));if(!s)return!1;let n=!1;for(let r in s){let a=s[r],i=this.#s?.getItem(r);this.#s?.setItem(r,a),n||=a!==i}return n};rawGet=async t=>this.hasExtensionApi?(await this.#t.get(t))[t]:this.isCopied(t)?this.#s?.getItem(t):null;rawSet=async(t,e)=>(this.isCopied(t)&&this.#s?.setItem(t,e),this.hasExtensionApi&&await this.#t.set({[t]:e}),null);clear=async(t=!1)=>{t&&this.#s?.clear(),await this.#t.clear()};rawRemove=async t=>{this.isCopied(t)&&this.#s?.removeItem(t),this.hasExtensionApi&&await this.#t.remove(t)};removeAll=async()=>{let t=await this.rawGetAll(),e=Object.keys(t);await Promise.all(e.map(this.rawRemove))};watch=t=>{let e=this.isWatchSupported();return e&&this.#u(t),e};#u=t=>{for(let e in t){let s=this.getNamespacedKey(e),n=this.#i.get(s)?.callbackSet||new Set;if(n.add(t[e]),n.size>1)continue;let r=(a,i)=>{if(i!==this.area||!a[s])return;let u=this.#i.get(s);if(!u)throw new Error(`Storage comms does not exist for nsKey: ${s}`);Promise.all([this.parseValue(a[s].newValue),this.parseValue(a[s].oldValue)]).then(([f,c])=>{for(let d of u.callbackSet)d({newValue:f,oldValue:c},i)})};this.#e.onChanged.addListener(r),this.#i.set(s,{callbackSet:n,listener:r})}};unwatch=t=>{let e=this.isWatchSupported();return e&&this.#c(t),e};#c(t){for(let e in t){let s=this.getNamespacedKey(e),n=t[e],r=this.#i.get(s);r&&(r.callbackSet.delete(n),r.callbackSet.size===0&&(this.#i.delete(s),this.#e.onChanged.removeListener(r.listener)))}}unwatchAll=()=>this.#r();#r(){this.#i.forEach(({listener:t})=>this.#e.onChanged.removeListener(t)),this.#i.clear()}async getItem(t){return this.get(t)}async setItem(t,e){await this.set(t,e)}async removeItem(t){return this.remove(t)}},g=class extends o{get=async t=>{let e=this.getNamespacedKey(t),s=await this.rawGet(e);return this.parseValue(s)};set=async(t,e)=>{let s=this.getNamespacedKey(t),n=JSON.stringify(e);return this.rawSet(s,n)};remove=async t=>{let e=this.getNamespacedKey(t);return this.rawRemove(e)};setNamespace=t=>{this.keyNamespace=t};parseValue=async t=>{try{if(t!==void 0)return JSON.parse(t)}catch(e){console.error(e)}}};const cleanUrl=t=>t.endsWith("/")?t.slice(0,-1):t,storage$3=new g,storage2=new g({area:"local"}),DEFAULT_URL_REWRITE_URL="http://127.0.0.1:11434",isUrlRewriteEnabled=async()=>await storage$3.get("urlRewriteEnabled")??!1,getIsAutoCORSFix=async()=>{try{return await storage2.get("autoCORSFix")??!0}catch{return!0}},getRewriteUrl=async()=>{const t=await storage$3.get("rewriteUrl");return!t||t.trim()===""?DEFAULT_URL_REWRITE_URL:t},getAdvancedOllamaSettings=async()=>{const[t,e,s]=await Promise.all([isUrlRewriteEnabled(),getRewriteUrl(),getIsAutoCORSFix()]);return{isEnableRewriteUrl:t,rewriteUrl:e,autoCORSFix:s}},customOllamaHeaders=async()=>{const t=await storage$3.get("customOllamaHeaders");return t||[]},getCustomOllamaHeaders=async()=>{const t=await customOllamaHeaders(),e={};for(const s of t)e[s.key]=s.value;return e},urlRewriteRuntime=async function(t,e="ollama"){if(browser.runtime&&browser.runtime.id){const{isEnableRewriteUrl:s,rewriteUrl:n,autoCORSFix:r}=await getAdvancedOllamaSettings();if(!r){try{await browser.declarativeNetRequest.updateDynamicRules({removeRuleIds:[1],addRules:[]})}catch{}return}{const a=new URL(t),i=[a.hostname];let u=`${a.protocol}//${a.hostname}`;s&&n&&e==="ollama"&&(u=n);const f=[{id:1,priority:1,condition:{requestDomains:i},action:{type:"modifyHeaders",requestHeaders:[{header:"Origin",operation:"set",value:u}]}}];await browser.declarativeNetRequest.updateDynamicRules({removeRuleIds:f.map(c=>c.id),addRules:f})}}};new g;const fetcher=async(t,e)=>{const s={...e},n=await getCustomOllamaHeaders();return s.headers={...n,...s?.headers},fetch(t,s)};class OpenAIModelDb{db;constructor(){this.db=chrome.storage.local}getAll=async()=>new Promise((e,s)=>{this.db.get(null,n=>{if(chrome.runtime.lastError)s(chrome.runtime.lastError);else{const r=Object.keys(n).map(a=>n[a]);e(r)}})});create=async e=>new Promise((s,n)=>{this.db.set({[e.id]:e},()=>{chrome.runtime.lastError?n(chrome.runtime.lastError):s()})});getById=async e=>new Promise((s,n)=>{this.db.get(e,r=>{chrome.runtime.lastError?n(chrome.runtime.lastError):s(r[e])})});update=async e=>new Promise((s,n)=>{this.db.set({[e.id]:e},()=>{chrome.runtime.lastError?n(chrome.runtime.lastError):s()})});delete=async e=>new Promise((s,n)=>{this.db.remove(e,()=>{chrome.runtime.lastError?n(chrome.runtime.lastError):s()})})}const getOpenAIConfigById=async t=>await new OpenAIModelDb().getById(t),DEFAULT_SYNC_CONFIG={enabled:!0,proxyEndpoint:"",retry:{maxRetries:5,initialDelay:1e3,maxDelay:6e4},retention:{expirationTime:14*24*60*60*1e3},batch:{enabled:!0,maxSize:10,batchWindow:2e3},network:{wifiOnly:!1}};async function getSyncConfig(){return new Promise(t=>{chrome.storage.local.get("syncConfig",e=>{t(e.syncConfig||DEFAULT_SYNC_CONFIG)})})}async function updateSyncConfig(t){return new Promise(e=>{chrome.storage.local.get("syncConfig",s=>{const n={...s.syncConfig||DEFAULT_SYNC_CONFIG,...t};chrome.storage.local.set({syncConfig:n},()=>{e()})})})}const DATA_PROVIDER_CONFIG_KEY="dataProviderConfig",DEFAULT_DATA_PROVIDER_CONFIG={enabled:!1,accessToken:generateAccessToken(),filters:{allowedEntityTypes:["page","document","model","knowledge","vector","message"],allowFullContent:!0},logging:{enabled:!0,retentionDays:30},sync:{defaultTimeWindow:864e5,batchEnabled:!0,batchSize:100}};function generateAccessToken(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let s="";for(let n=0;n<32;n++)s+=t.charAt(Math.floor(Math.random()*t.length));return s}async function getDataProviderConfig(){return new Promise(t=>{chrome.storage.local.get(DATA_PROVIDER_CONFIG_KEY,e=>{const s=e[DATA_PROVIDER_CONFIG_KEY];s?(logger$1.debug("获取数据提供者API配置成功"),t(s)):(logger$1.debug("数据提供者API配置不存在，使用默认配置"),t(DEFAULT_DATA_PROVIDER_CONFIG))})})}async function updateDataProviderConfig(t){const s={...await getDataProviderConfig(),...t};return new Promise((n,r)=>{chrome.storage.local.set({[DATA_PROVIDER_CONFIG_KEY]:s},()=>{chrome.runtime.lastError?(logger$1.error("更新数据提供者API配置失败",chrome.runtime.lastError),r(new Error(`更新数据提供者API配置失败: ${chrome.runtime.lastError.message}`))):(logger$1.debug("更新数据提供者API配置成功",t),n(s))})})}async function validateAccessToken(t){const e=await getDataProviderConfig();return e.enabled&&e.accessToken===t}var SyncEventType=(t=>(t.DATA_CHANGE="data-change",t.SYNC_SUCCESS="sync-success",t.SYNC_ERROR="sync-error",t.SYNC_QUEUE_UPDATED="sync-queue-updated",t.CONNECTIVITY_CHANGE="connectivity-change",t))(SyncEventType||{});class SyncEventManager{listeners={};addEventListener(e,s){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(s)}removeEventListener(e,s){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(n=>n!==s))}dispatchEvent(e){this.listeners[e.type]&&this.listeners[e.type].forEach(s=>{try{s(e.payload)}catch(n){console.error(`Error in sync event listener for ${e.type}:`,n)}})}}const syncEventManager=new SyncEventManager;class SyncQueue{queue=[];isInitialized=!1;constructor(){this.initialize()}async initialize(){if(!this.isInitialized)try{const e=await new Promise(s=>{chrome.storage.local.get("syncQueue",n=>{s(n)})});this.queue=e.syncQueue||[],this.isInitialized=!0,await this.cleanExpiredItems(),this.notifyQueueUpdated()}catch(e){console.error("Error initializing sync queue:",e),this.isInitialized=!0,this.queue=[]}}async addItem(e){await this.ensureInitialized();const s={...e,id:this.generateId(),createdAt:Date.now(),retryCount:0,priority:this.getPriorityForEntityType(e.entityType)};return this.queue.push(s),await this.persistQueue(),s.id}async getNextBatch(){await this.ensureInitialized();const e=await getSyncConfig(),s=e.batch.enabled?e.batch.maxSize:1;return[...this.queue].sort((r,a)=>r.priority-a.priority).slice(0,s)}async markSuccess(e){await this.ensureInitialized(),this.queue=this.queue.filter(s=>!e.includes(s.id)),await this.persistQueue()}async markFailure(e){await this.ensureInitialized();const s=this.queue.find(n=>n.id===e);s&&(s.retryCount++,await this.persistQueue())}async getStats(){return await this.ensureInitialized(),{total:this.queue.length,pending:this.queue.filter(e=>e.retryCount===0).length,retry:this.queue.filter(e=>e.retryCount>0).length}}async cleanExpiredItems(){await this.ensureInitialized();const e=await getSyncConfig(),s=Date.now(),n=e.retention.expirationTime,r=this.queue.length;return this.queue=this.queue.filter(a=>s-a.createdAt<n),r!==this.queue.length&&await this.persistQueue(),r-this.queue.length}async persistQueue(){return new Promise(e=>{chrome.storage.local.set({syncQueue:this.queue},()=>{this.notifyQueueUpdated(),e()})})}async ensureInitialized(){this.isInitialized||await this.initialize()}generateId(){return Date.now().toString(36)+Math.random().toString(36).substring(2)}getPriorityForEntityType(e){switch(e){case"document":return 1;case"knowledge":return 2;case"page":return 2;case"message":return 3;case"model":return 4;case"vector":return 5;default:return 10}}notifyQueueUpdated(){syncEventManager.dispatchEvent({type:SyncEventType.SYNC_QUEUE_UPDATED,payload:{queueLength:this.queue.length},timestamp:Date.now()})}}const syncQueue=new SyncQueue;class SyncWorker{isSyncing=!1;abortController=null;networkOnline=!0;constructor(){this.initNetworkListeners(),this.networkOnline=this.isOnline()}initNetworkListeners(){typeof window<"u"?(window.addEventListener("online",this.handleNetworkChange.bind(this)),window.addEventListener("offline",this.handleNetworkChange.bind(this))):typeof self<"u"&&(self.addEventListener("online",this.handleNetworkChange.bind(this)),self.addEventListener("offline",this.handleNetworkChange.bind(this)))}isOnline(){return typeof navigator<"u"&&"onLine"in navigator?navigator.onLine:!0}async startSync(){if(!(this.isSyncing||!(await getDataProviderConfig()).enabled)&&this.networkOnline){this.isSyncing=!0;try{syncEventManager.dispatchEvent({type:SyncEventType.SYNC_SUCCESS,payload:{message:"Data ready for pull"},timestamp:Date.now()})}catch(s){console.error("Error preparing data for pull:",s),syncEventManager.dispatchEvent({type:SyncEventType.SYNC_ERROR,payload:{error:s},timestamp:Date.now()})}finally{this.isSyncing=!1}}}stopSync(){this.abortController&&(this.abortController.abort(),this.isSyncing=!1,this.abortController=null)}async processBatch(e){console.log(`[Pull Mode] ${e.length} items ready for pull`)}async syncItem(e){console.log(`[Pull Mode] Item ${e.id} ready for pull`)}calculateRetryDelay(e,s){const{initialDelay:n,maxDelay:r}=s.retry,a=n*Math.pow(2,e);return Math.min(a,r)}handleNetworkChange(){const e=this.networkOnline;this.networkOnline=this.isOnline(),syncEventManager.dispatchEvent({type:SyncEventType.CONNECTIVITY_CHANGE,payload:{online:this.networkOnline},timestamp:Date.now()}),!e&&this.networkOnline&&this.startSync()}}const syncWorker=new SyncWorker;class SyncService{status="idle";statusListeners=[];initialized=!1;syncInterval=null;constructor(){this.initialize()}async initialize(){if(this.initialized)return;const e=await getDataProviderConfig();this.status=e.enabled?"idle":"disabled",syncEventManager.addEventListener(SyncEventType.SYNC_SUCCESS,this.handleSyncSuccess.bind(this)),syncEventManager.addEventListener(SyncEventType.SYNC_ERROR,this.handleSyncError.bind(this)),syncEventManager.addEventListener(SyncEventType.CONNECTIVITY_CHANGE,this.handleConnectivityChange.bind(this)),this.setupPeriodicSync(),this.initialized=!0}setupPeriodicSync(){this.syncInterval!==null&&(clearInterval(this.syncInterval),this.syncInterval=null),this.syncInterval=Number(setInterval(()=>{this.synchronize()},9e5))}async trackChange(e){await syncQueue.addItem({operation:e.operation,entityType:e.entityType,data:e.data}),syncEventManager.dispatchEvent({type:SyncEventType.DATA_CHANGE,payload:e,timestamp:Date.now()})}async synchronize(){try{if(!(await getDataProviderConfig()).enabled)return;this.setStatus("syncing"),setTimeout(()=>{this.setStatus("idle")},1e3)}catch(e){console.error("Error preparing data for synchronization:",e),this.setStatus("error")}}stopSync(){try{syncWorker.stopSync(),this.setStatus("idle")}catch(e){console.error("Error stopping synchronization:",e)}}async setEnabled(e){try{await updateDataProviderConfig({enabled:e}),await updateSyncConfig({enabled:e}),this.setStatus(e?"idle":"disabled"),e?this.synchronize():this.stopSync()}catch(s){console.error("Error setting sync enabled state:",s)}}async setProxyEndpoint(e){console.log("setProxyEndpoint is deprecated in pull mode")}getStatus(){return this.status}addStatusListener(e){this.statusListeners.push(e),e(this.status)}removeStatusListener(e){this.statusListeners=this.statusListeners.filter(s=>s!==e)}async getQueueStats(){return syncQueue.getStats()}async cleanExpiredItems(){return syncQueue.cleanExpiredItems()}setStatus(e){this.status!==e&&(this.status=e,this.statusListeners.forEach(s=>{try{s(e)}catch(n){console.error("Error in sync status listener:",n)}}))}handleSyncSuccess(){this.setStatus("idle")}handleSyncError(){this.setStatus("error")}handleConnectivityChange(e){!e.online&&this.status==="syncing"&&this.setStatus("idle")}}const syncService=new SyncService,syncHooks={document:{afterCreate:t=>{syncService.trackChange({entityType:"document",operation:"create",data:t})},afterUpdate:t=>{syncService.trackChange({entityType:"document",operation:"update",data:t})},afterDelete:t=>{syncService.trackChange({entityType:"document",operation:"delete",data:{id:t}})}},model:{afterCreate:t=>{syncService.trackChange({entityType:"model",operation:"create",data:t})},afterUpdate:t=>{syncService.trackChange({entityType:"model",operation:"update",data:t})},afterDelete:t=>{syncService.trackChange({entityType:"model",operation:"delete",data:{id:t}})}},knowledge:{afterCreate:t=>{syncService.trackChange({entityType:"knowledge",operation:"create",data:t})},afterUpdate:t=>{syncService.trackChange({entityType:"knowledge",operation:"update",data:t})},afterDelete:t=>{syncService.trackChange({entityType:"knowledge",operation:"delete",data:{id:t}})}},vector:{afterCreate:t=>{syncService.trackChange({entityType:"vector",operation:"create",data:t})},afterUpdate:t=>{syncService.trackChange({entityType:"vector",operation:"update",data:t})},afterDelete:t=>{syncService.trackChange({entityType:"vector",operation:"delete",data:{id:t}})}},message:{afterCreate:t=>{syncService.trackChange({entityType:"message",operation:"create",data:t})},afterUpdate:t=>{syncService.trackChange({entityType:"message",operation:"update",data:t})},afterDelete:t=>{syncService.trackChange({entityType:"message",operation:"delete",data:{id:t}})}},page:{afterCreate:t=>{syncService.trackChange({entityType:"page",operation:"create",data:t})},afterUpdate:t=>{syncService.trackChange({entityType:"page",operation:"update",data:t})},afterDelete:t=>{syncService.trackChange({entityType:"page",operation:"delete",data:{id:t}})}}},isLMStudioModel=t=>/_lmstudio_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/.test(t),isLlamafileModel=t=>/_llamafile_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/.test(t),isLLamaCppModel=t=>/_llamacpp_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/.test(t),isOllamaModel=t=>/_ollama2_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/.test(t),getLMStudioModelId=t=>{const e=/_lmstudio_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,s=t.match(e);if(s){const n=s[0],r=s[0].replace("_lmstudio_openai-","");return{model_id:n,provider_id:r}}return null},getOllamaModelId=t=>{const e=/_ollama2_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,s=t.match(e);if(s){const n=s[0],r=s[0].replace("_ollama2_openai-","");return{model_id:n,provider_id:r}}return null},getLlamafileModelId=t=>{const e=/_llamafile_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,s=t.match(e);if(s){const n=s[0],r=s[0].replace("_llamafile_openai-","");return{model_id:n,provider_id:r}}return null},getLLamaCppModelId=t=>{const e=/_llamacpp_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,s=t.match(e);if(s){const n=s[0],r=s[0].replace("_llamacpp_openai-","");return{model_id:n,provider_id:r}}return null},isCustomModel=t=>isLMStudioModel(t)||isLlamafileModel(t)||isOllamaModel(t)||isLLamaCppModel(t)?!0:/_model-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{3,4}-[a-f0-9]{4}/.test(t);class ModelDb{db;constructor(){this.db=chrome.storage.local}getAll=async()=>new Promise((e,s)=>{this.db.get(null,n=>{if(chrome.runtime.lastError)s(chrome.runtime.lastError);else{const r=Object.keys(n).map(a=>n[a]);e(r)}})});create=async e=>new Promise((s,n)=>{this.db.set({[e.id]:e},()=>{chrome.runtime.lastError?n(chrome.runtime.lastError):(syncHooks.model.afterCreate(e),s())})});getById=async e=>new Promise((s,n)=>{this.db.get(e,r=>{chrome.runtime.lastError?n(chrome.runtime.lastError):s(r[e])})});update=async e=>new Promise((s,n)=>{this.db.set({[e.id]:e},()=>{chrome.runtime.lastError?n(chrome.runtime.lastError):(syncHooks.model.afterUpdate(e),s())})});delete=async e=>new Promise((s,n)=>{this.db.remove(e,()=>{chrome.runtime.lastError?n(chrome.runtime.lastError):(syncHooks.model.afterDelete(e),s())})});deleteAll=async()=>new Promise((e,s)=>{this.db.clear(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):e()})})}const getModelInfo=async t=>{const e=new ModelDb;if(isLMStudioModel(t)){const n=getLMStudioModelId(t);if(!n)throw new Error("Invalid LMStudio model ID");return{model_id:t.replace(/_lmstudio_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,""),provider_id:`openai-${n.provider_id}`,name:t.replace(/_lmstudio_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,"")}}if(isLlamafileModel(t)){const n=getLlamafileModelId(t);if(!n)throw new Error("Invalid LMStudio model ID");return{model_id:t.replace(/_llamafile_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,""),provider_id:`openai-${n.provider_id}`,name:t.replace(/_llamafile_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,"")}}if(isLLamaCppModel(t)){const n=getLLamaCppModelId(t);if(!n)throw new Error("Invalid LMStudio model ID");return{model_id:t.replace(/_llamacpp_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,""),provider_id:`openai-${n.provider_id}`,name:t.replace(/_llamacpp_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,"")}}if(isOllamaModel(t)){const n=getOllamaModelId(t);if(!n)throw new Error("Invalid LMStudio model ID");return{model_id:t.replace(/_ollama2_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,""),provider_id:`openai-${n.provider_id}`,name:t.replace(/_ollama2_openai-[a-f0-9]{4}-[a-f0-9]{3}-[a-f0-9]{4}/,"")}}return await e.getById(t)},storage$2=new g;new g({area:"local"});const DEFAULT_OLLAMA_URL="http://127.0.0.1:11434",getOllamaURL=async()=>{const t=await storage$2.get("ollamaURL");return!t||t.length===0?(await urlRewriteRuntime(DEFAULT_OLLAMA_URL),DEFAULT_OLLAMA_URL):(await urlRewriteRuntime(cleanUrl(t)),t)},isOllamaRunning=async()=>{try{const t=await getOllamaURL(),e=await fetcher(`${cleanUrl(t)}`);if(!e.ok)throw new Error(e.statusText);return!0}catch(t){return console.error(t),!1}},getSelectedModel=async()=>await storage$2.get("selectedModel"),progressHuman=(t,e)=>(t/e*100).toFixed(0)+"%",clearBadge=()=>{setBadgeText({text:""}),setTitle({title:""})},streamDownload=async(t,e)=>{t+="/api/pull";const n=(await fetcher(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:e,stream:!0})})).body?.getReader(),r=new TextDecoder;let a=!0;for(;n;){const{done:i,value:u}=await n.read();if(i)break;const f=r.decode(u);try{const c=JSON.parse(f.trim());c.total&&c.completed?(setBadgeText({text:progressHuman(c.completed,c.total)}),setBadgeBackgroundColor({color:"#0000FF"})):(setBadgeText({text:"🏋️‍♂️"}),setBadgeBackgroundColor({color:"#FFFFFF"})),setTitle({title:c.status}),c.status==="success"&&(a=!0)}catch(c){console.error(c)}}a?(setBadgeText({text:"✅"}),setBadgeBackgroundColor({color:"#00FF00"}),setTitle({title:"Model pulled successfully"})):(setBadgeText({text:"❌"}),setBadgeBackgroundColor({color:"#FF0000"}),setTitle({title:"Model pull failed"})),setTimeout(()=>{clearBadge()},5e3)},storage$1=new g({area:"local"}),getInitialConfig=async()=>{const t=await storage$1.get("actionIconClick"),e=await storage$1.get("contextMenuClick");return{actionIconClick:t||"webui",contextMenuClick:e||"sidePanel"}},defaultOpts$2={xml:!1,decodeEntities:!0},xmlModeDefault={_useHtmlParser2:!0,xmlMode:!0};function flatten(t){return t?.xml?typeof t.xml=="boolean"?xmlModeDefault:{...xmlModeDefault,...t.xml}:t??void 0}var ElementType;(function(t){t.Root="root",t.Text="text",t.Directive="directive",t.Comment="comment",t.Script="script",t.Style="style",t.Tag="tag",t.CDATA="cdata",t.Doctype="doctype"})(ElementType||(ElementType={}));function isTag$1(t){return t.type===ElementType.Tag||t.type===ElementType.Script||t.type===ElementType.Style}const Root=ElementType.Root,Text$1=ElementType.Text,Directive=ElementType.Directive,Comment$1=ElementType.Comment,Script=ElementType.Script,Style=ElementType.Style,Tag=ElementType.Tag,CDATA$1=ElementType.CDATA,Doctype=ElementType.Doctype;class Node{constructor(){this.parent=null,this.prev=null,this.next=null,this.startIndex=null,this.endIndex=null}get parentNode(){return this.parent}set parentNode(e){this.parent=e}get previousSibling(){return this.prev}set previousSibling(e){this.prev=e}get nextSibling(){return this.next}set nextSibling(e){this.next=e}cloneNode(e=!1){return cloneNode(this,e)}}class DataNode extends Node{constructor(e){super(),this.data=e}get nodeValue(){return this.data}set nodeValue(e){this.data=e}}class Text extends DataNode{constructor(){super(...arguments),this.type=ElementType.Text}get nodeType(){return 3}}class Comment extends DataNode{constructor(){super(...arguments),this.type=ElementType.Comment}get nodeType(){return 8}}class ProcessingInstruction extends DataNode{constructor(e,s){super(s),this.name=e,this.type=ElementType.Directive}get nodeType(){return 1}}class NodeWithChildren extends Node{constructor(e){super(),this.children=e}get firstChild(){var e;return(e=this.children[0])!==null&&e!==void 0?e:null}get lastChild(){return this.children.length>0?this.children[this.children.length-1]:null}get childNodes(){return this.children}set childNodes(e){this.children=e}}class CDATA extends NodeWithChildren{constructor(){super(...arguments),this.type=ElementType.CDATA}get nodeType(){return 4}}class Document extends NodeWithChildren{constructor(){super(...arguments),this.type=ElementType.Root}get nodeType(){return 9}}class Element extends NodeWithChildren{constructor(e,s,n=[],r=e==="script"?ElementType.Script:e==="style"?ElementType.Style:ElementType.Tag){super(n),this.name=e,this.attribs=s,this.type=r}get nodeType(){return 1}get tagName(){return this.name}set tagName(e){this.name=e}get attributes(){return Object.keys(this.attribs).map(e=>{var s,n;return{name:e,value:this.attribs[e],namespace:(s=this["x-attribsNamespace"])===null||s===void 0?void 0:s[e],prefix:(n=this["x-attribsPrefix"])===null||n===void 0?void 0:n[e]}})}}function isTag(t){return isTag$1(t)}function isCDATA(t){return t.type===ElementType.CDATA}function isText(t){return t.type===ElementType.Text}function isComment(t){return t.type===ElementType.Comment}function isDirective(t){return t.type===ElementType.Directive}function isDocument(t){return t.type===ElementType.Root}function hasChildren(t){return Object.prototype.hasOwnProperty.call(t,"children")}function cloneNode(t,e=!1){let s;if(isText(t))s=new Text(t.data);else if(isComment(t))s=new Comment(t.data);else if(isTag(t)){const n=e?cloneChildren(t.children):[],r=new Element(t.name,{...t.attribs},n);n.forEach(a=>a.parent=r),t.namespace!=null&&(r.namespace=t.namespace),t["x-attribsNamespace"]&&(r["x-attribsNamespace"]={...t["x-attribsNamespace"]}),t["x-attribsPrefix"]&&(r["x-attribsPrefix"]={...t["x-attribsPrefix"]}),s=r}else if(isCDATA(t)){const n=e?cloneChildren(t.children):[],r=new CDATA(n);n.forEach(a=>a.parent=r),s=r}else if(isDocument(t)){const n=e?cloneChildren(t.children):[],r=new Document(n);n.forEach(a=>a.parent=r),t["x-mode"]&&(r["x-mode"]=t["x-mode"]),s=r}else if(isDirective(t)){const n=new ProcessingInstruction(t.name,t.data);t["x-name"]!=null&&(n["x-name"]=t["x-name"],n["x-publicId"]=t["x-publicId"],n["x-systemId"]=t["x-systemId"]),s=n}else throw new Error(`Not implemented yet: ${t.type}`);return s.startIndex=t.startIndex,s.endIndex=t.endIndex,t.sourceCodeLocation!=null&&(s.sourceCodeLocation=t.sourceCodeLocation),s}function cloneChildren(t){const e=t.map(s=>cloneNode(s,!0));for(let s=1;s<e.length;s++)e[s].prev=e[s-1],e[s-1].next=e[s];return e}const defaultOpts$1={withStartIndices:!1,withEndIndices:!1,xmlMode:!1};class DomHandler{constructor(e,s,n){this.dom=[],this.root=new Document(this.dom),this.done=!1,this.tagStack=[this.root],this.lastNode=null,this.parser=null,typeof s=="function"&&(n=s,s=defaultOpts$1),typeof e=="object"&&(s=e,e=void 0),this.callback=e??null,this.options=s??defaultOpts$1,this.elementCB=n??null}onparserinit(e){this.parser=e}onreset(){this.dom=[],this.root=new Document(this.dom),this.done=!1,this.tagStack=[this.root],this.lastNode=null,this.parser=null}onend(){this.done||(this.done=!0,this.parser=null,this.handleCallback(null))}onerror(e){this.handleCallback(e)}onclosetag(){this.lastNode=null;const e=this.tagStack.pop();this.options.withEndIndices&&(e.endIndex=this.parser.endIndex),this.elementCB&&this.elementCB(e)}onopentag(e,s){const n=this.options.xmlMode?ElementType.Tag:void 0,r=new Element(e,s,void 0,n);this.addNode(r),this.tagStack.push(r)}ontext(e){const{lastNode:s}=this;if(s&&s.type===ElementType.Text)s.data+=e,this.options.withEndIndices&&(s.endIndex=this.parser.endIndex);else{const n=new Text(e);this.addNode(n),this.lastNode=n}}oncomment(e){if(this.lastNode&&this.lastNode.type===ElementType.Comment){this.lastNode.data+=e;return}const s=new Comment(e);this.addNode(s),this.lastNode=s}oncommentend(){this.lastNode=null}oncdatastart(){const e=new Text(""),s=new CDATA([e]);this.addNode(s),e.parent=s,this.lastNode=e}oncdataend(){this.lastNode=null}onprocessinginstruction(e,s){const n=new ProcessingInstruction(e,s);this.addNode(n)}handleCallback(e){if(typeof this.callback=="function")this.callback(e,this.dom);else if(e)throw e}addNode(e){const s=this.tagStack[this.tagStack.length-1],n=s.children[s.children.length-1];this.options.withStartIndices&&(e.startIndex=this.parser.startIndex),this.options.withEndIndices&&(e.endIndex=this.parser.endIndex),s.children.push(e),n&&(e.prev=n,n.next=e),e.parent=s,this.lastNode=null}}const htmlDecodeTree=new Uint16Array('ᵁ<Õıʊҝջאٵ۞ޢߖࠏ੊ઑඡ๭༉༦჊ረዡᐕᒝᓃᓟᔥ\0\0\0\0\0\0ᕫᛍᦍᰒᷝ὾⁠↰⊍⏀⏻⑂⠤⤒ⴈ⹈⿎〖㊺㘹㞬㣾㨨㩱㫠㬮ࠀEMabcfglmnoprstu\\bfms¦³¹ÈÏlig耻Æ䃆P耻&䀦cute耻Á䃁reve;䄂Āiyx}rc耻Â䃂;䐐r;쀀𝔄rave耻À䃀pha;䎑acr;䄀d;橓Āgp¡on;䄄f;쀀𝔸plyFunction;恡ing耻Å䃅Ācs¾Ãr;쀀𝒜ign;扔ilde耻Ã䃃ml耻Ä䃄ЀaceforsuåûþėĜĢħĪĀcrêòkslash;或Ŷöø;櫧ed;挆y;䐑ƀcrtąċĔause;戵noullis;愬a;䎒r;쀀𝔅pf;쀀𝔹eve;䋘còēmpeq;扎܀HOacdefhilorsuōőŖƀƞƢƵƷƺǜȕɳɸɾcy;䐧PY耻©䂩ƀcpyŝŢźute;䄆Ā;iŧŨ拒talDifferentialD;慅leys;愭ȀaeioƉƎƔƘron;䄌dil耻Ç䃇rc;䄈nint;戰ot;䄊ĀdnƧƭilla;䂸terDot;䂷òſi;䎧rcleȀDMPTǇǋǑǖot;抙inus;抖lus;投imes;抗oĀcsǢǸkwiseContourIntegral;戲eCurlyĀDQȃȏoubleQuote;思uote;怙ȀlnpuȞȨɇɕonĀ;eȥȦ户;橴ƀgitȯȶȺruent;扡nt;戯ourIntegral;戮ĀfrɌɎ;愂oduct;成nterClockwiseContourIntegral;戳oss;樯cr;쀀𝒞pĀ;Cʄʅ拓ap;才րDJSZacefiosʠʬʰʴʸˋ˗ˡ˦̳ҍĀ;oŹʥtrahd;椑cy;䐂cy;䐅cy;䐏ƀgrsʿ˄ˇger;怡r;憡hv;櫤Āayː˕ron;䄎;䐔lĀ;t˝˞戇a;䎔r;쀀𝔇Āaf˫̧Ācm˰̢riticalȀADGT̖̜̀̆cute;䂴oŴ̋̍;䋙bleAcute;䋝rave;䁠ilde;䋜ond;拄ferentialD;慆Ѱ̽\0\0\0͔͂\0Ѕf;쀀𝔻ƀ;DE͈͉͍䂨ot;惜qual;扐blèCDLRUVͣͲ΂ϏϢϸontourIntegraìȹoɴ͹\0\0ͻ»͉nArrow;懓Āeo·ΤftƀARTΐΖΡrrow;懐ightArrow;懔eåˊngĀLRΫτeftĀARγιrrow;柸ightArrow;柺ightArrow;柹ightĀATϘϞrrow;懒ee;抨pɁϩ\0\0ϯrrow;懑ownArrow;懕erticalBar;戥ǹABLRTaВЪаўѿͼrrowƀ;BUНОТ憓ar;椓pArrow;懵reve;䌑eft˒к\0ц\0ѐightVector;楐eeVector;楞ectorĀ;Bљњ憽ar;楖ightǔѧ\0ѱeeVector;楟ectorĀ;BѺѻ懁ar;楗eeĀ;A҆҇护rrow;憧ĀctҒҗr;쀀𝒟rok;䄐ࠀNTacdfglmopqstuxҽӀӄӋӞӢӧӮӵԡԯԶՒ՝ՠեG;䅊H耻Ð䃐cute耻É䃉ƀaiyӒӗӜron;䄚rc耻Ê䃊;䐭ot;䄖r;쀀𝔈rave耻È䃈ement;戈ĀapӺӾcr;䄒tyɓԆ\0\0ԒmallSquare;旻erySmallSquare;斫ĀgpԦԪon;䄘f;쀀𝔼silon;䎕uĀaiԼՉlĀ;TՂՃ橵ilde;扂librium;懌Āci՗՚r;愰m;橳a;䎗ml耻Ë䃋Āipժկsts;戃onentialE;慇ʀcfiosօֈ֍ֲ׌y;䐤r;쀀𝔉lledɓ֗\0\0֣mallSquare;旼erySmallSquare;斪Ͱֺ\0ֿ\0\0ׄf;쀀𝔽All;戀riertrf;愱cò׋؀JTabcdfgorstר׬ׯ׺؀ؒؖ؛؝أ٬ٲcy;䐃耻>䀾mmaĀ;d׷׸䎓;䏜reve;䄞ƀeiy؇،ؐdil;䄢rc;䄜;䐓ot;䄠r;쀀𝔊;拙pf;쀀𝔾eater̀EFGLSTصلَٖٛ٦qualĀ;Lؾؿ扥ess;招ullEqual;执reater;檢ess;扷lantEqual;橾ilde;扳cr;쀀𝒢;扫ЀAacfiosuڅڋږڛڞڪھۊRDcy;䐪Āctڐڔek;䋇;䁞irc;䄤r;愌lbertSpace;愋ǰگ\0ڲf;愍izontalLine;攀Āctۃۅòکrok;䄦mpńېۘownHumðįqual;扏܀EJOacdfgmnostuۺ۾܃܇܎ܚܞܡܨ݄ݸދޏޕcy;䐕lig;䄲cy;䐁cute耻Í䃍Āiyܓܘrc耻Î䃎;䐘ot;䄰r;愑rave耻Ì䃌ƀ;apܠܯܿĀcgܴܷr;䄪inaryI;慈lieóϝǴ݉\0ݢĀ;eݍݎ戬Āgrݓݘral;戫section;拂isibleĀCTݬݲomma;恣imes;恢ƀgptݿރވon;䄮f;쀀𝕀a;䎙cr;愐ilde;䄨ǫޚ\0ޞcy;䐆l耻Ï䃏ʀcfosuެ޷޼߂ߐĀiyޱ޵rc;䄴;䐙r;쀀𝔍pf;쀀𝕁ǣ߇\0ߌr;쀀𝒥rcy;䐈kcy;䐄΀HJacfosߤߨ߽߬߱ࠂࠈcy;䐥cy;䐌ppa;䎚Āey߶߻dil;䄶;䐚r;쀀𝔎pf;쀀𝕂cr;쀀𝒦րJTaceflmostࠥࠩࠬࡐࡣ঳সে্਷ੇcy;䐉耻<䀼ʀcmnpr࠷࠼ࡁࡄࡍute;䄹bda;䎛g;柪lacetrf;愒r;憞ƀaeyࡗ࡜ࡡron;䄽dil;䄻;䐛Āfsࡨ॰tԀACDFRTUVarࡾࢩࢱࣦ࣠ࣼयज़ΐ४Ānrࢃ࢏gleBracket;柨rowƀ;BR࢙࢚࢞憐ar;懤ightArrow;懆eiling;挈oǵࢷ\0ࣃbleBracket;柦nǔࣈ\0࣒eeVector;楡ectorĀ;Bࣛࣜ懃ar;楙loor;挊ightĀAV࣯ࣵrrow;憔ector;楎Āerँगeƀ;AVउऊऐ抣rrow;憤ector;楚iangleƀ;BEतथऩ抲ar;槏qual;抴pƀDTVषूौownVector;楑eeVector;楠ectorĀ;Bॖॗ憿ar;楘ectorĀ;B॥०憼ar;楒ightáΜs̀EFGLSTॾঋকঝঢভqualGreater;拚ullEqual;扦reater;扶ess;檡lantEqual;橽ilde;扲r;쀀𝔏Ā;eঽা拘ftarrow;懚idot;䄿ƀnpw৔ਖਛgȀLRlr৞৷ਂਐeftĀAR০৬rrow;柵ightArrow;柷ightArrow;柶eftĀarγਊightáοightáϊf;쀀𝕃erĀLRਢਬeftArrow;憙ightArrow;憘ƀchtਾੀੂòࡌ;憰rok;䅁;扪Ѐacefiosuਗ਼੝੠੷੼અઋ઎p;椅y;䐜Ādl੥੯iumSpace;恟lintrf;愳r;쀀𝔐nusPlus;戓pf;쀀𝕄cò੶;䎜ҀJacefostuણધભીଔଙඑ඗ඞcy;䐊cute;䅃ƀaey઴હાron;䅇dil;䅅;䐝ƀgswે૰଎ativeƀMTV૓૟૨ediumSpace;怋hiĀcn૦૘ë૙eryThiî૙tedĀGL૸ଆreaterGreateòٳessLesóੈLine;䀊r;쀀𝔑ȀBnptଢନଷ଺reak;恠BreakingSpace;䂠f;愕ڀ;CDEGHLNPRSTV୕ୖ୪୼஡௫ఄ౞಄ದ೘ൡඅ櫬Āou୛୤ngruent;扢pCap;扭oubleVerticalBar;戦ƀlqxஃஊ஛ement;戉ualĀ;Tஒஓ扠ilde;쀀≂̸ists;戄reater΀;EFGLSTஶஷ஽௉௓௘௥扯qual;扱ullEqual;쀀≧̸reater;쀀≫̸ess;批lantEqual;쀀⩾̸ilde;扵umpń௲௽ownHump;쀀≎̸qual;쀀≏̸eĀfsఊధtTriangleƀ;BEచఛడ拪ar;쀀⧏̸qual;括s̀;EGLSTవశ఼ౄోౘ扮qual;扰reater;扸ess;쀀≪̸lantEqual;쀀⩽̸ilde;扴estedĀGL౨౹reaterGreater;쀀⪢̸essLess;쀀⪡̸recedesƀ;ESಒಓಛ技qual;쀀⪯̸lantEqual;拠ĀeiಫಹverseElement;戌ghtTriangleƀ;BEೋೌ೒拫ar;쀀⧐̸qual;拭ĀquೝഌuareSuĀbp೨೹setĀ;E೰ೳ쀀⊏̸qual;拢ersetĀ;Eഃആ쀀⊐̸qual;拣ƀbcpഓതൎsetĀ;Eഛഞ쀀⊂⃒qual;抈ceedsȀ;ESTലള഻െ抁qual;쀀⪰̸lantEqual;拡ilde;쀀≿̸ersetĀ;E൘൛쀀⊃⃒qual;抉ildeȀ;EFT൮൯൵ൿ扁qual;扄ullEqual;扇ilde;扉erticalBar;戤cr;쀀𝒩ilde耻Ñ䃑;䎝܀Eacdfgmoprstuvලෂ෉෕ෛ෠෧෼ขภยา฿ไlig;䅒cute耻Ó䃓Āiy෎ීrc耻Ô䃔;䐞blac;䅐r;쀀𝔒rave耻Ò䃒ƀaei෮ෲ෶cr;䅌ga;䎩cron;䎟pf;쀀𝕆enCurlyĀDQฎบoubleQuote;怜uote;怘;橔Āclวฬr;쀀𝒪ash耻Ø䃘iŬื฼de耻Õ䃕es;樷ml耻Ö䃖erĀBP๋๠Āar๐๓r;怾acĀek๚๜;揞et;掴arenthesis;揜Ҁacfhilors๿ງຊຏຒດຝະ໼rtialD;戂y;䐟r;쀀𝔓i;䎦;䎠usMinus;䂱Āipຢອncareplanåڝf;愙Ȁ;eio຺ູ໠໤檻cedesȀ;EST່້໏໚扺qual;檯lantEqual;扼ilde;找me;怳Ādp໩໮uct;戏ortionĀ;aȥ໹l;戝Āci༁༆r;쀀𝒫;䎨ȀUfos༑༖༛༟OT耻"䀢r;쀀𝔔pf;愚cr;쀀𝒬؀BEacefhiorsu༾གྷཇའཱིྦྷྪྭ႖ႩႴႾarr;椐G耻®䂮ƀcnrཎནབute;䅔g;柫rĀ;tཛྷཝ憠l;椖ƀaeyཧཬཱron;䅘dil;䅖;䐠Ā;vླྀཹ愜erseĀEUྂྙĀlq྇ྎement;戋uilibrium;懋pEquilibrium;楯r»ཹo;䎡ghtЀACDFTUVa࿁࿫࿳ဢဨၛႇϘĀnr࿆࿒gleBracket;柩rowƀ;BL࿜࿝࿡憒ar;懥eftArrow;懄eiling;按oǵ࿹\0စbleBracket;柧nǔည\0နeeVector;楝ectorĀ;Bဝသ懂ar;楕loor;挋Āerိ၃eƀ;AVဵံြ抢rrow;憦ector;楛iangleƀ;BEၐၑၕ抳ar;槐qual;抵pƀDTVၣၮၸownVector;楏eeVector;楜ectorĀ;Bႂႃ憾ar;楔ectorĀ;B႑႒懀ar;楓Āpuႛ႞f;愝ndImplies;楰ightarrow;懛ĀchႹႼr;愛;憱leDelayed;槴ڀHOacfhimoqstuფჱჷჽᄙᄞᅑᅖᅡᅧᆵᆻᆿĀCcჩხHcy;䐩y;䐨FTcy;䐬cute;䅚ʀ;aeiyᄈᄉᄎᄓᄗ檼ron;䅠dil;䅞rc;䅜;䐡r;쀀𝔖ortȀDLRUᄪᄴᄾᅉownArrow»ОeftArrow»࢚ightArrow»࿝pArrow;憑gma;䎣allCircle;战pf;쀀𝕊ɲᅭ\0\0ᅰt;戚areȀ;ISUᅻᅼᆉᆯ斡ntersection;抓uĀbpᆏᆞsetĀ;Eᆗᆘ抏qual;抑ersetĀ;Eᆨᆩ抐qual;抒nion;抔cr;쀀𝒮ar;拆ȀbcmpᇈᇛሉላĀ;sᇍᇎ拐etĀ;Eᇍᇕqual;抆ĀchᇠህeedsȀ;ESTᇭᇮᇴᇿ扻qual;檰lantEqual;扽ilde;承Tháྌ;我ƀ;esሒሓሣ拑rsetĀ;Eሜም抃qual;抇et»ሓրHRSacfhiorsሾቄ቉ቕ቞ቱቶኟዂወዑORN耻Þ䃞ADE;愢ĀHc቎ቒcy;䐋y;䐦Ābuቚቜ;䀉;䎤ƀaeyብቪቯron;䅤dil;䅢;䐢r;쀀𝔗Āeiቻ኉ǲኀ\0ኇefore;戴a;䎘Ācn኎ኘkSpace;쀀  Space;怉ldeȀ;EFTካኬኲኼ戼qual;扃ullEqual;扅ilde;扈pf;쀀𝕋ipleDot;惛Āctዖዛr;쀀𝒯rok;䅦ૡዷጎጚጦ\0ጬጱ\0\0\0\0\0ጸጽ፷ᎅ\0᏿ᐄᐊᐐĀcrዻጁute耻Ú䃚rĀ;oጇገ憟cir;楉rǣጓ\0጖y;䐎ve;䅬Āiyጞጣrc耻Û䃛;䐣blac;䅰r;쀀𝔘rave耻Ù䃙acr;䅪Ādiፁ፩erĀBPፈ፝Āarፍፐr;䁟acĀekፗፙ;揟et;掵arenthesis;揝onĀ;P፰፱拃lus;抎Āgp፻፿on;䅲f;쀀𝕌ЀADETadps᎕ᎮᎸᏄϨᏒᏗᏳrrowƀ;BDᅐᎠᎤar;椒ownArrow;懅ownArrow;憕quilibrium;楮eeĀ;AᏋᏌ报rrow;憥ownáϳerĀLRᏞᏨeftArrow;憖ightArrow;憗iĀ;lᏹᏺ䏒on;䎥ing;䅮cr;쀀𝒰ilde;䅨ml耻Ü䃜ҀDbcdefosvᐧᐬᐰᐳᐾᒅᒊᒐᒖash;披ar;櫫y;䐒ashĀ;lᐻᐼ抩;櫦Āerᑃᑅ;拁ƀbtyᑌᑐᑺar;怖Ā;iᑏᑕcalȀBLSTᑡᑥᑪᑴar;戣ine;䁼eparator;杘ilde;所ThinSpace;怊r;쀀𝔙pf;쀀𝕍cr;쀀𝒱dash;抪ʀcefosᒧᒬᒱᒶᒼirc;䅴dge;拀r;쀀𝔚pf;쀀𝕎cr;쀀𝒲Ȁfiosᓋᓐᓒᓘr;쀀𝔛;䎞pf;쀀𝕏cr;쀀𝒳ҀAIUacfosuᓱᓵᓹᓽᔄᔏᔔᔚᔠcy;䐯cy;䐇cy;䐮cute耻Ý䃝Āiyᔉᔍrc;䅶;䐫r;쀀𝔜pf;쀀𝕐cr;쀀𝒴ml;䅸ЀHacdefosᔵᔹᔿᕋᕏᕝᕠᕤcy;䐖cute;䅹Āayᕄᕉron;䅽;䐗ot;䅻ǲᕔ\0ᕛoWidtè૙a;䎖r;愨pf;愤cr;쀀𝒵௡ᖃᖊᖐ\0ᖰᖶᖿ\0\0\0\0ᗆᗛᗫᙟ᙭\0ᚕ᚛ᚲᚹ\0ᚾcute耻á䃡reve;䄃̀;Ediuyᖜᖝᖡᖣᖨᖭ戾;쀀∾̳;房rc耻â䃢te肻´̆;䐰lig耻æ䃦Ā;r²ᖺ;쀀𝔞rave耻à䃠ĀepᗊᗖĀfpᗏᗔsym;愵èᗓha;䎱ĀapᗟcĀclᗤᗧr;䄁g;樿ɤᗰ\0\0ᘊʀ;adsvᗺᗻᗿᘁᘇ戧nd;橕;橜lope;橘;橚΀;elmrszᘘᘙᘛᘞᘿᙏᙙ戠;榤e»ᘙsdĀ;aᘥᘦ戡ѡᘰᘲᘴᘶᘸᘺᘼᘾ;榨;榩;榪;榫;榬;榭;榮;榯tĀ;vᙅᙆ戟bĀ;dᙌᙍ抾;榝Āptᙔᙗh;戢»¹arr;捼Āgpᙣᙧon;䄅f;쀀𝕒΀;Eaeiop዁ᙻᙽᚂᚄᚇᚊ;橰cir;橯;扊d;手s;䀧roxĀ;e዁ᚒñᚃing耻å䃥ƀctyᚡᚦᚨr;쀀𝒶;䀪mpĀ;e዁ᚯñʈilde耻ã䃣ml耻ä䃤Āciᛂᛈoninôɲnt;樑ࠀNabcdefiklnoprsu᛭ᛱᜰ᜼ᝃᝈ᝸᝽០៦ᠹᡐᜍ᤽᥈ᥰot;櫭Ācrᛶ᜞kȀcepsᜀᜅᜍᜓong;扌psilon;䏶rime;怵imĀ;e᜚᜛戽q;拍Ŷᜢᜦee;抽edĀ;gᜬᜭ挅e»ᜭrkĀ;t፜᜷brk;掶Āoyᜁᝁ;䐱quo;怞ʀcmprtᝓ᝛ᝡᝤᝨausĀ;eĊĉptyv;榰séᜌnoõēƀahwᝯ᝱ᝳ;䎲;愶een;扬r;쀀𝔟g΀costuvwឍឝឳេ៕៛៞ƀaiuបពរðݠrc;旯p»፱ƀdptឤឨឭot;樀lus;樁imes;樂ɱឹ\0\0ើcup;樆ar;昅riangleĀdu៍្own;施p;斳plus;樄eåᑄåᒭarow;植ƀako៭ᠦᠵĀcn៲ᠣkƀlst៺֫᠂ozenge;槫riangleȀ;dlr᠒᠓᠘᠝斴own;斾eft;旂ight;斸k;搣Ʊᠫ\0ᠳƲᠯ\0ᠱ;斒;斑4;斓ck;斈ĀeoᠾᡍĀ;qᡃᡆ쀀=⃥uiv;쀀≡⃥t;挐Ȁptwxᡙᡞᡧᡬf;쀀𝕓Ā;tᏋᡣom»Ꮜtie;拈؀DHUVbdhmptuvᢅᢖᢪᢻᣗᣛᣬ᣿ᤅᤊᤐᤡȀLRlrᢎᢐᢒᢔ;敗;敔;敖;敓ʀ;DUduᢡᢢᢤᢦᢨ敐;敦;敩;敤;敧ȀLRlrᢳᢵᢷᢹ;敝;敚;敜;教΀;HLRhlrᣊᣋᣍᣏᣑᣓᣕ救;敬;散;敠;敫;敢;敟ox;槉ȀLRlrᣤᣦᣨᣪ;敕;敒;攐;攌ʀ;DUduڽ᣷᣹᣻᣽;敥;敨;攬;攴inus;抟lus;択imes;抠ȀLRlrᤙᤛᤝ᤟;敛;敘;攘;攔΀;HLRhlrᤰᤱᤳᤵᤷ᤻᤹攂;敪;敡;敞;攼;攤;攜Āevģ᥂bar耻¦䂦Ȁceioᥑᥖᥚᥠr;쀀𝒷mi;恏mĀ;e᜚᜜lƀ;bhᥨᥩᥫ䁜;槅sub;柈Ŭᥴ᥾lĀ;e᥹᥺怢t»᥺pƀ;Eeįᦅᦇ;檮Ā;qۜۛೡᦧ\0᧨ᨑᨕᨲ\0ᨷᩐ\0\0᪴\0\0᫁\0\0ᬡᬮ᭍᭒\0᯽\0ᰌƀcpr᦭ᦲ᧝ute;䄇̀;abcdsᦿᧀᧄ᧊᧕᧙戩nd;橄rcup;橉Āau᧏᧒p;橋p;橇ot;橀;쀀∩︀Āeo᧢᧥t;恁îړȀaeiu᧰᧻ᨁᨅǰ᧵\0᧸s;橍on;䄍dil耻ç䃧rc;䄉psĀ;sᨌᨍ橌m;橐ot;䄋ƀdmnᨛᨠᨦil肻¸ƭptyv;榲t脀¢;eᨭᨮ䂢räƲr;쀀𝔠ƀceiᨽᩀᩍy;䑇ckĀ;mᩇᩈ朓ark»ᩈ;䏇r΀;Ecefms᩟᩠ᩢᩫ᪤᪪᪮旋;槃ƀ;elᩩᩪᩭ䋆q;扗eɡᩴ\0\0᪈rrowĀlr᩼᪁eft;憺ight;憻ʀRSacd᪒᪔᪖᪚᪟»ཇ;擈st;抛irc;抚ash;抝nint;樐id;櫯cir;槂ubsĀ;u᪻᪼晣it»᪼ˬ᫇᫔᫺\0ᬊonĀ;eᫍᫎ䀺Ā;qÇÆɭ᫙\0\0᫢aĀ;t᫞᫟䀬;䁀ƀ;fl᫨᫩᫫戁îᅠeĀmx᫱᫶ent»᫩eóɍǧ᫾\0ᬇĀ;dኻᬂot;橭nôɆƀfryᬐᬔᬗ;쀀𝕔oäɔ脀©;sŕᬝr;愗Āaoᬥᬩrr;憵ss;朗Ācuᬲᬷr;쀀𝒸Ābpᬼ᭄Ā;eᭁᭂ櫏;櫑Ā;eᭉᭊ櫐;櫒dot;拯΀delprvw᭠᭬᭷ᮂᮬᯔ᯹arrĀlr᭨᭪;椸;椵ɰ᭲\0\0᭵r;拞c;拟arrĀ;p᭿ᮀ憶;椽̀;bcdosᮏᮐᮖᮡᮥᮨ截rcap;橈Āauᮛᮞp;橆p;橊ot;抍r;橅;쀀∪︀Ȁalrv᮵ᮿᯞᯣrrĀ;mᮼᮽ憷;椼yƀevwᯇᯔᯘqɰᯎ\0\0ᯒreã᭳uã᭵ee;拎edge;拏en耻¤䂤earrowĀlrᯮ᯳eft»ᮀight»ᮽeäᯝĀciᰁᰇoninôǷnt;戱lcty;挭ঀAHabcdefhijlorstuwz᰸᰻᰿ᱝᱩᱵᲊᲞᲬᲷ᳻᳿ᴍᵻᶑᶫᶻ᷆᷍rò΁ar;楥Ȁglrs᱈ᱍ᱒᱔ger;怠eth;愸òᄳhĀ;vᱚᱛ怐»ऊūᱡᱧarow;椏aã̕Āayᱮᱳron;䄏;䐴ƀ;ao̲ᱼᲄĀgrʿᲁr;懊tseq;橷ƀglmᲑᲔᲘ耻°䂰ta;䎴ptyv;榱ĀirᲣᲨsht;楿;쀀𝔡arĀlrᲳᲵ»ࣜ»သʀaegsv᳂͸᳖᳜᳠mƀ;oș᳊᳔ndĀ;ș᳑uit;晦amma;䏝in;拲ƀ;io᳧᳨᳸䃷de脀÷;o᳧ᳰntimes;拇nø᳷cy;䑒cɯᴆ\0\0ᴊrn;挞op;挍ʀlptuwᴘᴝᴢᵉᵕlar;䀤f;쀀𝕕ʀ;emps̋ᴭᴷᴽᵂqĀ;d͒ᴳot;扑inus;戸lus;戔quare;抡blebarwedgåúnƀadhᄮᵝᵧownarrowóᲃarpoonĀlrᵲᵶefôᲴighôᲶŢᵿᶅkaro÷གɯᶊ\0\0ᶎrn;挟op;挌ƀcotᶘᶣᶦĀryᶝᶡ;쀀𝒹;䑕l;槶rok;䄑Ādrᶰᶴot;拱iĀ;fᶺ᠖斿Āah᷀᷃ròЩaòྦangle;榦Āci᷒ᷕy;䑟grarr;柿ऀDacdefglmnopqrstuxḁḉḙḸոḼṉṡṾấắẽỡἪἷὄ὎὚ĀDoḆᴴoôᲉĀcsḎḔute耻é䃩ter;橮ȀaioyḢḧḱḶron;䄛rĀ;cḭḮ扖耻ê䃪lon;払;䑍ot;䄗ĀDrṁṅot;扒;쀀𝔢ƀ;rsṐṑṗ檚ave耻è䃨Ā;dṜṝ檖ot;檘Ȁ;ilsṪṫṲṴ檙nters;揧;愓Ā;dṹṺ檕ot;檗ƀapsẅẉẗcr;䄓tyƀ;svẒẓẕ戅et»ẓpĀ1;ẝẤĳạả;怄;怅怃ĀgsẪẬ;䅋p;怂ĀgpẴẸon;䄙f;쀀𝕖ƀalsỄỎỒrĀ;sỊị拕l;槣us;橱iƀ;lvỚớở䎵on»ớ;䏵ȀcsuvỪỳἋἣĀioữḱrc»Ḯɩỹ\0\0ỻíՈantĀglἂἆtr»ṝess»Ṻƀaeiἒ἖Ἒls;䀽st;扟vĀ;DȵἠD;橸parsl;槥ĀDaἯἳot;打rr;楱ƀcdiἾὁỸr;愯oô͒ĀahὉὋ;䎷耻ð䃰Āmrὓὗl耻ë䃫o;悬ƀcipὡὤὧl;䀡sôծĀeoὬὴctatioîՙnentialåչৡᾒ\0ᾞ\0ᾡᾧ\0\0ῆῌ\0ΐ\0ῦῪ \0 ⁚llingdotseñṄy;䑄male;晀ƀilrᾭᾳ῁lig;耀ﬃɩᾹ\0\0᾽g;耀ﬀig;耀ﬄ;쀀𝔣lig;耀ﬁlig;쀀fjƀaltῙ῜ῡt;晭ig;耀ﬂns;斱of;䆒ǰ΅\0ῳf;쀀𝕗ĀakֿῷĀ;vῼ´拔;櫙artint;樍Āao‌⁕Ācs‑⁒α‚‰‸⁅⁈\0⁐β•‥‧‪‬\0‮耻½䂽;慓耻¼䂼;慕;慙;慛Ƴ‴\0‶;慔;慖ʴ‾⁁\0\0⁃耻¾䂾;慗;慜5;慘ƶ⁌\0⁎;慚;慝8;慞l;恄wn;挢cr;쀀𝒻ࢀEabcdefgijlnorstv₂₉₟₥₰₴⃰⃵⃺⃿℃ℒℸ̗ℾ⅒↞Ā;lٍ₇;檌ƀcmpₐₕ₝ute;䇵maĀ;dₜ᳚䎳;檆reve;䄟Āiy₪₮rc;䄝;䐳ot;䄡Ȁ;lqsؾق₽⃉ƀ;qsؾٌ⃄lanô٥Ȁ;cdl٥⃒⃥⃕c;檩otĀ;o⃜⃝檀Ā;l⃢⃣檂;檄Ā;e⃪⃭쀀⋛︀s;檔r;쀀𝔤Ā;gٳ؛mel;愷cy;䑓Ȁ;Eajٚℌℎℐ;檒;檥;檤ȀEaesℛℝ℩ℴ;扩pĀ;p℣ℤ檊rox»ℤĀ;q℮ℯ檈Ā;q℮ℛim;拧pf;쀀𝕘Āci⅃ⅆr;愊mƀ;el٫ⅎ⅐;檎;檐茀>;cdlqr׮ⅠⅪⅮⅳⅹĀciⅥⅧ;檧r;橺ot;拗Par;榕uest;橼ʀadelsↄⅪ←ٖ↛ǰ↉\0↎proø₞r;楸qĀlqؿ↖lesó₈ií٫Āen↣↭rtneqq;쀀≩︀Å↪ԀAabcefkosy⇄⇇⇱⇵⇺∘∝∯≨≽ròΠȀilmr⇐⇔⇗⇛rsðᒄf»․ilôکĀdr⇠⇤cy;䑊ƀ;cwࣴ⇫⇯ir;楈;憭ar;意irc;䄥ƀalr∁∎∓rtsĀ;u∉∊晥it»∊lip;怦con;抹r;쀀𝔥sĀew∣∩arow;椥arow;椦ʀamopr∺∾≃≞≣rr;懿tht;戻kĀlr≉≓eftarrow;憩ightarrow;憪f;쀀𝕙bar;怕ƀclt≯≴≸r;쀀𝒽asè⇴rok;䄧Ābp⊂⊇ull;恃hen»ᱛૡ⊣\0⊪\0⊸⋅⋎\0⋕⋳\0\0⋸⌢⍧⍢⍿\0⎆⎪⎴cute耻í䃭ƀ;iyݱ⊰⊵rc耻î䃮;䐸Ācx⊼⊿y;䐵cl耻¡䂡ĀfrΟ⋉;쀀𝔦rave耻ì䃬Ȁ;inoܾ⋝⋩⋮Āin⋢⋦nt;樌t;戭fin;槜ta;愩lig;䄳ƀaop⋾⌚⌝ƀcgt⌅⌈⌗r;䄫ƀelpܟ⌏⌓inåގarôܠh;䄱f;抷ed;䆵ʀ;cfotӴ⌬⌱⌽⍁are;愅inĀ;t⌸⌹戞ie;槝doô⌙ʀ;celpݗ⍌⍐⍛⍡al;抺Āgr⍕⍙eróᕣã⍍arhk;樗rod;樼Ȁcgpt⍯⍲⍶⍻y;䑑on;䄯f;쀀𝕚a;䎹uest耻¿䂿Āci⎊⎏r;쀀𝒾nʀ;EdsvӴ⎛⎝⎡ӳ;拹ot;拵Ā;v⎦⎧拴;拳Ā;iݷ⎮lde;䄩ǫ⎸\0⎼cy;䑖l耻ï䃯̀cfmosu⏌⏗⏜⏡⏧⏵Āiy⏑⏕rc;䄵;䐹r;쀀𝔧ath;䈷pf;쀀𝕛ǣ⏬\0⏱r;쀀𝒿rcy;䑘kcy;䑔Ѐacfghjos␋␖␢␧␭␱␵␻ppaĀ;v␓␔䎺;䏰Āey␛␠dil;䄷;䐺r;쀀𝔨reen;䄸cy;䑅cy;䑜pf;쀀𝕜cr;쀀𝓀஀ABEHabcdefghjlmnoprstuv⑰⒁⒆⒍⒑┎┽╚▀♎♞♥♹♽⚚⚲⛘❝❨➋⟀⠁⠒ƀart⑷⑺⑼rò৆òΕail;椛arr;椎Ā;gঔ⒋;檋ar;楢ॣ⒥\0⒪\0⒱\0\0\0\0\0⒵Ⓔ\0ⓆⓈⓍ\0⓹ute;䄺mptyv;榴raîࡌbda;䎻gƀ;dlࢎⓁⓃ;榑åࢎ;檅uo耻«䂫rЀ;bfhlpst࢙ⓞⓦⓩ⓫⓮⓱⓵Ā;f࢝ⓣs;椟s;椝ë≒p;憫l;椹im;楳l;憢ƀ;ae⓿─┄檫il;椙Ā;s┉┊檭;쀀⪭︀ƀabr┕┙┝rr;椌rk;杲Āak┢┬cĀek┨┪;䁻;䁛Āes┱┳;榋lĀdu┹┻;榏;榍Ȁaeuy╆╋╖╘ron;䄾Ādi═╔il;䄼ìࢰâ┩;䐻Ȁcqrs╣╦╭╽a;椶uoĀ;rนᝆĀdu╲╷har;楧shar;楋h;憲ʀ;fgqs▋▌উ◳◿扤tʀahlrt▘▤▷◂◨rrowĀ;t࢙□aé⓶arpoonĀdu▯▴own»њp»०eftarrows;懇ightƀahs◍◖◞rrowĀ;sࣴࢧarpoonó྘quigarro÷⇰hreetimes;拋ƀ;qs▋ও◺lanôবʀ;cdgsব☊☍☝☨c;檨otĀ;o☔☕橿Ā;r☚☛檁;檃Ā;e☢☥쀀⋚︀s;檓ʀadegs☳☹☽♉♋pproøⓆot;拖qĀgq♃♅ôউgtò⒌ôছiíলƀilr♕࣡♚sht;楼;쀀𝔩Ā;Eজ♣;檑š♩♶rĀdu▲♮Ā;l॥♳;楪lk;斄cy;䑙ʀ;achtੈ⚈⚋⚑⚖rò◁orneòᴈard;楫ri;旺Āio⚟⚤dot;䅀ustĀ;a⚬⚭掰che»⚭ȀEaes⚻⚽⛉⛔;扨pĀ;p⛃⛄檉rox»⛄Ā;q⛎⛏檇Ā;q⛎⚻im;拦Ѐabnoptwz⛩⛴⛷✚✯❁❇❐Ānr⛮⛱g;柬r;懽rëࣁgƀlmr⛿✍✔eftĀar০✇ightá৲apsto;柼ightá৽parrowĀlr✥✩efô⓭ight;憬ƀafl✶✹✽r;榅;쀀𝕝us;樭imes;樴š❋❏st;戗áፎƀ;ef❗❘᠀旊nge»❘arĀ;l❤❥䀨t;榓ʀachmt❳❶❼➅➇ròࢨorneòᶌarĀ;d྘➃;業;怎ri;抿̀achiqt➘➝ੀ➢➮➻quo;怹r;쀀𝓁mƀ;egল➪➬;檍;檏Ābu┪➳oĀ;rฟ➹;怚rok;䅂萀<;cdhilqrࠫ⟒☹⟜⟠⟥⟪⟰Āci⟗⟙;檦r;橹reå◲mes;拉arr;楶uest;橻ĀPi⟵⟹ar;榖ƀ;ef⠀भ᠛旃rĀdu⠇⠍shar;楊har;楦Āen⠗⠡rtneqq;쀀≨︀Å⠞܀Dacdefhilnopsu⡀⡅⢂⢎⢓⢠⢥⢨⣚⣢⣤ઃ⣳⤂Dot;戺Ȁclpr⡎⡒⡣⡽r耻¯䂯Āet⡗⡙;時Ā;e⡞⡟朠se»⡟Ā;sျ⡨toȀ;dluျ⡳⡷⡻owîҌefôएðᏑker;斮Āoy⢇⢌mma;権;䐼ash;怔asuredangle»ᘦr;쀀𝔪o;愧ƀcdn⢯⢴⣉ro耻µ䂵Ȁ;acdᑤ⢽⣀⣄sôᚧir;櫰ot肻·Ƶusƀ;bd⣒ᤃ⣓戒Ā;uᴼ⣘;横ţ⣞⣡p;櫛ò−ðઁĀdp⣩⣮els;抧f;쀀𝕞Āct⣸⣽r;쀀𝓂pos»ᖝƀ;lm⤉⤊⤍䎼timap;抸ఀGLRVabcdefghijlmoprstuvw⥂⥓⥾⦉⦘⧚⧩⨕⨚⩘⩝⪃⪕⪤⪨⬄⬇⭄⭿⮮ⰴⱧⱼ⳩Āgt⥇⥋;쀀⋙̸Ā;v⥐௏쀀≫⃒ƀelt⥚⥲⥶ftĀar⥡⥧rrow;懍ightarrow;懎;쀀⋘̸Ā;v⥻ే쀀≪⃒ightarrow;懏ĀDd⦎⦓ash;抯ash;抮ʀbcnpt⦣⦧⦬⦱⧌la»˞ute;䅄g;쀀∠⃒ʀ;Eiop඄⦼⧀⧅⧈;쀀⩰̸d;쀀≋̸s;䅉roø඄urĀ;a⧓⧔普lĀ;s⧓ସǳ⧟\0⧣p肻 ଷmpĀ;e௹ఀʀaeouy⧴⧾⨃⨐⨓ǰ⧹\0⧻;橃on;䅈dil;䅆ngĀ;dൾ⨊ot;쀀⩭̸p;橂;䐽ash;怓΀;Aadqsxஒ⨩⨭⨻⩁⩅⩐rr;懗rĀhr⨳⨶k;椤Ā;oᏲᏰot;쀀≐̸uiöୣĀei⩊⩎ar;椨í஘istĀ;s஠டr;쀀𝔫ȀEest௅⩦⩹⩼ƀ;qs஼⩭௡ƀ;qs஼௅⩴lanô௢ií௪Ā;rஶ⪁»ஷƀAap⪊⪍⪑rò⥱rr;憮ar;櫲ƀ;svྍ⪜ྌĀ;d⪡⪢拼;拺cy;䑚΀AEadest⪷⪺⪾⫂⫅⫶⫹rò⥦;쀀≦̸rr;憚r;急Ȁ;fqs఻⫎⫣⫯tĀar⫔⫙rro÷⫁ightarro÷⪐ƀ;qs఻⪺⫪lanôౕĀ;sౕ⫴»శiíౝĀ;rవ⫾iĀ;eచథiäඐĀpt⬌⬑f;쀀𝕟膀¬;in⬙⬚⬶䂬nȀ;Edvஉ⬤⬨⬮;쀀⋹̸ot;쀀⋵̸ǡஉ⬳⬵;拷;拶iĀ;vಸ⬼ǡಸ⭁⭃;拾;拽ƀaor⭋⭣⭩rȀ;ast୻⭕⭚⭟lleì୻l;쀀⫽⃥;쀀∂̸lint;樔ƀ;ceಒ⭰⭳uåಥĀ;cಘ⭸Ā;eಒ⭽ñಘȀAait⮈⮋⮝⮧rò⦈rrƀ;cw⮔⮕⮙憛;쀀⤳̸;쀀↝̸ghtarrow»⮕riĀ;eೋೖ΀chimpqu⮽⯍⯙⬄୸⯤⯯Ȁ;cerല⯆ഷ⯉uå൅;쀀𝓃ortɭ⬅\0\0⯖ará⭖mĀ;e൮⯟Ā;q൴൳suĀbp⯫⯭å೸åഋƀbcp⯶ⰑⰙȀ;Ees⯿ⰀഢⰄ抄;쀀⫅̸etĀ;eഛⰋqĀ;qണⰀcĀ;eലⰗñസȀ;EesⰢⰣൟⰧ抅;쀀⫆̸etĀ;e൘ⰮqĀ;qൠⰣȀgilrⰽⰿⱅⱇìௗlde耻ñ䃱çృiangleĀlrⱒⱜeftĀ;eచⱚñదightĀ;eೋⱥñ೗Ā;mⱬⱭ䎽ƀ;esⱴⱵⱹ䀣ro;愖p;怇ҀDHadgilrsⲏⲔⲙⲞⲣⲰⲶⳓⳣash;抭arr;椄p;쀀≍⃒ash;抬ĀetⲨⲬ;쀀≥⃒;쀀>⃒nfin;槞ƀAetⲽⳁⳅrr;椂;쀀≤⃒Ā;rⳊⳍ쀀<⃒ie;쀀⊴⃒ĀAtⳘⳜrr;椃rie;쀀⊵⃒im;쀀∼⃒ƀAan⳰⳴ⴂrr;懖rĀhr⳺⳽k;椣Ā;oᏧᏥear;椧ቓ᪕\0\0\0\0\0\0\0\0\0\0\0\0\0ⴭ\0ⴸⵈⵠⵥ⵲ⶄᬇ\0\0ⶍⶫ\0ⷈⷎ\0ⷜ⸙⸫⸾⹃Ācsⴱ᪗ute耻ó䃳ĀiyⴼⵅrĀ;c᪞ⵂ耻ô䃴;䐾ʀabios᪠ⵒⵗǈⵚlac;䅑v;樸old;榼lig;䅓Ācr⵩⵭ir;榿;쀀𝔬ͯ⵹\0\0⵼\0ⶂn;䋛ave耻ò䃲;槁Ābmⶈ෴ar;榵Ȁacitⶕ⶘ⶥⶨrò᪀Āir⶝ⶠr;榾oss;榻nå๒;槀ƀaeiⶱⶵⶹcr;䅍ga;䏉ƀcdnⷀⷅǍron;䎿;榶pf;쀀𝕠ƀaelⷔ⷗ǒr;榷rp;榹΀;adiosvⷪⷫⷮ⸈⸍⸐⸖戨rò᪆Ȁ;efmⷷⷸ⸂⸅橝rĀ;oⷾⷿ愴f»ⷿ耻ª䂪耻º䂺gof;抶r;橖lope;橗;橛ƀclo⸟⸡⸧ò⸁ash耻ø䃸l;折iŬⸯ⸴de耻õ䃵esĀ;aǛ⸺s;樶ml耻ö䃶bar;挽ૡ⹞\0⹽\0⺀⺝\0⺢⺹\0\0⻋ຜ\0⼓\0\0⼫⾼\0⿈rȀ;astЃ⹧⹲຅脀¶;l⹭⹮䂶leìЃɩ⹸\0\0⹻m;櫳;櫽y;䐿rʀcimpt⺋⺏⺓ᡥ⺗nt;䀥od;䀮il;怰enk;怱r;쀀𝔭ƀimo⺨⺰⺴Ā;v⺭⺮䏆;䏕maô੶ne;明ƀ;tv⺿⻀⻈䏀chfork»´;䏖Āau⻏⻟nĀck⻕⻝kĀ;h⇴⻛;愎ö⇴sҀ;abcdemst⻳⻴ᤈ⻹⻽⼄⼆⼊⼎䀫cir;樣ir;樢Āouᵀ⼂;樥;橲n肻±ຝim;樦wo;樧ƀipu⼙⼠⼥ntint;樕f;쀀𝕡nd耻£䂣Ԁ;Eaceinosu່⼿⽁⽄⽇⾁⾉⾒⽾⾶;檳p;檷uå໙Ā;c໎⽌̀;acens່⽙⽟⽦⽨⽾pproø⽃urlyeñ໙ñ໎ƀaes⽯⽶⽺pprox;檹qq;檵im;拨iíໟmeĀ;s⾈ຮ怲ƀEas⽸⾐⽺ð⽵ƀdfp໬⾙⾯ƀals⾠⾥⾪lar;挮ine;挒urf;挓Ā;t໻⾴ï໻rel;抰Āci⿀⿅r;쀀𝓅;䏈ncsp;怈̀fiopsu⿚⋢⿟⿥⿫⿱r;쀀𝔮pf;쀀𝕢rime;恗cr;쀀𝓆ƀaeo⿸〉〓tĀei⿾々rnionóڰnt;樖stĀ;e【】䀿ñἙô༔઀ABHabcdefhilmnoprstux぀けさすムㄎㄫㅇㅢㅲㆎ㈆㈕㈤㈩㉘㉮㉲㊐㊰㊷ƀartぇおがròႳòϝail;検aròᱥar;楤΀cdenqrtとふへみわゔヌĀeuねぱ;쀀∽̱te;䅕iãᅮmptyv;榳gȀ;del࿑らるろ;榒;榥å࿑uo耻»䂻rր;abcfhlpstw࿜ガクシスゼゾダッデナp;極Ā;f࿠ゴs;椠;椳s;椞ë≝ð✮l;楅im;楴l;憣;憝Āaiパフil;椚oĀ;nホボ戶aló༞ƀabrョリヮrò៥rk;杳ĀakンヽcĀekヹ・;䁽;䁝Āes㄂㄄;榌lĀduㄊㄌ;榎;榐Ȁaeuyㄗㄜㄧㄩron;䅙Ādiㄡㄥil;䅗ì࿲âヺ;䑀Ȁclqsㄴㄷㄽㅄa;椷dhar;楩uoĀ;rȎȍh;憳ƀacgㅎㅟངlȀ;ipsླྀㅘㅛႜnåႻarôྩt;断ƀilrㅩဣㅮsht;楽;쀀𝔯ĀaoㅷㆆrĀduㅽㅿ»ѻĀ;l႑ㆄ;楬Ā;vㆋㆌ䏁;䏱ƀgns㆕ㇹㇼht̀ahlrstㆤㆰ㇂㇘㇤㇮rrowĀ;t࿜ㆭaéトarpoonĀduㆻㆿowîㅾp»႒eftĀah㇊㇐rrowó࿪arpoonóՑightarrows;應quigarro÷ニhreetimes;拌g;䋚ingdotseñἲƀahm㈍㈐㈓rò࿪aòՑ;怏oustĀ;a㈞㈟掱che»㈟mid;櫮Ȁabpt㈲㈽㉀㉒Ānr㈷㈺g;柭r;懾rëဃƀafl㉇㉊㉎r;榆;쀀𝕣us;樮imes;樵Āap㉝㉧rĀ;g㉣㉤䀩t;榔olint;樒arò㇣Ȁachq㉻㊀Ⴜ㊅quo;怺r;쀀𝓇Ābu・㊊oĀ;rȔȓƀhir㊗㊛㊠reåㇸmes;拊iȀ;efl㊪ၙᠡ㊫方tri;槎luhar;楨;愞ൡ㋕㋛㋟㌬㌸㍱\0㍺㎤\0\0㏬㏰\0㐨㑈㑚㒭㒱㓊㓱\0㘖\0\0㘳cute;䅛quï➺Ԁ;Eaceinpsyᇭ㋳㋵㋿㌂㌋㌏㌟㌦㌩;檴ǰ㋺\0㋼;檸on;䅡uåᇾĀ;dᇳ㌇il;䅟rc;䅝ƀEas㌖㌘㌛;檶p;檺im;择olint;樓iíሄ;䑁otƀ;be㌴ᵇ㌵担;橦΀Aacmstx㍆㍊㍗㍛㍞㍣㍭rr;懘rĀhr㍐㍒ë∨Ā;oਸ਼਴t耻§䂧i;䀻war;椩mĀin㍩ðnuóñt;朶rĀ;o㍶⁕쀀𝔰Ȁacoy㎂㎆㎑㎠rp;景Āhy㎋㎏cy;䑉;䑈rtɭ㎙\0\0㎜iäᑤaraì⹯耻­䂭Āgm㎨㎴maƀ;fv㎱㎲㎲䏃;䏂Ѐ;deglnprካ㏅㏉㏎㏖㏞㏡㏦ot;橪Ā;q኱ኰĀ;E㏓㏔檞;檠Ā;E㏛㏜檝;檟e;扆lus;樤arr;楲aròᄽȀaeit㏸㐈㐏㐗Āls㏽㐄lsetmé㍪hp;樳parsl;槤Ādlᑣ㐔e;挣Ā;e㐜㐝檪Ā;s㐢㐣檬;쀀⪬︀ƀflp㐮㐳㑂tcy;䑌Ā;b㐸㐹䀯Ā;a㐾㐿槄r;挿f;쀀𝕤aĀdr㑍ЂesĀ;u㑔㑕晠it»㑕ƀcsu㑠㑹㒟Āau㑥㑯pĀ;sᆈ㑫;쀀⊓︀pĀ;sᆴ㑵;쀀⊔︀uĀbp㑿㒏ƀ;esᆗᆜ㒆etĀ;eᆗ㒍ñᆝƀ;esᆨᆭ㒖etĀ;eᆨ㒝ñᆮƀ;afᅻ㒦ְrť㒫ֱ»ᅼaròᅈȀcemt㒹㒾㓂㓅r;쀀𝓈tmîñiì㐕aræᆾĀar㓎㓕rĀ;f㓔ឿ昆Āan㓚㓭ightĀep㓣㓪psiloîỠhé⺯s»⡒ʀbcmnp㓻㕞ሉ㖋㖎Ҁ;Edemnprs㔎㔏㔑㔕㔞㔣㔬㔱㔶抂;櫅ot;檽Ā;dᇚ㔚ot;櫃ult;櫁ĀEe㔨㔪;櫋;把lus;檿arr;楹ƀeiu㔽㕒㕕tƀ;en㔎㕅㕋qĀ;qᇚ㔏eqĀ;q㔫㔨m;櫇Ābp㕚㕜;櫕;櫓c̀;acensᇭ㕬㕲㕹㕻㌦pproø㋺urlyeñᇾñᇳƀaes㖂㖈㌛pproø㌚qñ㌗g;晪ڀ123;Edehlmnps㖩㖬㖯ሜ㖲㖴㗀㗉㗕㗚㗟㗨㗭耻¹䂹耻²䂲耻³䂳;櫆Āos㖹㖼t;檾ub;櫘Ā;dሢ㗅ot;櫄sĀou㗏㗒l;柉b;櫗arr;楻ult;櫂ĀEe㗤㗦;櫌;抋lus;櫀ƀeiu㗴㘉㘌tƀ;enሜ㗼㘂qĀ;qሢ㖲eqĀ;q㗧㗤m;櫈Ābp㘑㘓;櫔;櫖ƀAan㘜㘠㘭rr;懙rĀhr㘦㘨ë∮Ā;oਫ਩war;椪lig耻ß䃟௡㙑㙝㙠ዎ㙳㙹\0㙾㛂\0\0\0\0\0㛛㜃\0㜉㝬\0\0\0㞇ɲ㙖\0\0㙛get;挖;䏄rë๟ƀaey㙦㙫㙰ron;䅥dil;䅣;䑂lrec;挕r;쀀𝔱Ȁeiko㚆㚝㚵㚼ǲ㚋\0㚑eĀ4fኄኁaƀ;sv㚘㚙㚛䎸ym;䏑Ācn㚢㚲kĀas㚨㚮pproø዁im»ኬsðኞĀas㚺㚮ð዁rn耻þ䃾Ǭ̟㛆⋧es膀×;bd㛏㛐㛘䃗Ā;aᤏ㛕r;樱;樰ƀeps㛡㛣㜀á⩍Ȁ;bcf҆㛬㛰㛴ot;挶ir;櫱Ā;o㛹㛼쀀𝕥rk;櫚á㍢rime;怴ƀaip㜏㜒㝤dåቈ΀adempst㜡㝍㝀㝑㝗㝜㝟ngleʀ;dlqr㜰㜱㜶㝀㝂斵own»ᶻeftĀ;e⠀㜾ñम;扜ightĀ;e㊪㝋ñၚot;旬inus;樺lus;樹b;槍ime;樻ezium;揢ƀcht㝲㝽㞁Āry㝷㝻;쀀𝓉;䑆cy;䑛rok;䅧Āio㞋㞎xô᝷headĀlr㞗㞠eftarro÷ࡏightarrow»ཝऀAHabcdfghlmoprstuw㟐㟓㟗㟤㟰㟼㠎㠜㠣㠴㡑㡝㡫㢩㣌㣒㣪㣶ròϭar;楣Ācr㟜㟢ute耻ú䃺òᅐrǣ㟪\0㟭y;䑞ve;䅭Āiy㟵㟺rc耻û䃻;䑃ƀabh㠃㠆㠋ròᎭlac;䅱aòᏃĀir㠓㠘sht;楾;쀀𝔲rave耻ù䃹š㠧㠱rĀlr㠬㠮»ॗ»ႃlk;斀Āct㠹㡍ɯ㠿\0\0㡊rnĀ;e㡅㡆挜r»㡆op;挏ri;旸Āal㡖㡚cr;䅫肻¨͉Āgp㡢㡦on;䅳f;쀀𝕦̀adhlsuᅋ㡸㡽፲㢑㢠ownáᎳarpoonĀlr㢈㢌efô㠭ighô㠯iƀ;hl㢙㢚㢜䏅»ᏺon»㢚parrows;懈ƀcit㢰㣄㣈ɯ㢶\0\0㣁rnĀ;e㢼㢽挝r»㢽op;挎ng;䅯ri;旹cr;쀀𝓊ƀdir㣙㣝㣢ot;拰lde;䅩iĀ;f㜰㣨»᠓Āam㣯㣲rò㢨l耻ü䃼angle;榧ހABDacdeflnoprsz㤜㤟㤩㤭㦵㦸㦽㧟㧤㧨㧳㧹㧽㨁㨠ròϷarĀ;v㤦㤧櫨;櫩asèϡĀnr㤲㤷grt;榜΀eknprst㓣㥆㥋㥒㥝㥤㦖appá␕othinçẖƀhir㓫⻈㥙opô⾵Ā;hᎷ㥢ïㆍĀiu㥩㥭gmá㎳Ābp㥲㦄setneqĀ;q㥽㦀쀀⊊︀;쀀⫋︀setneqĀ;q㦏㦒쀀⊋︀;쀀⫌︀Āhr㦛㦟etá㚜iangleĀlr㦪㦯eft»थight»ၑy;䐲ash»ံƀelr㧄㧒㧗ƀ;beⷪ㧋㧏ar;抻q;扚lip;拮Ābt㧜ᑨaòᑩr;쀀𝔳tré㦮suĀbp㧯㧱»ജ»൙pf;쀀𝕧roð໻tré㦴Ācu㨆㨋r;쀀𝓋Ābp㨐㨘nĀEe㦀㨖»㥾nĀEe㦒㨞»㦐igzag;榚΀cefoprs㨶㨻㩖㩛㩔㩡㩪irc;䅵Ādi㩀㩑Ābg㩅㩉ar;機eĀ;qᗺ㩏;扙erp;愘r;쀀𝔴pf;쀀𝕨Ā;eᑹ㩦atèᑹcr;쀀𝓌ૣណ㪇\0㪋\0㪐㪛\0\0㪝㪨㪫㪯\0\0㫃㫎\0㫘ៜ៟tré៑r;쀀𝔵ĀAa㪔㪗ròσrò৶;䎾ĀAa㪡㪤ròθrò৫að✓is;拻ƀdptឤ㪵㪾Āfl㪺ឩ;쀀𝕩imåឲĀAa㫇㫊ròώròਁĀcq㫒ីr;쀀𝓍Āpt៖㫜ré។Ѐacefiosu㫰㫽㬈㬌㬑㬕㬛㬡cĀuy㫶㫻te耻ý䃽;䑏Āiy㬂㬆rc;䅷;䑋n耻¥䂥r;쀀𝔶cy;䑗pf;쀀𝕪cr;쀀𝓎Ācm㬦㬩y;䑎l耻ÿ䃿Ԁacdefhiosw㭂㭈㭔㭘㭤㭩㭭㭴㭺㮀cute;䅺Āay㭍㭒ron;䅾;䐷ot;䅼Āet㭝㭡træᕟa;䎶r;쀀𝔷cy;䐶grarr;懝pf;쀀𝕫cr;쀀𝓏Ājn㮅㮇;怍j;怌'.split("").map(t=>t.charCodeAt(0))),xmlDecodeTree=new Uint16Array("Ȁaglq	\x1Bɭ\0\0p;䀦os;䀧t;䀾t;䀼uot;䀢".split("").map(t=>t.charCodeAt(0)));var _a$1;const decodeMap=new Map([[0,65533],[128,8364],[130,8218],[131,402],[132,8222],[133,8230],[134,8224],[135,8225],[136,710],[137,8240],[138,352],[139,8249],[140,338],[142,381],[145,8216],[146,8217],[147,8220],[148,8221],[149,8226],[150,8211],[151,8212],[152,732],[153,8482],[154,353],[155,8250],[156,339],[158,382],[159,376]]),fromCodePoint=(_a$1=String.fromCodePoint)!==null&&_a$1!==void 0?_a$1:function(t){let e="";return t>65535&&(t-=65536,e+=String.fromCharCode(t>>>10&1023|55296),t=56320|t&1023),e+=String.fromCharCode(t),e};function replaceCodePoint(t){var e;return t>=55296&&t<=57343||t>1114111?65533:(e=decodeMap.get(t))!==null&&e!==void 0?e:t}var CharCodes$1;(function(t){t[t.NUM=35]="NUM",t[t.SEMI=59]="SEMI",t[t.EQUALS=61]="EQUALS",t[t.ZERO=48]="ZERO",t[t.NINE=57]="NINE",t[t.LOWER_A=97]="LOWER_A",t[t.LOWER_F=102]="LOWER_F",t[t.LOWER_X=120]="LOWER_X",t[t.LOWER_Z=122]="LOWER_Z",t[t.UPPER_A=65]="UPPER_A",t[t.UPPER_F=70]="UPPER_F",t[t.UPPER_Z=90]="UPPER_Z"})(CharCodes$1||(CharCodes$1={}));const TO_LOWER_BIT=32;var BinTrieFlags;(function(t){t[t.VALUE_LENGTH=49152]="VALUE_LENGTH",t[t.BRANCH_LENGTH=16256]="BRANCH_LENGTH",t[t.JUMP_TABLE=127]="JUMP_TABLE"})(BinTrieFlags||(BinTrieFlags={}));function isNumber$1(t){return t>=CharCodes$1.ZERO&&t<=CharCodes$1.NINE}function isHexadecimalCharacter(t){return t>=CharCodes$1.UPPER_A&&t<=CharCodes$1.UPPER_F||t>=CharCodes$1.LOWER_A&&t<=CharCodes$1.LOWER_F}function isAsciiAlphaNumeric$1(t){return t>=CharCodes$1.UPPER_A&&t<=CharCodes$1.UPPER_Z||t>=CharCodes$1.LOWER_A&&t<=CharCodes$1.LOWER_Z||isNumber$1(t)}function isEntityInAttributeInvalidEnd$1(t){return t===CharCodes$1.EQUALS||isAsciiAlphaNumeric$1(t)}var EntityDecoderState;(function(t){t[t.EntityStart=0]="EntityStart",t[t.NumericStart=1]="NumericStart",t[t.NumericDecimal=2]="NumericDecimal",t[t.NumericHex=3]="NumericHex",t[t.NamedEntity=4]="NamedEntity"})(EntityDecoderState||(EntityDecoderState={}));var DecodingMode;(function(t){t[t.Legacy=0]="Legacy",t[t.Strict=1]="Strict",t[t.Attribute=2]="Attribute"})(DecodingMode||(DecodingMode={}));class EntityDecoder{constructor(e,s,n){this.decodeTree=e,this.emitCodePoint=s,this.errors=n,this.state=EntityDecoderState.EntityStart,this.consumed=1,this.result=0,this.treeIndex=0,this.excess=1,this.decodeMode=DecodingMode.Strict}startEntity(e){this.decodeMode=e,this.state=EntityDecoderState.EntityStart,this.result=0,this.treeIndex=0,this.excess=1,this.consumed=1}write(e,s){switch(this.state){case EntityDecoderState.EntityStart:return e.charCodeAt(s)===CharCodes$1.NUM?(this.state=EntityDecoderState.NumericStart,this.consumed+=1,this.stateNumericStart(e,s+1)):(this.state=EntityDecoderState.NamedEntity,this.stateNamedEntity(e,s));case EntityDecoderState.NumericStart:return this.stateNumericStart(e,s);case EntityDecoderState.NumericDecimal:return this.stateNumericDecimal(e,s);case EntityDecoderState.NumericHex:return this.stateNumericHex(e,s);case EntityDecoderState.NamedEntity:return this.stateNamedEntity(e,s)}}stateNumericStart(e,s){return s>=e.length?-1:(e.charCodeAt(s)|TO_LOWER_BIT)===CharCodes$1.LOWER_X?(this.state=EntityDecoderState.NumericHex,this.consumed+=1,this.stateNumericHex(e,s+1)):(this.state=EntityDecoderState.NumericDecimal,this.stateNumericDecimal(e,s))}addToNumericResult(e,s,n,r){if(s!==n){const a=n-s;this.result=this.result*Math.pow(r,a)+parseInt(e.substr(s,a),r),this.consumed+=a}}stateNumericHex(e,s){const n=s;for(;s<e.length;){const r=e.charCodeAt(s);if(isNumber$1(r)||isHexadecimalCharacter(r))s+=1;else return this.addToNumericResult(e,n,s,16),this.emitNumericEntity(r,3)}return this.addToNumericResult(e,n,s,16),-1}stateNumericDecimal(e,s){const n=s;for(;s<e.length;){const r=e.charCodeAt(s);if(isNumber$1(r))s+=1;else return this.addToNumericResult(e,n,s,10),this.emitNumericEntity(r,2)}return this.addToNumericResult(e,n,s,10),-1}emitNumericEntity(e,s){var n;if(this.consumed<=s)return(n=this.errors)===null||n===void 0||n.absenceOfDigitsInNumericCharacterReference(this.consumed),0;if(e===CharCodes$1.SEMI)this.consumed+=1;else if(this.decodeMode===DecodingMode.Strict)return 0;return this.emitCodePoint(replaceCodePoint(this.result),this.consumed),this.errors&&(e!==CharCodes$1.SEMI&&this.errors.missingSemicolonAfterCharacterReference(),this.errors.validateNumericCharacterReference(this.result)),this.consumed}stateNamedEntity(e,s){const{decodeTree:n}=this;let r=n[this.treeIndex],a=(r&BinTrieFlags.VALUE_LENGTH)>>14;for(;s<e.length;s++,this.excess++){const i=e.charCodeAt(s);if(this.treeIndex=determineBranch(n,r,this.treeIndex+Math.max(1,a),i),this.treeIndex<0)return this.result===0||this.decodeMode===DecodingMode.Attribute&&(a===0||isEntityInAttributeInvalidEnd$1(i))?0:this.emitNotTerminatedNamedEntity();if(r=n[this.treeIndex],a=(r&BinTrieFlags.VALUE_LENGTH)>>14,a!==0){if(i===CharCodes$1.SEMI)return this.emitNamedEntityData(this.treeIndex,a,this.consumed+this.excess);this.decodeMode!==DecodingMode.Strict&&(this.result=this.treeIndex,this.consumed+=this.excess,this.excess=0)}}return-1}emitNotTerminatedNamedEntity(){var e;const{result:s,decodeTree:n}=this,r=(n[s]&BinTrieFlags.VALUE_LENGTH)>>14;return this.emitNamedEntityData(s,r,this.consumed),(e=this.errors)===null||e===void 0||e.missingSemicolonAfterCharacterReference(),this.consumed}emitNamedEntityData(e,s,n){const{decodeTree:r}=this;return this.emitCodePoint(s===1?r[e]&~BinTrieFlags.VALUE_LENGTH:r[e+1],n),s===3&&this.emitCodePoint(r[e+2],n),n}end(){var e;switch(this.state){case EntityDecoderState.NamedEntity:return this.result!==0&&(this.decodeMode!==DecodingMode.Attribute||this.result===this.treeIndex)?this.emitNotTerminatedNamedEntity():0;case EntityDecoderState.NumericDecimal:return this.emitNumericEntity(0,2);case EntityDecoderState.NumericHex:return this.emitNumericEntity(0,3);case EntityDecoderState.NumericStart:return(e=this.errors)===null||e===void 0||e.absenceOfDigitsInNumericCharacterReference(this.consumed),0;case EntityDecoderState.EntityStart:return 0}}}function getDecoder(t){let e="";const s=new EntityDecoder(t,n=>e+=fromCodePoint(n));return function(r,a){let i=0,u=0;for(;(u=r.indexOf("&",u))>=0;){e+=r.slice(i,u),s.startEntity(a);const c=s.write(r,u+1);if(c<0){i=u+s.end();break}i=u+c,u=c===0?i+1:i}const f=e+r.slice(i);return e="",f}}function determineBranch(t,e,s,n){const r=(e&BinTrieFlags.BRANCH_LENGTH)>>7,a=e&BinTrieFlags.JUMP_TABLE;if(r===0)return a!==0&&n===a?s:-1;if(a){const f=n-a;return f<0||f>=r?-1:t[s+f]-1}let i=s,u=i+r-1;for(;i<=u;){const f=i+u>>>1,c=t[f];if(c<n)i=f+1;else if(c>n)u=f-1;else return t[f+r]}return-1}getDecoder(htmlDecodeTree),getDecoder(xmlDecodeTree);const xmlReplacer=/["&'<>$\x80-\uFFFF]/g,xmlCodeMap=new Map([[34,"&quot;"],[38,"&amp;"],[39,"&apos;"],[60,"&lt;"],[62,"&gt;"]]),getCodePoint=String.prototype.codePointAt!=null?(t,e)=>t.codePointAt(e):(t,e)=>(t.charCodeAt(e)&64512)===55296?(t.charCodeAt(e)-55296)*1024+t.charCodeAt(e+1)-56320+65536:t.charCodeAt(e);function encodeXML(t){let e="",s=0,n;for(;(n=xmlReplacer.exec(t))!==null;){const r=n.index,a=t.charCodeAt(r),i=xmlCodeMap.get(a);i!==void 0?(e+=t.substring(s,r)+i,s=r+1):(e+=`${t.substring(s,r)}&#x${getCodePoint(t,r).toString(16)};`,s=xmlReplacer.lastIndex+=+((a&64512)===55296))}return e+t.substr(s)}function getEscaper(t,e){return function(n){let r,a=0,i="";for(;r=t.exec(n);)a!==r.index&&(i+=n.substring(a,r.index)),i+=e.get(r[0].charCodeAt(0)),a=r.index+1;return i+n.substring(a)}}const escapeAttribute=getEscaper(/["&\u00A0]/g,new Map([[34,"&quot;"],[38,"&amp;"],[160,"&nbsp;"]])),escapeText=getEscaper(/[&<>\u00A0]/g,new Map([[38,"&amp;"],[60,"&lt;"],[62,"&gt;"],[160,"&nbsp;"]])),elementNames=new Map(["altGlyph","altGlyphDef","altGlyphItem","animateColor","animateMotion","animateTransform","clipPath","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","foreignObject","glyphRef","linearGradient","radialGradient","textPath"].map(t=>[t.toLowerCase(),t])),attributeNames=new Map(["definitionURL","attributeName","attributeType","baseFrequency","baseProfile","calcMode","clipPathUnits","diffuseConstant","edgeMode","filterUnits","glyphRef","gradientTransform","gradientUnits","kernelMatrix","kernelUnitLength","keyPoints","keySplines","keyTimes","lengthAdjust","limitingConeAngle","markerHeight","markerUnits","markerWidth","maskContentUnits","maskUnits","numOctaves","pathLength","patternContentUnits","patternTransform","patternUnits","pointsAtX","pointsAtY","pointsAtZ","preserveAlpha","preserveAspectRatio","primitiveUnits","refX","refY","repeatCount","repeatDur","requiredExtensions","requiredFeatures","specularConstant","specularExponent","spreadMethod","startOffset","stdDeviation","stitchTiles","surfaceScale","systemLanguage","tableValues","targetX","targetY","textLength","viewBox","viewTarget","xChannelSelector","yChannelSelector","zoomAndPan"].map(t=>[t.toLowerCase(),t])),unencodedElements=new Set(["style","script","xmp","iframe","noembed","noframes","plaintext","noscript"]);function replaceQuotes(t){return t.replace(/"/g,"&quot;")}function formatAttributes(t,e){var s;if(!t)return;const n=((s=e.encodeEntities)!==null&&s!==void 0?s:e.decodeEntities)===!1?replaceQuotes:e.xmlMode||e.encodeEntities!=="utf8"?encodeXML:escapeAttribute;return Object.keys(t).map(r=>{var a,i;const u=(a=t[r])!==null&&a!==void 0?a:"";return e.xmlMode==="foreign"&&(r=(i=attributeNames.get(r))!==null&&i!==void 0?i:r),!e.emptyAttrs&&!e.xmlMode&&u===""?r:`${r}="${n(u)}"`}).join(" ")}const singleTag=new Set(["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr"]);function render$1(t,e={}){const s="length"in t?t:[t];let n="";for(let r=0;r<s.length;r++)n+=renderNode(s[r],e);return n}function renderNode(t,e){switch(t.type){case Root:return render$1(t.children,e);case Doctype:case Directive:return renderDirective(t);case Comment$1:return renderComment(t);case CDATA$1:return renderCdata(t);case Script:case Style:case Tag:return renderTag(t,e);case Text$1:return renderText(t,e)}}const foreignModeIntegrationPoints=new Set(["mi","mo","mn","ms","mtext","annotation-xml","foreignObject","desc","title"]),foreignElements=new Set(["svg","math"]);function renderTag(t,e){var s;e.xmlMode==="foreign"&&(t.name=(s=elementNames.get(t.name))!==null&&s!==void 0?s:t.name,t.parent&&foreignModeIntegrationPoints.has(t.parent.name)&&(e={...e,xmlMode:!1})),!e.xmlMode&&foreignElements.has(t.name)&&(e={...e,xmlMode:"foreign"});let n=`<${t.name}`;const r=formatAttributes(t.attribs,e);return r&&(n+=` ${r}`),t.children.length===0&&(e.xmlMode?e.selfClosingTags!==!1:e.selfClosingTags&&singleTag.has(t.name))?(e.xmlMode||(n+=" "),n+="/>"):(n+=">",t.children.length>0&&(n+=render$1(t.children,e)),(e.xmlMode||!singleTag.has(t.name))&&(n+=`</${t.name}>`)),n}function renderDirective(t){return`<${t.data}>`}function renderText(t,e){var s;let n=t.data||"";return((s=e.encodeEntities)!==null&&s!==void 0?s:e.decodeEntities)!==!1&&!(!e.xmlMode&&t.parent&&unencodedElements.has(t.parent.name))&&(n=e.xmlMode||e.encodeEntities!=="utf8"?encodeXML(n):escapeText(n)),n}function renderCdata(t){return`<![CDATA[${t.children[0].data}]]>`}function renderComment(t){return`<!--${t.data}-->`}function getOuterHTML(t,e){return render$1(t,e)}function getInnerHTML(t,e){return hasChildren(t)?t.children.map(s=>getOuterHTML(s,e)).join(""):""}function getText(t){return Array.isArray(t)?t.map(getText).join(""):isTag(t)?t.name==="br"?`
`:getText(t.children):isCDATA(t)?getText(t.children):isText(t)?t.data:""}function textContent(t){return Array.isArray(t)?t.map(textContent).join(""):hasChildren(t)&&!isComment(t)?textContent(t.children):isText(t)?t.data:""}function innerText(t){return Array.isArray(t)?t.map(innerText).join(""):hasChildren(t)&&(t.type===ElementType.Tag||isCDATA(t))?innerText(t.children):isText(t)?t.data:""}function getChildren(t){return hasChildren(t)?t.children:[]}function getParent(t){return t.parent||null}function getSiblings(t){const e=getParent(t);if(e!=null)return getChildren(e);const s=[t];let{prev:n,next:r}=t;for(;n!=null;)s.unshift(n),{prev:n}=n;for(;r!=null;)s.push(r),{next:r}=r;return s}function getAttributeValue(t,e){var s;return(s=t.attribs)===null||s===void 0?void 0:s[e]}function hasAttrib(t,e){return t.attribs!=null&&Object.prototype.hasOwnProperty.call(t.attribs,e)&&t.attribs[e]!=null}function getName$1(t){return t.name}function nextElementSibling(t){let{next:e}=t;for(;e!==null&&!isTag(e);)({next:e}=e);return e}function prevElementSibling(t){let{prev:e}=t;for(;e!==null&&!isTag(e);)({prev:e}=e);return e}function removeElement(t){if(t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t.parent){const e=t.parent.children,s=e.lastIndexOf(t);s>=0&&e.splice(s,1)}t.next=null,t.prev=null,t.parent=null}function replaceElement(t,e){const s=e.prev=t.prev;s&&(s.next=e);const n=e.next=t.next;n&&(n.prev=e);const r=e.parent=t.parent;if(r){const a=r.children;a[a.lastIndexOf(t)]=e,t.parent=null}}function appendChild(t,e){if(removeElement(e),e.next=null,e.parent=t,t.children.push(e)>1){const s=t.children[t.children.length-2];s.next=e,e.prev=s}else e.prev=null}function append$1(t,e){removeElement(e);const{parent:s}=t,n=t.next;if(e.next=n,e.prev=t,t.next=e,e.parent=s,n){if(n.prev=e,s){const r=s.children;r.splice(r.lastIndexOf(n),0,e)}}else s&&s.children.push(e)}function prependChild(t,e){if(removeElement(e),e.parent=t,e.prev=null,t.children.unshift(e)!==1){const s=t.children[1];s.prev=e,e.next=s}else e.next=null}function prepend$1(t,e){removeElement(e);const{parent:s}=t;if(s){const n=s.children;n.splice(n.indexOf(t),0,e)}t.prev&&(t.prev.next=e),e.parent=s,e.prev=t.prev,e.next=t,t.prev=e}function filter$2(t,e,s=!0,n=1/0){return find$2(t,Array.isArray(e)?e:[e],s,n)}function find$2(t,e,s,n){const r=[],a=[e],i=[0];for(;;){if(i[0]>=a[0].length){if(i.length===1)return r;a.shift(),i.shift();continue}const u=a[0][i[0]++];if(t(u)&&(r.push(u),--n<=0))return r;s&&hasChildren(u)&&u.children.length>0&&(i.unshift(0),a.unshift(u.children))}}function findOneChild(t,e){return e.find(t)}function findOne(t,e,s=!0){let n=null;for(let r=0;r<e.length&&!n;r++){const a=e[r];if(isTag(a))t(a)?n=a:s&&a.children.length>0&&(n=findOne(t,a.children,!0));else continue}return n}function existsOne(t,e){return e.some(s=>isTag(s)&&(t(s)||existsOne(t,s.children)))}function findAll(t,e){const s=[],n=[e],r=[0];for(;;){if(r[0]>=n[0].length){if(n.length===1)return s;n.shift(),r.shift();continue}const a=n[0][r[0]++];isTag(a)&&(t(a)&&s.push(a),a.children.length>0&&(r.unshift(0),n.unshift(a.children)))}}const Checks={tag_name(t){return typeof t=="function"?e=>isTag(e)&&t(e.name):t==="*"?isTag:e=>isTag(e)&&e.name===t},tag_type(t){return typeof t=="function"?e=>t(e.type):e=>e.type===t},tag_contains(t){return typeof t=="function"?e=>isText(e)&&t(e.data):e=>isText(e)&&e.data===t}};function getAttribCheck(t,e){return typeof e=="function"?s=>isTag(s)&&e(s.attribs[t]):s=>isTag(s)&&s.attribs[t]===e}function combineFuncs(t,e){return s=>t(s)||e(s)}function compileTest(t){const e=Object.keys(t).map(s=>{const n=t[s];return Object.prototype.hasOwnProperty.call(Checks,s)?Checks[s](n):getAttribCheck(s,n)});return e.length===0?null:e.reduce(combineFuncs)}function testElement(t,e){const s=compileTest(t);return s?s(e):!0}function getElements(t,e,s,n=1/0){const r=compileTest(t);return r?filter$2(r,e,s,n):[]}function getElementById(t,e,s=!0){return Array.isArray(e)||(e=[e]),findOne(getAttribCheck("id",t),e,s)}function getElementsByTagName(t,e,s=!0,n=1/0){return filter$2(Checks.tag_name(t),e,s,n)}function getElementsByTagType(t,e,s=!0,n=1/0){return filter$2(Checks.tag_type(t),e,s,n)}function removeSubsets(t){let e=t.length;for(;--e>=0;){const s=t[e];if(e>0&&t.lastIndexOf(s,e-1)>=0){t.splice(e,1);continue}for(let n=s.parent;n;n=n.parent)if(t.includes(n)){t.splice(e,1);break}}return t}var DocumentPosition;(function(t){t[t.DISCONNECTED=1]="DISCONNECTED",t[t.PRECEDING=2]="PRECEDING",t[t.FOLLOWING=4]="FOLLOWING",t[t.CONTAINS=8]="CONTAINS",t[t.CONTAINED_BY=16]="CONTAINED_BY"})(DocumentPosition||(DocumentPosition={}));function compareDocumentPosition(t,e){const s=[],n=[];if(t===e)return 0;let r=hasChildren(t)?t:t.parent;for(;r;)s.unshift(r),r=r.parent;for(r=hasChildren(e)?e:e.parent;r;)n.unshift(r),r=r.parent;const a=Math.min(s.length,n.length);let i=0;for(;i<a&&s[i]===n[i];)i++;if(i===0)return DocumentPosition.DISCONNECTED;const u=s[i-1],f=u.children,c=s[i],d=n[i];return f.indexOf(c)>f.indexOf(d)?u===e?DocumentPosition.FOLLOWING|DocumentPosition.CONTAINED_BY:DocumentPosition.FOLLOWING:u===t?DocumentPosition.PRECEDING|DocumentPosition.CONTAINS:DocumentPosition.PRECEDING}function uniqueSort(t){return t=t.filter((e,s,n)=>!n.includes(e,s+1)),t.sort((e,s)=>{const n=compareDocumentPosition(e,s);return n&DocumentPosition.PRECEDING?-1:n&DocumentPosition.FOLLOWING?1:0}),t}function getFeed(t){const e=getOneElement(isValidFeed,t);return e?e.name==="feed"?getAtomFeed(e):getRssFeed(e):null}function getAtomFeed(t){var e;const s=t.children,n={type:"atom",items:getElementsByTagName("entry",s).map(i=>{var u;const{children:f}=i,c={media:getMediaElements(f)};addConditionally(c,"id","id",f),addConditionally(c,"title","title",f);const d=(u=getOneElement("link",f))===null||u===void 0?void 0:u.attribs.href;d&&(c.link=d);const h=fetch$2("summary",f)||fetch$2("content",f);h&&(c.description=h);const m=fetch$2("updated",f);return m&&(c.pubDate=new Date(m)),c})};addConditionally(n,"id","id",s),addConditionally(n,"title","title",s);const r=(e=getOneElement("link",s))===null||e===void 0?void 0:e.attribs.href;r&&(n.link=r),addConditionally(n,"description","subtitle",s);const a=fetch$2("updated",s);return a&&(n.updated=new Date(a)),addConditionally(n,"author","email",s,!0),n}function getRssFeed(t){var e,s;const n=(s=(e=getOneElement("channel",t.children))===null||e===void 0?void 0:e.children)!==null&&s!==void 0?s:[],r={type:t.name.substr(0,3),id:"",items:getElementsByTagName("item",t.children).map(i=>{const{children:u}=i,f={media:getMediaElements(u)};addConditionally(f,"id","guid",u),addConditionally(f,"title","title",u),addConditionally(f,"link","link",u),addConditionally(f,"description","description",u);const c=fetch$2("pubDate",u)||fetch$2("dc:date",u);return c&&(f.pubDate=new Date(c)),f})};addConditionally(r,"title","title",n),addConditionally(r,"link","link",n),addConditionally(r,"description","description",n);const a=fetch$2("lastBuildDate",n);return a&&(r.updated=new Date(a)),addConditionally(r,"author","managingEditor",n,!0),r}const MEDIA_KEYS_STRING=["url","type","lang"],MEDIA_KEYS_INT=["fileSize","bitrate","framerate","samplingrate","channels","duration","height","width"];function getMediaElements(t){return getElementsByTagName("media:content",t).map(e=>{const{attribs:s}=e,n={medium:s.medium,isDefault:!!s.isDefault};for(const r of MEDIA_KEYS_STRING)s[r]&&(n[r]=s[r]);for(const r of MEDIA_KEYS_INT)s[r]&&(n[r]=parseInt(s[r],10));return s.expression&&(n.expression=s.expression),n})}function getOneElement(t,e){return getElementsByTagName(t,e,!0,1)[0]}function fetch$2(t,e,s=!1){return textContent(getElementsByTagName(t,e,s,1)).trim()}function addConditionally(t,e,s,n,r=!1){const a=fetch$2(s,n,r);a&&(t[e]=a)}function isValidFeed(t){return t==="rss"||t==="feed"||t==="rdf:RDF"}const DomUtils=Object.freeze(Object.defineProperty({__proto__:null,get DocumentPosition(){return DocumentPosition},append:append$1,appendChild,compareDocumentPosition,existsOne,filter:filter$2,find:find$2,findAll,findOne,findOneChild,getAttributeValue,getChildren,getElementById,getElements,getElementsByTagName,getElementsByTagType,getFeed,getInnerHTML,getName:getName$1,getOuterHTML,getParent,getSiblings,getText,hasAttrib,hasChildren,innerText,isCDATA,isComment,isDocument,isTag,isText,nextElementSibling,prepend:prepend$1,prependChild,prevElementSibling,removeElement,removeSubsets,replaceElement,testElement,textContent,uniqueSort},Symbol.toStringTag,{value:"Module"}));function render(t,e,s){return t?t(e??t._root.children,null,void 0,s).toString():""}function isOptions(t,e){return!e&&typeof t=="object"&&t!=null&&!("length"in t)&&!("type"in t)}function html$1(t,e){const s=isOptions(t)?(e=t,void 0):t,n={...defaultOpts$2,...this===null||this===void 0?void 0:this._options,...flatten(e??{})};return render(this,s,n)}function xml(t){const e={...this._options,xmlMode:!0};return render(this,t,e)}function text$1(t){const e=t||(this?this.root():[]);let s="";for(let n=0;n<e.length;n++)s+=textContent(e[n]);return s}function parseHTML(t,e,s=typeof e=="boolean"?e:!1){if(!t||typeof t!="string")return null;typeof e=="boolean"&&(s=e);const n=this.load(t,defaultOpts$2,!1);return s||n("script").remove(),n.root()[0].children.slice()}function root$1(){return this(this._root)}function contains(t,e){if(e===t)return!1;let s=e;for(;s&&s!==s.parent;)if(s=s.parent,s===t)return!0;return!1}function merge(t,e){if(!isArrayLike(t)||!isArrayLike(e))return;let s=t.length;const n=+e.length;for(let r=0;r<n;r++)t[s++]=e[r];return t.length=s,t}function isArrayLike(t){if(Array.isArray(t))return!0;if(typeof t!="object"||!Object.prototype.hasOwnProperty.call(t,"length")||typeof t.length!="number"||t.length<0)return!1;for(let e=0;e<t.length;e++)if(!(e in t))return!1;return!0}const staticMethods=Object.freeze(Object.defineProperty({__proto__:null,contains,html:html$1,merge,parseHTML,root:root$1,text:text$1,xml},Symbol.toStringTag,{value:"Module"}));function isCheerio(t){return t.cheerio!=null}function camelCase$1(t){return t.replace(/[_.-](\w|$)/g,(e,s)=>s.toUpperCase())}function cssCase(t){return t.replace(/[A-Z]/g,"-$&").toLowerCase()}function domEach(t,e){const s=t.length;for(let n=0;n<s;n++)e(t[n],n);return t}function cloneDom(t){const e="length"in t?Array.prototype.map.call(t,n=>cloneNode(n,!0)):[cloneNode(t,!0)],s=new Document(e);return e.forEach(n=>{n.parent=s}),e}var CharacterCodes;(function(t){t[t.LowerA=97]="LowerA",t[t.LowerZ=122]="LowerZ",t[t.UpperA=65]="UpperA",t[t.UpperZ=90]="UpperZ",t[t.Exclamation=33]="Exclamation"})(CharacterCodes||(CharacterCodes={}));function isHtml(t){const e=t.indexOf("<");if(e<0||e>t.length-3)return!1;const s=t.charCodeAt(e+1);return(s>=CharacterCodes.LowerA&&s<=CharacterCodes.LowerZ||s>=CharacterCodes.UpperA&&s<=CharacterCodes.UpperZ||s===CharacterCodes.Exclamation)&&t.includes(">",e+2)}const hasOwn$1=Object.prototype.hasOwnProperty,rspace=/\s+/,dataAttrPrefix="data-",primitives={null:null,true:!0,false:!1},rboolean=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,rbrace=/^{[^]*}$|^\[[^]*]$/;function getAttr(t,e,s){var n;if(!(!t||!isTag(t))){if((n=t.attribs)!==null&&n!==void 0||(t.attribs={}),!e)return t.attribs;if(hasOwn$1.call(t.attribs,e))return!s&&rboolean.test(e)?e:t.attribs[e];if(t.name==="option"&&e==="value")return text$1(t.children);if(t.name==="input"&&(t.attribs.type==="radio"||t.attribs.type==="checkbox")&&e==="value")return"on"}}function setAttr(t,e,s){s===null?removeAttribute(t,e):t.attribs[e]=`${s}`}function attr(t,e){if(typeof t=="object"||e!==void 0){if(typeof e=="function"){if(typeof t!="string")throw new Error("Bad combination of arguments.");return domEach(this,(s,n)=>{isTag(s)&&setAttr(s,t,e.call(s,n,s.attribs[t]))})}return domEach(this,s=>{isTag(s)&&(typeof t=="object"?Object.keys(t).forEach(n=>{const r=t[n];setAttr(s,n,r)}):setAttr(s,t,e))})}return arguments.length>1?this:getAttr(this[0],t,this.options.xmlMode)}function getProp(t,e,s){return e in t?t[e]:!s&&rboolean.test(e)?getAttr(t,e,!1)!==void 0:getAttr(t,e,s)}function setProp(t,e,s,n){e in t?t[e]=s:setAttr(t,e,!n&&rboolean.test(e)?s?"":null:`${s}`)}function prop(t,e){var s;if(typeof t=="string"&&e===void 0){const n=this[0];if(!n||!isTag(n))return;switch(t){case"style":{const r=this.css(),a=Object.keys(r);return a.forEach((i,u)=>{r[u]=i}),r.length=a.length,r}case"tagName":case"nodeName":return n.name.toUpperCase();case"href":case"src":{const r=(s=n.attribs)===null||s===void 0?void 0:s[t];return typeof URL<"u"&&(t==="href"&&(n.tagName==="a"||n.name==="link")||t==="src"&&(n.tagName==="img"||n.tagName==="iframe"||n.tagName==="audio"||n.tagName==="video"||n.tagName==="source"))&&r!==void 0&&this.options.baseURI?new URL(r,this.options.baseURI).href:r}case"innerText":return innerText(n);case"textContent":return textContent(n);case"outerHTML":return this.clone().wrap("<container />").parent().html();case"innerHTML":return this.html();default:return getProp(n,t,this.options.xmlMode)}}if(typeof t=="object"||e!==void 0){if(typeof e=="function"){if(typeof t=="object")throw new Error("Bad combination of arguments.");return domEach(this,(n,r)=>{isTag(n)&&setProp(n,t,e.call(n,r,getProp(n,t,this.options.xmlMode)),this.options.xmlMode)})}return domEach(this,n=>{isTag(n)&&(typeof t=="object"?Object.keys(t).forEach(r=>{const a=t[r];setProp(n,r,a,this.options.xmlMode)}):setProp(n,t,e,this.options.xmlMode))})}}function setData(t,e,s){var n;const r=t;(n=r.data)!==null&&n!==void 0||(r.data={}),typeof e=="object"?Object.assign(r.data,e):typeof e=="string"&&s!==void 0&&(r.data[e]=s)}function readData(t,e){let s,n,r;e==null?(s=Object.keys(t.attribs).filter(a=>a.startsWith(dataAttrPrefix)),n=s.map(a=>camelCase$1(a.slice(dataAttrPrefix.length)))):(s=[dataAttrPrefix+cssCase(e)],n=[e]);for(let a=0;a<s.length;++a){const i=s[a],u=n[a];if(hasOwn$1.call(t.attribs,i)&&!hasOwn$1.call(t.data,u)){if(r=t.attribs[i],hasOwn$1.call(primitives,r))r=primitives[r];else if(r===String(Number(r)))r=Number(r);else if(rbrace.test(r))try{r=JSON.parse(r)}catch{}t.data[u]=r}}return e==null?t.data:r}function data(t,e){var s;const n=this[0];if(!n||!isTag(n))return;const r=n;return(s=r.data)!==null&&s!==void 0||(r.data={}),t?typeof t=="object"||e!==void 0?(domEach(this,a=>{isTag(a)&&(typeof t=="object"?setData(a,t):setData(a,t,e))}),this):hasOwn$1.call(r.data,t)?r.data[t]:readData(r,t):readData(r)}function val(t){const e=arguments.length===0,s=this[0];if(!s||!isTag(s))return e?void 0:this;switch(s.name){case"textarea":return this.text(t);case"select":{const n=this.find("option:selected");if(!e){if(this.attr("multiple")==null&&typeof t=="object")return this;this.find("option").removeAttr("selected");const r=typeof t!="object"?[t]:t;for(let a=0;a<r.length;a++)this.find(`option[value="${r[a]}"]`).attr("selected","");return this}return this.attr("multiple")?n.toArray().map(r=>text$1(r.children)):n.attr("value")}case"input":case"option":return e?this.attr("value"):this.attr("value",t)}}function removeAttribute(t,e){!t.attribs||!hasOwn$1.call(t.attribs,e)||delete t.attribs[e]}function splitNames(t){return t?t.trim().split(rspace):[]}function removeAttr(t){const e=splitNames(t);for(let s=0;s<e.length;s++)domEach(this,n=>{isTag(n)&&removeAttribute(n,e[s])});return this}function hasClass(t){return this.toArray().some(e=>{const s=isTag(e)&&e.attribs.class;let n=-1;if(s&&t.length)for(;(n=s.indexOf(t,n+1))>-1;){const r=n+t.length;if((n===0||rspace.test(s[n-1]))&&(r===s.length||rspace.test(s[r])))return!0}return!1})}function addClass(t){if(typeof t=="function")return domEach(this,(n,r)=>{if(isTag(n)){const a=n.attribs.class||"";addClass.call([n],t.call(n,r,a))}});if(!t||typeof t!="string")return this;const e=t.split(rspace),s=this.length;for(let n=0;n<s;n++){const r=this[n];if(!isTag(r))continue;const a=getAttr(r,"class",!1);if(!a)setAttr(r,"class",e.join(" ").trim());else{let i=` ${a} `;for(let u=0;u<e.length;u++){const f=`${e[u]} `;i.includes(` ${f}`)||(i+=f)}setAttr(r,"class",i.trim())}}return this}function removeClass(t){if(typeof t=="function")return domEach(this,(r,a)=>{isTag(r)&&removeClass.call([r],t.call(r,a,r.attribs.class||""))});const e=splitNames(t),s=e.length,n=arguments.length===0;return domEach(this,r=>{if(isTag(r))if(n)r.attribs.class="";else{const a=splitNames(r.attribs.class);let i=!1;for(let u=0;u<s;u++){const f=a.indexOf(e[u]);f>=0&&(a.splice(f,1),i=!0,u--)}i&&(r.attribs.class=a.join(" "))}})}function toggleClass(t,e){if(typeof t=="function")return domEach(this,(i,u)=>{isTag(i)&&toggleClass.call([i],t.call(i,u,i.attribs.class||"",e),e)});if(!t||typeof t!="string")return this;const s=t.split(rspace),n=s.length,r=typeof e=="boolean"?e?1:-1:0,a=this.length;for(let i=0;i<a;i++){const u=this[i];if(!isTag(u))continue;const f=splitNames(u.attribs.class);for(let c=0;c<n;c++){const d=f.indexOf(s[c]);r>=0&&d<0?f.push(s[c]):r<=0&&d>=0&&f.splice(d,1)}u.attribs.class=f.join(" ")}return this}const Attributes=Object.freeze(Object.defineProperty({__proto__:null,addClass,attr,data,hasClass,prop,removeAttr,removeClass,toggleClass,val},Symbol.toStringTag,{value:"Module"}));var SelectorType;(function(t){t.Attribute="attribute",t.Pseudo="pseudo",t.PseudoElement="pseudo-element",t.Tag="tag",t.Universal="universal",t.Adjacent="adjacent",t.Child="child",t.Descendant="descendant",t.Parent="parent",t.Sibling="sibling",t.ColumnCombinator="column-combinator"})(SelectorType||(SelectorType={}));var AttributeAction;(function(t){t.Any="any",t.Element="element",t.End="end",t.Equals="equals",t.Exists="exists",t.Hyphen="hyphen",t.Not="not",t.Start="start"})(AttributeAction||(AttributeAction={}));const reName=/^[^\\#]?(?:\\(?:[\da-f]{1,6}\s?|.)|[\w\-\u00b0-\uFFFF])+/,reEscape=/\\([\da-f]{1,6}\s?|(\s)|.)/gi,actionTypes=new Map([[126,AttributeAction.Element],[94,AttributeAction.Start],[36,AttributeAction.End],[42,AttributeAction.Any],[33,AttributeAction.Not],[124,AttributeAction.Hyphen]]),unpackPseudos=new Set(["has","not","matches","is","where","host","host-context"]);function isTraversal$1(t){switch(t.type){case SelectorType.Adjacent:case SelectorType.Child:case SelectorType.Descendant:case SelectorType.Parent:case SelectorType.Sibling:case SelectorType.ColumnCombinator:return!0;default:return!1}}const stripQuotesFromPseudos=new Set(["contains","icontains"]);function funescape(t,e,s){const n=parseInt(e,16)-65536;return n!==n||s?e:n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,n&1023|56320)}function unescapeCSS(t){return t.replace(reEscape,funescape)}function isQuote(t){return t===39||t===34}function isWhitespace$2(t){return t===32||t===9||t===10||t===12||t===13}function parse$4(t){const e=[],s=parseSelector(e,`${t}`,0);if(s<t.length)throw new Error(`Unmatched selector: ${t.slice(s)}`);return e}function parseSelector(t,e,s){let n=[];function r(m){const _=e.slice(s+m).match(reName);if(!_)throw new Error(`Expected name, found ${e.slice(s)}`);const[p]=_;return s+=m+p.length,unescapeCSS(p)}function a(m){for(s+=m;s<e.length&&isWhitespace$2(e.charCodeAt(s));)s++}function i(){s+=1;const m=s;let _=1;for(;_>0&&s<e.length;s++)e.charCodeAt(s)===40&&!u(s)?_++:e.charCodeAt(s)===41&&!u(s)&&_--;if(_)throw new Error("Parenthesis not matched");return unescapeCSS(e.slice(m,s-1))}function u(m){let _=0;for(;e.charCodeAt(--m)===92;)_++;return(_&1)===1}function f(){if(n.length>0&&isTraversal$1(n[n.length-1]))throw new Error("Did not expect successive traversals.")}function c(m){if(n.length>0&&n[n.length-1].type===SelectorType.Descendant){n[n.length-1].type=m;return}f(),n.push({type:m})}function d(m,_){n.push({type:SelectorType.Attribute,name:m,action:_,value:r(1),namespace:null,ignoreCase:"quirks"})}function h(){if(n.length&&n[n.length-1].type===SelectorType.Descendant&&n.pop(),n.length===0)throw new Error("Empty sub-selector");t.push(n)}if(a(0),e.length===s)return s;e:for(;s<e.length;){const m=e.charCodeAt(s);switch(m){case 32:case 9:case 10:case 12:case 13:{(n.length===0||n[0].type!==SelectorType.Descendant)&&(f(),n.push({type:SelectorType.Descendant})),a(1);break}case 62:{c(SelectorType.Child),a(1);break}case 60:{c(SelectorType.Parent),a(1);break}case 126:{c(SelectorType.Sibling),a(1);break}case 43:{c(SelectorType.Adjacent),a(1);break}case 46:{d("class",AttributeAction.Element);break}case 35:{d("id",AttributeAction.Equals);break}case 91:{a(1);let _,p=null;e.charCodeAt(s)===124?_=r(1):e.startsWith("*|",s)?(p="*",_=r(2)):(_=r(0),e.charCodeAt(s)===124&&e.charCodeAt(s+1)!==61&&(p=_,_=r(1))),a(0);let b=AttributeAction.Exists;const A=actionTypes.get(e.charCodeAt(s));if(A){if(b=A,e.charCodeAt(s+1)!==61)throw new Error("Expected `=`");a(2)}else e.charCodeAt(s)===61&&(b=AttributeAction.Equals,a(1));let T="",v=null;if(b!=="exists"){if(isQuote(e.charCodeAt(s))){const y=e.charCodeAt(s);let S=s+1;for(;S<e.length&&(e.charCodeAt(S)!==y||u(S));)S+=1;if(e.charCodeAt(S)!==y)throw new Error("Attribute value didn't end");T=unescapeCSS(e.slice(s+1,S)),s=S+1}else{const y=s;for(;s<e.length&&(!isWhitespace$2(e.charCodeAt(s))&&e.charCodeAt(s)!==93||u(s));)s+=1;T=unescapeCSS(e.slice(y,s))}a(0);const x=e.charCodeAt(s)|32;x===115?(v=!1,a(1)):x===105&&(v=!0,a(1))}if(e.charCodeAt(s)!==93)throw new Error("Attribute selector didn't terminate");s+=1;const N={type:SelectorType.Attribute,name:_,action:b,value:T,namespace:p,ignoreCase:v};n.push(N);break}case 58:{if(e.charCodeAt(s+1)===58){n.push({type:SelectorType.PseudoElement,name:r(2).toLowerCase(),data:e.charCodeAt(s)===40?i():null});continue}const _=r(1).toLowerCase();let p=null;if(e.charCodeAt(s)===40)if(unpackPseudos.has(_)){if(isQuote(e.charCodeAt(s+1)))throw new Error(`Pseudo-selector ${_} cannot be quoted`);if(p=[],s=parseSelector(p,e,s+1),e.charCodeAt(s)!==41)throw new Error(`Missing closing parenthesis in :${_} (${e})`);s+=1}else{if(p=i(),stripQuotesFromPseudos.has(_)){const b=p.charCodeAt(0);b===p.charCodeAt(p.length-1)&&isQuote(b)&&(p=p.slice(1,-1))}p=unescapeCSS(p)}n.push({type:SelectorType.Pseudo,name:_,data:p});break}case 44:{h(),n=[],a(1);break}default:{if(e.startsWith("/*",s)){const b=e.indexOf("*/",s+2);if(b<0)throw new Error("Comment was not terminated");s=b+2,n.length===0&&a(0);break}let _=null,p;if(m===42)s+=1,p="*";else if(m===124){if(p="",e.charCodeAt(s+1)===124){c(SelectorType.ColumnCombinator),a(2);break}}else if(reName.test(e.slice(s)))p=r(0);else break e;e.charCodeAt(s)===124&&e.charCodeAt(s+1)!==124&&(_=p,e.charCodeAt(s+1)===42?(p="*",s+=2):p=r(1)),n.push(p==="*"?{type:SelectorType.Universal,namespace:_}:{type:SelectorType.Tag,name:p,namespace:_})}}}return h(),s}var boolbase={trueFunc:function(){return!0},falseFunc:function(){return!1}};const boolbase$1=getDefaultExportFromCjs(boolbase),procedure=new Map([[SelectorType.Universal,50],[SelectorType.Tag,30],[SelectorType.Attribute,1],[SelectorType.Pseudo,0]]);function isTraversal(t){return!procedure.has(t.type)}const attributes=new Map([[AttributeAction.Exists,10],[AttributeAction.Equals,8],[AttributeAction.Not,7],[AttributeAction.Start,6],[AttributeAction.End,6],[AttributeAction.Any,5]]);function sortByProcedure(t){const e=t.map(getProcedure);for(let s=1;s<t.length;s++){const n=e[s];if(!(n<0))for(let r=s-1;r>=0&&n<e[r];r--){const a=t[r+1];t[r+1]=t[r],t[r]=a,e[r+1]=e[r],e[r]=n}}}function getProcedure(t){var e,s;let n=(e=procedure.get(t.type))!==null&&e!==void 0?e:-1;return t.type===SelectorType.Attribute?(n=(s=attributes.get(t.action))!==null&&s!==void 0?s:4,t.action===AttributeAction.Equals&&t.name==="id"&&(n=9),t.ignoreCase&&(n>>=1)):t.type===SelectorType.Pseudo&&(t.data?t.name==="has"||t.name==="contains"?n=0:Array.isArray(t.data)?(n=Math.min(...t.data.map(r=>Math.min(...r.map(getProcedure)))),n<0&&(n=0)):n=2:n=3),n}const reChars=/[-[\]{}()*+?.,\\^$|#\s]/g;function escapeRegex$1(t){return t.replace(reChars,"\\$&")}const caseInsensitiveAttributes=new Set(["accept","accept-charset","align","alink","axis","bgcolor","charset","checked","clear","codetype","color","compact","declare","defer","dir","direction","disabled","enctype","face","frame","hreflang","http-equiv","lang","language","link","media","method","multiple","nohref","noresize","noshade","nowrap","readonly","rel","rev","rules","scope","scrolling","selected","shape","target","text","type","valign","valuetype","vlink"]);function shouldIgnoreCase(t,e){return typeof t.ignoreCase=="boolean"?t.ignoreCase:t.ignoreCase==="quirks"?!!e.quirksMode:!e.xmlMode&&caseInsensitiveAttributes.has(t.name)}const attributeRules={equals(t,e,s){const{adapter:n}=s,{name:r}=e;let{value:a}=e;return shouldIgnoreCase(e,s)?(a=a.toLowerCase(),i=>{const u=n.getAttributeValue(i,r);return u!=null&&u.length===a.length&&u.toLowerCase()===a&&t(i)}):i=>n.getAttributeValue(i,r)===a&&t(i)},hyphen(t,e,s){const{adapter:n}=s,{name:r}=e;let{value:a}=e;const i=a.length;return shouldIgnoreCase(e,s)?(a=a.toLowerCase(),function(f){const c=n.getAttributeValue(f,r);return c!=null&&(c.length===i||c.charAt(i)==="-")&&c.substr(0,i).toLowerCase()===a&&t(f)}):function(f){const c=n.getAttributeValue(f,r);return c!=null&&(c.length===i||c.charAt(i)==="-")&&c.substr(0,i)===a&&t(f)}},element(t,e,s){const{adapter:n}=s,{name:r,value:a}=e;if(/\s/.test(a))return boolbase$1.falseFunc;const i=new RegExp(`(?:^|\\s)${escapeRegex$1(a)}(?:$|\\s)`,shouldIgnoreCase(e,s)?"i":"");return function(f){const c=n.getAttributeValue(f,r);return c!=null&&c.length>=a.length&&i.test(c)&&t(f)}},exists(t,{name:e},{adapter:s}){return n=>s.hasAttrib(n,e)&&t(n)},start(t,e,s){const{adapter:n}=s,{name:r}=e;let{value:a}=e;const i=a.length;return i===0?boolbase$1.falseFunc:shouldIgnoreCase(e,s)?(a=a.toLowerCase(),u=>{const f=n.getAttributeValue(u,r);return f!=null&&f.length>=i&&f.substr(0,i).toLowerCase()===a&&t(u)}):u=>{var f;return!!(!((f=n.getAttributeValue(u,r))===null||f===void 0)&&f.startsWith(a))&&t(u)}},end(t,e,s){const{adapter:n}=s,{name:r}=e;let{value:a}=e;const i=-a.length;return i===0?boolbase$1.falseFunc:shouldIgnoreCase(e,s)?(a=a.toLowerCase(),u=>{var f;return((f=n.getAttributeValue(u,r))===null||f===void 0?void 0:f.substr(i).toLowerCase())===a&&t(u)}):u=>{var f;return!!(!((f=n.getAttributeValue(u,r))===null||f===void 0)&&f.endsWith(a))&&t(u)}},any(t,e,s){const{adapter:n}=s,{name:r,value:a}=e;if(a==="")return boolbase$1.falseFunc;if(shouldIgnoreCase(e,s)){const i=new RegExp(escapeRegex$1(a),"i");return function(f){const c=n.getAttributeValue(f,r);return c!=null&&c.length>=a.length&&i.test(c)&&t(f)}}return i=>{var u;return!!(!((u=n.getAttributeValue(i,r))===null||u===void 0)&&u.includes(a))&&t(i)}},not(t,e,s){const{adapter:n}=s,{name:r}=e;let{value:a}=e;return a===""?i=>!!n.getAttributeValue(i,r)&&t(i):shouldIgnoreCase(e,s)?(a=a.toLowerCase(),i=>{const u=n.getAttributeValue(i,r);return(u==null||u.length!==a.length||u.toLowerCase()!==a)&&t(i)}):i=>n.getAttributeValue(i,r)!==a&&t(i)}},whitespace=new Set([9,10,12,13,32]),ZERO=48,NINE=57;function parse$3(t){if(t=t.trim().toLowerCase(),t==="even")return[2,0];if(t==="odd")return[2,1];let e=0,s=0,n=a(),r=i();if(e<t.length&&t.charAt(e)==="n"&&(e++,s=n*(r??1),u(),e<t.length?(n=a(),u(),r=i()):n=r=0),r===null||e<t.length)throw new Error(`n-th rule couldn't be parsed ('${t}')`);return[s,n*r];function a(){return t.charAt(e)==="-"?(e++,-1):(t.charAt(e)==="+"&&e++,1)}function i(){const f=e;let c=0;for(;e<t.length&&t.charCodeAt(e)>=ZERO&&t.charCodeAt(e)<=NINE;)c=c*10+(t.charCodeAt(e)-ZERO),e++;return e===f?null:c}function u(){for(;e<t.length&&whitespace.has(t.charCodeAt(e));)e++}}function compile(t){const e=t[0],s=t[1]-1;if(s<0&&e<=0)return boolbase$1.falseFunc;if(e===-1)return a=>a<=s;if(e===0)return a=>a===s;if(e===1)return s<0?boolbase$1.trueFunc:a=>a>=s;const n=Math.abs(e),r=(s%n+n)%n;return e>1?a=>a>=s&&a%n===r:a=>a<=s&&a%n===r}function nthCheck(t){return compile(parse$3(t))}function getChildFunc(t,e){return s=>{const n=e.getParent(s);return n!=null&&e.isTag(n)&&t(s)}}const filters={contains(t,e,{adapter:s}){return function(r){return t(r)&&s.getText(r).includes(e)}},icontains(t,e,{adapter:s}){const n=e.toLowerCase();return function(a){return t(a)&&s.getText(a).toLowerCase().includes(n)}},"nth-child"(t,e,{adapter:s,equals:n}){const r=nthCheck(e);return r===boolbase$1.falseFunc?boolbase$1.falseFunc:r===boolbase$1.trueFunc?getChildFunc(t,s):function(i){const u=s.getSiblings(i);let f=0;for(let c=0;c<u.length&&!n(i,u[c]);c++)s.isTag(u[c])&&f++;return r(f)&&t(i)}},"nth-last-child"(t,e,{adapter:s,equals:n}){const r=nthCheck(e);return r===boolbase$1.falseFunc?boolbase$1.falseFunc:r===boolbase$1.trueFunc?getChildFunc(t,s):function(i){const u=s.getSiblings(i);let f=0;for(let c=u.length-1;c>=0&&!n(i,u[c]);c--)s.isTag(u[c])&&f++;return r(f)&&t(i)}},"nth-of-type"(t,e,{adapter:s,equals:n}){const r=nthCheck(e);return r===boolbase$1.falseFunc?boolbase$1.falseFunc:r===boolbase$1.trueFunc?getChildFunc(t,s):function(i){const u=s.getSiblings(i);let f=0;for(let c=0;c<u.length;c++){const d=u[c];if(n(i,d))break;s.isTag(d)&&s.getName(d)===s.getName(i)&&f++}return r(f)&&t(i)}},"nth-last-of-type"(t,e,{adapter:s,equals:n}){const r=nthCheck(e);return r===boolbase$1.falseFunc?boolbase$1.falseFunc:r===boolbase$1.trueFunc?getChildFunc(t,s):function(i){const u=s.getSiblings(i);let f=0;for(let c=u.length-1;c>=0;c--){const d=u[c];if(n(i,d))break;s.isTag(d)&&s.getName(d)===s.getName(i)&&f++}return r(f)&&t(i)}},root(t,e,{adapter:s}){return n=>{const r=s.getParent(n);return(r==null||!s.isTag(r))&&t(n)}},scope(t,e,s,n){const{equals:r}=s;return!n||n.length===0?filters.root(t,e,s):n.length===1?a=>r(n[0],a)&&t(a):a=>n.includes(a)&&t(a)},hover:dynamicStatePseudo("isHovered"),visited:dynamicStatePseudo("isVisited"),active:dynamicStatePseudo("isActive")};function dynamicStatePseudo(t){return function(s,n,{adapter:r}){const a=r[t];return typeof a!="function"?boolbase$1.falseFunc:function(u){return a(u)&&s(u)}}}const pseudos={empty(t,{adapter:e}){return!e.getChildren(t).some(s=>e.isTag(s)||e.getText(s)!=="")},"first-child"(t,{adapter:e,equals:s}){if(e.prevElementSibling)return e.prevElementSibling(t)==null;const n=e.getSiblings(t).find(r=>e.isTag(r));return n!=null&&s(t,n)},"last-child"(t,{adapter:e,equals:s}){const n=e.getSiblings(t);for(let r=n.length-1;r>=0;r--){if(s(t,n[r]))return!0;if(e.isTag(n[r]))break}return!1},"first-of-type"(t,{adapter:e,equals:s}){const n=e.getSiblings(t),r=e.getName(t);for(let a=0;a<n.length;a++){const i=n[a];if(s(t,i))return!0;if(e.isTag(i)&&e.getName(i)===r)break}return!1},"last-of-type"(t,{adapter:e,equals:s}){const n=e.getSiblings(t),r=e.getName(t);for(let a=n.length-1;a>=0;a--){const i=n[a];if(s(t,i))return!0;if(e.isTag(i)&&e.getName(i)===r)break}return!1},"only-of-type"(t,{adapter:e,equals:s}){const n=e.getName(t);return e.getSiblings(t).every(r=>s(t,r)||!e.isTag(r)||e.getName(r)!==n)},"only-child"(t,{adapter:e,equals:s}){return e.getSiblings(t).every(n=>s(t,n)||!e.isTag(n))}};function verifyPseudoArgs(t,e,s,n){if(s===null){if(t.length>n)throw new Error(`Pseudo-class :${e} requires an argument`)}else if(t.length===n)throw new Error(`Pseudo-class :${e} doesn't have any arguments`)}const aliases={"any-link":":is(a, area, link)[href]",link:":any-link:not(:visited)",disabled:`:is(
        :is(button, input, select, textarea, optgroup, option)[disabled],
        optgroup[disabled] > option,
        fieldset[disabled]:not(fieldset[disabled] legend:first-of-type *)
    )`,enabled:":not(:disabled)",checked:":is(:is(input[type=radio], input[type=checkbox])[checked], option:selected)",required:":is(input, select, textarea)[required]",optional:":is(input, select, textarea):not([required])",selected:"option:is([selected], select:not([multiple]):not(:has(> option[selected])) > :first-of-type)",checkbox:"[type=checkbox]",file:"[type=file]",password:"[type=password]",radio:"[type=radio]",reset:"[type=reset]",image:"[type=image]",submit:"[type=submit]",parent:":not(:empty)",header:":is(h1, h2, h3, h4, h5, h6)",button:":is(button, input[type=button])",input:":is(input, textarea, select, button)",text:"input:is(:not([type!='']), [type=text])"},PLACEHOLDER_ELEMENT={};function ensureIsTag(t,e){return t===boolbase$1.falseFunc?boolbase$1.falseFunc:s=>e.isTag(s)&&t(s)}function getNextSiblings(t,e){const s=e.getSiblings(t);if(s.length<=1)return[];const n=s.indexOf(t);return n<0||n===s.length-1?[]:s.slice(n+1).filter(e.isTag)}function copyOptions(t){return{xmlMode:!!t.xmlMode,lowerCaseAttributeNames:!!t.lowerCaseAttributeNames,lowerCaseTags:!!t.lowerCaseTags,quirksMode:!!t.quirksMode,cacheResults:!!t.cacheResults,pseudos:t.pseudos,adapter:t.adapter,equals:t.equals}}const is$2=(t,e,s,n,r)=>{const a=r(e,copyOptions(s),n);return a===boolbase$1.trueFunc?t:a===boolbase$1.falseFunc?boolbase$1.falseFunc:i=>a(i)&&t(i)},subselects={is:is$2,matches:is$2,where:is$2,not(t,e,s,n,r){const a=r(e,copyOptions(s),n);return a===boolbase$1.falseFunc?t:a===boolbase$1.trueFunc?boolbase$1.falseFunc:i=>!a(i)&&t(i)},has(t,e,s,n,r){const{adapter:a}=s,i=copyOptions(s);i.relativeSelector=!0;const u=e.some(d=>d.some(isTraversal))?[PLACEHOLDER_ELEMENT]:void 0,f=r(e,i,u);if(f===boolbase$1.falseFunc)return boolbase$1.falseFunc;const c=ensureIsTag(f,a);if(u&&f!==boolbase$1.trueFunc){const{shouldTestNextSiblings:d=!1}=f;return h=>{if(!t(h))return!1;u[0]=h;const m=a.getChildren(h),_=d?[...m,...getNextSiblings(h,a)]:m;return a.existsOne(c,_)}}return d=>t(d)&&a.existsOne(c,a.getChildren(d))}};function compilePseudoSelector(t,e,s,n,r){var a;const{name:i,data:u}=e;if(Array.isArray(u)){if(!(i in subselects))throw new Error(`Unknown pseudo-class :${i}(${u})`);return subselects[i](t,u,s,n,r)}const f=(a=s.pseudos)===null||a===void 0?void 0:a[i],c=typeof f=="string"?f:aliases[i];if(typeof c=="string"){if(u!=null)throw new Error(`Pseudo ${i} doesn't have any arguments`);const d=parse$4(c);return subselects.is(t,d,s,n,r)}if(typeof f=="function")return verifyPseudoArgs(f,i,u,1),d=>f(d,u)&&t(d);if(i in filters)return filters[i](t,u,s,n);if(i in pseudos){const d=pseudos[i];return verifyPseudoArgs(d,i,u,2),h=>d(h,s,u)&&t(h)}throw new Error(`Unknown pseudo-class :${i}`)}function getElementParent(t,e){const s=e.getParent(t);return s&&e.isTag(s)?s:null}function compileGeneralSelector(t,e,s,n,r){const{adapter:a,equals:i}=s;switch(e.type){case SelectorType.PseudoElement:throw new Error("Pseudo-elements are not supported by css-select");case SelectorType.ColumnCombinator:throw new Error("Column combinators are not yet supported by css-select");case SelectorType.Attribute:{if(e.namespace!=null)throw new Error("Namespaced attributes are not yet supported by css-select");return(!s.xmlMode||s.lowerCaseAttributeNames)&&(e.name=e.name.toLowerCase()),attributeRules[e.action](t,e,s)}case SelectorType.Pseudo:return compilePseudoSelector(t,e,s,n,r);case SelectorType.Tag:{if(e.namespace!=null)throw new Error("Namespaced tag names are not yet supported by css-select");let{name:u}=e;return(!s.xmlMode||s.lowerCaseTags)&&(u=u.toLowerCase()),function(c){return a.getName(c)===u&&t(c)}}case SelectorType.Descendant:{if(s.cacheResults===!1||typeof WeakSet>"u")return function(c){let d=c;for(;d=getElementParent(d,a);)if(t(d))return!0;return!1};const u=new WeakSet;return function(c){let d=c;for(;d=getElementParent(d,a);)if(!u.has(d)){if(a.isTag(d)&&t(d))return!0;u.add(d)}return!1}}case"_flexibleDescendant":return function(f){let c=f;do if(t(c))return!0;while(c=getElementParent(c,a));return!1};case SelectorType.Parent:return function(f){return a.getChildren(f).some(c=>a.isTag(c)&&t(c))};case SelectorType.Child:return function(f){const c=a.getParent(f);return c!=null&&a.isTag(c)&&t(c)};case SelectorType.Sibling:return function(f){const c=a.getSiblings(f);for(let d=0;d<c.length;d++){const h=c[d];if(i(f,h))break;if(a.isTag(h)&&t(h))return!0}return!1};case SelectorType.Adjacent:return a.prevElementSibling?function(f){const c=a.prevElementSibling(f);return c!=null&&t(c)}:function(f){const c=a.getSiblings(f);let d;for(let h=0;h<c.length;h++){const m=c[h];if(i(f,m))break;a.isTag(m)&&(d=m)}return!!d&&t(d)};case SelectorType.Universal:{if(e.namespace!=null&&e.namespace!=="*")throw new Error("Namespaced universal selectors are not yet supported by css-select");return t}}}function includesScopePseudo(t){return t.type===SelectorType.Pseudo&&(t.name==="scope"||Array.isArray(t.data)&&t.data.some(e=>e.some(includesScopePseudo)))}const DESCENDANT_TOKEN={type:SelectorType.Descendant},FLEXIBLE_DESCENDANT_TOKEN={type:"_flexibleDescendant"},SCOPE_TOKEN={type:SelectorType.Pseudo,name:"scope",data:null};function absolutize(t,{adapter:e},s){const n=!!s?.every(r=>{const a=e.isTag(r)&&e.getParent(r);return r===PLACEHOLDER_ELEMENT||a&&e.isTag(a)});for(const r of t){if(!(r.length>0&&isTraversal(r[0])&&r[0].type!==SelectorType.Descendant))if(n&&!r.some(includesScopePseudo))r.unshift(DESCENDANT_TOKEN);else continue;r.unshift(SCOPE_TOKEN)}}function compileToken(t,e,s){var n;t.forEach(sortByProcedure),s=(n=e.context)!==null&&n!==void 0?n:s;const r=Array.isArray(s),a=s&&(Array.isArray(s)?s:[s]);if(e.relativeSelector!==!1)absolutize(t,e,a);else if(t.some(f=>f.length>0&&isTraversal(f[0])))throw new Error("Relative selectors are not allowed when the `relativeSelector` option is disabled");let i=!1;const u=t.map(f=>{if(f.length>=2){const[c,d]=f;c.type!==SelectorType.Pseudo||c.name!=="scope"||(r&&d.type===SelectorType.Descendant?f[1]=FLEXIBLE_DESCENDANT_TOKEN:(d.type===SelectorType.Adjacent||d.type===SelectorType.Sibling)&&(i=!0))}return compileRules(f,e,a)}).reduce(reduceRules,boolbase$1.falseFunc);return u.shouldTestNextSiblings=i,u}function compileRules(t,e,s){var n;return t.reduce((r,a)=>r===boolbase$1.falseFunc?boolbase$1.falseFunc:compileGeneralSelector(r,a,e,s,compileToken),(n=e.rootFunc)!==null&&n!==void 0?n:boolbase$1.trueFunc)}function reduceRules(t,e){return e===boolbase$1.falseFunc||t===boolbase$1.trueFunc?t:t===boolbase$1.falseFunc||e===boolbase$1.trueFunc?e:function(n){return t(n)||e(n)}}const defaultEquals=(t,e)=>t===e,defaultOptions$1={adapter:DomUtils,equals:defaultEquals};function convertOptionFormats(t){var e,s,n,r;const a=t??defaultOptions$1;return(e=a.adapter)!==null&&e!==void 0||(a.adapter=DomUtils),(s=a.equals)!==null&&s!==void 0||(a.equals=(r=(n=a.adapter)===null||n===void 0?void 0:n.equals)!==null&&r!==void 0?r:defaultEquals),a}function wrapCompile(t){return function(s,n,r){const a=convertOptionFormats(n);return t(s,a,r)}}const _compileToken=wrapCompile(compileToken);function prepareContext(t,e,s=!1){return s&&(t=appendNextSiblings(t,e)),Array.isArray(t)?e.removeSubsets(t):e.getChildren(t)}function appendNextSiblings(t,e){const s=Array.isArray(t)?t.slice(0):[t],n=s.length;for(let r=0;r<n;r++){const a=getNextSiblings(s[r],e);s.push(...a)}return s}const filterNames=new Set(["first","last","eq","gt","nth","lt","even","odd"]);function isFilter(t){return t.type!=="pseudo"?!1:filterNames.has(t.name)?!0:t.name==="not"&&Array.isArray(t.data)?t.data.some(e=>e.some(isFilter)):!1}function getLimit(t,e,s){const n=e!=null?parseInt(e,10):NaN;switch(t){case"first":return 1;case"nth":case"eq":return isFinite(n)?n>=0?n+1:1/0:0;case"lt":return isFinite(n)?n>=0?Math.min(n,s):1/0:0;case"gt":return isFinite(n)?1/0:0;case"odd":return 2*s;case"even":return 2*s-1;case"last":case"not":return 1/0}}function getDocumentRoot(t){for(;t.parent;)t=t.parent;return t}function groupSelectors(t){const e=[],s=[];for(const n of t)n.some(isFilter)?e.push(n):s.push(n);return[s,e]}const UNIVERSAL_SELECTOR={type:SelectorType.Universal,namespace:null},SCOPE_PSEUDO={type:SelectorType.Pseudo,name:"scope",data:null};function is$1(t,e,s={}){return some([t],e,s)}function some(t,e,s={}){if(typeof e=="function")return t.some(e);const[n,r]=groupSelectors(parse$4(e));return n.length>0&&t.some(_compileToken(n,s))||r.some(a=>filterBySelector(a,t,s).length>0)}function filterByPosition(t,e,s,n){const r=typeof s=="string"?parseInt(s,10):NaN;switch(t){case"first":case"lt":return e;case"last":return e.length>0?[e[e.length-1]]:e;case"nth":case"eq":return isFinite(r)&&Math.abs(r)<e.length?[r<0?e[e.length+r]:e[r]]:[];case"gt":return isFinite(r)?e.slice(r+1):[];case"even":return e.filter((a,i)=>i%2===0);case"odd":return e.filter((a,i)=>i%2===1);case"not":{const a=new Set(filterParsed(s,e,n));return e.filter(i=>!a.has(i))}}}function filter$1(t,e,s={}){return filterParsed(parse$4(t),e,s)}function filterParsed(t,e,s){if(e.length===0)return[];const[n,r]=groupSelectors(t);let a;if(n.length){const i=filterElements(e,n,s);if(r.length===0)return i;i.length&&(a=new Set(i))}for(let i=0;i<r.length&&a?.size!==e.length;i++){const u=r[i];if((a?e.filter(d=>isTag(d)&&!a.has(d)):e).length===0)break;const c=filterBySelector(u,e,s);if(c.length)if(a)c.forEach(d=>a.add(d));else{if(i===r.length-1)return c;a=new Set(c)}}return typeof a<"u"?a.size===e.length?e:e.filter(i=>a.has(i)):[]}function filterBySelector(t,e,s){var n;if(t.some(isTraversal$1)){const r=(n=s.root)!==null&&n!==void 0?n:getDocumentRoot(e[0]),a={...s,context:e,relativeSelector:!1};return t.push(SCOPE_PSEUDO),findFilterElements(r,t,a,!0,e.length)}return findFilterElements(e,t,s,!1,e.length)}function select(t,e,s={},n=1/0){if(typeof t=="function")return find$1(e,t);const[r,a]=groupSelectors(parse$4(t)),i=a.map(u=>findFilterElements(e,u,s,!0,n));return r.length&&i.push(findElements(e,r,s,n)),i.length===0?[]:i.length===1?i[0]:uniqueSort(i.reduce((u,f)=>[...u,...f]))}function findFilterElements(t,e,s,n,r){const a=e.findIndex(isFilter),i=e.slice(0,a),u=e[a],f=e.length-1===a?r:1/0,c=getLimit(u.name,u.data,f);if(c===0)return[];const h=(i.length===0&&!Array.isArray(t)?getChildren(t).filter(isTag):i.length===0?(Array.isArray(t)?t:[t]).filter(isTag):n||i.some(isTraversal$1)?findElements(t,[i],s,c):filterElements(t,[i],s)).slice(0,c);let m=filterByPosition(u.name,h,u.data,s);if(m.length===0||e.length===a+1)return m;const _=e.slice(a+1),p=_.some(isTraversal$1);if(p){if(isTraversal$1(_[0])){const{type:b}=_[0];(b===SelectorType.Sibling||b===SelectorType.Adjacent)&&(m=prepareContext(m,DomUtils,!0)),_.unshift(UNIVERSAL_SELECTOR)}s={...s,relativeSelector:!1,rootFunc:b=>m.includes(b)}}else s.rootFunc&&s.rootFunc!==boolbase.trueFunc&&(s={...s,rootFunc:boolbase.trueFunc});return _.some(isFilter)?findFilterElements(m,_,s,!1,r):p?findElements(m,[_],s,r):filterElements(m,[_],s)}function findElements(t,e,s,n){const r=_compileToken(e,s,t);return find$1(t,r,n)}function find$1(t,e,s=1/0){const n=prepareContext(t,DomUtils,e.shouldTestNextSiblings);return find$2(r=>isTag(r)&&e(r),n,!0,s)}function filterElements(t,e,s){const n=(Array.isArray(t)?t:[t]).filter(isTag);if(n.length===0)return n;const r=_compileToken(e,s);return r===boolbase.trueFunc?n:n.filter(r)}const reSiblingSelector=/^\s*[~+]/;function find(t){var e;if(!t)return this._make([]);const s=this.toArray();if(typeof t!="string"){const a=isCheerio(t)?t.toArray():[t];return this._make(a.filter(i=>s.some(u=>contains(u,i))))}const n=reSiblingSelector.test(t)?s:this.children().toArray(),r={context:s,root:(e=this._root)===null||e===void 0?void 0:e[0],xmlMode:this.options.xmlMode,lowerCaseTags:this.options.lowerCaseTags,lowerCaseAttributeNames:this.options.lowerCaseAttributeNames,pseudos:this.options.pseudos,quirksMode:this.options.quirksMode};return this._make(select(t,n,r))}function _getMatcher(t){return function(e,...s){return function(n){var r;let a=t(e,this);return n&&(a=filterArray(a,n,this.options.xmlMode,(r=this._root)===null||r===void 0?void 0:r[0])),this._make(this.length>1&&a.length>1?s.reduce((i,u)=>u(i),a):a)}}}const _matcher=_getMatcher((t,e)=>{const s=[];for(let n=0;n<e.length;n++){const r=t(e[n]);s.push(r)}return new Array().concat(...s)}),_singleMatcher=_getMatcher((t,e)=>{const s=[];for(let n=0;n<e.length;n++){const r=t(e[n]);r!==null&&s.push(r)}return s});function _matchUntil(t,...e){let s=null;const n=_getMatcher((r,a)=>{const i=[];return domEach(a,u=>{for(let f;(f=r(u))&&!s?.(f,i.length);u=f)i.push(f)}),i})(t,...e);return function(r,a){s=typeof r=="string"?u=>is$1(u,r,this.options):r?getFilterFn(r):null;const i=n.call(this,a);return s=null,i}}function _removeDuplicates(t){return Array.from(new Set(t))}const parent=_singleMatcher(({parent:t})=>t&&!isDocument(t)?t:null,_removeDuplicates),parents=_matcher(t=>{const e=[];for(;t.parent&&!isDocument(t.parent);)e.push(t.parent),t=t.parent;return e},uniqueSort,t=>t.reverse()),parentsUntil=_matchUntil(({parent:t})=>t&&!isDocument(t)?t:null,uniqueSort,t=>t.reverse());function closest(t){var e;const s=[];if(!t)return this._make(s);const n={xmlMode:this.options.xmlMode,root:(e=this._root)===null||e===void 0?void 0:e[0]},r=typeof t=="string"?a=>is$1(a,t,n):getFilterFn(t);return domEach(this,a=>{for(;a&&isTag(a);){if(r(a,0)){s.includes(a)||s.push(a);break}a=a.parent}}),this._make(s)}const next=_singleMatcher(t=>nextElementSibling(t)),nextAll=_matcher(t=>{const e=[];for(;t.next;)t=t.next,isTag(t)&&e.push(t);return e},_removeDuplicates),nextUntil=_matchUntil(t=>nextElementSibling(t),_removeDuplicates),prev=_singleMatcher(t=>prevElementSibling(t)),prevAll=_matcher(t=>{const e=[];for(;t.prev;)t=t.prev,isTag(t)&&e.push(t);return e},_removeDuplicates),prevUntil=_matchUntil(t=>prevElementSibling(t),_removeDuplicates),siblings=_matcher(t=>getSiblings(t).filter(e=>isTag(e)&&e!==t),uniqueSort),children=_matcher(t=>getChildren(t).filter(isTag),_removeDuplicates);function contents(){const t=this.toArray().reduce((e,s)=>hasChildren(s)?e.concat(s.children):e,[]);return this._make(t)}function each(t){let e=0;const s=this.length;for(;e<s&&t.call(this[e],e,this[e])!==!1;)++e;return this}function map(t){let e=[];for(let s=0;s<this.length;s++){const n=this[s],r=t.call(n,s,n);r!=null&&(e=e.concat(r))}return this._make(e)}function getFilterFn(t){return typeof t=="function"?(e,s)=>t.call(e,s,e):isCheerio(t)?e=>Array.prototype.includes.call(t,e):function(e){return t===e}}function filter(t){var e;return this._make(filterArray(this.toArray(),t,this.options.xmlMode,(e=this._root)===null||e===void 0?void 0:e[0]))}function filterArray(t,e,s,n){return typeof e=="string"?filter$1(e,t,{xmlMode:s,root:n}):t.filter(getFilterFn(e))}function is(t){const e=this.toArray();return typeof t=="string"?some(e.filter(isTag),t,this.options):t?e.some(getFilterFn(t)):!1}function not(t){let e=this.toArray();if(typeof t=="string"){const s=new Set(filter$1(t,e,this.options));e=e.filter(n=>!s.has(n))}else{const s=getFilterFn(t);e=e.filter((n,r)=>!s(n,r))}return this._make(e)}function has$1(t){return this.filter(typeof t=="string"?`:has(${t})`:(e,s)=>this._make(s).find(t).length>0)}function first(){return this.length>1?this._make(this[0]):this}function last(){return this.length>0?this._make(this[this.length-1]):this}function eq(t){var e;return t=+t,t===0&&this.length<=1?this:(t<0&&(t=this.length+t),this._make((e=this[t])!==null&&e!==void 0?e:[]))}function get(t){return t==null?this.toArray():this[t<0?this.length+t:t]}function toArray$1(){return Array.prototype.slice.call(this)}function index(t){let e,s;return t==null?(e=this.parent().children(),s=this[0]):typeof t=="string"?(e=this._make(t),s=this[0]):(e=this,s=isCheerio(t)?t[0]:t),Array.prototype.indexOf.call(e,s)}function slice(t,e){return this._make(Array.prototype.slice.call(this,t,e))}function end(){var t;return(t=this.prevObject)!==null&&t!==void 0?t:this._make([])}function add(t,e){const s=this._make(t,e),n=uniqueSort([...this.get(),...s.get()]);return this._make(n)}function addBack(t){return this.prevObject?this.add(t?this.prevObject.filter(t):this.prevObject):this}const Traversing=Object.freeze(Object.defineProperty({__proto__:null,add,addBack,children,closest,contents,each,end,eq,filter,filterArray,find,first,get,has:has$1,index,is,last,map,next,nextAll,nextUntil,not,parent,parents,parentsUntil,prev,prevAll,prevUntil,siblings,slice,toArray:toArray$1},Symbol.toStringTag,{value:"Module"}));function getParse(t){return function(s,n,r,a){if(typeof Buffer<"u"&&Buffer.isBuffer(s)&&(s=s.toString()),typeof s=="string")return t(s,n,r,a);const i=s;if(!Array.isArray(i)&&isDocument(i))return i;const u=new Document([]);return update(i,u),u}}function update(t,e){const s=Array.isArray(t)?t:[t];e?e.children=s:e=null;for(let n=0;n<s.length;n++){const r=s[n];r.parent&&r.parent.children!==s&&removeElement(r),e?(r.prev=s[n-1]||null,r.next=s[n+1]||null):r.prev=r.next=null,r.parent=e}return e}function _makeDomArray(t,e){return t==null?[]:isCheerio(t)?e?cloneDom(t.get()):t.get():Array.isArray(t)?t.reduce((s,n)=>s.concat(this._makeDomArray(n,e)),[]):typeof t=="string"?this._parse(t,this.options,!1,null).children:e?cloneDom([t]):[t]}function _insert(t){return function(...e){const s=this.length-1;return domEach(this,(n,r)=>{if(!hasChildren(n))return;const a=typeof e[0]=="function"?e[0].call(n,r,this._render(n.children)):e,i=this._makeDomArray(a,r<s);t(i,n.children,n)})}}function uniqueSplice(t,e,s,n,r){var a,i;const u=[e,s,...n],f=e===0?null:t[e-1],c=e+s>=t.length?null:t[e+s];for(let d=0;d<n.length;++d){const h=n[d],m=h.parent;if(m){const p=m.children.indexOf(h);p>-1&&(m.children.splice(p,1),r===m&&e>p&&u[0]--)}h.parent=r,h.prev&&(h.prev.next=(a=h.next)!==null&&a!==void 0?a:null),h.next&&(h.next.prev=(i=h.prev)!==null&&i!==void 0?i:null),h.prev=d===0?f:n[d-1],h.next=d===n.length-1?c:n[d+1]}return f&&(f.next=n[0]),c&&(c.prev=n[n.length-1]),t.splice(...u)}function appendTo(t){return(isCheerio(t)?t:this._make(t)).append(this),this}function prependTo(t){return(isCheerio(t)?t:this._make(t)).prepend(this),this}const append=_insert((t,e,s)=>{uniqueSplice(e,e.length,0,t,s)}),prepend=_insert((t,e,s)=>{uniqueSplice(e,0,0,t,s)});function _wrap(t){return function(e){const s=this.length-1,n=this.parents().last();for(let r=0;r<this.length;r++){const a=this[r],i=typeof e=="function"?e.call(a,r,a):typeof e=="string"&&!isHtml(e)?n.find(e).clone():e,[u]=this._makeDomArray(i,r<s);if(!u||!hasChildren(u))continue;let f=u,c=0;for(;c<f.children.length;){const d=f.children[c];isTag(d)?(f=d,c=0):c++}t(a,f,[u])}return this}}const wrap$1=_wrap((t,e,s)=>{const{parent:n}=t;if(!n)return;const r=n.children,a=r.indexOf(t);update([t],e),uniqueSplice(r,a,0,s,n)}),wrapInner=_wrap((t,e,s)=>{hasChildren(t)&&(update(t.children,e),update(s,t))});function unwrap(t){return this.parent(t).not("body").each((e,s)=>{this._make(s).replaceWith(s.children)}),this}function wrapAll(t){const e=this[0];if(e){const s=this._make(typeof t=="function"?t.call(e,0,e):t).insertBefore(e);let n;for(let a=0;a<s.length;a++)s[a].type==="tag"&&(n=s[a]);let r=0;for(;n&&r<n.children.length;){const a=n.children[r];a.type==="tag"?(n=a,r=0):r++}n&&this._make(n).append(this)}return this}function after(...t){const e=this.length-1;return domEach(this,(s,n)=>{const{parent:r}=s;if(!hasChildren(s)||!r)return;const a=r.children,i=a.indexOf(s);if(i<0)return;const u=typeof t[0]=="function"?t[0].call(s,n,this._render(s.children)):t,f=this._makeDomArray(u,n<e);uniqueSplice(a,i+1,0,f,r)})}function insertAfter(t){typeof t=="string"&&(t=this._make(t)),this.remove();const e=[];return this._makeDomArray(t).forEach(s=>{const n=this.clone().toArray(),{parent:r}=s;if(!r)return;const a=r.children,i=a.indexOf(s);i<0||(uniqueSplice(a,i+1,0,n,r),e.push(...n))}),this._make(e)}function before(...t){const e=this.length-1;return domEach(this,(s,n)=>{const{parent:r}=s;if(!hasChildren(s)||!r)return;const a=r.children,i=a.indexOf(s);if(i<0)return;const u=typeof t[0]=="function"?t[0].call(s,n,this._render(s.children)):t,f=this._makeDomArray(u,n<e);uniqueSplice(a,i,0,f,r)})}function insertBefore(t){const e=this._make(t);this.remove();const s=[];return domEach(e,n=>{const r=this.clone().toArray(),{parent:a}=n;if(!a)return;const i=a.children,u=i.indexOf(n);u<0||(uniqueSplice(i,u,0,r,a),s.push(...r))}),this._make(s)}function remove(t){const e=t?this.filter(t):this;return domEach(e,s=>{removeElement(s),s.prev=s.next=s.parent=null}),this}function replaceWith(t){return domEach(this,(e,s)=>{const{parent:n}=e;if(!n)return;const r=n.children,a=typeof t=="function"?t.call(e,s,e):t,i=this._makeDomArray(a);update(i,null);const u=r.indexOf(e);uniqueSplice(r,u,1,i,n),i.includes(e)||(e.parent=e.prev=e.next=null)})}function empty$1(){return domEach(this,t=>{hasChildren(t)&&(t.children.forEach(e=>{e.next=e.prev=e.parent=null}),t.children.length=0)})}function html(t){if(t===void 0){const e=this[0];return!e||!hasChildren(e)?null:this._render(e.children)}return domEach(this,e=>{if(!hasChildren(e))return;e.children.forEach(n=>{n.next=n.prev=n.parent=null});const s=isCheerio(t)?t.toArray():this._parse(`${t}`,this.options,!1,e).children;update(s,e)})}function toString(){return this._render(this)}function text(t){return t===void 0?text$1(this):typeof t=="function"?domEach(this,(e,s)=>this._make(e).text(t.call(e,s,text$1([e])))):domEach(this,e=>{if(!hasChildren(e))return;e.children.forEach(n=>{n.next=n.prev=n.parent=null});const s=new Text(`${t}`);update(s,e)})}function clone(){return this._make(cloneDom(this.get()))}const Manipulation=Object.freeze(Object.defineProperty({__proto__:null,_makeDomArray,after,append,appendTo,before,clone,empty:empty$1,html,insertAfter,insertBefore,prepend,prependTo,remove,replaceWith,text,toString,unwrap,wrap:wrap$1,wrapAll,wrapInner},Symbol.toStringTag,{value:"Module"}));function css(t,e){if(t!=null&&e!=null||typeof t=="object"&&!Array.isArray(t))return domEach(this,(s,n)=>{isTag(s)&&setCss(s,t,e,n)});if(this.length!==0)return getCss(this[0],t)}function setCss(t,e,s,n){if(typeof e=="string"){const r=getCss(t),a=typeof s=="function"?s.call(t,n,r[e]):s;a===""?delete r[e]:a!=null&&(r[e]=a),t.attribs.style=stringify$1(r)}else typeof e=="object"&&Object.keys(e).forEach((r,a)=>{setCss(t,r,e[r],a)})}function getCss(t,e){if(!t||!isTag(t))return;const s=parse$2(t.attribs.style);if(typeof e=="string")return s[e];if(Array.isArray(e)){const n={};return e.forEach(r=>{s[r]!=null&&(n[r]=s[r])}),n}return s}function stringify$1(t){return Object.keys(t).reduce((e,s)=>`${e}${e?" ":""}${s}: ${t[s]};`,"")}function parse$2(t){if(t=(t||"").trim(),!t)return{};const e={};let s;for(const n of t.split(";")){const r=n.indexOf(":");if(r<1||r===n.length-1){const a=n.trimEnd();a.length>0&&s!==void 0&&(e[s]+=`;${a}`)}else s=n.slice(0,r).trim(),e[s]=n.slice(r+1).trim()}return e}const Css=Object.freeze(Object.defineProperty({__proto__:null,css},Symbol.toStringTag,{value:"Module"})),submittableSelector="input,select,textarea,keygen",r20=/%20/g,rCRLF=/\r?\n/g;function serialize(){return this.serializeArray().map(s=>`${encodeURIComponent(s.name)}=${encodeURIComponent(s.value)}`).join("&").replace(r20,"+")}function serializeArray(){return this.map((t,e)=>{const s=this._make(e);return isTag(e)&&e.name==="form"?s.find(submittableSelector).toArray():s.filter(submittableSelector).toArray()}).filter('[name!=""]:enabled:not(:submit, :button, :image, :reset, :file):matches([checked], :not(:checkbox, :radio))').map((t,e)=>{var s;const n=this._make(e),r=n.attr("name"),a=(s=n.val())!==null&&s!==void 0?s:"";return Array.isArray(a)?a.map(i=>({name:r,value:i.replace(rCRLF,`\r
`)})):{name:r,value:a.replace(rCRLF,`\r
`)}}).toArray()}const Forms=Object.freeze(Object.defineProperty({__proto__:null,serialize,serializeArray},Symbol.toStringTag,{value:"Module"}));class Cheerio{constructor(e,s,n){if(this.length=0,this.options=n,this._root=s,e){for(let r=0;r<e.length;r++)this[r]=e[r];this.length=e.length}}}Cheerio.prototype.cheerio="[cheerio object]",Cheerio.prototype.splice=Array.prototype.splice,Cheerio.prototype[Symbol.iterator]=Array.prototype[Symbol.iterator],Object.assign(Cheerio.prototype,Attributes,Traversing,Manipulation,Css,Forms);function getLoad(t,e){return function s(n,r,a=!0){if(n==null)throw new Error("cheerio.load() expects a string");const i={...defaultOpts$2,...flatten(r)},u=t(n,i,a,null);class f extends Cheerio{_make(h,m){const _=c(h,m);return _.prevObject=this,_}_parse(h,m,_,p){return t(h,m,_,p)}_render(h){return e(h,this.options)}}function c(d,h,m=u,_){if(d&&isCheerio(d))return d;const p={...i,...flatten(_)},b=typeof m=="string"?[t(m,p,!1,null)]:"length"in m?m:[m],A=isCheerio(b)?b:new f(b,null,p);if(A._root=A,!d)return new f(void 0,A,p);const T=typeof d=="string"&&isHtml(d)?t(d,p,!1,null).children:isNode$2(d)?[d]:Array.isArray(d)?d:void 0,v=new f(T,A,p);if(T)return v;if(typeof d!="string")throw new Error("Unexpected type of selector");let N=d;const x=h?typeof h=="string"?isHtml(h)?new f([t(h,p,!1,null)],A,p):(N=`${h} ${N}`,A):isCheerio(h)?h:new f(Array.isArray(h)?h:[h],A,p):A;return x?x.find(N):v}return Object.assign(c,staticMethods,{load:s,_root:u,_options:i,fn:f.prototype,prototype:f.prototype}),c}}function isNode$2(t){return!!t.name||t.type==="root"||t.type==="text"||t.type==="comment"}const UNDEFINED_CODE_POINTS=new Set([65534,65535,131070,131071,196606,196607,262142,262143,327678,327679,393214,393215,458750,458751,524286,524287,589822,589823,655358,655359,720894,720895,786430,786431,851966,851967,917502,917503,983038,983039,1048574,1048575,1114110,1114111]),REPLACEMENT_CHARACTER="�";var CODE_POINTS;(function(t){t[t.EOF=-1]="EOF",t[t.NULL=0]="NULL",t[t.TABULATION=9]="TABULATION",t[t.CARRIAGE_RETURN=13]="CARRIAGE_RETURN",t[t.LINE_FEED=10]="LINE_FEED",t[t.FORM_FEED=12]="FORM_FEED",t[t.SPACE=32]="SPACE",t[t.EXCLAMATION_MARK=33]="EXCLAMATION_MARK",t[t.QUOTATION_MARK=34]="QUOTATION_MARK",t[t.NUMBER_SIGN=35]="NUMBER_SIGN",t[t.AMPERSAND=38]="AMPERSAND",t[t.APOSTROPHE=39]="APOSTROPHE",t[t.HYPHEN_MINUS=45]="HYPHEN_MINUS",t[t.SOLIDUS=47]="SOLIDUS",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_9=57]="DIGIT_9",t[t.SEMICOLON=59]="SEMICOLON",t[t.LESS_THAN_SIGN=60]="LESS_THAN_SIGN",t[t.EQUALS_SIGN=61]="EQUALS_SIGN",t[t.GREATER_THAN_SIGN=62]="GREATER_THAN_SIGN",t[t.QUESTION_MARK=63]="QUESTION_MARK",t[t.LATIN_CAPITAL_A=65]="LATIN_CAPITAL_A",t[t.LATIN_CAPITAL_F=70]="LATIN_CAPITAL_F",t[t.LATIN_CAPITAL_X=88]="LATIN_CAPITAL_X",t[t.LATIN_CAPITAL_Z=90]="LATIN_CAPITAL_Z",t[t.RIGHT_SQUARE_BRACKET=93]="RIGHT_SQUARE_BRACKET",t[t.GRAVE_ACCENT=96]="GRAVE_ACCENT",t[t.LATIN_SMALL_A=97]="LATIN_SMALL_A",t[t.LATIN_SMALL_F=102]="LATIN_SMALL_F",t[t.LATIN_SMALL_X=120]="LATIN_SMALL_X",t[t.LATIN_SMALL_Z=122]="LATIN_SMALL_Z",t[t.REPLACEMENT_CHARACTER=65533]="REPLACEMENT_CHARACTER"})(CODE_POINTS=CODE_POINTS||(CODE_POINTS={}));const SEQUENCES={DASH_DASH:"--",CDATA_START:"[CDATA[",DOCTYPE:"doctype",SCRIPT:"script",PUBLIC:"public",SYSTEM:"system"};function isSurrogate(t){return t>=55296&&t<=57343}function isSurrogatePair(t){return t>=56320&&t<=57343}function getSurrogatePairCodePoint(t,e){return(t-55296)*1024+9216+e}function isControlCodePoint(t){return t!==32&&t!==10&&t!==13&&t!==9&&t!==12&&t>=1&&t<=31||t>=127&&t<=159}function isUndefinedCodePoint(t){return t>=64976&&t<=65007||UNDEFINED_CODE_POINTS.has(t)}var ERR;(function(t){t.controlCharacterInInputStream="control-character-in-input-stream",t.noncharacterInInputStream="noncharacter-in-input-stream",t.surrogateInInputStream="surrogate-in-input-stream",t.nonVoidHtmlElementStartTagWithTrailingSolidus="non-void-html-element-start-tag-with-trailing-solidus",t.endTagWithAttributes="end-tag-with-attributes",t.endTagWithTrailingSolidus="end-tag-with-trailing-solidus",t.unexpectedSolidusInTag="unexpected-solidus-in-tag",t.unexpectedNullCharacter="unexpected-null-character",t.unexpectedQuestionMarkInsteadOfTagName="unexpected-question-mark-instead-of-tag-name",t.invalidFirstCharacterOfTagName="invalid-first-character-of-tag-name",t.unexpectedEqualsSignBeforeAttributeName="unexpected-equals-sign-before-attribute-name",t.missingEndTagName="missing-end-tag-name",t.unexpectedCharacterInAttributeName="unexpected-character-in-attribute-name",t.unknownNamedCharacterReference="unknown-named-character-reference",t.missingSemicolonAfterCharacterReference="missing-semicolon-after-character-reference",t.unexpectedCharacterAfterDoctypeSystemIdentifier="unexpected-character-after-doctype-system-identifier",t.unexpectedCharacterInUnquotedAttributeValue="unexpected-character-in-unquoted-attribute-value",t.eofBeforeTagName="eof-before-tag-name",t.eofInTag="eof-in-tag",t.missingAttributeValue="missing-attribute-value",t.missingWhitespaceBetweenAttributes="missing-whitespace-between-attributes",t.missingWhitespaceAfterDoctypePublicKeyword="missing-whitespace-after-doctype-public-keyword",t.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers="missing-whitespace-between-doctype-public-and-system-identifiers",t.missingWhitespaceAfterDoctypeSystemKeyword="missing-whitespace-after-doctype-system-keyword",t.missingQuoteBeforeDoctypePublicIdentifier="missing-quote-before-doctype-public-identifier",t.missingQuoteBeforeDoctypeSystemIdentifier="missing-quote-before-doctype-system-identifier",t.missingDoctypePublicIdentifier="missing-doctype-public-identifier",t.missingDoctypeSystemIdentifier="missing-doctype-system-identifier",t.abruptDoctypePublicIdentifier="abrupt-doctype-public-identifier",t.abruptDoctypeSystemIdentifier="abrupt-doctype-system-identifier",t.cdataInHtmlContent="cdata-in-html-content",t.incorrectlyOpenedComment="incorrectly-opened-comment",t.eofInScriptHtmlCommentLikeText="eof-in-script-html-comment-like-text",t.eofInDoctype="eof-in-doctype",t.nestedComment="nested-comment",t.abruptClosingOfEmptyComment="abrupt-closing-of-empty-comment",t.eofInComment="eof-in-comment",t.incorrectlyClosedComment="incorrectly-closed-comment",t.eofInCdata="eof-in-cdata",t.absenceOfDigitsInNumericCharacterReference="absence-of-digits-in-numeric-character-reference",t.nullCharacterReference="null-character-reference",t.surrogateCharacterReference="surrogate-character-reference",t.characterReferenceOutsideUnicodeRange="character-reference-outside-unicode-range",t.controlCharacterReference="control-character-reference",t.noncharacterCharacterReference="noncharacter-character-reference",t.missingWhitespaceBeforeDoctypeName="missing-whitespace-before-doctype-name",t.missingDoctypeName="missing-doctype-name",t.invalidCharacterSequenceAfterDoctypeName="invalid-character-sequence-after-doctype-name",t.duplicateAttribute="duplicate-attribute",t.nonConformingDoctype="non-conforming-doctype",t.missingDoctype="missing-doctype",t.misplacedDoctype="misplaced-doctype",t.endTagWithoutMatchingOpenElement="end-tag-without-matching-open-element",t.closingOfElementWithOpenChildElements="closing-of-element-with-open-child-elements",t.disallowedContentInNoscriptInHead="disallowed-content-in-noscript-in-head",t.openElementsLeftAfterEof="open-elements-left-after-eof",t.abandonedHeadElementChild="abandoned-head-element-child",t.misplacedStartTagForHeadElement="misplaced-start-tag-for-head-element",t.nestedNoscriptInHead="nested-noscript-in-head",t.eofInElementThatCanContainOnlyText="eof-in-element-that-can-contain-only-text"})(ERR=ERR||(ERR={}));const DEFAULT_BUFFER_WATERLINE=65536;class Preprocessor{constructor(e){this.handler=e,this.html="",this.pos=-1,this.lastGapPos=-2,this.gapStack=[],this.skipNextNewLine=!1,this.lastChunkWritten=!1,this.endOfChunkHit=!1,this.bufferWaterline=DEFAULT_BUFFER_WATERLINE,this.isEol=!1,this.lineStartPos=0,this.droppedBufferSize=0,this.line=1,this.lastErrOffset=-1}get col(){return this.pos-this.lineStartPos+ +(this.lastGapPos!==this.pos)}get offset(){return this.droppedBufferSize+this.pos}getError(e){const{line:s,col:n,offset:r}=this;return{code:e,startLine:s,endLine:s,startCol:n,endCol:n,startOffset:r,endOffset:r}}_err(e){this.handler.onParseError&&this.lastErrOffset!==this.offset&&(this.lastErrOffset=this.offset,this.handler.onParseError(this.getError(e)))}_addGap(){this.gapStack.push(this.lastGapPos),this.lastGapPos=this.pos}_processSurrogate(e){if(this.pos!==this.html.length-1){const s=this.html.charCodeAt(this.pos+1);if(isSurrogatePair(s))return this.pos++,this._addGap(),getSurrogatePairCodePoint(e,s)}else if(!this.lastChunkWritten)return this.endOfChunkHit=!0,CODE_POINTS.EOF;return this._err(ERR.surrogateInInputStream),e}willDropParsedChunk(){return this.pos>this.bufferWaterline}dropParsedChunk(){this.willDropParsedChunk()&&(this.html=this.html.substring(this.pos),this.lineStartPos-=this.pos,this.droppedBufferSize+=this.pos,this.pos=0,this.lastGapPos=-2,this.gapStack.length=0)}write(e,s){this.html.length>0?this.html+=e:this.html=e,this.endOfChunkHit=!1,this.lastChunkWritten=s}insertHtmlAtCurrentPos(e){this.html=this.html.substring(0,this.pos+1)+e+this.html.substring(this.pos+1),this.endOfChunkHit=!1}startsWith(e,s){if(this.pos+e.length>this.html.length)return this.endOfChunkHit=!this.lastChunkWritten,!1;if(s)return this.html.startsWith(e,this.pos);for(let n=0;n<e.length;n++)if((this.html.charCodeAt(this.pos+n)|32)!==e.charCodeAt(n))return!1;return!0}peek(e){const s=this.pos+e;if(s>=this.html.length)return this.endOfChunkHit=!this.lastChunkWritten,CODE_POINTS.EOF;const n=this.html.charCodeAt(s);return n===CODE_POINTS.CARRIAGE_RETURN?CODE_POINTS.LINE_FEED:n}advance(){if(this.pos++,this.isEol&&(this.isEol=!1,this.line++,this.lineStartPos=this.pos),this.pos>=this.html.length)return this.endOfChunkHit=!this.lastChunkWritten,CODE_POINTS.EOF;let e=this.html.charCodeAt(this.pos);return e===CODE_POINTS.CARRIAGE_RETURN?(this.isEol=!0,this.skipNextNewLine=!0,CODE_POINTS.LINE_FEED):e===CODE_POINTS.LINE_FEED&&(this.isEol=!0,this.skipNextNewLine)?(this.line--,this.skipNextNewLine=!1,this._addGap(),this.advance()):(this.skipNextNewLine=!1,isSurrogate(e)&&(e=this._processSurrogate(e)),this.handler.onParseError===null||e>31&&e<127||e===CODE_POINTS.LINE_FEED||e===CODE_POINTS.CARRIAGE_RETURN||e>159&&e<64976||this._checkForProblematicCharacters(e),e)}_checkForProblematicCharacters(e){isControlCodePoint(e)?this._err(ERR.controlCharacterInInputStream):isUndefinedCodePoint(e)&&this._err(ERR.noncharacterInInputStream)}retreat(e){for(this.pos-=e;this.pos<this.lastGapPos;)this.lastGapPos=this.gapStack.pop(),this.pos--;this.isEol=!1}}var TokenType;(function(t){t[t.CHARACTER=0]="CHARACTER",t[t.NULL_CHARACTER=1]="NULL_CHARACTER",t[t.WHITESPACE_CHARACTER=2]="WHITESPACE_CHARACTER",t[t.START_TAG=3]="START_TAG",t[t.END_TAG=4]="END_TAG",t[t.COMMENT=5]="COMMENT",t[t.DOCTYPE=6]="DOCTYPE",t[t.EOF=7]="EOF",t[t.HIBERNATION=8]="HIBERNATION"})(TokenType=TokenType||(TokenType={}));function getTokenAttr(t,e){for(let s=t.attrs.length-1;s>=0;s--)if(t.attrs[s].name===e)return t.attrs[s].value;return null}var NS;(function(t){t.HTML="http://www.w3.org/1999/xhtml",t.MATHML="http://www.w3.org/1998/Math/MathML",t.SVG="http://www.w3.org/2000/svg",t.XLINK="http://www.w3.org/1999/xlink",t.XML="http://www.w3.org/XML/1998/namespace",t.XMLNS="http://www.w3.org/2000/xmlns/"})(NS=NS||(NS={}));var ATTRS;(function(t){t.TYPE="type",t.ACTION="action",t.ENCODING="encoding",t.PROMPT="prompt",t.NAME="name",t.COLOR="color",t.FACE="face",t.SIZE="size"})(ATTRS=ATTRS||(ATTRS={}));var DOCUMENT_MODE;(function(t){t.NO_QUIRKS="no-quirks",t.QUIRKS="quirks",t.LIMITED_QUIRKS="limited-quirks"})(DOCUMENT_MODE=DOCUMENT_MODE||(DOCUMENT_MODE={}));var TAG_NAMES;(function(t){t.A="a",t.ADDRESS="address",t.ANNOTATION_XML="annotation-xml",t.APPLET="applet",t.AREA="area",t.ARTICLE="article",t.ASIDE="aside",t.B="b",t.BASE="base",t.BASEFONT="basefont",t.BGSOUND="bgsound",t.BIG="big",t.BLOCKQUOTE="blockquote",t.BODY="body",t.BR="br",t.BUTTON="button",t.CAPTION="caption",t.CENTER="center",t.CODE="code",t.COL="col",t.COLGROUP="colgroup",t.DD="dd",t.DESC="desc",t.DETAILS="details",t.DIALOG="dialog",t.DIR="dir",t.DIV="div",t.DL="dl",t.DT="dt",t.EM="em",t.EMBED="embed",t.FIELDSET="fieldset",t.FIGCAPTION="figcaption",t.FIGURE="figure",t.FONT="font",t.FOOTER="footer",t.FOREIGN_OBJECT="foreignObject",t.FORM="form",t.FRAME="frame",t.FRAMESET="frameset",t.H1="h1",t.H2="h2",t.H3="h3",t.H4="h4",t.H5="h5",t.H6="h6",t.HEAD="head",t.HEADER="header",t.HGROUP="hgroup",t.HR="hr",t.HTML="html",t.I="i",t.IMG="img",t.IMAGE="image",t.INPUT="input",t.IFRAME="iframe",t.KEYGEN="keygen",t.LABEL="label",t.LI="li",t.LINK="link",t.LISTING="listing",t.MAIN="main",t.MALIGNMARK="malignmark",t.MARQUEE="marquee",t.MATH="math",t.MENU="menu",t.META="meta",t.MGLYPH="mglyph",t.MI="mi",t.MO="mo",t.MN="mn",t.MS="ms",t.MTEXT="mtext",t.NAV="nav",t.NOBR="nobr",t.NOFRAMES="noframes",t.NOEMBED="noembed",t.NOSCRIPT="noscript",t.OBJECT="object",t.OL="ol",t.OPTGROUP="optgroup",t.OPTION="option",t.P="p",t.PARAM="param",t.PLAINTEXT="plaintext",t.PRE="pre",t.RB="rb",t.RP="rp",t.RT="rt",t.RTC="rtc",t.RUBY="ruby",t.S="s",t.SCRIPT="script",t.SECTION="section",t.SELECT="select",t.SOURCE="source",t.SMALL="small",t.SPAN="span",t.STRIKE="strike",t.STRONG="strong",t.STYLE="style",t.SUB="sub",t.SUMMARY="summary",t.SUP="sup",t.TABLE="table",t.TBODY="tbody",t.TEMPLATE="template",t.TEXTAREA="textarea",t.TFOOT="tfoot",t.TD="td",t.TH="th",t.THEAD="thead",t.TITLE="title",t.TR="tr",t.TRACK="track",t.TT="tt",t.U="u",t.UL="ul",t.SVG="svg",t.VAR="var",t.WBR="wbr",t.XMP="xmp"})(TAG_NAMES=TAG_NAMES||(TAG_NAMES={}));var TAG_ID;(function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A=1]="A",t[t.ADDRESS=2]="ADDRESS",t[t.ANNOTATION_XML=3]="ANNOTATION_XML",t[t.APPLET=4]="APPLET",t[t.AREA=5]="AREA",t[t.ARTICLE=6]="ARTICLE",t[t.ASIDE=7]="ASIDE",t[t.B=8]="B",t[t.BASE=9]="BASE",t[t.BASEFONT=10]="BASEFONT",t[t.BGSOUND=11]="BGSOUND",t[t.BIG=12]="BIG",t[t.BLOCKQUOTE=13]="BLOCKQUOTE",t[t.BODY=14]="BODY",t[t.BR=15]="BR",t[t.BUTTON=16]="BUTTON",t[t.CAPTION=17]="CAPTION",t[t.CENTER=18]="CENTER",t[t.CODE=19]="CODE",t[t.COL=20]="COL",t[t.COLGROUP=21]="COLGROUP",t[t.DD=22]="DD",t[t.DESC=23]="DESC",t[t.DETAILS=24]="DETAILS",t[t.DIALOG=25]="DIALOG",t[t.DIR=26]="DIR",t[t.DIV=27]="DIV",t[t.DL=28]="DL",t[t.DT=29]="DT",t[t.EM=30]="EM",t[t.EMBED=31]="EMBED",t[t.FIELDSET=32]="FIELDSET",t[t.FIGCAPTION=33]="FIGCAPTION",t[t.FIGURE=34]="FIGURE",t[t.FONT=35]="FONT",t[t.FOOTER=36]="FOOTER",t[t.FOREIGN_OBJECT=37]="FOREIGN_OBJECT",t[t.FORM=38]="FORM",t[t.FRAME=39]="FRAME",t[t.FRAMESET=40]="FRAMESET",t[t.H1=41]="H1",t[t.H2=42]="H2",t[t.H3=43]="H3",t[t.H4=44]="H4",t[t.H5=45]="H5",t[t.H6=46]="H6",t[t.HEAD=47]="HEAD",t[t.HEADER=48]="HEADER",t[t.HGROUP=49]="HGROUP",t[t.HR=50]="HR",t[t.HTML=51]="HTML",t[t.I=52]="I",t[t.IMG=53]="IMG",t[t.IMAGE=54]="IMAGE",t[t.INPUT=55]="INPUT",t[t.IFRAME=56]="IFRAME",t[t.KEYGEN=57]="KEYGEN",t[t.LABEL=58]="LABEL",t[t.LI=59]="LI",t[t.LINK=60]="LINK",t[t.LISTING=61]="LISTING",t[t.MAIN=62]="MAIN",t[t.MALIGNMARK=63]="MALIGNMARK",t[t.MARQUEE=64]="MARQUEE",t[t.MATH=65]="MATH",t[t.MENU=66]="MENU",t[t.META=67]="META",t[t.MGLYPH=68]="MGLYPH",t[t.MI=69]="MI",t[t.MO=70]="MO",t[t.MN=71]="MN",t[t.MS=72]="MS",t[t.MTEXT=73]="MTEXT",t[t.NAV=74]="NAV",t[t.NOBR=75]="NOBR",t[t.NOFRAMES=76]="NOFRAMES",t[t.NOEMBED=77]="NOEMBED",t[t.NOSCRIPT=78]="NOSCRIPT",t[t.OBJECT=79]="OBJECT",t[t.OL=80]="OL",t[t.OPTGROUP=81]="OPTGROUP",t[t.OPTION=82]="OPTION",t[t.P=83]="P",t[t.PARAM=84]="PARAM",t[t.PLAINTEXT=85]="PLAINTEXT",t[t.PRE=86]="PRE",t[t.RB=87]="RB",t[t.RP=88]="RP",t[t.RT=89]="RT",t[t.RTC=90]="RTC",t[t.RUBY=91]="RUBY",t[t.S=92]="S",t[t.SCRIPT=93]="SCRIPT",t[t.SECTION=94]="SECTION",t[t.SELECT=95]="SELECT",t[t.SOURCE=96]="SOURCE",t[t.SMALL=97]="SMALL",t[t.SPAN=98]="SPAN",t[t.STRIKE=99]="STRIKE",t[t.STRONG=100]="STRONG",t[t.STYLE=101]="STYLE",t[t.SUB=102]="SUB",t[t.SUMMARY=103]="SUMMARY",t[t.SUP=104]="SUP",t[t.TABLE=105]="TABLE",t[t.TBODY=106]="TBODY",t[t.TEMPLATE=107]="TEMPLATE",t[t.TEXTAREA=108]="TEXTAREA",t[t.TFOOT=109]="TFOOT",t[t.TD=110]="TD",t[t.TH=111]="TH",t[t.THEAD=112]="THEAD",t[t.TITLE=113]="TITLE",t[t.TR=114]="TR",t[t.TRACK=115]="TRACK",t[t.TT=116]="TT",t[t.U=117]="U",t[t.UL=118]="UL",t[t.SVG=119]="SVG",t[t.VAR=120]="VAR",t[t.WBR=121]="WBR",t[t.XMP=122]="XMP"})(TAG_ID=TAG_ID||(TAG_ID={}));const TAG_NAME_TO_ID=new Map([[TAG_NAMES.A,TAG_ID.A],[TAG_NAMES.ADDRESS,TAG_ID.ADDRESS],[TAG_NAMES.ANNOTATION_XML,TAG_ID.ANNOTATION_XML],[TAG_NAMES.APPLET,TAG_ID.APPLET],[TAG_NAMES.AREA,TAG_ID.AREA],[TAG_NAMES.ARTICLE,TAG_ID.ARTICLE],[TAG_NAMES.ASIDE,TAG_ID.ASIDE],[TAG_NAMES.B,TAG_ID.B],[TAG_NAMES.BASE,TAG_ID.BASE],[TAG_NAMES.BASEFONT,TAG_ID.BASEFONT],[TAG_NAMES.BGSOUND,TAG_ID.BGSOUND],[TAG_NAMES.BIG,TAG_ID.BIG],[TAG_NAMES.BLOCKQUOTE,TAG_ID.BLOCKQUOTE],[TAG_NAMES.BODY,TAG_ID.BODY],[TAG_NAMES.BR,TAG_ID.BR],[TAG_NAMES.BUTTON,TAG_ID.BUTTON],[TAG_NAMES.CAPTION,TAG_ID.CAPTION],[TAG_NAMES.CENTER,TAG_ID.CENTER],[TAG_NAMES.CODE,TAG_ID.CODE],[TAG_NAMES.COL,TAG_ID.COL],[TAG_NAMES.COLGROUP,TAG_ID.COLGROUP],[TAG_NAMES.DD,TAG_ID.DD],[TAG_NAMES.DESC,TAG_ID.DESC],[TAG_NAMES.DETAILS,TAG_ID.DETAILS],[TAG_NAMES.DIALOG,TAG_ID.DIALOG],[TAG_NAMES.DIR,TAG_ID.DIR],[TAG_NAMES.DIV,TAG_ID.DIV],[TAG_NAMES.DL,TAG_ID.DL],[TAG_NAMES.DT,TAG_ID.DT],[TAG_NAMES.EM,TAG_ID.EM],[TAG_NAMES.EMBED,TAG_ID.EMBED],[TAG_NAMES.FIELDSET,TAG_ID.FIELDSET],[TAG_NAMES.FIGCAPTION,TAG_ID.FIGCAPTION],[TAG_NAMES.FIGURE,TAG_ID.FIGURE],[TAG_NAMES.FONT,TAG_ID.FONT],[TAG_NAMES.FOOTER,TAG_ID.FOOTER],[TAG_NAMES.FOREIGN_OBJECT,TAG_ID.FOREIGN_OBJECT],[TAG_NAMES.FORM,TAG_ID.FORM],[TAG_NAMES.FRAME,TAG_ID.FRAME],[TAG_NAMES.FRAMESET,TAG_ID.FRAMESET],[TAG_NAMES.H1,TAG_ID.H1],[TAG_NAMES.H2,TAG_ID.H2],[TAG_NAMES.H3,TAG_ID.H3],[TAG_NAMES.H4,TAG_ID.H4],[TAG_NAMES.H5,TAG_ID.H5],[TAG_NAMES.H6,TAG_ID.H6],[TAG_NAMES.HEAD,TAG_ID.HEAD],[TAG_NAMES.HEADER,TAG_ID.HEADER],[TAG_NAMES.HGROUP,TAG_ID.HGROUP],[TAG_NAMES.HR,TAG_ID.HR],[TAG_NAMES.HTML,TAG_ID.HTML],[TAG_NAMES.I,TAG_ID.I],[TAG_NAMES.IMG,TAG_ID.IMG],[TAG_NAMES.IMAGE,TAG_ID.IMAGE],[TAG_NAMES.INPUT,TAG_ID.INPUT],[TAG_NAMES.IFRAME,TAG_ID.IFRAME],[TAG_NAMES.KEYGEN,TAG_ID.KEYGEN],[TAG_NAMES.LABEL,TAG_ID.LABEL],[TAG_NAMES.LI,TAG_ID.LI],[TAG_NAMES.LINK,TAG_ID.LINK],[TAG_NAMES.LISTING,TAG_ID.LISTING],[TAG_NAMES.MAIN,TAG_ID.MAIN],[TAG_NAMES.MALIGNMARK,TAG_ID.MALIGNMARK],[TAG_NAMES.MARQUEE,TAG_ID.MARQUEE],[TAG_NAMES.MATH,TAG_ID.MATH],[TAG_NAMES.MENU,TAG_ID.MENU],[TAG_NAMES.META,TAG_ID.META],[TAG_NAMES.MGLYPH,TAG_ID.MGLYPH],[TAG_NAMES.MI,TAG_ID.MI],[TAG_NAMES.MO,TAG_ID.MO],[TAG_NAMES.MN,TAG_ID.MN],[TAG_NAMES.MS,TAG_ID.MS],[TAG_NAMES.MTEXT,TAG_ID.MTEXT],[TAG_NAMES.NAV,TAG_ID.NAV],[TAG_NAMES.NOBR,TAG_ID.NOBR],[TAG_NAMES.NOFRAMES,TAG_ID.NOFRAMES],[TAG_NAMES.NOEMBED,TAG_ID.NOEMBED],[TAG_NAMES.NOSCRIPT,TAG_ID.NOSCRIPT],[TAG_NAMES.OBJECT,TAG_ID.OBJECT],[TAG_NAMES.OL,TAG_ID.OL],[TAG_NAMES.OPTGROUP,TAG_ID.OPTGROUP],[TAG_NAMES.OPTION,TAG_ID.OPTION],[TAG_NAMES.P,TAG_ID.P],[TAG_NAMES.PARAM,TAG_ID.PARAM],[TAG_NAMES.PLAINTEXT,TAG_ID.PLAINTEXT],[TAG_NAMES.PRE,TAG_ID.PRE],[TAG_NAMES.RB,TAG_ID.RB],[TAG_NAMES.RP,TAG_ID.RP],[TAG_NAMES.RT,TAG_ID.RT],[TAG_NAMES.RTC,TAG_ID.RTC],[TAG_NAMES.RUBY,TAG_ID.RUBY],[TAG_NAMES.S,TAG_ID.S],[TAG_NAMES.SCRIPT,TAG_ID.SCRIPT],[TAG_NAMES.SECTION,TAG_ID.SECTION],[TAG_NAMES.SELECT,TAG_ID.SELECT],[TAG_NAMES.SOURCE,TAG_ID.SOURCE],[TAG_NAMES.SMALL,TAG_ID.SMALL],[TAG_NAMES.SPAN,TAG_ID.SPAN],[TAG_NAMES.STRIKE,TAG_ID.STRIKE],[TAG_NAMES.STRONG,TAG_ID.STRONG],[TAG_NAMES.STYLE,TAG_ID.STYLE],[TAG_NAMES.SUB,TAG_ID.SUB],[TAG_NAMES.SUMMARY,TAG_ID.SUMMARY],[TAG_NAMES.SUP,TAG_ID.SUP],[TAG_NAMES.TABLE,TAG_ID.TABLE],[TAG_NAMES.TBODY,TAG_ID.TBODY],[TAG_NAMES.TEMPLATE,TAG_ID.TEMPLATE],[TAG_NAMES.TEXTAREA,TAG_ID.TEXTAREA],[TAG_NAMES.TFOOT,TAG_ID.TFOOT],[TAG_NAMES.TD,TAG_ID.TD],[TAG_NAMES.TH,TAG_ID.TH],[TAG_NAMES.THEAD,TAG_ID.THEAD],[TAG_NAMES.TITLE,TAG_ID.TITLE],[TAG_NAMES.TR,TAG_ID.TR],[TAG_NAMES.TRACK,TAG_ID.TRACK],[TAG_NAMES.TT,TAG_ID.TT],[TAG_NAMES.U,TAG_ID.U],[TAG_NAMES.UL,TAG_ID.UL],[TAG_NAMES.SVG,TAG_ID.SVG],[TAG_NAMES.VAR,TAG_ID.VAR],[TAG_NAMES.WBR,TAG_ID.WBR],[TAG_NAMES.XMP,TAG_ID.XMP]]);function getTagID(t){var e;return(e=TAG_NAME_TO_ID.get(t))!==null&&e!==void 0?e:TAG_ID.UNKNOWN}const $=TAG_ID,SPECIAL_ELEMENTS={[NS.HTML]:new Set([$.ADDRESS,$.APPLET,$.AREA,$.ARTICLE,$.ASIDE,$.BASE,$.BASEFONT,$.BGSOUND,$.BLOCKQUOTE,$.BODY,$.BR,$.BUTTON,$.CAPTION,$.CENTER,$.COL,$.COLGROUP,$.DD,$.DETAILS,$.DIR,$.DIV,$.DL,$.DT,$.EMBED,$.FIELDSET,$.FIGCAPTION,$.FIGURE,$.FOOTER,$.FORM,$.FRAME,$.FRAMESET,$.H1,$.H2,$.H3,$.H4,$.H5,$.H6,$.HEAD,$.HEADER,$.HGROUP,$.HR,$.HTML,$.IFRAME,$.IMG,$.INPUT,$.LI,$.LINK,$.LISTING,$.MAIN,$.MARQUEE,$.MENU,$.META,$.NAV,$.NOEMBED,$.NOFRAMES,$.NOSCRIPT,$.OBJECT,$.OL,$.P,$.PARAM,$.PLAINTEXT,$.PRE,$.SCRIPT,$.SECTION,$.SELECT,$.SOURCE,$.STYLE,$.SUMMARY,$.TABLE,$.TBODY,$.TD,$.TEMPLATE,$.TEXTAREA,$.TFOOT,$.TH,$.THEAD,$.TITLE,$.TR,$.TRACK,$.UL,$.WBR,$.XMP]),[NS.MATHML]:new Set([$.MI,$.MO,$.MN,$.MS,$.MTEXT,$.ANNOTATION_XML]),[NS.SVG]:new Set([$.TITLE,$.FOREIGN_OBJECT,$.DESC]),[NS.XLINK]:new Set,[NS.XML]:new Set,[NS.XMLNS]:new Set};function isNumberedHeader(t){return t===$.H1||t===$.H2||t===$.H3||t===$.H4||t===$.H5||t===$.H6}const UNESCAPED_TEXT=new Set([TAG_NAMES.STYLE,TAG_NAMES.SCRIPT,TAG_NAMES.XMP,TAG_NAMES.IFRAME,TAG_NAMES.NOEMBED,TAG_NAMES.NOFRAMES,TAG_NAMES.PLAINTEXT]);function hasUnescapedText(t,e){return UNESCAPED_TEXT.has(t)||e&&t===TAG_NAMES.NOSCRIPT}const C1_CONTROLS_REFERENCE_REPLACEMENTS=new Map([[128,8364],[130,8218],[131,402],[132,8222],[133,8230],[134,8224],[135,8225],[136,710],[137,8240],[138,352],[139,8249],[140,338],[142,381],[145,8216],[146,8217],[147,8220],[148,8221],[149,8226],[150,8211],[151,8212],[152,732],[153,8482],[154,353],[155,8250],[156,339],[158,382],[159,376]]);var State$1;(function(t){t[t.DATA=0]="DATA",t[t.RCDATA=1]="RCDATA",t[t.RAWTEXT=2]="RAWTEXT",t[t.SCRIPT_DATA=3]="SCRIPT_DATA",t[t.PLAINTEXT=4]="PLAINTEXT",t[t.TAG_OPEN=5]="TAG_OPEN",t[t.END_TAG_OPEN=6]="END_TAG_OPEN",t[t.TAG_NAME=7]="TAG_NAME",t[t.RCDATA_LESS_THAN_SIGN=8]="RCDATA_LESS_THAN_SIGN",t[t.RCDATA_END_TAG_OPEN=9]="RCDATA_END_TAG_OPEN",t[t.RCDATA_END_TAG_NAME=10]="RCDATA_END_TAG_NAME",t[t.RAWTEXT_LESS_THAN_SIGN=11]="RAWTEXT_LESS_THAN_SIGN",t[t.RAWTEXT_END_TAG_OPEN=12]="RAWTEXT_END_TAG_OPEN",t[t.RAWTEXT_END_TAG_NAME=13]="RAWTEXT_END_TAG_NAME",t[t.SCRIPT_DATA_LESS_THAN_SIGN=14]="SCRIPT_DATA_LESS_THAN_SIGN",t[t.SCRIPT_DATA_END_TAG_OPEN=15]="SCRIPT_DATA_END_TAG_OPEN",t[t.SCRIPT_DATA_END_TAG_NAME=16]="SCRIPT_DATA_END_TAG_NAME",t[t.SCRIPT_DATA_ESCAPE_START=17]="SCRIPT_DATA_ESCAPE_START",t[t.SCRIPT_DATA_ESCAPE_START_DASH=18]="SCRIPT_DATA_ESCAPE_START_DASH",t[t.SCRIPT_DATA_ESCAPED=19]="SCRIPT_DATA_ESCAPED",t[t.SCRIPT_DATA_ESCAPED_DASH=20]="SCRIPT_DATA_ESCAPED_DASH",t[t.SCRIPT_DATA_ESCAPED_DASH_DASH=21]="SCRIPT_DATA_ESCAPED_DASH_DASH",t[t.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN=22]="SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN",t[t.SCRIPT_DATA_ESCAPED_END_TAG_OPEN=23]="SCRIPT_DATA_ESCAPED_END_TAG_OPEN",t[t.SCRIPT_DATA_ESCAPED_END_TAG_NAME=24]="SCRIPT_DATA_ESCAPED_END_TAG_NAME",t[t.SCRIPT_DATA_DOUBLE_ESCAPE_START=25]="SCRIPT_DATA_DOUBLE_ESCAPE_START",t[t.SCRIPT_DATA_DOUBLE_ESCAPED=26]="SCRIPT_DATA_DOUBLE_ESCAPED",t[t.SCRIPT_DATA_DOUBLE_ESCAPED_DASH=27]="SCRIPT_DATA_DOUBLE_ESCAPED_DASH",t[t.SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH=28]="SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH",t[t.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN=29]="SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN",t[t.SCRIPT_DATA_DOUBLE_ESCAPE_END=30]="SCRIPT_DATA_DOUBLE_ESCAPE_END",t[t.BEFORE_ATTRIBUTE_NAME=31]="BEFORE_ATTRIBUTE_NAME",t[t.ATTRIBUTE_NAME=32]="ATTRIBUTE_NAME",t[t.AFTER_ATTRIBUTE_NAME=33]="AFTER_ATTRIBUTE_NAME",t[t.BEFORE_ATTRIBUTE_VALUE=34]="BEFORE_ATTRIBUTE_VALUE",t[t.ATTRIBUTE_VALUE_DOUBLE_QUOTED=35]="ATTRIBUTE_VALUE_DOUBLE_QUOTED",t[t.ATTRIBUTE_VALUE_SINGLE_QUOTED=36]="ATTRIBUTE_VALUE_SINGLE_QUOTED",t[t.ATTRIBUTE_VALUE_UNQUOTED=37]="ATTRIBUTE_VALUE_UNQUOTED",t[t.AFTER_ATTRIBUTE_VALUE_QUOTED=38]="AFTER_ATTRIBUTE_VALUE_QUOTED",t[t.SELF_CLOSING_START_TAG=39]="SELF_CLOSING_START_TAG",t[t.BOGUS_COMMENT=40]="BOGUS_COMMENT",t[t.MARKUP_DECLARATION_OPEN=41]="MARKUP_DECLARATION_OPEN",t[t.COMMENT_START=42]="COMMENT_START",t[t.COMMENT_START_DASH=43]="COMMENT_START_DASH",t[t.COMMENT=44]="COMMENT",t[t.COMMENT_LESS_THAN_SIGN=45]="COMMENT_LESS_THAN_SIGN",t[t.COMMENT_LESS_THAN_SIGN_BANG=46]="COMMENT_LESS_THAN_SIGN_BANG",t[t.COMMENT_LESS_THAN_SIGN_BANG_DASH=47]="COMMENT_LESS_THAN_SIGN_BANG_DASH",t[t.COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH=48]="COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH",t[t.COMMENT_END_DASH=49]="COMMENT_END_DASH",t[t.COMMENT_END=50]="COMMENT_END",t[t.COMMENT_END_BANG=51]="COMMENT_END_BANG",t[t.DOCTYPE=52]="DOCTYPE",t[t.BEFORE_DOCTYPE_NAME=53]="BEFORE_DOCTYPE_NAME",t[t.DOCTYPE_NAME=54]="DOCTYPE_NAME",t[t.AFTER_DOCTYPE_NAME=55]="AFTER_DOCTYPE_NAME",t[t.AFTER_DOCTYPE_PUBLIC_KEYWORD=56]="AFTER_DOCTYPE_PUBLIC_KEYWORD",t[t.BEFORE_DOCTYPE_PUBLIC_IDENTIFIER=57]="BEFORE_DOCTYPE_PUBLIC_IDENTIFIER",t[t.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED=58]="DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED",t[t.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED=59]="DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED",t[t.AFTER_DOCTYPE_PUBLIC_IDENTIFIER=60]="AFTER_DOCTYPE_PUBLIC_IDENTIFIER",t[t.BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS=61]="BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS",t[t.AFTER_DOCTYPE_SYSTEM_KEYWORD=62]="AFTER_DOCTYPE_SYSTEM_KEYWORD",t[t.BEFORE_DOCTYPE_SYSTEM_IDENTIFIER=63]="BEFORE_DOCTYPE_SYSTEM_IDENTIFIER",t[t.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED=64]="DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED",t[t.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED=65]="DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED",t[t.AFTER_DOCTYPE_SYSTEM_IDENTIFIER=66]="AFTER_DOCTYPE_SYSTEM_IDENTIFIER",t[t.BOGUS_DOCTYPE=67]="BOGUS_DOCTYPE",t[t.CDATA_SECTION=68]="CDATA_SECTION",t[t.CDATA_SECTION_BRACKET=69]="CDATA_SECTION_BRACKET",t[t.CDATA_SECTION_END=70]="CDATA_SECTION_END",t[t.CHARACTER_REFERENCE=71]="CHARACTER_REFERENCE",t[t.NAMED_CHARACTER_REFERENCE=72]="NAMED_CHARACTER_REFERENCE",t[t.AMBIGUOUS_AMPERSAND=73]="AMBIGUOUS_AMPERSAND",t[t.NUMERIC_CHARACTER_REFERENCE=74]="NUMERIC_CHARACTER_REFERENCE",t[t.HEXADEMICAL_CHARACTER_REFERENCE_START=75]="HEXADEMICAL_CHARACTER_REFERENCE_START",t[t.HEXADEMICAL_CHARACTER_REFERENCE=76]="HEXADEMICAL_CHARACTER_REFERENCE",t[t.DECIMAL_CHARACTER_REFERENCE=77]="DECIMAL_CHARACTER_REFERENCE",t[t.NUMERIC_CHARACTER_REFERENCE_END=78]="NUMERIC_CHARACTER_REFERENCE_END"})(State$1||(State$1={}));const TokenizerMode={DATA:State$1.DATA,RCDATA:State$1.RCDATA,RAWTEXT:State$1.RAWTEXT,SCRIPT_DATA:State$1.SCRIPT_DATA,PLAINTEXT:State$1.PLAINTEXT,CDATA_SECTION:State$1.CDATA_SECTION};function isAsciiDigit(t){return t>=CODE_POINTS.DIGIT_0&&t<=CODE_POINTS.DIGIT_9}function isAsciiUpper(t){return t>=CODE_POINTS.LATIN_CAPITAL_A&&t<=CODE_POINTS.LATIN_CAPITAL_Z}function isAsciiLower(t){return t>=CODE_POINTS.LATIN_SMALL_A&&t<=CODE_POINTS.LATIN_SMALL_Z}function isAsciiLetter(t){return isAsciiLower(t)||isAsciiUpper(t)}function isAsciiAlphaNumeric(t){return isAsciiLetter(t)||isAsciiDigit(t)}function isAsciiUpperHexDigit(t){return t>=CODE_POINTS.LATIN_CAPITAL_A&&t<=CODE_POINTS.LATIN_CAPITAL_F}function isAsciiLowerHexDigit(t){return t>=CODE_POINTS.LATIN_SMALL_A&&t<=CODE_POINTS.LATIN_SMALL_F}function isAsciiHexDigit(t){return isAsciiDigit(t)||isAsciiUpperHexDigit(t)||isAsciiLowerHexDigit(t)}function toAsciiLower(t){return t+32}function isWhitespace$1(t){return t===CODE_POINTS.SPACE||t===CODE_POINTS.LINE_FEED||t===CODE_POINTS.TABULATION||t===CODE_POINTS.FORM_FEED}function isEntityInAttributeInvalidEnd(t){return t===CODE_POINTS.EQUALS_SIGN||isAsciiAlphaNumeric(t)}function isScriptDataDoubleEscapeSequenceEnd(t){return isWhitespace$1(t)||t===CODE_POINTS.SOLIDUS||t===CODE_POINTS.GREATER_THAN_SIGN}let Tokenizer$1=class{constructor(e,s){this.options=e,this.handler=s,this.paused=!1,this.inLoop=!1,this.inForeignNode=!1,this.lastStartTagName="",this.active=!1,this.state=State$1.DATA,this.returnState=State$1.DATA,this.charRefCode=-1,this.consumedAfterSnapshot=-1,this.currentCharacterToken=null,this.currentToken=null,this.currentAttr={name:"",value:""},this.preprocessor=new Preprocessor(s),this.currentLocation=this.getCurrentLocation(-1)}_err(e){var s,n;(n=(s=this.handler).onParseError)===null||n===void 0||n.call(s,this.preprocessor.getError(e))}getCurrentLocation(e){return this.options.sourceCodeLocationInfo?{startLine:this.preprocessor.line,startCol:this.preprocessor.col-e,startOffset:this.preprocessor.offset-e,endLine:-1,endCol:-1,endOffset:-1}:null}_runParsingLoop(){if(!this.inLoop){for(this.inLoop=!0;this.active&&!this.paused;){this.consumedAfterSnapshot=0;const e=this._consume();this._ensureHibernation()||this._callState(e)}this.inLoop=!1}}pause(){this.paused=!0}resume(e){if(!this.paused)throw new Error("Parser was already resumed");this.paused=!1,!this.inLoop&&(this._runParsingLoop(),this.paused||e?.())}write(e,s,n){this.active=!0,this.preprocessor.write(e,s),this._runParsingLoop(),this.paused||n?.()}insertHtmlAtCurrentPos(e){this.active=!0,this.preprocessor.insertHtmlAtCurrentPos(e),this._runParsingLoop()}_ensureHibernation(){return this.preprocessor.endOfChunkHit?(this._unconsume(this.consumedAfterSnapshot),this.active=!1,!0):!1}_consume(){return this.consumedAfterSnapshot++,this.preprocessor.advance()}_unconsume(e){this.consumedAfterSnapshot-=e,this.preprocessor.retreat(e)}_reconsumeInState(e,s){this.state=e,this._callState(s)}_advanceBy(e){this.consumedAfterSnapshot+=e;for(let s=0;s<e;s++)this.preprocessor.advance()}_consumeSequenceIfMatch(e,s){return this.preprocessor.startsWith(e,s)?(this._advanceBy(e.length-1),!0):!1}_createStartTagToken(){this.currentToken={type:TokenType.START_TAG,tagName:"",tagID:TAG_ID.UNKNOWN,selfClosing:!1,ackSelfClosing:!1,attrs:[],location:this.getCurrentLocation(1)}}_createEndTagToken(){this.currentToken={type:TokenType.END_TAG,tagName:"",tagID:TAG_ID.UNKNOWN,selfClosing:!1,ackSelfClosing:!1,attrs:[],location:this.getCurrentLocation(2)}}_createCommentToken(e){this.currentToken={type:TokenType.COMMENT,data:"",location:this.getCurrentLocation(e)}}_createDoctypeToken(e){this.currentToken={type:TokenType.DOCTYPE,name:e,forceQuirks:!1,publicId:null,systemId:null,location:this.currentLocation}}_createCharacterToken(e,s){this.currentCharacterToken={type:e,chars:s,location:this.currentLocation}}_createAttr(e){this.currentAttr={name:e,value:""},this.currentLocation=this.getCurrentLocation(0)}_leaveAttrName(){var e,s;const n=this.currentToken;if(getTokenAttr(n,this.currentAttr.name)===null){if(n.attrs.push(this.currentAttr),n.location&&this.currentLocation){const r=(e=(s=n.location).attrs)!==null&&e!==void 0?e:s.attrs=Object.create(null);r[this.currentAttr.name]=this.currentLocation,this._leaveAttrValue()}}else this._err(ERR.duplicateAttribute)}_leaveAttrValue(){this.currentLocation&&(this.currentLocation.endLine=this.preprocessor.line,this.currentLocation.endCol=this.preprocessor.col,this.currentLocation.endOffset=this.preprocessor.offset)}prepareToken(e){this._emitCurrentCharacterToken(e.location),this.currentToken=null,e.location&&(e.location.endLine=this.preprocessor.line,e.location.endCol=this.preprocessor.col+1,e.location.endOffset=this.preprocessor.offset+1),this.currentLocation=this.getCurrentLocation(-1)}emitCurrentTagToken(){const e=this.currentToken;this.prepareToken(e),e.tagID=getTagID(e.tagName),e.type===TokenType.START_TAG?(this.lastStartTagName=e.tagName,this.handler.onStartTag(e)):(e.attrs.length>0&&this._err(ERR.endTagWithAttributes),e.selfClosing&&this._err(ERR.endTagWithTrailingSolidus),this.handler.onEndTag(e)),this.preprocessor.dropParsedChunk()}emitCurrentComment(e){this.prepareToken(e),this.handler.onComment(e),this.preprocessor.dropParsedChunk()}emitCurrentDoctype(e){this.prepareToken(e),this.handler.onDoctype(e),this.preprocessor.dropParsedChunk()}_emitCurrentCharacterToken(e){if(this.currentCharacterToken){switch(e&&this.currentCharacterToken.location&&(this.currentCharacterToken.location.endLine=e.startLine,this.currentCharacterToken.location.endCol=e.startCol,this.currentCharacterToken.location.endOffset=e.startOffset),this.currentCharacterToken.type){case TokenType.CHARACTER:{this.handler.onCharacter(this.currentCharacterToken);break}case TokenType.NULL_CHARACTER:{this.handler.onNullCharacter(this.currentCharacterToken);break}case TokenType.WHITESPACE_CHARACTER:{this.handler.onWhitespaceCharacter(this.currentCharacterToken);break}}this.currentCharacterToken=null}}_emitEOFToken(){const e=this.getCurrentLocation(0);e&&(e.endLine=e.startLine,e.endCol=e.startCol,e.endOffset=e.startOffset),this._emitCurrentCharacterToken(e),this.handler.onEof({type:TokenType.EOF,location:e}),this.active=!1}_appendCharToCurrentCharacterToken(e,s){if(this.currentCharacterToken)if(this.currentCharacterToken.type!==e)this.currentLocation=this.getCurrentLocation(0),this._emitCurrentCharacterToken(this.currentLocation),this.preprocessor.dropParsedChunk();else{this.currentCharacterToken.chars+=s;return}this._createCharacterToken(e,s)}_emitCodePoint(e){const s=isWhitespace$1(e)?TokenType.WHITESPACE_CHARACTER:e===CODE_POINTS.NULL?TokenType.NULL_CHARACTER:TokenType.CHARACTER;this._appendCharToCurrentCharacterToken(s,String.fromCodePoint(e))}_emitChars(e){this._appendCharToCurrentCharacterToken(TokenType.CHARACTER,e)}_matchNamedCharacterReference(e){let s=null,n=0,r=!1;for(let a=0,i=htmlDecodeTree[0];a>=0&&(a=determineBranch(htmlDecodeTree,i,a+1,e),!(a<0));e=this._consume()){n+=1,i=htmlDecodeTree[a];const u=i&BinTrieFlags.VALUE_LENGTH;if(u){const f=(u>>14)-1;if(e!==CODE_POINTS.SEMICOLON&&this._isCharacterReferenceInAttribute()&&isEntityInAttributeInvalidEnd(this.preprocessor.peek(1))?(s=[CODE_POINTS.AMPERSAND],a+=f):(s=f===0?[htmlDecodeTree[a]&~BinTrieFlags.VALUE_LENGTH]:f===1?[htmlDecodeTree[++a]]:[htmlDecodeTree[++a],htmlDecodeTree[++a]],n=0,r=e!==CODE_POINTS.SEMICOLON),f===0){this._consume();break}}}return this._unconsume(n),r&&!this.preprocessor.endOfChunkHit&&this._err(ERR.missingSemicolonAfterCharacterReference),this._unconsume(1),s}_isCharacterReferenceInAttribute(){return this.returnState===State$1.ATTRIBUTE_VALUE_DOUBLE_QUOTED||this.returnState===State$1.ATTRIBUTE_VALUE_SINGLE_QUOTED||this.returnState===State$1.ATTRIBUTE_VALUE_UNQUOTED}_flushCodePointConsumedAsCharacterReference(e){this._isCharacterReferenceInAttribute()?this.currentAttr.value+=String.fromCodePoint(e):this._emitCodePoint(e)}_callState(e){switch(this.state){case State$1.DATA:{this._stateData(e);break}case State$1.RCDATA:{this._stateRcdata(e);break}case State$1.RAWTEXT:{this._stateRawtext(e);break}case State$1.SCRIPT_DATA:{this._stateScriptData(e);break}case State$1.PLAINTEXT:{this._statePlaintext(e);break}case State$1.TAG_OPEN:{this._stateTagOpen(e);break}case State$1.END_TAG_OPEN:{this._stateEndTagOpen(e);break}case State$1.TAG_NAME:{this._stateTagName(e);break}case State$1.RCDATA_LESS_THAN_SIGN:{this._stateRcdataLessThanSign(e);break}case State$1.RCDATA_END_TAG_OPEN:{this._stateRcdataEndTagOpen(e);break}case State$1.RCDATA_END_TAG_NAME:{this._stateRcdataEndTagName(e);break}case State$1.RAWTEXT_LESS_THAN_SIGN:{this._stateRawtextLessThanSign(e);break}case State$1.RAWTEXT_END_TAG_OPEN:{this._stateRawtextEndTagOpen(e);break}case State$1.RAWTEXT_END_TAG_NAME:{this._stateRawtextEndTagName(e);break}case State$1.SCRIPT_DATA_LESS_THAN_SIGN:{this._stateScriptDataLessThanSign(e);break}case State$1.SCRIPT_DATA_END_TAG_OPEN:{this._stateScriptDataEndTagOpen(e);break}case State$1.SCRIPT_DATA_END_TAG_NAME:{this._stateScriptDataEndTagName(e);break}case State$1.SCRIPT_DATA_ESCAPE_START:{this._stateScriptDataEscapeStart(e);break}case State$1.SCRIPT_DATA_ESCAPE_START_DASH:{this._stateScriptDataEscapeStartDash(e);break}case State$1.SCRIPT_DATA_ESCAPED:{this._stateScriptDataEscaped(e);break}case State$1.SCRIPT_DATA_ESCAPED_DASH:{this._stateScriptDataEscapedDash(e);break}case State$1.SCRIPT_DATA_ESCAPED_DASH_DASH:{this._stateScriptDataEscapedDashDash(e);break}case State$1.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN:{this._stateScriptDataEscapedLessThanSign(e);break}case State$1.SCRIPT_DATA_ESCAPED_END_TAG_OPEN:{this._stateScriptDataEscapedEndTagOpen(e);break}case State$1.SCRIPT_DATA_ESCAPED_END_TAG_NAME:{this._stateScriptDataEscapedEndTagName(e);break}case State$1.SCRIPT_DATA_DOUBLE_ESCAPE_START:{this._stateScriptDataDoubleEscapeStart(e);break}case State$1.SCRIPT_DATA_DOUBLE_ESCAPED:{this._stateScriptDataDoubleEscaped(e);break}case State$1.SCRIPT_DATA_DOUBLE_ESCAPED_DASH:{this._stateScriptDataDoubleEscapedDash(e);break}case State$1.SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH:{this._stateScriptDataDoubleEscapedDashDash(e);break}case State$1.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN:{this._stateScriptDataDoubleEscapedLessThanSign(e);break}case State$1.SCRIPT_DATA_DOUBLE_ESCAPE_END:{this._stateScriptDataDoubleEscapeEnd(e);break}case State$1.BEFORE_ATTRIBUTE_NAME:{this._stateBeforeAttributeName(e);break}case State$1.ATTRIBUTE_NAME:{this._stateAttributeName(e);break}case State$1.AFTER_ATTRIBUTE_NAME:{this._stateAfterAttributeName(e);break}case State$1.BEFORE_ATTRIBUTE_VALUE:{this._stateBeforeAttributeValue(e);break}case State$1.ATTRIBUTE_VALUE_DOUBLE_QUOTED:{this._stateAttributeValueDoubleQuoted(e);break}case State$1.ATTRIBUTE_VALUE_SINGLE_QUOTED:{this._stateAttributeValueSingleQuoted(e);break}case State$1.ATTRIBUTE_VALUE_UNQUOTED:{this._stateAttributeValueUnquoted(e);break}case State$1.AFTER_ATTRIBUTE_VALUE_QUOTED:{this._stateAfterAttributeValueQuoted(e);break}case State$1.SELF_CLOSING_START_TAG:{this._stateSelfClosingStartTag(e);break}case State$1.BOGUS_COMMENT:{this._stateBogusComment(e);break}case State$1.MARKUP_DECLARATION_OPEN:{this._stateMarkupDeclarationOpen(e);break}case State$1.COMMENT_START:{this._stateCommentStart(e);break}case State$1.COMMENT_START_DASH:{this._stateCommentStartDash(e);break}case State$1.COMMENT:{this._stateComment(e);break}case State$1.COMMENT_LESS_THAN_SIGN:{this._stateCommentLessThanSign(e);break}case State$1.COMMENT_LESS_THAN_SIGN_BANG:{this._stateCommentLessThanSignBang(e);break}case State$1.COMMENT_LESS_THAN_SIGN_BANG_DASH:{this._stateCommentLessThanSignBangDash(e);break}case State$1.COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH:{this._stateCommentLessThanSignBangDashDash(e);break}case State$1.COMMENT_END_DASH:{this._stateCommentEndDash(e);break}case State$1.COMMENT_END:{this._stateCommentEnd(e);break}case State$1.COMMENT_END_BANG:{this._stateCommentEndBang(e);break}case State$1.DOCTYPE:{this._stateDoctype(e);break}case State$1.BEFORE_DOCTYPE_NAME:{this._stateBeforeDoctypeName(e);break}case State$1.DOCTYPE_NAME:{this._stateDoctypeName(e);break}case State$1.AFTER_DOCTYPE_NAME:{this._stateAfterDoctypeName(e);break}case State$1.AFTER_DOCTYPE_PUBLIC_KEYWORD:{this._stateAfterDoctypePublicKeyword(e);break}case State$1.BEFORE_DOCTYPE_PUBLIC_IDENTIFIER:{this._stateBeforeDoctypePublicIdentifier(e);break}case State$1.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED:{this._stateDoctypePublicIdentifierDoubleQuoted(e);break}case State$1.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED:{this._stateDoctypePublicIdentifierSingleQuoted(e);break}case State$1.AFTER_DOCTYPE_PUBLIC_IDENTIFIER:{this._stateAfterDoctypePublicIdentifier(e);break}case State$1.BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS:{this._stateBetweenDoctypePublicAndSystemIdentifiers(e);break}case State$1.AFTER_DOCTYPE_SYSTEM_KEYWORD:{this._stateAfterDoctypeSystemKeyword(e);break}case State$1.BEFORE_DOCTYPE_SYSTEM_IDENTIFIER:{this._stateBeforeDoctypeSystemIdentifier(e);break}case State$1.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED:{this._stateDoctypeSystemIdentifierDoubleQuoted(e);break}case State$1.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED:{this._stateDoctypeSystemIdentifierSingleQuoted(e);break}case State$1.AFTER_DOCTYPE_SYSTEM_IDENTIFIER:{this._stateAfterDoctypeSystemIdentifier(e);break}case State$1.BOGUS_DOCTYPE:{this._stateBogusDoctype(e);break}case State$1.CDATA_SECTION:{this._stateCdataSection(e);break}case State$1.CDATA_SECTION_BRACKET:{this._stateCdataSectionBracket(e);break}case State$1.CDATA_SECTION_END:{this._stateCdataSectionEnd(e);break}case State$1.CHARACTER_REFERENCE:{this._stateCharacterReference(e);break}case State$1.NAMED_CHARACTER_REFERENCE:{this._stateNamedCharacterReference(e);break}case State$1.AMBIGUOUS_AMPERSAND:{this._stateAmbiguousAmpersand(e);break}case State$1.NUMERIC_CHARACTER_REFERENCE:{this._stateNumericCharacterReference(e);break}case State$1.HEXADEMICAL_CHARACTER_REFERENCE_START:{this._stateHexademicalCharacterReferenceStart(e);break}case State$1.HEXADEMICAL_CHARACTER_REFERENCE:{this._stateHexademicalCharacterReference(e);break}case State$1.DECIMAL_CHARACTER_REFERENCE:{this._stateDecimalCharacterReference(e);break}case State$1.NUMERIC_CHARACTER_REFERENCE_END:{this._stateNumericCharacterReferenceEnd(e);break}default:throw new Error("Unknown state")}}_stateData(e){switch(e){case CODE_POINTS.LESS_THAN_SIGN:{this.state=State$1.TAG_OPEN;break}case CODE_POINTS.AMPERSAND:{this.returnState=State$1.DATA,this.state=State$1.CHARACTER_REFERENCE;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this._emitCodePoint(e);break}case CODE_POINTS.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateRcdata(e){switch(e){case CODE_POINTS.AMPERSAND:{this.returnState=State$1.RCDATA,this.state=State$1.CHARACTER_REFERENCE;break}case CODE_POINTS.LESS_THAN_SIGN:{this.state=State$1.RCDATA_LESS_THAN_SIGN;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this._emitChars(REPLACEMENT_CHARACTER);break}case CODE_POINTS.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateRawtext(e){switch(e){case CODE_POINTS.LESS_THAN_SIGN:{this.state=State$1.RAWTEXT_LESS_THAN_SIGN;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this._emitChars(REPLACEMENT_CHARACTER);break}case CODE_POINTS.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateScriptData(e){switch(e){case CODE_POINTS.LESS_THAN_SIGN:{this.state=State$1.SCRIPT_DATA_LESS_THAN_SIGN;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this._emitChars(REPLACEMENT_CHARACTER);break}case CODE_POINTS.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_statePlaintext(e){switch(e){case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this._emitChars(REPLACEMENT_CHARACTER);break}case CODE_POINTS.EOF:{this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateTagOpen(e){if(isAsciiLetter(e))this._createStartTagToken(),this.state=State$1.TAG_NAME,this._stateTagName(e);else switch(e){case CODE_POINTS.EXCLAMATION_MARK:{this.state=State$1.MARKUP_DECLARATION_OPEN;break}case CODE_POINTS.SOLIDUS:{this.state=State$1.END_TAG_OPEN;break}case CODE_POINTS.QUESTION_MARK:{this._err(ERR.unexpectedQuestionMarkInsteadOfTagName),this._createCommentToken(1),this.state=State$1.BOGUS_COMMENT,this._stateBogusComment(e);break}case CODE_POINTS.EOF:{this._err(ERR.eofBeforeTagName),this._emitChars("<"),this._emitEOFToken();break}default:this._err(ERR.invalidFirstCharacterOfTagName),this._emitChars("<"),this.state=State$1.DATA,this._stateData(e)}}_stateEndTagOpen(e){if(isAsciiLetter(e))this._createEndTagToken(),this.state=State$1.TAG_NAME,this._stateTagName(e);else switch(e){case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.missingEndTagName),this.state=State$1.DATA;break}case CODE_POINTS.EOF:{this._err(ERR.eofBeforeTagName),this._emitChars("</"),this._emitEOFToken();break}default:this._err(ERR.invalidFirstCharacterOfTagName),this._createCommentToken(2),this.state=State$1.BOGUS_COMMENT,this._stateBogusComment(e)}}_stateTagName(e){const s=this.currentToken;switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:{this.state=State$1.BEFORE_ATTRIBUTE_NAME;break}case CODE_POINTS.SOLIDUS:{this.state=State$1.SELF_CLOSING_START_TAG;break}case CODE_POINTS.GREATER_THAN_SIGN:{this.state=State$1.DATA,this.emitCurrentTagToken();break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),s.tagName+=REPLACEMENT_CHARACTER;break}case CODE_POINTS.EOF:{this._err(ERR.eofInTag),this._emitEOFToken();break}default:s.tagName+=String.fromCodePoint(isAsciiUpper(e)?toAsciiLower(e):e)}}_stateRcdataLessThanSign(e){e===CODE_POINTS.SOLIDUS?this.state=State$1.RCDATA_END_TAG_OPEN:(this._emitChars("<"),this.state=State$1.RCDATA,this._stateRcdata(e))}_stateRcdataEndTagOpen(e){isAsciiLetter(e)?(this.state=State$1.RCDATA_END_TAG_NAME,this._stateRcdataEndTagName(e)):(this._emitChars("</"),this.state=State$1.RCDATA,this._stateRcdata(e))}handleSpecialEndTag(e){if(!this.preprocessor.startsWith(this.lastStartTagName,!1))return!this._ensureHibernation();this._createEndTagToken();const s=this.currentToken;switch(s.tagName=this.lastStartTagName,this.preprocessor.peek(this.lastStartTagName.length)){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:return this._advanceBy(this.lastStartTagName.length),this.state=State$1.BEFORE_ATTRIBUTE_NAME,!1;case CODE_POINTS.SOLIDUS:return this._advanceBy(this.lastStartTagName.length),this.state=State$1.SELF_CLOSING_START_TAG,!1;case CODE_POINTS.GREATER_THAN_SIGN:return this._advanceBy(this.lastStartTagName.length),this.emitCurrentTagToken(),this.state=State$1.DATA,!1;default:return!this._ensureHibernation()}}_stateRcdataEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=State$1.RCDATA,this._stateRcdata(e))}_stateRawtextLessThanSign(e){e===CODE_POINTS.SOLIDUS?this.state=State$1.RAWTEXT_END_TAG_OPEN:(this._emitChars("<"),this.state=State$1.RAWTEXT,this._stateRawtext(e))}_stateRawtextEndTagOpen(e){isAsciiLetter(e)?(this.state=State$1.RAWTEXT_END_TAG_NAME,this._stateRawtextEndTagName(e)):(this._emitChars("</"),this.state=State$1.RAWTEXT,this._stateRawtext(e))}_stateRawtextEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=State$1.RAWTEXT,this._stateRawtext(e))}_stateScriptDataLessThanSign(e){switch(e){case CODE_POINTS.SOLIDUS:{this.state=State$1.SCRIPT_DATA_END_TAG_OPEN;break}case CODE_POINTS.EXCLAMATION_MARK:{this.state=State$1.SCRIPT_DATA_ESCAPE_START,this._emitChars("<!");break}default:this._emitChars("<"),this.state=State$1.SCRIPT_DATA,this._stateScriptData(e)}}_stateScriptDataEndTagOpen(e){isAsciiLetter(e)?(this.state=State$1.SCRIPT_DATA_END_TAG_NAME,this._stateScriptDataEndTagName(e)):(this._emitChars("</"),this.state=State$1.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=State$1.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEscapeStart(e){e===CODE_POINTS.HYPHEN_MINUS?(this.state=State$1.SCRIPT_DATA_ESCAPE_START_DASH,this._emitChars("-")):(this.state=State$1.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEscapeStartDash(e){e===CODE_POINTS.HYPHEN_MINUS?(this.state=State$1.SCRIPT_DATA_ESCAPED_DASH_DASH,this._emitChars("-")):(this.state=State$1.SCRIPT_DATA,this._stateScriptData(e))}_stateScriptDataEscaped(e){switch(e){case CODE_POINTS.HYPHEN_MINUS:{this.state=State$1.SCRIPT_DATA_ESCAPED_DASH,this._emitChars("-");break}case CODE_POINTS.LESS_THAN_SIGN:{this.state=State$1.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this._emitChars(REPLACEMENT_CHARACTER);break}case CODE_POINTS.EOF:{this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateScriptDataEscapedDash(e){switch(e){case CODE_POINTS.HYPHEN_MINUS:{this.state=State$1.SCRIPT_DATA_ESCAPED_DASH_DASH,this._emitChars("-");break}case CODE_POINTS.LESS_THAN_SIGN:{this.state=State$1.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this.state=State$1.SCRIPT_DATA_ESCAPED,this._emitChars(REPLACEMENT_CHARACTER);break}case CODE_POINTS.EOF:{this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=State$1.SCRIPT_DATA_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataEscapedDashDash(e){switch(e){case CODE_POINTS.HYPHEN_MINUS:{this._emitChars("-");break}case CODE_POINTS.LESS_THAN_SIGN:{this.state=State$1.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN;break}case CODE_POINTS.GREATER_THAN_SIGN:{this.state=State$1.SCRIPT_DATA,this._emitChars(">");break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this.state=State$1.SCRIPT_DATA_ESCAPED,this._emitChars(REPLACEMENT_CHARACTER);break}case CODE_POINTS.EOF:{this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=State$1.SCRIPT_DATA_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataEscapedLessThanSign(e){e===CODE_POINTS.SOLIDUS?this.state=State$1.SCRIPT_DATA_ESCAPED_END_TAG_OPEN:isAsciiLetter(e)?(this._emitChars("<"),this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPE_START,this._stateScriptDataDoubleEscapeStart(e)):(this._emitChars("<"),this.state=State$1.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataEscapedEndTagOpen(e){isAsciiLetter(e)?(this.state=State$1.SCRIPT_DATA_ESCAPED_END_TAG_NAME,this._stateScriptDataEscapedEndTagName(e)):(this._emitChars("</"),this.state=State$1.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataEscapedEndTagName(e){this.handleSpecialEndTag(e)&&(this._emitChars("</"),this.state=State$1.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataDoubleEscapeStart(e){if(this.preprocessor.startsWith(SEQUENCES.SCRIPT,!1)&&isScriptDataDoubleEscapeSequenceEnd(this.preprocessor.peek(SEQUENCES.SCRIPT.length))){this._emitCodePoint(e);for(let s=0;s<SEQUENCES.SCRIPT.length;s++)this._emitCodePoint(this._consume());this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED}else this._ensureHibernation()||(this.state=State$1.SCRIPT_DATA_ESCAPED,this._stateScriptDataEscaped(e))}_stateScriptDataDoubleEscaped(e){switch(e){case CODE_POINTS.HYPHEN_MINUS:{this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED_DASH,this._emitChars("-");break}case CODE_POINTS.LESS_THAN_SIGN:{this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN,this._emitChars("<");break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this._emitChars(REPLACEMENT_CHARACTER);break}case CODE_POINTS.EOF:{this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateScriptDataDoubleEscapedDash(e){switch(e){case CODE_POINTS.HYPHEN_MINUS:{this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH,this._emitChars("-");break}case CODE_POINTS.LESS_THAN_SIGN:{this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN,this._emitChars("<");break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitChars(REPLACEMENT_CHARACTER);break}case CODE_POINTS.EOF:{this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataDoubleEscapedDashDash(e){switch(e){case CODE_POINTS.HYPHEN_MINUS:{this._emitChars("-");break}case CODE_POINTS.LESS_THAN_SIGN:{this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN,this._emitChars("<");break}case CODE_POINTS.GREATER_THAN_SIGN:{this.state=State$1.SCRIPT_DATA,this._emitChars(">");break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitChars(REPLACEMENT_CHARACTER);break}case CODE_POINTS.EOF:{this._err(ERR.eofInScriptHtmlCommentLikeText),this._emitEOFToken();break}default:this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED,this._emitCodePoint(e)}}_stateScriptDataDoubleEscapedLessThanSign(e){e===CODE_POINTS.SOLIDUS?(this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPE_END,this._emitChars("/")):(this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED,this._stateScriptDataDoubleEscaped(e))}_stateScriptDataDoubleEscapeEnd(e){if(this.preprocessor.startsWith(SEQUENCES.SCRIPT,!1)&&isScriptDataDoubleEscapeSequenceEnd(this.preprocessor.peek(SEQUENCES.SCRIPT.length))){this._emitCodePoint(e);for(let s=0;s<SEQUENCES.SCRIPT.length;s++)this._emitCodePoint(this._consume());this.state=State$1.SCRIPT_DATA_ESCAPED}else this._ensureHibernation()||(this.state=State$1.SCRIPT_DATA_DOUBLE_ESCAPED,this._stateScriptDataDoubleEscaped(e))}_stateBeforeAttributeName(e){switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:break;case CODE_POINTS.SOLIDUS:case CODE_POINTS.GREATER_THAN_SIGN:case CODE_POINTS.EOF:{this.state=State$1.AFTER_ATTRIBUTE_NAME,this._stateAfterAttributeName(e);break}case CODE_POINTS.EQUALS_SIGN:{this._err(ERR.unexpectedEqualsSignBeforeAttributeName),this._createAttr("="),this.state=State$1.ATTRIBUTE_NAME;break}default:this._createAttr(""),this.state=State$1.ATTRIBUTE_NAME,this._stateAttributeName(e)}}_stateAttributeName(e){switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:case CODE_POINTS.SOLIDUS:case CODE_POINTS.GREATER_THAN_SIGN:case CODE_POINTS.EOF:{this._leaveAttrName(),this.state=State$1.AFTER_ATTRIBUTE_NAME,this._stateAfterAttributeName(e);break}case CODE_POINTS.EQUALS_SIGN:{this._leaveAttrName(),this.state=State$1.BEFORE_ATTRIBUTE_VALUE;break}case CODE_POINTS.QUOTATION_MARK:case CODE_POINTS.APOSTROPHE:case CODE_POINTS.LESS_THAN_SIGN:{this._err(ERR.unexpectedCharacterInAttributeName),this.currentAttr.name+=String.fromCodePoint(e);break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this.currentAttr.name+=REPLACEMENT_CHARACTER;break}default:this.currentAttr.name+=String.fromCodePoint(isAsciiUpper(e)?toAsciiLower(e):e)}}_stateAfterAttributeName(e){switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:break;case CODE_POINTS.SOLIDUS:{this.state=State$1.SELF_CLOSING_START_TAG;break}case CODE_POINTS.EQUALS_SIGN:{this.state=State$1.BEFORE_ATTRIBUTE_VALUE;break}case CODE_POINTS.GREATER_THAN_SIGN:{this.state=State$1.DATA,this.emitCurrentTagToken();break}case CODE_POINTS.EOF:{this._err(ERR.eofInTag),this._emitEOFToken();break}default:this._createAttr(""),this.state=State$1.ATTRIBUTE_NAME,this._stateAttributeName(e)}}_stateBeforeAttributeValue(e){switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:break;case CODE_POINTS.QUOTATION_MARK:{this.state=State$1.ATTRIBUTE_VALUE_DOUBLE_QUOTED;break}case CODE_POINTS.APOSTROPHE:{this.state=State$1.ATTRIBUTE_VALUE_SINGLE_QUOTED;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.missingAttributeValue),this.state=State$1.DATA,this.emitCurrentTagToken();break}default:this.state=State$1.ATTRIBUTE_VALUE_UNQUOTED,this._stateAttributeValueUnquoted(e)}}_stateAttributeValueDoubleQuoted(e){switch(e){case CODE_POINTS.QUOTATION_MARK:{this.state=State$1.AFTER_ATTRIBUTE_VALUE_QUOTED;break}case CODE_POINTS.AMPERSAND:{this.returnState=State$1.ATTRIBUTE_VALUE_DOUBLE_QUOTED,this.state=State$1.CHARACTER_REFERENCE;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this.currentAttr.value+=REPLACEMENT_CHARACTER;break}case CODE_POINTS.EOF:{this._err(ERR.eofInTag),this._emitEOFToken();break}default:this.currentAttr.value+=String.fromCodePoint(e)}}_stateAttributeValueSingleQuoted(e){switch(e){case CODE_POINTS.APOSTROPHE:{this.state=State$1.AFTER_ATTRIBUTE_VALUE_QUOTED;break}case CODE_POINTS.AMPERSAND:{this.returnState=State$1.ATTRIBUTE_VALUE_SINGLE_QUOTED,this.state=State$1.CHARACTER_REFERENCE;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this.currentAttr.value+=REPLACEMENT_CHARACTER;break}case CODE_POINTS.EOF:{this._err(ERR.eofInTag),this._emitEOFToken();break}default:this.currentAttr.value+=String.fromCodePoint(e)}}_stateAttributeValueUnquoted(e){switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:{this._leaveAttrValue(),this.state=State$1.BEFORE_ATTRIBUTE_NAME;break}case CODE_POINTS.AMPERSAND:{this.returnState=State$1.ATTRIBUTE_VALUE_UNQUOTED,this.state=State$1.CHARACTER_REFERENCE;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._leaveAttrValue(),this.state=State$1.DATA,this.emitCurrentTagToken();break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this.currentAttr.value+=REPLACEMENT_CHARACTER;break}case CODE_POINTS.QUOTATION_MARK:case CODE_POINTS.APOSTROPHE:case CODE_POINTS.LESS_THAN_SIGN:case CODE_POINTS.EQUALS_SIGN:case CODE_POINTS.GRAVE_ACCENT:{this._err(ERR.unexpectedCharacterInUnquotedAttributeValue),this.currentAttr.value+=String.fromCodePoint(e);break}case CODE_POINTS.EOF:{this._err(ERR.eofInTag),this._emitEOFToken();break}default:this.currentAttr.value+=String.fromCodePoint(e)}}_stateAfterAttributeValueQuoted(e){switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:{this._leaveAttrValue(),this.state=State$1.BEFORE_ATTRIBUTE_NAME;break}case CODE_POINTS.SOLIDUS:{this._leaveAttrValue(),this.state=State$1.SELF_CLOSING_START_TAG;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._leaveAttrValue(),this.state=State$1.DATA,this.emitCurrentTagToken();break}case CODE_POINTS.EOF:{this._err(ERR.eofInTag),this._emitEOFToken();break}default:this._err(ERR.missingWhitespaceBetweenAttributes),this.state=State$1.BEFORE_ATTRIBUTE_NAME,this._stateBeforeAttributeName(e)}}_stateSelfClosingStartTag(e){switch(e){case CODE_POINTS.GREATER_THAN_SIGN:{const s=this.currentToken;s.selfClosing=!0,this.state=State$1.DATA,this.emitCurrentTagToken();break}case CODE_POINTS.EOF:{this._err(ERR.eofInTag),this._emitEOFToken();break}default:this._err(ERR.unexpectedSolidusInTag),this.state=State$1.BEFORE_ATTRIBUTE_NAME,this._stateBeforeAttributeName(e)}}_stateBogusComment(e){const s=this.currentToken;switch(e){case CODE_POINTS.GREATER_THAN_SIGN:{this.state=State$1.DATA,this.emitCurrentComment(s);break}case CODE_POINTS.EOF:{this.emitCurrentComment(s),this._emitEOFToken();break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),s.data+=REPLACEMENT_CHARACTER;break}default:s.data+=String.fromCodePoint(e)}}_stateMarkupDeclarationOpen(e){this._consumeSequenceIfMatch(SEQUENCES.DASH_DASH,!0)?(this._createCommentToken(SEQUENCES.DASH_DASH.length+1),this.state=State$1.COMMENT_START):this._consumeSequenceIfMatch(SEQUENCES.DOCTYPE,!1)?(this.currentLocation=this.getCurrentLocation(SEQUENCES.DOCTYPE.length+1),this.state=State$1.DOCTYPE):this._consumeSequenceIfMatch(SEQUENCES.CDATA_START,!0)?this.inForeignNode?this.state=State$1.CDATA_SECTION:(this._err(ERR.cdataInHtmlContent),this._createCommentToken(SEQUENCES.CDATA_START.length+1),this.currentToken.data="[CDATA[",this.state=State$1.BOGUS_COMMENT):this._ensureHibernation()||(this._err(ERR.incorrectlyOpenedComment),this._createCommentToken(2),this.state=State$1.BOGUS_COMMENT,this._stateBogusComment(e))}_stateCommentStart(e){switch(e){case CODE_POINTS.HYPHEN_MINUS:{this.state=State$1.COMMENT_START_DASH;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.abruptClosingOfEmptyComment),this.state=State$1.DATA;const s=this.currentToken;this.emitCurrentComment(s);break}default:this.state=State$1.COMMENT,this._stateComment(e)}}_stateCommentStartDash(e){const s=this.currentToken;switch(e){case CODE_POINTS.HYPHEN_MINUS:{this.state=State$1.COMMENT_END;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.abruptClosingOfEmptyComment),this.state=State$1.DATA,this.emitCurrentComment(s);break}case CODE_POINTS.EOF:{this._err(ERR.eofInComment),this.emitCurrentComment(s),this._emitEOFToken();break}default:s.data+="-",this.state=State$1.COMMENT,this._stateComment(e)}}_stateComment(e){const s=this.currentToken;switch(e){case CODE_POINTS.HYPHEN_MINUS:{this.state=State$1.COMMENT_END_DASH;break}case CODE_POINTS.LESS_THAN_SIGN:{s.data+="<",this.state=State$1.COMMENT_LESS_THAN_SIGN;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),s.data+=REPLACEMENT_CHARACTER;break}case CODE_POINTS.EOF:{this._err(ERR.eofInComment),this.emitCurrentComment(s),this._emitEOFToken();break}default:s.data+=String.fromCodePoint(e)}}_stateCommentLessThanSign(e){const s=this.currentToken;switch(e){case CODE_POINTS.EXCLAMATION_MARK:{s.data+="!",this.state=State$1.COMMENT_LESS_THAN_SIGN_BANG;break}case CODE_POINTS.LESS_THAN_SIGN:{s.data+="<";break}default:this.state=State$1.COMMENT,this._stateComment(e)}}_stateCommentLessThanSignBang(e){e===CODE_POINTS.HYPHEN_MINUS?this.state=State$1.COMMENT_LESS_THAN_SIGN_BANG_DASH:(this.state=State$1.COMMENT,this._stateComment(e))}_stateCommentLessThanSignBangDash(e){e===CODE_POINTS.HYPHEN_MINUS?this.state=State$1.COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH:(this.state=State$1.COMMENT_END_DASH,this._stateCommentEndDash(e))}_stateCommentLessThanSignBangDashDash(e){e!==CODE_POINTS.GREATER_THAN_SIGN&&e!==CODE_POINTS.EOF&&this._err(ERR.nestedComment),this.state=State$1.COMMENT_END,this._stateCommentEnd(e)}_stateCommentEndDash(e){const s=this.currentToken;switch(e){case CODE_POINTS.HYPHEN_MINUS:{this.state=State$1.COMMENT_END;break}case CODE_POINTS.EOF:{this._err(ERR.eofInComment),this.emitCurrentComment(s),this._emitEOFToken();break}default:s.data+="-",this.state=State$1.COMMENT,this._stateComment(e)}}_stateCommentEnd(e){const s=this.currentToken;switch(e){case CODE_POINTS.GREATER_THAN_SIGN:{this.state=State$1.DATA,this.emitCurrentComment(s);break}case CODE_POINTS.EXCLAMATION_MARK:{this.state=State$1.COMMENT_END_BANG;break}case CODE_POINTS.HYPHEN_MINUS:{s.data+="-";break}case CODE_POINTS.EOF:{this._err(ERR.eofInComment),this.emitCurrentComment(s),this._emitEOFToken();break}default:s.data+="--",this.state=State$1.COMMENT,this._stateComment(e)}}_stateCommentEndBang(e){const s=this.currentToken;switch(e){case CODE_POINTS.HYPHEN_MINUS:{s.data+="--!",this.state=State$1.COMMENT_END_DASH;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.incorrectlyClosedComment),this.state=State$1.DATA,this.emitCurrentComment(s);break}case CODE_POINTS.EOF:{this._err(ERR.eofInComment),this.emitCurrentComment(s),this._emitEOFToken();break}default:s.data+="--!",this.state=State$1.COMMENT,this._stateComment(e)}}_stateDoctype(e){switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:{this.state=State$1.BEFORE_DOCTYPE_NAME;break}case CODE_POINTS.GREATER_THAN_SIGN:{this.state=State$1.BEFORE_DOCTYPE_NAME,this._stateBeforeDoctypeName(e);break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),this._createDoctypeToken(null);const s=this.currentToken;s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:this._err(ERR.missingWhitespaceBeforeDoctypeName),this.state=State$1.BEFORE_DOCTYPE_NAME,this._stateBeforeDoctypeName(e)}}_stateBeforeDoctypeName(e){if(isAsciiUpper(e))this._createDoctypeToken(String.fromCharCode(toAsciiLower(e))),this.state=State$1.DOCTYPE_NAME;else switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:break;case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),this._createDoctypeToken(REPLACEMENT_CHARACTER),this.state=State$1.DOCTYPE_NAME;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.missingDoctypeName),this._createDoctypeToken(null);const s=this.currentToken;s.forceQuirks=!0,this.emitCurrentDoctype(s),this.state=State$1.DATA;break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),this._createDoctypeToken(null);const s=this.currentToken;s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:this._createDoctypeToken(String.fromCodePoint(e)),this.state=State$1.DOCTYPE_NAME}}_stateDoctypeName(e){const s=this.currentToken;switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:{this.state=State$1.AFTER_DOCTYPE_NAME;break}case CODE_POINTS.GREATER_THAN_SIGN:{this.state=State$1.DATA,this.emitCurrentDoctype(s);break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),s.name+=REPLACEMENT_CHARACTER;break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:s.name+=String.fromCodePoint(isAsciiUpper(e)?toAsciiLower(e):e)}}_stateAfterDoctypeName(e){const s=this.currentToken;switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:break;case CODE_POINTS.GREATER_THAN_SIGN:{this.state=State$1.DATA,this.emitCurrentDoctype(s);break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:this._consumeSequenceIfMatch(SEQUENCES.PUBLIC,!1)?this.state=State$1.AFTER_DOCTYPE_PUBLIC_KEYWORD:this._consumeSequenceIfMatch(SEQUENCES.SYSTEM,!1)?this.state=State$1.AFTER_DOCTYPE_SYSTEM_KEYWORD:this._ensureHibernation()||(this._err(ERR.invalidCharacterSequenceAfterDoctypeName),s.forceQuirks=!0,this.state=State$1.BOGUS_DOCTYPE,this._stateBogusDoctype(e))}}_stateAfterDoctypePublicKeyword(e){const s=this.currentToken;switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:{this.state=State$1.BEFORE_DOCTYPE_PUBLIC_IDENTIFIER;break}case CODE_POINTS.QUOTATION_MARK:{this._err(ERR.missingWhitespaceAfterDoctypePublicKeyword),s.publicId="",this.state=State$1.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED;break}case CODE_POINTS.APOSTROPHE:{this._err(ERR.missingWhitespaceAfterDoctypePublicKeyword),s.publicId="",this.state=State$1.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.missingDoctypePublicIdentifier),s.forceQuirks=!0,this.state=State$1.DATA,this.emitCurrentDoctype(s);break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:this._err(ERR.missingQuoteBeforeDoctypePublicIdentifier),s.forceQuirks=!0,this.state=State$1.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBeforeDoctypePublicIdentifier(e){const s=this.currentToken;switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:break;case CODE_POINTS.QUOTATION_MARK:{s.publicId="",this.state=State$1.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED;break}case CODE_POINTS.APOSTROPHE:{s.publicId="",this.state=State$1.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.missingDoctypePublicIdentifier),s.forceQuirks=!0,this.state=State$1.DATA,this.emitCurrentDoctype(s);break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:this._err(ERR.missingQuoteBeforeDoctypePublicIdentifier),s.forceQuirks=!0,this.state=State$1.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateDoctypePublicIdentifierDoubleQuoted(e){const s=this.currentToken;switch(e){case CODE_POINTS.QUOTATION_MARK:{this.state=State$1.AFTER_DOCTYPE_PUBLIC_IDENTIFIER;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),s.publicId+=REPLACEMENT_CHARACTER;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.abruptDoctypePublicIdentifier),s.forceQuirks=!0,this.emitCurrentDoctype(s),this.state=State$1.DATA;break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:s.publicId+=String.fromCodePoint(e)}}_stateDoctypePublicIdentifierSingleQuoted(e){const s=this.currentToken;switch(e){case CODE_POINTS.APOSTROPHE:{this.state=State$1.AFTER_DOCTYPE_PUBLIC_IDENTIFIER;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),s.publicId+=REPLACEMENT_CHARACTER;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.abruptDoctypePublicIdentifier),s.forceQuirks=!0,this.emitCurrentDoctype(s),this.state=State$1.DATA;break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:s.publicId+=String.fromCodePoint(e)}}_stateAfterDoctypePublicIdentifier(e){const s=this.currentToken;switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:{this.state=State$1.BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS;break}case CODE_POINTS.GREATER_THAN_SIGN:{this.state=State$1.DATA,this.emitCurrentDoctype(s);break}case CODE_POINTS.QUOTATION_MARK:{this._err(ERR.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers),s.systemId="",this.state=State$1.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case CODE_POINTS.APOSTROPHE:{this._err(ERR.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers),s.systemId="",this.state=State$1.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:this._err(ERR.missingQuoteBeforeDoctypeSystemIdentifier),s.forceQuirks=!0,this.state=State$1.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBetweenDoctypePublicAndSystemIdentifiers(e){const s=this.currentToken;switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:break;case CODE_POINTS.GREATER_THAN_SIGN:{this.emitCurrentDoctype(s),this.state=State$1.DATA;break}case CODE_POINTS.QUOTATION_MARK:{s.systemId="",this.state=State$1.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case CODE_POINTS.APOSTROPHE:{s.systemId="",this.state=State$1.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:this._err(ERR.missingQuoteBeforeDoctypeSystemIdentifier),s.forceQuirks=!0,this.state=State$1.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateAfterDoctypeSystemKeyword(e){const s=this.currentToken;switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:{this.state=State$1.BEFORE_DOCTYPE_SYSTEM_IDENTIFIER;break}case CODE_POINTS.QUOTATION_MARK:{this._err(ERR.missingWhitespaceAfterDoctypeSystemKeyword),s.systemId="",this.state=State$1.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case CODE_POINTS.APOSTROPHE:{this._err(ERR.missingWhitespaceAfterDoctypeSystemKeyword),s.systemId="",this.state=State$1.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.missingDoctypeSystemIdentifier),s.forceQuirks=!0,this.state=State$1.DATA,this.emitCurrentDoctype(s);break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:this._err(ERR.missingQuoteBeforeDoctypeSystemIdentifier),s.forceQuirks=!0,this.state=State$1.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBeforeDoctypeSystemIdentifier(e){const s=this.currentToken;switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:break;case CODE_POINTS.QUOTATION_MARK:{s.systemId="",this.state=State$1.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED;break}case CODE_POINTS.APOSTROPHE:{s.systemId="",this.state=State$1.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.missingDoctypeSystemIdentifier),s.forceQuirks=!0,this.state=State$1.DATA,this.emitCurrentDoctype(s);break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:this._err(ERR.missingQuoteBeforeDoctypeSystemIdentifier),s.forceQuirks=!0,this.state=State$1.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateDoctypeSystemIdentifierDoubleQuoted(e){const s=this.currentToken;switch(e){case CODE_POINTS.QUOTATION_MARK:{this.state=State$1.AFTER_DOCTYPE_SYSTEM_IDENTIFIER;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),s.systemId+=REPLACEMENT_CHARACTER;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.abruptDoctypeSystemIdentifier),s.forceQuirks=!0,this.emitCurrentDoctype(s),this.state=State$1.DATA;break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:s.systemId+=String.fromCodePoint(e)}}_stateDoctypeSystemIdentifierSingleQuoted(e){const s=this.currentToken;switch(e){case CODE_POINTS.APOSTROPHE:{this.state=State$1.AFTER_DOCTYPE_SYSTEM_IDENTIFIER;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter),s.systemId+=REPLACEMENT_CHARACTER;break}case CODE_POINTS.GREATER_THAN_SIGN:{this._err(ERR.abruptDoctypeSystemIdentifier),s.forceQuirks=!0,this.emitCurrentDoctype(s),this.state=State$1.DATA;break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:s.systemId+=String.fromCodePoint(e)}}_stateAfterDoctypeSystemIdentifier(e){const s=this.currentToken;switch(e){case CODE_POINTS.SPACE:case CODE_POINTS.LINE_FEED:case CODE_POINTS.TABULATION:case CODE_POINTS.FORM_FEED:break;case CODE_POINTS.GREATER_THAN_SIGN:{this.emitCurrentDoctype(s),this.state=State$1.DATA;break}case CODE_POINTS.EOF:{this._err(ERR.eofInDoctype),s.forceQuirks=!0,this.emitCurrentDoctype(s),this._emitEOFToken();break}default:this._err(ERR.unexpectedCharacterAfterDoctypeSystemIdentifier),this.state=State$1.BOGUS_DOCTYPE,this._stateBogusDoctype(e)}}_stateBogusDoctype(e){const s=this.currentToken;switch(e){case CODE_POINTS.GREATER_THAN_SIGN:{this.emitCurrentDoctype(s),this.state=State$1.DATA;break}case CODE_POINTS.NULL:{this._err(ERR.unexpectedNullCharacter);break}case CODE_POINTS.EOF:{this.emitCurrentDoctype(s),this._emitEOFToken();break}}}_stateCdataSection(e){switch(e){case CODE_POINTS.RIGHT_SQUARE_BRACKET:{this.state=State$1.CDATA_SECTION_BRACKET;break}case CODE_POINTS.EOF:{this._err(ERR.eofInCdata),this._emitEOFToken();break}default:this._emitCodePoint(e)}}_stateCdataSectionBracket(e){e===CODE_POINTS.RIGHT_SQUARE_BRACKET?this.state=State$1.CDATA_SECTION_END:(this._emitChars("]"),this.state=State$1.CDATA_SECTION,this._stateCdataSection(e))}_stateCdataSectionEnd(e){switch(e){case CODE_POINTS.GREATER_THAN_SIGN:{this.state=State$1.DATA;break}case CODE_POINTS.RIGHT_SQUARE_BRACKET:{this._emitChars("]");break}default:this._emitChars("]]"),this.state=State$1.CDATA_SECTION,this._stateCdataSection(e)}}_stateCharacterReference(e){e===CODE_POINTS.NUMBER_SIGN?this.state=State$1.NUMERIC_CHARACTER_REFERENCE:isAsciiAlphaNumeric(e)?(this.state=State$1.NAMED_CHARACTER_REFERENCE,this._stateNamedCharacterReference(e)):(this._flushCodePointConsumedAsCharacterReference(CODE_POINTS.AMPERSAND),this._reconsumeInState(this.returnState,e))}_stateNamedCharacterReference(e){const s=this._matchNamedCharacterReference(e);if(!this._ensureHibernation())if(s){for(let n=0;n<s.length;n++)this._flushCodePointConsumedAsCharacterReference(s[n]);this.state=this.returnState}else this._flushCodePointConsumedAsCharacterReference(CODE_POINTS.AMPERSAND),this.state=State$1.AMBIGUOUS_AMPERSAND}_stateAmbiguousAmpersand(e){isAsciiAlphaNumeric(e)?this._flushCodePointConsumedAsCharacterReference(e):(e===CODE_POINTS.SEMICOLON&&this._err(ERR.unknownNamedCharacterReference),this._reconsumeInState(this.returnState,e))}_stateNumericCharacterReference(e){this.charRefCode=0,e===CODE_POINTS.LATIN_SMALL_X||e===CODE_POINTS.LATIN_CAPITAL_X?this.state=State$1.HEXADEMICAL_CHARACTER_REFERENCE_START:isAsciiDigit(e)?(this.state=State$1.DECIMAL_CHARACTER_REFERENCE,this._stateDecimalCharacterReference(e)):(this._err(ERR.absenceOfDigitsInNumericCharacterReference),this._flushCodePointConsumedAsCharacterReference(CODE_POINTS.AMPERSAND),this._flushCodePointConsumedAsCharacterReference(CODE_POINTS.NUMBER_SIGN),this._reconsumeInState(this.returnState,e))}_stateHexademicalCharacterReferenceStart(e){isAsciiHexDigit(e)?(this.state=State$1.HEXADEMICAL_CHARACTER_REFERENCE,this._stateHexademicalCharacterReference(e)):(this._err(ERR.absenceOfDigitsInNumericCharacterReference),this._flushCodePointConsumedAsCharacterReference(CODE_POINTS.AMPERSAND),this._flushCodePointConsumedAsCharacterReference(CODE_POINTS.NUMBER_SIGN),this._unconsume(2),this.state=this.returnState)}_stateHexademicalCharacterReference(e){isAsciiUpperHexDigit(e)?this.charRefCode=this.charRefCode*16+e-55:isAsciiLowerHexDigit(e)?this.charRefCode=this.charRefCode*16+e-87:isAsciiDigit(e)?this.charRefCode=this.charRefCode*16+e-48:e===CODE_POINTS.SEMICOLON?this.state=State$1.NUMERIC_CHARACTER_REFERENCE_END:(this._err(ERR.missingSemicolonAfterCharacterReference),this.state=State$1.NUMERIC_CHARACTER_REFERENCE_END,this._stateNumericCharacterReferenceEnd(e))}_stateDecimalCharacterReference(e){isAsciiDigit(e)?this.charRefCode=this.charRefCode*10+e-48:e===CODE_POINTS.SEMICOLON?this.state=State$1.NUMERIC_CHARACTER_REFERENCE_END:(this._err(ERR.missingSemicolonAfterCharacterReference),this.state=State$1.NUMERIC_CHARACTER_REFERENCE_END,this._stateNumericCharacterReferenceEnd(e))}_stateNumericCharacterReferenceEnd(e){if(this.charRefCode===CODE_POINTS.NULL)this._err(ERR.nullCharacterReference),this.charRefCode=CODE_POINTS.REPLACEMENT_CHARACTER;else if(this.charRefCode>1114111)this._err(ERR.characterReferenceOutsideUnicodeRange),this.charRefCode=CODE_POINTS.REPLACEMENT_CHARACTER;else if(isSurrogate(this.charRefCode))this._err(ERR.surrogateCharacterReference),this.charRefCode=CODE_POINTS.REPLACEMENT_CHARACTER;else if(isUndefinedCodePoint(this.charRefCode))this._err(ERR.noncharacterCharacterReference);else if(isControlCodePoint(this.charRefCode)||this.charRefCode===CODE_POINTS.CARRIAGE_RETURN){this._err(ERR.controlCharacterReference);const s=C1_CONTROLS_REFERENCE_REPLACEMENTS.get(this.charRefCode);s!==void 0&&(this.charRefCode=s)}this._flushCodePointConsumedAsCharacterReference(this.charRefCode),this._reconsumeInState(this.returnState,e)}};const IMPLICIT_END_TAG_REQUIRED=new Set([TAG_ID.DD,TAG_ID.DT,TAG_ID.LI,TAG_ID.OPTGROUP,TAG_ID.OPTION,TAG_ID.P,TAG_ID.RB,TAG_ID.RP,TAG_ID.RT,TAG_ID.RTC]),IMPLICIT_END_TAG_REQUIRED_THOROUGHLY=new Set([...IMPLICIT_END_TAG_REQUIRED,TAG_ID.CAPTION,TAG_ID.COLGROUP,TAG_ID.TBODY,TAG_ID.TD,TAG_ID.TFOOT,TAG_ID.TH,TAG_ID.THEAD,TAG_ID.TR]),SCOPING_ELEMENT_NS=new Map([[TAG_ID.APPLET,NS.HTML],[TAG_ID.CAPTION,NS.HTML],[TAG_ID.HTML,NS.HTML],[TAG_ID.MARQUEE,NS.HTML],[TAG_ID.OBJECT,NS.HTML],[TAG_ID.TABLE,NS.HTML],[TAG_ID.TD,NS.HTML],[TAG_ID.TEMPLATE,NS.HTML],[TAG_ID.TH,NS.HTML],[TAG_ID.ANNOTATION_XML,NS.MATHML],[TAG_ID.MI,NS.MATHML],[TAG_ID.MN,NS.MATHML],[TAG_ID.MO,NS.MATHML],[TAG_ID.MS,NS.MATHML],[TAG_ID.MTEXT,NS.MATHML],[TAG_ID.DESC,NS.SVG],[TAG_ID.FOREIGN_OBJECT,NS.SVG],[TAG_ID.TITLE,NS.SVG]]),NAMED_HEADERS=[TAG_ID.H1,TAG_ID.H2,TAG_ID.H3,TAG_ID.H4,TAG_ID.H5,TAG_ID.H6],TABLE_ROW_CONTEXT=[TAG_ID.TR,TAG_ID.TEMPLATE,TAG_ID.HTML],TABLE_BODY_CONTEXT=[TAG_ID.TBODY,TAG_ID.TFOOT,TAG_ID.THEAD,TAG_ID.TEMPLATE,TAG_ID.HTML],TABLE_CONTEXT=[TAG_ID.TABLE,TAG_ID.TEMPLATE,TAG_ID.HTML],TABLE_CELLS=[TAG_ID.TD,TAG_ID.TH];class OpenElementStack{get currentTmplContentOrNode(){return this._isInTemplate()?this.treeAdapter.getTemplateContent(this.current):this.current}constructor(e,s,n){this.treeAdapter=s,this.handler=n,this.items=[],this.tagIDs=[],this.stackTop=-1,this.tmplCount=0,this.currentTagId=TAG_ID.UNKNOWN,this.current=e}_indexOf(e){return this.items.lastIndexOf(e,this.stackTop)}_isInTemplate(){return this.currentTagId===TAG_ID.TEMPLATE&&this.treeAdapter.getNamespaceURI(this.current)===NS.HTML}_updateCurrentElement(){this.current=this.items[this.stackTop],this.currentTagId=this.tagIDs[this.stackTop]}push(e,s){this.stackTop++,this.items[this.stackTop]=e,this.current=e,this.tagIDs[this.stackTop]=s,this.currentTagId=s,this._isInTemplate()&&this.tmplCount++,this.handler.onItemPush(e,s,!0)}pop(){const e=this.current;this.tmplCount>0&&this._isInTemplate()&&this.tmplCount--,this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(e,!0)}replace(e,s){const n=this._indexOf(e);this.items[n]=s,n===this.stackTop&&(this.current=s)}insertAfter(e,s,n){const r=this._indexOf(e)+1;this.items.splice(r,0,s),this.tagIDs.splice(r,0,n),this.stackTop++,r===this.stackTop&&this._updateCurrentElement(),this.handler.onItemPush(this.current,this.currentTagId,r===this.stackTop)}popUntilTagNamePopped(e){let s=this.stackTop+1;do s=this.tagIDs.lastIndexOf(e,s-1);while(s>0&&this.treeAdapter.getNamespaceURI(this.items[s])!==NS.HTML);this.shortenToLength(s<0?0:s)}shortenToLength(e){for(;this.stackTop>=e;){const s=this.current;this.tmplCount>0&&this._isInTemplate()&&(this.tmplCount-=1),this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(s,this.stackTop<e)}}popUntilElementPopped(e){const s=this._indexOf(e);this.shortenToLength(s<0?0:s)}popUntilPopped(e,s){const n=this._indexOfTagNames(e,s);this.shortenToLength(n<0?0:n)}popUntilNumberedHeaderPopped(){this.popUntilPopped(NAMED_HEADERS,NS.HTML)}popUntilTableCellPopped(){this.popUntilPopped(TABLE_CELLS,NS.HTML)}popAllUpToHtmlElement(){this.tmplCount=0,this.shortenToLength(1)}_indexOfTagNames(e,s){for(let n=this.stackTop;n>=0;n--)if(e.includes(this.tagIDs[n])&&this.treeAdapter.getNamespaceURI(this.items[n])===s)return n;return-1}clearBackTo(e,s){const n=this._indexOfTagNames(e,s);this.shortenToLength(n+1)}clearBackToTableContext(){this.clearBackTo(TABLE_CONTEXT,NS.HTML)}clearBackToTableBodyContext(){this.clearBackTo(TABLE_BODY_CONTEXT,NS.HTML)}clearBackToTableRowContext(){this.clearBackTo(TABLE_ROW_CONTEXT,NS.HTML)}remove(e){const s=this._indexOf(e);s>=0&&(s===this.stackTop?this.pop():(this.items.splice(s,1),this.tagIDs.splice(s,1),this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(e,!1)))}tryPeekProperlyNestedBodyElement(){return this.stackTop>=1&&this.tagIDs[1]===TAG_ID.BODY?this.items[1]:null}contains(e){return this._indexOf(e)>-1}getCommonAncestor(e){const s=this._indexOf(e)-1;return s>=0?this.items[s]:null}isRootHtmlElementCurrent(){return this.stackTop===0&&this.tagIDs[0]===TAG_ID.HTML}hasInScope(e){for(let s=this.stackTop;s>=0;s--){const n=this.tagIDs[s],r=this.treeAdapter.getNamespaceURI(this.items[s]);if(n===e&&r===NS.HTML)return!0;if(SCOPING_ELEMENT_NS.get(n)===r)return!1}return!0}hasNumberedHeaderInScope(){for(let e=this.stackTop;e>=0;e--){const s=this.tagIDs[e],n=this.treeAdapter.getNamespaceURI(this.items[e]);if(isNumberedHeader(s)&&n===NS.HTML)return!0;if(SCOPING_ELEMENT_NS.get(s)===n)return!1}return!0}hasInListItemScope(e){for(let s=this.stackTop;s>=0;s--){const n=this.tagIDs[s],r=this.treeAdapter.getNamespaceURI(this.items[s]);if(n===e&&r===NS.HTML)return!0;if((n===TAG_ID.UL||n===TAG_ID.OL)&&r===NS.HTML||SCOPING_ELEMENT_NS.get(n)===r)return!1}return!0}hasInButtonScope(e){for(let s=this.stackTop;s>=0;s--){const n=this.tagIDs[s],r=this.treeAdapter.getNamespaceURI(this.items[s]);if(n===e&&r===NS.HTML)return!0;if(n===TAG_ID.BUTTON&&r===NS.HTML||SCOPING_ELEMENT_NS.get(n)===r)return!1}return!0}hasInTableScope(e){for(let s=this.stackTop;s>=0;s--){const n=this.tagIDs[s];if(this.treeAdapter.getNamespaceURI(this.items[s])===NS.HTML){if(n===e)return!0;if(n===TAG_ID.TABLE||n===TAG_ID.TEMPLATE||n===TAG_ID.HTML)return!1}}return!0}hasTableBodyContextInTableScope(){for(let e=this.stackTop;e>=0;e--){const s=this.tagIDs[e];if(this.treeAdapter.getNamespaceURI(this.items[e])===NS.HTML){if(s===TAG_ID.TBODY||s===TAG_ID.THEAD||s===TAG_ID.TFOOT)return!0;if(s===TAG_ID.TABLE||s===TAG_ID.HTML)return!1}}return!0}hasInSelectScope(e){for(let s=this.stackTop;s>=0;s--){const n=this.tagIDs[s];if(this.treeAdapter.getNamespaceURI(this.items[s])===NS.HTML){if(n===e)return!0;if(n!==TAG_ID.OPTION&&n!==TAG_ID.OPTGROUP)return!1}}return!0}generateImpliedEndTags(){for(;IMPLICIT_END_TAG_REQUIRED.has(this.currentTagId);)this.pop()}generateImpliedEndTagsThoroughly(){for(;IMPLICIT_END_TAG_REQUIRED_THOROUGHLY.has(this.currentTagId);)this.pop()}generateImpliedEndTagsWithExclusion(e){for(;this.currentTagId!==e&&IMPLICIT_END_TAG_REQUIRED_THOROUGHLY.has(this.currentTagId);)this.pop()}}const NOAH_ARK_CAPACITY=3;var EntryType;(function(t){t[t.Marker=0]="Marker",t[t.Element=1]="Element"})(EntryType=EntryType||(EntryType={}));const MARKER={type:EntryType.Marker};class FormattingElementList{constructor(e){this.treeAdapter=e,this.entries=[],this.bookmark=null}_getNoahArkConditionCandidates(e,s){const n=[],r=s.length,a=this.treeAdapter.getTagName(e),i=this.treeAdapter.getNamespaceURI(e);for(let u=0;u<this.entries.length;u++){const f=this.entries[u];if(f.type===EntryType.Marker)break;const{element:c}=f;if(this.treeAdapter.getTagName(c)===a&&this.treeAdapter.getNamespaceURI(c)===i){const d=this.treeAdapter.getAttrList(c);d.length===r&&n.push({idx:u,attrs:d})}}return n}_ensureNoahArkCondition(e){if(this.entries.length<NOAH_ARK_CAPACITY)return;const s=this.treeAdapter.getAttrList(e),n=this._getNoahArkConditionCandidates(e,s);if(n.length<NOAH_ARK_CAPACITY)return;const r=new Map(s.map(i=>[i.name,i.value]));let a=0;for(let i=0;i<n.length;i++){const u=n[i];u.attrs.every(f=>r.get(f.name)===f.value)&&(a+=1,a>=NOAH_ARK_CAPACITY&&this.entries.splice(u.idx,1))}}insertMarker(){this.entries.unshift(MARKER)}pushElement(e,s){this._ensureNoahArkCondition(e),this.entries.unshift({type:EntryType.Element,element:e,token:s})}insertElementAfterBookmark(e,s){const n=this.entries.indexOf(this.bookmark);this.entries.splice(n,0,{type:EntryType.Element,element:e,token:s})}removeEntry(e){const s=this.entries.indexOf(e);s>=0&&this.entries.splice(s,1)}clearToLastMarker(){const e=this.entries.indexOf(MARKER);e>=0?this.entries.splice(0,e+1):this.entries.length=0}getElementEntryInScopeWithTagName(e){const s=this.entries.find(n=>n.type===EntryType.Marker||this.treeAdapter.getTagName(n.element)===e);return s&&s.type===EntryType.Element?s:null}getElementEntry(e){return this.entries.find(s=>s.type===EntryType.Element&&s.element===e)}}function createTextNode$1(t){return{nodeName:"#text",value:t,parentNode:null}}const defaultTreeAdapter={createDocument(){return{nodeName:"#document",mode:DOCUMENT_MODE.NO_QUIRKS,childNodes:[]}},createDocumentFragment(){return{nodeName:"#document-fragment",childNodes:[]}},createElement(t,e,s){return{nodeName:t,tagName:t,attrs:s,namespaceURI:e,childNodes:[],parentNode:null}},createCommentNode(t){return{nodeName:"#comment",data:t,parentNode:null}},appendChild(t,e){t.childNodes.push(e),e.parentNode=t},insertBefore(t,e,s){const n=t.childNodes.indexOf(s);t.childNodes.splice(n,0,e),e.parentNode=t},setTemplateContent(t,e){t.content=e},getTemplateContent(t){return t.content},setDocumentType(t,e,s,n){const r=t.childNodes.find(a=>a.nodeName==="#documentType");if(r)r.name=e,r.publicId=s,r.systemId=n;else{const a={nodeName:"#documentType",name:e,publicId:s,systemId:n,parentNode:null};defaultTreeAdapter.appendChild(t,a)}},setDocumentMode(t,e){t.mode=e},getDocumentMode(t){return t.mode},detachNode(t){if(t.parentNode){const e=t.parentNode.childNodes.indexOf(t);t.parentNode.childNodes.splice(e,1),t.parentNode=null}},insertText(t,e){if(t.childNodes.length>0){const s=t.childNodes[t.childNodes.length-1];if(defaultTreeAdapter.isTextNode(s)){s.value+=e;return}}defaultTreeAdapter.appendChild(t,createTextNode$1(e))},insertTextBefore(t,e,s){const n=t.childNodes[t.childNodes.indexOf(s)-1];n&&defaultTreeAdapter.isTextNode(n)?n.value+=e:defaultTreeAdapter.insertBefore(t,createTextNode$1(e),s)},adoptAttributes(t,e){const s=new Set(t.attrs.map(n=>n.name));for(let n=0;n<e.length;n++)s.has(e[n].name)||t.attrs.push(e[n])},getFirstChild(t){return t.childNodes[0]},getChildNodes(t){return t.childNodes},getParentNode(t){return t.parentNode},getAttrList(t){return t.attrs},getTagName(t){return t.tagName},getNamespaceURI(t){return t.namespaceURI},getTextNodeContent(t){return t.value},getCommentNodeContent(t){return t.data},getDocumentTypeNodeName(t){return t.name},getDocumentTypeNodePublicId(t){return t.publicId},getDocumentTypeNodeSystemId(t){return t.systemId},isTextNode(t){return t.nodeName==="#text"},isCommentNode(t){return t.nodeName==="#comment"},isDocumentTypeNode(t){return t.nodeName==="#documentType"},isElementNode(t){return Object.prototype.hasOwnProperty.call(t,"tagName")},setNodeSourceCodeLocation(t,e){t.sourceCodeLocation=e},getNodeSourceCodeLocation(t){return t.sourceCodeLocation},updateNodeSourceCodeLocation(t,e){t.sourceCodeLocation={...t.sourceCodeLocation,...e}}},VALID_DOCTYPE_NAME="html",VALID_SYSTEM_ID="about:legacy-compat",QUIRKS_MODE_SYSTEM_ID="http://www.ibm.com/data/dtd/v11/ibmxhtml1-transitional.dtd",QUIRKS_MODE_PUBLIC_ID_PREFIXES=["+//silmaril//dtd html pro v0r11 19970101//","-//as//dtd html 3.0 aswedit + extensions//","-//advasoft ltd//dtd html 3.0 aswedit + extensions//","-//ietf//dtd html 2.0 level 1//","-//ietf//dtd html 2.0 level 2//","-//ietf//dtd html 2.0 strict level 1//","-//ietf//dtd html 2.0 strict level 2//","-//ietf//dtd html 2.0 strict//","-//ietf//dtd html 2.0//","-//ietf//dtd html 2.1e//","-//ietf//dtd html 3.0//","-//ietf//dtd html 3.2 final//","-//ietf//dtd html 3.2//","-//ietf//dtd html 3//","-//ietf//dtd html level 0//","-//ietf//dtd html level 1//","-//ietf//dtd html level 2//","-//ietf//dtd html level 3//","-//ietf//dtd html strict level 0//","-//ietf//dtd html strict level 1//","-//ietf//dtd html strict level 2//","-//ietf//dtd html strict level 3//","-//ietf//dtd html strict//","-//ietf//dtd html//","-//metrius//dtd metrius presentational//","-//microsoft//dtd internet explorer 2.0 html strict//","-//microsoft//dtd internet explorer 2.0 html//","-//microsoft//dtd internet explorer 2.0 tables//","-//microsoft//dtd internet explorer 3.0 html strict//","-//microsoft//dtd internet explorer 3.0 html//","-//microsoft//dtd internet explorer 3.0 tables//","-//netscape comm. corp.//dtd html//","-//netscape comm. corp.//dtd strict html//","-//o'reilly and associates//dtd html 2.0//","-//o'reilly and associates//dtd html extended 1.0//","-//o'reilly and associates//dtd html extended relaxed 1.0//","-//sq//dtd html 2.0 hotmetal + extensions//","-//softquad software//dtd hotmetal pro 6.0::19990601::extensions to html 4.0//","-//softquad//dtd hotmetal pro 4.0::19971010::extensions to html 4.0//","-//spyglass//dtd html 2.0 extended//","-//sun microsystems corp.//dtd hotjava html//","-//sun microsystems corp.//dtd hotjava strict html//","-//w3c//dtd html 3 1995-03-24//","-//w3c//dtd html 3.2 draft//","-//w3c//dtd html 3.2 final//","-//w3c//dtd html 3.2//","-//w3c//dtd html 3.2s draft//","-//w3c//dtd html 4.0 frameset//","-//w3c//dtd html 4.0 transitional//","-//w3c//dtd html experimental 19960712//","-//w3c//dtd html experimental 970421//","-//w3c//dtd w3 html//","-//w3o//dtd w3 html 3.0//","-//webtechs//dtd mozilla html 2.0//","-//webtechs//dtd mozilla html//"],QUIRKS_MODE_NO_SYSTEM_ID_PUBLIC_ID_PREFIXES=[...QUIRKS_MODE_PUBLIC_ID_PREFIXES,"-//w3c//dtd html 4.01 frameset//","-//w3c//dtd html 4.01 transitional//"],QUIRKS_MODE_PUBLIC_IDS=new Set(["-//w3o//dtd w3 html strict 3.0//en//","-/w3c/dtd html 4.0 transitional/en","html"]),LIMITED_QUIRKS_PUBLIC_ID_PREFIXES=["-//w3c//dtd xhtml 1.0 frameset//","-//w3c//dtd xhtml 1.0 transitional//"],LIMITED_QUIRKS_WITH_SYSTEM_ID_PUBLIC_ID_PREFIXES=[...LIMITED_QUIRKS_PUBLIC_ID_PREFIXES,"-//w3c//dtd html 4.01 frameset//","-//w3c//dtd html 4.01 transitional//"];function hasPrefix(t,e){return e.some(s=>t.startsWith(s))}function isConforming(t){return t.name===VALID_DOCTYPE_NAME&&t.publicId===null&&(t.systemId===null||t.systemId===VALID_SYSTEM_ID)}function getDocumentMode(t){if(t.name!==VALID_DOCTYPE_NAME)return DOCUMENT_MODE.QUIRKS;const{systemId:e}=t;if(e&&e.toLowerCase()===QUIRKS_MODE_SYSTEM_ID)return DOCUMENT_MODE.QUIRKS;let{publicId:s}=t;if(s!==null){if(s=s.toLowerCase(),QUIRKS_MODE_PUBLIC_IDS.has(s))return DOCUMENT_MODE.QUIRKS;let n=e===null?QUIRKS_MODE_NO_SYSTEM_ID_PUBLIC_ID_PREFIXES:QUIRKS_MODE_PUBLIC_ID_PREFIXES;if(hasPrefix(s,n))return DOCUMENT_MODE.QUIRKS;if(n=e===null?LIMITED_QUIRKS_PUBLIC_ID_PREFIXES:LIMITED_QUIRKS_WITH_SYSTEM_ID_PUBLIC_ID_PREFIXES,hasPrefix(s,n))return DOCUMENT_MODE.LIMITED_QUIRKS}return DOCUMENT_MODE.NO_QUIRKS}const MIME_TYPES={TEXT_HTML:"text/html",APPLICATION_XML:"application/xhtml+xml"},DEFINITION_URL_ATTR="definitionurl",ADJUSTED_DEFINITION_URL_ATTR="definitionURL",SVG_ATTRS_ADJUSTMENT_MAP=new Map(["attributeName","attributeType","baseFrequency","baseProfile","calcMode","clipPathUnits","diffuseConstant","edgeMode","filterUnits","glyphRef","gradientTransform","gradientUnits","kernelMatrix","kernelUnitLength","keyPoints","keySplines","keyTimes","lengthAdjust","limitingConeAngle","markerHeight","markerUnits","markerWidth","maskContentUnits","maskUnits","numOctaves","pathLength","patternContentUnits","patternTransform","patternUnits","pointsAtX","pointsAtY","pointsAtZ","preserveAlpha","preserveAspectRatio","primitiveUnits","refX","refY","repeatCount","repeatDur","requiredExtensions","requiredFeatures","specularConstant","specularExponent","spreadMethod","startOffset","stdDeviation","stitchTiles","surfaceScale","systemLanguage","tableValues","targetX","targetY","textLength","viewBox","viewTarget","xChannelSelector","yChannelSelector","zoomAndPan"].map(t=>[t.toLowerCase(),t])),XML_ATTRS_ADJUSTMENT_MAP=new Map([["xlink:actuate",{prefix:"xlink",name:"actuate",namespace:NS.XLINK}],["xlink:arcrole",{prefix:"xlink",name:"arcrole",namespace:NS.XLINK}],["xlink:href",{prefix:"xlink",name:"href",namespace:NS.XLINK}],["xlink:role",{prefix:"xlink",name:"role",namespace:NS.XLINK}],["xlink:show",{prefix:"xlink",name:"show",namespace:NS.XLINK}],["xlink:title",{prefix:"xlink",name:"title",namespace:NS.XLINK}],["xlink:type",{prefix:"xlink",name:"type",namespace:NS.XLINK}],["xml:base",{prefix:"xml",name:"base",namespace:NS.XML}],["xml:lang",{prefix:"xml",name:"lang",namespace:NS.XML}],["xml:space",{prefix:"xml",name:"space",namespace:NS.XML}],["xmlns",{prefix:"",name:"xmlns",namespace:NS.XMLNS}],["xmlns:xlink",{prefix:"xmlns",name:"xlink",namespace:NS.XMLNS}]]),SVG_TAG_NAMES_ADJUSTMENT_MAP=new Map(["altGlyph","altGlyphDef","altGlyphItem","animateColor","animateMotion","animateTransform","clipPath","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","foreignObject","glyphRef","linearGradient","radialGradient","textPath"].map(t=>[t.toLowerCase(),t])),EXITS_FOREIGN_CONTENT=new Set([TAG_ID.B,TAG_ID.BIG,TAG_ID.BLOCKQUOTE,TAG_ID.BODY,TAG_ID.BR,TAG_ID.CENTER,TAG_ID.CODE,TAG_ID.DD,TAG_ID.DIV,TAG_ID.DL,TAG_ID.DT,TAG_ID.EM,TAG_ID.EMBED,TAG_ID.H1,TAG_ID.H2,TAG_ID.H3,TAG_ID.H4,TAG_ID.H5,TAG_ID.H6,TAG_ID.HEAD,TAG_ID.HR,TAG_ID.I,TAG_ID.IMG,TAG_ID.LI,TAG_ID.LISTING,TAG_ID.MENU,TAG_ID.META,TAG_ID.NOBR,TAG_ID.OL,TAG_ID.P,TAG_ID.PRE,TAG_ID.RUBY,TAG_ID.S,TAG_ID.SMALL,TAG_ID.SPAN,TAG_ID.STRONG,TAG_ID.STRIKE,TAG_ID.SUB,TAG_ID.SUP,TAG_ID.TABLE,TAG_ID.TT,TAG_ID.U,TAG_ID.UL,TAG_ID.VAR]);function causesExit(t){const e=t.tagID;return e===TAG_ID.FONT&&t.attrs.some(({name:n})=>n===ATTRS.COLOR||n===ATTRS.SIZE||n===ATTRS.FACE)||EXITS_FOREIGN_CONTENT.has(e)}function adjustTokenMathMLAttrs(t){for(let e=0;e<t.attrs.length;e++)if(t.attrs[e].name===DEFINITION_URL_ATTR){t.attrs[e].name=ADJUSTED_DEFINITION_URL_ATTR;break}}function adjustTokenSVGAttrs(t){for(let e=0;e<t.attrs.length;e++){const s=SVG_ATTRS_ADJUSTMENT_MAP.get(t.attrs[e].name);s!=null&&(t.attrs[e].name=s)}}function adjustTokenXMLAttrs(t){for(let e=0;e<t.attrs.length;e++){const s=XML_ATTRS_ADJUSTMENT_MAP.get(t.attrs[e].name);s&&(t.attrs[e].prefix=s.prefix,t.attrs[e].name=s.name,t.attrs[e].namespace=s.namespace)}}function adjustTokenSVGTagName(t){const e=SVG_TAG_NAMES_ADJUSTMENT_MAP.get(t.tagName);e!=null&&(t.tagName=e,t.tagID=getTagID(t.tagName))}function isMathMLTextIntegrationPoint(t,e){return e===NS.MATHML&&(t===TAG_ID.MI||t===TAG_ID.MO||t===TAG_ID.MN||t===TAG_ID.MS||t===TAG_ID.MTEXT)}function isHtmlIntegrationPoint(t,e,s){if(e===NS.MATHML&&t===TAG_ID.ANNOTATION_XML){for(let n=0;n<s.length;n++)if(s[n].name===ATTRS.ENCODING){const r=s[n].value.toLowerCase();return r===MIME_TYPES.TEXT_HTML||r===MIME_TYPES.APPLICATION_XML}}return e===NS.SVG&&(t===TAG_ID.FOREIGN_OBJECT||t===TAG_ID.DESC||t===TAG_ID.TITLE)}function isIntegrationPoint(t,e,s,n){return(!n||n===NS.HTML)&&isHtmlIntegrationPoint(t,e,s)||(!n||n===NS.MATHML)&&isMathMLTextIntegrationPoint(t,e)}const HIDDEN_INPUT_TYPE="hidden",AA_OUTER_LOOP_ITER=8,AA_INNER_LOOP_ITER=3;var InsertionMode;(function(t){t[t.INITIAL=0]="INITIAL",t[t.BEFORE_HTML=1]="BEFORE_HTML",t[t.BEFORE_HEAD=2]="BEFORE_HEAD",t[t.IN_HEAD=3]="IN_HEAD",t[t.IN_HEAD_NO_SCRIPT=4]="IN_HEAD_NO_SCRIPT",t[t.AFTER_HEAD=5]="AFTER_HEAD",t[t.IN_BODY=6]="IN_BODY",t[t.TEXT=7]="TEXT",t[t.IN_TABLE=8]="IN_TABLE",t[t.IN_TABLE_TEXT=9]="IN_TABLE_TEXT",t[t.IN_CAPTION=10]="IN_CAPTION",t[t.IN_COLUMN_GROUP=11]="IN_COLUMN_GROUP",t[t.IN_TABLE_BODY=12]="IN_TABLE_BODY",t[t.IN_ROW=13]="IN_ROW",t[t.IN_CELL=14]="IN_CELL",t[t.IN_SELECT=15]="IN_SELECT",t[t.IN_SELECT_IN_TABLE=16]="IN_SELECT_IN_TABLE",t[t.IN_TEMPLATE=17]="IN_TEMPLATE",t[t.AFTER_BODY=18]="AFTER_BODY",t[t.IN_FRAMESET=19]="IN_FRAMESET",t[t.AFTER_FRAMESET=20]="AFTER_FRAMESET",t[t.AFTER_AFTER_BODY=21]="AFTER_AFTER_BODY",t[t.AFTER_AFTER_FRAMESET=22]="AFTER_AFTER_FRAMESET"})(InsertionMode||(InsertionMode={}));const BASE_LOC={startLine:-1,startCol:-1,startOffset:-1,endLine:-1,endCol:-1,endOffset:-1},TABLE_STRUCTURE_TAGS=new Set([TAG_ID.TABLE,TAG_ID.TBODY,TAG_ID.TFOOT,TAG_ID.THEAD,TAG_ID.TR]),defaultParserOptions={scriptingEnabled:!0,sourceCodeLocationInfo:!1,treeAdapter:defaultTreeAdapter,onParseError:null};let Parser$1=class{constructor(e,s,n=null,r=null){this.fragmentContext=n,this.scriptHandler=r,this.currentToken=null,this.stopped=!1,this.insertionMode=InsertionMode.INITIAL,this.originalInsertionMode=InsertionMode.INITIAL,this.headElement=null,this.formElement=null,this.currentNotInHTML=!1,this.tmplInsertionModeStack=[],this.pendingCharacterTokens=[],this.hasNonWhitespacePendingCharacterToken=!1,this.framesetOk=!0,this.skipNextNewLine=!1,this.fosterParentingEnabled=!1,this.options={...defaultParserOptions,...e},this.treeAdapter=this.options.treeAdapter,this.onParseError=this.options.onParseError,this.onParseError&&(this.options.sourceCodeLocationInfo=!0),this.document=s??this.treeAdapter.createDocument(),this.tokenizer=new Tokenizer$1(this.options,this),this.activeFormattingElements=new FormattingElementList(this.treeAdapter),this.fragmentContextID=n?getTagID(this.treeAdapter.getTagName(n)):TAG_ID.UNKNOWN,this._setContextModes(n??this.document,this.fragmentContextID),this.openElements=new OpenElementStack(this.document,this.treeAdapter,this)}static parse(e,s){const n=new this(s);return n.tokenizer.write(e,!0),n.document}static getFragmentParser(e,s){const n={...defaultParserOptions,...s};e??(e=n.treeAdapter.createElement(TAG_NAMES.TEMPLATE,NS.HTML,[]));const r=n.treeAdapter.createElement("documentmock",NS.HTML,[]),a=new this(n,r,e);return a.fragmentContextID===TAG_ID.TEMPLATE&&a.tmplInsertionModeStack.unshift(InsertionMode.IN_TEMPLATE),a._initTokenizerForFragmentParsing(),a._insertFakeRootElement(),a._resetInsertionMode(),a._findFormInFragmentContext(),a}getFragment(){const e=this.treeAdapter.getFirstChild(this.document),s=this.treeAdapter.createDocumentFragment();return this._adoptNodes(e,s),s}_err(e,s,n){var r;if(!this.onParseError)return;const a=(r=e.location)!==null&&r!==void 0?r:BASE_LOC,i={code:s,startLine:a.startLine,startCol:a.startCol,startOffset:a.startOffset,endLine:n?a.startLine:a.endLine,endCol:n?a.startCol:a.endCol,endOffset:n?a.startOffset:a.endOffset};this.onParseError(i)}onItemPush(e,s,n){var r,a;(a=(r=this.treeAdapter).onItemPush)===null||a===void 0||a.call(r,e),n&&this.openElements.stackTop>0&&this._setContextModes(e,s)}onItemPop(e,s){var n,r;if(this.options.sourceCodeLocationInfo&&this._setEndLocation(e,this.currentToken),(r=(n=this.treeAdapter).onItemPop)===null||r===void 0||r.call(n,e,this.openElements.current),s){let a,i;this.openElements.stackTop===0&&this.fragmentContext?(a=this.fragmentContext,i=this.fragmentContextID):{current:a,currentTagId:i}=this.openElements,this._setContextModes(a,i)}}_setContextModes(e,s){const n=e===this.document||this.treeAdapter.getNamespaceURI(e)===NS.HTML;this.currentNotInHTML=!n,this.tokenizer.inForeignNode=!n&&!this._isIntegrationPoint(s,e)}_switchToTextParsing(e,s){this._insertElement(e,NS.HTML),this.tokenizer.state=s,this.originalInsertionMode=this.insertionMode,this.insertionMode=InsertionMode.TEXT}switchToPlaintextParsing(){this.insertionMode=InsertionMode.TEXT,this.originalInsertionMode=InsertionMode.IN_BODY,this.tokenizer.state=TokenizerMode.PLAINTEXT}_getAdjustedCurrentElement(){return this.openElements.stackTop===0&&this.fragmentContext?this.fragmentContext:this.openElements.current}_findFormInFragmentContext(){let e=this.fragmentContext;for(;e;){if(this.treeAdapter.getTagName(e)===TAG_NAMES.FORM){this.formElement=e;break}e=this.treeAdapter.getParentNode(e)}}_initTokenizerForFragmentParsing(){if(!(!this.fragmentContext||this.treeAdapter.getNamespaceURI(this.fragmentContext)!==NS.HTML))switch(this.fragmentContextID){case TAG_ID.TITLE:case TAG_ID.TEXTAREA:{this.tokenizer.state=TokenizerMode.RCDATA;break}case TAG_ID.STYLE:case TAG_ID.XMP:case TAG_ID.IFRAME:case TAG_ID.NOEMBED:case TAG_ID.NOFRAMES:case TAG_ID.NOSCRIPT:{this.tokenizer.state=TokenizerMode.RAWTEXT;break}case TAG_ID.SCRIPT:{this.tokenizer.state=TokenizerMode.SCRIPT_DATA;break}case TAG_ID.PLAINTEXT:{this.tokenizer.state=TokenizerMode.PLAINTEXT;break}}}_setDocumentType(e){const s=e.name||"",n=e.publicId||"",r=e.systemId||"";if(this.treeAdapter.setDocumentType(this.document,s,n,r),e.location){const i=this.treeAdapter.getChildNodes(this.document).find(u=>this.treeAdapter.isDocumentTypeNode(u));i&&this.treeAdapter.setNodeSourceCodeLocation(i,e.location)}}_attachElementToTree(e,s){if(this.options.sourceCodeLocationInfo){const n=s&&{...s,startTag:s};this.treeAdapter.setNodeSourceCodeLocation(e,n)}if(this._shouldFosterParentOnInsertion())this._fosterParentElement(e);else{const n=this.openElements.currentTmplContentOrNode;this.treeAdapter.appendChild(n,e)}}_appendElement(e,s){const n=this.treeAdapter.createElement(e.tagName,s,e.attrs);this._attachElementToTree(n,e.location)}_insertElement(e,s){const n=this.treeAdapter.createElement(e.tagName,s,e.attrs);this._attachElementToTree(n,e.location),this.openElements.push(n,e.tagID)}_insertFakeElement(e,s){const n=this.treeAdapter.createElement(e,NS.HTML,[]);this._attachElementToTree(n,null),this.openElements.push(n,s)}_insertTemplate(e){const s=this.treeAdapter.createElement(e.tagName,NS.HTML,e.attrs),n=this.treeAdapter.createDocumentFragment();this.treeAdapter.setTemplateContent(s,n),this._attachElementToTree(s,e.location),this.openElements.push(s,e.tagID),this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(n,null)}_insertFakeRootElement(){const e=this.treeAdapter.createElement(TAG_NAMES.HTML,NS.HTML,[]);this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(e,null),this.treeAdapter.appendChild(this.openElements.current,e),this.openElements.push(e,TAG_ID.HTML)}_appendCommentNode(e,s){const n=this.treeAdapter.createCommentNode(e.data);this.treeAdapter.appendChild(s,n),this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(n,e.location)}_insertCharacters(e){let s,n;if(this._shouldFosterParentOnInsertion()?({parent:s,beforeElement:n}=this._findFosterParentingLocation(),n?this.treeAdapter.insertTextBefore(s,e.chars,n):this.treeAdapter.insertText(s,e.chars)):(s=this.openElements.currentTmplContentOrNode,this.treeAdapter.insertText(s,e.chars)),!e.location)return;const r=this.treeAdapter.getChildNodes(s),a=n?r.lastIndexOf(n):r.length,i=r[a-1];if(this.treeAdapter.getNodeSourceCodeLocation(i)){const{endLine:f,endCol:c,endOffset:d}=e.location;this.treeAdapter.updateNodeSourceCodeLocation(i,{endLine:f,endCol:c,endOffset:d})}else this.options.sourceCodeLocationInfo&&this.treeAdapter.setNodeSourceCodeLocation(i,e.location)}_adoptNodes(e,s){for(let n=this.treeAdapter.getFirstChild(e);n;n=this.treeAdapter.getFirstChild(e))this.treeAdapter.detachNode(n),this.treeAdapter.appendChild(s,n)}_setEndLocation(e,s){if(this.treeAdapter.getNodeSourceCodeLocation(e)&&s.location){const n=s.location,r=this.treeAdapter.getTagName(e),a=s.type===TokenType.END_TAG&&r===s.tagName?{endTag:{...n},endLine:n.endLine,endCol:n.endCol,endOffset:n.endOffset}:{endLine:n.startLine,endCol:n.startCol,endOffset:n.startOffset};this.treeAdapter.updateNodeSourceCodeLocation(e,a)}}shouldProcessStartTagTokenInForeignContent(e){if(!this.currentNotInHTML)return!1;let s,n;return this.openElements.stackTop===0&&this.fragmentContext?(s=this.fragmentContext,n=this.fragmentContextID):{current:s,currentTagId:n}=this.openElements,e.tagID===TAG_ID.SVG&&this.treeAdapter.getTagName(s)===TAG_NAMES.ANNOTATION_XML&&this.treeAdapter.getNamespaceURI(s)===NS.MATHML?!1:this.tokenizer.inForeignNode||(e.tagID===TAG_ID.MGLYPH||e.tagID===TAG_ID.MALIGNMARK)&&!this._isIntegrationPoint(n,s,NS.HTML)}_processToken(e){switch(e.type){case TokenType.CHARACTER:{this.onCharacter(e);break}case TokenType.NULL_CHARACTER:{this.onNullCharacter(e);break}case TokenType.COMMENT:{this.onComment(e);break}case TokenType.DOCTYPE:{this.onDoctype(e);break}case TokenType.START_TAG:{this._processStartTag(e);break}case TokenType.END_TAG:{this.onEndTag(e);break}case TokenType.EOF:{this.onEof(e);break}case TokenType.WHITESPACE_CHARACTER:{this.onWhitespaceCharacter(e);break}}}_isIntegrationPoint(e,s,n){const r=this.treeAdapter.getNamespaceURI(s),a=this.treeAdapter.getAttrList(s);return isIntegrationPoint(e,r,a,n)}_reconstructActiveFormattingElements(){const e=this.activeFormattingElements.entries.length;if(e){const s=this.activeFormattingElements.entries.findIndex(r=>r.type===EntryType.Marker||this.openElements.contains(r.element)),n=s<0?e-1:s-1;for(let r=n;r>=0;r--){const a=this.activeFormattingElements.entries[r];this._insertElement(a.token,this.treeAdapter.getNamespaceURI(a.element)),a.element=this.openElements.current}}}_closeTableCell(){this.openElements.generateImpliedEndTags(),this.openElements.popUntilTableCellPopped(),this.activeFormattingElements.clearToLastMarker(),this.insertionMode=InsertionMode.IN_ROW}_closePElement(){this.openElements.generateImpliedEndTagsWithExclusion(TAG_ID.P),this.openElements.popUntilTagNamePopped(TAG_ID.P)}_resetInsertionMode(){for(let e=this.openElements.stackTop;e>=0;e--)switch(e===0&&this.fragmentContext?this.fragmentContextID:this.openElements.tagIDs[e]){case TAG_ID.TR:{this.insertionMode=InsertionMode.IN_ROW;return}case TAG_ID.TBODY:case TAG_ID.THEAD:case TAG_ID.TFOOT:{this.insertionMode=InsertionMode.IN_TABLE_BODY;return}case TAG_ID.CAPTION:{this.insertionMode=InsertionMode.IN_CAPTION;return}case TAG_ID.COLGROUP:{this.insertionMode=InsertionMode.IN_COLUMN_GROUP;return}case TAG_ID.TABLE:{this.insertionMode=InsertionMode.IN_TABLE;return}case TAG_ID.BODY:{this.insertionMode=InsertionMode.IN_BODY;return}case TAG_ID.FRAMESET:{this.insertionMode=InsertionMode.IN_FRAMESET;return}case TAG_ID.SELECT:{this._resetInsertionModeForSelect(e);return}case TAG_ID.TEMPLATE:{this.insertionMode=this.tmplInsertionModeStack[0];return}case TAG_ID.HTML:{this.insertionMode=this.headElement?InsertionMode.AFTER_HEAD:InsertionMode.BEFORE_HEAD;return}case TAG_ID.TD:case TAG_ID.TH:{if(e>0){this.insertionMode=InsertionMode.IN_CELL;return}break}case TAG_ID.HEAD:{if(e>0){this.insertionMode=InsertionMode.IN_HEAD;return}break}}this.insertionMode=InsertionMode.IN_BODY}_resetInsertionModeForSelect(e){if(e>0)for(let s=e-1;s>0;s--){const n=this.openElements.tagIDs[s];if(n===TAG_ID.TEMPLATE)break;if(n===TAG_ID.TABLE){this.insertionMode=InsertionMode.IN_SELECT_IN_TABLE;return}}this.insertionMode=InsertionMode.IN_SELECT}_isElementCausesFosterParenting(e){return TABLE_STRUCTURE_TAGS.has(e)}_shouldFosterParentOnInsertion(){return this.fosterParentingEnabled&&this._isElementCausesFosterParenting(this.openElements.currentTagId)}_findFosterParentingLocation(){for(let e=this.openElements.stackTop;e>=0;e--){const s=this.openElements.items[e];switch(this.openElements.tagIDs[e]){case TAG_ID.TEMPLATE:{if(this.treeAdapter.getNamespaceURI(s)===NS.HTML)return{parent:this.treeAdapter.getTemplateContent(s),beforeElement:null};break}case TAG_ID.TABLE:{const n=this.treeAdapter.getParentNode(s);return n?{parent:n,beforeElement:s}:{parent:this.openElements.items[e-1],beforeElement:null}}}}return{parent:this.openElements.items[0],beforeElement:null}}_fosterParentElement(e){const s=this._findFosterParentingLocation();s.beforeElement?this.treeAdapter.insertBefore(s.parent,e,s.beforeElement):this.treeAdapter.appendChild(s.parent,e)}_isSpecialElement(e,s){const n=this.treeAdapter.getNamespaceURI(e);return SPECIAL_ELEMENTS[n].has(s)}onCharacter(e){if(this.skipNextNewLine=!1,this.tokenizer.inForeignNode){characterInForeignContent(this,e);return}switch(this.insertionMode){case InsertionMode.INITIAL:{tokenInInitialMode(this,e);break}case InsertionMode.BEFORE_HTML:{tokenBeforeHtml(this,e);break}case InsertionMode.BEFORE_HEAD:{tokenBeforeHead(this,e);break}case InsertionMode.IN_HEAD:{tokenInHead(this,e);break}case InsertionMode.IN_HEAD_NO_SCRIPT:{tokenInHeadNoScript(this,e);break}case InsertionMode.AFTER_HEAD:{tokenAfterHead(this,e);break}case InsertionMode.IN_BODY:case InsertionMode.IN_CAPTION:case InsertionMode.IN_CELL:case InsertionMode.IN_TEMPLATE:{characterInBody(this,e);break}case InsertionMode.TEXT:case InsertionMode.IN_SELECT:case InsertionMode.IN_SELECT_IN_TABLE:{this._insertCharacters(e);break}case InsertionMode.IN_TABLE:case InsertionMode.IN_TABLE_BODY:case InsertionMode.IN_ROW:{characterInTable(this,e);break}case InsertionMode.IN_TABLE_TEXT:{characterInTableText(this,e);break}case InsertionMode.IN_COLUMN_GROUP:{tokenInColumnGroup(this,e);break}case InsertionMode.AFTER_BODY:{tokenAfterBody(this,e);break}case InsertionMode.AFTER_AFTER_BODY:{tokenAfterAfterBody(this,e);break}}}onNullCharacter(e){if(this.skipNextNewLine=!1,this.tokenizer.inForeignNode){nullCharacterInForeignContent(this,e);return}switch(this.insertionMode){case InsertionMode.INITIAL:{tokenInInitialMode(this,e);break}case InsertionMode.BEFORE_HTML:{tokenBeforeHtml(this,e);break}case InsertionMode.BEFORE_HEAD:{tokenBeforeHead(this,e);break}case InsertionMode.IN_HEAD:{tokenInHead(this,e);break}case InsertionMode.IN_HEAD_NO_SCRIPT:{tokenInHeadNoScript(this,e);break}case InsertionMode.AFTER_HEAD:{tokenAfterHead(this,e);break}case InsertionMode.TEXT:{this._insertCharacters(e);break}case InsertionMode.IN_TABLE:case InsertionMode.IN_TABLE_BODY:case InsertionMode.IN_ROW:{characterInTable(this,e);break}case InsertionMode.IN_COLUMN_GROUP:{tokenInColumnGroup(this,e);break}case InsertionMode.AFTER_BODY:{tokenAfterBody(this,e);break}case InsertionMode.AFTER_AFTER_BODY:{tokenAfterAfterBody(this,e);break}}}onComment(e){if(this.skipNextNewLine=!1,this.currentNotInHTML){appendComment(this,e);return}switch(this.insertionMode){case InsertionMode.INITIAL:case InsertionMode.BEFORE_HTML:case InsertionMode.BEFORE_HEAD:case InsertionMode.IN_HEAD:case InsertionMode.IN_HEAD_NO_SCRIPT:case InsertionMode.AFTER_HEAD:case InsertionMode.IN_BODY:case InsertionMode.IN_TABLE:case InsertionMode.IN_CAPTION:case InsertionMode.IN_COLUMN_GROUP:case InsertionMode.IN_TABLE_BODY:case InsertionMode.IN_ROW:case InsertionMode.IN_CELL:case InsertionMode.IN_SELECT:case InsertionMode.IN_SELECT_IN_TABLE:case InsertionMode.IN_TEMPLATE:case InsertionMode.IN_FRAMESET:case InsertionMode.AFTER_FRAMESET:{appendComment(this,e);break}case InsertionMode.IN_TABLE_TEXT:{tokenInTableText(this,e);break}case InsertionMode.AFTER_BODY:{appendCommentToRootHtmlElement(this,e);break}case InsertionMode.AFTER_AFTER_BODY:case InsertionMode.AFTER_AFTER_FRAMESET:{appendCommentToDocument(this,e);break}}}onDoctype(e){switch(this.skipNextNewLine=!1,this.insertionMode){case InsertionMode.INITIAL:{doctypeInInitialMode(this,e);break}case InsertionMode.BEFORE_HEAD:case InsertionMode.IN_HEAD:case InsertionMode.IN_HEAD_NO_SCRIPT:case InsertionMode.AFTER_HEAD:{this._err(e,ERR.misplacedDoctype);break}case InsertionMode.IN_TABLE_TEXT:{tokenInTableText(this,e);break}}}onStartTag(e){this.skipNextNewLine=!1,this.currentToken=e,this._processStartTag(e),e.selfClosing&&!e.ackSelfClosing&&this._err(e,ERR.nonVoidHtmlElementStartTagWithTrailingSolidus)}_processStartTag(e){this.shouldProcessStartTagTokenInForeignContent(e)?startTagInForeignContent(this,e):this._startTagOutsideForeignContent(e)}_startTagOutsideForeignContent(e){switch(this.insertionMode){case InsertionMode.INITIAL:{tokenInInitialMode(this,e);break}case InsertionMode.BEFORE_HTML:{startTagBeforeHtml(this,e);break}case InsertionMode.BEFORE_HEAD:{startTagBeforeHead(this,e);break}case InsertionMode.IN_HEAD:{startTagInHead(this,e);break}case InsertionMode.IN_HEAD_NO_SCRIPT:{startTagInHeadNoScript(this,e);break}case InsertionMode.AFTER_HEAD:{startTagAfterHead(this,e);break}case InsertionMode.IN_BODY:{startTagInBody(this,e);break}case InsertionMode.IN_TABLE:{startTagInTable(this,e);break}case InsertionMode.IN_TABLE_TEXT:{tokenInTableText(this,e);break}case InsertionMode.IN_CAPTION:{startTagInCaption(this,e);break}case InsertionMode.IN_COLUMN_GROUP:{startTagInColumnGroup(this,e);break}case InsertionMode.IN_TABLE_BODY:{startTagInTableBody(this,e);break}case InsertionMode.IN_ROW:{startTagInRow(this,e);break}case InsertionMode.IN_CELL:{startTagInCell(this,e);break}case InsertionMode.IN_SELECT:{startTagInSelect(this,e);break}case InsertionMode.IN_SELECT_IN_TABLE:{startTagInSelectInTable(this,e);break}case InsertionMode.IN_TEMPLATE:{startTagInTemplate(this,e);break}case InsertionMode.AFTER_BODY:{startTagAfterBody(this,e);break}case InsertionMode.IN_FRAMESET:{startTagInFrameset(this,e);break}case InsertionMode.AFTER_FRAMESET:{startTagAfterFrameset(this,e);break}case InsertionMode.AFTER_AFTER_BODY:{startTagAfterAfterBody(this,e);break}case InsertionMode.AFTER_AFTER_FRAMESET:{startTagAfterAfterFrameset(this,e);break}}}onEndTag(e){this.skipNextNewLine=!1,this.currentToken=e,this.currentNotInHTML?endTagInForeignContent(this,e):this._endTagOutsideForeignContent(e)}_endTagOutsideForeignContent(e){switch(this.insertionMode){case InsertionMode.INITIAL:{tokenInInitialMode(this,e);break}case InsertionMode.BEFORE_HTML:{endTagBeforeHtml(this,e);break}case InsertionMode.BEFORE_HEAD:{endTagBeforeHead(this,e);break}case InsertionMode.IN_HEAD:{endTagInHead(this,e);break}case InsertionMode.IN_HEAD_NO_SCRIPT:{endTagInHeadNoScript(this,e);break}case InsertionMode.AFTER_HEAD:{endTagAfterHead(this,e);break}case InsertionMode.IN_BODY:{endTagInBody(this,e);break}case InsertionMode.TEXT:{endTagInText(this,e);break}case InsertionMode.IN_TABLE:{endTagInTable(this,e);break}case InsertionMode.IN_TABLE_TEXT:{tokenInTableText(this,e);break}case InsertionMode.IN_CAPTION:{endTagInCaption(this,e);break}case InsertionMode.IN_COLUMN_GROUP:{endTagInColumnGroup(this,e);break}case InsertionMode.IN_TABLE_BODY:{endTagInTableBody(this,e);break}case InsertionMode.IN_ROW:{endTagInRow(this,e);break}case InsertionMode.IN_CELL:{endTagInCell(this,e);break}case InsertionMode.IN_SELECT:{endTagInSelect(this,e);break}case InsertionMode.IN_SELECT_IN_TABLE:{endTagInSelectInTable(this,e);break}case InsertionMode.IN_TEMPLATE:{endTagInTemplate(this,e);break}case InsertionMode.AFTER_BODY:{endTagAfterBody(this,e);break}case InsertionMode.IN_FRAMESET:{endTagInFrameset(this,e);break}case InsertionMode.AFTER_FRAMESET:{endTagAfterFrameset(this,e);break}case InsertionMode.AFTER_AFTER_BODY:{tokenAfterAfterBody(this,e);break}}}onEof(e){switch(this.insertionMode){case InsertionMode.INITIAL:{tokenInInitialMode(this,e);break}case InsertionMode.BEFORE_HTML:{tokenBeforeHtml(this,e);break}case InsertionMode.BEFORE_HEAD:{tokenBeforeHead(this,e);break}case InsertionMode.IN_HEAD:{tokenInHead(this,e);break}case InsertionMode.IN_HEAD_NO_SCRIPT:{tokenInHeadNoScript(this,e);break}case InsertionMode.AFTER_HEAD:{tokenAfterHead(this,e);break}case InsertionMode.IN_BODY:case InsertionMode.IN_TABLE:case InsertionMode.IN_CAPTION:case InsertionMode.IN_COLUMN_GROUP:case InsertionMode.IN_TABLE_BODY:case InsertionMode.IN_ROW:case InsertionMode.IN_CELL:case InsertionMode.IN_SELECT:case InsertionMode.IN_SELECT_IN_TABLE:{eofInBody(this,e);break}case InsertionMode.TEXT:{eofInText(this,e);break}case InsertionMode.IN_TABLE_TEXT:{tokenInTableText(this,e);break}case InsertionMode.IN_TEMPLATE:{eofInTemplate(this,e);break}case InsertionMode.AFTER_BODY:case InsertionMode.IN_FRAMESET:case InsertionMode.AFTER_FRAMESET:case InsertionMode.AFTER_AFTER_BODY:case InsertionMode.AFTER_AFTER_FRAMESET:{stopParsing(this,e);break}}}onWhitespaceCharacter(e){if(this.skipNextNewLine&&(this.skipNextNewLine=!1,e.chars.charCodeAt(0)===CODE_POINTS.LINE_FEED)){if(e.chars.length===1)return;e.chars=e.chars.substr(1)}if(this.tokenizer.inForeignNode){this._insertCharacters(e);return}switch(this.insertionMode){case InsertionMode.IN_HEAD:case InsertionMode.IN_HEAD_NO_SCRIPT:case InsertionMode.AFTER_HEAD:case InsertionMode.TEXT:case InsertionMode.IN_COLUMN_GROUP:case InsertionMode.IN_SELECT:case InsertionMode.IN_SELECT_IN_TABLE:case InsertionMode.IN_FRAMESET:case InsertionMode.AFTER_FRAMESET:{this._insertCharacters(e);break}case InsertionMode.IN_BODY:case InsertionMode.IN_CAPTION:case InsertionMode.IN_CELL:case InsertionMode.IN_TEMPLATE:case InsertionMode.AFTER_BODY:case InsertionMode.AFTER_AFTER_BODY:case InsertionMode.AFTER_AFTER_FRAMESET:{whitespaceCharacterInBody(this,e);break}case InsertionMode.IN_TABLE:case InsertionMode.IN_TABLE_BODY:case InsertionMode.IN_ROW:{characterInTable(this,e);break}case InsertionMode.IN_TABLE_TEXT:{whitespaceCharacterInTableText(this,e);break}}}};function aaObtainFormattingElementEntry(t,e){let s=t.activeFormattingElements.getElementEntryInScopeWithTagName(e.tagName);return s?t.openElements.contains(s.element)?t.openElements.hasInScope(e.tagID)||(s=null):(t.activeFormattingElements.removeEntry(s),s=null):genericEndTagInBody(t,e),s}function aaObtainFurthestBlock(t,e){let s=null,n=t.openElements.stackTop;for(;n>=0;n--){const r=t.openElements.items[n];if(r===e.element)break;t._isSpecialElement(r,t.openElements.tagIDs[n])&&(s=r)}return s||(t.openElements.shortenToLength(n<0?0:n),t.activeFormattingElements.removeEntry(e)),s}function aaInnerLoop(t,e,s){let n=e,r=t.openElements.getCommonAncestor(e);for(let a=0,i=r;i!==s;a++,i=r){r=t.openElements.getCommonAncestor(i);const u=t.activeFormattingElements.getElementEntry(i),f=u&&a>=AA_INNER_LOOP_ITER;!u||f?(f&&t.activeFormattingElements.removeEntry(u),t.openElements.remove(i)):(i=aaRecreateElementFromEntry(t,u),n===e&&(t.activeFormattingElements.bookmark=u),t.treeAdapter.detachNode(n),t.treeAdapter.appendChild(i,n),n=i)}return n}function aaRecreateElementFromEntry(t,e){const s=t.treeAdapter.getNamespaceURI(e.element),n=t.treeAdapter.createElement(e.token.tagName,s,e.token.attrs);return t.openElements.replace(e.element,n),e.element=n,n}function aaInsertLastNodeInCommonAncestor(t,e,s){const n=t.treeAdapter.getTagName(e),r=getTagID(n);if(t._isElementCausesFosterParenting(r))t._fosterParentElement(s);else{const a=t.treeAdapter.getNamespaceURI(e);r===TAG_ID.TEMPLATE&&a===NS.HTML&&(e=t.treeAdapter.getTemplateContent(e)),t.treeAdapter.appendChild(e,s)}}function aaReplaceFormattingElement(t,e,s){const n=t.treeAdapter.getNamespaceURI(s.element),{token:r}=s,a=t.treeAdapter.createElement(r.tagName,n,r.attrs);t._adoptNodes(e,a),t.treeAdapter.appendChild(e,a),t.activeFormattingElements.insertElementAfterBookmark(a,r),t.activeFormattingElements.removeEntry(s),t.openElements.remove(s.element),t.openElements.insertAfter(e,a,r.tagID)}function callAdoptionAgency(t,e){for(let s=0;s<AA_OUTER_LOOP_ITER;s++){const n=aaObtainFormattingElementEntry(t,e);if(!n)break;const r=aaObtainFurthestBlock(t,n);if(!r)break;t.activeFormattingElements.bookmark=n;const a=aaInnerLoop(t,r,n.element),i=t.openElements.getCommonAncestor(n.element);t.treeAdapter.detachNode(a),i&&aaInsertLastNodeInCommonAncestor(t,i,a),aaReplaceFormattingElement(t,r,n)}}function appendComment(t,e){t._appendCommentNode(e,t.openElements.currentTmplContentOrNode)}function appendCommentToRootHtmlElement(t,e){t._appendCommentNode(e,t.openElements.items[0])}function appendCommentToDocument(t,e){t._appendCommentNode(e,t.document)}function stopParsing(t,e){if(t.stopped=!0,e.location){const s=t.fragmentContext?0:2;for(let n=t.openElements.stackTop;n>=s;n--)t._setEndLocation(t.openElements.items[n],e);if(!t.fragmentContext&&t.openElements.stackTop>=0){const n=t.openElements.items[0],r=t.treeAdapter.getNodeSourceCodeLocation(n);if(r&&!r.endTag&&(t._setEndLocation(n,e),t.openElements.stackTop>=1)){const a=t.openElements.items[1],i=t.treeAdapter.getNodeSourceCodeLocation(a);i&&!i.endTag&&t._setEndLocation(a,e)}}}}function doctypeInInitialMode(t,e){t._setDocumentType(e);const s=e.forceQuirks?DOCUMENT_MODE.QUIRKS:getDocumentMode(e);isConforming(e)||t._err(e,ERR.nonConformingDoctype),t.treeAdapter.setDocumentMode(t.document,s),t.insertionMode=InsertionMode.BEFORE_HTML}function tokenInInitialMode(t,e){t._err(e,ERR.missingDoctype,!0),t.treeAdapter.setDocumentMode(t.document,DOCUMENT_MODE.QUIRKS),t.insertionMode=InsertionMode.BEFORE_HTML,t._processToken(e)}function startTagBeforeHtml(t,e){e.tagID===TAG_ID.HTML?(t._insertElement(e,NS.HTML),t.insertionMode=InsertionMode.BEFORE_HEAD):tokenBeforeHtml(t,e)}function endTagBeforeHtml(t,e){const s=e.tagID;(s===TAG_ID.HTML||s===TAG_ID.HEAD||s===TAG_ID.BODY||s===TAG_ID.BR)&&tokenBeforeHtml(t,e)}function tokenBeforeHtml(t,e){t._insertFakeRootElement(),t.insertionMode=InsertionMode.BEFORE_HEAD,t._processToken(e)}function startTagBeforeHead(t,e){switch(e.tagID){case TAG_ID.HTML:{startTagInBody(t,e);break}case TAG_ID.HEAD:{t._insertElement(e,NS.HTML),t.headElement=t.openElements.current,t.insertionMode=InsertionMode.IN_HEAD;break}default:tokenBeforeHead(t,e)}}function endTagBeforeHead(t,e){const s=e.tagID;s===TAG_ID.HEAD||s===TAG_ID.BODY||s===TAG_ID.HTML||s===TAG_ID.BR?tokenBeforeHead(t,e):t._err(e,ERR.endTagWithoutMatchingOpenElement)}function tokenBeforeHead(t,e){t._insertFakeElement(TAG_NAMES.HEAD,TAG_ID.HEAD),t.headElement=t.openElements.current,t.insertionMode=InsertionMode.IN_HEAD,t._processToken(e)}function startTagInHead(t,e){switch(e.tagID){case TAG_ID.HTML:{startTagInBody(t,e);break}case TAG_ID.BASE:case TAG_ID.BASEFONT:case TAG_ID.BGSOUND:case TAG_ID.LINK:case TAG_ID.META:{t._appendElement(e,NS.HTML),e.ackSelfClosing=!0;break}case TAG_ID.TITLE:{t._switchToTextParsing(e,TokenizerMode.RCDATA);break}case TAG_ID.NOSCRIPT:{t.options.scriptingEnabled?t._switchToTextParsing(e,TokenizerMode.RAWTEXT):(t._insertElement(e,NS.HTML),t.insertionMode=InsertionMode.IN_HEAD_NO_SCRIPT);break}case TAG_ID.NOFRAMES:case TAG_ID.STYLE:{t._switchToTextParsing(e,TokenizerMode.RAWTEXT);break}case TAG_ID.SCRIPT:{t._switchToTextParsing(e,TokenizerMode.SCRIPT_DATA);break}case TAG_ID.TEMPLATE:{t._insertTemplate(e),t.activeFormattingElements.insertMarker(),t.framesetOk=!1,t.insertionMode=InsertionMode.IN_TEMPLATE,t.tmplInsertionModeStack.unshift(InsertionMode.IN_TEMPLATE);break}case TAG_ID.HEAD:{t._err(e,ERR.misplacedStartTagForHeadElement);break}default:tokenInHead(t,e)}}function endTagInHead(t,e){switch(e.tagID){case TAG_ID.HEAD:{t.openElements.pop(),t.insertionMode=InsertionMode.AFTER_HEAD;break}case TAG_ID.BODY:case TAG_ID.BR:case TAG_ID.HTML:{tokenInHead(t,e);break}case TAG_ID.TEMPLATE:{templateEndTagInHead(t,e);break}default:t._err(e,ERR.endTagWithoutMatchingOpenElement)}}function templateEndTagInHead(t,e){t.openElements.tmplCount>0?(t.openElements.generateImpliedEndTagsThoroughly(),t.openElements.currentTagId!==TAG_ID.TEMPLATE&&t._err(e,ERR.closingOfElementWithOpenChildElements),t.openElements.popUntilTagNamePopped(TAG_ID.TEMPLATE),t.activeFormattingElements.clearToLastMarker(),t.tmplInsertionModeStack.shift(),t._resetInsertionMode()):t._err(e,ERR.endTagWithoutMatchingOpenElement)}function tokenInHead(t,e){t.openElements.pop(),t.insertionMode=InsertionMode.AFTER_HEAD,t._processToken(e)}function startTagInHeadNoScript(t,e){switch(e.tagID){case TAG_ID.HTML:{startTagInBody(t,e);break}case TAG_ID.BASEFONT:case TAG_ID.BGSOUND:case TAG_ID.HEAD:case TAG_ID.LINK:case TAG_ID.META:case TAG_ID.NOFRAMES:case TAG_ID.STYLE:{startTagInHead(t,e);break}case TAG_ID.NOSCRIPT:{t._err(e,ERR.nestedNoscriptInHead);break}default:tokenInHeadNoScript(t,e)}}function endTagInHeadNoScript(t,e){switch(e.tagID){case TAG_ID.NOSCRIPT:{t.openElements.pop(),t.insertionMode=InsertionMode.IN_HEAD;break}case TAG_ID.BR:{tokenInHeadNoScript(t,e);break}default:t._err(e,ERR.endTagWithoutMatchingOpenElement)}}function tokenInHeadNoScript(t,e){const s=e.type===TokenType.EOF?ERR.openElementsLeftAfterEof:ERR.disallowedContentInNoscriptInHead;t._err(e,s),t.openElements.pop(),t.insertionMode=InsertionMode.IN_HEAD,t._processToken(e)}function startTagAfterHead(t,e){switch(e.tagID){case TAG_ID.HTML:{startTagInBody(t,e);break}case TAG_ID.BODY:{t._insertElement(e,NS.HTML),t.framesetOk=!1,t.insertionMode=InsertionMode.IN_BODY;break}case TAG_ID.FRAMESET:{t._insertElement(e,NS.HTML),t.insertionMode=InsertionMode.IN_FRAMESET;break}case TAG_ID.BASE:case TAG_ID.BASEFONT:case TAG_ID.BGSOUND:case TAG_ID.LINK:case TAG_ID.META:case TAG_ID.NOFRAMES:case TAG_ID.SCRIPT:case TAG_ID.STYLE:case TAG_ID.TEMPLATE:case TAG_ID.TITLE:{t._err(e,ERR.abandonedHeadElementChild),t.openElements.push(t.headElement,TAG_ID.HEAD),startTagInHead(t,e),t.openElements.remove(t.headElement);break}case TAG_ID.HEAD:{t._err(e,ERR.misplacedStartTagForHeadElement);break}default:tokenAfterHead(t,e)}}function endTagAfterHead(t,e){switch(e.tagID){case TAG_ID.BODY:case TAG_ID.HTML:case TAG_ID.BR:{tokenAfterHead(t,e);break}case TAG_ID.TEMPLATE:{templateEndTagInHead(t,e);break}default:t._err(e,ERR.endTagWithoutMatchingOpenElement)}}function tokenAfterHead(t,e){t._insertFakeElement(TAG_NAMES.BODY,TAG_ID.BODY),t.insertionMode=InsertionMode.IN_BODY,modeInBody(t,e)}function modeInBody(t,e){switch(e.type){case TokenType.CHARACTER:{characterInBody(t,e);break}case TokenType.WHITESPACE_CHARACTER:{whitespaceCharacterInBody(t,e);break}case TokenType.COMMENT:{appendComment(t,e);break}case TokenType.START_TAG:{startTagInBody(t,e);break}case TokenType.END_TAG:{endTagInBody(t,e);break}case TokenType.EOF:{eofInBody(t,e);break}}}function whitespaceCharacterInBody(t,e){t._reconstructActiveFormattingElements(),t._insertCharacters(e)}function characterInBody(t,e){t._reconstructActiveFormattingElements(),t._insertCharacters(e),t.framesetOk=!1}function htmlStartTagInBody(t,e){t.openElements.tmplCount===0&&t.treeAdapter.adoptAttributes(t.openElements.items[0],e.attrs)}function bodyStartTagInBody(t,e){const s=t.openElements.tryPeekProperlyNestedBodyElement();s&&t.openElements.tmplCount===0&&(t.framesetOk=!1,t.treeAdapter.adoptAttributes(s,e.attrs))}function framesetStartTagInBody(t,e){const s=t.openElements.tryPeekProperlyNestedBodyElement();t.framesetOk&&s&&(t.treeAdapter.detachNode(s),t.openElements.popAllUpToHtmlElement(),t._insertElement(e,NS.HTML),t.insertionMode=InsertionMode.IN_FRAMESET)}function addressStartTagInBody(t,e){t.openElements.hasInButtonScope(TAG_ID.P)&&t._closePElement(),t._insertElement(e,NS.HTML)}function numberedHeaderStartTagInBody(t,e){t.openElements.hasInButtonScope(TAG_ID.P)&&t._closePElement(),isNumberedHeader(t.openElements.currentTagId)&&t.openElements.pop(),t._insertElement(e,NS.HTML)}function preStartTagInBody(t,e){t.openElements.hasInButtonScope(TAG_ID.P)&&t._closePElement(),t._insertElement(e,NS.HTML),t.skipNextNewLine=!0,t.framesetOk=!1}function formStartTagInBody(t,e){const s=t.openElements.tmplCount>0;(!t.formElement||s)&&(t.openElements.hasInButtonScope(TAG_ID.P)&&t._closePElement(),t._insertElement(e,NS.HTML),s||(t.formElement=t.openElements.current))}function listItemStartTagInBody(t,e){t.framesetOk=!1;const s=e.tagID;for(let n=t.openElements.stackTop;n>=0;n--){const r=t.openElements.tagIDs[n];if(s===TAG_ID.LI&&r===TAG_ID.LI||(s===TAG_ID.DD||s===TAG_ID.DT)&&(r===TAG_ID.DD||r===TAG_ID.DT)){t.openElements.generateImpliedEndTagsWithExclusion(r),t.openElements.popUntilTagNamePopped(r);break}if(r!==TAG_ID.ADDRESS&&r!==TAG_ID.DIV&&r!==TAG_ID.P&&t._isSpecialElement(t.openElements.items[n],r))break}t.openElements.hasInButtonScope(TAG_ID.P)&&t._closePElement(),t._insertElement(e,NS.HTML)}function plaintextStartTagInBody(t,e){t.openElements.hasInButtonScope(TAG_ID.P)&&t._closePElement(),t._insertElement(e,NS.HTML),t.tokenizer.state=TokenizerMode.PLAINTEXT}function buttonStartTagInBody(t,e){t.openElements.hasInScope(TAG_ID.BUTTON)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(TAG_ID.BUTTON)),t._reconstructActiveFormattingElements(),t._insertElement(e,NS.HTML),t.framesetOk=!1}function aStartTagInBody(t,e){const s=t.activeFormattingElements.getElementEntryInScopeWithTagName(TAG_NAMES.A);s&&(callAdoptionAgency(t,e),t.openElements.remove(s.element),t.activeFormattingElements.removeEntry(s)),t._reconstructActiveFormattingElements(),t._insertElement(e,NS.HTML),t.activeFormattingElements.pushElement(t.openElements.current,e)}function bStartTagInBody(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,NS.HTML),t.activeFormattingElements.pushElement(t.openElements.current,e)}function nobrStartTagInBody(t,e){t._reconstructActiveFormattingElements(),t.openElements.hasInScope(TAG_ID.NOBR)&&(callAdoptionAgency(t,e),t._reconstructActiveFormattingElements()),t._insertElement(e,NS.HTML),t.activeFormattingElements.pushElement(t.openElements.current,e)}function appletStartTagInBody(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,NS.HTML),t.activeFormattingElements.insertMarker(),t.framesetOk=!1}function tableStartTagInBody(t,e){t.treeAdapter.getDocumentMode(t.document)!==DOCUMENT_MODE.QUIRKS&&t.openElements.hasInButtonScope(TAG_ID.P)&&t._closePElement(),t._insertElement(e,NS.HTML),t.framesetOk=!1,t.insertionMode=InsertionMode.IN_TABLE}function areaStartTagInBody(t,e){t._reconstructActiveFormattingElements(),t._appendElement(e,NS.HTML),t.framesetOk=!1,e.ackSelfClosing=!0}function isHiddenInput(t){const e=getTokenAttr(t,ATTRS.TYPE);return e!=null&&e.toLowerCase()===HIDDEN_INPUT_TYPE}function inputStartTagInBody(t,e){t._reconstructActiveFormattingElements(),t._appendElement(e,NS.HTML),isHiddenInput(e)||(t.framesetOk=!1),e.ackSelfClosing=!0}function paramStartTagInBody(t,e){t._appendElement(e,NS.HTML),e.ackSelfClosing=!0}function hrStartTagInBody(t,e){t.openElements.hasInButtonScope(TAG_ID.P)&&t._closePElement(),t._appendElement(e,NS.HTML),t.framesetOk=!1,e.ackSelfClosing=!0}function imageStartTagInBody(t,e){e.tagName=TAG_NAMES.IMG,e.tagID=TAG_ID.IMG,areaStartTagInBody(t,e)}function textareaStartTagInBody(t,e){t._insertElement(e,NS.HTML),t.skipNextNewLine=!0,t.tokenizer.state=TokenizerMode.RCDATA,t.originalInsertionMode=t.insertionMode,t.framesetOk=!1,t.insertionMode=InsertionMode.TEXT}function xmpStartTagInBody(t,e){t.openElements.hasInButtonScope(TAG_ID.P)&&t._closePElement(),t._reconstructActiveFormattingElements(),t.framesetOk=!1,t._switchToTextParsing(e,TokenizerMode.RAWTEXT)}function iframeStartTagInBody(t,e){t.framesetOk=!1,t._switchToTextParsing(e,TokenizerMode.RAWTEXT)}function noembedStartTagInBody(t,e){t._switchToTextParsing(e,TokenizerMode.RAWTEXT)}function selectStartTagInBody(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,NS.HTML),t.framesetOk=!1,t.insertionMode=t.insertionMode===InsertionMode.IN_TABLE||t.insertionMode===InsertionMode.IN_CAPTION||t.insertionMode===InsertionMode.IN_TABLE_BODY||t.insertionMode===InsertionMode.IN_ROW||t.insertionMode===InsertionMode.IN_CELL?InsertionMode.IN_SELECT_IN_TABLE:InsertionMode.IN_SELECT}function optgroupStartTagInBody(t,e){t.openElements.currentTagId===TAG_ID.OPTION&&t.openElements.pop(),t._reconstructActiveFormattingElements(),t._insertElement(e,NS.HTML)}function rbStartTagInBody(t,e){t.openElements.hasInScope(TAG_ID.RUBY)&&t.openElements.generateImpliedEndTags(),t._insertElement(e,NS.HTML)}function rtStartTagInBody(t,e){t.openElements.hasInScope(TAG_ID.RUBY)&&t.openElements.generateImpliedEndTagsWithExclusion(TAG_ID.RTC),t._insertElement(e,NS.HTML)}function mathStartTagInBody(t,e){t._reconstructActiveFormattingElements(),adjustTokenMathMLAttrs(e),adjustTokenXMLAttrs(e),e.selfClosing?t._appendElement(e,NS.MATHML):t._insertElement(e,NS.MATHML),e.ackSelfClosing=!0}function svgStartTagInBody(t,e){t._reconstructActiveFormattingElements(),adjustTokenSVGAttrs(e),adjustTokenXMLAttrs(e),e.selfClosing?t._appendElement(e,NS.SVG):t._insertElement(e,NS.SVG),e.ackSelfClosing=!0}function genericStartTagInBody(t,e){t._reconstructActiveFormattingElements(),t._insertElement(e,NS.HTML)}function startTagInBody(t,e){switch(e.tagID){case TAG_ID.I:case TAG_ID.S:case TAG_ID.B:case TAG_ID.U:case TAG_ID.EM:case TAG_ID.TT:case TAG_ID.BIG:case TAG_ID.CODE:case TAG_ID.FONT:case TAG_ID.SMALL:case TAG_ID.STRIKE:case TAG_ID.STRONG:{bStartTagInBody(t,e);break}case TAG_ID.A:{aStartTagInBody(t,e);break}case TAG_ID.H1:case TAG_ID.H2:case TAG_ID.H3:case TAG_ID.H4:case TAG_ID.H5:case TAG_ID.H6:{numberedHeaderStartTagInBody(t,e);break}case TAG_ID.P:case TAG_ID.DL:case TAG_ID.OL:case TAG_ID.UL:case TAG_ID.DIV:case TAG_ID.DIR:case TAG_ID.NAV:case TAG_ID.MAIN:case TAG_ID.MENU:case TAG_ID.ASIDE:case TAG_ID.CENTER:case TAG_ID.FIGURE:case TAG_ID.FOOTER:case TAG_ID.HEADER:case TAG_ID.HGROUP:case TAG_ID.DIALOG:case TAG_ID.DETAILS:case TAG_ID.ADDRESS:case TAG_ID.ARTICLE:case TAG_ID.SECTION:case TAG_ID.SUMMARY:case TAG_ID.FIELDSET:case TAG_ID.BLOCKQUOTE:case TAG_ID.FIGCAPTION:{addressStartTagInBody(t,e);break}case TAG_ID.LI:case TAG_ID.DD:case TAG_ID.DT:{listItemStartTagInBody(t,e);break}case TAG_ID.BR:case TAG_ID.IMG:case TAG_ID.WBR:case TAG_ID.AREA:case TAG_ID.EMBED:case TAG_ID.KEYGEN:{areaStartTagInBody(t,e);break}case TAG_ID.HR:{hrStartTagInBody(t,e);break}case TAG_ID.RB:case TAG_ID.RTC:{rbStartTagInBody(t,e);break}case TAG_ID.RT:case TAG_ID.RP:{rtStartTagInBody(t,e);break}case TAG_ID.PRE:case TAG_ID.LISTING:{preStartTagInBody(t,e);break}case TAG_ID.XMP:{xmpStartTagInBody(t,e);break}case TAG_ID.SVG:{svgStartTagInBody(t,e);break}case TAG_ID.HTML:{htmlStartTagInBody(t,e);break}case TAG_ID.BASE:case TAG_ID.LINK:case TAG_ID.META:case TAG_ID.STYLE:case TAG_ID.TITLE:case TAG_ID.SCRIPT:case TAG_ID.BGSOUND:case TAG_ID.BASEFONT:case TAG_ID.TEMPLATE:{startTagInHead(t,e);break}case TAG_ID.BODY:{bodyStartTagInBody(t,e);break}case TAG_ID.FORM:{formStartTagInBody(t,e);break}case TAG_ID.NOBR:{nobrStartTagInBody(t,e);break}case TAG_ID.MATH:{mathStartTagInBody(t,e);break}case TAG_ID.TABLE:{tableStartTagInBody(t,e);break}case TAG_ID.INPUT:{inputStartTagInBody(t,e);break}case TAG_ID.PARAM:case TAG_ID.TRACK:case TAG_ID.SOURCE:{paramStartTagInBody(t,e);break}case TAG_ID.IMAGE:{imageStartTagInBody(t,e);break}case TAG_ID.BUTTON:{buttonStartTagInBody(t,e);break}case TAG_ID.APPLET:case TAG_ID.OBJECT:case TAG_ID.MARQUEE:{appletStartTagInBody(t,e);break}case TAG_ID.IFRAME:{iframeStartTagInBody(t,e);break}case TAG_ID.SELECT:{selectStartTagInBody(t,e);break}case TAG_ID.OPTION:case TAG_ID.OPTGROUP:{optgroupStartTagInBody(t,e);break}case TAG_ID.NOEMBED:{noembedStartTagInBody(t,e);break}case TAG_ID.FRAMESET:{framesetStartTagInBody(t,e);break}case TAG_ID.TEXTAREA:{textareaStartTagInBody(t,e);break}case TAG_ID.NOSCRIPT:{t.options.scriptingEnabled?noembedStartTagInBody(t,e):genericStartTagInBody(t,e);break}case TAG_ID.PLAINTEXT:{plaintextStartTagInBody(t,e);break}case TAG_ID.COL:case TAG_ID.TH:case TAG_ID.TD:case TAG_ID.TR:case TAG_ID.HEAD:case TAG_ID.FRAME:case TAG_ID.TBODY:case TAG_ID.TFOOT:case TAG_ID.THEAD:case TAG_ID.CAPTION:case TAG_ID.COLGROUP:break;default:genericStartTagInBody(t,e)}}function bodyEndTagInBody(t,e){if(t.openElements.hasInScope(TAG_ID.BODY)&&(t.insertionMode=InsertionMode.AFTER_BODY,t.options.sourceCodeLocationInfo)){const s=t.openElements.tryPeekProperlyNestedBodyElement();s&&t._setEndLocation(s,e)}}function htmlEndTagInBody(t,e){t.openElements.hasInScope(TAG_ID.BODY)&&(t.insertionMode=InsertionMode.AFTER_BODY,endTagAfterBody(t,e))}function addressEndTagInBody(t,e){const s=e.tagID;t.openElements.hasInScope(s)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(s))}function formEndTagInBody(t){const e=t.openElements.tmplCount>0,{formElement:s}=t;e||(t.formElement=null),(s||e)&&t.openElements.hasInScope(TAG_ID.FORM)&&(t.openElements.generateImpliedEndTags(),e?t.openElements.popUntilTagNamePopped(TAG_ID.FORM):s&&t.openElements.remove(s))}function pEndTagInBody(t){t.openElements.hasInButtonScope(TAG_ID.P)||t._insertFakeElement(TAG_NAMES.P,TAG_ID.P),t._closePElement()}function liEndTagInBody(t){t.openElements.hasInListItemScope(TAG_ID.LI)&&(t.openElements.generateImpliedEndTagsWithExclusion(TAG_ID.LI),t.openElements.popUntilTagNamePopped(TAG_ID.LI))}function ddEndTagInBody(t,e){const s=e.tagID;t.openElements.hasInScope(s)&&(t.openElements.generateImpliedEndTagsWithExclusion(s),t.openElements.popUntilTagNamePopped(s))}function numberedHeaderEndTagInBody(t){t.openElements.hasNumberedHeaderInScope()&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilNumberedHeaderPopped())}function appletEndTagInBody(t,e){const s=e.tagID;t.openElements.hasInScope(s)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(s),t.activeFormattingElements.clearToLastMarker())}function brEndTagInBody(t){t._reconstructActiveFormattingElements(),t._insertFakeElement(TAG_NAMES.BR,TAG_ID.BR),t.openElements.pop(),t.framesetOk=!1}function genericEndTagInBody(t,e){const s=e.tagName,n=e.tagID;for(let r=t.openElements.stackTop;r>0;r--){const a=t.openElements.items[r],i=t.openElements.tagIDs[r];if(n===i&&(n!==TAG_ID.UNKNOWN||t.treeAdapter.getTagName(a)===s)){t.openElements.generateImpliedEndTagsWithExclusion(n),t.openElements.stackTop>=r&&t.openElements.shortenToLength(r);break}if(t._isSpecialElement(a,i))break}}function endTagInBody(t,e){switch(e.tagID){case TAG_ID.A:case TAG_ID.B:case TAG_ID.I:case TAG_ID.S:case TAG_ID.U:case TAG_ID.EM:case TAG_ID.TT:case TAG_ID.BIG:case TAG_ID.CODE:case TAG_ID.FONT:case TAG_ID.NOBR:case TAG_ID.SMALL:case TAG_ID.STRIKE:case TAG_ID.STRONG:{callAdoptionAgency(t,e);break}case TAG_ID.P:{pEndTagInBody(t);break}case TAG_ID.DL:case TAG_ID.UL:case TAG_ID.OL:case TAG_ID.DIR:case TAG_ID.DIV:case TAG_ID.NAV:case TAG_ID.PRE:case TAG_ID.MAIN:case TAG_ID.MENU:case TAG_ID.ASIDE:case TAG_ID.BUTTON:case TAG_ID.CENTER:case TAG_ID.FIGURE:case TAG_ID.FOOTER:case TAG_ID.HEADER:case TAG_ID.HGROUP:case TAG_ID.DIALOG:case TAG_ID.ADDRESS:case TAG_ID.ARTICLE:case TAG_ID.DETAILS:case TAG_ID.SECTION:case TAG_ID.SUMMARY:case TAG_ID.LISTING:case TAG_ID.FIELDSET:case TAG_ID.BLOCKQUOTE:case TAG_ID.FIGCAPTION:{addressEndTagInBody(t,e);break}case TAG_ID.LI:{liEndTagInBody(t);break}case TAG_ID.DD:case TAG_ID.DT:{ddEndTagInBody(t,e);break}case TAG_ID.H1:case TAG_ID.H2:case TAG_ID.H3:case TAG_ID.H4:case TAG_ID.H5:case TAG_ID.H6:{numberedHeaderEndTagInBody(t);break}case TAG_ID.BR:{brEndTagInBody(t);break}case TAG_ID.BODY:{bodyEndTagInBody(t,e);break}case TAG_ID.HTML:{htmlEndTagInBody(t,e);break}case TAG_ID.FORM:{formEndTagInBody(t);break}case TAG_ID.APPLET:case TAG_ID.OBJECT:case TAG_ID.MARQUEE:{appletEndTagInBody(t,e);break}case TAG_ID.TEMPLATE:{templateEndTagInHead(t,e);break}default:genericEndTagInBody(t,e)}}function eofInBody(t,e){t.tmplInsertionModeStack.length>0?eofInTemplate(t,e):stopParsing(t,e)}function endTagInText(t,e){var s;e.tagID===TAG_ID.SCRIPT&&((s=t.scriptHandler)===null||s===void 0||s.call(t,t.openElements.current)),t.openElements.pop(),t.insertionMode=t.originalInsertionMode}function eofInText(t,e){t._err(e,ERR.eofInElementThatCanContainOnlyText),t.openElements.pop(),t.insertionMode=t.originalInsertionMode,t.onEof(e)}function characterInTable(t,e){if(TABLE_STRUCTURE_TAGS.has(t.openElements.currentTagId))switch(t.pendingCharacterTokens.length=0,t.hasNonWhitespacePendingCharacterToken=!1,t.originalInsertionMode=t.insertionMode,t.insertionMode=InsertionMode.IN_TABLE_TEXT,e.type){case TokenType.CHARACTER:{characterInTableText(t,e);break}case TokenType.WHITESPACE_CHARACTER:{whitespaceCharacterInTableText(t,e);break}}else tokenInTable(t,e)}function captionStartTagInTable(t,e){t.openElements.clearBackToTableContext(),t.activeFormattingElements.insertMarker(),t._insertElement(e,NS.HTML),t.insertionMode=InsertionMode.IN_CAPTION}function colgroupStartTagInTable(t,e){t.openElements.clearBackToTableContext(),t._insertElement(e,NS.HTML),t.insertionMode=InsertionMode.IN_COLUMN_GROUP}function colStartTagInTable(t,e){t.openElements.clearBackToTableContext(),t._insertFakeElement(TAG_NAMES.COLGROUP,TAG_ID.COLGROUP),t.insertionMode=InsertionMode.IN_COLUMN_GROUP,startTagInColumnGroup(t,e)}function tbodyStartTagInTable(t,e){t.openElements.clearBackToTableContext(),t._insertElement(e,NS.HTML),t.insertionMode=InsertionMode.IN_TABLE_BODY}function tdStartTagInTable(t,e){t.openElements.clearBackToTableContext(),t._insertFakeElement(TAG_NAMES.TBODY,TAG_ID.TBODY),t.insertionMode=InsertionMode.IN_TABLE_BODY,startTagInTableBody(t,e)}function tableStartTagInTable(t,e){t.openElements.hasInTableScope(TAG_ID.TABLE)&&(t.openElements.popUntilTagNamePopped(TAG_ID.TABLE),t._resetInsertionMode(),t._processStartTag(e))}function inputStartTagInTable(t,e){isHiddenInput(e)?t._appendElement(e,NS.HTML):tokenInTable(t,e),e.ackSelfClosing=!0}function formStartTagInTable(t,e){!t.formElement&&t.openElements.tmplCount===0&&(t._insertElement(e,NS.HTML),t.formElement=t.openElements.current,t.openElements.pop())}function startTagInTable(t,e){switch(e.tagID){case TAG_ID.TD:case TAG_ID.TH:case TAG_ID.TR:{tdStartTagInTable(t,e);break}case TAG_ID.STYLE:case TAG_ID.SCRIPT:case TAG_ID.TEMPLATE:{startTagInHead(t,e);break}case TAG_ID.COL:{colStartTagInTable(t,e);break}case TAG_ID.FORM:{formStartTagInTable(t,e);break}case TAG_ID.TABLE:{tableStartTagInTable(t,e);break}case TAG_ID.TBODY:case TAG_ID.TFOOT:case TAG_ID.THEAD:{tbodyStartTagInTable(t,e);break}case TAG_ID.INPUT:{inputStartTagInTable(t,e);break}case TAG_ID.CAPTION:{captionStartTagInTable(t,e);break}case TAG_ID.COLGROUP:{colgroupStartTagInTable(t,e);break}default:tokenInTable(t,e)}}function endTagInTable(t,e){switch(e.tagID){case TAG_ID.TABLE:{t.openElements.hasInTableScope(TAG_ID.TABLE)&&(t.openElements.popUntilTagNamePopped(TAG_ID.TABLE),t._resetInsertionMode());break}case TAG_ID.TEMPLATE:{templateEndTagInHead(t,e);break}case TAG_ID.BODY:case TAG_ID.CAPTION:case TAG_ID.COL:case TAG_ID.COLGROUP:case TAG_ID.HTML:case TAG_ID.TBODY:case TAG_ID.TD:case TAG_ID.TFOOT:case TAG_ID.TH:case TAG_ID.THEAD:case TAG_ID.TR:break;default:tokenInTable(t,e)}}function tokenInTable(t,e){const s=t.fosterParentingEnabled;t.fosterParentingEnabled=!0,modeInBody(t,e),t.fosterParentingEnabled=s}function whitespaceCharacterInTableText(t,e){t.pendingCharacterTokens.push(e)}function characterInTableText(t,e){t.pendingCharacterTokens.push(e),t.hasNonWhitespacePendingCharacterToken=!0}function tokenInTableText(t,e){let s=0;if(t.hasNonWhitespacePendingCharacterToken)for(;s<t.pendingCharacterTokens.length;s++)tokenInTable(t,t.pendingCharacterTokens[s]);else for(;s<t.pendingCharacterTokens.length;s++)t._insertCharacters(t.pendingCharacterTokens[s]);t.insertionMode=t.originalInsertionMode,t._processToken(e)}const TABLE_VOID_ELEMENTS=new Set([TAG_ID.CAPTION,TAG_ID.COL,TAG_ID.COLGROUP,TAG_ID.TBODY,TAG_ID.TD,TAG_ID.TFOOT,TAG_ID.TH,TAG_ID.THEAD,TAG_ID.TR]);function startTagInCaption(t,e){const s=e.tagID;TABLE_VOID_ELEMENTS.has(s)?t.openElements.hasInTableScope(TAG_ID.CAPTION)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(TAG_ID.CAPTION),t.activeFormattingElements.clearToLastMarker(),t.insertionMode=InsertionMode.IN_TABLE,startTagInTable(t,e)):startTagInBody(t,e)}function endTagInCaption(t,e){const s=e.tagID;switch(s){case TAG_ID.CAPTION:case TAG_ID.TABLE:{t.openElements.hasInTableScope(TAG_ID.CAPTION)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(TAG_ID.CAPTION),t.activeFormattingElements.clearToLastMarker(),t.insertionMode=InsertionMode.IN_TABLE,s===TAG_ID.TABLE&&endTagInTable(t,e));break}case TAG_ID.BODY:case TAG_ID.COL:case TAG_ID.COLGROUP:case TAG_ID.HTML:case TAG_ID.TBODY:case TAG_ID.TD:case TAG_ID.TFOOT:case TAG_ID.TH:case TAG_ID.THEAD:case TAG_ID.TR:break;default:endTagInBody(t,e)}}function startTagInColumnGroup(t,e){switch(e.tagID){case TAG_ID.HTML:{startTagInBody(t,e);break}case TAG_ID.COL:{t._appendElement(e,NS.HTML),e.ackSelfClosing=!0;break}case TAG_ID.TEMPLATE:{startTagInHead(t,e);break}default:tokenInColumnGroup(t,e)}}function endTagInColumnGroup(t,e){switch(e.tagID){case TAG_ID.COLGROUP:{t.openElements.currentTagId===TAG_ID.COLGROUP&&(t.openElements.pop(),t.insertionMode=InsertionMode.IN_TABLE);break}case TAG_ID.TEMPLATE:{templateEndTagInHead(t,e);break}case TAG_ID.COL:break;default:tokenInColumnGroup(t,e)}}function tokenInColumnGroup(t,e){t.openElements.currentTagId===TAG_ID.COLGROUP&&(t.openElements.pop(),t.insertionMode=InsertionMode.IN_TABLE,t._processToken(e))}function startTagInTableBody(t,e){switch(e.tagID){case TAG_ID.TR:{t.openElements.clearBackToTableBodyContext(),t._insertElement(e,NS.HTML),t.insertionMode=InsertionMode.IN_ROW;break}case TAG_ID.TH:case TAG_ID.TD:{t.openElements.clearBackToTableBodyContext(),t._insertFakeElement(TAG_NAMES.TR,TAG_ID.TR),t.insertionMode=InsertionMode.IN_ROW,startTagInRow(t,e);break}case TAG_ID.CAPTION:case TAG_ID.COL:case TAG_ID.COLGROUP:case TAG_ID.TBODY:case TAG_ID.TFOOT:case TAG_ID.THEAD:{t.openElements.hasTableBodyContextInTableScope()&&(t.openElements.clearBackToTableBodyContext(),t.openElements.pop(),t.insertionMode=InsertionMode.IN_TABLE,startTagInTable(t,e));break}default:startTagInTable(t,e)}}function endTagInTableBody(t,e){const s=e.tagID;switch(e.tagID){case TAG_ID.TBODY:case TAG_ID.TFOOT:case TAG_ID.THEAD:{t.openElements.hasInTableScope(s)&&(t.openElements.clearBackToTableBodyContext(),t.openElements.pop(),t.insertionMode=InsertionMode.IN_TABLE);break}case TAG_ID.TABLE:{t.openElements.hasTableBodyContextInTableScope()&&(t.openElements.clearBackToTableBodyContext(),t.openElements.pop(),t.insertionMode=InsertionMode.IN_TABLE,endTagInTable(t,e));break}case TAG_ID.BODY:case TAG_ID.CAPTION:case TAG_ID.COL:case TAG_ID.COLGROUP:case TAG_ID.HTML:case TAG_ID.TD:case TAG_ID.TH:case TAG_ID.TR:break;default:endTagInTable(t,e)}}function startTagInRow(t,e){switch(e.tagID){case TAG_ID.TH:case TAG_ID.TD:{t.openElements.clearBackToTableRowContext(),t._insertElement(e,NS.HTML),t.insertionMode=InsertionMode.IN_CELL,t.activeFormattingElements.insertMarker();break}case TAG_ID.CAPTION:case TAG_ID.COL:case TAG_ID.COLGROUP:case TAG_ID.TBODY:case TAG_ID.TFOOT:case TAG_ID.THEAD:case TAG_ID.TR:{t.openElements.hasInTableScope(TAG_ID.TR)&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=InsertionMode.IN_TABLE_BODY,startTagInTableBody(t,e));break}default:startTagInTable(t,e)}}function endTagInRow(t,e){switch(e.tagID){case TAG_ID.TR:{t.openElements.hasInTableScope(TAG_ID.TR)&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=InsertionMode.IN_TABLE_BODY);break}case TAG_ID.TABLE:{t.openElements.hasInTableScope(TAG_ID.TR)&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=InsertionMode.IN_TABLE_BODY,endTagInTableBody(t,e));break}case TAG_ID.TBODY:case TAG_ID.TFOOT:case TAG_ID.THEAD:{(t.openElements.hasInTableScope(e.tagID)||t.openElements.hasInTableScope(TAG_ID.TR))&&(t.openElements.clearBackToTableRowContext(),t.openElements.pop(),t.insertionMode=InsertionMode.IN_TABLE_BODY,endTagInTableBody(t,e));break}case TAG_ID.BODY:case TAG_ID.CAPTION:case TAG_ID.COL:case TAG_ID.COLGROUP:case TAG_ID.HTML:case TAG_ID.TD:case TAG_ID.TH:break;default:endTagInTable(t,e)}}function startTagInCell(t,e){const s=e.tagID;TABLE_VOID_ELEMENTS.has(s)?(t.openElements.hasInTableScope(TAG_ID.TD)||t.openElements.hasInTableScope(TAG_ID.TH))&&(t._closeTableCell(),startTagInRow(t,e)):startTagInBody(t,e)}function endTagInCell(t,e){const s=e.tagID;switch(s){case TAG_ID.TD:case TAG_ID.TH:{t.openElements.hasInTableScope(s)&&(t.openElements.generateImpliedEndTags(),t.openElements.popUntilTagNamePopped(s),t.activeFormattingElements.clearToLastMarker(),t.insertionMode=InsertionMode.IN_ROW);break}case TAG_ID.TABLE:case TAG_ID.TBODY:case TAG_ID.TFOOT:case TAG_ID.THEAD:case TAG_ID.TR:{t.openElements.hasInTableScope(s)&&(t._closeTableCell(),endTagInRow(t,e));break}case TAG_ID.BODY:case TAG_ID.CAPTION:case TAG_ID.COL:case TAG_ID.COLGROUP:case TAG_ID.HTML:break;default:endTagInBody(t,e)}}function startTagInSelect(t,e){switch(e.tagID){case TAG_ID.HTML:{startTagInBody(t,e);break}case TAG_ID.OPTION:{t.openElements.currentTagId===TAG_ID.OPTION&&t.openElements.pop(),t._insertElement(e,NS.HTML);break}case TAG_ID.OPTGROUP:{t.openElements.currentTagId===TAG_ID.OPTION&&t.openElements.pop(),t.openElements.currentTagId===TAG_ID.OPTGROUP&&t.openElements.pop(),t._insertElement(e,NS.HTML);break}case TAG_ID.INPUT:case TAG_ID.KEYGEN:case TAG_ID.TEXTAREA:case TAG_ID.SELECT:{t.openElements.hasInSelectScope(TAG_ID.SELECT)&&(t.openElements.popUntilTagNamePopped(TAG_ID.SELECT),t._resetInsertionMode(),e.tagID!==TAG_ID.SELECT&&t._processStartTag(e));break}case TAG_ID.SCRIPT:case TAG_ID.TEMPLATE:{startTagInHead(t,e);break}}}function endTagInSelect(t,e){switch(e.tagID){case TAG_ID.OPTGROUP:{t.openElements.stackTop>0&&t.openElements.currentTagId===TAG_ID.OPTION&&t.openElements.tagIDs[t.openElements.stackTop-1]===TAG_ID.OPTGROUP&&t.openElements.pop(),t.openElements.currentTagId===TAG_ID.OPTGROUP&&t.openElements.pop();break}case TAG_ID.OPTION:{t.openElements.currentTagId===TAG_ID.OPTION&&t.openElements.pop();break}case TAG_ID.SELECT:{t.openElements.hasInSelectScope(TAG_ID.SELECT)&&(t.openElements.popUntilTagNamePopped(TAG_ID.SELECT),t._resetInsertionMode());break}case TAG_ID.TEMPLATE:{templateEndTagInHead(t,e);break}}}function startTagInSelectInTable(t,e){const s=e.tagID;s===TAG_ID.CAPTION||s===TAG_ID.TABLE||s===TAG_ID.TBODY||s===TAG_ID.TFOOT||s===TAG_ID.THEAD||s===TAG_ID.TR||s===TAG_ID.TD||s===TAG_ID.TH?(t.openElements.popUntilTagNamePopped(TAG_ID.SELECT),t._resetInsertionMode(),t._processStartTag(e)):startTagInSelect(t,e)}function endTagInSelectInTable(t,e){const s=e.tagID;s===TAG_ID.CAPTION||s===TAG_ID.TABLE||s===TAG_ID.TBODY||s===TAG_ID.TFOOT||s===TAG_ID.THEAD||s===TAG_ID.TR||s===TAG_ID.TD||s===TAG_ID.TH?t.openElements.hasInTableScope(s)&&(t.openElements.popUntilTagNamePopped(TAG_ID.SELECT),t._resetInsertionMode(),t.onEndTag(e)):endTagInSelect(t,e)}function startTagInTemplate(t,e){switch(e.tagID){case TAG_ID.BASE:case TAG_ID.BASEFONT:case TAG_ID.BGSOUND:case TAG_ID.LINK:case TAG_ID.META:case TAG_ID.NOFRAMES:case TAG_ID.SCRIPT:case TAG_ID.STYLE:case TAG_ID.TEMPLATE:case TAG_ID.TITLE:{startTagInHead(t,e);break}case TAG_ID.CAPTION:case TAG_ID.COLGROUP:case TAG_ID.TBODY:case TAG_ID.TFOOT:case TAG_ID.THEAD:{t.tmplInsertionModeStack[0]=InsertionMode.IN_TABLE,t.insertionMode=InsertionMode.IN_TABLE,startTagInTable(t,e);break}case TAG_ID.COL:{t.tmplInsertionModeStack[0]=InsertionMode.IN_COLUMN_GROUP,t.insertionMode=InsertionMode.IN_COLUMN_GROUP,startTagInColumnGroup(t,e);break}case TAG_ID.TR:{t.tmplInsertionModeStack[0]=InsertionMode.IN_TABLE_BODY,t.insertionMode=InsertionMode.IN_TABLE_BODY,startTagInTableBody(t,e);break}case TAG_ID.TD:case TAG_ID.TH:{t.tmplInsertionModeStack[0]=InsertionMode.IN_ROW,t.insertionMode=InsertionMode.IN_ROW,startTagInRow(t,e);break}default:t.tmplInsertionModeStack[0]=InsertionMode.IN_BODY,t.insertionMode=InsertionMode.IN_BODY,startTagInBody(t,e)}}function endTagInTemplate(t,e){e.tagID===TAG_ID.TEMPLATE&&templateEndTagInHead(t,e)}function eofInTemplate(t,e){t.openElements.tmplCount>0?(t.openElements.popUntilTagNamePopped(TAG_ID.TEMPLATE),t.activeFormattingElements.clearToLastMarker(),t.tmplInsertionModeStack.shift(),t._resetInsertionMode(),t.onEof(e)):stopParsing(t,e)}function startTagAfterBody(t,e){e.tagID===TAG_ID.HTML?startTagInBody(t,e):tokenAfterBody(t,e)}function endTagAfterBody(t,e){var s;if(e.tagID===TAG_ID.HTML){if(t.fragmentContext||(t.insertionMode=InsertionMode.AFTER_AFTER_BODY),t.options.sourceCodeLocationInfo&&t.openElements.tagIDs[0]===TAG_ID.HTML){t._setEndLocation(t.openElements.items[0],e);const n=t.openElements.items[1];n&&!(!((s=t.treeAdapter.getNodeSourceCodeLocation(n))===null||s===void 0)&&s.endTag)&&t._setEndLocation(n,e)}}else tokenAfterBody(t,e)}function tokenAfterBody(t,e){t.insertionMode=InsertionMode.IN_BODY,modeInBody(t,e)}function startTagInFrameset(t,e){switch(e.tagID){case TAG_ID.HTML:{startTagInBody(t,e);break}case TAG_ID.FRAMESET:{t._insertElement(e,NS.HTML);break}case TAG_ID.FRAME:{t._appendElement(e,NS.HTML),e.ackSelfClosing=!0;break}case TAG_ID.NOFRAMES:{startTagInHead(t,e);break}}}function endTagInFrameset(t,e){e.tagID===TAG_ID.FRAMESET&&!t.openElements.isRootHtmlElementCurrent()&&(t.openElements.pop(),!t.fragmentContext&&t.openElements.currentTagId!==TAG_ID.FRAMESET&&(t.insertionMode=InsertionMode.AFTER_FRAMESET))}function startTagAfterFrameset(t,e){switch(e.tagID){case TAG_ID.HTML:{startTagInBody(t,e);break}case TAG_ID.NOFRAMES:{startTagInHead(t,e);break}}}function endTagAfterFrameset(t,e){e.tagID===TAG_ID.HTML&&(t.insertionMode=InsertionMode.AFTER_AFTER_FRAMESET)}function startTagAfterAfterBody(t,e){e.tagID===TAG_ID.HTML?startTagInBody(t,e):tokenAfterAfterBody(t,e)}function tokenAfterAfterBody(t,e){t.insertionMode=InsertionMode.IN_BODY,modeInBody(t,e)}function startTagAfterAfterFrameset(t,e){switch(e.tagID){case TAG_ID.HTML:{startTagInBody(t,e);break}case TAG_ID.NOFRAMES:{startTagInHead(t,e);break}}}function nullCharacterInForeignContent(t,e){e.chars=REPLACEMENT_CHARACTER,t._insertCharacters(e)}function characterInForeignContent(t,e){t._insertCharacters(e),t.framesetOk=!1}function popUntilHtmlOrIntegrationPoint(t){for(;t.treeAdapter.getNamespaceURI(t.openElements.current)!==NS.HTML&&!t._isIntegrationPoint(t.openElements.currentTagId,t.openElements.current);)t.openElements.pop()}function startTagInForeignContent(t,e){if(causesExit(e))popUntilHtmlOrIntegrationPoint(t),t._startTagOutsideForeignContent(e);else{const s=t._getAdjustedCurrentElement(),n=t.treeAdapter.getNamespaceURI(s);n===NS.MATHML?adjustTokenMathMLAttrs(e):n===NS.SVG&&(adjustTokenSVGTagName(e),adjustTokenSVGAttrs(e)),adjustTokenXMLAttrs(e),e.selfClosing?t._appendElement(e,n):t._insertElement(e,n),e.ackSelfClosing=!0}}function endTagInForeignContent(t,e){if(e.tagID===TAG_ID.P||e.tagID===TAG_ID.BR){popUntilHtmlOrIntegrationPoint(t),t._endTagOutsideForeignContent(e);return}for(let s=t.openElements.stackTop;s>0;s--){const n=t.openElements.items[s];if(t.treeAdapter.getNamespaceURI(n)===NS.HTML){t._endTagOutsideForeignContent(e);break}const r=t.treeAdapter.getTagName(n);if(r.toLowerCase()===e.tagName){e.tagName=r,t.openElements.shortenToLength(s);break}}}const VOID_ELEMENTS=new Set([TAG_NAMES.AREA,TAG_NAMES.BASE,TAG_NAMES.BASEFONT,TAG_NAMES.BGSOUND,TAG_NAMES.BR,TAG_NAMES.COL,TAG_NAMES.EMBED,TAG_NAMES.FRAME,TAG_NAMES.HR,TAG_NAMES.IMG,TAG_NAMES.INPUT,TAG_NAMES.KEYGEN,TAG_NAMES.LINK,TAG_NAMES.META,TAG_NAMES.PARAM,TAG_NAMES.SOURCE,TAG_NAMES.TRACK,TAG_NAMES.WBR]);function isVoidElement(t,e){return e.treeAdapter.isElementNode(t)&&e.treeAdapter.getNamespaceURI(t)===NS.HTML&&VOID_ELEMENTS.has(e.treeAdapter.getTagName(t))}const defaultOpts={treeAdapter:defaultTreeAdapter,scriptingEnabled:!0};function serializeOuter(t,e){const s={...defaultOpts,...e};return serializeNode(t,s)}function serializeChildNodes(t,e){let s="";const n=e.treeAdapter.isElementNode(t)&&e.treeAdapter.getTagName(t)===TAG_NAMES.TEMPLATE&&e.treeAdapter.getNamespaceURI(t)===NS.HTML?e.treeAdapter.getTemplateContent(t):t,r=e.treeAdapter.getChildNodes(n);if(r)for(const a of r)s+=serializeNode(a,e);return s}function serializeNode(t,e){return e.treeAdapter.isElementNode(t)?serializeElement(t,e):e.treeAdapter.isTextNode(t)?serializeTextNode(t,e):e.treeAdapter.isCommentNode(t)?serializeCommentNode(t,e):e.treeAdapter.isDocumentTypeNode(t)?serializeDocumentTypeNode(t,e):""}function serializeElement(t,e){const s=e.treeAdapter.getTagName(t);return`<${s}${serializeAttributes(t,e)}>${isVoidElement(t,e)?"":`${serializeChildNodes(t,e)}</${s}>`}`}function serializeAttributes(t,{treeAdapter:e}){let s="";for(const n of e.getAttrList(t)){if(s+=" ",!n.namespace)s+=n.name;else switch(n.namespace){case NS.XML:{s+=`xml:${n.name}`;break}case NS.XMLNS:{n.name!=="xmlns"&&(s+="xmlns:"),s+=n.name;break}case NS.XLINK:{s+=`xlink:${n.name}`;break}default:s+=`${n.prefix}:${n.name}`}s+=`="${escapeAttribute(n.value)}"`}return s}function serializeTextNode(t,e){const{treeAdapter:s}=e,n=s.getTextNodeContent(t),r=s.getParentNode(t),a=r&&s.isElementNode(r)&&s.getTagName(r);return a&&s.getNamespaceURI(r)===NS.HTML&&hasUnescapedText(a,e.scriptingEnabled)?n:escapeText(n)}function serializeCommentNode(t,{treeAdapter:e}){return`<!--${e.getCommentNodeContent(t)}-->`}function serializeDocumentTypeNode(t,{treeAdapter:e}){return`<!DOCTYPE ${e.getDocumentTypeNodeName(t)}>`}function parse$1(t,e){return Parser$1.parse(t,e)}function parseFragment(t,e,s){typeof t=="string"&&(s=e,e=t,t=null);const n=Parser$1.getFragmentParser(t,s);return n.tokenizer.write(e,!0),n.getFragment()}function createTextNode(t){return new Text(t)}function enquoteDoctypeId(t){const e=t.includes('"')?"'":'"';return e+t+e}function serializeDoctypeContent(t,e,s){let n="!DOCTYPE ";return t&&(n+=t),e?n+=` PUBLIC ${enquoteDoctypeId(e)}`:s&&(n+=" SYSTEM"),s&&(n+=` ${enquoteDoctypeId(s)}`),n}const adapter={isCommentNode:isComment,isElementNode:isTag,isTextNode:isText,createDocument(){const t=new Document([]);return t["x-mode"]=DOCUMENT_MODE.NO_QUIRKS,t},createDocumentFragment(){return new Document([])},createElement(t,e,s){const n=Object.create(null),r=Object.create(null),a=Object.create(null);for(let u=0;u<s.length;u++){const f=s[u].name;n[f]=s[u].value,r[f]=s[u].namespace,a[f]=s[u].prefix}const i=new Element(t,n,[]);return i.namespace=e,i["x-attribsNamespace"]=r,i["x-attribsPrefix"]=a,i},createCommentNode(t){return new Comment(t)},appendChild(t,e){const s=t.children[t.children.length-1];s&&(s.next=e,e.prev=s),t.children.push(e),e.parent=t},insertBefore(t,e,s){const n=t.children.indexOf(s),{prev:r}=s;r&&(r.next=e,e.prev=r),s.prev=e,e.next=s,t.children.splice(n,0,e),e.parent=t},setTemplateContent(t,e){adapter.appendChild(t,e)},getTemplateContent(t){return t.children[0]},setDocumentType(t,e,s,n){const r=serializeDoctypeContent(e,s,n);let a=t.children.find(i=>isDirective(i)&&i.name==="!doctype");a?a.data=r??null:(a=new ProcessingInstruction("!doctype",r),adapter.appendChild(t,a)),a["x-name"]=e??void 0,a["x-publicId"]=s??void 0,a["x-systemId"]=n??void 0},setDocumentMode(t,e){t["x-mode"]=e},getDocumentMode(t){return t["x-mode"]},detachNode(t){if(t.parent){const e=t.parent.children.indexOf(t),{prev:s,next:n}=t;t.prev=null,t.next=null,s&&(s.next=n),n&&(n.prev=s),t.parent.children.splice(e,1),t.parent=null}},insertText(t,e){const s=t.children[t.children.length-1];s&&isText(s)?s.data+=e:adapter.appendChild(t,createTextNode(e))},insertTextBefore(t,e,s){const n=t.children[t.children.indexOf(s)-1];n&&isText(n)?n.data+=e:adapter.insertBefore(t,createTextNode(e),s)},adoptAttributes(t,e){for(let s=0;s<e.length;s++){const n=e[s].name;typeof t.attribs[n]>"u"&&(t.attribs[n]=e[s].value,t["x-attribsNamespace"][n]=e[s].namespace,t["x-attribsPrefix"][n]=e[s].prefix)}},getFirstChild(t){return t.children[0]},getChildNodes(t){return t.children},getParentNode(t){return t.parent},getAttrList(t){return t.attributes},getTagName(t){return t.name},getNamespaceURI(t){return t.namespace},getTextNodeContent(t){return t.data},getCommentNodeContent(t){return t.data},getDocumentTypeNodeName(t){var e;return(e=t["x-name"])!==null&&e!==void 0?e:""},getDocumentTypeNodePublicId(t){var e;return(e=t["x-publicId"])!==null&&e!==void 0?e:""},getDocumentTypeNodeSystemId(t){var e;return(e=t["x-systemId"])!==null&&e!==void 0?e:""},isDocumentTypeNode(t){return isDirective(t)&&t.name==="!doctype"},setNodeSourceCodeLocation(t,e){e&&(t.startIndex=e.startOffset,t.endIndex=e.endOffset),t.sourceCodeLocation=e},getNodeSourceCodeLocation(t){return t.sourceCodeLocation},updateNodeSourceCodeLocation(t,e){e.endOffset!=null&&(t.endIndex=e.endOffset),t.sourceCodeLocation={...t.sourceCodeLocation,...e}}};function parseWithParse5(t,e,s,n){const r={scriptingEnabled:typeof e.scriptingEnabled=="boolean"?e.scriptingEnabled:!0,treeAdapter:adapter,sourceCodeLocationInfo:e.sourceCodeLocationInfo};return s?parse$1(t,r):parseFragment(n,t,r)}const renderOpts={treeAdapter:adapter};function renderWithParse5(t){const e="length"in t?t:[t];for(let n=0;n<e.length;n+=1){const r=e[n];isDocument(r)&&Array.prototype.splice.call(e,n,1,...r.children)}let s="";for(let n=0;n<e.length;n+=1){const r=e[n];s+=serializeOuter(r,renderOpts)}return s}var CharCodes;(function(t){t[t.Tab=9]="Tab",t[t.NewLine=10]="NewLine",t[t.FormFeed=12]="FormFeed",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.ExclamationMark=33]="ExclamationMark",t[t.Number=35]="Number",t[t.Amp=38]="Amp",t[t.SingleQuote=39]="SingleQuote",t[t.DoubleQuote=34]="DoubleQuote",t[t.Dash=45]="Dash",t[t.Slash=47]="Slash",t[t.Zero=48]="Zero",t[t.Nine=57]="Nine",t[t.Semi=59]="Semi",t[t.Lt=60]="Lt",t[t.Eq=61]="Eq",t[t.Gt=62]="Gt",t[t.Questionmark=63]="Questionmark",t[t.UpperA=65]="UpperA",t[t.LowerA=97]="LowerA",t[t.UpperF=70]="UpperF",t[t.LowerF=102]="LowerF",t[t.UpperZ=90]="UpperZ",t[t.LowerZ=122]="LowerZ",t[t.LowerX=120]="LowerX",t[t.OpeningSquareBracket=91]="OpeningSquareBracket"})(CharCodes||(CharCodes={}));var State;(function(t){t[t.Text=1]="Text",t[t.BeforeTagName=2]="BeforeTagName",t[t.InTagName=3]="InTagName",t[t.InSelfClosingTag=4]="InSelfClosingTag",t[t.BeforeClosingTagName=5]="BeforeClosingTagName",t[t.InClosingTagName=6]="InClosingTagName",t[t.AfterClosingTagName=7]="AfterClosingTagName",t[t.BeforeAttributeName=8]="BeforeAttributeName",t[t.InAttributeName=9]="InAttributeName",t[t.AfterAttributeName=10]="AfterAttributeName",t[t.BeforeAttributeValue=11]="BeforeAttributeValue",t[t.InAttributeValueDq=12]="InAttributeValueDq",t[t.InAttributeValueSq=13]="InAttributeValueSq",t[t.InAttributeValueNq=14]="InAttributeValueNq",t[t.BeforeDeclaration=15]="BeforeDeclaration",t[t.InDeclaration=16]="InDeclaration",t[t.InProcessingInstruction=17]="InProcessingInstruction",t[t.BeforeComment=18]="BeforeComment",t[t.CDATASequence=19]="CDATASequence",t[t.InSpecialComment=20]="InSpecialComment",t[t.InCommentLike=21]="InCommentLike",t[t.BeforeSpecialS=22]="BeforeSpecialS",t[t.SpecialStartSequence=23]="SpecialStartSequence",t[t.InSpecialTag=24]="InSpecialTag",t[t.BeforeEntity=25]="BeforeEntity",t[t.BeforeNumericEntity=26]="BeforeNumericEntity",t[t.InNamedEntity=27]="InNamedEntity",t[t.InNumericEntity=28]="InNumericEntity",t[t.InHexEntity=29]="InHexEntity"})(State||(State={}));function isWhitespace(t){return t===CharCodes.Space||t===CharCodes.NewLine||t===CharCodes.Tab||t===CharCodes.FormFeed||t===CharCodes.CarriageReturn}function isEndOfTagSection(t){return t===CharCodes.Slash||t===CharCodes.Gt||isWhitespace(t)}function isNumber(t){return t>=CharCodes.Zero&&t<=CharCodes.Nine}function isASCIIAlpha(t){return t>=CharCodes.LowerA&&t<=CharCodes.LowerZ||t>=CharCodes.UpperA&&t<=CharCodes.UpperZ}function isHexDigit(t){return t>=CharCodes.UpperA&&t<=CharCodes.UpperF||t>=CharCodes.LowerA&&t<=CharCodes.LowerF}var QuoteType;(function(t){t[t.NoValue=0]="NoValue",t[t.Unquoted=1]="Unquoted",t[t.Single=2]="Single",t[t.Double=3]="Double"})(QuoteType||(QuoteType={}));const Sequences={Cdata:new Uint8Array([67,68,65,84,65,91]),CdataEnd:new Uint8Array([93,93,62]),CommentEnd:new Uint8Array([45,45,62]),ScriptEnd:new Uint8Array([60,47,115,99,114,105,112,116]),StyleEnd:new Uint8Array([60,47,115,116,121,108,101]),TitleEnd:new Uint8Array([60,47,116,105,116,108,101])};class Tokenizer{constructor({xmlMode:e=!1,decodeEntities:s=!0},n){this.cbs=n,this.state=State.Text,this.buffer="",this.sectionStart=0,this.index=0,this.baseState=State.Text,this.isSpecial=!1,this.running=!0,this.offset=0,this.currentSequence=void 0,this.sequenceIndex=0,this.trieIndex=0,this.trieCurrent=0,this.entityResult=0,this.entityExcess=0,this.xmlMode=e,this.decodeEntities=s,this.entityTrie=e?xmlDecodeTree:htmlDecodeTree}reset(){this.state=State.Text,this.buffer="",this.sectionStart=0,this.index=0,this.baseState=State.Text,this.currentSequence=void 0,this.running=!0,this.offset=0}write(e){this.offset+=this.buffer.length,this.buffer=e,this.parse()}end(){this.running&&this.finish()}pause(){this.running=!1}resume(){this.running=!0,this.index<this.buffer.length+this.offset&&this.parse()}getIndex(){return this.index}getSectionStart(){return this.sectionStart}stateText(e){e===CharCodes.Lt||!this.decodeEntities&&this.fastForwardTo(CharCodes.Lt)?(this.index>this.sectionStart&&this.cbs.ontext(this.sectionStart,this.index),this.state=State.BeforeTagName,this.sectionStart=this.index):this.decodeEntities&&e===CharCodes.Amp&&(this.state=State.BeforeEntity)}stateSpecialStartSequence(e){const s=this.sequenceIndex===this.currentSequence.length;if(!(s?isEndOfTagSection(e):(e|32)===this.currentSequence[this.sequenceIndex]))this.isSpecial=!1;else if(!s){this.sequenceIndex++;return}this.sequenceIndex=0,this.state=State.InTagName,this.stateInTagName(e)}stateInSpecialTag(e){if(this.sequenceIndex===this.currentSequence.length){if(e===CharCodes.Gt||isWhitespace(e)){const s=this.index-this.currentSequence.length;if(this.sectionStart<s){const n=this.index;this.index=s,this.cbs.ontext(this.sectionStart,s),this.index=n}this.isSpecial=!1,this.sectionStart=s+2,this.stateInClosingTagName(e);return}this.sequenceIndex=0}(e|32)===this.currentSequence[this.sequenceIndex]?this.sequenceIndex+=1:this.sequenceIndex===0?this.currentSequence===Sequences.TitleEnd?this.decodeEntities&&e===CharCodes.Amp&&(this.state=State.BeforeEntity):this.fastForwardTo(CharCodes.Lt)&&(this.sequenceIndex=1):this.sequenceIndex=+(e===CharCodes.Lt)}stateCDATASequence(e){e===Sequences.Cdata[this.sequenceIndex]?++this.sequenceIndex===Sequences.Cdata.length&&(this.state=State.InCommentLike,this.currentSequence=Sequences.CdataEnd,this.sequenceIndex=0,this.sectionStart=this.index+1):(this.sequenceIndex=0,this.state=State.InDeclaration,this.stateInDeclaration(e))}fastForwardTo(e){for(;++this.index<this.buffer.length+this.offset;)if(this.buffer.charCodeAt(this.index-this.offset)===e)return!0;return this.index=this.buffer.length+this.offset-1,!1}stateInCommentLike(e){e===this.currentSequence[this.sequenceIndex]?++this.sequenceIndex===this.currentSequence.length&&(this.currentSequence===Sequences.CdataEnd?this.cbs.oncdata(this.sectionStart,this.index,2):this.cbs.oncomment(this.sectionStart,this.index,2),this.sequenceIndex=0,this.sectionStart=this.index+1,this.state=State.Text):this.sequenceIndex===0?this.fastForwardTo(this.currentSequence[0])&&(this.sequenceIndex=1):e!==this.currentSequence[this.sequenceIndex-1]&&(this.sequenceIndex=0)}isTagStartChar(e){return this.xmlMode?!isEndOfTagSection(e):isASCIIAlpha(e)}startSpecial(e,s){this.isSpecial=!0,this.currentSequence=e,this.sequenceIndex=s,this.state=State.SpecialStartSequence}stateBeforeTagName(e){if(e===CharCodes.ExclamationMark)this.state=State.BeforeDeclaration,this.sectionStart=this.index+1;else if(e===CharCodes.Questionmark)this.state=State.InProcessingInstruction,this.sectionStart=this.index+1;else if(this.isTagStartChar(e)){const s=e|32;this.sectionStart=this.index,!this.xmlMode&&s===Sequences.TitleEnd[2]?this.startSpecial(Sequences.TitleEnd,3):this.state=!this.xmlMode&&s===Sequences.ScriptEnd[2]?State.BeforeSpecialS:State.InTagName}else e===CharCodes.Slash?this.state=State.BeforeClosingTagName:(this.state=State.Text,this.stateText(e))}stateInTagName(e){isEndOfTagSection(e)&&(this.cbs.onopentagname(this.sectionStart,this.index),this.sectionStart=-1,this.state=State.BeforeAttributeName,this.stateBeforeAttributeName(e))}stateBeforeClosingTagName(e){isWhitespace(e)||(e===CharCodes.Gt?this.state=State.Text:(this.state=this.isTagStartChar(e)?State.InClosingTagName:State.InSpecialComment,this.sectionStart=this.index))}stateInClosingTagName(e){(e===CharCodes.Gt||isWhitespace(e))&&(this.cbs.onclosetag(this.sectionStart,this.index),this.sectionStart=-1,this.state=State.AfterClosingTagName,this.stateAfterClosingTagName(e))}stateAfterClosingTagName(e){(e===CharCodes.Gt||this.fastForwardTo(CharCodes.Gt))&&(this.state=State.Text,this.baseState=State.Text,this.sectionStart=this.index+1)}stateBeforeAttributeName(e){e===CharCodes.Gt?(this.cbs.onopentagend(this.index),this.isSpecial?(this.state=State.InSpecialTag,this.sequenceIndex=0):this.state=State.Text,this.baseState=this.state,this.sectionStart=this.index+1):e===CharCodes.Slash?this.state=State.InSelfClosingTag:isWhitespace(e)||(this.state=State.InAttributeName,this.sectionStart=this.index)}stateInSelfClosingTag(e){e===CharCodes.Gt?(this.cbs.onselfclosingtag(this.index),this.state=State.Text,this.baseState=State.Text,this.sectionStart=this.index+1,this.isSpecial=!1):isWhitespace(e)||(this.state=State.BeforeAttributeName,this.stateBeforeAttributeName(e))}stateInAttributeName(e){(e===CharCodes.Eq||isEndOfTagSection(e))&&(this.cbs.onattribname(this.sectionStart,this.index),this.sectionStart=-1,this.state=State.AfterAttributeName,this.stateAfterAttributeName(e))}stateAfterAttributeName(e){e===CharCodes.Eq?this.state=State.BeforeAttributeValue:e===CharCodes.Slash||e===CharCodes.Gt?(this.cbs.onattribend(QuoteType.NoValue,this.index),this.state=State.BeforeAttributeName,this.stateBeforeAttributeName(e)):isWhitespace(e)||(this.cbs.onattribend(QuoteType.NoValue,this.index),this.state=State.InAttributeName,this.sectionStart=this.index)}stateBeforeAttributeValue(e){e===CharCodes.DoubleQuote?(this.state=State.InAttributeValueDq,this.sectionStart=this.index+1):e===CharCodes.SingleQuote?(this.state=State.InAttributeValueSq,this.sectionStart=this.index+1):isWhitespace(e)||(this.sectionStart=this.index,this.state=State.InAttributeValueNq,this.stateInAttributeValueNoQuotes(e))}handleInAttributeValue(e,s){e===s||!this.decodeEntities&&this.fastForwardTo(s)?(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=-1,this.cbs.onattribend(s===CharCodes.DoubleQuote?QuoteType.Double:QuoteType.Single,this.index),this.state=State.BeforeAttributeName):this.decodeEntities&&e===CharCodes.Amp&&(this.baseState=this.state,this.state=State.BeforeEntity)}stateInAttributeValueDoubleQuotes(e){this.handleInAttributeValue(e,CharCodes.DoubleQuote)}stateInAttributeValueSingleQuotes(e){this.handleInAttributeValue(e,CharCodes.SingleQuote)}stateInAttributeValueNoQuotes(e){isWhitespace(e)||e===CharCodes.Gt?(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=-1,this.cbs.onattribend(QuoteType.Unquoted,this.index),this.state=State.BeforeAttributeName,this.stateBeforeAttributeName(e)):this.decodeEntities&&e===CharCodes.Amp&&(this.baseState=this.state,this.state=State.BeforeEntity)}stateBeforeDeclaration(e){e===CharCodes.OpeningSquareBracket?(this.state=State.CDATASequence,this.sequenceIndex=0):this.state=e===CharCodes.Dash?State.BeforeComment:State.InDeclaration}stateInDeclaration(e){(e===CharCodes.Gt||this.fastForwardTo(CharCodes.Gt))&&(this.cbs.ondeclaration(this.sectionStart,this.index),this.state=State.Text,this.sectionStart=this.index+1)}stateInProcessingInstruction(e){(e===CharCodes.Gt||this.fastForwardTo(CharCodes.Gt))&&(this.cbs.onprocessinginstruction(this.sectionStart,this.index),this.state=State.Text,this.sectionStart=this.index+1)}stateBeforeComment(e){e===CharCodes.Dash?(this.state=State.InCommentLike,this.currentSequence=Sequences.CommentEnd,this.sequenceIndex=2,this.sectionStart=this.index+1):this.state=State.InDeclaration}stateInSpecialComment(e){(e===CharCodes.Gt||this.fastForwardTo(CharCodes.Gt))&&(this.cbs.oncomment(this.sectionStart,this.index,0),this.state=State.Text,this.sectionStart=this.index+1)}stateBeforeSpecialS(e){const s=e|32;s===Sequences.ScriptEnd[3]?this.startSpecial(Sequences.ScriptEnd,4):s===Sequences.StyleEnd[3]?this.startSpecial(Sequences.StyleEnd,4):(this.state=State.InTagName,this.stateInTagName(e))}stateBeforeEntity(e){this.entityExcess=1,this.entityResult=0,e===CharCodes.Number?this.state=State.BeforeNumericEntity:e===CharCodes.Amp||(this.trieIndex=0,this.trieCurrent=this.entityTrie[0],this.state=State.InNamedEntity,this.stateInNamedEntity(e))}stateInNamedEntity(e){if(this.entityExcess+=1,this.trieIndex=determineBranch(this.entityTrie,this.trieCurrent,this.trieIndex+1,e),this.trieIndex<0){this.emitNamedEntity(),this.index--;return}this.trieCurrent=this.entityTrie[this.trieIndex];const s=this.trieCurrent&BinTrieFlags.VALUE_LENGTH;if(s){const n=(s>>14)-1;if(!this.allowLegacyEntity()&&e!==CharCodes.Semi)this.trieIndex+=n;else{const r=this.index-this.entityExcess+1;r>this.sectionStart&&this.emitPartial(this.sectionStart,r),this.entityResult=this.trieIndex,this.trieIndex+=n,this.entityExcess=0,this.sectionStart=this.index+1,n===0&&this.emitNamedEntity()}}}emitNamedEntity(){if(this.state=this.baseState,this.entityResult===0)return;switch((this.entityTrie[this.entityResult]&BinTrieFlags.VALUE_LENGTH)>>14){case 1:{this.emitCodePoint(this.entityTrie[this.entityResult]&~BinTrieFlags.VALUE_LENGTH);break}case 2:{this.emitCodePoint(this.entityTrie[this.entityResult+1]);break}case 3:this.emitCodePoint(this.entityTrie[this.entityResult+1]),this.emitCodePoint(this.entityTrie[this.entityResult+2])}}stateBeforeNumericEntity(e){(e|32)===CharCodes.LowerX?(this.entityExcess++,this.state=State.InHexEntity):(this.state=State.InNumericEntity,this.stateInNumericEntity(e))}emitNumericEntity(e){const s=this.index-this.entityExcess-1;s+2+ +(this.state===State.InHexEntity)!==this.index&&(s>this.sectionStart&&this.emitPartial(this.sectionStart,s),this.sectionStart=this.index+Number(e),this.emitCodePoint(replaceCodePoint(this.entityResult))),this.state=this.baseState}stateInNumericEntity(e){e===CharCodes.Semi?this.emitNumericEntity(!0):isNumber(e)?(this.entityResult=this.entityResult*10+(e-CharCodes.Zero),this.entityExcess++):(this.allowLegacyEntity()?this.emitNumericEntity(!1):this.state=this.baseState,this.index--)}stateInHexEntity(e){e===CharCodes.Semi?this.emitNumericEntity(!0):isNumber(e)?(this.entityResult=this.entityResult*16+(e-CharCodes.Zero),this.entityExcess++):isHexDigit(e)?(this.entityResult=this.entityResult*16+((e|32)-CharCodes.LowerA+10),this.entityExcess++):(this.allowLegacyEntity()?this.emitNumericEntity(!1):this.state=this.baseState,this.index--)}allowLegacyEntity(){return!this.xmlMode&&(this.baseState===State.Text||this.baseState===State.InSpecialTag)}cleanup(){this.running&&this.sectionStart!==this.index&&(this.state===State.Text||this.state===State.InSpecialTag&&this.sequenceIndex===0?(this.cbs.ontext(this.sectionStart,this.index),this.sectionStart=this.index):(this.state===State.InAttributeValueDq||this.state===State.InAttributeValueSq||this.state===State.InAttributeValueNq)&&(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=this.index))}shouldContinue(){return this.index<this.buffer.length+this.offset&&this.running}parse(){for(;this.shouldContinue();){const e=this.buffer.charCodeAt(this.index-this.offset);switch(this.state){case State.Text:{this.stateText(e);break}case State.SpecialStartSequence:{this.stateSpecialStartSequence(e);break}case State.InSpecialTag:{this.stateInSpecialTag(e);break}case State.CDATASequence:{this.stateCDATASequence(e);break}case State.InAttributeValueDq:{this.stateInAttributeValueDoubleQuotes(e);break}case State.InAttributeName:{this.stateInAttributeName(e);break}case State.InCommentLike:{this.stateInCommentLike(e);break}case State.InSpecialComment:{this.stateInSpecialComment(e);break}case State.BeforeAttributeName:{this.stateBeforeAttributeName(e);break}case State.InTagName:{this.stateInTagName(e);break}case State.InClosingTagName:{this.stateInClosingTagName(e);break}case State.BeforeTagName:{this.stateBeforeTagName(e);break}case State.AfterAttributeName:{this.stateAfterAttributeName(e);break}case State.InAttributeValueSq:{this.stateInAttributeValueSingleQuotes(e);break}case State.BeforeAttributeValue:{this.stateBeforeAttributeValue(e);break}case State.BeforeClosingTagName:{this.stateBeforeClosingTagName(e);break}case State.AfterClosingTagName:{this.stateAfterClosingTagName(e);break}case State.BeforeSpecialS:{this.stateBeforeSpecialS(e);break}case State.InAttributeValueNq:{this.stateInAttributeValueNoQuotes(e);break}case State.InSelfClosingTag:{this.stateInSelfClosingTag(e);break}case State.InDeclaration:{this.stateInDeclaration(e);break}case State.BeforeDeclaration:{this.stateBeforeDeclaration(e);break}case State.BeforeComment:{this.stateBeforeComment(e);break}case State.InProcessingInstruction:{this.stateInProcessingInstruction(e);break}case State.InNamedEntity:{this.stateInNamedEntity(e);break}case State.BeforeEntity:{this.stateBeforeEntity(e);break}case State.InHexEntity:{this.stateInHexEntity(e);break}case State.InNumericEntity:{this.stateInNumericEntity(e);break}default:this.stateBeforeNumericEntity(e)}this.index++}this.cleanup()}finish(){this.state===State.InNamedEntity&&this.emitNamedEntity(),this.sectionStart<this.index&&this.handleTrailingData(),this.cbs.onend()}handleTrailingData(){const e=this.buffer.length+this.offset;this.state===State.InCommentLike?this.currentSequence===Sequences.CdataEnd?this.cbs.oncdata(this.sectionStart,e,0):this.cbs.oncomment(this.sectionStart,e,0):this.state===State.InNumericEntity&&this.allowLegacyEntity()?this.emitNumericEntity(!1):this.state===State.InHexEntity&&this.allowLegacyEntity()?this.emitNumericEntity(!1):this.state===State.InTagName||this.state===State.BeforeAttributeName||this.state===State.BeforeAttributeValue||this.state===State.AfterAttributeName||this.state===State.InAttributeName||this.state===State.InAttributeValueSq||this.state===State.InAttributeValueDq||this.state===State.InAttributeValueNq||this.state===State.InClosingTagName||this.cbs.ontext(this.sectionStart,e)}emitPartial(e,s){this.baseState!==State.Text&&this.baseState!==State.InSpecialTag?this.cbs.onattribdata(e,s):this.cbs.ontext(e,s)}emitCodePoint(e){this.baseState!==State.Text&&this.baseState!==State.InSpecialTag?this.cbs.onattribentity(e):this.cbs.ontextentity(e)}}const formTags=new Set(["input","option","optgroup","select","button","datalist","textarea"]),pTag=new Set(["p"]),tableSectionTags=new Set(["thead","tbody"]),ddtTags=new Set(["dd","dt"]),rtpTags=new Set(["rt","rp"]),openImpliesClose=new Map([["tr",new Set(["tr","th","td"])],["th",new Set(["th"])],["td",new Set(["thead","th","td"])],["body",new Set(["head","link","script"])],["li",new Set(["li"])],["p",pTag],["h1",pTag],["h2",pTag],["h3",pTag],["h4",pTag],["h5",pTag],["h6",pTag],["select",formTags],["input",formTags],["output",formTags],["button",formTags],["datalist",formTags],["textarea",formTags],["option",new Set(["option"])],["optgroup",new Set(["optgroup","option"])],["dd",ddtTags],["dt",ddtTags],["address",pTag],["article",pTag],["aside",pTag],["blockquote",pTag],["details",pTag],["div",pTag],["dl",pTag],["fieldset",pTag],["figcaption",pTag],["figure",pTag],["footer",pTag],["form",pTag],["header",pTag],["hr",pTag],["main",pTag],["nav",pTag],["ol",pTag],["pre",pTag],["section",pTag],["table",pTag],["ul",pTag],["rt",rtpTags],["rp",rtpTags],["tbody",tableSectionTags],["tfoot",tableSectionTags]]),voidElements=new Set(["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr"]),foreignContextElements=new Set(["math","svg"]),htmlIntegrationElements=new Set(["mi","mo","mn","ms","mtext","annotation-xml","foreignobject","desc","title"]),reNameEnd=/\s|\//;class Parser{constructor(e,s={}){var n,r,a,i,u;this.options=s,this.startIndex=0,this.endIndex=0,this.openTagStart=0,this.tagname="",this.attribname="",this.attribvalue="",this.attribs=null,this.stack=[],this.foreignContext=[],this.buffers=[],this.bufferOffset=0,this.writeIndex=0,this.ended=!1,this.cbs=e??{},this.lowerCaseTagNames=(n=s.lowerCaseTags)!==null&&n!==void 0?n:!s.xmlMode,this.lowerCaseAttributeNames=(r=s.lowerCaseAttributeNames)!==null&&r!==void 0?r:!s.xmlMode,this.tokenizer=new((a=s.Tokenizer)!==null&&a!==void 0?a:Tokenizer)(this.options,this),(u=(i=this.cbs).onparserinit)===null||u===void 0||u.call(i,this)}ontext(e,s){var n,r;const a=this.getSlice(e,s);this.endIndex=s-1,(r=(n=this.cbs).ontext)===null||r===void 0||r.call(n,a),this.startIndex=s}ontextentity(e){var s,n;const r=this.tokenizer.getSectionStart();this.endIndex=r-1,(n=(s=this.cbs).ontext)===null||n===void 0||n.call(s,fromCodePoint(e)),this.startIndex=r}isVoidElement(e){return!this.options.xmlMode&&voidElements.has(e)}onopentagname(e,s){this.endIndex=s;let n=this.getSlice(e,s);this.lowerCaseTagNames&&(n=n.toLowerCase()),this.emitOpenTag(n)}emitOpenTag(e){var s,n,r,a;this.openTagStart=this.startIndex,this.tagname=e;const i=!this.options.xmlMode&&openImpliesClose.get(e);if(i)for(;this.stack.length>0&&i.has(this.stack[this.stack.length-1]);){const u=this.stack.pop();(n=(s=this.cbs).onclosetag)===null||n===void 0||n.call(s,u,!0)}this.isVoidElement(e)||(this.stack.push(e),foreignContextElements.has(e)?this.foreignContext.push(!0):htmlIntegrationElements.has(e)&&this.foreignContext.push(!1)),(a=(r=this.cbs).onopentagname)===null||a===void 0||a.call(r,e),this.cbs.onopentag&&(this.attribs={})}endOpenTag(e){var s,n;this.startIndex=this.openTagStart,this.attribs&&((n=(s=this.cbs).onopentag)===null||n===void 0||n.call(s,this.tagname,this.attribs,e),this.attribs=null),this.cbs.onclosetag&&this.isVoidElement(this.tagname)&&this.cbs.onclosetag(this.tagname,!0),this.tagname=""}onopentagend(e){this.endIndex=e,this.endOpenTag(!1),this.startIndex=e+1}onclosetag(e,s){var n,r,a,i,u,f;this.endIndex=s;let c=this.getSlice(e,s);if(this.lowerCaseTagNames&&(c=c.toLowerCase()),(foreignContextElements.has(c)||htmlIntegrationElements.has(c))&&this.foreignContext.pop(),this.isVoidElement(c))!this.options.xmlMode&&c==="br"&&((r=(n=this.cbs).onopentagname)===null||r===void 0||r.call(n,"br"),(i=(a=this.cbs).onopentag)===null||i===void 0||i.call(a,"br",{},!0),(f=(u=this.cbs).onclosetag)===null||f===void 0||f.call(u,"br",!1));else{const d=this.stack.lastIndexOf(c);if(d!==-1)if(this.cbs.onclosetag){let h=this.stack.length-d;for(;h--;)this.cbs.onclosetag(this.stack.pop(),h!==0)}else this.stack.length=d;else!this.options.xmlMode&&c==="p"&&(this.emitOpenTag("p"),this.closeCurrentTag(!0))}this.startIndex=s+1}onselfclosingtag(e){this.endIndex=e,this.options.xmlMode||this.options.recognizeSelfClosing||this.foreignContext[this.foreignContext.length-1]?(this.closeCurrentTag(!1),this.startIndex=e+1):this.onopentagend(e)}closeCurrentTag(e){var s,n;const r=this.tagname;this.endOpenTag(e),this.stack[this.stack.length-1]===r&&((n=(s=this.cbs).onclosetag)===null||n===void 0||n.call(s,r,!e),this.stack.pop())}onattribname(e,s){this.startIndex=e;const n=this.getSlice(e,s);this.attribname=this.lowerCaseAttributeNames?n.toLowerCase():n}onattribdata(e,s){this.attribvalue+=this.getSlice(e,s)}onattribentity(e){this.attribvalue+=fromCodePoint(e)}onattribend(e,s){var n,r;this.endIndex=s,(r=(n=this.cbs).onattribute)===null||r===void 0||r.call(n,this.attribname,this.attribvalue,e===QuoteType.Double?'"':e===QuoteType.Single?"'":e===QuoteType.NoValue?void 0:null),this.attribs&&!Object.prototype.hasOwnProperty.call(this.attribs,this.attribname)&&(this.attribs[this.attribname]=this.attribvalue),this.attribvalue=""}getInstructionName(e){const s=e.search(reNameEnd);let n=s<0?e:e.substr(0,s);return this.lowerCaseTagNames&&(n=n.toLowerCase()),n}ondeclaration(e,s){this.endIndex=s;const n=this.getSlice(e,s);if(this.cbs.onprocessinginstruction){const r=this.getInstructionName(n);this.cbs.onprocessinginstruction(`!${r}`,`!${n}`)}this.startIndex=s+1}onprocessinginstruction(e,s){this.endIndex=s;const n=this.getSlice(e,s);if(this.cbs.onprocessinginstruction){const r=this.getInstructionName(n);this.cbs.onprocessinginstruction(`?${r}`,`?${n}`)}this.startIndex=s+1}oncomment(e,s,n){var r,a,i,u;this.endIndex=s,(a=(r=this.cbs).oncomment)===null||a===void 0||a.call(r,this.getSlice(e,s-n)),(u=(i=this.cbs).oncommentend)===null||u===void 0||u.call(i),this.startIndex=s+1}oncdata(e,s,n){var r,a,i,u,f,c,d,h,m,_;this.endIndex=s;const p=this.getSlice(e,s-n);this.options.xmlMode||this.options.recognizeCDATA?((a=(r=this.cbs).oncdatastart)===null||a===void 0||a.call(r),(u=(i=this.cbs).ontext)===null||u===void 0||u.call(i,p),(c=(f=this.cbs).oncdataend)===null||c===void 0||c.call(f)):((h=(d=this.cbs).oncomment)===null||h===void 0||h.call(d,`[CDATA[${p}]]`),(_=(m=this.cbs).oncommentend)===null||_===void 0||_.call(m)),this.startIndex=s+1}onend(){var e,s;if(this.cbs.onclosetag){this.endIndex=this.startIndex;for(let n=this.stack.length;n>0;this.cbs.onclosetag(this.stack[--n],!0));}(s=(e=this.cbs).onend)===null||s===void 0||s.call(e)}reset(){var e,s,n,r;(s=(e=this.cbs).onreset)===null||s===void 0||s.call(e),this.tokenizer.reset(),this.tagname="",this.attribname="",this.attribs=null,this.stack.length=0,this.startIndex=0,this.endIndex=0,(r=(n=this.cbs).onparserinit)===null||r===void 0||r.call(n,this),this.buffers.length=0,this.bufferOffset=0,this.writeIndex=0,this.ended=!1}parseComplete(e){this.reset(),this.end(e)}getSlice(e,s){for(;e-this.bufferOffset>=this.buffers[0].length;)this.shiftBuffer();let n=this.buffers[0].slice(e-this.bufferOffset,s-this.bufferOffset);for(;s-this.bufferOffset>this.buffers[0].length;)this.shiftBuffer(),n+=this.buffers[0].slice(0,s-this.bufferOffset);return n}shiftBuffer(){this.bufferOffset+=this.buffers[0].length,this.writeIndex--,this.buffers.shift()}write(e){var s,n;if(this.ended){(n=(s=this.cbs).onerror)===null||n===void 0||n.call(s,new Error(".write() after done!"));return}this.buffers.push(e),this.tokenizer.running&&(this.tokenizer.write(e),this.writeIndex++)}end(e){var s,n;if(this.ended){(n=(s=this.cbs).onerror)===null||n===void 0||n.call(s,new Error(".end() after done!"));return}e&&this.write(e),this.ended=!0,this.tokenizer.end()}pause(){this.tokenizer.pause()}resume(){for(this.tokenizer.resume();this.tokenizer.running&&this.writeIndex<this.buffers.length;)this.tokenizer.write(this.buffers[this.writeIndex++]);this.ended&&this.tokenizer.end()}parseChunk(e){this.write(e)}done(e){this.end(e)}}function parseDocument(t,e){const s=new DomHandler(void 0,e);return new Parser(s,e).end(t),s.root}const parse=getParse((t,e,s,n)=>e.xmlMode||e._useHtmlParser2?parseDocument(t,e):parseWithParse5(t,e,s,n)),load=getLoad(parse,(t,e)=>e.xmlMode||e._useHtmlParser2?render$1(t,e):renderWithParse5(t));load([]);var Readability$1={exports:{}};(function(t){function e(s,n){if(n&&n.documentElement)s=n,n=arguments[2];else if(!s||!s.documentElement)throw new Error("First argument to Readability constructor should be a document object.");if(n=n||{},this._doc=s,this._docJSDOMParser=this._doc.firstChild.__JSDOMParser__,this._articleTitle=null,this._articleByline=null,this._articleDir=null,this._articleSiteName=null,this._attempts=[],this._debug=!!n.debug,this._maxElemsToParse=n.maxElemsToParse||this.DEFAULT_MAX_ELEMS_TO_PARSE,this._nbTopCandidates=n.nbTopCandidates||this.DEFAULT_N_TOP_CANDIDATES,this._charThreshold=n.charThreshold||this.DEFAULT_CHAR_THRESHOLD,this._classesToPreserve=this.CLASSES_TO_PRESERVE.concat(n.classesToPreserve||[]),this._keepClasses=!!n.keepClasses,this._serializer=n.serializer||function(r){return r.innerHTML},this._disableJSONLD=!!n.disableJSONLD,this._allowedVideoRegex=n.allowedVideoRegex||this.REGEXPS.videos,this._flags=this.FLAG_STRIP_UNLIKELYS|this.FLAG_WEIGHT_CLASSES|this.FLAG_CLEAN_CONDITIONALLY,this._debug){let r=function(a){if(a.nodeType==a.TEXT_NODE)return`${a.nodeName} ("${a.textContent}")`;let i=Array.from(a.attributes||[],function(u){return`${u.name}="${u.value}"`}).join(" ");return`<${a.localName} ${i}>`};this.log=function(){if(typeof console<"u"){let i=Array.from(arguments,u=>u&&u.nodeType==this.ELEMENT_NODE?r(u):u);i.unshift("Reader: (Readability)"),console.log.apply(console,i)}else if(typeof dump<"u"){var a=Array.prototype.map.call(arguments,function(i){return i&&i.nodeName?r(i):i}).join(" ");dump("Reader: (Readability) "+a+`
`)}}}else this.log=function(){}}e.prototype={FLAG_STRIP_UNLIKELYS:1,FLAG_WEIGHT_CLASSES:2,FLAG_CLEAN_CONDITIONALLY:4,ELEMENT_NODE:1,TEXT_NODE:3,DEFAULT_MAX_ELEMS_TO_PARSE:0,DEFAULT_N_TOP_CANDIDATES:5,DEFAULT_TAGS_TO_SCORE:"section,h2,h3,h4,h5,h6,p,td,pre".toUpperCase().split(","),DEFAULT_CHAR_THRESHOLD:500,REGEXPS:{unlikelyCandidates:/-ad-|ai2html|banner|breadcrumbs|combx|comment|community|cover-wrap|disqus|extra|footer|gdpr|header|legends|menu|related|remark|replies|rss|shoutbox|sidebar|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote/i,okMaybeItsACandidate:/and|article|body|column|content|main|shadow/i,positive:/article|body|content|entry|hentry|h-entry|main|page|pagination|post|text|blog|story/i,negative:/-ad-|hidden|^hid$| hid$| hid |^hid |banner|combx|comment|com-|contact|foot|footer|footnote|gdpr|masthead|media|meta|outbrain|promo|related|scroll|share|shoutbox|sidebar|skyscraper|sponsor|shopping|tags|tool|widget/i,extraneous:/print|archive|comment|discuss|e[\-]?mail|share|reply|all|login|sign|single|utility/i,byline:/byline|author|dateline|writtenby|p-author/i,replaceFonts:/<(\/?)font[^>]*>/gi,normalize:/\s{2,}/g,videos:/\/\/(www\.)?((dailymotion|youtube|youtube-nocookie|player\.vimeo|v\.qq)\.com|(archive|upload\.wikimedia)\.org|player\.twitch\.tv)/i,shareElements:/(\b|_)(share|sharedaddy)(\b|_)/i,nextLink:/(next|weiter|continue|>([^\|]|$)|»([^\|]|$))/i,prevLink:/(prev|earl|old|new|<|«)/i,tokenize:/\W+/g,whitespace:/^\s*$/,hasContent:/\S$/,hashUrl:/^#.+/,srcsetUrl:/(\S+)(\s+[\d.]+[xw])?(\s*(?:,|$))/g,b64DataUrl:/^data:\s*([^\s;,]+)\s*;\s*base64\s*,/i,commas:/\u002C|\u060C|\uFE50|\uFE10|\uFE11|\u2E41|\u2E34|\u2E32|\uFF0C/g,jsonLdArticleTypes:/^Article|AdvertiserContentArticle|NewsArticle|AnalysisNewsArticle|AskPublicNewsArticle|BackgroundNewsArticle|OpinionNewsArticle|ReportageNewsArticle|ReviewNewsArticle|Report|SatiricalArticle|ScholarlyArticle|MedicalScholarlyArticle|SocialMediaPosting|BlogPosting|LiveBlogPosting|DiscussionForumPosting|TechArticle|APIReference$/},UNLIKELY_ROLES:["menu","menubar","complementary","navigation","alert","alertdialog","dialog"],DIV_TO_P_ELEMS:new Set(["BLOCKQUOTE","DL","DIV","IMG","OL","P","PRE","TABLE","UL"]),ALTER_TO_DIV_EXCEPTIONS:["DIV","ARTICLE","SECTION","P"],PRESENTATIONAL_ATTRIBUTES:["align","background","bgcolor","border","cellpadding","cellspacing","frame","hspace","rules","style","valign","vspace"],DEPRECATED_SIZE_ATTRIBUTE_ELEMS:["TABLE","TH","TD","HR","PRE"],PHRASING_ELEMS:["ABBR","AUDIO","B","BDO","BR","BUTTON","CITE","CODE","DATA","DATALIST","DFN","EM","EMBED","I","IMG","INPUT","KBD","LABEL","MARK","MATH","METER","NOSCRIPT","OBJECT","OUTPUT","PROGRESS","Q","RUBY","SAMP","SCRIPT","SELECT","SMALL","SPAN","STRONG","SUB","SUP","TEXTAREA","TIME","VAR","WBR"],CLASSES_TO_PRESERVE:["page"],HTML_ESCAPE_MAP:{lt:"<",gt:">",amp:"&",quot:'"',apos:"'"},_postProcessContent:function(s){this._fixRelativeUris(s),this._simplifyNestedElements(s),this._keepClasses||this._cleanClasses(s)},_removeNodes:function(s,n){if(this._docJSDOMParser&&s._isLiveNodeList)throw new Error("Do not pass live node lists to _removeNodes");for(var r=s.length-1;r>=0;r--){var a=s[r],i=a.parentNode;i&&(!n||n.call(this,a,r,s))&&i.removeChild(a)}},_replaceNodeTags:function(s,n){if(this._docJSDOMParser&&s._isLiveNodeList)throw new Error("Do not pass live node lists to _replaceNodeTags");for(const r of s)this._setNodeTag(r,n)},_forEachNode:function(s,n){Array.prototype.forEach.call(s,n,this)},_findNode:function(s,n){return Array.prototype.find.call(s,n,this)},_someNode:function(s,n){return Array.prototype.some.call(s,n,this)},_everyNode:function(s,n){return Array.prototype.every.call(s,n,this)},_concatNodeLists:function(){var s=Array.prototype.slice,n=s.call(arguments),r=n.map(function(a){return s.call(a)});return Array.prototype.concat.apply([],r)},_getAllNodesWithTag:function(s,n){return s.querySelectorAll?s.querySelectorAll(n.join(",")):[].concat.apply([],n.map(function(r){var a=s.getElementsByTagName(r);return Array.isArray(a)?a:Array.from(a)}))},_cleanClasses:function(s){var n=this._classesToPreserve,r=(s.getAttribute("class")||"").split(/\s+/).filter(function(a){return n.indexOf(a)!=-1}).join(" ");for(r?s.setAttribute("class",r):s.removeAttribute("class"),s=s.firstElementChild;s;s=s.nextElementSibling)this._cleanClasses(s)},_fixRelativeUris:function(s){var n=this._doc.baseURI,r=this._doc.documentURI;function a(f){if(n==r&&f.charAt(0)=="#")return f;try{return new URL(f,n).href}catch{}return f}var i=this._getAllNodesWithTag(s,["a"]);this._forEachNode(i,function(f){var c=f.getAttribute("href");if(c)if(c.indexOf("javascript:")===0)if(f.childNodes.length===1&&f.childNodes[0].nodeType===this.TEXT_NODE){var d=this._doc.createTextNode(f.textContent);f.parentNode.replaceChild(d,f)}else{for(var h=this._doc.createElement("span");f.firstChild;)h.appendChild(f.firstChild);f.parentNode.replaceChild(h,f)}else f.setAttribute("href",a(c))});var u=this._getAllNodesWithTag(s,["img","picture","figure","video","audio","source"]);this._forEachNode(u,function(f){var c=f.getAttribute("src"),d=f.getAttribute("poster"),h=f.getAttribute("srcset");if(c&&f.setAttribute("src",a(c)),d&&f.setAttribute("poster",a(d)),h){var m=h.replace(this.REGEXPS.srcsetUrl,function(_,p,b,A){return a(p)+(b||"")+A});f.setAttribute("srcset",m)}})},_simplifyNestedElements:function(s){for(var n=s;n;){if(n.parentNode&&["DIV","SECTION"].includes(n.tagName)&&!(n.id&&n.id.startsWith("readability"))){if(this._isElementWithoutContent(n)){n=this._removeAndGetNext(n);continue}else if(this._hasSingleTagInsideElement(n,"DIV")||this._hasSingleTagInsideElement(n,"SECTION")){for(var r=n.children[0],a=0;a<n.attributes.length;a++)r.setAttribute(n.attributes[a].name,n.attributes[a].value);n.parentNode.replaceChild(r,n),n=r;continue}}n=this._getNextNode(n)}},_getArticleTitle:function(){var s=this._doc,n="",r="";try{n=r=s.title.trim(),typeof n!="string"&&(n=r=this._getInnerText(s.getElementsByTagName("title")[0]))}catch{}var a=!1;function i(m){return m.split(/\s+/).length}if(/ [\|\-\\\/>»] /.test(n))a=/ [\\\/>»] /.test(n),n=r.replace(/(.*)[\|\-\\\/>»] .*/gi,"$1"),i(n)<3&&(n=r.replace(/[^\|\-\\\/>»]*[\|\-\\\/>»](.*)/gi,"$1"));else if(n.indexOf(": ")!==-1){var u=this._concatNodeLists(s.getElementsByTagName("h1"),s.getElementsByTagName("h2")),f=n.trim(),c=this._someNode(u,function(m){return m.textContent.trim()===f});c||(n=r.substring(r.lastIndexOf(":")+1),i(n)<3?n=r.substring(r.indexOf(":")+1):i(r.substr(0,r.indexOf(":")))>5&&(n=r))}else if(n.length>150||n.length<15){var d=s.getElementsByTagName("h1");d.length===1&&(n=this._getInnerText(d[0]))}n=n.trim().replace(this.REGEXPS.normalize," ");var h=i(n);return h<=4&&(!a||h!=i(r.replace(/[\|\-\\\/>»]+/g,""))-1)&&(n=r),n},_prepDocument:function(){var s=this._doc;this._removeNodes(this._getAllNodesWithTag(s,["style"])),s.body&&this._replaceBrs(s.body),this._replaceNodeTags(this._getAllNodesWithTag(s,["font"]),"SPAN")},_nextNode:function(s){for(var n=s;n&&n.nodeType!=this.ELEMENT_NODE&&this.REGEXPS.whitespace.test(n.textContent);)n=n.nextSibling;return n},_replaceBrs:function(s){this._forEachNode(this._getAllNodesWithTag(s,["br"]),function(n){for(var r=n.nextSibling,a=!1;(r=this._nextNode(r))&&r.tagName=="BR";){a=!0;var i=r.nextSibling;r.parentNode.removeChild(r),r=i}if(a){var u=this._doc.createElement("p");for(n.parentNode.replaceChild(u,n),r=u.nextSibling;r;){if(r.tagName=="BR"){var f=this._nextNode(r.nextSibling);if(f&&f.tagName=="BR")break}if(!this._isPhrasingContent(r))break;var c=r.nextSibling;u.appendChild(r),r=c}for(;u.lastChild&&this._isWhitespace(u.lastChild);)u.removeChild(u.lastChild);u.parentNode.tagName==="P"&&this._setNodeTag(u.parentNode,"DIV")}})},_setNodeTag:function(s,n){if(this.log("_setNodeTag",s,n),this._docJSDOMParser)return s.localName=n.toLowerCase(),s.tagName=n.toUpperCase(),s;for(var r=s.ownerDocument.createElement(n);s.firstChild;)r.appendChild(s.firstChild);s.parentNode.replaceChild(r,s),s.readability&&(r.readability=s.readability);for(var a=0;a<s.attributes.length;a++)try{r.setAttribute(s.attributes[a].name,s.attributes[a].value)}catch{}return r},_prepArticle:function(s){this._cleanStyles(s),this._markDataTables(s),this._fixLazyImages(s),this._cleanConditionally(s,"form"),this._cleanConditionally(s,"fieldset"),this._clean(s,"object"),this._clean(s,"embed"),this._clean(s,"footer"),this._clean(s,"link"),this._clean(s,"aside");var n=this.DEFAULT_CHAR_THRESHOLD;this._forEachNode(s.children,function(r){this._cleanMatchedNodes(r,function(a,i){return this.REGEXPS.shareElements.test(i)&&a.textContent.length<n})}),this._clean(s,"iframe"),this._clean(s,"input"),this._clean(s,"textarea"),this._clean(s,"select"),this._clean(s,"button"),this._cleanHeaders(s),this._cleanConditionally(s,"table"),this._cleanConditionally(s,"ul"),this._cleanConditionally(s,"div"),this._replaceNodeTags(this._getAllNodesWithTag(s,["h1"]),"h2"),this._removeNodes(this._getAllNodesWithTag(s,["p"]),function(r){var a=r.getElementsByTagName("img").length,i=r.getElementsByTagName("embed").length,u=r.getElementsByTagName("object").length,f=r.getElementsByTagName("iframe").length,c=a+i+u+f;return c===0&&!this._getInnerText(r,!1)}),this._forEachNode(this._getAllNodesWithTag(s,["br"]),function(r){var a=this._nextNode(r.nextSibling);a&&a.tagName=="P"&&r.parentNode.removeChild(r)}),this._forEachNode(this._getAllNodesWithTag(s,["table"]),function(r){var a=this._hasSingleTagInsideElement(r,"TBODY")?r.firstElementChild:r;if(this._hasSingleTagInsideElement(a,"TR")){var i=a.firstElementChild;if(this._hasSingleTagInsideElement(i,"TD")){var u=i.firstElementChild;u=this._setNodeTag(u,this._everyNode(u.childNodes,this._isPhrasingContent)?"P":"DIV"),r.parentNode.replaceChild(u,r)}}})},_initializeNode:function(s){switch(s.readability={contentScore:0},s.tagName){case"DIV":s.readability.contentScore+=5;break;case"PRE":case"TD":case"BLOCKQUOTE":s.readability.contentScore+=3;break;case"ADDRESS":case"OL":case"UL":case"DL":case"DD":case"DT":case"LI":case"FORM":s.readability.contentScore-=3;break;case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"TH":s.readability.contentScore-=5;break}s.readability.contentScore+=this._getClassWeight(s)},_removeAndGetNext:function(s){var n=this._getNextNode(s,!0);return s.parentNode.removeChild(s),n},_getNextNode:function(s,n){if(!n&&s.firstElementChild)return s.firstElementChild;if(s.nextElementSibling)return s.nextElementSibling;do s=s.parentNode;while(s&&!s.nextElementSibling);return s&&s.nextElementSibling},_textSimilarity:function(s,n){var r=s.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean),a=n.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean);if(!r.length||!a.length)return 0;var i=a.filter(f=>!r.includes(f)),u=i.join(" ").length/a.join(" ").length;return 1-u},_checkByline:function(s,n){if(this._articleByline)return!1;if(s.getAttribute!==void 0)var r=s.getAttribute("rel"),a=s.getAttribute("itemprop");return(r==="author"||a&&a.indexOf("author")!==-1||this.REGEXPS.byline.test(n))&&this._isValidByline(s.textContent)?(this._articleByline=s.textContent.trim(),!0):!1},_getNodeAncestors:function(s,n){n=n||0;for(var r=0,a=[];s.parentNode&&(a.push(s.parentNode),!(n&&++r===n));)s=s.parentNode;return a},_grabArticle:function(s){this.log("**** grabArticle ****");var n=this._doc,r=s!==null;if(s=s||this._doc.body,!s)return this.log("No body found in document. Abort."),null;for(var a=s.innerHTML;;){this.log("Starting grabArticle loop");var i=this._flagIsActive(this.FLAG_STRIP_UNLIKELYS),u=[],f=this._doc.documentElement;let V=!0;for(;f;){f.tagName==="HTML"&&(this._articleLang=f.getAttribute("lang"));var c=f.className+" "+f.id;if(!this._isProbablyVisible(f)){this.log("Removing hidden node - "+c),f=this._removeAndGetNext(f);continue}if(f.getAttribute("aria-modal")=="true"&&f.getAttribute("role")=="dialog"){f=this._removeAndGetNext(f);continue}if(this._checkByline(f,c)){f=this._removeAndGetNext(f);continue}if(V&&this._headerDuplicatesTitle(f)){this.log("Removing header: ",f.textContent.trim(),this._articleTitle.trim()),V=!1,f=this._removeAndGetNext(f);continue}if(i){if(this.REGEXPS.unlikelyCandidates.test(c)&&!this.REGEXPS.okMaybeItsACandidate.test(c)&&!this._hasAncestorTag(f,"table")&&!this._hasAncestorTag(f,"code")&&f.tagName!=="BODY"&&f.tagName!=="A"){this.log("Removing unlikely candidate - "+c),f=this._removeAndGetNext(f);continue}if(this.UNLIKELY_ROLES.includes(f.getAttribute("role"))){this.log("Removing content with role "+f.getAttribute("role")+" - "+c),f=this._removeAndGetNext(f);continue}}if((f.tagName==="DIV"||f.tagName==="SECTION"||f.tagName==="HEADER"||f.tagName==="H1"||f.tagName==="H2"||f.tagName==="H3"||f.tagName==="H4"||f.tagName==="H5"||f.tagName==="H6")&&this._isElementWithoutContent(f)){f=this._removeAndGetNext(f);continue}if(this.DEFAULT_TAGS_TO_SCORE.indexOf(f.tagName)!==-1&&u.push(f),f.tagName==="DIV"){for(var d=null,h=f.firstChild;h;){var m=h.nextSibling;if(this._isPhrasingContent(h))d!==null?d.appendChild(h):this._isWhitespace(h)||(d=n.createElement("p"),f.replaceChild(d,h),d.appendChild(h));else if(d!==null){for(;d.lastChild&&this._isWhitespace(d.lastChild);)d.removeChild(d.lastChild);d=null}h=m}if(this._hasSingleTagInsideElement(f,"P")&&this._getLinkDensity(f)<.25){var _=f.children[0];f.parentNode.replaceChild(_,f),f=_,u.push(f)}else this._hasChildBlockElement(f)||(f=this._setNodeTag(f,"P"),u.push(f))}f=this._getNextNode(f)}var p=[];this._forEachNode(u,function(K){if(!(!K.parentNode||typeof K.parentNode.tagName>"u")){var ue=this._getInnerText(K);if(!(ue.length<25)){var Q=this._getNodeAncestors(K,5);if(Q.length!==0){var J=0;J+=1,J+=ue.split(this.REGEXPS.commas).length,J+=Math.min(Math.floor(ue.length/100),3),this._forEachNode(Q,function(ee,se){if(!(!ee.tagName||!ee.parentNode||typeof ee.parentNode.tagName>"u")){if(typeof ee.readability>"u"&&(this._initializeNode(ee),p.push(ee)),se===0)var ae=1;else se===1?ae=2:ae=se*3;ee.readability.contentScore+=J/ae}})}}}});for(var b=[],A=0,T=p.length;A<T;A+=1){var v=p[A],N=v.readability.contentScore*(1-this._getLinkDensity(v));v.readability.contentScore=N,this.log("Candidate:",v,"with score "+N);for(var x=0;x<this._nbTopCandidates;x++){var y=b[x];if(!y||N>y.readability.contentScore){b.splice(x,0,v),b.length>this._nbTopCandidates&&b.pop();break}}}var S=b[0]||null,D=!1,F;if(S===null||S.tagName==="BODY"){for(S=n.createElement("DIV"),D=!0;s.firstChild;)this.log("Moving child out:",s.firstChild),S.appendChild(s.firstChild);s.appendChild(S),this._initializeNode(S)}else if(S){for(var B=[],W=1;W<b.length;W++)b[W].readability.contentScore/S.readability.contentScore>=.75&&B.push(this._getNodeAncestors(b[W]));var z=3;if(B.length>=z)for(F=S.parentNode;F.tagName!=="BODY";){for(var re=0,X=0;X<B.length&&re<z;X++)re+=Number(B[X].includes(F));if(re>=z){S=F;break}F=F.parentNode}S.readability||this._initializeNode(S),F=S.parentNode;for(var ne=S.readability.contentScore,ie=ne/3;F.tagName!=="BODY";){if(!F.readability){F=F.parentNode;continue}var te=F.readability.contentScore;if(te<ie)break;if(te>ne){S=F;break}ne=F.readability.contentScore,F=F.parentNode}for(F=S.parentNode;F.tagName!="BODY"&&F.children.length==1;)S=F,F=S.parentNode;S.readability||this._initializeNode(S)}var H=n.createElement("DIV");r&&(H.id="readability-content");var P=Math.max(10,S.readability.contentScore*.2);F=S.parentNode;for(var C=F.children,I=0,R=C.length;I<R;I++){var L=C[I],G=!1;if(this.log("Looking at sibling node:",L,L.readability?"with score "+L.readability.contentScore:""),this.log("Sibling has score",L.readability?L.readability.contentScore:"Unknown"),L===S)G=!0;else{var j=0;if(L.className===S.className&&S.className!==""&&(j+=S.readability.contentScore*.2),L.readability&&L.readability.contentScore+j>=P)G=!0;else if(L.nodeName==="P"){var M=this._getLinkDensity(L),E=this._getInnerText(L),w=E.length;(w>80&&M<.25||w<80&&w>0&&M===0&&E.search(/\.( |$)/)!==-1)&&(G=!0)}}G&&(this.log("Appending node:",L),this.ALTER_TO_DIV_EXCEPTIONS.indexOf(L.nodeName)===-1&&(this.log("Altering sibling:",L,"to div."),L=this._setNodeTag(L,"DIV")),H.appendChild(L),C=F.children,I-=1,R-=1)}if(this._debug&&this.log("Article content pre-prep: "+H.innerHTML),this._prepArticle(H),this._debug&&this.log("Article content post-prep: "+H.innerHTML),D)S.id="readability-page-1",S.className="page";else{var O=n.createElement("DIV");for(O.id="readability-page-1",O.className="page";H.firstChild;)O.appendChild(H.firstChild);H.appendChild(O)}this._debug&&this.log("Article content after paging: "+H.innerHTML);var k=!0,U=this._getInnerText(H,!0).length;if(U<this._charThreshold)if(k=!1,s.innerHTML=a,this._flagIsActive(this.FLAG_STRIP_UNLIKELYS))this._removeFlag(this.FLAG_STRIP_UNLIKELYS),this._attempts.push({articleContent:H,textLength:U});else if(this._flagIsActive(this.FLAG_WEIGHT_CLASSES))this._removeFlag(this.FLAG_WEIGHT_CLASSES),this._attempts.push({articleContent:H,textLength:U});else if(this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY))this._removeFlag(this.FLAG_CLEAN_CONDITIONALLY),this._attempts.push({articleContent:H,textLength:U});else{if(this._attempts.push({articleContent:H,textLength:U}),this._attempts.sort(function(K,ue){return ue.textLength-K.textLength}),!this._attempts[0].textLength)return null;H=this._attempts[0].articleContent,k=!0}if(k){var q=[F,S].concat(this._getNodeAncestors(F));return this._someNode(q,function(K){if(!K.tagName)return!1;var ue=K.getAttribute("dir");return ue?(this._articleDir=ue,!0):!1}),H}}},_isValidByline:function(s){return typeof s=="string"||s instanceof String?(s=s.trim(),s.length>0&&s.length<100):!1},_unescapeHtmlEntities:function(s){if(!s)return s;var n=this.HTML_ESCAPE_MAP;return s.replace(/&(quot|amp|apos|lt|gt);/g,function(r,a){return n[a]}).replace(/&#(?:x([0-9a-z]{1,4})|([0-9]{1,4}));/gi,function(r,a,i){var u=parseInt(a||i,a?16:10);return String.fromCharCode(u)})},_getJSONLD:function(s){var n=this._getAllNodesWithTag(s,["script"]),r;return this._forEachNode(n,function(a){if(!r&&a.getAttribute("type")==="application/ld+json")try{var i=a.textContent.replace(/^\s*<!\[CDATA\[|\]\]>\s*$/g,""),u=JSON.parse(i);if(!u["@context"]||!u["@context"].match(/^https?\:\/\/schema\.org$/)||(!u["@type"]&&Array.isArray(u["@graph"])&&(u=u["@graph"].find(function(h){return(h["@type"]||"").match(this.REGEXPS.jsonLdArticleTypes)})),!u||!u["@type"]||!u["@type"].match(this.REGEXPS.jsonLdArticleTypes)))return;if(r={},typeof u.name=="string"&&typeof u.headline=="string"&&u.name!==u.headline){var f=this._getArticleTitle(),c=this._textSimilarity(u.name,f)>.75,d=this._textSimilarity(u.headline,f)>.75;d&&!c?r.title=u.headline:r.title=u.name}else typeof u.name=="string"?r.title=u.name.trim():typeof u.headline=="string"&&(r.title=u.headline.trim());u.author&&(typeof u.author.name=="string"?r.byline=u.author.name.trim():Array.isArray(u.author)&&u.author[0]&&typeof u.author[0].name=="string"&&(r.byline=u.author.filter(function(h){return h&&typeof h.name=="string"}).map(function(h){return h.name.trim()}).join(", "))),typeof u.description=="string"&&(r.excerpt=u.description.trim()),u.publisher&&typeof u.publisher.name=="string"&&(r.siteName=u.publisher.name.trim()),typeof u.datePublished=="string"&&(r.datePublished=u.datePublished.trim());return}catch(h){this.log(h.message)}}),r||{}},_getArticleMetadata:function(s){var n={},r={},a=this._doc.getElementsByTagName("meta"),i=/\s*(article|dc|dcterm|og|twitter)\s*:\s*(author|creator|description|published_time|title|site_name)\s*/gi,u=/^\s*(?:(dc|dcterm|og|twitter|weibo:(article|webpage))\s*[\.:]\s*)?(author|creator|description|title|site_name)\s*$/i;return this._forEachNode(a,function(f){var c=f.getAttribute("name"),d=f.getAttribute("property"),h=f.getAttribute("content");if(h){var m=null,_=null;d&&(m=d.match(i),m&&(_=m[0].toLowerCase().replace(/\s/g,""),r[_]=h.trim())),!m&&c&&u.test(c)&&(_=c,h&&(_=_.toLowerCase().replace(/\s/g,"").replace(/\./g,":"),r[_]=h.trim()))}}),n.title=s.title||r["dc:title"]||r["dcterm:title"]||r["og:title"]||r["weibo:article:title"]||r["weibo:webpage:title"]||r.title||r["twitter:title"],n.title||(n.title=this._getArticleTitle()),n.byline=s.byline||r["dc:creator"]||r["dcterm:creator"]||r.author,n.excerpt=s.excerpt||r["dc:description"]||r["dcterm:description"]||r["og:description"]||r["weibo:article:description"]||r["weibo:webpage:description"]||r.description||r["twitter:description"],n.siteName=s.siteName||r["og:site_name"],n.publishedTime=s.datePublished||r["article:published_time"]||null,n.title=this._unescapeHtmlEntities(n.title),n.byline=this._unescapeHtmlEntities(n.byline),n.excerpt=this._unescapeHtmlEntities(n.excerpt),n.siteName=this._unescapeHtmlEntities(n.siteName),n.publishedTime=this._unescapeHtmlEntities(n.publishedTime),n},_isSingleImage:function(s){return s.tagName==="IMG"?!0:s.children.length!==1||s.textContent.trim()!==""?!1:this._isSingleImage(s.children[0])},_unwrapNoscriptImages:function(s){var n=Array.from(s.getElementsByTagName("img"));this._forEachNode(n,function(a){for(var i=0;i<a.attributes.length;i++){var u=a.attributes[i];switch(u.name){case"src":case"srcset":case"data-src":case"data-srcset":return}if(/\.(jpg|jpeg|png|webp)/i.test(u.value))return}a.parentNode.removeChild(a)});var r=Array.from(s.getElementsByTagName("noscript"));this._forEachNode(r,function(a){var i=s.createElement("div");if(i.innerHTML=a.innerHTML,!!this._isSingleImage(i)){var u=a.previousElementSibling;if(u&&this._isSingleImage(u)){var f=u;f.tagName!=="IMG"&&(f=u.getElementsByTagName("img")[0]);for(var c=i.getElementsByTagName("img")[0],d=0;d<f.attributes.length;d++){var h=f.attributes[d];if(h.value!==""&&(h.name==="src"||h.name==="srcset"||/\.(jpg|jpeg|png|webp)/i.test(h.value))){if(c.getAttribute(h.name)===h.value)continue;var m=h.name;c.hasAttribute(m)&&(m="data-old-"+m),c.setAttribute(m,h.value)}}a.parentNode.replaceChild(i.firstElementChild,u)}}})},_removeScripts:function(s){this._removeNodes(this._getAllNodesWithTag(s,["script","noscript"]))},_hasSingleTagInsideElement:function(s,n){return s.children.length!=1||s.children[0].tagName!==n?!1:!this._someNode(s.childNodes,function(r){return r.nodeType===this.TEXT_NODE&&this.REGEXPS.hasContent.test(r.textContent)})},_isElementWithoutContent:function(s){return s.nodeType===this.ELEMENT_NODE&&s.textContent.trim().length==0&&(s.children.length==0||s.children.length==s.getElementsByTagName("br").length+s.getElementsByTagName("hr").length)},_hasChildBlockElement:function(s){return this._someNode(s.childNodes,function(n){return this.DIV_TO_P_ELEMS.has(n.tagName)||this._hasChildBlockElement(n)})},_isPhrasingContent:function(s){return s.nodeType===this.TEXT_NODE||this.PHRASING_ELEMS.indexOf(s.tagName)!==-1||(s.tagName==="A"||s.tagName==="DEL"||s.tagName==="INS")&&this._everyNode(s.childNodes,this._isPhrasingContent)},_isWhitespace:function(s){return s.nodeType===this.TEXT_NODE&&s.textContent.trim().length===0||s.nodeType===this.ELEMENT_NODE&&s.tagName==="BR"},_getInnerText:function(s,n){n=typeof n>"u"?!0:n;var r=s.textContent.trim();return n?r.replace(this.REGEXPS.normalize," "):r},_getCharCount:function(s,n){return n=n||",",this._getInnerText(s).split(n).length-1},_cleanStyles:function(s){if(!(!s||s.tagName.toLowerCase()==="svg")){for(var n=0;n<this.PRESENTATIONAL_ATTRIBUTES.length;n++)s.removeAttribute(this.PRESENTATIONAL_ATTRIBUTES[n]);this.DEPRECATED_SIZE_ATTRIBUTE_ELEMS.indexOf(s.tagName)!==-1&&(s.removeAttribute("width"),s.removeAttribute("height"));for(var r=s.firstElementChild;r!==null;)this._cleanStyles(r),r=r.nextElementSibling}},_getLinkDensity:function(s){var n=this._getInnerText(s).length;if(n===0)return 0;var r=0;return this._forEachNode(s.getElementsByTagName("a"),function(a){var i=a.getAttribute("href"),u=i&&this.REGEXPS.hashUrl.test(i)?.3:1;r+=this._getInnerText(a).length*u}),r/n},_getClassWeight:function(s){if(!this._flagIsActive(this.FLAG_WEIGHT_CLASSES))return 0;var n=0;return typeof s.className=="string"&&s.className!==""&&(this.REGEXPS.negative.test(s.className)&&(n-=25),this.REGEXPS.positive.test(s.className)&&(n+=25)),typeof s.id=="string"&&s.id!==""&&(this.REGEXPS.negative.test(s.id)&&(n-=25),this.REGEXPS.positive.test(s.id)&&(n+=25)),n},_clean:function(s,n){var r=["object","embed","iframe"].indexOf(n)!==-1;this._removeNodes(this._getAllNodesWithTag(s,[n]),function(a){if(r){for(var i=0;i<a.attributes.length;i++)if(this._allowedVideoRegex.test(a.attributes[i].value))return!1;if(a.tagName==="object"&&this._allowedVideoRegex.test(a.innerHTML))return!1}return!0})},_hasAncestorTag:function(s,n,r,a){r=r||3,n=n.toUpperCase();for(var i=0;s.parentNode;){if(r>0&&i>r)return!1;if(s.parentNode.tagName===n&&(!a||a(s.parentNode)))return!0;s=s.parentNode,i++}return!1},_getRowAndColumnCount:function(s){for(var n=0,r=0,a=s.getElementsByTagName("tr"),i=0;i<a.length;i++){var u=a[i].getAttribute("rowspan")||0;u&&(u=parseInt(u,10)),n+=u||1;for(var f=0,c=a[i].getElementsByTagName("td"),d=0;d<c.length;d++){var h=c[d].getAttribute("colspan")||0;h&&(h=parseInt(h,10)),f+=h||1}r=Math.max(r,f)}return{rows:n,columns:r}},_markDataTables:function(s){for(var n=s.getElementsByTagName("table"),r=0;r<n.length;r++){var a=n[r],i=a.getAttribute("role");if(i=="presentation"){a._readabilityDataTable=!1;continue}var u=a.getAttribute("datatable");if(u=="0"){a._readabilityDataTable=!1;continue}var f=a.getAttribute("summary");if(f){a._readabilityDataTable=!0;continue}var c=a.getElementsByTagName("caption")[0];if(c&&c.childNodes.length>0){a._readabilityDataTable=!0;continue}var d=["col","colgroup","tfoot","thead","th"],h=function(_){return!!a.getElementsByTagName(_)[0]};if(d.some(h)){this.log("Data table because found data-y descendant"),a._readabilityDataTable=!0;continue}if(a.getElementsByTagName("table")[0]){a._readabilityDataTable=!1;continue}var m=this._getRowAndColumnCount(a);if(m.rows>=10||m.columns>4){a._readabilityDataTable=!0;continue}a._readabilityDataTable=m.rows*m.columns>10}},_fixLazyImages:function(s){this._forEachNode(this._getAllNodesWithTag(s,["img","picture","figure"]),function(n){if(n.src&&this.REGEXPS.b64DataUrl.test(n.src)){var r=this.REGEXPS.b64DataUrl.exec(n.src);if(r[1]==="image/svg+xml")return;for(var a=!1,i=0;i<n.attributes.length;i++){var u=n.attributes[i];if(u.name!=="src"&&/\.(jpg|jpeg|png|webp)/i.test(u.value)){a=!0;break}}if(a){var f=n.src.search(/base64\s*/i)+7,c=n.src.length-f;c<133&&n.removeAttribute("src")}}if(!((n.src||n.srcset&&n.srcset!="null")&&n.className.toLowerCase().indexOf("lazy")===-1)){for(var d=0;d<n.attributes.length;d++)if(u=n.attributes[d],!(u.name==="src"||u.name==="srcset"||u.name==="alt")){var h=null;if(/\.(jpg|jpeg|png|webp)\s+\d/.test(u.value)?h="srcset":/^\s*\S+\.(jpg|jpeg|png|webp)\S*\s*$/.test(u.value)&&(h="src"),h){if(n.tagName==="IMG"||n.tagName==="PICTURE")n.setAttribute(h,u.value);else if(n.tagName==="FIGURE"&&!this._getAllNodesWithTag(n,["img","picture"]).length){var m=this._doc.createElement("img");m.setAttribute(h,u.value),n.appendChild(m)}}}}})},_getTextDensity:function(s,n){var r=this._getInnerText(s,!0).length;if(r===0)return 0;var a=0,i=this._getAllNodesWithTag(s,n);return this._forEachNode(i,u=>a+=this._getInnerText(u,!0).length),a/r},_cleanConditionally:function(s,n){this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY)&&this._removeNodes(this._getAllNodesWithTag(s,[n]),function(r){var a=function(F){return F._readabilityDataTable},i=n==="ul"||n==="ol";if(!i){var u=0,f=this._getAllNodesWithTag(r,["ul","ol"]);this._forEachNode(f,F=>u+=this._getInnerText(F).length),i=u/this._getInnerText(r).length>.9}if(n==="table"&&a(r)||this._hasAncestorTag(r,"table",-1,a)||this._hasAncestorTag(r,"code"))return!1;var c=this._getClassWeight(r);this.log("Cleaning Conditionally",r);var d=0;if(c+d<0)return!0;if(this._getCharCount(r,",")<10){for(var h=r.getElementsByTagName("p").length,m=r.getElementsByTagName("img").length,_=r.getElementsByTagName("li").length-100,p=r.getElementsByTagName("input").length,b=this._getTextDensity(r,["h1","h2","h3","h4","h5","h6"]),A=0,T=this._getAllNodesWithTag(r,["object","embed","iframe"]),v=0;v<T.length;v++){for(var N=0;N<T[v].attributes.length;N++)if(this._allowedVideoRegex.test(T[v].attributes[N].value))return!1;if(T[v].tagName==="object"&&this._allowedVideoRegex.test(T[v].innerHTML))return!1;A++}var x=this._getLinkDensity(r),y=this._getInnerText(r).length,S=m>1&&h/m<.5&&!this._hasAncestorTag(r,"figure")||!i&&_>h||p>Math.floor(h/3)||!i&&b<.9&&y<25&&(m===0||m>2)&&!this._hasAncestorTag(r,"figure")||!i&&c<25&&x>.2||c>=25&&x>.5||A===1&&y<75||A>1;if(i&&S){for(var D=0;D<r.children.length;D++)if(r.children[D].children.length>1)return S;let F=r.getElementsByTagName("li").length;if(m==F)return!1}return S}return!1})},_cleanMatchedNodes:function(s,n){for(var r=this._getNextNode(s,!0),a=this._getNextNode(s);a&&a!=r;)n.call(this,a,a.className+" "+a.id)?a=this._removeAndGetNext(a):a=this._getNextNode(a)},_cleanHeaders:function(s){let n=this._getAllNodesWithTag(s,["h1","h2"]);this._removeNodes(n,function(r){let a=this._getClassWeight(r)<0;return a&&this.log("Removing header with low class weight:",r),a})},_headerDuplicatesTitle:function(s){if(s.tagName!="H1"&&s.tagName!="H2")return!1;var n=this._getInnerText(s,!1);return this.log("Evaluating similarity of header:",n,this._articleTitle),this._textSimilarity(this._articleTitle,n)>.75},_flagIsActive:function(s){return(this._flags&s)>0},_removeFlag:function(s){this._flags=this._flags&~s},_isProbablyVisible:function(s){return(!s.style||s.style.display!="none")&&(!s.style||s.style.visibility!="hidden")&&!s.hasAttribute("hidden")&&(!s.hasAttribute("aria-hidden")||s.getAttribute("aria-hidden")!="true"||s.className&&s.className.indexOf&&s.className.indexOf("fallback-image")!==-1)},parse:function(){if(this._maxElemsToParse>0){var s=this._doc.getElementsByTagName("*").length;if(s>this._maxElemsToParse)throw new Error("Aborting parsing document; "+s+" elements found")}this._unwrapNoscriptImages(this._doc);var n=this._disableJSONLD?{}:this._getJSONLD(this._doc);this._removeScripts(this._doc),this._prepDocument();var r=this._getArticleMetadata(n);this._articleTitle=r.title;var a=this._grabArticle();if(!a)return null;if(this.log("Grabbed: "+a.innerHTML),this._postProcessContent(a),!r.excerpt){var i=a.getElementsByTagName("p");i.length>0&&(r.excerpt=i[0].textContent.trim())}var u=a.textContent;return{title:this._articleTitle,byline:r.byline||this._articleByline,dir:this._articleDir,lang:this._articleLang,content:this._serializer(a),textContent:u,length:u.length,excerpt:r.excerpt,siteName:r.siteName||this._articleSiteName,publishedTime:r.publishedTime}}},t.exports=e})(Readability$1);var ReadabilityExports=Readability$1.exports,ReadabilityReaderable={exports:{}};(function(t){var e={unlikelyCandidates:/-ad-|ai2html|banner|breadcrumbs|combx|comment|community|cover-wrap|disqus|extra|footer|gdpr|header|legends|menu|related|remark|replies|rss|shoutbox|sidebar|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote/i,okMaybeItsACandidate:/and|article|body|column|content|main|shadow/i};function s(r){return(!r.style||r.style.display!="none")&&!r.hasAttribute("hidden")&&(!r.hasAttribute("aria-hidden")||r.getAttribute("aria-hidden")!="true"||r.className&&r.className.indexOf&&r.className.indexOf("fallback-image")!==-1)}function n(r,a={}){typeof a=="function"&&(a={visibilityChecker:a});var i={minScore:20,minContentLength:140,visibilityChecker:s};a=Object.assign(i,a);var u=r.querySelectorAll("p, pre, article"),f=r.querySelectorAll("div > br");if(f.length){var c=new Set(u);[].forEach.call(f,function(h){c.add(h.parentNode)}),u=Array.from(c)}var d=0;return[].some.call(u,function(h){if(!a.visibilityChecker(h))return!1;var m=h.className+" "+h.id;if(e.unlikelyCandidates.test(m)&&!e.okMaybeItsACandidate.test(m)||h.matches("li p"))return!1;var _=h.textContent.trim().length;return _<a.minContentLength?!1:(d+=Math.sqrt(_-a.minContentLength),d>a.minScore)})}t.exports=n})(ReadabilityReaderable);var ReadabilityReaderableExports=ReadabilityReaderable.exports,Readability=ReadabilityExports,isProbablyReaderable=ReadabilityReaderableExports,readability={Readability,isProbablyReaderable};function htmlToMarkdown(t){logger$1.debug("开始将 HTML 转换为 Markdown");try{const e=load(t);e('script, style, link, svg, [src^="data:image/"]').remove();const s=e("body").html()||"",n=convertToMarkdown(e,s);return logger$1.debug("HTML 成功转换为 Markdown",{markdownLength:n.length}),n}catch(e){return logger$1.error("HTML 转换为 Markdown 失败",e),"无法转换 HTML 到 Markdown: "+(e instanceof Error?e.message:String(e))}}function convertToMarkdown(t,e){const s=load(e);let n="";return s("body").children().each((r,a)=>{n+=processElement(s,a)+`

`}),cleanMarkdown(n)}function processElement(t,e){const s=e.tagName?.toLowerCase(),n=t(e),r=n.text().trim(),a=n.html()||"";if(!r&&!a)return"";switch(s){case"h1":return`# ${r}`;case"h2":return`## ${r}`;case"h3":return`### ${r}`;case"h4":return`#### ${r}`;case"h5":return`##### ${r}`;case"h6":return`###### ${r}`;case"p":return processInlineElements(t,e);case"ul":return processList(t,e,"*");case"ol":return processList(t,e,"1.");case"blockquote":return processBlockquote(t,e);case"pre":return processCodeBlock(t,e);case"code":return"`"+r+"`";case"a":return processLink(t,e);case"img":return processImage(t,e);case"table":return processTable(t,e);case"br":return`
`;case"hr":return"---";case"div":case"section":case"article":case"main":case"aside":case"header":case"footer":let i="";return n.children().each((u,f)=>{i+=processElement(t,f)+`

`}),i.trim();default:return processInlineElements(t,e)}}function processInlineElements(t,e){let s="";return t(e).children().length?(e.childNodes.forEach(n=>{if(n.type==="text")s+=n.data||"";else if(n.type==="tag"){const r=n.tagName?.toLowerCase(),i=t(n).text();switch(r){case"strong":case"b":s+=`**${i}**`;break;case"em":case"i":s+=`*${i}*`;break;case"code":s+=`\`${i}\``;break;case"a":s+=processLink(t,n);break;case"img":s+=processImage(t,n);break;case"br":s+=`
`;break;default:s+=processElement(t,n)}}}),s):t(e).text()}function processList(t,e,s){let n="";return t(e).children("li").each((r,a)=>{const i=processInlineElements(t,a),u=s==="1."?`${r+1}. `:`${s} `;n+=`${u}${i}
`}),n}function processBlockquote(t,e){return processInlineElements(t,e).split(`
`).map(n=>`> ${n}`).join(`
`)}function processCodeBlock(t,e){return"```\n"+t(e).text()+"\n```"}function processLink(t,e){const s=t(e).attr("href")||"";return`[${t(e).text()||s}](${s})`}function processImage(t,e){const s=t(e).attr("src")||"";return`![${t(e).attr("alt")||""}](${s})`}function processTable(t,e){let s="";const n=t(e).find("th");if(n.length){const r=[];n.each((a,i)=>{r.push(t(i).text().trim())}),s+="| "+r.join(" | ")+` |
`,s+="| "+r.map(()=>"---").join(" | ")+` |
`}return t(e).find("tr").each((r,a)=>{const i=t(a).find("td");if(i.length){const u=[];i.each((f,c)=>{u.push(t(c).text().trim())}),s+="| "+u.join(" | ")+` |
`}}),s}function cleanMarkdown(t){return t.replace(/\n{3,}/g,`

`).trim()}class SimpleDocument{content;$=null;constructor(e){this.content=e,this.$=load(e)}querySelector(e){return this.$.root().find(e).get(0)}querySelectorAll(e){return this.$.root().find(e).get()}getElementsByTagName(e){return this.$.root().find(e).get()}get documentElement(){return{getAttribute:e=>null,getBoundingClientRect:()=>({width:1024,height:768}),className:"",tagName:"HTML"}}get body(){return this.$.root().find("body").get(0)||{}}get head(){return this.$.root().find("head").get(0)||{}}get title(){return this.$.root().find("title").text()||""}get location(){return{href:""}}get documentURI(){return""}get baseURI(){return""}createTreeWalker(){return{currentNode:null,nextNode:()=>null}}createNodeIterator(){return{nextNode:()=>null}}createElement(e){return{tagName:e}}}const defaultExtractContent=t=>{logger$1.debug("开始提取页面内容");try{const e=load(t);try{logger$1.debug("尝试使用 Readability 解析页面");const r=new SimpleDocument(t);if(readability.isProbablyReaderable(r)){logger$1.debug("页面可能适合 Readability 解析");const i=new readability.Readability(r).parse();if(i&&i.content){logger$1.debug("Readability 成功解析页面",{title:i.title,contentLength:i.content.length});const u=htmlToMarkdown(i.content);return logger$1.debug("成功转换为 Markdown",{markdownLength:u.length}),u}}}catch(r){logger$1.warn("Readability 解析失败，将使用备用方法",r)}logger$1.debug("使用备用方法提取内容"),e("script, style, link, svg, [src^='data:image/']").remove(),e("*").each((r,a)=>{if("attribs"in a){const i=a.attribs;for(const u in i)u!=="href"&&u!=="src"&&e(a).removeAttr(u)}});const s=e('[role="main"]').html()||e("main").html()||e("body").html()||"",n=htmlToMarkdown(s);return logger$1.debug("成功转换为 Markdown（备用方法）",{markdownLength:n.length}),n}catch(e){return logger$1.error("提取页面内容失败",e),"无法提取页面内容。错误: "+(e instanceof Error?e.message:String(e))}};function commonjsRequire(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var pdf$1={exports:{}};const __viteBrowserExternal={},__viteBrowserExternal$1=Object.freeze(Object.defineProperty({__proto__:null,default:__viteBrowserExternal},Symbol.toStringTag,{value:"Module"})),require$$0=getAugmentedNamespace(__viteBrowserExternal$1);(function(module,exports){(function(e,s){module.exports=e.pdfjsLib=s()})(globalThis,()=>(()=>{var __webpack_modules__=[,(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.VerbosityLevel=e.Util=e.UnknownErrorException=e.UnexpectedResponseException=e.TextRenderingMode=e.RenderingIntentFlag=e.PromiseCapability=e.PermissionFlag=e.PasswordResponses=e.PasswordException=e.PageActionEventType=e.OPS=e.MissingPDFException=e.MAX_IMAGE_SIZE_TO_CACHE=e.LINE_FACTOR=e.LINE_DESCENT_FACTOR=e.InvalidPDFException=e.ImageKind=e.IDENTITY_MATRIX=e.FormatError=e.FeatureTest=e.FONT_IDENTITY_MATRIX=e.DocumentActionEventType=e.CMapCompressionType=e.BaseException=e.BASELINE_FACTOR=e.AnnotationType=e.AnnotationReplyType=e.AnnotationPrefix=e.AnnotationMode=e.AnnotationFlag=e.AnnotationFieldFlag=e.AnnotationEditorType=e.AnnotationEditorPrefix=e.AnnotationEditorParamsType=e.AnnotationBorderStyleType=e.AnnotationActionEventType=e.AbortException=void 0,e.assert=C,e.bytesToString=q,e.createValidAbsoluteUrl=R,e.getModificationDate=Ae,e.getUuid=Ge,e.getVerbosityLevel=ie,e.info=te,e.isArrayBuffer=ge,e.isArrayEqual=Se,e.isNodeJS=void 0,e.normalizeUnicode=Fe,e.objectFromMap=Q,e.objectSize=ue,e.setVerbosityLevel=ne,e.shadow=L,e.string32=K,e.stringToBytes=V,e.stringToPDFString=he,e.stringToUTF8String=fe,e.unreachable=P,e.utf8StringToString=pe,e.warn=H;const s=typeof process=="object"&&process+""=="[object process]"&&!process.versions.nw&&!(process.versions.electron&&process.type&&process.type!=="browser");e.isNodeJS=s;const n=[1,0,0,1,0,0];e.IDENTITY_MATRIX=n;const r=[.001,0,0,.001,0,0];e.FONT_IDENTITY_MATRIX=r;const a=1e7;e.MAX_IMAGE_SIZE_TO_CACHE=a;const i=1.35;e.LINE_FACTOR=i;const u=.35;e.LINE_DESCENT_FACTOR=u;const f=u/i;e.BASELINE_FACTOR=f;const c={ANY:1,DISPLAY:2,PRINT:4,SAVE:8,ANNOTATIONS_FORMS:16,ANNOTATIONS_STORAGE:32,ANNOTATIONS_DISABLE:64,OPLIST:256};e.RenderingIntentFlag=c;const d={DISABLE:0,ENABLE:1,ENABLE_FORMS:2,ENABLE_STORAGE:3};e.AnnotationMode=d;const h="pdfjs_internal_editor_";e.AnnotationEditorPrefix=h;const m={DISABLE:-1,NONE:0,FREETEXT:3,STAMP:13,INK:15};e.AnnotationEditorType=m;const _={RESIZE:1,CREATE:2,FREETEXT_SIZE:11,FREETEXT_COLOR:12,FREETEXT_OPACITY:13,INK_COLOR:21,INK_THICKNESS:22,INK_OPACITY:23};e.AnnotationEditorParamsType=_;const p={PRINT:4,MODIFY_CONTENTS:8,COPY:16,MODIFY_ANNOTATIONS:32,FILL_INTERACTIVE_FORMS:256,COPY_FOR_ACCESSIBILITY:512,ASSEMBLE:1024,PRINT_HIGH_QUALITY:2048};e.PermissionFlag=p;const b={FILL:0,STROKE:1,FILL_STROKE:2,INVISIBLE:3,FILL_ADD_TO_PATH:4,STROKE_ADD_TO_PATH:5,FILL_STROKE_ADD_TO_PATH:6,ADD_TO_PATH:7,FILL_STROKE_MASK:3,ADD_TO_PATH_FLAG:4};e.TextRenderingMode=b;const A={GRAYSCALE_1BPP:1,RGB_24BPP:2,RGBA_32BPP:3};e.ImageKind=A;const T={TEXT:1,LINK:2,FREETEXT:3,LINE:4,SQUARE:5,CIRCLE:6,POLYGON:7,POLYLINE:8,HIGHLIGHT:9,UNDERLINE:10,SQUIGGLY:11,STRIKEOUT:12,STAMP:13,CARET:14,INK:15,POPUP:16,FILEATTACHMENT:17,SOUND:18,MOVIE:19,WIDGET:20,SCREEN:21,PRINTERMARK:22,TRAPNET:23,WATERMARK:24,THREED:25,REDACT:26};e.AnnotationType=T;const v={GROUP:"Group",REPLY:"R"};e.AnnotationReplyType=v;const N={INVISIBLE:1,HIDDEN:2,PRINT:4,NOZOOM:8,NOROTATE:16,NOVIEW:32,READONLY:64,LOCKED:128,TOGGLENOVIEW:256,LOCKEDCONTENTS:512};e.AnnotationFlag=N;const x={READONLY:1,REQUIRED:2,NOEXPORT:4,MULTILINE:4096,PASSWORD:8192,NOTOGGLETOOFF:16384,RADIO:32768,PUSHBUTTON:65536,COMBO:131072,EDIT:262144,SORT:524288,FILESELECT:1048576,MULTISELECT:2097152,DONOTSPELLCHECK:4194304,DONOTSCROLL:8388608,COMB:16777216,RICHTEXT:33554432,RADIOSINUNISON:33554432,COMMITONSELCHANGE:67108864};e.AnnotationFieldFlag=x;const y={SOLID:1,DASHED:2,BEVELED:3,INSET:4,UNDERLINE:5};e.AnnotationBorderStyleType=y;const S={E:"Mouse Enter",X:"Mouse Exit",D:"Mouse Down",U:"Mouse Up",Fo:"Focus",Bl:"Blur",PO:"PageOpen",PC:"PageClose",PV:"PageVisible",PI:"PageInvisible",K:"Keystroke",F:"Format",V:"Validate",C:"Calculate"};e.AnnotationActionEventType=S;const D={WC:"WillClose",WS:"WillSave",DS:"DidSave",WP:"WillPrint",DP:"DidPrint"};e.DocumentActionEventType=D;const F={O:"PageOpen",C:"PageClose"};e.PageActionEventType=F;const B={ERRORS:0,WARNINGS:1,INFOS:5};e.VerbosityLevel=B;const W={NONE:0,BINARY:1};e.CMapCompressionType=W;const z={dependency:1,setLineWidth:2,setLineCap:3,setLineJoin:4,setMiterLimit:5,setDash:6,setRenderingIntent:7,setFlatness:8,setGState:9,save:10,restore:11,transform:12,moveTo:13,lineTo:14,curveTo:15,curveTo2:16,curveTo3:17,closePath:18,rectangle:19,stroke:20,closeStroke:21,fill:22,eoFill:23,fillStroke:24,eoFillStroke:25,closeFillStroke:26,closeEOFillStroke:27,endPath:28,clip:29,eoClip:30,beginText:31,endText:32,setCharSpacing:33,setWordSpacing:34,setHScale:35,setLeading:36,setFont:37,setTextRenderingMode:38,setTextRise:39,moveText:40,setLeadingMoveText:41,setTextMatrix:42,nextLine:43,showText:44,showSpacedText:45,nextLineShowText:46,nextLineSetSpacingShowText:47,setCharWidth:48,setCharWidthAndBounds:49,setStrokeColorSpace:50,setFillColorSpace:51,setStrokeColor:52,setStrokeColorN:53,setFillColor:54,setFillColorN:55,setStrokeGray:56,setFillGray:57,setStrokeRGBColor:58,setFillRGBColor:59,setStrokeCMYKColor:60,setFillCMYKColor:61,shadingFill:62,beginInlineImage:63,beginImageData:64,endInlineImage:65,paintXObject:66,markPoint:67,markPointProps:68,beginMarkedContent:69,beginMarkedContentProps:70,endMarkedContent:71,beginCompat:72,endCompat:73,paintFormXObjectBegin:74,paintFormXObjectEnd:75,beginGroup:76,endGroup:77,beginAnnotation:80,endAnnotation:81,paintImageMaskXObject:83,paintImageMaskXObjectGroup:84,paintImageXObject:85,paintInlineImageXObject:86,paintInlineImageXObjectGroup:87,paintImageXObjectRepeat:88,paintImageMaskXObjectRepeat:89,paintSolidColorImageMask:90,constructPath:91};e.OPS=z;const re={NEED_PASSWORD:1,INCORRECT_PASSWORD:2};e.PasswordResponses=re;let X=B.WARNINGS;function ne(oe){Number.isInteger(oe)&&(X=oe)}function ie(){return X}function te(oe){X>=B.INFOS&&console.log(`Info: ${oe}`)}function H(oe){X>=B.WARNINGS&&console.log(`Warning: ${oe}`)}function P(oe){throw new Error(oe)}function C(oe,Y){oe||P(Y)}function I(oe){switch(oe?.protocol){case"http:":case"https:":case"ftp:":case"mailto:":case"tel:":return!0;default:return!1}}function R(oe,Y=null,Z=null){if(!oe)return null;try{if(Z&&typeof oe=="string"&&(Z.addDefaultProtocol&&oe.startsWith("www.")&&oe.match(/\./g)?.length>=2&&(oe=`http://${oe}`),Z.tryConvertEncoding))try{oe=fe(oe)}catch{}const le=Y?new URL(oe,Y):new URL(oe);if(I(le))return le}catch{}return null}function L(oe,Y,Z,le=!1){return Object.defineProperty(oe,Y,{value:Z,enumerable:!le,configurable:!0,writable:!1}),Z}const G=function(){function Y(Z,le){this.constructor===Y&&P("Cannot initialize BaseException."),this.message=Z,this.name=le}return Y.prototype=new Error,Y.constructor=Y,Y}();e.BaseException=G;class j extends G{constructor(Y,Z){super(Y,"PasswordException"),this.code=Z}}e.PasswordException=j;class M extends G{constructor(Y,Z){super(Y,"UnknownErrorException"),this.details=Z}}e.UnknownErrorException=M;class E extends G{constructor(Y){super(Y,"InvalidPDFException")}}e.InvalidPDFException=E;class w extends G{constructor(Y){super(Y,"MissingPDFException")}}e.MissingPDFException=w;class O extends G{constructor(Y,Z){super(Y,"UnexpectedResponseException"),this.status=Z}}e.UnexpectedResponseException=O;class k extends G{constructor(Y){super(Y,"FormatError")}}e.FormatError=k;class U extends G{constructor(Y){super(Y,"AbortException")}}e.AbortException=U;function q(oe){(typeof oe!="object"||oe?.length===void 0)&&P("Invalid argument for bytesToString");const Y=oe.length,Z=8192;if(Y<Z)return String.fromCharCode.apply(null,oe);const le=[];for(let me=0;me<Y;me+=Z){const be=Math.min(me+Z,Y),Te=oe.subarray(me,be);le.push(String.fromCharCode.apply(null,Te))}return le.join("")}function V(oe){typeof oe!="string"&&P("Invalid argument for stringToBytes");const Y=oe.length,Z=new Uint8Array(Y);for(let le=0;le<Y;++le)Z[le]=oe.charCodeAt(le)&255;return Z}function K(oe){return String.fromCharCode(oe>>24&255,oe>>16&255,oe>>8&255,oe&255)}function ue(oe){return Object.keys(oe).length}function Q(oe){const Y=Object.create(null);for(const[Z,le]of oe)Y[Z]=le;return Y}function J(){const oe=new Uint8Array(4);return oe[0]=1,new Uint32Array(oe.buffer,0,1)[0]===1}function ee(){try{return new Function(""),!0}catch{return!1}}class se{static get isLittleEndian(){return L(this,"isLittleEndian",J())}static get isEvalSupported(){return L(this,"isEvalSupported",ee())}static get isOffscreenCanvasSupported(){return L(this,"isOffscreenCanvasSupported",typeof OffscreenCanvas<"u")}static get platform(){return typeof navigator>"u"?L(this,"platform",{isWin:!1,isMac:!1}):L(this,"platform",{isWin:navigator.platform.includes("Win"),isMac:navigator.platform.includes("Mac")})}static get isCSSRoundSupported(){return L(this,"isCSSRoundSupported",globalThis.CSS?.supports?.("width: round(1.5px, 1px)"))}}e.FeatureTest=se;const ae=[...Array(256).keys()].map(oe=>oe.toString(16).padStart(2,"0"));class ce{static makeHexColor(Y,Z,le){return`#${ae[Y]}${ae[Z]}${ae[le]}`}static scaleMinMax(Y,Z){let le;Y[0]?(Y[0]<0&&(le=Z[0],Z[0]=Z[1],Z[1]=le),Z[0]*=Y[0],Z[1]*=Y[0],Y[3]<0&&(le=Z[2],Z[2]=Z[3],Z[3]=le),Z[2]*=Y[3],Z[3]*=Y[3]):(le=Z[0],Z[0]=Z[2],Z[2]=le,le=Z[1],Z[1]=Z[3],Z[3]=le,Y[1]<0&&(le=Z[2],Z[2]=Z[3],Z[3]=le),Z[2]*=Y[1],Z[3]*=Y[1],Y[2]<0&&(le=Z[0],Z[0]=Z[1],Z[1]=le),Z[0]*=Y[2],Z[1]*=Y[2]),Z[0]+=Y[4],Z[1]+=Y[4],Z[2]+=Y[5],Z[3]+=Y[5]}static transform(Y,Z){return[Y[0]*Z[0]+Y[2]*Z[1],Y[1]*Z[0]+Y[3]*Z[1],Y[0]*Z[2]+Y[2]*Z[3],Y[1]*Z[2]+Y[3]*Z[3],Y[0]*Z[4]+Y[2]*Z[5]+Y[4],Y[1]*Z[4]+Y[3]*Z[5]+Y[5]]}static applyTransform(Y,Z){const le=Y[0]*Z[0]+Y[1]*Z[2]+Z[4],me=Y[0]*Z[1]+Y[1]*Z[3]+Z[5];return[le,me]}static applyInverseTransform(Y,Z){const le=Z[0]*Z[3]-Z[1]*Z[2],me=(Y[0]*Z[3]-Y[1]*Z[2]+Z[2]*Z[5]-Z[4]*Z[3])/le,be=(-Y[0]*Z[1]+Y[1]*Z[0]+Z[4]*Z[1]-Z[5]*Z[0])/le;return[me,be]}static getAxialAlignedBoundingBox(Y,Z){const le=this.applyTransform(Y,Z),me=this.applyTransform(Y.slice(2,4),Z),be=this.applyTransform([Y[0],Y[3]],Z),Te=this.applyTransform([Y[2],Y[1]],Z);return[Math.min(le[0],me[0],be[0],Te[0]),Math.min(le[1],me[1],be[1],Te[1]),Math.max(le[0],me[0],be[0],Te[0]),Math.max(le[1],me[1],be[1],Te[1])]}static inverseTransform(Y){const Z=Y[0]*Y[3]-Y[1]*Y[2];return[Y[3]/Z,-Y[1]/Z,-Y[2]/Z,Y[0]/Z,(Y[2]*Y[5]-Y[4]*Y[3])/Z,(Y[4]*Y[1]-Y[5]*Y[0])/Z]}static singularValueDecompose2dScale(Y){const Z=[Y[0],Y[2],Y[1],Y[3]],le=Y[0]*Z[0]+Y[1]*Z[2],me=Y[0]*Z[1]+Y[1]*Z[3],be=Y[2]*Z[0]+Y[3]*Z[2],Te=Y[2]*Z[1]+Y[3]*Z[3],Re=(le+Te)/2,Ne=Math.sqrt((le+Te)**2-4*(le*Te-be*me))/2,we=Re+Ne||1,ye=Re-Ne||1;return[Math.sqrt(we),Math.sqrt(ye)]}static normalizeRect(Y){const Z=Y.slice(0);return Y[0]>Y[2]&&(Z[0]=Y[2],Z[2]=Y[0]),Y[1]>Y[3]&&(Z[1]=Y[3],Z[3]=Y[1]),Z}static intersect(Y,Z){const le=Math.max(Math.min(Y[0],Y[2]),Math.min(Z[0],Z[2])),me=Math.min(Math.max(Y[0],Y[2]),Math.max(Z[0],Z[2]));if(le>me)return null;const be=Math.max(Math.min(Y[1],Y[3]),Math.min(Z[1],Z[3])),Te=Math.min(Math.max(Y[1],Y[3]),Math.max(Z[1],Z[3]));return be>Te?null:[le,be,me,Te]}static bezierBoundingBox(Y,Z,le,me,be,Te,Re,Ne){const we=[],ye=[[],[]];let Oe,ve,ke,_e,Me,Le,$e,Be;for(let Ue=0;Ue<2;++Ue){if(Ue===0?(ve=6*Y-12*le+6*be,Oe=-3*Y+9*le-9*be+3*Re,ke=3*le-3*Y):(ve=6*Z-12*me+6*Te,Oe=-3*Z+9*me-9*Te+3*Ne,ke=3*me-3*Z),Math.abs(Oe)<1e-12){if(Math.abs(ve)<1e-12)continue;_e=-ke/ve,0<_e&&_e<1&&we.push(_e);continue}$e=ve*ve-4*ke*Oe,Be=Math.sqrt($e),!($e<0)&&(Me=(-ve+Be)/(2*Oe),0<Me&&Me<1&&we.push(Me),Le=(-ve-Be)/(2*Oe),0<Le&&Le<1&&we.push(Le))}let xe=we.length,Ce;const De=xe;for(;xe--;)_e=we[xe],Ce=1-_e,ye[0][xe]=Ce*Ce*Ce*Y+3*Ce*Ce*_e*le+3*Ce*_e*_e*be+_e*_e*_e*Re,ye[1][xe]=Ce*Ce*Ce*Z+3*Ce*Ce*_e*me+3*Ce*_e*_e*Te+_e*_e*_e*Ne;return ye[0][De]=Y,ye[1][De]=Z,ye[0][De+1]=Re,ye[1][De+1]=Ne,ye[0].length=ye[1].length=De+2,[Math.min(...ye[0]),Math.min(...ye[1]),Math.max(...ye[0]),Math.max(...ye[1])]}}e.Util=ce;const de=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,728,711,710,729,733,731,730,732,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8226,8224,8225,8230,8212,8211,402,8260,8249,8250,8722,8240,8222,8220,8221,8216,8217,8218,8482,64257,64258,321,338,352,376,381,305,322,339,353,382,0,8364];function he(oe){if(oe[0]>="ï"){let Z;if(oe[0]==="þ"&&oe[1]==="ÿ"?Z="utf-16be":oe[0]==="ÿ"&&oe[1]==="þ"?Z="utf-16le":oe[0]==="ï"&&oe[1]==="»"&&oe[2]==="¿"&&(Z="utf-8"),Z)try{const le=new TextDecoder(Z,{fatal:!0}),me=V(oe);return le.decode(me)}catch(le){H(`stringToPDFString: "${le}".`)}}const Y=[];for(let Z=0,le=oe.length;Z<le;Z++){const me=de[oe.charCodeAt(Z)];Y.push(me?String.fromCharCode(me):oe.charAt(Z))}return Y.join("")}function fe(oe){return decodeURIComponent(escape(oe))}function pe(oe){return unescape(encodeURIComponent(oe))}function ge(oe){return typeof oe=="object"&&oe?.byteLength!==void 0}function Se(oe,Y){if(oe.length!==Y.length)return!1;for(let Z=0,le=oe.length;Z<le;Z++)if(oe[Z]!==Y[Z])return!1;return!0}function Ae(oe=new Date){return[oe.getUTCFullYear().toString(),(oe.getUTCMonth()+1).toString().padStart(2,"0"),oe.getUTCDate().toString().padStart(2,"0"),oe.getUTCHours().toString().padStart(2,"0"),oe.getUTCMinutes().toString().padStart(2,"0"),oe.getUTCSeconds().toString().padStart(2,"0")].join("")}class Pe{#e=!1;constructor(){this.promise=new Promise((Y,Z)=>{this.resolve=le=>{this.#e=!0,Y(le)},this.reject=le=>{this.#e=!0,Z(le)}})}get settled(){return this.#e}}e.PromiseCapability=Pe;let Ee=null,Ie=null;function Fe(oe){return Ee||(Ee=/([\u00a0\u00b5\u037e\u0eb3\u2000-\u200a\u202f\u2126\ufb00-\ufb04\ufb06\ufb20-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufba1\ufba4-\ufba9\ufbae-\ufbb1\ufbd3-\ufbdc\ufbde-\ufbe7\ufbea-\ufbf8\ufbfc-\ufbfd\ufc00-\ufc5d\ufc64-\ufcf1\ufcf5-\ufd3d\ufd88\ufdf4\ufdfa-\ufdfb\ufe71\ufe77\ufe79\ufe7b\ufe7d]+)|(\ufb05+)/gu,Ie=new Map([["ﬅ","ſt"]])),oe.replaceAll(Ee,(Y,Z,le)=>Z?Z.normalize("NFKC"):Ie.get(le))}function Ge(){if(typeof crypto<"u"&&typeof crypto?.randomUUID=="function")return crypto.randomUUID();const oe=new Uint8Array(32);if(typeof crypto<"u"&&typeof crypto?.getRandomValues=="function")crypto.getRandomValues(oe);else for(let Y=0;Y<32;Y++)oe[Y]=Math.floor(Math.random()*255);return q(oe)}const He="pdfjs_internal_id_";e.AnnotationPrefix=He},(__unused_webpack_module,exports,__w_pdfjs_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.RenderTask=exports.PDFWorkerUtil=exports.PDFWorker=exports.PDFPageProxy=exports.PDFDocumentProxy=exports.PDFDocumentLoadingTask=exports.PDFDataRangeTransport=exports.LoopbackPort=exports.DefaultStandardFontDataFactory=exports.DefaultFilterFactory=exports.DefaultCanvasFactory=exports.DefaultCMapReaderFactory=void 0,Object.defineProperty(exports,"SVGGraphics",{enumerable:!0,get:function(){return _displaySvg.SVGGraphics}}),exports.build=void 0,exports.getDocument=getDocument,exports.version=void 0;var _util=__w_pdfjs_require__(1),_annotation_storage=__w_pdfjs_require__(3),_display_utils=__w_pdfjs_require__(6),_font_loader=__w_pdfjs_require__(9),_displayNode_utils=__w_pdfjs_require__(10),_canvas=__w_pdfjs_require__(11),_worker_options=__w_pdfjs_require__(14),_message_handler=__w_pdfjs_require__(15),_metadata=__w_pdfjs_require__(16),_optional_content_config=__w_pdfjs_require__(17),_transport_stream=__w_pdfjs_require__(18),_displayFetch_stream=__w_pdfjs_require__(19),_displayNetwork=__w_pdfjs_require__(22),_displayNode_stream=__w_pdfjs_require__(23),_displaySvg=__w_pdfjs_require__(24),_xfa_text=__w_pdfjs_require__(25);const DEFAULT_RANGE_CHUNK_SIZE=65536,RENDERING_CANCELLED_TIMEOUT=100,DELAYED_CLEANUP_TIMEOUT=5e3,DefaultCanvasFactory=_util.isNodeJS?_displayNode_utils.NodeCanvasFactory:_display_utils.DOMCanvasFactory;exports.DefaultCanvasFactory=DefaultCanvasFactory;const DefaultCMapReaderFactory=_util.isNodeJS?_displayNode_utils.NodeCMapReaderFactory:_display_utils.DOMCMapReaderFactory;exports.DefaultCMapReaderFactory=DefaultCMapReaderFactory;const DefaultFilterFactory=_util.isNodeJS?_displayNode_utils.NodeFilterFactory:_display_utils.DOMFilterFactory;exports.DefaultFilterFactory=DefaultFilterFactory;const DefaultStandardFontDataFactory=_util.isNodeJS?_displayNode_utils.NodeStandardFontDataFactory:_display_utils.DOMStandardFontDataFactory;exports.DefaultStandardFontDataFactory=DefaultStandardFontDataFactory;function getDocument(t){if(typeof t=="string"||t instanceof URL?t={url:t}:(0,_util.isArrayBuffer)(t)&&(t={data:t}),typeof t!="object")throw new Error("Invalid parameter in getDocument, need parameter object.");if(!t.url&&!t.data&&!t.range)throw new Error("Invalid parameter object: need either .data, .range or .url");const e=new PDFDocumentLoadingTask,{docId:s}=e,n=t.url?getUrlProp(t.url):null,r=t.data?getDataProp(t.data):null,a=t.httpHeaders||null,i=t.withCredentials===!0,u=t.password??null,f=t.range instanceof PDFDataRangeTransport?t.range:null,c=Number.isInteger(t.rangeChunkSize)&&t.rangeChunkSize>0?t.rangeChunkSize:DEFAULT_RANGE_CHUNK_SIZE;let d=t.worker instanceof PDFWorker?t.worker:null;const h=t.verbosity,m=typeof t.docBaseUrl=="string"&&!(0,_display_utils.isDataScheme)(t.docBaseUrl)?t.docBaseUrl:null,_=typeof t.cMapUrl=="string"?t.cMapUrl:null,p=t.cMapPacked!==!1,b=t.CMapReaderFactory||DefaultCMapReaderFactory,A=typeof t.standardFontDataUrl=="string"?t.standardFontDataUrl:null,T=t.StandardFontDataFactory||DefaultStandardFontDataFactory,v=t.stopAtErrors!==!0,N=Number.isInteger(t.maxImageSize)&&t.maxImageSize>-1?t.maxImageSize:-1,x=t.isEvalSupported!==!1,y=typeof t.isOffscreenCanvasSupported=="boolean"?t.isOffscreenCanvasSupported:!_util.isNodeJS,S=Number.isInteger(t.canvasMaxAreaInBytes)?t.canvasMaxAreaInBytes:-1,D=typeof t.disableFontFace=="boolean"?t.disableFontFace:_util.isNodeJS,F=t.fontExtraProperties===!0,B=t.enableXfa===!0,W=t.ownerDocument||globalThis.document,z=t.disableRange===!0,re=t.disableStream===!0,X=t.disableAutoFetch===!0,ne=t.pdfBug===!0,ie=f?f.length:t.length??NaN,te=typeof t.useSystemFonts=="boolean"?t.useSystemFonts:!_util.isNodeJS&&!D,H=typeof t.useWorkerFetch=="boolean"?t.useWorkerFetch:b===_display_utils.DOMCMapReaderFactory&&T===_display_utils.DOMStandardFontDataFactory&&_&&A&&(0,_display_utils.isValidFetchUrl)(_,document.baseURI)&&(0,_display_utils.isValidFetchUrl)(A,document.baseURI),P=t.canvasFactory||new DefaultCanvasFactory({ownerDocument:W}),C=t.filterFactory||new DefaultFilterFactory({docId:s,ownerDocument:W}),I=null;(0,_util.setVerbosityLevel)(h);const R={canvasFactory:P,filterFactory:C};if(H||(R.cMapReaderFactory=new b({baseUrl:_,isCompressed:p}),R.standardFontDataFactory=new T({baseUrl:A})),!d){const j={verbosity:h,port:_worker_options.GlobalWorkerOptions.workerPort};d=j.port?PDFWorker.fromPort(j):new PDFWorker(j),e._worker=d}const L={docId:s,apiVersion:"3.11.174",data:r,password:u,disableAutoFetch:X,rangeChunkSize:c,length:ie,docBaseUrl:m,enableXfa:B,evaluatorOptions:{maxImageSize:N,disableFontFace:D,ignoreErrors:v,isEvalSupported:x,isOffscreenCanvasSupported:y,canvasMaxAreaInBytes:S,fontExtraProperties:F,useSystemFonts:te,cMapUrl:H?_:null,standardFontDataUrl:H?A:null}},G={ignoreErrors:v,isEvalSupported:x,disableFontFace:D,fontExtraProperties:F,enableXfa:B,ownerDocument:W,disableAutoFetch:X,pdfBug:ne,styleElement:I};return d.promise.then(function(){if(e.destroyed)throw new Error("Loading aborted");const j=_fetchDocument(d,L),M=new Promise(function(E){let w;f?w=new _transport_stream.PDFDataTransportStream({length:ie,initialData:f.initialData,progressiveDone:f.progressiveDone,contentDispositionFilename:f.contentDispositionFilename,disableRange:z,disableStream:re},f):r||(w=(k=>_util.isNodeJS?new _displayNode_stream.PDFNodeStream(k):(0,_display_utils.isValidFetchUrl)(k.url)?new _displayFetch_stream.PDFFetchStream(k):new _displayNetwork.PDFNetworkStream(k))({url:n,length:ie,httpHeaders:a,withCredentials:i,rangeChunkSize:c,disableRange:z,disableStream:re})),E(w)});return Promise.all([j,M]).then(function([E,w]){if(e.destroyed)throw new Error("Loading aborted");const O=new _message_handler.MessageHandler(s,E,d.port),k=new WorkerTransport(O,e,w,G,R);e._transport=k,O.send("Ready",null)})}).catch(e._capability.reject),e}async function _fetchDocument(t,e){if(t.destroyed)throw new Error("Worker was destroyed");const s=await t.messageHandler.sendWithPromise("GetDocRequest",e,e.data?[e.data.buffer]:null);if(t.destroyed)throw new Error("Worker was destroyed");return s}function getUrlProp(t){if(t instanceof URL)return t.href;try{return new URL(t,window.location).href}catch{if(_util.isNodeJS&&typeof t=="string")return t}throw new Error("Invalid PDF url data: either string or URL-object is expected in the url property.")}function getDataProp(t){if(_util.isNodeJS&&typeof Buffer<"u"&&t instanceof Buffer)throw new Error("Please provide binary data as `Uint8Array`, rather than `Buffer`.");if(t instanceof Uint8Array&&t.byteLength===t.buffer.byteLength)return t;if(typeof t=="string")return(0,_util.stringToBytes)(t);if(typeof t=="object"&&!isNaN(t?.length)||(0,_util.isArrayBuffer)(t))return new Uint8Array(t);throw new Error("Invalid PDF binary data: either TypedArray, string, or array-like object is expected in the data property.")}class PDFDocumentLoadingTask{static#e=0;constructor(){this._capability=new _util.PromiseCapability,this._transport=null,this._worker=null,this.docId=`d${PDFDocumentLoadingTask.#e++}`,this.destroyed=!1,this.onPassword=null,this.onProgress=null}get promise(){return this._capability.promise}async destroy(){this.destroyed=!0;try{this._worker?.port&&(this._worker._pendingDestroy=!0),await this._transport?.destroy()}catch(e){throw this._worker?.port&&delete this._worker._pendingDestroy,e}this._transport=null,this._worker&&(this._worker.destroy(),this._worker=null)}}exports.PDFDocumentLoadingTask=PDFDocumentLoadingTask;class PDFDataRangeTransport{constructor(e,s,n=!1,r=null){this.length=e,this.initialData=s,this.progressiveDone=n,this.contentDispositionFilename=r,this._rangeListeners=[],this._progressListeners=[],this._progressiveReadListeners=[],this._progressiveDoneListeners=[],this._readyCapability=new _util.PromiseCapability}addRangeListener(e){this._rangeListeners.push(e)}addProgressListener(e){this._progressListeners.push(e)}addProgressiveReadListener(e){this._progressiveReadListeners.push(e)}addProgressiveDoneListener(e){this._progressiveDoneListeners.push(e)}onDataRange(e,s){for(const n of this._rangeListeners)n(e,s)}onDataProgress(e,s){this._readyCapability.promise.then(()=>{for(const n of this._progressListeners)n(e,s)})}onDataProgressiveRead(e){this._readyCapability.promise.then(()=>{for(const s of this._progressiveReadListeners)s(e)})}onDataProgressiveDone(){this._readyCapability.promise.then(()=>{for(const e of this._progressiveDoneListeners)e()})}transportReady(){this._readyCapability.resolve()}requestDataRange(e,s){(0,_util.unreachable)("Abstract method PDFDataRangeTransport.requestDataRange")}abort(){}}exports.PDFDataRangeTransport=PDFDataRangeTransport;class PDFDocumentProxy{constructor(e,s){this._pdfInfo=e,this._transport=s,Object.defineProperty(this,"getJavaScript",{value:()=>((0,_display_utils.deprecated)("`PDFDocumentProxy.getJavaScript`, please use `PDFDocumentProxy.getJSActions` instead."),this.getJSActions().then(n=>{if(!n)return n;const r=[];for(const a in n)r.push(...n[a]);return r}))})}get annotationStorage(){return this._transport.annotationStorage}get filterFactory(){return this._transport.filterFactory}get numPages(){return this._pdfInfo.numPages}get fingerprints(){return this._pdfInfo.fingerprints}get isPureXfa(){return(0,_util.shadow)(this,"isPureXfa",!!this._transport._htmlForXfa)}get allXfaHtml(){return this._transport._htmlForXfa}getPage(e){return this._transport.getPage(e)}getPageIndex(e){return this._transport.getPageIndex(e)}getDestinations(){return this._transport.getDestinations()}getDestination(e){return this._transport.getDestination(e)}getPageLabels(){return this._transport.getPageLabels()}getPageLayout(){return this._transport.getPageLayout()}getPageMode(){return this._transport.getPageMode()}getViewerPreferences(){return this._transport.getViewerPreferences()}getOpenAction(){return this._transport.getOpenAction()}getAttachments(){return this._transport.getAttachments()}getJSActions(){return this._transport.getDocJSActions()}getOutline(){return this._transport.getOutline()}getOptionalContentConfig(){return this._transport.getOptionalContentConfig()}getPermissions(){return this._transport.getPermissions()}getMetadata(){return this._transport.getMetadata()}getMarkInfo(){return this._transport.getMarkInfo()}getData(){return this._transport.getData()}saveDocument(){return this._transport.saveDocument()}getDownloadInfo(){return this._transport.downloadInfoCapability.promise}cleanup(e=!1){return this._transport.startCleanup(e||this.isPureXfa)}destroy(){return this.loadingTask.destroy()}get loadingParams(){return this._transport.loadingParams}get loadingTask(){return this._transport.loadingTask}getFieldObjects(){return this._transport.getFieldObjects()}hasJSActions(){return this._transport.hasJSActions()}getCalculationOrderIds(){return this._transport.getCalculationOrderIds()}}exports.PDFDocumentProxy=PDFDocumentProxy;class PDFPageProxy{#e=null;#t=!1;constructor(e,s,n,r=!1){this._pageIndex=e,this._pageInfo=s,this._transport=n,this._stats=r?new _display_utils.StatTimer:null,this._pdfBug=r,this.commonObjs=n.commonObjs,this.objs=new PDFObjects,this._maybeCleanupAfterRender=!1,this._intentStates=new Map,this.destroyed=!1}get pageNumber(){return this._pageIndex+1}get rotate(){return this._pageInfo.rotate}get ref(){return this._pageInfo.ref}get userUnit(){return this._pageInfo.userUnit}get view(){return this._pageInfo.view}getViewport({scale:e,rotation:s=this.rotate,offsetX:n=0,offsetY:r=0,dontFlip:a=!1}={}){return new _display_utils.PageViewport({viewBox:this.view,scale:e,rotation:s,offsetX:n,offsetY:r,dontFlip:a})}getAnnotations({intent:e="display"}={}){const s=this._transport.getRenderingIntent(e);return this._transport.getAnnotations(this._pageIndex,s.renderingIntent)}getJSActions(){return this._transport.getPageJSActions(this._pageIndex)}get filterFactory(){return this._transport.filterFactory}get isPureXfa(){return(0,_util.shadow)(this,"isPureXfa",!!this._transport._htmlForXfa)}async getXfa(){return this._transport._htmlForXfa?.children[this._pageIndex]||null}render({canvasContext:e,viewport:s,intent:n="display",annotationMode:r=_util.AnnotationMode.ENABLE,transform:a=null,background:i=null,optionalContentConfigPromise:u=null,annotationCanvasMap:f=null,pageColors:c=null,printAnnotationStorage:d=null}){this._stats?.time("Overall");const h=this._transport.getRenderingIntent(n,r,d);this.#t=!1,this.#n(),u||(u=this._transport.getOptionalContentConfig());let m=this._intentStates.get(h.cacheKey);m||(m=Object.create(null),this._intentStates.set(h.cacheKey,m)),m.streamReaderCancelTimeout&&(clearTimeout(m.streamReaderCancelTimeout),m.streamReaderCancelTimeout=null);const _=!!(h.renderingIntent&_util.RenderingIntentFlag.PRINT);m.displayReadyCapability||(m.displayReadyCapability=new _util.PromiseCapability,m.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(h));const p=T=>{m.renderTasks.delete(b),(this._maybeCleanupAfterRender||_)&&(this.#t=!0),this.#s(!_),T?(b.capability.reject(T),this._abortOperatorList({intentState:m,reason:T instanceof Error?T:new Error(T)})):b.capability.resolve(),this._stats?.timeEnd("Rendering"),this._stats?.timeEnd("Overall")},b=new InternalRenderTask({callback:p,params:{canvasContext:e,viewport:s,transform:a,background:i},objs:this.objs,commonObjs:this.commonObjs,annotationCanvasMap:f,operatorList:m.operatorList,pageIndex:this._pageIndex,canvasFactory:this._transport.canvasFactory,filterFactory:this._transport.filterFactory,useRequestAnimationFrame:!_,pdfBug:this._pdfBug,pageColors:c});(m.renderTasks||=new Set).add(b);const A=b.task;return Promise.all([m.displayReadyCapability.promise,u]).then(([T,v])=>{if(this.destroyed){p();return}this._stats?.time("Rendering"),b.initializeGraphics({transparency:T,optionalContentConfig:v}),b.operatorListChanged()}).catch(p),A}getOperatorList({intent:e="display",annotationMode:s=_util.AnnotationMode.ENABLE,printAnnotationStorage:n=null}={}){function r(){i.operatorList.lastChunk&&(i.opListReadCapability.resolve(i.operatorList),i.renderTasks.delete(u))}const a=this._transport.getRenderingIntent(e,s,n,!0);let i=this._intentStates.get(a.cacheKey);i||(i=Object.create(null),this._intentStates.set(a.cacheKey,i));let u;return i.opListReadCapability||(u=Object.create(null),u.operatorListChanged=r,i.opListReadCapability=new _util.PromiseCapability,(i.renderTasks||=new Set).add(u),i.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(a)),i.opListReadCapability.promise}streamTextContent({includeMarkedContent:e=!1,disableNormalization:s=!1}={}){return this._transport.messageHandler.sendWithStream("GetTextContent",{pageIndex:this._pageIndex,includeMarkedContent:e===!0,disableNormalization:s===!0},{highWaterMark:100,size(r){return r.items.length}})}getTextContent(e={}){if(this._transport._htmlForXfa)return this.getXfa().then(n=>_xfa_text.XfaText.textContent(n));const s=this.streamTextContent(e);return new Promise(function(n,r){function a(){i.read().then(function({value:f,done:c}){if(c){n(u);return}Object.assign(u.styles,f.styles),u.items.push(...f.items),a()},r)}const i=s.getReader(),u={items:[],styles:Object.create(null)};a()})}getStructTree(){return this._transport.getStructTree(this._pageIndex)}_destroy(){this.destroyed=!0;const e=[];for(const s of this._intentStates.values())if(this._abortOperatorList({intentState:s,reason:new Error("Page was destroyed."),force:!0}),!s.opListReadCapability)for(const n of s.renderTasks)e.push(n.completed),n.cancel();return this.objs.clear(),this.#t=!1,this.#n(),Promise.all(e)}cleanup(e=!1){this.#t=!0;const s=this.#s(!1);return e&&s&&(this._stats&&=new _display_utils.StatTimer),s}#s(e=!1){if(this.#n(),!this.#t||this.destroyed)return!1;if(e)return this.#e=setTimeout(()=>{this.#e=null,this.#s(!1)},DELAYED_CLEANUP_TIMEOUT),!1;for(const{renderTasks:s,operatorList:n}of this._intentStates.values())if(s.size>0||!n.lastChunk)return!1;return this._intentStates.clear(),this.objs.clear(),this.#t=!1,!0}#n(){this.#e&&(clearTimeout(this.#e),this.#e=null)}_startRenderPage(e,s){const n=this._intentStates.get(s);n&&(this._stats?.timeEnd("Page Request"),n.displayReadyCapability?.resolve(e))}_renderPageChunk(e,s){for(let n=0,r=e.length;n<r;n++)s.operatorList.fnArray.push(e.fnArray[n]),s.operatorList.argsArray.push(e.argsArray[n]);s.operatorList.lastChunk=e.lastChunk,s.operatorList.separateAnnots=e.separateAnnots;for(const n of s.renderTasks)n.operatorListChanged();e.lastChunk&&this.#s(!0)}_pumpOperatorList({renderingIntent:e,cacheKey:s,annotationStorageSerializable:n}){const{map:r,transfers:a}=n,u=this._transport.messageHandler.sendWithStream("GetOperatorList",{pageIndex:this._pageIndex,intent:e,cacheKey:s,annotationStorage:r},a).getReader(),f=this._intentStates.get(s);f.streamReader=u;const c=()=>{u.read().then(({value:d,done:h})=>{if(h){f.streamReader=null;return}this._transport.destroyed||(this._renderPageChunk(d,f),c())},d=>{if(f.streamReader=null,!this._transport.destroyed){if(f.operatorList){f.operatorList.lastChunk=!0;for(const h of f.renderTasks)h.operatorListChanged();this.#s(!0)}if(f.displayReadyCapability)f.displayReadyCapability.reject(d);else if(f.opListReadCapability)f.opListReadCapability.reject(d);else throw d}})};c()}_abortOperatorList({intentState:e,reason:s,force:n=!1}){if(e.streamReader){if(e.streamReaderCancelTimeout&&(clearTimeout(e.streamReaderCancelTimeout),e.streamReaderCancelTimeout=null),!n){if(e.renderTasks.size>0)return;if(s instanceof _display_utils.RenderingCancelledException){let r=RENDERING_CANCELLED_TIMEOUT;s.extraDelay>0&&s.extraDelay<1e3&&(r+=s.extraDelay),e.streamReaderCancelTimeout=setTimeout(()=>{e.streamReaderCancelTimeout=null,this._abortOperatorList({intentState:e,reason:s,force:!0})},r);return}}if(e.streamReader.cancel(new _util.AbortException(s.message)).catch(()=>{}),e.streamReader=null,!this._transport.destroyed){for(const[r,a]of this._intentStates)if(a===e){this._intentStates.delete(r);break}this.cleanup()}}}get stats(){return this._stats}}exports.PDFPageProxy=PDFPageProxy;class LoopbackPort{#e=new Set;#t=Promise.resolve();postMessage(e,s){const n={data:structuredClone(e,s?{transfer:s}:null)};this.#t.then(()=>{for(const r of this.#e)r.call(this,n)})}addEventListener(e,s){this.#e.add(s)}removeEventListener(e,s){this.#e.delete(s)}terminate(){this.#e.clear()}}exports.LoopbackPort=LoopbackPort;const PDFWorkerUtil={isWorkerDisabled:!1,fallbackWorkerSrc:null,fakeWorkerId:0};exports.PDFWorkerUtil=PDFWorkerUtil;{if(_util.isNodeJS&&typeof commonjsRequire=="function")PDFWorkerUtil.isWorkerDisabled=!0,PDFWorkerUtil.fallbackWorkerSrc="./pdf.worker.js";else if(typeof document=="object"){const t=document?.currentScript?.src;t&&(PDFWorkerUtil.fallbackWorkerSrc=t.replace(/(\.(?:min\.)?js)(\?.*)?$/i,".worker$1$2"))}PDFWorkerUtil.isSameOrigin=function(t,e){let s;try{if(s=new URL(t),!s.origin||s.origin==="null")return!1}catch{return!1}const n=new URL(e,s);return s.origin===n.origin},PDFWorkerUtil.createCDNWrapper=function(t){const e=`importScripts("${t}");`;return URL.createObjectURL(new Blob([e]))}}class PDFWorker{static#workerPorts;constructor({name:t=null,port:e=null,verbosity:s=(0,_util.getVerbosityLevel)()}={}){if(this.name=t,this.destroyed=!1,this.verbosity=s,this._readyCapability=new _util.PromiseCapability,this._port=null,this._webWorker=null,this._messageHandler=null,e){if(PDFWorker.#workerPorts?.has(e))throw new Error("Cannot use more than one PDFWorker per port.");(PDFWorker.#workerPorts||=new WeakMap).set(e,this),this._initializeFromPort(e);return}this._initialize()}get promise(){return this._readyCapability.promise}get port(){return this._port}get messageHandler(){return this._messageHandler}_initializeFromPort(t){this._port=t,this._messageHandler=new _message_handler.MessageHandler("main","worker",t),this._messageHandler.on("ready",function(){}),this._readyCapability.resolve(),this._messageHandler.send("configure",{verbosity:this.verbosity})}_initialize(){if(!PDFWorkerUtil.isWorkerDisabled&&!PDFWorker._mainThreadWorkerMessageHandler){let{workerSrc:t}=PDFWorker;try{PDFWorkerUtil.isSameOrigin(window.location.href,t)||(t=PDFWorkerUtil.createCDNWrapper(new URL(t,window.location).href));const e=new Worker(t),s=new _message_handler.MessageHandler("main","worker",e),n=()=>{e.removeEventListener("error",r),s.destroy(),e.terminate(),this.destroyed?this._readyCapability.reject(new Error("Worker was destroyed")):this._setupFakeWorker()},r=()=>{this._webWorker||n()};e.addEventListener("error",r),s.on("test",i=>{if(e.removeEventListener("error",r),this.destroyed){n();return}i?(this._messageHandler=s,this._port=e,this._webWorker=e,this._readyCapability.resolve(),s.send("configure",{verbosity:this.verbosity})):(this._setupFakeWorker(),s.destroy(),e.terminate())}),s.on("ready",i=>{if(e.removeEventListener("error",r),this.destroyed){n();return}try{a()}catch{this._setupFakeWorker()}});const a=()=>{const i=new Uint8Array;s.send("test",i,[i.buffer])};a();return}catch{(0,_util.info)("The worker has been disabled.")}}this._setupFakeWorker()}_setupFakeWorker(){PDFWorkerUtil.isWorkerDisabled||((0,_util.warn)("Setting up fake worker."),PDFWorkerUtil.isWorkerDisabled=!0),PDFWorker._setupFakeWorkerGlobal.then(t=>{if(this.destroyed){this._readyCapability.reject(new Error("Worker was destroyed"));return}const e=new LoopbackPort;this._port=e;const s=`fake${PDFWorkerUtil.fakeWorkerId++}`,n=new _message_handler.MessageHandler(s+"_worker",s,e);t.setup(n,e);const r=new _message_handler.MessageHandler(s,s+"_worker",e);this._messageHandler=r,this._readyCapability.resolve(),r.send("configure",{verbosity:this.verbosity})}).catch(t=>{this._readyCapability.reject(new Error(`Setting up fake worker failed: "${t.message}".`))})}destroy(){this.destroyed=!0,this._webWorker&&(this._webWorker.terminate(),this._webWorker=null),PDFWorker.#workerPorts?.delete(this._port),this._port=null,this._messageHandler&&(this._messageHandler.destroy(),this._messageHandler=null)}static fromPort(t){if(!t?.port)throw new Error("PDFWorker.fromPort - invalid method signature.");const e=this.#workerPorts?.get(t.port);if(e){if(e._pendingDestroy)throw new Error("PDFWorker.fromPort - the worker is being destroyed.\nPlease remember to await `PDFDocumentLoadingTask.destroy()`-calls.");return e}return new PDFWorker(t)}static get workerSrc(){if(_worker_options.GlobalWorkerOptions.workerSrc)return _worker_options.GlobalWorkerOptions.workerSrc;if(PDFWorkerUtil.fallbackWorkerSrc!==null)return _util.isNodeJS||(0,_display_utils.deprecated)('No "GlobalWorkerOptions.workerSrc" specified.'),PDFWorkerUtil.fallbackWorkerSrc;throw new Error('No "GlobalWorkerOptions.workerSrc" specified.')}static get _mainThreadWorkerMessageHandler(){try{return globalThis.pdfjsWorker?.WorkerMessageHandler||null}catch{return null}}static get _setupFakeWorkerGlobal(){const loader=async()=>{const mainWorkerMessageHandler=this._mainThreadWorkerMessageHandler;if(mainWorkerMessageHandler)return mainWorkerMessageHandler;if(_util.isNodeJS&&typeof commonjsRequire=="function"){const worker=eval("require")(this.workerSrc);return worker.WorkerMessageHandler}return await(0,_display_utils.loadScript)(this.workerSrc),window.pdfjsWorker.WorkerMessageHandler};return(0,_util.shadow)(this,"_setupFakeWorkerGlobal",loader())}}exports.PDFWorker=PDFWorker;class WorkerTransport{#e=new Map;#t=new Map;#s=new Map;#n=null;constructor(e,s,n,r,a){this.messageHandler=e,this.loadingTask=s,this.commonObjs=new PDFObjects,this.fontLoader=new _font_loader.FontLoader({ownerDocument:r.ownerDocument,styleElement:r.styleElement}),this._params=r,this.canvasFactory=a.canvasFactory,this.filterFactory=a.filterFactory,this.cMapReaderFactory=a.cMapReaderFactory,this.standardFontDataFactory=a.standardFontDataFactory,this.destroyed=!1,this.destroyCapability=null,this._networkStream=n,this._fullReader=null,this._lastProgress=null,this.downloadInfoCapability=new _util.PromiseCapability,this.setupMessageHandler()}#i(e,s=null){const n=this.#e.get(e);if(n)return n;const r=this.messageHandler.sendWithPromise(e,s);return this.#e.set(e,r),r}get annotationStorage(){return(0,_util.shadow)(this,"annotationStorage",new _annotation_storage.AnnotationStorage)}getRenderingIntent(e,s=_util.AnnotationMode.ENABLE,n=null,r=!1){let a=_util.RenderingIntentFlag.DISPLAY,i=_annotation_storage.SerializableEmpty;switch(e){case"any":a=_util.RenderingIntentFlag.ANY;break;case"display":break;case"print":a=_util.RenderingIntentFlag.PRINT;break;default:(0,_util.warn)(`getRenderingIntent - invalid intent: ${e}`)}switch(s){case _util.AnnotationMode.DISABLE:a+=_util.RenderingIntentFlag.ANNOTATIONS_DISABLE;break;case _util.AnnotationMode.ENABLE:break;case _util.AnnotationMode.ENABLE_FORMS:a+=_util.RenderingIntentFlag.ANNOTATIONS_FORMS;break;case _util.AnnotationMode.ENABLE_STORAGE:a+=_util.RenderingIntentFlag.ANNOTATIONS_STORAGE,i=(a&_util.RenderingIntentFlag.PRINT&&n instanceof _annotation_storage.PrintAnnotationStorage?n:this.annotationStorage).serializable;break;default:(0,_util.warn)(`getRenderingIntent - invalid annotationMode: ${s}`)}return r&&(a+=_util.RenderingIntentFlag.OPLIST),{renderingIntent:a,cacheKey:`${a}_${i.hash}`,annotationStorageSerializable:i}}destroy(){if(this.destroyCapability)return this.destroyCapability.promise;this.destroyed=!0,this.destroyCapability=new _util.PromiseCapability,this.#n?.reject(new Error("Worker was destroyed during onPassword callback"));const e=[];for(const n of this.#t.values())e.push(n._destroy());this.#t.clear(),this.#s.clear(),this.hasOwnProperty("annotationStorage")&&this.annotationStorage.resetModified();const s=this.messageHandler.sendWithPromise("Terminate",null);return e.push(s),Promise.all(e).then(()=>{this.commonObjs.clear(),this.fontLoader.clear(),this.#e.clear(),this.filterFactory.destroy(),this._networkStream?.cancelAllRequests(new _util.AbortException("Worker was terminated.")),this.messageHandler&&(this.messageHandler.destroy(),this.messageHandler=null),this.destroyCapability.resolve()},this.destroyCapability.reject),this.destroyCapability.promise}setupMessageHandler(){const{messageHandler:e,loadingTask:s}=this;e.on("GetReader",(n,r)=>{(0,_util.assert)(this._networkStream,"GetReader - no `IPDFStream` instance available."),this._fullReader=this._networkStream.getFullReader(),this._fullReader.onProgress=a=>{this._lastProgress={loaded:a.loaded,total:a.total}},r.onPull=()=>{this._fullReader.read().then(function({value:a,done:i}){if(i){r.close();return}(0,_util.assert)(a instanceof ArrayBuffer,"GetReader - expected an ArrayBuffer."),r.enqueue(new Uint8Array(a),1,[a])}).catch(a=>{r.error(a)})},r.onCancel=a=>{this._fullReader.cancel(a),r.ready.catch(i=>{if(!this.destroyed)throw i})}}),e.on("ReaderHeadersReady",n=>{const r=new _util.PromiseCapability,a=this._fullReader;return a.headersReady.then(()=>{(!a.isStreamingSupported||!a.isRangeSupported)&&(this._lastProgress&&s.onProgress?.(this._lastProgress),a.onProgress=i=>{s.onProgress?.({loaded:i.loaded,total:i.total})}),r.resolve({isStreamingSupported:a.isStreamingSupported,isRangeSupported:a.isRangeSupported,contentLength:a.contentLength})},r.reject),r.promise}),e.on("GetRangeReader",(n,r)=>{(0,_util.assert)(this._networkStream,"GetRangeReader - no `IPDFStream` instance available.");const a=this._networkStream.getRangeReader(n.begin,n.end);if(!a){r.close();return}r.onPull=()=>{a.read().then(function({value:i,done:u}){if(u){r.close();return}(0,_util.assert)(i instanceof ArrayBuffer,"GetRangeReader - expected an ArrayBuffer."),r.enqueue(new Uint8Array(i),1,[i])}).catch(i=>{r.error(i)})},r.onCancel=i=>{a.cancel(i),r.ready.catch(u=>{if(!this.destroyed)throw u})}}),e.on("GetDoc",({pdfInfo:n})=>{this._numPages=n.numPages,this._htmlForXfa=n.htmlForXfa,delete n.htmlForXfa,s._capability.resolve(new PDFDocumentProxy(n,this))}),e.on("DocException",function(n){let r;switch(n.name){case"PasswordException":r=new _util.PasswordException(n.message,n.code);break;case"InvalidPDFException":r=new _util.InvalidPDFException(n.message);break;case"MissingPDFException":r=new _util.MissingPDFException(n.message);break;case"UnexpectedResponseException":r=new _util.UnexpectedResponseException(n.message,n.status);break;case"UnknownErrorException":r=new _util.UnknownErrorException(n.message,n.details);break;default:(0,_util.unreachable)("DocException - expected a valid Error.")}s._capability.reject(r)}),e.on("PasswordRequest",n=>{if(this.#n=new _util.PromiseCapability,s.onPassword){const r=a=>{a instanceof Error?this.#n.reject(a):this.#n.resolve({password:a})};try{s.onPassword(r,n.code)}catch(a){this.#n.reject(a)}}else this.#n.reject(new _util.PasswordException(n.message,n.code));return this.#n.promise}),e.on("DataLoaded",n=>{s.onProgress?.({loaded:n.length,total:n.length}),this.downloadInfoCapability.resolve(n)}),e.on("StartRenderPage",n=>{if(this.destroyed)return;this.#t.get(n.pageIndex)._startRenderPage(n.transparency,n.cacheKey)}),e.on("commonobj",([n,r,a])=>{if(!this.destroyed&&!this.commonObjs.has(n))switch(r){case"Font":const i=this._params;if("error"in a){const c=a.error;(0,_util.warn)(`Error during font loading: ${c}`),this.commonObjs.resolve(n,c);break}const u=i.pdfBug&&globalThis.FontInspector?.enabled?(c,d)=>globalThis.FontInspector.fontAdded(c,d):null,f=new _font_loader.FontFaceObject(a,{isEvalSupported:i.isEvalSupported,disableFontFace:i.disableFontFace,ignoreErrors:i.ignoreErrors,inspectFont:u});this.fontLoader.bind(f).catch(c=>e.sendWithPromise("FontFallback",{id:n})).finally(()=>{!i.fontExtraProperties&&f.data&&(f.data=null),this.commonObjs.resolve(n,f)});break;case"FontPath":case"Image":case"Pattern":this.commonObjs.resolve(n,a);break;default:throw new Error(`Got unknown common object type ${r}`)}}),e.on("obj",([n,r,a,i])=>{if(this.destroyed)return;const u=this.#t.get(r);if(!u.objs.has(n))switch(a){case"Image":if(u.objs.resolve(n,i),i){let f;if(i.bitmap){const{width:c,height:d}=i;f=c*d*4}else f=i.data?.length||0;f>_util.MAX_IMAGE_SIZE_TO_CACHE&&(u._maybeCleanupAfterRender=!0)}break;case"Pattern":u.objs.resolve(n,i);break;default:throw new Error(`Got unknown object type ${a}`)}}),e.on("DocProgress",n=>{this.destroyed||s.onProgress?.({loaded:n.loaded,total:n.total})}),e.on("FetchBuiltInCMap",n=>this.destroyed?Promise.reject(new Error("Worker was destroyed.")):this.cMapReaderFactory?this.cMapReaderFactory.fetch(n):Promise.reject(new Error("CMapReaderFactory not initialized, see the `useWorkerFetch` parameter."))),e.on("FetchStandardFontData",n=>this.destroyed?Promise.reject(new Error("Worker was destroyed.")):this.standardFontDataFactory?this.standardFontDataFactory.fetch(n):Promise.reject(new Error("StandardFontDataFactory not initialized, see the `useWorkerFetch` parameter.")))}getData(){return this.messageHandler.sendWithPromise("GetData",null)}saveDocument(){this.annotationStorage.size<=0&&(0,_util.warn)("saveDocument called while `annotationStorage` is empty, please use the getData-method instead.");const{map:e,transfers:s}=this.annotationStorage.serializable;return this.messageHandler.sendWithPromise("SaveDocument",{isPureXfa:!!this._htmlForXfa,numPages:this._numPages,annotationStorage:e,filename:this._fullReader?.filename??null},s).finally(()=>{this.annotationStorage.resetModified()})}getPage(e){if(!Number.isInteger(e)||e<=0||e>this._numPages)return Promise.reject(new Error("Invalid page request."));const s=e-1,n=this.#s.get(s);if(n)return n;const r=this.messageHandler.sendWithPromise("GetPage",{pageIndex:s}).then(a=>{if(this.destroyed)throw new Error("Transport destroyed");const i=new PDFPageProxy(s,a,this,this._params.pdfBug);return this.#t.set(s,i),i});return this.#s.set(s,r),r}getPageIndex(e){return typeof e!="object"||e===null||!Number.isInteger(e.num)||e.num<0||!Number.isInteger(e.gen)||e.gen<0?Promise.reject(new Error("Invalid pageIndex request.")):this.messageHandler.sendWithPromise("GetPageIndex",{num:e.num,gen:e.gen})}getAnnotations(e,s){return this.messageHandler.sendWithPromise("GetAnnotations",{pageIndex:e,intent:s})}getFieldObjects(){return this.#i("GetFieldObjects")}hasJSActions(){return this.#i("HasJSActions")}getCalculationOrderIds(){return this.messageHandler.sendWithPromise("GetCalculationOrderIds",null)}getDestinations(){return this.messageHandler.sendWithPromise("GetDestinations",null)}getDestination(e){return typeof e!="string"?Promise.reject(new Error("Invalid destination request.")):this.messageHandler.sendWithPromise("GetDestination",{id:e})}getPageLabels(){return this.messageHandler.sendWithPromise("GetPageLabels",null)}getPageLayout(){return this.messageHandler.sendWithPromise("GetPageLayout",null)}getPageMode(){return this.messageHandler.sendWithPromise("GetPageMode",null)}getViewerPreferences(){return this.messageHandler.sendWithPromise("GetViewerPreferences",null)}getOpenAction(){return this.messageHandler.sendWithPromise("GetOpenAction",null)}getAttachments(){return this.messageHandler.sendWithPromise("GetAttachments",null)}getDocJSActions(){return this.#i("GetDocJSActions")}getPageJSActions(e){return this.messageHandler.sendWithPromise("GetPageJSActions",{pageIndex:e})}getStructTree(e){return this.messageHandler.sendWithPromise("GetStructTree",{pageIndex:e})}getOutline(){return this.messageHandler.sendWithPromise("GetOutline",null)}getOptionalContentConfig(){return this.messageHandler.sendWithPromise("GetOptionalContentConfig",null).then(e=>new _optional_content_config.OptionalContentConfig(e))}getPermissions(){return this.messageHandler.sendWithPromise("GetPermissions",null)}getMetadata(){const e="GetMetadata",s=this.#e.get(e);if(s)return s;const n=this.messageHandler.sendWithPromise(e,null).then(r=>({info:r[0],metadata:r[1]?new _metadata.Metadata(r[1]):null,contentDispositionFilename:this._fullReader?.filename??null,contentLength:this._fullReader?.contentLength??null}));return this.#e.set(e,n),n}getMarkInfo(){return this.messageHandler.sendWithPromise("GetMarkInfo",null)}async startCleanup(e=!1){if(!this.destroyed){await this.messageHandler.sendWithPromise("Cleanup",null);for(const s of this.#t.values())if(!s.cleanup())throw new Error(`startCleanup: Page ${s.pageNumber} is currently rendering.`);this.commonObjs.clear(),e||this.fontLoader.clear(),this.#e.clear(),this.filterFactory.destroy(!0)}}get loadingParams(){const{disableAutoFetch:e,enableXfa:s}=this._params;return(0,_util.shadow)(this,"loadingParams",{disableAutoFetch:e,enableXfa:s})}}class PDFObjects{#e=Object.create(null);#t(e){return this.#e[e]||={capability:new _util.PromiseCapability,data:null}}get(e,s=null){if(s){const r=this.#t(e);return r.capability.promise.then(()=>s(r.data)),null}const n=this.#e[e];if(!n?.capability.settled)throw new Error(`Requesting object that isn't resolved yet ${e}.`);return n.data}has(e){return this.#e[e]?.capability.settled||!1}resolve(e,s=null){const n=this.#t(e);n.data=s,n.capability.resolve()}clear(){for(const e in this.#e){const{data:s}=this.#e[e];s?.bitmap?.close()}this.#e=Object.create(null)}}class RenderTask{#e=null;constructor(e){this.#e=e,this.onContinue=null}get promise(){return this.#e.capability.promise}cancel(e=0){this.#e.cancel(null,e)}get separateAnnots(){const{separateAnnots:e}=this.#e.operatorList;if(!e)return!1;const{annotationCanvasMap:s}=this.#e;return e.form||e.canvas&&s?.size>0}}exports.RenderTask=RenderTask;class InternalRenderTask{static#e=new WeakSet;constructor({callback:e,params:s,objs:n,commonObjs:r,annotationCanvasMap:a,operatorList:i,pageIndex:u,canvasFactory:f,filterFactory:c,useRequestAnimationFrame:d=!1,pdfBug:h=!1,pageColors:m=null}){this.callback=e,this.params=s,this.objs=n,this.commonObjs=r,this.annotationCanvasMap=a,this.operatorListIdx=null,this.operatorList=i,this._pageIndex=u,this.canvasFactory=f,this.filterFactory=c,this._pdfBug=h,this.pageColors=m,this.running=!1,this.graphicsReadyCallback=null,this.graphicsReady=!1,this._useRequestAnimationFrame=d===!0&&typeof window<"u",this.cancelled=!1,this.capability=new _util.PromiseCapability,this.task=new RenderTask(this),this._cancelBound=this.cancel.bind(this),this._continueBound=this._continue.bind(this),this._scheduleNextBound=this._scheduleNext.bind(this),this._nextBound=this._next.bind(this),this._canvas=s.canvasContext.canvas}get completed(){return this.capability.promise.catch(function(){})}initializeGraphics({transparency:e=!1,optionalContentConfig:s}){if(this.cancelled)return;if(this._canvas){if(InternalRenderTask.#e.has(this._canvas))throw new Error("Cannot use the same canvas during multiple render() operations. Use different canvas or ensure previous operations were cancelled or completed.");InternalRenderTask.#e.add(this._canvas)}this._pdfBug&&globalThis.StepperManager?.enabled&&(this.stepper=globalThis.StepperManager.create(this._pageIndex),this.stepper.init(this.operatorList),this.stepper.nextBreakPoint=this.stepper.getNextBreakPoint());const{canvasContext:n,viewport:r,transform:a,background:i}=this.params;this.gfx=new _canvas.CanvasGraphics(n,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:s},this.annotationCanvasMap,this.pageColors),this.gfx.beginDrawing({transform:a,viewport:r,transparency:e,background:i}),this.operatorListIdx=0,this.graphicsReady=!0,this.graphicsReadyCallback?.()}cancel(e=null,s=0){this.running=!1,this.cancelled=!0,this.gfx?.endDrawing(),InternalRenderTask.#e.delete(this._canvas),this.callback(e||new _display_utils.RenderingCancelledException(`Rendering cancelled, page ${this._pageIndex+1}`,s))}operatorListChanged(){if(!this.graphicsReady){this.graphicsReadyCallback||=this._continueBound;return}this.stepper?.updateOperatorList(this.operatorList),!this.running&&this._continue()}_continue(){this.running=!0,!this.cancelled&&(this.task.onContinue?this.task.onContinue(this._scheduleNextBound):this._scheduleNext())}_scheduleNext(){this._useRequestAnimationFrame?window.requestAnimationFrame(()=>{this._nextBound().catch(this._cancelBound)}):Promise.resolve().then(this._nextBound).catch(this._cancelBound)}async _next(){this.cancelled||(this.operatorListIdx=this.gfx.executeOperatorList(this.operatorList,this.operatorListIdx,this._continueBound,this.stepper),this.operatorListIdx===this.operatorList.argsArray.length&&(this.running=!1,this.operatorList.lastChunk&&(this.gfx.endDrawing(),InternalRenderTask.#e.delete(this._canvas),this.callback())))}}const version="3.11.174";exports.version=version;const build="ce8716743";exports.build=build},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.SerializableEmpty=e.PrintAnnotationStorage=e.AnnotationStorage=void 0;var n=s(1),r=s(4),a=s(8);const i=Object.freeze({map:null,hash:"",transfers:void 0});e.SerializableEmpty=i;class u{#e=!1;#t=new Map;constructor(){this.onSetModified=null,this.onResetModified=null,this.onAnnotationEditor=null}getValue(d,h){const m=this.#t.get(d);return m===void 0?h:Object.assign(h,m)}getRawValue(d){return this.#t.get(d)}remove(d){if(this.#t.delete(d),this.#t.size===0&&this.resetModified(),typeof this.onAnnotationEditor=="function"){for(const h of this.#t.values())if(h instanceof r.AnnotationEditor)return;this.onAnnotationEditor(null)}}setValue(d,h){const m=this.#t.get(d);let _=!1;if(m!==void 0)for(const[p,b]of Object.entries(h))m[p]!==b&&(_=!0,m[p]=b);else _=!0,this.#t.set(d,h);_&&this.#s(),h instanceof r.AnnotationEditor&&typeof this.onAnnotationEditor=="function"&&this.onAnnotationEditor(h.constructor._type)}has(d){return this.#t.has(d)}getAll(){return this.#t.size>0?(0,n.objectFromMap)(this.#t):null}setAll(d){for(const[h,m]of Object.entries(d))this.setValue(h,m)}get size(){return this.#t.size}#s(){this.#e||(this.#e=!0,typeof this.onSetModified=="function"&&this.onSetModified())}resetModified(){this.#e&&(this.#e=!1,typeof this.onResetModified=="function"&&this.onResetModified())}get print(){return new f(this)}get serializable(){if(this.#t.size===0)return i;const d=new Map,h=new a.MurmurHash3_64,m=[],_=Object.create(null);let p=!1;for(const[b,A]of this.#t){const T=A instanceof r.AnnotationEditor?A.serialize(!1,_):A;T&&(d.set(b,T),h.update(`${b}:${JSON.stringify(T)}`),p||=!!T.bitmap)}if(p)for(const b of d.values())b.bitmap&&m.push(b.bitmap);return d.size>0?{map:d,hash:h.hexdigest(),transfers:m}:i}}e.AnnotationStorage=u;class f extends u{#e;constructor(d){super();const{map:h,hash:m,transfers:_}=d.serializable,p=structuredClone(h,_?{transfer:_}:null);this.#e={map:p,hash:m,transfers:_}}get print(){(0,n.unreachable)("Should not call PrintAnnotationStorage.print")}get serializable(){return this.#e}}e.PrintAnnotationStorage=f},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.AnnotationEditor=void 0;var n=s(5),r=s(1),a=s(6);class i{#e="";#t=!1;#s=null;#n=null;#i=null;#o=!1;#a=null;#u=this.focusin.bind(this);#c=this.focusout.bind(this);#r=!1;#f=!1;#d=!1;_initialOptions=Object.create(null);_uiManager=null;_focusEventsAllowed=!0;_l10nPromise=null;#h=!1;#p=i._zIndex++;static _borderLineWidth=-1;static _colorManager=new n.ColorManager;static _zIndex=1;static SMALL_EDITOR_SIZE=0;constructor(c){this.constructor===i&&(0,r.unreachable)("Cannot initialize AnnotationEditor."),this.parent=c.parent,this.id=c.id,this.width=this.height=null,this.pageIndex=c.parent.pageIndex,this.name=c.name,this.div=null,this._uiManager=c.uiManager,this.annotationElementId=null,this._willKeepAspectRatio=!1,this._initialOptions.isCentered=c.isCentered,this._structTreeParentId=null;const{rotation:d,rawDims:{pageWidth:h,pageHeight:m,pageX:_,pageY:p}}=this.parent.viewport;this.rotation=d,this.pageRotation=(360+d-this._uiManager.viewParameters.rotation)%360,this.pageDimensions=[h,m],this.pageTranslation=[_,p];const[b,A]=this.parentDimensions;this.x=c.x/b,this.y=c.y/A,this.isAttachedToDOM=!1,this.deleted=!1}get editorType(){return Object.getPrototypeOf(this).constructor._type}static get _defaultLineColor(){return(0,r.shadow)(this,"_defaultLineColor",this._colorManager.getHexCode("CanvasText"))}static deleteAnnotationElement(c){const d=new u({id:c.parent.getNextId(),parent:c.parent,uiManager:c._uiManager});d.annotationElementId=c.annotationElementId,d.deleted=!0,d._uiManager.addToAnnotationStorage(d)}static initialize(c,d=null){if(i._l10nPromise||=new Map(["editor_alt_text_button_label","editor_alt_text_edit_button_label","editor_alt_text_decorative_tooltip"].map(m=>[m,c.get(m)])),d?.strings)for(const m of d.strings)i._l10nPromise.set(m,c.get(m));if(i._borderLineWidth!==-1)return;const h=getComputedStyle(document.documentElement);i._borderLineWidth=parseFloat(h.getPropertyValue("--outline-width"))||0}static updateDefaultParams(c,d){}static get defaultPropertiesToUpdate(){return[]}static isHandlingMimeForPasting(c){return!1}static paste(c,d){(0,r.unreachable)("Not implemented")}get propertiesToUpdate(){return[]}get _isDraggable(){return this.#h}set _isDraggable(c){this.#h=c,this.div?.classList.toggle("draggable",c)}center(){const[c,d]=this.pageDimensions;switch(this.parentRotation){case 90:this.x-=this.height*d/(c*2),this.y+=this.width*c/(d*2);break;case 180:this.x+=this.width/2,this.y+=this.height/2;break;case 270:this.x+=this.height*d/(c*2),this.y-=this.width*c/(d*2);break;default:this.x-=this.width/2,this.y-=this.height/2;break}this.fixAndSetPosition()}addCommands(c){this._uiManager.addCommands(c)}get currentLayer(){return this._uiManager.currentLayer}setInBackground(){this.div.style.zIndex=0}setInForeground(){this.div.style.zIndex=this.#p}setParent(c){c!==null&&(this.pageIndex=c.pageIndex,this.pageDimensions=c.pageDimensions),this.parent=c}focusin(c){this._focusEventsAllowed&&(this.#r?this.#r=!1:this.parent.setSelected(this))}focusout(c){!this._focusEventsAllowed||!this.isAttachedToDOM||c.relatedTarget?.closest(`#${this.id}`)||(c.preventDefault(),this.parent?.isMultipleSelection||this.commitOrRemove())}commitOrRemove(){this.isEmpty()?this.remove():this.commit()}commit(){this.addToAnnotationStorage()}addToAnnotationStorage(){this._uiManager.addToAnnotationStorage(this)}setAt(c,d,h,m){const[_,p]=this.parentDimensions;[h,m]=this.screenToPageTranslation(h,m),this.x=(c+h)/_,this.y=(d+m)/p,this.fixAndSetPosition()}#_([c,d],h,m){[h,m]=this.screenToPageTranslation(h,m),this.x+=h/c,this.y+=m/d,this.fixAndSetPosition()}translate(c,d){this.#_(this.parentDimensions,c,d)}translateInPage(c,d){this.#_(this.pageDimensions,c,d),this.div.scrollIntoView({block:"nearest"})}drag(c,d){const[h,m]=this.parentDimensions;if(this.x+=c/h,this.y+=d/m,this.parent&&(this.x<0||this.x>1||this.y<0||this.y>1)){const{x:T,y:v}=this.div.getBoundingClientRect();this.parent.findNewParent(this,T,v)&&(this.x-=Math.floor(this.x),this.y-=Math.floor(this.y))}let{x:_,y:p}=this;const[b,A]=this.#g();_+=b,p+=A,this.div.style.left=`${(100*_).toFixed(2)}%`,this.div.style.top=`${(100*p).toFixed(2)}%`,this.div.scrollIntoView({block:"nearest"})}#g(){const[c,d]=this.parentDimensions,{_borderLineWidth:h}=i,m=h/c,_=h/d;switch(this.rotation){case 90:return[-m,_];case 180:return[m,_];case 270:return[m,-_];default:return[-m,-_]}}fixAndSetPosition(){const[c,d]=this.pageDimensions;let{x:h,y:m,width:_,height:p}=this;switch(_*=c,p*=d,h*=c,m*=d,this.rotation){case 0:h=Math.max(0,Math.min(c-_,h)),m=Math.max(0,Math.min(d-p,m));break;case 90:h=Math.max(0,Math.min(c-p,h)),m=Math.min(d,Math.max(_,m));break;case 180:h=Math.min(c,Math.max(_,h)),m=Math.min(d,Math.max(p,m));break;case 270:h=Math.min(c,Math.max(p,h)),m=Math.max(0,Math.min(d-_,m));break}this.x=h/=c,this.y=m/=d;const[b,A]=this.#g();h+=b,m+=A;const{style:T}=this.div;T.left=`${(100*h).toFixed(2)}%`,T.top=`${(100*m).toFixed(2)}%`,this.moveInDOM()}static#m(c,d,h){switch(h){case 90:return[d,-c];case 180:return[-c,-d];case 270:return[-d,c];default:return[c,d]}}screenToPageTranslation(c,d){return i.#m(c,d,this.parentRotation)}pageTranslationToScreen(c,d){return i.#m(c,d,360-this.parentRotation)}#l(c){switch(c){case 90:{const[d,h]=this.pageDimensions;return[0,-d/h,h/d,0]}case 180:return[-1,0,0,-1];case 270:{const[d,h]=this.pageDimensions;return[0,d/h,-h/d,0]}default:return[1,0,0,1]}}get parentScale(){return this._uiManager.viewParameters.realScale}get parentRotation(){return(this._uiManager.viewParameters.rotation+this.pageRotation)%360}get parentDimensions(){const{parentScale:c,pageDimensions:[d,h]}=this,m=d*c,_=h*c;return r.FeatureTest.isCSSRoundSupported?[Math.round(m),Math.round(_)]:[m,_]}setDims(c,d){const[h,m]=this.parentDimensions;this.div.style.width=`${(100*c/h).toFixed(2)}%`,this.#o||(this.div.style.height=`${(100*d/m).toFixed(2)}%`),this.#s?.classList.toggle("small",c<i.SMALL_EDITOR_SIZE||d<i.SMALL_EDITOR_SIZE)}fixDims(){const{style:c}=this.div,{height:d,width:h}=c,m=h.endsWith("%"),_=!this.#o&&d.endsWith("%");if(m&&_)return;const[p,b]=this.parentDimensions;m||(c.width=`${(100*parseFloat(h)/p).toFixed(2)}%`),!this.#o&&!_&&(c.height=`${(100*parseFloat(d)/b).toFixed(2)}%`)}getInitialTranslation(){return[0,0]}#b(){if(this.#a)return;this.#a=document.createElement("div"),this.#a.classList.add("resizers");const c=["topLeft","topRight","bottomRight","bottomLeft"];this._willKeepAspectRatio||c.push("topMiddle","middleRight","bottomMiddle","middleLeft");for(const d of c){const h=document.createElement("div");this.#a.append(h),h.classList.add("resizer",d),h.addEventListener("pointerdown",this.#S.bind(this,d)),h.addEventListener("contextmenu",a.noContextMenu)}this.div.prepend(this.#a)}#S(c,d){d.preventDefault();const{isMac:h}=r.FeatureTest.platform;if(d.button!==0||d.ctrlKey&&h)return;const m=this.#y.bind(this,c),_=this._isDraggable;this._isDraggable=!1;const p={passive:!0,capture:!0};window.addEventListener("pointermove",m,p);const b=this.x,A=this.y,T=this.width,v=this.height,N=this.parent.div.style.cursor,x=this.div.style.cursor;this.div.style.cursor=this.parent.div.style.cursor=window.getComputedStyle(d.target).cursor;const y=()=>{this._isDraggable=_,window.removeEventListener("pointerup",y),window.removeEventListener("blur",y),window.removeEventListener("pointermove",m,p),this.parent.div.style.cursor=N,this.div.style.cursor=x;const S=this.x,D=this.y,F=this.width,B=this.height;S===b&&D===A&&F===T&&B===v||this.addCommands({cmd:()=>{this.width=F,this.height=B,this.x=S,this.y=D;const[W,z]=this.parentDimensions;this.setDims(W*F,z*B),this.fixAndSetPosition()},undo:()=>{this.width=T,this.height=v,this.x=b,this.y=A;const[W,z]=this.parentDimensions;this.setDims(W*T,z*v),this.fixAndSetPosition()},mustExec:!0})};window.addEventListener("pointerup",y),window.addEventListener("blur",y)}#y(c,d){const[h,m]=this.parentDimensions,_=this.x,p=this.y,b=this.width,A=this.height,T=i.MIN_SIZE/h,v=i.MIN_SIZE/m,N=M=>Math.round(M*1e4)/1e4,x=this.#l(this.rotation),y=(M,E)=>[x[0]*M+x[2]*E,x[1]*M+x[3]*E],S=this.#l(360-this.rotation),D=(M,E)=>[S[0]*M+S[2]*E,S[1]*M+S[3]*E];let F,B,W=!1,z=!1;switch(c){case"topLeft":W=!0,F=(M,E)=>[0,0],B=(M,E)=>[M,E];break;case"topMiddle":F=(M,E)=>[M/2,0],B=(M,E)=>[M/2,E];break;case"topRight":W=!0,F=(M,E)=>[M,0],B=(M,E)=>[0,E];break;case"middleRight":z=!0,F=(M,E)=>[M,E/2],B=(M,E)=>[0,E/2];break;case"bottomRight":W=!0,F=(M,E)=>[M,E],B=(M,E)=>[0,0];break;case"bottomMiddle":F=(M,E)=>[M/2,E],B=(M,E)=>[M/2,0];break;case"bottomLeft":W=!0,F=(M,E)=>[0,E],B=(M,E)=>[M,0];break;case"middleLeft":z=!0,F=(M,E)=>[0,E/2],B=(M,E)=>[M,E/2];break}const re=F(b,A),X=B(b,A);let ne=y(...X);const ie=N(_+ne[0]),te=N(p+ne[1]);let H=1,P=1,[C,I]=this.screenToPageTranslation(d.movementX,d.movementY);if([C,I]=D(C/h,I/m),W){const M=Math.hypot(b,A);H=P=Math.max(Math.min(Math.hypot(X[0]-re[0]-C,X[1]-re[1]-I)/M,1/b,1/A),T/b,v/A)}else z?H=Math.max(T,Math.min(1,Math.abs(X[0]-re[0]-C)))/b:P=Math.max(v,Math.min(1,Math.abs(X[1]-re[1]-I)))/A;const R=N(b*H),L=N(A*P);ne=y(...B(R,L));const G=ie-ne[0],j=te-ne[1];this.width=R,this.height=L,this.x=G,this.y=j,this.setDims(h*R,m*L),this.fixAndSetPosition()}async addAltTextButton(){if(this.#s)return;const c=this.#s=document.createElement("button");c.className="altText";const d=await i._l10nPromise.get("editor_alt_text_button_label");c.textContent=d,c.setAttribute("aria-label",d),c.tabIndex="0",c.addEventListener("contextmenu",a.noContextMenu),c.addEventListener("pointerdown",h=>h.stopPropagation()),c.addEventListener("click",h=>{h.preventDefault(),this._uiManager.editAltText(this)},{capture:!0}),c.addEventListener("keydown",h=>{h.target===c&&h.key==="Enter"&&(h.preventDefault(),this._uiManager.editAltText(this))}),this.#v(),this.div.append(c),i.SMALL_EDITOR_SIZE||(i.SMALL_EDITOR_SIZE=Math.min(128,Math.round(c.getBoundingClientRect().width*1.4)))}async#v(){const c=this.#s;if(!c)return;if(!this.#e&&!this.#t){c.classList.remove("done"),this.#n?.remove();return}i._l10nPromise.get("editor_alt_text_edit_button_label").then(h=>{c.setAttribute("aria-label",h)});let d=this.#n;if(!d){this.#n=d=document.createElement("span"),d.className="tooltip",d.setAttribute("role","tooltip");const h=d.id=`alt-text-tooltip-${this.id}`;c.setAttribute("aria-describedby",h);const m=100;c.addEventListener("mouseenter",()=>{this.#i=setTimeout(()=>{this.#i=null,this.#n.classList.add("show"),this._uiManager._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",subtype:this.editorType,data:{action:"alt_text_tooltip"}}})},m)}),c.addEventListener("mouseleave",()=>{clearTimeout(this.#i),this.#i=null,this.#n?.classList.remove("show")})}c.classList.add("done"),d.innerText=this.#t?await i._l10nPromise.get("editor_alt_text_decorative_tooltip"):this.#e,d.parentNode||c.append(d)}getClientDimensions(){return this.div.getBoundingClientRect()}get altTextData(){return{altText:this.#e,decorative:this.#t}}set altTextData({altText:c,decorative:d}){this.#e===c&&this.#t===d||(this.#e=c,this.#t=d,this.#v())}render(){this.div=document.createElement("div"),this.div.setAttribute("data-editor-rotation",(360-this.rotation)%360),this.div.className=this.name,this.div.setAttribute("id",this.id),this.div.setAttribute("tabIndex",0),this.setInForeground(),this.div.addEventListener("focusin",this.#u),this.div.addEventListener("focusout",this.#c);const[c,d]=this.parentDimensions;this.parentRotation%180!==0&&(this.div.style.maxWidth=`${(100*d/c).toFixed(2)}%`,this.div.style.maxHeight=`${(100*c/d).toFixed(2)}%`);const[h,m]=this.getInitialTranslation();return this.translate(h,m),(0,n.bindEvents)(this,this.div,["pointerdown"]),this.div}pointerdown(c){const{isMac:d}=r.FeatureTest.platform;if(c.button!==0||c.ctrlKey&&d){c.preventDefault();return}this.#r=!0,this.#P(c)}#P(c){if(!this._isDraggable)return;const d=this._uiManager.isSelected(this);this._uiManager.setUpDragSession();let h,m;d&&(h={passive:!0,capture:!0},m=p=>{const[b,A]=this.screenToPageTranslation(p.movementX,p.movementY);this._uiManager.dragSelectedEditors(b,A)},window.addEventListener("pointermove",m,h));const _=()=>{if(window.removeEventListener("pointerup",_),window.removeEventListener("blur",_),d&&window.removeEventListener("pointermove",m,h),this.#r=!1,!this._uiManager.endDragSession()){const{isMac:p}=r.FeatureTest.platform;c.ctrlKey&&!p||c.shiftKey||c.metaKey&&p?this.parent.toggleSelected(this):this.parent.setSelected(this)}};window.addEventListener("pointerup",_),window.addEventListener("blur",_)}moveInDOM(){this.parent?.moveEditorInDOM(this)}_setParentAndPosition(c,d,h){c.changeParent(this),this.x=d,this.y=h,this.fixAndSetPosition()}getRect(c,d){const h=this.parentScale,[m,_]=this.pageDimensions,[p,b]=this.pageTranslation,A=c/h,T=d/h,v=this.x*m,N=this.y*_,x=this.width*m,y=this.height*_;switch(this.rotation){case 0:return[v+A+p,_-N-T-y+b,v+A+x+p,_-N-T+b];case 90:return[v+T+p,_-N+A+b,v+T+y+p,_-N+A+x+b];case 180:return[v-A-x+p,_-N+T+b,v-A+p,_-N+T+y+b];case 270:return[v-T-y+p,_-N-A-x+b,v-T+p,_-N-A+b];default:throw new Error("Invalid rotation")}}getRectInCurrentCoords(c,d){const[h,m,_,p]=c,b=_-h,A=p-m;switch(this.rotation){case 0:return[h,d-p,b,A];case 90:return[h,d-m,A,b];case 180:return[_,d-m,b,A];case 270:return[_,d-p,A,b];default:throw new Error("Invalid rotation")}}onceAdded(){}isEmpty(){return!1}enableEditMode(){this.#d=!0}disableEditMode(){this.#d=!1}isInEditMode(){return this.#d}shouldGetKeyboardEvents(){return!1}needsToBeRebuilt(){return this.div&&!this.isAttachedToDOM}rebuild(){this.div?.addEventListener("focusin",this.#u),this.div?.addEventListener("focusout",this.#c)}serialize(c=!1,d=null){(0,r.unreachable)("An editor must be serializable")}static deserialize(c,d,h){const m=new this.prototype.constructor({parent:d,id:d.getNextId(),uiManager:h});m.rotation=c.rotation;const[_,p]=m.pageDimensions,[b,A,T,v]=m.getRectInCurrentCoords(c.rect,p);return m.x=b/_,m.y=A/p,m.width=T/_,m.height=v/p,m}remove(){this.div.removeEventListener("focusin",this.#u),this.div.removeEventListener("focusout",this.#c),this.isEmpty()||this.commit(),this.parent?this.parent.remove(this):this._uiManager.removeEditor(this),this.#s?.remove(),this.#s=null,this.#n=null}get isResizable(){return!1}makeResizable(){this.isResizable&&(this.#b(),this.#a.classList.remove("hidden"))}select(){this.makeResizable(),this.div?.classList.add("selectedEditor")}unselect(){this.#a?.classList.add("hidden"),this.div?.classList.remove("selectedEditor"),this.div?.contains(document.activeElement)&&this._uiManager.currentLayer.div.focus()}updateParams(c,d){}disableEditing(){this.#s&&(this.#s.hidden=!0)}enableEditing(){this.#s&&(this.#s.hidden=!1)}enterInEditMode(){}get contentDiv(){return this.div}get isEditing(){return this.#f}set isEditing(c){this.#f=c,this.parent&&(c?(this.parent.setSelected(this),this.parent.setActiveEditor(this)):this.parent.setActiveEditor(null))}setAspectRatio(c,d){this.#o=!0;const h=c/d,{style:m}=this.div;m.aspectRatio=h,m.height="auto"}static get MIN_SIZE(){return 16}}e.AnnotationEditor=i;class u extends i{constructor(c){super(c),this.annotationElementId=c.annotationElementId,this.deleted=!0}serialize(){return{id:this.annotationElementId,deleted:!0,pageIndex:this.pageIndex}}}},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.KeyboardManager=e.CommandManager=e.ColorManager=e.AnnotationEditorUIManager=void 0,e.bindEvents=a,e.opacityToHex=i;var n=s(1),r=s(6);function a(_,p,b){for(const A of b)p.addEventListener(A,_[A].bind(_))}function i(_){return Math.round(Math.min(255,Math.max(1,255*_))).toString(16).padStart(2,"0")}class u{#e=0;getId(){return`${n.AnnotationEditorPrefix}${this.#e++}`}}class f{#e=(0,n.getUuid)();#t=0;#s=null;static get _isSVGFittingCanvas(){const p='data:image/svg+xml;charset=UTF-8,<svg viewBox="0 0 1 1" width="1" height="1" xmlns="http://www.w3.org/2000/svg"><rect width="1" height="1" style="fill:red;"/></svg>',A=new OffscreenCanvas(1,3).getContext("2d"),T=new Image;T.src=p;const v=T.decode().then(()=>(A.drawImage(T,0,0,1,1,0,0,1,3),new Uint32Array(A.getImageData(0,0,1,1).data.buffer)[0]===0));return(0,n.shadow)(this,"_isSVGFittingCanvas",v)}async#n(p,b){this.#s||=new Map;let A=this.#s.get(p);if(A===null)return null;if(A?.bitmap)return A.refCounter+=1,A;try{A||={bitmap:null,id:`image_${this.#e}_${this.#t++}`,refCounter:0,isSvg:!1};let T;if(typeof b=="string"){A.url=b;const v=await fetch(b);if(!v.ok)throw new Error(v.statusText);T=await v.blob()}else T=A.file=b;if(T.type==="image/svg+xml"){const v=f._isSVGFittingCanvas,N=new FileReader,x=new Image,y=new Promise((S,D)=>{x.onload=()=>{A.bitmap=x,A.isSvg=!0,S()},N.onload=async()=>{const F=A.svgUrl=N.result;x.src=await v?`${F}#svgView(preserveAspectRatio(none))`:F},x.onerror=N.onerror=D});N.readAsDataURL(T),await y}else A.bitmap=await createImageBitmap(T);A.refCounter=1}catch(T){console.error(T),A=null}return this.#s.set(p,A),A&&this.#s.set(A.id,A),A}async getFromFile(p){const{lastModified:b,name:A,size:T,type:v}=p;return this.#n(`${b}_${A}_${T}_${v}`,p)}async getFromUrl(p){return this.#n(p,p)}async getFromId(p){this.#s||=new Map;const b=this.#s.get(p);return b?b.bitmap?(b.refCounter+=1,b):b.file?this.getFromFile(b.file):this.getFromUrl(b.url):null}getSvgUrl(p){const b=this.#s.get(p);return b?.isSvg?b.svgUrl:null}deleteId(p){this.#s||=new Map;const b=this.#s.get(p);b&&(b.refCounter-=1,b.refCounter===0&&(b.bitmap=null))}isValidId(p){return p.startsWith(`image_${this.#e}_`)}}class c{#e=[];#t=!1;#s;#n=-1;constructor(p=128){this.#s=p}add({cmd:p,undo:b,mustExec:A,type:T=NaN,overwriteIfSameType:v=!1,keepUndo:N=!1}){if(A&&p(),this.#t)return;const x={cmd:p,undo:b,type:T};if(this.#n===-1){this.#e.length>0&&(this.#e.length=0),this.#n=0,this.#e.push(x);return}if(v&&this.#e[this.#n].type===T){N&&(x.undo=this.#e[this.#n].undo),this.#e[this.#n]=x;return}const y=this.#n+1;y===this.#s?this.#e.splice(0,1):(this.#n=y,y<this.#e.length&&this.#e.splice(y)),this.#e.push(x)}undo(){this.#n!==-1&&(this.#t=!0,this.#e[this.#n].undo(),this.#t=!1,this.#n-=1)}redo(){this.#n<this.#e.length-1&&(this.#n+=1,this.#t=!0,this.#e[this.#n].cmd(),this.#t=!1)}hasSomethingToUndo(){return this.#n!==-1}hasSomethingToRedo(){return this.#n<this.#e.length-1}destroy(){this.#e=null}}e.CommandManager=c;class d{constructor(p){this.buffer=[],this.callbacks=new Map,this.allKeys=new Set;const{isMac:b}=n.FeatureTest.platform;for(const[A,T,v={}]of p)for(const N of A){const x=N.startsWith("mac+");b&&x?(this.callbacks.set(N.slice(4),{callback:T,options:v}),this.allKeys.add(N.split("+").at(-1))):!b&&!x&&(this.callbacks.set(N,{callback:T,options:v}),this.allKeys.add(N.split("+").at(-1)))}}#e(p){p.altKey&&this.buffer.push("alt"),p.ctrlKey&&this.buffer.push("ctrl"),p.metaKey&&this.buffer.push("meta"),p.shiftKey&&this.buffer.push("shift"),this.buffer.push(p.key);const b=this.buffer.join("+");return this.buffer.length=0,b}exec(p,b){if(!this.allKeys.has(b.key))return;const A=this.callbacks.get(this.#e(b));if(!A)return;const{callback:T,options:{bubbles:v=!1,args:N=[],checker:x=null}}=A;x&&!x(p,b)||(T.bind(p,...N)(),v||(b.stopPropagation(),b.preventDefault()))}}e.KeyboardManager=d;class h{static _colorsMapping=new Map([["CanvasText",[0,0,0]],["Canvas",[255,255,255]]]);get _colors(){const p=new Map([["CanvasText",null],["Canvas",null]]);return(0,r.getColorValues)(p),(0,n.shadow)(this,"_colors",p)}convert(p){const b=(0,r.getRGB)(p);if(!window.matchMedia("(forced-colors: active)").matches)return b;for(const[A,T]of this._colors)if(T.every((v,N)=>v===b[N]))return h._colorsMapping.get(A);return b}getHexCode(p){const b=this._colors.get(p);return b?n.Util.makeHexColor(...b):p}}e.ColorManager=h;class m{#e=null;#t=new Map;#s=new Map;#n=null;#i=null;#o=new c;#a=0;#u=new Set;#c=null;#r=null;#f=new Set;#d=null;#h=new u;#p=!1;#_=!1;#g=null;#m=n.AnnotationEditorType.NONE;#l=new Set;#b=null;#S=this.blur.bind(this);#y=this.focus.bind(this);#v=this.copy.bind(this);#P=this.cut.bind(this);#k=this.paste.bind(this);#M=this.keydown.bind(this);#L=this.onEditingAction.bind(this);#T=this.onPageChanging.bind(this);#D=this.onScaleChanging.bind(this);#R=this.onRotationChanging.bind(this);#N={isEditing:!1,isEmpty:!0,hasSomethingToUndo:!1,hasSomethingToRedo:!1,hasSelectedEditor:!1};#A=[0,0];#w=null;#C=null;#F=null;static TRANSLATE_SMALL=1;static TRANSLATE_BIG=10;static get _keyboardManager(){const p=m.prototype,b=v=>{const{activeElement:N}=document;return N&&v.#C.contains(N)&&v.hasSomethingToControl()},A=this.TRANSLATE_SMALL,T=this.TRANSLATE_BIG;return(0,n.shadow)(this,"_keyboardManager",new d([[["ctrl+a","mac+meta+a"],p.selectAll],[["ctrl+z","mac+meta+z"],p.undo],[["ctrl+y","ctrl+shift+z","mac+meta+shift+z","ctrl+shift+Z","mac+meta+shift+Z"],p.redo],[["Backspace","alt+Backspace","ctrl+Backspace","shift+Backspace","mac+Backspace","mac+alt+Backspace","mac+ctrl+Backspace","Delete","ctrl+Delete","shift+Delete","mac+Delete"],p.delete],[["Escape","mac+Escape"],p.unselectAll],[["ArrowLeft","mac+ArrowLeft"],p.translateSelectedEditors,{args:[-A,0],checker:b}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],p.translateSelectedEditors,{args:[-T,0],checker:b}],[["ArrowRight","mac+ArrowRight"],p.translateSelectedEditors,{args:[A,0],checker:b}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],p.translateSelectedEditors,{args:[T,0],checker:b}],[["ArrowUp","mac+ArrowUp"],p.translateSelectedEditors,{args:[0,-A],checker:b}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],p.translateSelectedEditors,{args:[0,-T],checker:b}],[["ArrowDown","mac+ArrowDown"],p.translateSelectedEditors,{args:[0,A],checker:b}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],p.translateSelectedEditors,{args:[0,T],checker:b}]]))}constructor(p,b,A,T,v,N){this.#C=p,this.#F=b,this.#n=A,this._eventBus=T,this._eventBus._on("editingaction",this.#L),this._eventBus._on("pagechanging",this.#T),this._eventBus._on("scalechanging",this.#D),this._eventBus._on("rotationchanging",this.#R),this.#i=v.annotationStorage,this.#d=v.filterFactory,this.#b=N,this.viewParameters={realScale:r.PixelsPerInch.PDF_TO_CSS_UNITS,rotation:0}}destroy(){this.#O(),this.#B(),this._eventBus._off("editingaction",this.#L),this._eventBus._off("pagechanging",this.#T),this._eventBus._off("scalechanging",this.#D),this._eventBus._off("rotationchanging",this.#R);for(const p of this.#s.values())p.destroy();this.#s.clear(),this.#t.clear(),this.#f.clear(),this.#e=null,this.#l.clear(),this.#o.destroy(),this.#n.destroy()}get hcmFilter(){return(0,n.shadow)(this,"hcmFilter",this.#b?this.#d.addHCMFilter(this.#b.foreground,this.#b.background):"none")}get direction(){return(0,n.shadow)(this,"direction",getComputedStyle(this.#C).direction)}editAltText(p){this.#n?.editAltText(this,p)}onPageChanging({pageNumber:p}){this.#a=p-1}focusMainContainer(){this.#C.focus()}findParent(p,b){for(const A of this.#s.values()){const{x:T,y:v,width:N,height:x}=A.div.getBoundingClientRect();if(p>=T&&p<=T+N&&b>=v&&b<=v+x)return A}return null}disableUserSelect(p=!1){this.#F.classList.toggle("noUserSelect",p)}addShouldRescale(p){this.#f.add(p)}removeShouldRescale(p){this.#f.delete(p)}onScaleChanging({scale:p}){this.commitOrRemove(),this.viewParameters.realScale=p*r.PixelsPerInch.PDF_TO_CSS_UNITS;for(const b of this.#f)b.onScaleChanging()}onRotationChanging({pagesRotation:p}){this.commitOrRemove(),this.viewParameters.rotation=p}addToAnnotationStorage(p){!p.isEmpty()&&this.#i&&!this.#i.has(p.id)&&this.#i.setValue(p.id,p)}#$(){window.addEventListener("focus",this.#y),window.addEventListener("blur",this.#S)}#B(){window.removeEventListener("focus",this.#y),window.removeEventListener("blur",this.#S)}blur(){if(!this.hasSelection)return;const{activeElement:p}=document;for(const b of this.#l)if(b.div.contains(p)){this.#g=[b,p],b._focusEventsAllowed=!1;break}}focus(){if(!this.#g)return;const[p,b]=this.#g;this.#g=null,b.addEventListener("focusin",()=>{p._focusEventsAllowed=!0},{once:!0}),b.focus()}#U(){window.addEventListener("keydown",this.#M,{capture:!0})}#O(){window.removeEventListener("keydown",this.#M,{capture:!0})}#x(){document.addEventListener("copy",this.#v),document.addEventListener("cut",this.#P),document.addEventListener("paste",this.#k)}#I(){document.removeEventListener("copy",this.#v),document.removeEventListener("cut",this.#P),document.removeEventListener("paste",this.#k)}addEditListeners(){this.#U(),this.#x()}removeEditListeners(){this.#O(),this.#I()}copy(p){if(p.preventDefault(),this.#e?.commitOrRemove(),!this.hasSelection)return;const b=[];for(const A of this.#l){const T=A.serialize(!0);T&&b.push(T)}b.length!==0&&p.clipboardData.setData("application/pdfjs",JSON.stringify(b))}cut(p){this.copy(p),this.delete()}paste(p){p.preventDefault();const{clipboardData:b}=p;for(const v of b.items)for(const N of this.#r)if(N.isHandlingMimeForPasting(v.type)){N.paste(v,this.currentLayer);return}let A=b.getData("application/pdfjs");if(!A)return;try{A=JSON.parse(A)}catch(v){(0,n.warn)(`paste: "${v.message}".`);return}if(!Array.isArray(A))return;this.unselectAll();const T=this.currentLayer;try{const v=[];for(const y of A){const S=T.deserialize(y);if(!S)return;v.push(S)}const N=()=>{for(const y of v)this.#j(y);this.#q(v)},x=()=>{for(const y of v)y.remove()};this.addCommands({cmd:N,undo:x,mustExec:!0})}catch(v){(0,n.warn)(`paste: "${v.message}".`)}}keydown(p){this.getActive()?.shouldGetKeyboardEvents()||m._keyboardManager.exec(this,p)}onEditingAction(p){["undo","redo","delete","selectAll"].includes(p.name)&&this[p.name]()}#E(p){Object.entries(p).some(([A,T])=>this.#N[A]!==T)&&this._eventBus.dispatch("annotationeditorstateschanged",{source:this,details:Object.assign(this.#N,p)})}#G(p){this._eventBus.dispatch("annotationeditorparamschanged",{source:this,details:p})}setEditingState(p){p?(this.#$(),this.#U(),this.#x(),this.#E({isEditing:this.#m!==n.AnnotationEditorType.NONE,isEmpty:this.#H(),hasSomethingToUndo:this.#o.hasSomethingToUndo(),hasSomethingToRedo:this.#o.hasSomethingToRedo(),hasSelectedEditor:!1})):(this.#B(),this.#O(),this.#I(),this.#E({isEditing:!1}),this.disableUserSelect(!1))}registerEditorTypes(p){if(!this.#r){this.#r=p;for(const b of this.#r)this.#G(b.defaultPropertiesToUpdate)}}getId(){return this.#h.getId()}get currentLayer(){return this.#s.get(this.#a)}getLayer(p){return this.#s.get(p)}get currentPageIndex(){return this.#a}addLayer(p){this.#s.set(p.pageIndex,p),this.#p?p.enable():p.disable()}removeLayer(p){this.#s.delete(p.pageIndex)}updateMode(p,b=null){if(this.#m!==p){if(this.#m=p,p===n.AnnotationEditorType.NONE){this.setEditingState(!1),this.#W();return}this.setEditingState(!0),this.#V(),this.unselectAll();for(const A of this.#s.values())A.updateMode(p);if(b){for(const A of this.#t.values())if(A.annotationElementId===b){this.setSelected(A),A.enterInEditMode();break}}}}updateToolbar(p){p!==this.#m&&this._eventBus.dispatch("switchannotationeditormode",{source:this,mode:p})}updateParams(p,b){if(this.#r){if(p===n.AnnotationEditorParamsType.CREATE){this.currentLayer.addNewEditor(p);return}for(const A of this.#l)A.updateParams(p,b);for(const A of this.#r)A.updateDefaultParams(p,b)}}enableWaiting(p=!1){if(this.#_!==p){this.#_=p;for(const b of this.#s.values())p?b.disableClick():b.enableClick(),b.div.classList.toggle("waiting",p)}}#V(){if(!this.#p){this.#p=!0;for(const p of this.#s.values())p.enable()}}#W(){if(this.unselectAll(),this.#p){this.#p=!1;for(const p of this.#s.values())p.disable()}}getEditors(p){const b=[];for(const A of this.#t.values())A.pageIndex===p&&b.push(A);return b}getEditor(p){return this.#t.get(p)}addEditor(p){this.#t.set(p.id,p)}removeEditor(p){this.#t.delete(p.id),this.unselect(p),(!p.annotationElementId||!this.#u.has(p.annotationElementId))&&this.#i?.remove(p.id)}addDeletedAnnotationElement(p){this.#u.add(p.annotationElementId),p.deleted=!0}isDeletedAnnotationElement(p){return this.#u.has(p)}removeDeletedAnnotationElement(p){this.#u.delete(p.annotationElementId),p.deleted=!1}#j(p){const b=this.#s.get(p.pageIndex);b?b.addOrRebuild(p):this.addEditor(p)}setActiveEditor(p){this.#e!==p&&(this.#e=p,p&&this.#G(p.propertiesToUpdate))}toggleSelected(p){if(this.#l.has(p)){this.#l.delete(p),p.unselect(),this.#E({hasSelectedEditor:this.hasSelection});return}this.#l.add(p),p.select(),this.#G(p.propertiesToUpdate),this.#E({hasSelectedEditor:!0})}setSelected(p){for(const b of this.#l)b!==p&&b.unselect();this.#l.clear(),this.#l.add(p),p.select(),this.#G(p.propertiesToUpdate),this.#E({hasSelectedEditor:!0})}isSelected(p){return this.#l.has(p)}unselect(p){p.unselect(),this.#l.delete(p),this.#E({hasSelectedEditor:this.hasSelection})}get hasSelection(){return this.#l.size!==0}undo(){this.#o.undo(),this.#E({hasSomethingToUndo:this.#o.hasSomethingToUndo(),hasSomethingToRedo:!0,isEmpty:this.#H()})}redo(){this.#o.redo(),this.#E({hasSomethingToUndo:!0,hasSomethingToRedo:this.#o.hasSomethingToRedo(),isEmpty:this.#H()})}addCommands(p){this.#o.add(p),this.#E({hasSomethingToUndo:!0,hasSomethingToRedo:!1,isEmpty:this.#H()})}#H(){if(this.#t.size===0)return!0;if(this.#t.size===1)for(const p of this.#t.values())return p.isEmpty();return!1}delete(){if(this.commitOrRemove(),!this.hasSelection)return;const p=[...this.#l],b=()=>{for(const T of p)T.remove()},A=()=>{for(const T of p)this.#j(T)};this.addCommands({cmd:b,undo:A,mustExec:!0})}commitOrRemove(){this.#e?.commitOrRemove()}hasSomethingToControl(){return this.#e||this.hasSelection}#q(p){this.#l.clear();for(const b of p)b.isEmpty()||(this.#l.add(b),b.select());this.#E({hasSelectedEditor:!0})}selectAll(){for(const p of this.#l)p.commit();this.#q(this.#t.values())}unselectAll(){if(this.#e){this.#e.commitOrRemove();return}if(this.hasSelection){for(const p of this.#l)p.unselect();this.#l.clear(),this.#E({hasSelectedEditor:!1})}}translateSelectedEditors(p,b,A=!1){if(A||this.commitOrRemove(),!this.hasSelection)return;this.#A[0]+=p,this.#A[1]+=b;const[T,v]=this.#A,N=[...this.#l],x=1e3;this.#w&&clearTimeout(this.#w),this.#w=setTimeout(()=>{this.#w=null,this.#A[0]=this.#A[1]=0,this.addCommands({cmd:()=>{for(const y of N)this.#t.has(y.id)&&y.translateInPage(T,v)},undo:()=>{for(const y of N)this.#t.has(y.id)&&y.translateInPage(-T,-v)},mustExec:!1})},x);for(const y of N)y.translateInPage(p,b)}setUpDragSession(){if(this.hasSelection){this.disableUserSelect(!0),this.#c=new Map;for(const p of this.#l)this.#c.set(p,{savedX:p.x,savedY:p.y,savedPageIndex:p.pageIndex,newX:0,newY:0,newPageIndex:-1})}}endDragSession(){if(!this.#c)return!1;this.disableUserSelect(!1);const p=this.#c;this.#c=null;let b=!1;for(const[{x:T,y:v,pageIndex:N},x]of p)x.newX=T,x.newY=v,x.newPageIndex=N,b||=T!==x.savedX||v!==x.savedY||N!==x.savedPageIndex;if(!b)return!1;const A=(T,v,N,x)=>{if(this.#t.has(T.id)){const y=this.#s.get(x);y?T._setParentAndPosition(y,v,N):(T.pageIndex=x,T.x=v,T.y=N)}};return this.addCommands({cmd:()=>{for(const[T,{newX:v,newY:N,newPageIndex:x}]of p)A(T,v,N,x)},undo:()=>{for(const[T,{savedX:v,savedY:N,savedPageIndex:x}]of p)A(T,v,N,x)},mustExec:!0}),!0}dragSelectedEditors(p,b){if(this.#c)for(const A of this.#c.keys())A.drag(p,b)}rebuild(p){if(p.parent===null){const b=this.getLayer(p.pageIndex);b?(b.changeParent(p),b.addOrRebuild(p)):(this.addEditor(p),this.addToAnnotationStorage(p),p.rebuild())}else p.parent.addOrRebuild(p)}isActive(p){return this.#e===p}getActive(){return this.#e}getMode(){return this.#m}get imageManager(){return(0,n.shadow)(this,"imageManager",new f)}}e.AnnotationEditorUIManager=m},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.StatTimer=e.RenderingCancelledException=e.PixelsPerInch=e.PageViewport=e.PDFDateString=e.DOMStandardFontDataFactory=e.DOMSVGFactory=e.DOMFilterFactory=e.DOMCanvasFactory=e.DOMCMapReaderFactory=void 0,e.deprecated=D,e.getColorValues=re,e.getCurrentTransform=X,e.getCurrentTransformInverse=ne,e.getFilenameFromUrl=T,e.getPdfFilenameFromUrl=v,e.getRGB=z,e.getXfaPageViewport=W,e.isDataScheme=b,e.isPdfFile=A,e.isValidFetchUrl=x,e.loadScript=S,e.noContextMenu=y,e.setLayerDimensions=ie;var n=s(7),r=s(1);const a="http://www.w3.org/2000/svg";class i{static CSS=96;static PDF=72;static PDF_TO_CSS_UNITS=this.CSS/this.PDF}e.PixelsPerInch=i;class u extends n.BaseFilterFactory{#e;#t;#s;#n;#i;#o;#a;#u;#c;#r;#f=0;constructor({docId:H,ownerDocument:P=globalThis.document}={}){super(),this.#s=H,this.#n=P}get#d(){return this.#e||=new Map}get#h(){if(!this.#t){const H=this.#n.createElement("div"),{style:P}=H;P.visibility="hidden",P.contain="strict",P.width=P.height=0,P.position="absolute",P.top=P.left=0,P.zIndex=-1;const C=this.#n.createElementNS(a,"svg");C.setAttribute("width",0),C.setAttribute("height",0),this.#t=this.#n.createElementNS(a,"defs"),H.append(C),C.append(this.#t),this.#n.body.append(H)}return this.#t}addFilter(H){if(!H)return"none";let P=this.#d.get(H);if(P)return P;let C,I,R,L;if(H.length===1){const E=H[0],w=new Array(256);for(let O=0;O<256;O++)w[O]=E[O]/255;L=C=I=R=w.join(",")}else{const[E,w,O]=H,k=new Array(256),U=new Array(256),q=new Array(256);for(let V=0;V<256;V++)k[V]=E[V]/255,U[V]=w[V]/255,q[V]=O[V]/255;C=k.join(","),I=U.join(","),R=q.join(","),L=`${C}${I}${R}`}if(P=this.#d.get(L),P)return this.#d.set(H,P),P;const G=`g_${this.#s}_transfer_map_${this.#f++}`,j=`url(#${G})`;this.#d.set(H,j),this.#d.set(L,j);const M=this.#_(G);return this.#m(C,I,R,M),j}addHCMFilter(H,P){const C=`${H}-${P}`;if(this.#o===C)return this.#a;if(this.#o=C,this.#a="none",this.#i?.remove(),!H||!P)return this.#a;const I=this.#l(H);H=r.Util.makeHexColor(...I);const R=this.#l(P);if(P=r.Util.makeHexColor(...R),this.#h.style.color="",H==="#000000"&&P==="#ffffff"||H===P)return this.#a;const L=new Array(256);for(let w=0;w<=255;w++){const O=w/255;L[w]=O<=.03928?O/12.92:((O+.055)/1.055)**2.4}const G=L.join(","),j=`g_${this.#s}_hcm_filter`,M=this.#u=this.#_(j);this.#m(G,G,G,M),this.#p(M);const E=(w,O)=>{const k=I[w]/255,U=R[w]/255,q=new Array(O+1);for(let V=0;V<=O;V++)q[V]=k+V/O*(U-k);return q.join(",")};return this.#m(E(0,5),E(1,5),E(2,5),M),this.#a=`url(#${j})`,this.#a}addHighlightHCMFilter(H,P,C,I){const R=`${H}-${P}-${C}-${I}`;if(this.#c===R)return this.#r;if(this.#c=R,this.#r="none",this.#u?.remove(),!H||!P)return this.#r;const[L,G]=[H,P].map(this.#l.bind(this));let j=Math.round(.2126*L[0]+.7152*L[1]+.0722*L[2]),M=Math.round(.2126*G[0]+.7152*G[1]+.0722*G[2]),[E,w]=[C,I].map(this.#l.bind(this));M<j&&([j,M,E,w]=[M,j,w,E]),this.#h.style.color="";const O=(q,V,K)=>{const ue=new Array(256),Q=(M-j)/K,J=q/255,ee=(V-q)/(255*K);let se=0;for(let ae=0;ae<=K;ae++){const ce=Math.round(j+ae*Q),de=J+ae*ee;for(let he=se;he<=ce;he++)ue[he]=de;se=ce+1}for(let ae=se;ae<256;ae++)ue[ae]=ue[se-1];return ue.join(",")},k=`g_${this.#s}_hcm_highlight_filter`,U=this.#u=this.#_(k);return this.#p(U),this.#m(O(E[0],w[0],5),O(E[1],w[1],5),O(E[2],w[2],5),U),this.#r=`url(#${k})`,this.#r}destroy(H=!1){H&&(this.#a||this.#r)||(this.#t&&(this.#t.parentNode.parentNode.remove(),this.#t=null),this.#e&&(this.#e.clear(),this.#e=null),this.#f=0)}#p(H){const P=this.#n.createElementNS(a,"feColorMatrix");P.setAttribute("type","matrix"),P.setAttribute("values","0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0"),H.append(P)}#_(H){const P=this.#n.createElementNS(a,"filter");return P.setAttribute("color-interpolation-filters","sRGB"),P.setAttribute("id",H),this.#h.append(P),P}#g(H,P,C){const I=this.#n.createElementNS(a,P);I.setAttribute("type","discrete"),I.setAttribute("tableValues",C),H.append(I)}#m(H,P,C,I){const R=this.#n.createElementNS(a,"feComponentTransfer");I.append(R),this.#g(R,"feFuncR",H),this.#g(R,"feFuncG",P),this.#g(R,"feFuncB",C)}#l(H){return this.#h.style.color=H,z(getComputedStyle(this.#h).getPropertyValue("color"))}}e.DOMFilterFactory=u;class f extends n.BaseCanvasFactory{constructor({ownerDocument:H=globalThis.document}={}){super(),this._document=H}_createCanvas(H,P){const C=this._document.createElement("canvas");return C.width=H,C.height=P,C}}e.DOMCanvasFactory=f;async function c(te,H=!1){if(x(te,document.baseURI)){const P=await fetch(te);if(!P.ok)throw new Error(P.statusText);return H?new Uint8Array(await P.arrayBuffer()):(0,r.stringToBytes)(await P.text())}return new Promise((P,C)=>{const I=new XMLHttpRequest;I.open("GET",te,!0),H&&(I.responseType="arraybuffer"),I.onreadystatechange=()=>{if(I.readyState===XMLHttpRequest.DONE){if(I.status===200||I.status===0){let R;if(H&&I.response?R=new Uint8Array(I.response):!H&&I.responseText&&(R=(0,r.stringToBytes)(I.responseText)),R){P(R);return}}C(new Error(I.statusText))}},I.send(null)})}class d extends n.BaseCMapReaderFactory{_fetchData(H,P){return c(H,this.isCompressed).then(C=>({cMapData:C,compressionType:P}))}}e.DOMCMapReaderFactory=d;class h extends n.BaseStandardFontDataFactory{_fetchData(H){return c(H,!0)}}e.DOMStandardFontDataFactory=h;class m extends n.BaseSVGFactory{_createSVG(H){return document.createElementNS(a,H)}}e.DOMSVGFactory=m;class _{constructor({viewBox:H,scale:P,rotation:C,offsetX:I=0,offsetY:R=0,dontFlip:L=!1}){this.viewBox=H,this.scale=P,this.rotation=C,this.offsetX=I,this.offsetY=R;const G=(H[2]+H[0])/2,j=(H[3]+H[1])/2;let M,E,w,O;switch(C%=360,C<0&&(C+=360),C){case 180:M=-1,E=0,w=0,O=1;break;case 90:M=0,E=1,w=1,O=0;break;case 270:M=0,E=-1,w=-1,O=0;break;case 0:M=1,E=0,w=0,O=-1;break;default:throw new Error("PageViewport: Invalid rotation, must be a multiple of 90 degrees.")}L&&(w=-w,O=-O);let k,U,q,V;M===0?(k=Math.abs(j-H[1])*P+I,U=Math.abs(G-H[0])*P+R,q=(H[3]-H[1])*P,V=(H[2]-H[0])*P):(k=Math.abs(G-H[0])*P+I,U=Math.abs(j-H[1])*P+R,q=(H[2]-H[0])*P,V=(H[3]-H[1])*P),this.transform=[M*P,E*P,w*P,O*P,k-M*P*G-w*P*j,U-E*P*G-O*P*j],this.width=q,this.height=V}get rawDims(){const{viewBox:H}=this;return(0,r.shadow)(this,"rawDims",{pageWidth:H[2]-H[0],pageHeight:H[3]-H[1],pageX:H[0],pageY:H[1]})}clone({scale:H=this.scale,rotation:P=this.rotation,offsetX:C=this.offsetX,offsetY:I=this.offsetY,dontFlip:R=!1}={}){return new _({viewBox:this.viewBox.slice(),scale:H,rotation:P,offsetX:C,offsetY:I,dontFlip:R})}convertToViewportPoint(H,P){return r.Util.applyTransform([H,P],this.transform)}convertToViewportRectangle(H){const P=r.Util.applyTransform([H[0],H[1]],this.transform),C=r.Util.applyTransform([H[2],H[3]],this.transform);return[P[0],P[1],C[0],C[1]]}convertToPdfPoint(H,P){return r.Util.applyInverseTransform([H,P],this.transform)}}e.PageViewport=_;class p extends r.BaseException{constructor(H,P=0){super(H,"RenderingCancelledException"),this.extraDelay=P}}e.RenderingCancelledException=p;function b(te){const H=te.length;let P=0;for(;P<H&&te[P].trim()==="";)P++;return te.substring(P,P+5).toLowerCase()==="data:"}function A(te){return typeof te=="string"&&/\.pdf$/i.test(te)}function T(te,H=!1){return H||([te]=te.split(/[#?]/,1)),te.substring(te.lastIndexOf("/")+1)}function v(te,H="document.pdf"){if(typeof te!="string")return H;if(b(te))return(0,r.warn)('getPdfFilenameFromUrl: ignore "data:"-URL for performance reasons.'),H;const P=/^(?:(?:[^:]+:)?\/\/[^/]+)?([^?#]*)(\?[^#]*)?(#.*)?$/,C=/[^/?#=]+\.pdf\b(?!.*\.pdf\b)/i,I=P.exec(te);let R=C.exec(I[1])||C.exec(I[2])||C.exec(I[3]);if(R&&(R=R[0],R.includes("%")))try{R=C.exec(decodeURIComponent(R))[0]}catch{}return R||H}class N{started=Object.create(null);times=[];time(H){H in this.started&&(0,r.warn)(`Timer is already running for ${H}`),this.started[H]=Date.now()}timeEnd(H){H in this.started||(0,r.warn)(`Timer has not been started for ${H}`),this.times.push({name:H,start:this.started[H],end:Date.now()}),delete this.started[H]}toString(){const H=[];let P=0;for(const{name:C}of this.times)P=Math.max(C.length,P);for(const{name:C,start:I,end:R}of this.times)H.push(`${C.padEnd(P)} ${R-I}ms
`);return H.join("")}}e.StatTimer=N;function x(te,H){try{const{protocol:P}=H?new URL(te,H):new URL(te);return P==="http:"||P==="https:"}catch{return!1}}function y(te){te.preventDefault()}function S(te,H=!1){return new Promise((P,C)=>{const I=document.createElement("script");I.src=te,I.onload=function(R){H&&I.remove(),P(R)},I.onerror=function(){C(new Error(`Cannot load script at: ${I.src}`))},(document.head||document.documentElement).append(I)})}function D(te){console.log("Deprecated API usage: "+te)}let F;class B{static toDateObject(H){if(!H||typeof H!="string")return null;F||=new RegExp("^D:(\\d{4})(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?([Z|+|-])?(\\d{2})?'?(\\d{2})?'?");const P=F.exec(H);if(!P)return null;const C=parseInt(P[1],10);let I=parseInt(P[2],10);I=I>=1&&I<=12?I-1:0;let R=parseInt(P[3],10);R=R>=1&&R<=31?R:1;let L=parseInt(P[4],10);L=L>=0&&L<=23?L:0;let G=parseInt(P[5],10);G=G>=0&&G<=59?G:0;let j=parseInt(P[6],10);j=j>=0&&j<=59?j:0;const M=P[7]||"Z";let E=parseInt(P[8],10);E=E>=0&&E<=23?E:0;let w=parseInt(P[9],10)||0;return w=w>=0&&w<=59?w:0,M==="-"?(L+=E,G+=w):M==="+"&&(L-=E,G-=w),new Date(Date.UTC(C,I,R,L,G,j))}}e.PDFDateString=B;function W(te,{scale:H=1,rotation:P=0}){const{width:C,height:I}=te.attributes.style,R=[0,0,parseInt(C),parseInt(I)];return new _({viewBox:R,scale:H,rotation:P})}function z(te){if(te.startsWith("#")){const H=parseInt(te.slice(1),16);return[(H&16711680)>>16,(H&65280)>>8,H&255]}return te.startsWith("rgb(")?te.slice(4,-1).split(",").map(H=>parseInt(H)):te.startsWith("rgba(")?te.slice(5,-1).split(",").map(H=>parseInt(H)).slice(0,3):((0,r.warn)(`Not a valid color format: "${te}"`),[0,0,0])}function re(te){const H=document.createElement("span");H.style.visibility="hidden",document.body.append(H);for(const P of te.keys()){H.style.color=P;const C=window.getComputedStyle(H).color;te.set(P,z(C))}H.remove()}function X(te){const{a:H,b:P,c:C,d:I,e:R,f:L}=te.getTransform();return[H,P,C,I,R,L]}function ne(te){const{a:H,b:P,c:C,d:I,e:R,f:L}=te.getTransform().invertSelf();return[H,P,C,I,R,L]}function ie(te,H,P=!1,C=!0){if(H instanceof _){const{pageWidth:I,pageHeight:R}=H.rawDims,{style:L}=te,G=r.FeatureTest.isCSSRoundSupported,j=`var(--scale-factor) * ${I}px`,M=`var(--scale-factor) * ${R}px`,E=G?`round(${j}, 1px)`:`calc(${j})`,w=G?`round(${M}, 1px)`:`calc(${M})`;!P||H.rotation%180===0?(L.width=E,L.height=w):(L.width=w,L.height=E)}C&&te.setAttribute("data-main-rotation",H.rotation)}},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.BaseStandardFontDataFactory=e.BaseSVGFactory=e.BaseFilterFactory=e.BaseCanvasFactory=e.BaseCMapReaderFactory=void 0;var n=s(1);class r{constructor(){this.constructor===r&&(0,n.unreachable)("Cannot initialize BaseFilterFactory.")}addFilter(d){return"none"}addHCMFilter(d,h){return"none"}addHighlightHCMFilter(d,h,m,_){return"none"}destroy(d=!1){}}e.BaseFilterFactory=r;class a{constructor(){this.constructor===a&&(0,n.unreachable)("Cannot initialize BaseCanvasFactory.")}create(d,h){if(d<=0||h<=0)throw new Error("Invalid canvas size");const m=this._createCanvas(d,h);return{canvas:m,context:m.getContext("2d")}}reset(d,h,m){if(!d.canvas)throw new Error("Canvas is not specified");if(h<=0||m<=0)throw new Error("Invalid canvas size");d.canvas.width=h,d.canvas.height=m}destroy(d){if(!d.canvas)throw new Error("Canvas is not specified");d.canvas.width=0,d.canvas.height=0,d.canvas=null,d.context=null}_createCanvas(d,h){(0,n.unreachable)("Abstract method `_createCanvas` called.")}}e.BaseCanvasFactory=a;class i{constructor({baseUrl:d=null,isCompressed:h=!0}){this.constructor===i&&(0,n.unreachable)("Cannot initialize BaseCMapReaderFactory."),this.baseUrl=d,this.isCompressed=h}async fetch({name:d}){if(!this.baseUrl)throw new Error('The CMap "baseUrl" parameter must be specified, ensure that the "cMapUrl" and "cMapPacked" API parameters are provided.');if(!d)throw new Error("CMap name must be specified.");const h=this.baseUrl+d+(this.isCompressed?".bcmap":""),m=this.isCompressed?n.CMapCompressionType.BINARY:n.CMapCompressionType.NONE;return this._fetchData(h,m).catch(_=>{throw new Error(`Unable to load ${this.isCompressed?"binary ":""}CMap at: ${h}`)})}_fetchData(d,h){(0,n.unreachable)("Abstract method `_fetchData` called.")}}e.BaseCMapReaderFactory=i;class u{constructor({baseUrl:d=null}){this.constructor===u&&(0,n.unreachable)("Cannot initialize BaseStandardFontDataFactory."),this.baseUrl=d}async fetch({filename:d}){if(!this.baseUrl)throw new Error('The standard font "baseUrl" parameter must be specified, ensure that the "standardFontDataUrl" API parameter is provided.');if(!d)throw new Error("Font filename must be specified.");const h=`${this.baseUrl}${d}`;return this._fetchData(h).catch(m=>{throw new Error(`Unable to load font data at: ${h}`)})}_fetchData(d){(0,n.unreachable)("Abstract method `_fetchData` called.")}}e.BaseStandardFontDataFactory=u;class f{constructor(){this.constructor===f&&(0,n.unreachable)("Cannot initialize BaseSVGFactory.")}create(d,h,m=!1){if(d<=0||h<=0)throw new Error("Invalid SVG dimensions");const _=this._createSVG("svg:svg");return _.setAttribute("version","1.1"),m||(_.setAttribute("width",`${d}px`),_.setAttribute("height",`${h}px`)),_.setAttribute("preserveAspectRatio","none"),_.setAttribute("viewBox",`0 0 ${d} ${h}`),_}createElement(d){if(typeof d!="string")throw new Error("Invalid SVG element type");return this._createSVG(d)}_createSVG(d){(0,n.unreachable)("Abstract method `_createSVG` called.")}}e.BaseSVGFactory=f},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.MurmurHash3_64=void 0;var n=s(1);const r=3285377520,a=4294901760,i=65535;class u{constructor(c){this.h1=c?c&4294967295:r,this.h2=c?c&4294967295:r}update(c){let d,h;if(typeof c=="string"){d=new Uint8Array(c.length*2),h=0;for(let D=0,F=c.length;D<F;D++){const B=c.charCodeAt(D);B<=255?d[h++]=B:(d[h++]=B>>>8,d[h++]=B&255)}}else if((0,n.isArrayBuffer)(c))d=c.slice(),h=d.byteLength;else throw new Error("Wrong data format in MurmurHash3_64_update. Input must be a string or array.");const m=h>>2,_=h-m*4,p=new Uint32Array(d.buffer,0,m);let b=0,A=0,T=this.h1,v=this.h2;const N=3432918353,x=461845907,y=N&i,S=x&i;for(let D=0;D<m;D++)D&1?(b=p[D],b=b*N&a|b*y&i,b=b<<15|b>>>17,b=b*x&a|b*S&i,T^=b,T=T<<13|T>>>19,T=T*5+3864292196):(A=p[D],A=A*N&a|A*y&i,A=A<<15|A>>>17,A=A*x&a|A*S&i,v^=A,v=v<<13|v>>>19,v=v*5+3864292196);switch(b=0,_){case 3:b^=d[m*4+2]<<16;case 2:b^=d[m*4+1]<<8;case 1:b^=d[m*4],b=b*N&a|b*y&i,b=b<<15|b>>>17,b=b*x&a|b*S&i,m&1?T^=b:v^=b}this.h1=T,this.h2=v}hexdigest(){let c=this.h1,d=this.h2;return c^=d>>>1,c=c*3981806797&a|c*36045&i,d=d*4283543511&a|((d<<16|c>>>16)*2950163797&a)>>>16,c^=d>>>1,c=c*444984403&a|c*60499&i,d=d*3301882366&a|((d<<16|c>>>16)*3120437893&a)>>>16,c^=d>>>1,(c>>>0).toString(16).padStart(8,"0")+(d>>>0).toString(16).padStart(8,"0")}}e.MurmurHash3_64=u},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.FontLoader=e.FontFaceObject=void 0;var n=s(1);class r{#e=new Set;constructor({ownerDocument:u=globalThis.document,styleElement:f=null}){this._document=u,this.nativeFontFaces=new Set,this.styleElement=null,this.loadingRequests=[],this.loadTestFontId=0}addNativeFontFace(u){this.nativeFontFaces.add(u),this._document.fonts.add(u)}removeNativeFontFace(u){this.nativeFontFaces.delete(u),this._document.fonts.delete(u)}insertRule(u){this.styleElement||(this.styleElement=this._document.createElement("style"),this._document.documentElement.getElementsByTagName("head")[0].append(this.styleElement));const f=this.styleElement.sheet;f.insertRule(u,f.cssRules.length)}clear(){for(const u of this.nativeFontFaces)this._document.fonts.delete(u);this.nativeFontFaces.clear(),this.#e.clear(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}async loadSystemFont(u){if(!(!u||this.#e.has(u.loadedName))){if((0,n.assert)(!this.disableFontFace,"loadSystemFont shouldn't be called when `disableFontFace` is set."),this.isFontLoadingAPISupported){const{loadedName:f,src:c,style:d}=u,h=new FontFace(f,c,d);this.addNativeFontFace(h);try{await h.load(),this.#e.add(f)}catch{(0,n.warn)(`Cannot load system font: ${u.baseFontName}, installing it could help to improve PDF rendering.`),this.removeNativeFontFace(h)}return}(0,n.unreachable)("Not implemented: loadSystemFont without the Font Loading API.")}}async bind(u){if(u.attached||u.missingFile&&!u.systemFontInfo)return;if(u.attached=!0,u.systemFontInfo){await this.loadSystemFont(u.systemFontInfo);return}if(this.isFontLoadingAPISupported){const c=u.createNativeFontFace();if(c){this.addNativeFontFace(c);try{await c.loaded}catch(d){throw(0,n.warn)(`Failed to load font '${c.family}': '${d}'.`),u.disableFontFace=!0,d}}return}const f=u.createFontFaceRule();if(f){if(this.insertRule(f),this.isSyncFontLoadingSupported)return;await new Promise(c=>{const d=this._queueLoadingCallback(c);this._prepareFontLoadEvent(u,d)})}}get isFontLoadingAPISupported(){const u=!!this._document?.fonts;return(0,n.shadow)(this,"isFontLoadingAPISupported",u)}get isSyncFontLoadingSupported(){let u=!1;return(n.isNodeJS||typeof navigator<"u"&&/Mozilla\/5.0.*?rv:\d+.*? Gecko/.test(navigator.userAgent))&&(u=!0),(0,n.shadow)(this,"isSyncFontLoadingSupported",u)}_queueLoadingCallback(u){function f(){for((0,n.assert)(!d.done,"completeRequest() cannot be called twice."),d.done=!0;c.length>0&&c[0].done;){const h=c.shift();setTimeout(h.callback,0)}}const{loadingRequests:c}=this,d={done:!1,complete:f,callback:u};return c.push(d),d}get _loadTestFont(){const u=atob("T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQAFQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAAALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgAAAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACMAooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4DIP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAAAAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUAAQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgABAAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABYAAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAAAC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAAAAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQACAQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTjFQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA==");return(0,n.shadow)(this,"_loadTestFont",u)}_prepareFontLoadEvent(u,f){function c(W,z){return W.charCodeAt(z)<<24|W.charCodeAt(z+1)<<16|W.charCodeAt(z+2)<<8|W.charCodeAt(z+3)&255}function d(W,z,re,X){const ne=W.substring(0,z),ie=W.substring(z+re);return ne+X+ie}let h,m;const _=this._document.createElement("canvas");_.width=1,_.height=1;const p=_.getContext("2d");let b=0;function A(W,z){if(++b>30){(0,n.warn)("Load test font never loaded."),z();return}if(p.font="30px "+W,p.fillText(".",0,20),p.getImageData(0,0,1,1).data[3]>0){z();return}setTimeout(A.bind(null,W,z))}const T=`lt${Date.now()}${this.loadTestFontId++}`;let v=this._loadTestFont;v=d(v,976,T.length,T);const x=16,y=1482184792;let S=c(v,x);for(h=0,m=T.length-3;h<m;h+=4)S=S-y+c(T,h)|0;h<T.length&&(S=S-y+c(T+"XXX",h)|0),v=d(v,x,4,(0,n.string32)(S));const D=`url(data:font/opentype;base64,${btoa(v)});`,F=`@font-face {font-family:"${T}";src:${D}}`;this.insertRule(F);const B=this._document.createElement("div");B.style.visibility="hidden",B.style.width=B.style.height="10px",B.style.position="absolute",B.style.top=B.style.left="0px";for(const W of[u.loadedName,T]){const z=this._document.createElement("span");z.textContent="Hi",z.style.fontFamily=W,B.append(z)}this._document.body.append(B),A(T,()=>{B.remove(),f.complete()})}}e.FontLoader=r;class a{constructor(u,{isEvalSupported:f=!0,disableFontFace:c=!1,ignoreErrors:d=!1,inspectFont:h=null}){this.compiledGlyphs=Object.create(null);for(const m in u)this[m]=u[m];this.isEvalSupported=f!==!1,this.disableFontFace=c===!0,this.ignoreErrors=d===!0,this._inspectFont=h}createNativeFontFace(){if(!this.data||this.disableFontFace)return null;let u;if(!this.cssFontInfo)u=new FontFace(this.loadedName,this.data,{});else{const f={weight:this.cssFontInfo.fontWeight};this.cssFontInfo.italicAngle&&(f.style=`oblique ${this.cssFontInfo.italicAngle}deg`),u=new FontFace(this.cssFontInfo.fontFamily,this.data,f)}return this._inspectFont?.(this),u}createFontFaceRule(){if(!this.data||this.disableFontFace)return null;const u=(0,n.bytesToString)(this.data),f=`url(data:${this.mimetype};base64,${btoa(u)});`;let c;if(!this.cssFontInfo)c=`@font-face {font-family:"${this.loadedName}";src:${f}}`;else{let d=`font-weight: ${this.cssFontInfo.fontWeight};`;this.cssFontInfo.italicAngle&&(d+=`font-style: oblique ${this.cssFontInfo.italicAngle}deg;`),c=`@font-face {font-family:"${this.cssFontInfo.fontFamily}";${d}src:${f}}`}return this._inspectFont?.(this,f),c}getPathGenerator(u,f){if(this.compiledGlyphs[f]!==void 0)return this.compiledGlyphs[f];let c;try{c=u.get(this.loadedName+"_path_"+f)}catch(d){if(!this.ignoreErrors)throw d;return(0,n.warn)(`getPathGenerator - ignoring character: "${d}".`),this.compiledGlyphs[f]=function(h,m){}}if(this.isEvalSupported&&n.FeatureTest.isEvalSupported){const d=[];for(const h of c){const m=h.args!==void 0?h.args.join(","):"";d.push("c.",h.cmd,"(",m,`);
`)}return this.compiledGlyphs[f]=new Function("c","size",d.join(""))}return this.compiledGlyphs[f]=function(d,h){for(const m of c)m.cmd==="scale"&&(m.args=[h,-h]),d[m.cmd].apply(d,m.args)}}}e.FontFaceObject=a},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.NodeStandardFontDataFactory=e.NodeFilterFactory=e.NodeCanvasFactory=e.NodeCMapReaderFactory=void 0;var n=s(7);s(1);const r=function(c){return new Promise((d,h)=>{require$$0.readFile(c,(_,p)=>{if(_||!p){h(new Error(_));return}d(new Uint8Array(p))})})};class a extends n.BaseFilterFactory{}e.NodeFilterFactory=a;class i extends n.BaseCanvasFactory{_createCanvas(d,h){return require$$0.createCanvas(d,h)}}e.NodeCanvasFactory=i;class u extends n.BaseCMapReaderFactory{_fetchData(d,h){return r(d).then(m=>({cMapData:m,compressionType:h}))}}e.NodeCMapReaderFactory=u;class f extends n.BaseStandardFontDataFactory{_fetchData(d){return r(d)}}e.NodeStandardFontDataFactory=f},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.CanvasGraphics=void 0;var n=s(1),r=s(6),a=s(12),i=s(13);const u=16,f=100,c=4096,d=15,h=10,m=1e3,_=16;function p(P,C){if(P._removeMirroring)throw new Error("Context is already forwarding operations.");P.__originalSave=P.save,P.__originalRestore=P.restore,P.__originalRotate=P.rotate,P.__originalScale=P.scale,P.__originalTranslate=P.translate,P.__originalTransform=P.transform,P.__originalSetTransform=P.setTransform,P.__originalResetTransform=P.resetTransform,P.__originalClip=P.clip,P.__originalMoveTo=P.moveTo,P.__originalLineTo=P.lineTo,P.__originalBezierCurveTo=P.bezierCurveTo,P.__originalRect=P.rect,P.__originalClosePath=P.closePath,P.__originalBeginPath=P.beginPath,P._removeMirroring=()=>{P.save=P.__originalSave,P.restore=P.__originalRestore,P.rotate=P.__originalRotate,P.scale=P.__originalScale,P.translate=P.__originalTranslate,P.transform=P.__originalTransform,P.setTransform=P.__originalSetTransform,P.resetTransform=P.__originalResetTransform,P.clip=P.__originalClip,P.moveTo=P.__originalMoveTo,P.lineTo=P.__originalLineTo,P.bezierCurveTo=P.__originalBezierCurveTo,P.rect=P.__originalRect,P.closePath=P.__originalClosePath,P.beginPath=P.__originalBeginPath,delete P._removeMirroring},P.save=function(){C.save(),this.__originalSave()},P.restore=function(){C.restore(),this.__originalRestore()},P.translate=function(R,L){C.translate(R,L),this.__originalTranslate(R,L)},P.scale=function(R,L){C.scale(R,L),this.__originalScale(R,L)},P.transform=function(R,L,G,j,M,E){C.transform(R,L,G,j,M,E),this.__originalTransform(R,L,G,j,M,E)},P.setTransform=function(R,L,G,j,M,E){C.setTransform(R,L,G,j,M,E),this.__originalSetTransform(R,L,G,j,M,E)},P.resetTransform=function(){C.resetTransform(),this.__originalResetTransform()},P.rotate=function(R){C.rotate(R),this.__originalRotate(R)},P.clip=function(R){C.clip(R),this.__originalClip(R)},P.moveTo=function(I,R){C.moveTo(I,R),this.__originalMoveTo(I,R)},P.lineTo=function(I,R){C.lineTo(I,R),this.__originalLineTo(I,R)},P.bezierCurveTo=function(I,R,L,G,j,M){C.bezierCurveTo(I,R,L,G,j,M),this.__originalBezierCurveTo(I,R,L,G,j,M)},P.rect=function(I,R,L,G){C.rect(I,R,L,G),this.__originalRect(I,R,L,G)},P.closePath=function(){C.closePath(),this.__originalClosePath()},P.beginPath=function(){C.beginPath(),this.__originalBeginPath()}}class b{constructor(C){this.canvasFactory=C,this.cache=Object.create(null)}getCanvas(C,I,R){let L;return this.cache[C]!==void 0?(L=this.cache[C],this.canvasFactory.reset(L,I,R)):(L=this.canvasFactory.create(I,R),this.cache[C]=L),L}delete(C){delete this.cache[C]}clear(){for(const C in this.cache){const I=this.cache[C];this.canvasFactory.destroy(I),delete this.cache[C]}}}function A(P,C,I,R,L,G,j,M,E,w){const[O,k,U,q,V,K]=(0,r.getCurrentTransform)(P);if(k===0&&U===0){const J=j*O+V,ee=Math.round(J),se=M*q+K,ae=Math.round(se),ce=(j+E)*O+V,de=Math.abs(Math.round(ce)-ee)||1,he=(M+w)*q+K,fe=Math.abs(Math.round(he)-ae)||1;return P.setTransform(Math.sign(O),0,0,Math.sign(q),ee,ae),P.drawImage(C,I,R,L,G,0,0,de,fe),P.setTransform(O,k,U,q,V,K),[de,fe]}if(O===0&&q===0){const J=M*U+V,ee=Math.round(J),se=j*k+K,ae=Math.round(se),ce=(M+w)*U+V,de=Math.abs(Math.round(ce)-ee)||1,he=(j+E)*k+K,fe=Math.abs(Math.round(he)-ae)||1;return P.setTransform(0,Math.sign(k),Math.sign(U),0,ee,ae),P.drawImage(C,I,R,L,G,0,0,fe,de),P.setTransform(O,k,U,q,V,K),[fe,de]}P.drawImage(C,I,R,L,G,j,M,E,w);const ue=Math.hypot(O,k),Q=Math.hypot(U,q);return[ue*E,Q*w]}function T(P){const{width:C,height:I}=P;if(C>m||I>m)return null;const R=1e3,L=new Uint8Array([0,2,4,0,1,0,5,4,8,10,0,8,0,2,1,0]),G=C+1;let j=new Uint8Array(G*(I+1)),M,E,w;const O=C+7&-8;let k=new Uint8Array(O*I),U=0;for(const Q of P.data){let J=128;for(;J>0;)k[U++]=Q&J?0:255,J>>=1}let q=0;for(U=0,k[U]!==0&&(j[0]=1,++q),E=1;E<C;E++)k[U]!==k[U+1]&&(j[E]=k[U]?2:1,++q),U++;for(k[U]!==0&&(j[E]=2,++q),M=1;M<I;M++){U=M*O,w=M*G,k[U-O]!==k[U]&&(j[w]=k[U]?1:8,++q);let Q=(k[U]?4:0)+(k[U-O]?8:0);for(E=1;E<C;E++)Q=(Q>>2)+(k[U+1]?4:0)+(k[U-O+1]?8:0),L[Q]&&(j[w+E]=L[Q],++q),U++;if(k[U-O]!==k[U]&&(j[w+E]=k[U]?2:4,++q),q>R)return null}for(U=O*(I-1),w=M*G,k[U]!==0&&(j[w]=8,++q),E=1;E<C;E++)k[U]!==k[U+1]&&(j[w+E]=k[U]?4:8,++q),U++;if(k[U]!==0&&(j[w+E]=4,++q),q>R)return null;const V=new Int32Array([0,G,-1,0,-G,0,0,0,1]),K=new Path2D;for(M=0;q&&M<=I;M++){let Q=M*G;const J=Q+C;for(;Q<J&&!j[Q];)Q++;if(Q===J)continue;K.moveTo(Q%G,M);const ee=Q;let se=j[Q];do{const ae=V[se];do Q+=ae;while(!j[Q]);const ce=j[Q];ce!==5&&ce!==10?(se=ce,j[Q]=0):(se=ce&51*se>>4,j[Q]&=se>>2|se<<2),K.lineTo(Q%G,Q/G|0),j[Q]||--q}while(ee!==Q);--M}return k=null,j=null,function(Q){Q.save(),Q.scale(1/C,-1/I),Q.translate(0,-I),Q.fill(K),Q.beginPath(),Q.restore()}}class v{constructor(C,I){this.alphaIsShape=!1,this.fontSize=0,this.fontSizeScale=1,this.textMatrix=n.IDENTITY_MATRIX,this.textMatrixScale=1,this.fontMatrix=n.FONT_IDENTITY_MATRIX,this.leading=0,this.x=0,this.y=0,this.lineX=0,this.lineY=0,this.charSpacing=0,this.wordSpacing=0,this.textHScale=1,this.textRenderingMode=n.TextRenderingMode.FILL,this.textRise=0,this.fillColor="#000000",this.strokeColor="#000000",this.patternFill=!1,this.fillAlpha=1,this.strokeAlpha=1,this.lineWidth=1,this.activeSMask=null,this.transferMaps="none",this.startNewPathAndClipBox([0,0,C,I])}clone(){const C=Object.create(this);return C.clipBox=this.clipBox.slice(),C}setCurrentPoint(C,I){this.x=C,this.y=I}updatePathMinMax(C,I,R){[I,R]=n.Util.applyTransform([I,R],C),this.minX=Math.min(this.minX,I),this.minY=Math.min(this.minY,R),this.maxX=Math.max(this.maxX,I),this.maxY=Math.max(this.maxY,R)}updateRectMinMax(C,I){const R=n.Util.applyTransform(I,C),L=n.Util.applyTransform(I.slice(2),C);this.minX=Math.min(this.minX,R[0],L[0]),this.minY=Math.min(this.minY,R[1],L[1]),this.maxX=Math.max(this.maxX,R[0],L[0]),this.maxY=Math.max(this.maxY,R[1],L[1])}updateScalingPathMinMax(C,I){n.Util.scaleMinMax(C,I),this.minX=Math.min(this.minX,I[0]),this.maxX=Math.max(this.maxX,I[1]),this.minY=Math.min(this.minY,I[2]),this.maxY=Math.max(this.maxY,I[3])}updateCurvePathMinMax(C,I,R,L,G,j,M,E,w,O){const k=n.Util.bezierBoundingBox(I,R,L,G,j,M,E,w);if(O){O[0]=Math.min(O[0],k[0],k[2]),O[1]=Math.max(O[1],k[0],k[2]),O[2]=Math.min(O[2],k[1],k[3]),O[3]=Math.max(O[3],k[1],k[3]);return}this.updateRectMinMax(C,k)}getPathBoundingBox(C=a.PathType.FILL,I=null){const R=[this.minX,this.minY,this.maxX,this.maxY];if(C===a.PathType.STROKE){I||(0,n.unreachable)("Stroke bounding box must include transform.");const L=n.Util.singularValueDecompose2dScale(I),G=L[0]*this.lineWidth/2,j=L[1]*this.lineWidth/2;R[0]-=G,R[1]-=j,R[2]+=G,R[3]+=j}return R}updateClipFromPath(){const C=n.Util.intersect(this.clipBox,this.getPathBoundingBox());this.startNewPathAndClipBox(C||[0,0,0,0])}isEmptyClip(){return this.minX===1/0}startNewPathAndClipBox(C){this.clipBox=C,this.minX=1/0,this.minY=1/0,this.maxX=0,this.maxY=0}getClippedPathBoundingBox(C=a.PathType.FILL,I=null){return n.Util.intersect(this.clipBox,this.getPathBoundingBox(C,I))}}function N(P,C){if(typeof ImageData<"u"&&C instanceof ImageData){P.putImageData(C,0,0);return}const I=C.height,R=C.width,L=I%_,G=(I-L)/_,j=L===0?G:G+1,M=P.createImageData(R,_);let E=0,w;const O=C.data,k=M.data;let U,q,V,K;if(C.kind===n.ImageKind.GRAYSCALE_1BPP){const ue=O.byteLength,Q=new Uint32Array(k.buffer,0,k.byteLength>>2),J=Q.length,ee=R+7>>3,se=4294967295,ae=n.FeatureTest.isLittleEndian?4278190080:255;for(U=0;U<j;U++){for(V=U<G?_:L,w=0,q=0;q<V;q++){const ce=ue-E;let de=0;const he=ce>ee?R:ce*8-7,fe=he&-8;let pe=0,ge=0;for(;de<fe;de+=8)ge=O[E++],Q[w++]=ge&128?se:ae,Q[w++]=ge&64?se:ae,Q[w++]=ge&32?se:ae,Q[w++]=ge&16?se:ae,Q[w++]=ge&8?se:ae,Q[w++]=ge&4?se:ae,Q[w++]=ge&2?se:ae,Q[w++]=ge&1?se:ae;for(;de<he;de++)pe===0&&(ge=O[E++],pe=128),Q[w++]=ge&pe?se:ae,pe>>=1}for(;w<J;)Q[w++]=0;P.putImageData(M,0,U*_)}}else if(C.kind===n.ImageKind.RGBA_32BPP){for(q=0,K=R*_*4,U=0;U<G;U++)k.set(O.subarray(E,E+K)),E+=K,P.putImageData(M,0,q),q+=_;U<j&&(K=R*L*4,k.set(O.subarray(E,E+K)),P.putImageData(M,0,q))}else if(C.kind===n.ImageKind.RGB_24BPP)for(V=_,K=R*V,U=0;U<j;U++){for(U>=G&&(V=L,K=R*V),w=0,q=K;q--;)k[w++]=O[E++],k[w++]=O[E++],k[w++]=O[E++],k[w++]=255;P.putImageData(M,0,U*_)}else throw new Error(`bad image kind: ${C.kind}`)}function x(P,C){if(C.bitmap){P.drawImage(C.bitmap,0,0);return}const I=C.height,R=C.width,L=I%_,G=(I-L)/_,j=L===0?G:G+1,M=P.createImageData(R,_);let E=0;const w=C.data,O=M.data;for(let k=0;k<j;k++){const U=k<G?_:L;({srcPos:E}=(0,i.convertBlackAndWhiteToRGBA)({src:w,srcPos:E,dest:O,width:R,height:U,nonBlackColor:0})),P.putImageData(M,0,k*_)}}function y(P,C){const I=["strokeStyle","fillStyle","fillRule","globalAlpha","lineWidth","lineCap","lineJoin","miterLimit","globalCompositeOperation","font","filter"];for(const R of I)P[R]!==void 0&&(C[R]=P[R]);P.setLineDash!==void 0&&(C.setLineDash(P.getLineDash()),C.lineDashOffset=P.lineDashOffset)}function S(P){if(P.strokeStyle=P.fillStyle="#000000",P.fillRule="nonzero",P.globalAlpha=1,P.lineWidth=1,P.lineCap="butt",P.lineJoin="miter",P.miterLimit=10,P.globalCompositeOperation="source-over",P.font="10px sans-serif",P.setLineDash!==void 0&&(P.setLineDash([]),P.lineDashOffset=0),!n.isNodeJS){const{filter:C}=P;C!=="none"&&C!==""&&(P.filter="none")}}function D(P,C,I,R){const L=P.length;for(let G=3;G<L;G+=4){const j=P[G];if(j===0)P[G-3]=C,P[G-2]=I,P[G-1]=R;else if(j<255){const M=255-j;P[G-3]=P[G-3]*j+C*M>>8,P[G-2]=P[G-2]*j+I*M>>8,P[G-1]=P[G-1]*j+R*M>>8}}}function F(P,C,I){const R=P.length,L=1/255;for(let G=3;G<R;G+=4){const j=I?I[P[G]]:P[G];C[G]=C[G]*j*L|0}}function B(P,C,I){const R=P.length;for(let L=3;L<R;L+=4){const G=P[L-3]*77+P[L-2]*152+P[L-1]*28;C[L]=I?C[L]*I[G>>8]>>8:C[L]*G>>16}}function W(P,C,I,R,L,G,j,M,E,w,O){const k=!!G,U=k?G[0]:0,q=k?G[1]:0,V=k?G[2]:0,K=L==="Luminosity"?B:F,Q=Math.min(R,Math.ceil(1048576/I));for(let J=0;J<R;J+=Q){const ee=Math.min(Q,R-J),se=P.getImageData(M-w,J+(E-O),I,ee),ae=C.getImageData(M,J+E,I,ee);k&&D(se.data,U,q,V),K(se.data,ae.data,j),C.putImageData(ae,M,J+E)}}function z(P,C,I,R){const L=R[0],G=R[1],j=R[2]-L,M=R[3]-G;j===0||M===0||(W(C.context,I,j,M,C.subtype,C.backdrop,C.transferMap,L,G,C.offsetX,C.offsetY),P.save(),P.globalAlpha=1,P.globalCompositeOperation="source-over",P.setTransform(1,0,0,1,0,0),P.drawImage(I.canvas,0,0),P.restore())}function re(P,C){const I=n.Util.singularValueDecompose2dScale(P);I[0]=Math.fround(I[0]),I[1]=Math.fround(I[1]);const R=Math.fround((globalThis.devicePixelRatio||1)*r.PixelsPerInch.PDF_TO_CSS_UNITS);return C!==void 0?C:I[0]<=R||I[1]<=R}const X=["butt","round","square"],ne=["miter","round","bevel"],ie={},te={};class H{constructor(C,I,R,L,G,{optionalContentConfig:j,markedContentStack:M=null},E,w){this.ctx=C,this.current=new v(this.ctx.canvas.width,this.ctx.canvas.height),this.stateStack=[],this.pendingClip=null,this.pendingEOFill=!1,this.res=null,this.xobjs=null,this.commonObjs=I,this.objs=R,this.canvasFactory=L,this.filterFactory=G,this.groupStack=[],this.processingType3=null,this.baseTransform=null,this.baseTransformStack=[],this.groupLevel=0,this.smaskStack=[],this.smaskCounter=0,this.tempSMask=null,this.suspendedCtx=null,this.contentVisible=!0,this.markedContentStack=M||[],this.optionalContentConfig=j,this.cachedCanvases=new b(this.canvasFactory),this.cachedPatterns=new Map,this.annotationCanvasMap=E,this.viewportScale=1,this.outputScaleX=1,this.outputScaleY=1,this.pageColors=w,this._cachedScaleForStroking=[-1,0],this._cachedGetSinglePixelWidth=null,this._cachedBitmapsMap=new Map}getObject(C,I=null){return typeof C=="string"?C.startsWith("g_")?this.commonObjs.get(C):this.objs.get(C):I}beginDrawing({transform:C,viewport:I,transparency:R=!1,background:L=null}){const G=this.ctx.canvas.width,j=this.ctx.canvas.height,M=this.ctx.fillStyle;if(this.ctx.fillStyle=L||"#ffffff",this.ctx.fillRect(0,0,G,j),this.ctx.fillStyle=M,R){const E=this.cachedCanvases.getCanvas("transparent",G,j);this.compositeCtx=this.ctx,this.transparentCanvas=E.canvas,this.ctx=E.context,this.ctx.save(),this.ctx.transform(...(0,r.getCurrentTransform)(this.compositeCtx))}this.ctx.save(),S(this.ctx),C&&(this.ctx.transform(...C),this.outputScaleX=C[0],this.outputScaleY=C[0]),this.ctx.transform(...I.transform),this.viewportScale=I.scale,this.baseTransform=(0,r.getCurrentTransform)(this.ctx)}executeOperatorList(C,I,R,L){const G=C.argsArray,j=C.fnArray;let M=I||0;const E=G.length;if(E===M)return M;const w=E-M>h&&typeof R=="function",O=w?Date.now()+d:0;let k=0;const U=this.commonObjs,q=this.objs;let V;for(;;){if(L!==void 0&&M===L.nextBreakPoint)return L.breakIt(M,R),M;if(V=j[M],V!==n.OPS.dependency)this[V].apply(this,G[M]);else for(const K of G[M]){const ue=K.startsWith("g_")?U:q;if(!ue.has(K))return ue.get(K,R),M}if(M++,M===E)return M;if(w&&++k>h){if(Date.now()>O)return R(),M;k=0}}}#e(){for(;this.stateStack.length||this.inSMaskMode;)this.restore();this.ctx.restore(),this.transparentCanvas&&(this.ctx=this.compositeCtx,this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.drawImage(this.transparentCanvas,0,0),this.ctx.restore(),this.transparentCanvas=null)}endDrawing(){this.#e(),this.cachedCanvases.clear(),this.cachedPatterns.clear();for(const C of this._cachedBitmapsMap.values()){for(const I of C.values())typeof HTMLCanvasElement<"u"&&I instanceof HTMLCanvasElement&&(I.width=I.height=0);C.clear()}this._cachedBitmapsMap.clear(),this.#t()}#t(){if(this.pageColors){const C=this.filterFactory.addHCMFilter(this.pageColors.foreground,this.pageColors.background);if(C!=="none"){const I=this.ctx.filter;this.ctx.filter=C,this.ctx.drawImage(this.ctx.canvas,0,0),this.ctx.filter=I}}}_scaleImage(C,I){const R=C.width,L=C.height;let G=Math.max(Math.hypot(I[0],I[1]),1),j=Math.max(Math.hypot(I[2],I[3]),1),M=R,E=L,w="prescale1",O,k;for(;G>2&&M>1||j>2&&E>1;){let U=M,q=E;G>2&&M>1&&(U=M>=16384?Math.floor(M/2)-1||1:Math.ceil(M/2),G/=M/U),j>2&&E>1&&(q=E>=16384?Math.floor(E/2)-1||1:Math.ceil(E)/2,j/=E/q),O=this.cachedCanvases.getCanvas(w,U,q),k=O.context,k.clearRect(0,0,U,q),k.drawImage(C,0,0,M,E,0,0,U,q),C=O.canvas,M=U,E=q,w=w==="prescale1"?"prescale2":"prescale1"}return{img:C,paintWidth:M,paintHeight:E}}_createMaskCanvas(C){const I=this.ctx,{width:R,height:L}=C,G=this.current.fillColor,j=this.current.patternFill,M=(0,r.getCurrentTransform)(I);let E,w,O,k;if((C.bitmap||C.data)&&C.count>1){const de=C.bitmap||C.data.buffer;w=JSON.stringify(j?M:[M.slice(0,4),G]),E=this._cachedBitmapsMap.get(de),E||(E=new Map,this._cachedBitmapsMap.set(de,E));const he=E.get(w);if(he&&!j){const fe=Math.round(Math.min(M[0],M[2])+M[4]),pe=Math.round(Math.min(M[1],M[3])+M[5]);return{canvas:he,offsetX:fe,offsetY:pe}}O=he}O||(k=this.cachedCanvases.getCanvas("maskCanvas",R,L),x(k.context,C));let U=n.Util.transform(M,[1/R,0,0,-1/L,0,0]);U=n.Util.transform(U,[1,0,0,1,0,-L]);const q=n.Util.applyTransform([0,0],U),V=n.Util.applyTransform([R,L],U),K=n.Util.normalizeRect([q[0],q[1],V[0],V[1]]),ue=Math.round(K[2]-K[0])||1,Q=Math.round(K[3]-K[1])||1,J=this.cachedCanvases.getCanvas("fillCanvas",ue,Q),ee=J.context,se=Math.min(q[0],V[0]),ae=Math.min(q[1],V[1]);ee.translate(-se,-ae),ee.transform(...U),O||(O=this._scaleImage(k.canvas,(0,r.getCurrentTransformInverse)(ee)),O=O.img,E&&j&&E.set(w,O)),ee.imageSmoothingEnabled=re((0,r.getCurrentTransform)(ee),C.interpolate),A(ee,O,0,0,O.width,O.height,0,0,R,L),ee.globalCompositeOperation="source-in";const ce=n.Util.transform((0,r.getCurrentTransformInverse)(ee),[1,0,0,1,-se,-ae]);return ee.fillStyle=j?G.getPattern(I,this,ce,a.PathType.FILL):G,ee.fillRect(0,0,R,L),E&&!j&&(this.cachedCanvases.delete("fillCanvas"),E.set(w,J.canvas)),{canvas:J.canvas,offsetX:Math.round(se),offsetY:Math.round(ae)}}setLineWidth(C){C!==this.current.lineWidth&&(this._cachedScaleForStroking[0]=-1),this.current.lineWidth=C,this.ctx.lineWidth=C}setLineCap(C){this.ctx.lineCap=X[C]}setLineJoin(C){this.ctx.lineJoin=ne[C]}setMiterLimit(C){this.ctx.miterLimit=C}setDash(C,I){const R=this.ctx;R.setLineDash!==void 0&&(R.setLineDash(C),R.lineDashOffset=I)}setRenderingIntent(C){}setFlatness(C){}setGState(C){for(const[I,R]of C)switch(I){case"LW":this.setLineWidth(R);break;case"LC":this.setLineCap(R);break;case"LJ":this.setLineJoin(R);break;case"ML":this.setMiterLimit(R);break;case"D":this.setDash(R[0],R[1]);break;case"RI":this.setRenderingIntent(R);break;case"FL":this.setFlatness(R);break;case"Font":this.setFont(R[0],R[1]);break;case"CA":this.current.strokeAlpha=R;break;case"ca":this.current.fillAlpha=R,this.ctx.globalAlpha=R;break;case"BM":this.ctx.globalCompositeOperation=R;break;case"SMask":this.current.activeSMask=R?this.tempSMask:null,this.tempSMask=null,this.checkSMaskState();break;case"TR":this.ctx.filter=this.current.transferMaps=this.filterFactory.addFilter(R);break}}get inSMaskMode(){return!!this.suspendedCtx}checkSMaskState(){const C=this.inSMaskMode;this.current.activeSMask&&!C?this.beginSMaskMode():!this.current.activeSMask&&C&&this.endSMaskMode()}beginSMaskMode(){if(this.inSMaskMode)throw new Error("beginSMaskMode called while already in smask mode");const C=this.ctx.canvas.width,I=this.ctx.canvas.height,R="smaskGroupAt"+this.groupLevel,L=this.cachedCanvases.getCanvas(R,C,I);this.suspendedCtx=this.ctx,this.ctx=L.context;const G=this.ctx;G.setTransform(...(0,r.getCurrentTransform)(this.suspendedCtx)),y(this.suspendedCtx,G),p(G,this.suspendedCtx),this.setGState([["BM","source-over"],["ca",1],["CA",1]])}endSMaskMode(){if(!this.inSMaskMode)throw new Error("endSMaskMode called while not in smask mode");this.ctx._removeMirroring(),y(this.ctx,this.suspendedCtx),this.ctx=this.suspendedCtx,this.suspendedCtx=null}compose(C){if(!this.current.activeSMask)return;C?(C[0]=Math.floor(C[0]),C[1]=Math.floor(C[1]),C[2]=Math.ceil(C[2]),C[3]=Math.ceil(C[3])):C=[0,0,this.ctx.canvas.width,this.ctx.canvas.height];const I=this.current.activeSMask,R=this.suspendedCtx;z(R,I,this.ctx,C),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()}save(){this.inSMaskMode?(y(this.ctx,this.suspendedCtx),this.suspendedCtx.save()):this.ctx.save();const C=this.current;this.stateStack.push(C),this.current=C.clone()}restore(){this.stateStack.length===0&&this.inSMaskMode&&this.endSMaskMode(),this.stateStack.length!==0&&(this.current=this.stateStack.pop(),this.inSMaskMode?(this.suspendedCtx.restore(),y(this.suspendedCtx,this.ctx)):this.ctx.restore(),this.checkSMaskState(),this.pendingClip=null,this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null)}transform(C,I,R,L,G,j){this.ctx.transform(C,I,R,L,G,j),this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}constructPath(C,I,R){const L=this.ctx,G=this.current;let j=G.x,M=G.y,E,w;const O=(0,r.getCurrentTransform)(L),k=O[0]===0&&O[3]===0||O[1]===0&&O[2]===0,U=k?R.slice(0):null;for(let q=0,V=0,K=C.length;q<K;q++)switch(C[q]|0){case n.OPS.rectangle:j=I[V++],M=I[V++];const ue=I[V++],Q=I[V++],J=j+ue,ee=M+Q;L.moveTo(j,M),ue===0||Q===0?L.lineTo(J,ee):(L.lineTo(J,M),L.lineTo(J,ee),L.lineTo(j,ee)),k||G.updateRectMinMax(O,[j,M,J,ee]),L.closePath();break;case n.OPS.moveTo:j=I[V++],M=I[V++],L.moveTo(j,M),k||G.updatePathMinMax(O,j,M);break;case n.OPS.lineTo:j=I[V++],M=I[V++],L.lineTo(j,M),k||G.updatePathMinMax(O,j,M);break;case n.OPS.curveTo:E=j,w=M,j=I[V+4],M=I[V+5],L.bezierCurveTo(I[V],I[V+1],I[V+2],I[V+3],j,M),G.updateCurvePathMinMax(O,E,w,I[V],I[V+1],I[V+2],I[V+3],j,M,U),V+=6;break;case n.OPS.curveTo2:E=j,w=M,L.bezierCurveTo(j,M,I[V],I[V+1],I[V+2],I[V+3]),G.updateCurvePathMinMax(O,E,w,j,M,I[V],I[V+1],I[V+2],I[V+3],U),j=I[V+2],M=I[V+3],V+=4;break;case n.OPS.curveTo3:E=j,w=M,j=I[V+2],M=I[V+3],L.bezierCurveTo(I[V],I[V+1],j,M,j,M),G.updateCurvePathMinMax(O,E,w,I[V],I[V+1],j,M,j,M,U),V+=4;break;case n.OPS.closePath:L.closePath();break}k&&G.updateScalingPathMinMax(O,U),G.setCurrentPoint(j,M)}closePath(){this.ctx.closePath()}stroke(C=!0){const I=this.ctx,R=this.current.strokeColor;I.globalAlpha=this.current.strokeAlpha,this.contentVisible&&(typeof R=="object"&&R?.getPattern?(I.save(),I.strokeStyle=R.getPattern(I,this,(0,r.getCurrentTransformInverse)(I),a.PathType.STROKE),this.rescaleAndStroke(!1),I.restore()):this.rescaleAndStroke(!0)),C&&this.consumePath(this.current.getClippedPathBoundingBox()),I.globalAlpha=this.current.fillAlpha}closeStroke(){this.closePath(),this.stroke()}fill(C=!0){const I=this.ctx,R=this.current.fillColor,L=this.current.patternFill;let G=!1;L&&(I.save(),I.fillStyle=R.getPattern(I,this,(0,r.getCurrentTransformInverse)(I),a.PathType.FILL),G=!0);const j=this.current.getClippedPathBoundingBox();this.contentVisible&&j!==null&&(this.pendingEOFill?(I.fill("evenodd"),this.pendingEOFill=!1):I.fill()),G&&I.restore(),C&&this.consumePath(j)}eoFill(){this.pendingEOFill=!0,this.fill()}fillStroke(){this.fill(!1),this.stroke(!1),this.consumePath()}eoFillStroke(){this.pendingEOFill=!0,this.fillStroke()}closeFillStroke(){this.closePath(),this.fillStroke()}closeEOFillStroke(){this.pendingEOFill=!0,this.closePath(),this.fillStroke()}endPath(){this.consumePath()}clip(){this.pendingClip=ie}eoClip(){this.pendingClip=te}beginText(){this.current.textMatrix=n.IDENTITY_MATRIX,this.current.textMatrixScale=1,this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0}endText(){const C=this.pendingTextPaths,I=this.ctx;if(C===void 0){I.beginPath();return}I.save(),I.beginPath();for(const R of C)I.setTransform(...R.transform),I.translate(R.x,R.y),R.addToPath(I,R.fontSize);I.restore(),I.clip(),I.beginPath(),delete this.pendingTextPaths}setCharSpacing(C){this.current.charSpacing=C}setWordSpacing(C){this.current.wordSpacing=C}setHScale(C){this.current.textHScale=C/100}setLeading(C){this.current.leading=-C}setFont(C,I){const R=this.commonObjs.get(C),L=this.current;if(!R)throw new Error(`Can't find font for ${C}`);if(L.fontMatrix=R.fontMatrix||n.FONT_IDENTITY_MATRIX,(L.fontMatrix[0]===0||L.fontMatrix[3]===0)&&(0,n.warn)("Invalid font matrix for font "+C),I<0?(I=-I,L.fontDirection=-1):L.fontDirection=1,this.current.font=R,this.current.fontSize=I,R.isType3Font)return;const G=R.loadedName||"sans-serif",j=R.systemFontInfo?.css||`"${G}", ${R.fallbackName}`;let M="normal";R.black?M="900":R.bold&&(M="bold");const E=R.italic?"italic":"normal";let w=I;I<u?w=u:I>f&&(w=f),this.current.fontSizeScale=I/w,this.ctx.font=`${E} ${M} ${w}px ${j}`}setTextRenderingMode(C){this.current.textRenderingMode=C}setTextRise(C){this.current.textRise=C}moveText(C,I){this.current.x=this.current.lineX+=C,this.current.y=this.current.lineY+=I}setLeadingMoveText(C,I){this.setLeading(-I),this.moveText(C,I)}setTextMatrix(C,I,R,L,G,j){this.current.textMatrix=[C,I,R,L,G,j],this.current.textMatrixScale=Math.hypot(C,I),this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0}nextLine(){this.moveText(0,this.current.leading)}paintChar(C,I,R,L){const G=this.ctx,j=this.current,M=j.font,E=j.textRenderingMode,w=j.fontSize/j.fontSizeScale,O=E&n.TextRenderingMode.FILL_STROKE_MASK,k=!!(E&n.TextRenderingMode.ADD_TO_PATH_FLAG),U=j.patternFill&&!M.missingFile;let q;(M.disableFontFace||k||U)&&(q=M.getPathGenerator(this.commonObjs,C)),M.disableFontFace||U?(G.save(),G.translate(I,R),G.beginPath(),q(G,w),L&&G.setTransform(...L),(O===n.TextRenderingMode.FILL||O===n.TextRenderingMode.FILL_STROKE)&&G.fill(),(O===n.TextRenderingMode.STROKE||O===n.TextRenderingMode.FILL_STROKE)&&G.stroke(),G.restore()):((O===n.TextRenderingMode.FILL||O===n.TextRenderingMode.FILL_STROKE)&&G.fillText(C,I,R),(O===n.TextRenderingMode.STROKE||O===n.TextRenderingMode.FILL_STROKE)&&G.strokeText(C,I,R)),k&&(this.pendingTextPaths||=[]).push({transform:(0,r.getCurrentTransform)(G),x:I,y:R,fontSize:w,addToPath:q})}get isFontSubpixelAAEnabled(){const{context:C}=this.cachedCanvases.getCanvas("isFontSubpixelAAEnabled",10,10);C.scale(1.5,1),C.fillText("I",0,10);const I=C.getImageData(0,0,10,10).data;let R=!1;for(let L=3;L<I.length;L+=4)if(I[L]>0&&I[L]<255){R=!0;break}return(0,n.shadow)(this,"isFontSubpixelAAEnabled",R)}showText(C){const I=this.current,R=I.font;if(R.isType3Font)return this.showType3Text(C);const L=I.fontSize;if(L===0)return;const G=this.ctx,j=I.fontSizeScale,M=I.charSpacing,E=I.wordSpacing,w=I.fontDirection,O=I.textHScale*w,k=C.length,U=R.vertical,q=U?1:-1,V=R.defaultVMetrics,K=L*I.fontMatrix[0],ue=I.textRenderingMode===n.TextRenderingMode.FILL&&!R.disableFontFace&&!I.patternFill;G.save(),G.transform(...I.textMatrix),G.translate(I.x,I.y+I.textRise),w>0?G.scale(O,-1):G.scale(O,1);let Q;if(I.patternFill){G.save();const ce=I.fillColor.getPattern(G,this,(0,r.getCurrentTransformInverse)(G),a.PathType.FILL);Q=(0,r.getCurrentTransform)(G),G.restore(),G.fillStyle=ce}let J=I.lineWidth;const ee=I.textMatrixScale;if(ee===0||J===0){const ce=I.textRenderingMode&n.TextRenderingMode.FILL_STROKE_MASK;(ce===n.TextRenderingMode.STROKE||ce===n.TextRenderingMode.FILL_STROKE)&&(J=this.getSinglePixelWidth())}else J/=ee;if(j!==1&&(G.scale(j,j),J/=j),G.lineWidth=J,R.isInvalidPDFjsFont){const ce=[];let de=0;for(const he of C)ce.push(he.unicode),de+=he.width;G.fillText(ce.join(""),0,0),I.x+=de*K*O,G.restore(),this.compose();return}let se=0,ae;for(ae=0;ae<k;++ae){const ce=C[ae];if(typeof ce=="number"){se+=q*ce*L/1e3;continue}let de=!1;const he=(ce.isSpace?E:0)+M,fe=ce.fontChar,pe=ce.accent;let ge,Se,Ae=ce.width;if(U){const Ee=ce.vmetric||V,Ie=-(ce.vmetric?Ee[1]:Ae*.5)*K,Fe=Ee[2]*K;Ae=Ee?-Ee[0]:Ae,ge=Ie/j,Se=(se+Fe)/j}else ge=se/j,Se=0;if(R.remeasure&&Ae>0){const Ee=G.measureText(fe).width*1e3/L*j;if(Ae<Ee&&this.isFontSubpixelAAEnabled){const Ie=Ae/Ee;de=!0,G.save(),G.scale(Ie,1),ge/=Ie}else Ae!==Ee&&(ge+=(Ae-Ee)/2e3*L/j)}if(this.contentVisible&&(ce.isInFont||R.missingFile)){if(ue&&!pe)G.fillText(fe,ge,Se);else if(this.paintChar(fe,ge,Se,Q),pe){const Ee=ge+L*pe.offset.x/j,Ie=Se-L*pe.offset.y/j;this.paintChar(pe.fontChar,Ee,Ie,Q)}}const Pe=U?Ae*K-he*w:Ae*K+he*w;se+=Pe,de&&G.restore()}U?I.y-=se:I.x+=se*O,G.restore(),this.compose()}showType3Text(C){const I=this.ctx,R=this.current,L=R.font,G=R.fontSize,j=R.fontDirection,M=L.vertical?1:-1,E=R.charSpacing,w=R.wordSpacing,O=R.textHScale*j,k=R.fontMatrix||n.FONT_IDENTITY_MATRIX,U=C.length,q=R.textRenderingMode===n.TextRenderingMode.INVISIBLE;let V,K,ue,Q;if(!(q||G===0)){for(this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null,I.save(),I.transform(...R.textMatrix),I.translate(R.x,R.y),I.scale(O,j),V=0;V<U;++V){if(K=C[V],typeof K=="number"){Q=M*K*G/1e3,this.ctx.translate(Q,0),R.x+=Q*O;continue}const J=(K.isSpace?w:0)+E,ee=L.charProcOperatorList[K.operatorListId];if(!ee){(0,n.warn)(`Type3 character "${K.operatorListId}" is not available.`);continue}this.contentVisible&&(this.processingType3=K,this.save(),I.scale(G,G),I.transform(...k),this.executeOperatorList(ee),this.restore()),ue=n.Util.applyTransform([K.width,0],k)[0]*G+J,I.translate(ue,0),R.x+=ue*O}I.restore(),this.processingType3=null}}setCharWidth(C,I){}setCharWidthAndBounds(C,I,R,L,G,j){this.ctx.rect(R,L,G-R,j-L),this.ctx.clip(),this.endPath()}getColorN_Pattern(C){let I;if(C[0]==="TilingPattern"){const R=C[1],L=this.baseTransform||(0,r.getCurrentTransform)(this.ctx),G={createCanvasGraphics:j=>new H(j,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:this.optionalContentConfig,markedContentStack:this.markedContentStack})};I=new a.TilingPattern(C,R,this.ctx,G,L)}else I=this._getPattern(C[1],C[2]);return I}setStrokeColorN(){this.current.strokeColor=this.getColorN_Pattern(arguments)}setFillColorN(){this.current.fillColor=this.getColorN_Pattern(arguments),this.current.patternFill=!0}setStrokeRGBColor(C,I,R){const L=n.Util.makeHexColor(C,I,R);this.ctx.strokeStyle=L,this.current.strokeColor=L}setFillRGBColor(C,I,R){const L=n.Util.makeHexColor(C,I,R);this.ctx.fillStyle=L,this.current.fillColor=L,this.current.patternFill=!1}_getPattern(C,I=null){let R;return this.cachedPatterns.has(C)?R=this.cachedPatterns.get(C):(R=(0,a.getShadingPattern)(this.getObject(C)),this.cachedPatterns.set(C,R)),I&&(R.matrix=I),R}shadingFill(C){if(!this.contentVisible)return;const I=this.ctx;this.save();const R=this._getPattern(C);I.fillStyle=R.getPattern(I,this,(0,r.getCurrentTransformInverse)(I),a.PathType.SHADING);const L=(0,r.getCurrentTransformInverse)(I);if(L){const{width:G,height:j}=I.canvas,[M,E,w,O]=n.Util.getAxialAlignedBoundingBox([0,0,G,j],L);this.ctx.fillRect(M,E,w-M,O-E)}else this.ctx.fillRect(-1e10,-1e10,2e10,2e10);this.compose(this.current.getClippedPathBoundingBox()),this.restore()}beginInlineImage(){(0,n.unreachable)("Should not call beginInlineImage")}beginImageData(){(0,n.unreachable)("Should not call beginImageData")}paintFormXObjectBegin(C,I){if(this.contentVisible&&(this.save(),this.baseTransformStack.push(this.baseTransform),Array.isArray(C)&&C.length===6&&this.transform(...C),this.baseTransform=(0,r.getCurrentTransform)(this.ctx),I)){const R=I[2]-I[0],L=I[3]-I[1];this.ctx.rect(I[0],I[1],R,L),this.current.updateRectMinMax((0,r.getCurrentTransform)(this.ctx),I),this.clip(),this.endPath()}}paintFormXObjectEnd(){this.contentVisible&&(this.restore(),this.baseTransform=this.baseTransformStack.pop())}beginGroup(C){if(!this.contentVisible)return;this.save(),this.inSMaskMode&&(this.endSMaskMode(),this.current.activeSMask=null);const I=this.ctx;C.isolated||(0,n.info)("TODO: Support non-isolated groups."),C.knockout&&(0,n.warn)("Knockout groups not supported.");const R=(0,r.getCurrentTransform)(I);if(C.matrix&&I.transform(...C.matrix),!C.bbox)throw new Error("Bounding box is required.");let L=n.Util.getAxialAlignedBoundingBox(C.bbox,(0,r.getCurrentTransform)(I));const G=[0,0,I.canvas.width,I.canvas.height];L=n.Util.intersect(L,G)||[0,0,0,0];const j=Math.floor(L[0]),M=Math.floor(L[1]);let E=Math.max(Math.ceil(L[2])-j,1),w=Math.max(Math.ceil(L[3])-M,1),O=1,k=1;E>c&&(O=E/c,E=c),w>c&&(k=w/c,w=c),this.current.startNewPathAndClipBox([0,0,E,w]);let U="groupAt"+this.groupLevel;C.smask&&(U+="_smask_"+this.smaskCounter++%2);const q=this.cachedCanvases.getCanvas(U,E,w),V=q.context;V.scale(1/O,1/k),V.translate(-j,-M),V.transform(...R),C.smask?this.smaskStack.push({canvas:q.canvas,context:V,offsetX:j,offsetY:M,scaleX:O,scaleY:k,subtype:C.smask.subtype,backdrop:C.smask.backdrop,transferMap:C.smask.transferMap||null,startTransformInverse:null}):(I.setTransform(1,0,0,1,0,0),I.translate(j,M),I.scale(O,k),I.save()),y(I,V),this.ctx=V,this.setGState([["BM","source-over"],["ca",1],["CA",1]]),this.groupStack.push(I),this.groupLevel++}endGroup(C){if(!this.contentVisible)return;this.groupLevel--;const I=this.ctx,R=this.groupStack.pop();if(this.ctx=R,this.ctx.imageSmoothingEnabled=!1,C.smask)this.tempSMask=this.smaskStack.pop(),this.restore();else{this.ctx.restore();const L=(0,r.getCurrentTransform)(this.ctx);this.restore(),this.ctx.save(),this.ctx.setTransform(...L);const G=n.Util.getAxialAlignedBoundingBox([0,0,I.canvas.width,I.canvas.height],L);this.ctx.drawImage(I.canvas,0,0),this.ctx.restore(),this.compose(G)}}beginAnnotation(C,I,R,L,G){if(this.#e(),S(this.ctx),this.ctx.save(),this.save(),this.baseTransform&&this.ctx.setTransform(...this.baseTransform),Array.isArray(I)&&I.length===4){const j=I[2]-I[0],M=I[3]-I[1];if(G&&this.annotationCanvasMap){R=R.slice(),R[4]-=I[0],R[5]-=I[1],I=I.slice(),I[0]=I[1]=0,I[2]=j,I[3]=M;const[E,w]=n.Util.singularValueDecompose2dScale((0,r.getCurrentTransform)(this.ctx)),{viewportScale:O}=this,k=Math.ceil(j*this.outputScaleX*O),U=Math.ceil(M*this.outputScaleY*O);this.annotationCanvas=this.canvasFactory.create(k,U);const{canvas:q,context:V}=this.annotationCanvas;this.annotationCanvasMap.set(C,q),this.annotationCanvas.savedCtx=this.ctx,this.ctx=V,this.ctx.save(),this.ctx.setTransform(E,0,0,-w,0,M*w),S(this.ctx)}else S(this.ctx),this.ctx.rect(I[0],I[1],j,M),this.ctx.clip(),this.endPath()}this.current=new v(this.ctx.canvas.width,this.ctx.canvas.height),this.transform(...R),this.transform(...L)}endAnnotation(){this.annotationCanvas&&(this.ctx.restore(),this.#t(),this.ctx=this.annotationCanvas.savedCtx,delete this.annotationCanvas.savedCtx,delete this.annotationCanvas)}paintImageMaskXObject(C){if(!this.contentVisible)return;const I=C.count;C=this.getObject(C.data,C),C.count=I;const R=this.ctx,L=this.processingType3;if(L&&(L.compiled===void 0&&(L.compiled=T(C)),L.compiled)){L.compiled(R);return}const G=this._createMaskCanvas(C),j=G.canvas;R.save(),R.setTransform(1,0,0,1,0,0),R.drawImage(j,G.offsetX,G.offsetY),R.restore(),this.compose()}paintImageMaskXObjectRepeat(C,I,R=0,L=0,G,j){if(!this.contentVisible)return;C=this.getObject(C.data,C);const M=this.ctx;M.save();const E=(0,r.getCurrentTransform)(M);M.transform(I,R,L,G,0,0);const w=this._createMaskCanvas(C);M.setTransform(1,0,0,1,w.offsetX-E[4],w.offsetY-E[5]);for(let O=0,k=j.length;O<k;O+=2){const U=n.Util.transform(E,[I,R,L,G,j[O],j[O+1]]),[q,V]=n.Util.applyTransform([0,0],U);M.drawImage(w.canvas,q,V)}M.restore(),this.compose()}paintImageMaskXObjectGroup(C){if(!this.contentVisible)return;const I=this.ctx,R=this.current.fillColor,L=this.current.patternFill;for(const G of C){const{data:j,width:M,height:E,transform:w}=G,O=this.cachedCanvases.getCanvas("maskCanvas",M,E),k=O.context;k.save();const U=this.getObject(j,G);x(k,U),k.globalCompositeOperation="source-in",k.fillStyle=L?R.getPattern(k,this,(0,r.getCurrentTransformInverse)(I),a.PathType.FILL):R,k.fillRect(0,0,M,E),k.restore(),I.save(),I.transform(...w),I.scale(1,-1),A(I,O.canvas,0,0,M,E,0,-1,1,1),I.restore()}this.compose()}paintImageXObject(C){if(!this.contentVisible)return;const I=this.getObject(C);if(!I){(0,n.warn)("Dependent image isn't ready yet");return}this.paintInlineImageXObject(I)}paintImageXObjectRepeat(C,I,R,L){if(!this.contentVisible)return;const G=this.getObject(C);if(!G){(0,n.warn)("Dependent image isn't ready yet");return}const j=G.width,M=G.height,E=[];for(let w=0,O=L.length;w<O;w+=2)E.push({transform:[I,0,0,R,L[w],L[w+1]],x:0,y:0,w:j,h:M});this.paintInlineImageXObjectGroup(G,E)}applyTransferMapsToCanvas(C){return this.current.transferMaps!=="none"&&(C.filter=this.current.transferMaps,C.drawImage(C.canvas,0,0),C.filter="none"),C.canvas}applyTransferMapsToBitmap(C){if(this.current.transferMaps==="none")return C.bitmap;const{bitmap:I,width:R,height:L}=C,G=this.cachedCanvases.getCanvas("inlineImage",R,L),j=G.context;return j.filter=this.current.transferMaps,j.drawImage(I,0,0),j.filter="none",G.canvas}paintInlineImageXObject(C){if(!this.contentVisible)return;const I=C.width,R=C.height,L=this.ctx;if(this.save(),!n.isNodeJS){const{filter:M}=L;M!=="none"&&M!==""&&(L.filter="none")}L.scale(1/I,-1/R);let G;if(C.bitmap)G=this.applyTransferMapsToBitmap(C);else if(typeof HTMLElement=="function"&&C instanceof HTMLElement||!C.data)G=C;else{const E=this.cachedCanvases.getCanvas("inlineImage",I,R).context;N(E,C),G=this.applyTransferMapsToCanvas(E)}const j=this._scaleImage(G,(0,r.getCurrentTransformInverse)(L));L.imageSmoothingEnabled=re((0,r.getCurrentTransform)(L),C.interpolate),A(L,j.img,0,0,j.paintWidth,j.paintHeight,0,-R,I,R),this.compose(),this.restore()}paintInlineImageXObjectGroup(C,I){if(!this.contentVisible)return;const R=this.ctx;let L;if(C.bitmap)L=C.bitmap;else{const G=C.width,j=C.height,E=this.cachedCanvases.getCanvas("inlineImage",G,j).context;N(E,C),L=this.applyTransferMapsToCanvas(E)}for(const G of I)R.save(),R.transform(...G.transform),R.scale(1,-1),A(R,L,G.x,G.y,G.w,G.h,0,-1,1,1),R.restore();this.compose()}paintSolidColorImageMask(){this.contentVisible&&(this.ctx.fillRect(0,0,1,1),this.compose())}markPoint(C){}markPointProps(C,I){}beginMarkedContent(C){this.markedContentStack.push({visible:!0})}beginMarkedContentProps(C,I){C==="OC"?this.markedContentStack.push({visible:this.optionalContentConfig.isVisible(I)}):this.markedContentStack.push({visible:!0}),this.contentVisible=this.isContentVisible()}endMarkedContent(){this.markedContentStack.pop(),this.contentVisible=this.isContentVisible()}beginCompat(){}endCompat(){}consumePath(C){const I=this.current.isEmptyClip();this.pendingClip&&this.current.updateClipFromPath(),this.pendingClip||this.compose(C);const R=this.ctx;this.pendingClip&&(I||(this.pendingClip===te?R.clip("evenodd"):R.clip()),this.pendingClip=null),this.current.startNewPathAndClipBox(this.current.clipBox),R.beginPath()}getSinglePixelWidth(){if(!this._cachedGetSinglePixelWidth){const C=(0,r.getCurrentTransform)(this.ctx);if(C[1]===0&&C[2]===0)this._cachedGetSinglePixelWidth=1/Math.min(Math.abs(C[0]),Math.abs(C[3]));else{const I=Math.abs(C[0]*C[3]-C[2]*C[1]),R=Math.hypot(C[0],C[2]),L=Math.hypot(C[1],C[3]);this._cachedGetSinglePixelWidth=Math.max(R,L)/I}}return this._cachedGetSinglePixelWidth}getScaleForStroking(){if(this._cachedScaleForStroking[0]===-1){const{lineWidth:C}=this.current,{a:I,b:R,c:L,d:G}=this.ctx.getTransform();let j,M;if(R===0&&L===0){const E=Math.abs(I),w=Math.abs(G);if(E===w)if(C===0)j=M=1/E;else{const O=E*C;j=M=O<1?1/O:1}else if(C===0)j=1/E,M=1/w;else{const O=E*C,k=w*C;j=O<1?1/O:1,M=k<1?1/k:1}}else{const E=Math.abs(I*G-R*L),w=Math.hypot(I,R),O=Math.hypot(L,G);if(C===0)j=O/E,M=w/E;else{const k=C*E;j=O>k?O/k:1,M=w>k?w/k:1}}this._cachedScaleForStroking[0]=j,this._cachedScaleForStroking[1]=M}return this._cachedScaleForStroking}rescaleAndStroke(C){const{ctx:I}=this,{lineWidth:R}=this.current,[L,G]=this.getScaleForStroking();if(I.lineWidth=R||1,L===1&&G===1){I.stroke();return}const j=I.getLineDash();if(C&&I.save(),I.scale(L,G),j.length>0){const M=Math.max(L,G);I.setLineDash(j.map(E=>E/M)),I.lineDashOffset/=M}I.stroke(),C&&I.restore()}isContentVisible(){for(let C=this.markedContentStack.length-1;C>=0;C--)if(!this.markedContentStack[C].visible)return!1;return!0}}e.CanvasGraphics=H;for(const P in n.OPS)H.prototype[P]!==void 0&&(H.prototype[n.OPS[P]]=H.prototype[P])},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.TilingPattern=e.PathType=void 0,e.getShadingPattern=_;var n=s(1),r=s(6);const a={FILL:"Fill",STROKE:"Stroke",SHADING:"Shading"};e.PathType=a;function i(A,T){if(!T)return;const v=T[2]-T[0],N=T[3]-T[1],x=new Path2D;x.rect(T[0],T[1],v,N),A.clip(x)}class u{constructor(){this.constructor===u&&(0,n.unreachable)("Cannot initialize BaseShadingPattern.")}getPattern(){(0,n.unreachable)("Abstract method `getPattern` called.")}}class f extends u{constructor(T){super(),this._type=T[1],this._bbox=T[2],this._colorStops=T[3],this._p0=T[4],this._p1=T[5],this._r0=T[6],this._r1=T[7],this.matrix=null}_createGradient(T){let v;this._type==="axial"?v=T.createLinearGradient(this._p0[0],this._p0[1],this._p1[0],this._p1[1]):this._type==="radial"&&(v=T.createRadialGradient(this._p0[0],this._p0[1],this._r0,this._p1[0],this._p1[1],this._r1));for(const N of this._colorStops)v.addColorStop(N[0],N[1]);return v}getPattern(T,v,N,x){let y;if(x===a.STROKE||x===a.FILL){const S=v.current.getClippedPathBoundingBox(x,(0,r.getCurrentTransform)(T))||[0,0,0,0],D=Math.ceil(S[2]-S[0])||1,F=Math.ceil(S[3]-S[1])||1,B=v.cachedCanvases.getCanvas("pattern",D,F,!0),W=B.context;W.clearRect(0,0,W.canvas.width,W.canvas.height),W.beginPath(),W.rect(0,0,W.canvas.width,W.canvas.height),W.translate(-S[0],-S[1]),N=n.Util.transform(N,[1,0,0,1,S[0],S[1]]),W.transform(...v.baseTransform),this.matrix&&W.transform(...this.matrix),i(W,this._bbox),W.fillStyle=this._createGradient(W),W.fill(),y=T.createPattern(B.canvas,"no-repeat");const z=new DOMMatrix(N);y.setTransform(z)}else i(T,this._bbox),y=this._createGradient(T);return y}}function c(A,T,v,N,x,y,S,D){const F=T.coords,B=T.colors,W=A.data,z=A.width*4;let re;F[v+1]>F[N+1]&&(re=v,v=N,N=re,re=y,y=S,S=re),F[N+1]>F[x+1]&&(re=N,N=x,x=re,re=S,S=D,D=re),F[v+1]>F[N+1]&&(re=v,v=N,N=re,re=y,y=S,S=re);const X=(F[v]+T.offsetX)*T.scaleX,ne=(F[v+1]+T.offsetY)*T.scaleY,ie=(F[N]+T.offsetX)*T.scaleX,te=(F[N+1]+T.offsetY)*T.scaleY,H=(F[x]+T.offsetX)*T.scaleX,P=(F[x+1]+T.offsetY)*T.scaleY;if(ne>=P)return;const C=B[y],I=B[y+1],R=B[y+2],L=B[S],G=B[S+1],j=B[S+2],M=B[D],E=B[D+1],w=B[D+2],O=Math.round(ne),k=Math.round(P);let U,q,V,K,ue,Q,J,ee;for(let se=O;se<=k;se++){if(se<te){const fe=se<ne?0:(ne-se)/(ne-te);U=X-(X-ie)*fe,q=C-(C-L)*fe,V=I-(I-G)*fe,K=R-(R-j)*fe}else{let fe;se>P?fe=1:te===P?fe=0:fe=(te-se)/(te-P),U=ie-(ie-H)*fe,q=L-(L-M)*fe,V=G-(G-E)*fe,K=j-(j-w)*fe}let ae;se<ne?ae=0:se>P?ae=1:ae=(ne-se)/(ne-P),ue=X-(X-H)*ae,Q=C-(C-M)*ae,J=I-(I-E)*ae,ee=R-(R-w)*ae;const ce=Math.round(Math.min(U,ue)),de=Math.round(Math.max(U,ue));let he=z*se+ce*4;for(let fe=ce;fe<=de;fe++)ae=(U-fe)/(U-ue),ae<0?ae=0:ae>1&&(ae=1),W[he++]=q-(q-Q)*ae|0,W[he++]=V-(V-J)*ae|0,W[he++]=K-(K-ee)*ae|0,W[he++]=255}}function d(A,T,v){const N=T.coords,x=T.colors;let y,S;switch(T.type){case"lattice":const D=T.verticesPerRow,F=Math.floor(N.length/D)-1,B=D-1;for(y=0;y<F;y++){let W=y*D;for(let z=0;z<B;z++,W++)c(A,v,N[W],N[W+1],N[W+D],x[W],x[W+1],x[W+D]),c(A,v,N[W+D+1],N[W+1],N[W+D],x[W+D+1],x[W+1],x[W+D])}break;case"triangles":for(y=0,S=N.length;y<S;y+=3)c(A,v,N[y],N[y+1],N[y+2],x[y],x[y+1],x[y+2]);break;default:throw new Error("illegal figure")}}class h extends u{constructor(T){super(),this._coords=T[2],this._colors=T[3],this._figures=T[4],this._bounds=T[5],this._bbox=T[7],this._background=T[8],this.matrix=null}_createMeshCanvas(T,v,N){const D=Math.floor(this._bounds[0]),F=Math.floor(this._bounds[1]),B=Math.ceil(this._bounds[2])-D,W=Math.ceil(this._bounds[3])-F,z=Math.min(Math.ceil(Math.abs(B*T[0]*1.1)),3e3),re=Math.min(Math.ceil(Math.abs(W*T[1]*1.1)),3e3),X=B/z,ne=W/re,ie={coords:this._coords,colors:this._colors,offsetX:-D,offsetY:-F,scaleX:1/X,scaleY:1/ne},te=z+2*2,H=re+2*2,P=N.getCanvas("mesh",te,H,!1),C=P.context,I=C.createImageData(z,re);if(v){const L=I.data;for(let G=0,j=L.length;G<j;G+=4)L[G]=v[0],L[G+1]=v[1],L[G+2]=v[2],L[G+3]=255}for(const L of this._figures)d(I,L,ie);return C.putImageData(I,2,2),{canvas:P.canvas,offsetX:D-2*X,offsetY:F-2*ne,scaleX:X,scaleY:ne}}getPattern(T,v,N,x){i(T,this._bbox);let y;if(x===a.SHADING)y=n.Util.singularValueDecompose2dScale((0,r.getCurrentTransform)(T));else if(y=n.Util.singularValueDecompose2dScale(v.baseTransform),this.matrix){const D=n.Util.singularValueDecompose2dScale(this.matrix);y=[y[0]*D[0],y[1]*D[1]]}const S=this._createMeshCanvas(y,x===a.SHADING?null:this._background,v.cachedCanvases);return x!==a.SHADING&&(T.setTransform(...v.baseTransform),this.matrix&&T.transform(...this.matrix)),T.translate(S.offsetX,S.offsetY),T.scale(S.scaleX,S.scaleY),T.createPattern(S.canvas,"no-repeat")}}class m extends u{getPattern(){return"hotpink"}}function _(A){switch(A[0]){case"RadialAxial":return new f(A);case"Mesh":return new h(A);case"Dummy":return new m}throw new Error(`Unknown IR type: ${A[0]}`)}const p={COLORED:1,UNCOLORED:2};class b{static MAX_PATTERN_SIZE=3e3;constructor(T,v,N,x,y){this.operatorList=T[2],this.matrix=T[3]||[1,0,0,1,0,0],this.bbox=T[4],this.xstep=T[5],this.ystep=T[6],this.paintType=T[7],this.tilingType=T[8],this.color=v,this.ctx=N,this.canvasGraphicsFactory=x,this.baseTransform=y}createPatternCanvas(T){const v=this.operatorList,N=this.bbox,x=this.xstep,y=this.ystep,S=this.paintType,D=this.tilingType,F=this.color,B=this.canvasGraphicsFactory;(0,n.info)("TilingType: "+D);const W=N[0],z=N[1],re=N[2],X=N[3],ne=n.Util.singularValueDecompose2dScale(this.matrix),ie=n.Util.singularValueDecompose2dScale(this.baseTransform),te=[ne[0]*ie[0],ne[1]*ie[1]],H=this.getSizeAndScale(x,this.ctx.canvas.width,te[0]),P=this.getSizeAndScale(y,this.ctx.canvas.height,te[1]),C=T.cachedCanvases.getCanvas("pattern",H.size,P.size,!0),I=C.context,R=B.createCanvasGraphics(I);R.groupLevel=T.groupLevel,this.setFillAndStrokeStyleToContext(R,S,F);let L=W,G=z,j=re,M=X;return W<0&&(L=0,j+=Math.abs(W)),z<0&&(G=0,M+=Math.abs(z)),I.translate(-(H.scale*L),-(P.scale*G)),R.transform(H.scale,0,0,P.scale,0,0),I.save(),this.clipBbox(R,L,G,j,M),R.baseTransform=(0,r.getCurrentTransform)(R.ctx),R.executeOperatorList(v),R.endDrawing(),{canvas:C.canvas,scaleX:H.scale,scaleY:P.scale,offsetX:L,offsetY:G}}getSizeAndScale(T,v,N){T=Math.abs(T);const x=Math.max(b.MAX_PATTERN_SIZE,v);let y=Math.ceil(T*N);return y>=x?y=x:N=y/T,{scale:N,size:y}}clipBbox(T,v,N,x,y){const S=x-v,D=y-N;T.ctx.rect(v,N,S,D),T.current.updateRectMinMax((0,r.getCurrentTransform)(T.ctx),[v,N,x,y]),T.clip(),T.endPath()}setFillAndStrokeStyleToContext(T,v,N){const x=T.ctx,y=T.current;switch(v){case p.COLORED:const S=this.ctx;x.fillStyle=S.fillStyle,x.strokeStyle=S.strokeStyle,y.fillColor=S.fillStyle,y.strokeColor=S.strokeStyle;break;case p.UNCOLORED:const D=n.Util.makeHexColor(N[0],N[1],N[2]);x.fillStyle=D,x.strokeStyle=D,y.fillColor=D,y.strokeColor=D;break;default:throw new n.FormatError(`Unsupported paint type: ${v}`)}}getPattern(T,v,N,x){let y=N;x!==a.SHADING&&(y=n.Util.transform(y,v.baseTransform),this.matrix&&(y=n.Util.transform(y,this.matrix)));const S=this.createPatternCanvas(v);let D=new DOMMatrix(y);D=D.translate(S.offsetX,S.offsetY),D=D.scale(1/S.scaleX,1/S.scaleY);const F=T.createPattern(S.canvas,"repeat");return F.setTransform(D),F}}e.TilingPattern=b},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.convertBlackAndWhiteToRGBA=a,e.convertToRGBA=r,e.grayToRGBA=u;var n=s(1);function r(f){switch(f.kind){case n.ImageKind.GRAYSCALE_1BPP:return a(f);case n.ImageKind.RGB_24BPP:return i(f)}return null}function a({src:f,srcPos:c=0,dest:d,width:h,height:m,nonBlackColor:_=4294967295,inverseDecode:p=!1}){const b=n.FeatureTest.isLittleEndian?4278190080:255,[A,T]=p?[_,b]:[b,_],v=h>>3,N=h&7,x=f.length;d=new Uint32Array(d.buffer);let y=0;for(let S=0;S<m;S++){for(const F=c+v;c<F;c++){const B=c<x?f[c]:255;d[y++]=B&128?T:A,d[y++]=B&64?T:A,d[y++]=B&32?T:A,d[y++]=B&16?T:A,d[y++]=B&8?T:A,d[y++]=B&4?T:A,d[y++]=B&2?T:A,d[y++]=B&1?T:A}if(N===0)continue;const D=c<x?f[c++]:255;for(let F=0;F<N;F++)d[y++]=D&1<<7-F?T:A}return{srcPos:c,destPos:y}}function i({src:f,srcPos:c=0,dest:d,destPos:h=0,width:m,height:_}){let p=0;const b=f.length>>2,A=new Uint32Array(f.buffer,c,b);if(n.FeatureTest.isLittleEndian){for(;p<b-2;p+=3,h+=4){const T=A[p],v=A[p+1],N=A[p+2];d[h]=T|4278190080,d[h+1]=T>>>24|v<<8|4278190080,d[h+2]=v>>>16|N<<16|4278190080,d[h+3]=N>>>8|4278190080}for(let T=p*4,v=f.length;T<v;T+=3)d[h++]=f[T]|f[T+1]<<8|f[T+2]<<16|4278190080}else{for(;p<b-2;p+=3,h+=4){const T=A[p],v=A[p+1],N=A[p+2];d[h]=T|255,d[h+1]=T<<24|v>>>8|255,d[h+2]=v<<16|N>>>16|255,d[h+3]=N<<8|255}for(let T=p*4,v=f.length;T<v;T+=3)d[h++]=f[T]<<24|f[T+1]<<16|f[T+2]<<8|255}return{srcPos:c,destPos:h}}function u(f,c){if(n.FeatureTest.isLittleEndian)for(let d=0,h=f.length;d<h;d++)c[d]=f[d]*65793|4278190080;else for(let d=0,h=f.length;d<h;d++)c[d]=f[d]*16843008|255}},(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.GlobalWorkerOptions=void 0;const s=Object.create(null);e.GlobalWorkerOptions=s,s.workerPort=null,s.workerSrc=""},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.MessageHandler=void 0;var n=s(1);const r={UNKNOWN:0,DATA:1,ERROR:2},a={UNKNOWN:0,CANCEL:1,CANCEL_COMPLETE:2,CLOSE:3,ENQUEUE:4,ERROR:5,PULL:6,PULL_COMPLETE:7,START_COMPLETE:8};function i(f){switch(f instanceof Error||typeof f=="object"&&f!==null||(0,n.unreachable)('wrapReason: Expected "reason" to be a (possibly cloned) Error.'),f.name){case"AbortException":return new n.AbortException(f.message);case"MissingPDFException":return new n.MissingPDFException(f.message);case"PasswordException":return new n.PasswordException(f.message,f.code);case"UnexpectedResponseException":return new n.UnexpectedResponseException(f.message,f.status);case"UnknownErrorException":return new n.UnknownErrorException(f.message,f.details);default:return new n.UnknownErrorException(f.message,f.toString())}}class u{constructor(c,d,h){this.sourceName=c,this.targetName=d,this.comObj=h,this.callbackId=1,this.streamId=1,this.streamSinks=Object.create(null),this.streamControllers=Object.create(null),this.callbackCapabilities=Object.create(null),this.actionHandler=Object.create(null),this._onComObjOnMessage=m=>{const _=m.data;if(_.targetName!==this.sourceName)return;if(_.stream){this.#t(_);return}if(_.callback){const b=_.callbackId,A=this.callbackCapabilities[b];if(!A)throw new Error(`Cannot resolve callback ${b}`);if(delete this.callbackCapabilities[b],_.callback===r.DATA)A.resolve(_.data);else if(_.callback===r.ERROR)A.reject(i(_.reason));else throw new Error("Unexpected callback case");return}const p=this.actionHandler[_.action];if(!p)throw new Error(`Unknown action from worker: ${_.action}`);if(_.callbackId){const b=this.sourceName,A=_.sourceName;new Promise(function(T){T(p(_.data))}).then(function(T){h.postMessage({sourceName:b,targetName:A,callback:r.DATA,callbackId:_.callbackId,data:T})},function(T){h.postMessage({sourceName:b,targetName:A,callback:r.ERROR,callbackId:_.callbackId,reason:i(T)})});return}if(_.streamId){this.#e(_);return}p(_.data)},h.addEventListener("message",this._onComObjOnMessage)}on(c,d){const h=this.actionHandler;if(h[c])throw new Error(`There is already an actionName called "${c}"`);h[c]=d}send(c,d,h){this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:c,data:d},h)}sendWithPromise(c,d,h){const m=this.callbackId++,_=new n.PromiseCapability;this.callbackCapabilities[m]=_;try{this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:c,callbackId:m,data:d},h)}catch(p){_.reject(p)}return _.promise}sendWithStream(c,d,h,m){const _=this.streamId++,p=this.sourceName,b=this.targetName,A=this.comObj;return new ReadableStream({start:T=>{const v=new n.PromiseCapability;return this.streamControllers[_]={controller:T,startCall:v,pullCall:null,cancelCall:null,isClosed:!1},A.postMessage({sourceName:p,targetName:b,action:c,streamId:_,data:d,desiredSize:T.desiredSize},m),v.promise},pull:T=>{const v=new n.PromiseCapability;return this.streamControllers[_].pullCall=v,A.postMessage({sourceName:p,targetName:b,stream:a.PULL,streamId:_,desiredSize:T.desiredSize}),v.promise},cancel:T=>{(0,n.assert)(T instanceof Error,"cancel must have a valid reason");const v=new n.PromiseCapability;return this.streamControllers[_].cancelCall=v,this.streamControllers[_].isClosed=!0,A.postMessage({sourceName:p,targetName:b,stream:a.CANCEL,streamId:_,reason:i(T)}),v.promise}},h)}#e(c){const d=c.streamId,h=this.sourceName,m=c.sourceName,_=this.comObj,p=this,b=this.actionHandler[c.action],A={enqueue(T,v=1,N){if(this.isCancelled)return;const x=this.desiredSize;this.desiredSize-=v,x>0&&this.desiredSize<=0&&(this.sinkCapability=new n.PromiseCapability,this.ready=this.sinkCapability.promise),_.postMessage({sourceName:h,targetName:m,stream:a.ENQUEUE,streamId:d,chunk:T},N)},close(){this.isCancelled||(this.isCancelled=!0,_.postMessage({sourceName:h,targetName:m,stream:a.CLOSE,streamId:d}),delete p.streamSinks[d])},error(T){(0,n.assert)(T instanceof Error,"error must have a valid reason"),!this.isCancelled&&(this.isCancelled=!0,_.postMessage({sourceName:h,targetName:m,stream:a.ERROR,streamId:d,reason:i(T)}))},sinkCapability:new n.PromiseCapability,onPull:null,onCancel:null,isCancelled:!1,desiredSize:c.desiredSize,ready:null};A.sinkCapability.resolve(),A.ready=A.sinkCapability.promise,this.streamSinks[d]=A,new Promise(function(T){T(b(c.data,A))}).then(function(){_.postMessage({sourceName:h,targetName:m,stream:a.START_COMPLETE,streamId:d,success:!0})},function(T){_.postMessage({sourceName:h,targetName:m,stream:a.START_COMPLETE,streamId:d,reason:i(T)})})}#t(c){const d=c.streamId,h=this.sourceName,m=c.sourceName,_=this.comObj,p=this.streamControllers[d],b=this.streamSinks[d];switch(c.stream){case a.START_COMPLETE:c.success?p.startCall.resolve():p.startCall.reject(i(c.reason));break;case a.PULL_COMPLETE:c.success?p.pullCall.resolve():p.pullCall.reject(i(c.reason));break;case a.PULL:if(!b){_.postMessage({sourceName:h,targetName:m,stream:a.PULL_COMPLETE,streamId:d,success:!0});break}b.desiredSize<=0&&c.desiredSize>0&&b.sinkCapability.resolve(),b.desiredSize=c.desiredSize,new Promise(function(A){A(b.onPull?.())}).then(function(){_.postMessage({sourceName:h,targetName:m,stream:a.PULL_COMPLETE,streamId:d,success:!0})},function(A){_.postMessage({sourceName:h,targetName:m,stream:a.PULL_COMPLETE,streamId:d,reason:i(A)})});break;case a.ENQUEUE:if((0,n.assert)(p,"enqueue should have stream controller"),p.isClosed)break;p.controller.enqueue(c.chunk);break;case a.CLOSE:if((0,n.assert)(p,"close should have stream controller"),p.isClosed)break;p.isClosed=!0,p.controller.close(),this.#s(p,d);break;case a.ERROR:(0,n.assert)(p,"error should have stream controller"),p.controller.error(i(c.reason)),this.#s(p,d);break;case a.CANCEL_COMPLETE:c.success?p.cancelCall.resolve():p.cancelCall.reject(i(c.reason)),this.#s(p,d);break;case a.CANCEL:if(!b)break;new Promise(function(A){A(b.onCancel?.(i(c.reason)))}).then(function(){_.postMessage({sourceName:h,targetName:m,stream:a.CANCEL_COMPLETE,streamId:d,success:!0})},function(A){_.postMessage({sourceName:h,targetName:m,stream:a.CANCEL_COMPLETE,streamId:d,reason:i(A)})}),b.sinkCapability.reject(i(c.reason)),b.isCancelled=!0,delete this.streamSinks[d];break;default:throw new Error("Unexpected stream case")}}async#s(c,d){await Promise.allSettled([c.startCall?.promise,c.pullCall?.promise,c.cancelCall?.promise]),delete this.streamControllers[d]}destroy(){this.comObj.removeEventListener("message",this._onComObjOnMessage)}}e.MessageHandler=u},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Metadata=void 0;var n=s(1);class r{#e;#t;constructor({parsedData:i,rawData:u}){this.#e=i,this.#t=u}getRaw(){return this.#t}get(i){return this.#e.get(i)??null}getAll(){return(0,n.objectFromMap)(this.#e)}has(i){return this.#e.has(i)}}e.Metadata=r},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.OptionalContentConfig=void 0;var n=s(1),r=s(8);const a=Symbol("INTERNAL");class i{#e=!0;constructor(c,d){this.name=c,this.intent=d}get visible(){return this.#e}_setVisible(c,d){c!==a&&(0,n.unreachable)("Internal method `_setVisible` called."),this.#e=d}}class u{#e=null;#t=new Map;#s=null;#n=null;constructor(c){if(this.name=null,this.creator=null,c!==null){this.name=c.name,this.creator=c.creator,this.#n=c.order;for(const d of c.groups)this.#t.set(d.id,new i(d.name,d.intent));if(c.baseState==="OFF")for(const d of this.#t.values())d._setVisible(a,!1);for(const d of c.on)this.#t.get(d)._setVisible(a,!0);for(const d of c.off)this.#t.get(d)._setVisible(a,!1);this.#s=this.getHash()}}#i(c){const d=c.length;if(d<2)return!0;const h=c[0];for(let m=1;m<d;m++){const _=c[m];let p;if(Array.isArray(_))p=this.#i(_);else if(this.#t.has(_))p=this.#t.get(_).visible;else return(0,n.warn)(`Optional content group not found: ${_}`),!0;switch(h){case"And":if(!p)return!1;break;case"Or":if(p)return!0;break;case"Not":return!p;default:return!0}}return h==="And"}isVisible(c){if(this.#t.size===0)return!0;if(!c)return(0,n.warn)("Optional content group not defined."),!0;if(c.type==="OCG")return this.#t.has(c.id)?this.#t.get(c.id).visible:((0,n.warn)(`Optional content group not found: ${c.id}`),!0);if(c.type==="OCMD"){if(c.expression)return this.#i(c.expression);if(!c.policy||c.policy==="AnyOn"){for(const d of c.ids){if(!this.#t.has(d))return(0,n.warn)(`Optional content group not found: ${d}`),!0;if(this.#t.get(d).visible)return!0}return!1}else if(c.policy==="AllOn"){for(const d of c.ids){if(!this.#t.has(d))return(0,n.warn)(`Optional content group not found: ${d}`),!0;if(!this.#t.get(d).visible)return!1}return!0}else if(c.policy==="AnyOff"){for(const d of c.ids){if(!this.#t.has(d))return(0,n.warn)(`Optional content group not found: ${d}`),!0;if(!this.#t.get(d).visible)return!0}return!1}else if(c.policy==="AllOff"){for(const d of c.ids){if(!this.#t.has(d))return(0,n.warn)(`Optional content group not found: ${d}`),!0;if(this.#t.get(d).visible)return!1}return!0}return(0,n.warn)(`Unknown optional content policy ${c.policy}.`),!0}return(0,n.warn)(`Unknown group type ${c.type}.`),!0}setVisibility(c,d=!0){if(!this.#t.has(c)){(0,n.warn)(`Optional content group not found: ${c}`);return}this.#t.get(c)._setVisible(a,!!d),this.#e=null}get hasInitialVisibility(){return this.#s===null||this.getHash()===this.#s}getOrder(){return this.#t.size?this.#n?this.#n.slice():[...this.#t.keys()]:null}getGroups(){return this.#t.size>0?(0,n.objectFromMap)(this.#t):null}getGroup(c){return this.#t.get(c)||null}getHash(){if(this.#e!==null)return this.#e;const c=new r.MurmurHash3_64;for(const[d,h]of this.#t)c.update(`${d}:${h.visible}`);return this.#e=c.hexdigest()}}e.OptionalContentConfig=u},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PDFDataTransportStream=void 0;var n=s(1),r=s(6);class a{constructor({length:c,initialData:d,progressiveDone:h=!1,contentDispositionFilename:m=null,disableRange:_=!1,disableStream:p=!1},b){if((0,n.assert)(b,'PDFDataTransportStream - missing required "pdfDataRangeTransport" argument.'),this._queuedChunks=[],this._progressiveDone=h,this._contentDispositionFilename=m,d?.length>0){const A=d instanceof Uint8Array&&d.byteLength===d.buffer.byteLength?d.buffer:new Uint8Array(d).buffer;this._queuedChunks.push(A)}this._pdfDataRangeTransport=b,this._isStreamingSupported=!p,this._isRangeSupported=!_,this._contentLength=c,this._fullRequestReader=null,this._rangeReaders=[],this._pdfDataRangeTransport.addRangeListener((A,T)=>{this._onReceiveData({begin:A,chunk:T})}),this._pdfDataRangeTransport.addProgressListener((A,T)=>{this._onProgress({loaded:A,total:T})}),this._pdfDataRangeTransport.addProgressiveReadListener(A=>{this._onReceiveData({chunk:A})}),this._pdfDataRangeTransport.addProgressiveDoneListener(()=>{this._onProgressiveDone()}),this._pdfDataRangeTransport.transportReady()}_onReceiveData({begin:c,chunk:d}){const h=d instanceof Uint8Array&&d.byteLength===d.buffer.byteLength?d.buffer:new Uint8Array(d).buffer;if(c===void 0)this._fullRequestReader?this._fullRequestReader._enqueue(h):this._queuedChunks.push(h);else{const m=this._rangeReaders.some(function(_){return _._begin!==c?!1:(_._enqueue(h),!0)});(0,n.assert)(m,"_onReceiveData - no `PDFDataTransportStreamRangeReader` instance found.")}}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}_onProgress(c){c.total===void 0?this._rangeReaders[0]?.onProgress?.({loaded:c.loaded}):this._fullRequestReader?.onProgress?.({loaded:c.loaded,total:c.total})}_onProgressiveDone(){this._fullRequestReader?.progressiveDone(),this._progressiveDone=!0}_removeRangeReader(c){const d=this._rangeReaders.indexOf(c);d>=0&&this._rangeReaders.splice(d,1)}getFullReader(){(0,n.assert)(!this._fullRequestReader,"PDFDataTransportStream.getFullReader can only be called once.");const c=this._queuedChunks;return this._queuedChunks=null,new i(this,c,this._progressiveDone,this._contentDispositionFilename)}getRangeReader(c,d){if(d<=this._progressiveDataLength)return null;const h=new u(this,c,d);return this._pdfDataRangeTransport.requestDataRange(c,d),this._rangeReaders.push(h),h}cancelAllRequests(c){this._fullRequestReader?.cancel(c);for(const d of this._rangeReaders.slice(0))d.cancel(c);this._pdfDataRangeTransport.abort()}}e.PDFDataTransportStream=a;class i{constructor(c,d,h=!1,m=null){this._stream=c,this._done=h||!1,this._filename=(0,r.isPdfFile)(m)?m:null,this._queuedChunks=d||[],this._loaded=0;for(const _ of this._queuedChunks)this._loaded+=_.byteLength;this._requests=[],this._headersReady=Promise.resolve(),c._fullRequestReader=this,this.onProgress=null}_enqueue(c){this._done||(this._requests.length>0?this._requests.shift().resolve({value:c,done:!1}):this._queuedChunks.push(c),this._loaded+=c.byteLength)}get headersReady(){return this._headersReady}get filename(){return this._filename}get isRangeSupported(){return this._stream._isRangeSupported}get isStreamingSupported(){return this._stream._isStreamingSupported}get contentLength(){return this._stream._contentLength}async read(){if(this._queuedChunks.length>0)return{value:this._queuedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};const c=new n.PromiseCapability;return this._requests.push(c),c.promise}cancel(c){this._done=!0;for(const d of this._requests)d.resolve({value:void 0,done:!0});this._requests.length=0}progressiveDone(){this._done||(this._done=!0)}}class u{constructor(c,d,h){this._stream=c,this._begin=d,this._end=h,this._queuedChunk=null,this._requests=[],this._done=!1,this.onProgress=null}_enqueue(c){if(!this._done){if(this._requests.length===0)this._queuedChunk=c;else{this._requests.shift().resolve({value:c,done:!1});for(const h of this._requests)h.resolve({value:void 0,done:!0});this._requests.length=0}this._done=!0,this._stream._removeRangeReader(this)}}get isStreamingSupported(){return!1}async read(){if(this._queuedChunk){const d=this._queuedChunk;return this._queuedChunk=null,{value:d,done:!1}}if(this._done)return{value:void 0,done:!0};const c=new n.PromiseCapability;return this._requests.push(c),c.promise}cancel(c){this._done=!0;for(const d of this._requests)d.resolve({value:void 0,done:!0});this._requests.length=0,this._stream._removeRangeReader(this)}}},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PDFFetchStream=void 0;var n=s(1),r=s(20);function a(h,m,_){return{method:"GET",headers:h,signal:_.signal,mode:"cors",credentials:m?"include":"same-origin",redirect:"follow"}}function i(h){const m=new Headers;for(const _ in h){const p=h[_];p!==void 0&&m.append(_,p)}return m}function u(h){return h instanceof Uint8Array?h.buffer:h instanceof ArrayBuffer?h:((0,n.warn)(`getArrayBuffer - unexpected data format: ${h}`),new Uint8Array(h).buffer)}class f{constructor(m){this.source=m,this.isHttp=/^https?:/i.test(m.url),this.httpHeaders=this.isHttp&&m.httpHeaders||{},this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){return(0,n.assert)(!this._fullRequestReader,"PDFFetchStream.getFullReader can only be called once."),this._fullRequestReader=new c(this),this._fullRequestReader}getRangeReader(m,_){if(_<=this._progressiveDataLength)return null;const p=new d(this,m,_);return this._rangeRequestReaders.push(p),p}cancelAllRequests(m){this._fullRequestReader?.cancel(m);for(const _ of this._rangeRequestReaders.slice(0))_.cancel(m)}}e.PDFFetchStream=f;class c{constructor(m){this._stream=m,this._reader=null,this._loaded=0,this._filename=null;const _=m.source;this._withCredentials=_.withCredentials||!1,this._contentLength=_.length,this._headersCapability=new n.PromiseCapability,this._disableRange=_.disableRange||!1,this._rangeChunkSize=_.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._abortController=new AbortController,this._isStreamingSupported=!_.disableStream,this._isRangeSupported=!_.disableRange,this._headers=i(this._stream.httpHeaders);const p=_.url;fetch(p,a(this._headers,this._withCredentials,this._abortController)).then(b=>{if(!(0,r.validateResponseStatus)(b.status))throw(0,r.createResponseStatusError)(b.status,p);this._reader=b.body.getReader(),this._headersCapability.resolve();const A=N=>b.headers.get(N),{allowRangeRequests:T,suggestedLength:v}=(0,r.validateRangeRequestCapabilities)({getResponseHeader:A,isHttp:this._stream.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});this._isRangeSupported=T,this._contentLength=v||this._contentLength,this._filename=(0,r.extractFilenameFromHeader)(A),!this._isStreamingSupported&&this._isRangeSupported&&this.cancel(new n.AbortException("Streaming is disabled."))}).catch(this._headersCapability.reject),this.onProgress=null}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._headersCapability.promise;const{value:m,done:_}=await this._reader.read();return _?{value:m,done:_}:(this._loaded+=m.byteLength,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:u(m),done:!1})}cancel(m){this._reader?.cancel(m),this._abortController.abort()}}class d{constructor(m,_,p){this._stream=m,this._reader=null,this._loaded=0;const b=m.source;this._withCredentials=b.withCredentials||!1,this._readCapability=new n.PromiseCapability,this._isStreamingSupported=!b.disableStream,this._abortController=new AbortController,this._headers=i(this._stream.httpHeaders),this._headers.append("Range",`bytes=${_}-${p-1}`);const A=b.url;fetch(A,a(this._headers,this._withCredentials,this._abortController)).then(T=>{if(!(0,r.validateResponseStatus)(T.status))throw(0,r.createResponseStatusError)(T.status,A);this._readCapability.resolve(),this._reader=T.body.getReader()}).catch(this._readCapability.reject),this.onProgress=null}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._readCapability.promise;const{value:m,done:_}=await this._reader.read();return _?{value:m,done:_}:(this._loaded+=m.byteLength,this.onProgress?.({loaded:this._loaded}),{value:u(m),done:!1})}cancel(m){this._reader?.cancel(m),this._abortController.abort()}}},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.createResponseStatusError=f,e.extractFilenameFromHeader=u,e.validateRangeRequestCapabilities=i,e.validateResponseStatus=c;var n=s(1),r=s(21),a=s(6);function i({getResponseHeader:d,isHttp:h,rangeChunkSize:m,disableRange:_}){const p={allowRangeRequests:!1,suggestedLength:void 0},b=parseInt(d("Content-Length"),10);return!Number.isInteger(b)||(p.suggestedLength=b,b<=2*m)||_||!h||d("Accept-Ranges")!=="bytes"||(d("Content-Encoding")||"identity")!=="identity"||(p.allowRangeRequests=!0),p}function u(d){const h=d("Content-Disposition");if(h){let m=(0,r.getFilenameFromContentDispositionHeader)(h);if(m.includes("%"))try{m=decodeURIComponent(m)}catch{}if((0,a.isPdfFile)(m))return m}return null}function f(d,h){return d===404||d===0&&h.startsWith("file:")?new n.MissingPDFException('Missing PDF "'+h+'".'):new n.UnexpectedResponseException(`Unexpected server response (${d}) while retrieving PDF "${h}".`,d)}function c(d){return d===200||d===206}},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.getFilenameFromContentDispositionHeader=r;var n=s(1);function r(a){let i=!0,u=f("filename\\*","i").exec(a);if(u){u=u[1];let b=m(u);return b=unescape(b),b=_(b),b=p(b),d(b)}if(u=h(a),u){const b=p(u);return d(b)}if(u=f("filename","i").exec(a),u){u=u[1];let b=m(u);return b=p(b),d(b)}function f(b,A){return new RegExp("(?:^|;)\\s*"+b+'\\s*=\\s*([^";\\s][^;\\s]*|"(?:[^"\\\\]|\\\\"?)+"?)',A)}function c(b,A){if(b){if(!/^[\x00-\xFF]+$/.test(A))return A;try{const T=new TextDecoder(b,{fatal:!0}),v=(0,n.stringToBytes)(A);A=T.decode(v),i=!1}catch{}}return A}function d(b){return i&&/[\x80-\xff]/.test(b)&&(b=c("utf-8",b),i&&(b=c("iso-8859-1",b))),b}function h(b){const A=[];let T;const v=f("filename\\*((?!0\\d)\\d+)(\\*?)","ig");for(;(T=v.exec(b))!==null;){let[,x,y,S]=T;if(x=parseInt(x,10),x in A){if(x===0)break;continue}A[x]=[y,S]}const N=[];for(let x=0;x<A.length&&x in A;++x){let[y,S]=A[x];S=m(S),y&&(S=unescape(S),x===0&&(S=_(S))),N.push(S)}return N.join("")}function m(b){if(b.startsWith('"')){const A=b.slice(1).split('\\"');for(let T=0;T<A.length;++T){const v=A[T].indexOf('"');v!==-1&&(A[T]=A[T].slice(0,v),A.length=T+1),A[T]=A[T].replaceAll(/\\(.)/g,"$1")}b=A.join('"')}return b}function _(b){const A=b.indexOf("'");if(A===-1)return b;const T=b.slice(0,A),N=b.slice(A+1).replace(/^[^']*'/,"");return c(T,N)}function p(b){return!b.startsWith("=?")||/[\x00-\x19\x80-\xff]/.test(b)?b:b.replaceAll(/=\?([\w-]*)\?([QqBb])\?((?:[^?]|\?(?!=))*)\?=/g,function(A,T,v,N){if(v==="q"||v==="Q")return N=N.replaceAll("_"," "),N=N.replaceAll(/=([0-9a-fA-F]{2})/g,function(x,y){return String.fromCharCode(parseInt(y,16))}),c(T,N);try{N=atob(N)}catch{}return c(T,N)})}return""}},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PDFNetworkStream=void 0;var n=s(1),r=s(20);const a=200,i=206;function u(m){const _=m.response;return typeof _!="string"?_:(0,n.stringToBytes)(_).buffer}class f{constructor(_,p={}){this.url=_,this.isHttp=/^https?:/i.test(_),this.httpHeaders=this.isHttp&&p.httpHeaders||Object.create(null),this.withCredentials=p.withCredentials||!1,this.currXhrId=0,this.pendingRequests=Object.create(null)}requestRange(_,p,b){const A={begin:_,end:p};for(const T in b)A[T]=b[T];return this.request(A)}requestFull(_){return this.request(_)}request(_){const p=new XMLHttpRequest,b=this.currXhrId++,A=this.pendingRequests[b]={xhr:p};p.open("GET",this.url),p.withCredentials=this.withCredentials;for(const T in this.httpHeaders){const v=this.httpHeaders[T];v!==void 0&&p.setRequestHeader(T,v)}return this.isHttp&&"begin"in _&&"end"in _?(p.setRequestHeader("Range",`bytes=${_.begin}-${_.end-1}`),A.expectedStatus=i):A.expectedStatus=a,p.responseType="arraybuffer",_.onError&&(p.onerror=function(T){_.onError(p.status)}),p.onreadystatechange=this.onStateChange.bind(this,b),p.onprogress=this.onProgress.bind(this,b),A.onHeadersReceived=_.onHeadersReceived,A.onDone=_.onDone,A.onError=_.onError,A.onProgress=_.onProgress,p.send(null),b}onProgress(_,p){const b=this.pendingRequests[_];b&&b.onProgress?.(p)}onStateChange(_,p){const b=this.pendingRequests[_];if(!b)return;const A=b.xhr;if(A.readyState>=2&&b.onHeadersReceived&&(b.onHeadersReceived(),delete b.onHeadersReceived),A.readyState!==4||!(_ in this.pendingRequests))return;if(delete this.pendingRequests[_],A.status===0&&this.isHttp){b.onError?.(A.status);return}const T=A.status||a;if(!(T===a&&b.expectedStatus===i)&&T!==b.expectedStatus){b.onError?.(A.status);return}const N=u(A);if(T===i){const x=A.getResponseHeader("Content-Range"),y=/bytes (\d+)-(\d+)\/(\d+)/.exec(x);b.onDone({begin:parseInt(y[1],10),chunk:N})}else N?b.onDone({begin:0,chunk:N}):b.onError?.(A.status)}getRequestXhr(_){return this.pendingRequests[_].xhr}isPendingRequest(_){return _ in this.pendingRequests}abortRequest(_){const p=this.pendingRequests[_].xhr;delete this.pendingRequests[_],p.abort()}}class c{constructor(_){this._source=_,this._manager=new f(_.url,{httpHeaders:_.httpHeaders,withCredentials:_.withCredentials}),this._rangeChunkSize=_.rangeChunkSize,this._fullRequestReader=null,this._rangeRequestReaders=[]}_onRangeRequestReaderClosed(_){const p=this._rangeRequestReaders.indexOf(_);p>=0&&this._rangeRequestReaders.splice(p,1)}getFullReader(){return(0,n.assert)(!this._fullRequestReader,"PDFNetworkStream.getFullReader can only be called once."),this._fullRequestReader=new d(this._manager,this._source),this._fullRequestReader}getRangeReader(_,p){const b=new h(this._manager,_,p);return b.onClosed=this._onRangeRequestReaderClosed.bind(this),this._rangeRequestReaders.push(b),b}cancelAllRequests(_){this._fullRequestReader?.cancel(_);for(const p of this._rangeRequestReaders.slice(0))p.cancel(_)}}e.PDFNetworkStream=c;class d{constructor(_,p){this._manager=_;const b={onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)};this._url=p.url,this._fullRequestId=_.requestFull(b),this._headersReceivedCapability=new n.PromiseCapability,this._disableRange=p.disableRange||!1,this._contentLength=p.length,this._rangeChunkSize=p.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!1,this._isRangeSupported=!1,this._cachedChunks=[],this._requests=[],this._done=!1,this._storedError=void 0,this._filename=null,this.onProgress=null}_onHeadersReceived(){const _=this._fullRequestId,p=this._manager.getRequestXhr(_),b=v=>p.getResponseHeader(v),{allowRangeRequests:A,suggestedLength:T}=(0,r.validateRangeRequestCapabilities)({getResponseHeader:b,isHttp:this._manager.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});A&&(this._isRangeSupported=!0),this._contentLength=T||this._contentLength,this._filename=(0,r.extractFilenameFromHeader)(b),this._isRangeSupported&&this._manager.abortRequest(_),this._headersReceivedCapability.resolve()}_onDone(_){if(_&&(this._requests.length>0?this._requests.shift().resolve({value:_.chunk,done:!1}):this._cachedChunks.push(_.chunk)),this._done=!0,!(this._cachedChunks.length>0)){for(const p of this._requests)p.resolve({value:void 0,done:!0});this._requests.length=0}}_onError(_){this._storedError=(0,r.createResponseStatusError)(_,this._url),this._headersReceivedCapability.reject(this._storedError);for(const p of this._requests)p.reject(this._storedError);this._requests.length=0,this._cachedChunks.length=0}_onProgress(_){this.onProgress?.({loaded:_.loaded,total:_.lengthComputable?_.total:this._contentLength})}get filename(){return this._filename}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}get contentLength(){return this._contentLength}get headersReady(){return this._headersReceivedCapability.promise}async read(){if(this._storedError)throw this._storedError;if(this._cachedChunks.length>0)return{value:this._cachedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};const _=new n.PromiseCapability;return this._requests.push(_),_.promise}cancel(_){this._done=!0,this._headersReceivedCapability.reject(_);for(const p of this._requests)p.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._fullRequestId)&&this._manager.abortRequest(this._fullRequestId),this._fullRequestReader=null}}class h{constructor(_,p,b){this._manager=_;const A={onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)};this._url=_.url,this._requestId=_.requestRange(p,b,A),this._requests=[],this._queuedChunk=null,this._done=!1,this._storedError=void 0,this.onProgress=null,this.onClosed=null}_close(){this.onClosed?.(this)}_onDone(_){const p=_.chunk;this._requests.length>0?this._requests.shift().resolve({value:p,done:!1}):this._queuedChunk=p,this._done=!0;for(const b of this._requests)b.resolve({value:void 0,done:!0});this._requests.length=0,this._close()}_onError(_){this._storedError=(0,r.createResponseStatusError)(_,this._url);for(const p of this._requests)p.reject(this._storedError);this._requests.length=0,this._queuedChunk=null}_onProgress(_){this.isStreamingSupported||this.onProgress?.({loaded:_.loaded})}get isStreamingSupported(){return!1}async read(){if(this._storedError)throw this._storedError;if(this._queuedChunk!==null){const p=this._queuedChunk;return this._queuedChunk=null,{value:p,done:!1}}if(this._done)return{value:void 0,done:!0};const _=new n.PromiseCapability;return this._requests.push(_),_.promise}cancel(_){this._done=!0;for(const p of this._requests)p.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._requestId)&&this._manager.abortRequest(this._requestId),this._close()}}},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PDFNodeStream=void 0;var n=s(1),r=s(20);const a=/^file:\/\/\/[a-zA-Z]:\//;function i(b){const A=require$$0,T=A.parse(b);return T.protocol==="file:"||T.host?T:/^[a-z]:[/\\]/i.test(b)?A.parse(`file:///${b}`):(T.host||(T.protocol="file:"),T)}class u{constructor(A){this.source=A,this.url=i(A.url),this.isHttp=this.url.protocol==="http:"||this.url.protocol==="https:",this.isFsUrl=this.url.protocol==="file:",this.httpHeaders=this.isHttp&&A.httpHeaders||{},this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){return(0,n.assert)(!this._fullRequestReader,"PDFNodeStream.getFullReader can only be called once."),this._fullRequestReader=this.isFsUrl?new _(this):new h(this),this._fullRequestReader}getRangeReader(A,T){if(T<=this._progressiveDataLength)return null;const v=this.isFsUrl?new p(this,A,T):new m(this,A,T);return this._rangeRequestReaders.push(v),v}cancelAllRequests(A){this._fullRequestReader?.cancel(A);for(const T of this._rangeRequestReaders.slice(0))T.cancel(A)}}e.PDFNodeStream=u;class f{constructor(A){this._url=A.url,this._done=!1,this._storedError=null,this.onProgress=null;const T=A.source;this._contentLength=T.length,this._loaded=0,this._filename=null,this._disableRange=T.disableRange||!1,this._rangeChunkSize=T.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!T.disableStream,this._isRangeSupported=!T.disableRange,this._readableStream=null,this._readCapability=new n.PromiseCapability,this._headersCapability=new n.PromiseCapability}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const A=this._readableStream.read();return A===null?(this._readCapability=new n.PromiseCapability,this.read()):(this._loaded+=A.length,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:new Uint8Array(A).buffer,done:!1})}cancel(A){if(!this._readableStream){this._error(A);return}this._readableStream.destroy(A)}_error(A){this._storedError=A,this._readCapability.resolve()}_setReadableStream(A){this._readableStream=A,A.on("readable",()=>{this._readCapability.resolve()}),A.on("end",()=>{A.destroy(),this._done=!0,this._readCapability.resolve()}),A.on("error",T=>{this._error(T)}),!this._isStreamingSupported&&this._isRangeSupported&&this._error(new n.AbortException("streaming is disabled")),this._storedError&&this._readableStream.destroy(this._storedError)}}class c{constructor(A){this._url=A.url,this._done=!1,this._storedError=null,this.onProgress=null,this._loaded=0,this._readableStream=null,this._readCapability=new n.PromiseCapability;const T=A.source;this._isStreamingSupported=!T.disableStream}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const A=this._readableStream.read();return A===null?(this._readCapability=new n.PromiseCapability,this.read()):(this._loaded+=A.length,this.onProgress?.({loaded:this._loaded}),{value:new Uint8Array(A).buffer,done:!1})}cancel(A){if(!this._readableStream){this._error(A);return}this._readableStream.destroy(A)}_error(A){this._storedError=A,this._readCapability.resolve()}_setReadableStream(A){this._readableStream=A,A.on("readable",()=>{this._readCapability.resolve()}),A.on("end",()=>{A.destroy(),this._done=!0,this._readCapability.resolve()}),A.on("error",T=>{this._error(T)}),this._storedError&&this._readableStream.destroy(this._storedError)}}function d(b,A){return{protocol:b.protocol,auth:b.auth,host:b.hostname,port:b.port,path:b.path,method:"GET",headers:A}}class h extends f{constructor(A){super(A);const T=v=>{if(v.statusCode===404){const S=new n.MissingPDFException(`Missing PDF "${this._url}".`);this._storedError=S,this._headersCapability.reject(S);return}this._headersCapability.resolve(),this._setReadableStream(v);const N=S=>this._readableStream.headers[S.toLowerCase()],{allowRangeRequests:x,suggestedLength:y}=(0,r.validateRangeRequestCapabilities)({getResponseHeader:N,isHttp:A.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});this._isRangeSupported=x,this._contentLength=y||this._contentLength,this._filename=(0,r.extractFilenameFromHeader)(N)};if(this._request=null,this._url.protocol==="http:"){const v=require$$0;this._request=v.request(d(this._url,A.httpHeaders),T)}else{const v=require$$0;this._request=v.request(d(this._url,A.httpHeaders),T)}this._request.on("error",v=>{this._storedError=v,this._headersCapability.reject(v)}),this._request.end()}}class m extends c{constructor(A,T,v){super(A),this._httpHeaders={};for(const x in A.httpHeaders){const y=A.httpHeaders[x];y!==void 0&&(this._httpHeaders[x]=y)}this._httpHeaders.Range=`bytes=${T}-${v-1}`;const N=x=>{if(x.statusCode===404){const y=new n.MissingPDFException(`Missing PDF "${this._url}".`);this._storedError=y;return}this._setReadableStream(x)};if(this._request=null,this._url.protocol==="http:"){const x=require$$0;this._request=x.request(d(this._url,this._httpHeaders),N)}else{const x=require$$0;this._request=x.request(d(this._url,this._httpHeaders),N)}this._request.on("error",x=>{this._storedError=x}),this._request.end()}}class _ extends f{constructor(A){super(A);let T=decodeURIComponent(this._url.path);a.test(this._url.href)&&(T=T.replace(/^\//,""));const v=require$$0;v.lstat(T,(N,x)=>{if(N){N.code==="ENOENT"&&(N=new n.MissingPDFException(`Missing PDF "${T}".`)),this._storedError=N,this._headersCapability.reject(N);return}this._contentLength=x.size,this._setReadableStream(v.createReadStream(T)),this._headersCapability.resolve()})}}class p extends c{constructor(A,T,v){super(A);let N=decodeURIComponent(this._url.path);a.test(this._url.href)&&(N=N.replace(/^\//,""));const x=require$$0;this._setReadableStream(x.createReadStream(N,{start:T,end:v-1}))}}},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.SVGGraphics=void 0;var n=s(6),r=s(1);const a={fontStyle:"normal",fontWeight:"normal",fillColor:"#000000"},i="http://www.w3.org/XML/1998/namespace",u="http://www.w3.org/1999/xlink",f=["butt","round","square"],c=["miter","round","bevel"],d=function(x,y="",S=!1){if(URL.createObjectURL&&typeof Blob<"u"&&!S)return URL.createObjectURL(new Blob([x],{type:y}));const D="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let F=`data:${y};base64,`;for(let B=0,W=x.length;B<W;B+=3){const z=x[B]&255,re=x[B+1]&255,X=x[B+2]&255,ne=z>>2,ie=(z&3)<<4|re>>4,te=B+1<W?(re&15)<<2|X>>6:64,H=B+2<W?X&63:64;F+=D[ne]+D[ie]+D[te]+D[H]}return F},h=function(){const x=new Uint8Array([137,80,78,71,13,10,26,10]),y=12,S=new Int32Array(256);for(let X=0;X<256;X++){let ne=X;for(let ie=0;ie<8;ie++)ne=ne&1?3988292384^ne>>1&2147483647:ne>>1&2147483647;S[X]=ne}function D(X,ne,ie){let te=-1;for(let H=ne;H<ie;H++){const P=(te^X[H])&255,C=S[P];te=te>>>8^C}return te^-1}function F(X,ne,ie,te){let H=te;const P=ne.length;ie[H]=P>>24&255,ie[H+1]=P>>16&255,ie[H+2]=P>>8&255,ie[H+3]=P&255,H+=4,ie[H]=X.charCodeAt(0)&255,ie[H+1]=X.charCodeAt(1)&255,ie[H+2]=X.charCodeAt(2)&255,ie[H+3]=X.charCodeAt(3)&255,H+=4,ie.set(ne,H),H+=ne.length;const C=D(ie,te+4,H);ie[H]=C>>24&255,ie[H+1]=C>>16&255,ie[H+2]=C>>8&255,ie[H+3]=C&255}function B(X,ne,ie){let te=1,H=0;for(let P=ne;P<ie;++P)te=(te+(X[P]&255))%65521,H=(H+te)%65521;return H<<16|te}function W(X){if(!r.isNodeJS)return z(X);try{const ne=parseInt(process.versions.node)>=8?X:Buffer.from(X),ie=require$$0.deflateSync(ne,{level:9});return ie instanceof Uint8Array?ie:new Uint8Array(ie)}catch(ne){(0,r.warn)("Not compressing PNG because zlib.deflateSync is unavailable: "+ne)}return z(X)}function z(X){let ne=X.length;const ie=65535,te=Math.ceil(ne/ie),H=new Uint8Array(2+ne+te*5+4);let P=0;H[P++]=120,H[P++]=156;let C=0;for(;ne>ie;)H[P++]=0,H[P++]=255,H[P++]=255,H[P++]=0,H[P++]=0,H.set(X.subarray(C,C+ie),P),P+=ie,C+=ie,ne-=ie;H[P++]=1,H[P++]=ne&255,H[P++]=ne>>8&255,H[P++]=~ne&65535&255,H[P++]=(~ne&65535)>>8&255,H.set(X.subarray(C),P),P+=X.length-C;const I=B(X,0,X.length);return H[P++]=I>>24&255,H[P++]=I>>16&255,H[P++]=I>>8&255,H[P++]=I&255,H}function re(X,ne,ie,te){const H=X.width,P=X.height;let C,I,R;const L=X.data;switch(ne){case r.ImageKind.GRAYSCALE_1BPP:I=0,C=1,R=H+7>>3;break;case r.ImageKind.RGB_24BPP:I=2,C=8,R=H*3;break;case r.ImageKind.RGBA_32BPP:I=6,C=8,R=H*4;break;default:throw new Error("invalid format")}const G=new Uint8Array((1+R)*P);let j=0,M=0;for(let q=0;q<P;++q)G[j++]=0,G.set(L.subarray(M,M+R),j),M+=R,j+=R;if(ne===r.ImageKind.GRAYSCALE_1BPP&&te){j=0;for(let q=0;q<P;q++){j++;for(let V=0;V<R;V++)G[j++]^=255}}const E=new Uint8Array([H>>24&255,H>>16&255,H>>8&255,H&255,P>>24&255,P>>16&255,P>>8&255,P&255,C,I,0,0,0]),w=W(G),O=x.length+y*3+E.length+w.length,k=new Uint8Array(O);let U=0;return k.set(x,U),U+=x.length,F("IHDR",E,k,U),U+=y+E.length,F("IDATA",w,k,U),U+=y+w.length,F("IEND",new Uint8Array(0),k,U),d(k,"image/png",ie)}return function(ne,ie,te){const H=ne.kind===void 0?r.ImageKind.GRAYSCALE_1BPP:ne.kind;return re(ne,H,ie,te)}}();class m{constructor(){this.fontSizeScale=1,this.fontWeight=a.fontWeight,this.fontSize=0,this.textMatrix=r.IDENTITY_MATRIX,this.fontMatrix=r.FONT_IDENTITY_MATRIX,this.leading=0,this.textRenderingMode=r.TextRenderingMode.FILL,this.textMatrixScale=1,this.x=0,this.y=0,this.lineX=0,this.lineY=0,this.charSpacing=0,this.wordSpacing=0,this.textHScale=1,this.textRise=0,this.fillColor=a.fillColor,this.strokeColor="#000000",this.fillAlpha=1,this.strokeAlpha=1,this.lineWidth=1,this.lineJoin="",this.lineCap="",this.miterLimit=0,this.dashArray=[],this.dashPhase=0,this.dependencies=[],this.activeClipUrl=null,this.clipGroup=null,this.maskId=""}clone(){return Object.create(this)}setCurrentPoint(y,S){this.x=y,this.y=S}}function _(x){let y=[];const S=[];for(const D of x){if(D.fn==="save"){y.push({fnId:92,fn:"group",items:[]}),S.push(y),y=y.at(-1).items;continue}D.fn==="restore"?y=S.pop():y.push(D)}return y}function p(x){if(Number.isInteger(x))return x.toString();const y=x.toFixed(10);let S=y.length-1;if(y[S]!=="0")return y;do S--;while(y[S]==="0");return y.substring(0,y[S]==="."?S:S+1)}function b(x){if(x[4]===0&&x[5]===0){if(x[1]===0&&x[2]===0)return x[0]===1&&x[3]===1?"":`scale(${p(x[0])} ${p(x[3])})`;if(x[0]===x[3]&&x[1]===-x[2]){const y=Math.acos(x[0])*180/Math.PI;return`rotate(${p(y)})`}}else if(x[0]===1&&x[1]===0&&x[2]===0&&x[3]===1)return`translate(${p(x[4])} ${p(x[5])})`;return`matrix(${p(x[0])} ${p(x[1])} ${p(x[2])} ${p(x[3])} ${p(x[4])} ${p(x[5])})`}let A=0,T=0,v=0;class N{constructor(y,S,D=!1){(0,n.deprecated)("The SVG back-end is no longer maintained and *may* be removed in the future."),this.svgFactory=new n.DOMSVGFactory,this.current=new m,this.transformMatrix=r.IDENTITY_MATRIX,this.transformStack=[],this.extraStack=[],this.commonObjs=y,this.objs=S,this.pendingClip=null,this.pendingEOFill=!1,this.embedFonts=!1,this.embeddedFonts=Object.create(null),this.cssStyle=null,this.forceDataSchema=!!D,this._operatorIdMapping=[];for(const F in r.OPS)this._operatorIdMapping[r.OPS[F]]=F}getObject(y,S=null){return typeof y=="string"?y.startsWith("g_")?this.commonObjs.get(y):this.objs.get(y):S}save(){this.transformStack.push(this.transformMatrix);const y=this.current;this.extraStack.push(y),this.current=y.clone()}restore(){this.transformMatrix=this.transformStack.pop(),this.current=this.extraStack.pop(),this.pendingClip=null,this.tgrp=null}group(y){this.save(),this.executeOpTree(y),this.restore()}loadDependencies(y){const S=y.fnArray,D=y.argsArray;for(let F=0,B=S.length;F<B;F++)if(S[F]===r.OPS.dependency)for(const W of D[F]){const z=W.startsWith("g_")?this.commonObjs:this.objs,re=new Promise(X=>{z.get(W,X)});this.current.dependencies.push(re)}return Promise.all(this.current.dependencies)}transform(y,S,D,F,B,W){const z=[y,S,D,F,B,W];this.transformMatrix=r.Util.transform(this.transformMatrix,z),this.tgrp=null}getSVG(y,S){this.viewport=S;const D=this._initialize(S);return this.loadDependencies(y).then(()=>(this.transformMatrix=r.IDENTITY_MATRIX,this.executeOpTree(this.convertOpList(y)),D))}convertOpList(y){const S=this._operatorIdMapping,D=y.argsArray,F=y.fnArray,B=[];for(let W=0,z=F.length;W<z;W++){const re=F[W];B.push({fnId:re,fn:S[re],args:D[W]})}return _(B)}executeOpTree(y){for(const S of y){const D=S.fn,F=S.fnId,B=S.args;switch(F|0){case r.OPS.beginText:this.beginText();break;case r.OPS.dependency:break;case r.OPS.setLeading:this.setLeading(B);break;case r.OPS.setLeadingMoveText:this.setLeadingMoveText(B[0],B[1]);break;case r.OPS.setFont:this.setFont(B);break;case r.OPS.showText:this.showText(B[0]);break;case r.OPS.showSpacedText:this.showText(B[0]);break;case r.OPS.endText:this.endText();break;case r.OPS.moveText:this.moveText(B[0],B[1]);break;case r.OPS.setCharSpacing:this.setCharSpacing(B[0]);break;case r.OPS.setWordSpacing:this.setWordSpacing(B[0]);break;case r.OPS.setHScale:this.setHScale(B[0]);break;case r.OPS.setTextMatrix:this.setTextMatrix(B[0],B[1],B[2],B[3],B[4],B[5]);break;case r.OPS.setTextRise:this.setTextRise(B[0]);break;case r.OPS.setTextRenderingMode:this.setTextRenderingMode(B[0]);break;case r.OPS.setLineWidth:this.setLineWidth(B[0]);break;case r.OPS.setLineJoin:this.setLineJoin(B[0]);break;case r.OPS.setLineCap:this.setLineCap(B[0]);break;case r.OPS.setMiterLimit:this.setMiterLimit(B[0]);break;case r.OPS.setFillRGBColor:this.setFillRGBColor(B[0],B[1],B[2]);break;case r.OPS.setStrokeRGBColor:this.setStrokeRGBColor(B[0],B[1],B[2]);break;case r.OPS.setStrokeColorN:this.setStrokeColorN(B);break;case r.OPS.setFillColorN:this.setFillColorN(B);break;case r.OPS.shadingFill:this.shadingFill(B[0]);break;case r.OPS.setDash:this.setDash(B[0],B[1]);break;case r.OPS.setRenderingIntent:this.setRenderingIntent(B[0]);break;case r.OPS.setFlatness:this.setFlatness(B[0]);break;case r.OPS.setGState:this.setGState(B[0]);break;case r.OPS.fill:this.fill();break;case r.OPS.eoFill:this.eoFill();break;case r.OPS.stroke:this.stroke();break;case r.OPS.fillStroke:this.fillStroke();break;case r.OPS.eoFillStroke:this.eoFillStroke();break;case r.OPS.clip:this.clip("nonzero");break;case r.OPS.eoClip:this.clip("evenodd");break;case r.OPS.paintSolidColorImageMask:this.paintSolidColorImageMask();break;case r.OPS.paintImageXObject:this.paintImageXObject(B[0]);break;case r.OPS.paintInlineImageXObject:this.paintInlineImageXObject(B[0]);break;case r.OPS.paintImageMaskXObject:this.paintImageMaskXObject(B[0]);break;case r.OPS.paintFormXObjectBegin:this.paintFormXObjectBegin(B[0],B[1]);break;case r.OPS.paintFormXObjectEnd:this.paintFormXObjectEnd();break;case r.OPS.closePath:this.closePath();break;case r.OPS.closeStroke:this.closeStroke();break;case r.OPS.closeFillStroke:this.closeFillStroke();break;case r.OPS.closeEOFillStroke:this.closeEOFillStroke();break;case r.OPS.nextLine:this.nextLine();break;case r.OPS.transform:this.transform(B[0],B[1],B[2],B[3],B[4],B[5]);break;case r.OPS.constructPath:this.constructPath(B[0],B[1]);break;case r.OPS.endPath:this.endPath();break;case 92:this.group(S.items);break;default:(0,r.warn)(`Unimplemented operator ${D}`);break}}}setWordSpacing(y){this.current.wordSpacing=y}setCharSpacing(y){this.current.charSpacing=y}nextLine(){this.moveText(0,this.current.leading)}setTextMatrix(y,S,D,F,B,W){const z=this.current;z.textMatrix=z.lineMatrix=[y,S,D,F,B,W],z.textMatrixScale=Math.hypot(y,S),z.x=z.lineX=0,z.y=z.lineY=0,z.xcoords=[],z.ycoords=[],z.tspan=this.svgFactory.createElement("svg:tspan"),z.tspan.setAttributeNS(null,"font-family",z.fontFamily),z.tspan.setAttributeNS(null,"font-size",`${p(z.fontSize)}px`),z.tspan.setAttributeNS(null,"y",p(-z.y)),z.txtElement=this.svgFactory.createElement("svg:text"),z.txtElement.append(z.tspan)}beginText(){const y=this.current;y.x=y.lineX=0,y.y=y.lineY=0,y.textMatrix=r.IDENTITY_MATRIX,y.lineMatrix=r.IDENTITY_MATRIX,y.textMatrixScale=1,y.tspan=this.svgFactory.createElement("svg:tspan"),y.txtElement=this.svgFactory.createElement("svg:text"),y.txtgrp=this.svgFactory.createElement("svg:g"),y.xcoords=[],y.ycoords=[]}moveText(y,S){const D=this.current;D.x=D.lineX+=y,D.y=D.lineY+=S,D.xcoords=[],D.ycoords=[],D.tspan=this.svgFactory.createElement("svg:tspan"),D.tspan.setAttributeNS(null,"font-family",D.fontFamily),D.tspan.setAttributeNS(null,"font-size",`${p(D.fontSize)}px`),D.tspan.setAttributeNS(null,"y",p(-D.y))}showText(y){const S=this.current,D=S.font,F=S.fontSize;if(F===0)return;const B=S.fontSizeScale,W=S.charSpacing,z=S.wordSpacing,re=S.fontDirection,X=S.textHScale*re,ne=D.vertical,ie=ne?1:-1,te=D.defaultVMetrics,H=F*S.fontMatrix[0];let P=0;for(const R of y){if(R===null){P+=re*z;continue}else if(typeof R=="number"){P+=ie*R*F/1e3;continue}const L=(R.isSpace?z:0)+W,G=R.fontChar;let j,M,E=R.width;if(ne){let O;const k=R.vmetric||te;O=R.vmetric?k[1]:E*.5,O=-O*H;const U=k[2]*H;E=k?-k[0]:E,j=O/B,M=(P+U)/B}else j=P/B,M=0;(R.isInFont||D.missingFile)&&(S.xcoords.push(S.x+j),ne&&S.ycoords.push(-S.y+M),S.tspan.textContent+=G);const w=ne?E*H-L*re:E*H+L*re;P+=w}S.tspan.setAttributeNS(null,"x",S.xcoords.map(p).join(" ")),ne?S.tspan.setAttributeNS(null,"y",S.ycoords.map(p).join(" ")):S.tspan.setAttributeNS(null,"y",p(-S.y)),ne?S.y-=P:S.x+=P*X,S.tspan.setAttributeNS(null,"font-family",S.fontFamily),S.tspan.setAttributeNS(null,"font-size",`${p(S.fontSize)}px`),S.fontStyle!==a.fontStyle&&S.tspan.setAttributeNS(null,"font-style",S.fontStyle),S.fontWeight!==a.fontWeight&&S.tspan.setAttributeNS(null,"font-weight",S.fontWeight);const C=S.textRenderingMode&r.TextRenderingMode.FILL_STROKE_MASK;if(C===r.TextRenderingMode.FILL||C===r.TextRenderingMode.FILL_STROKE?(S.fillColor!==a.fillColor&&S.tspan.setAttributeNS(null,"fill",S.fillColor),S.fillAlpha<1&&S.tspan.setAttributeNS(null,"fill-opacity",S.fillAlpha)):S.textRenderingMode===r.TextRenderingMode.ADD_TO_PATH?S.tspan.setAttributeNS(null,"fill","transparent"):S.tspan.setAttributeNS(null,"fill","none"),C===r.TextRenderingMode.STROKE||C===r.TextRenderingMode.FILL_STROKE){const R=1/(S.textMatrixScale||1);this._setStrokeAttributes(S.tspan,R)}let I=S.textMatrix;S.textRise!==0&&(I=I.slice(),I[5]+=S.textRise),S.txtElement.setAttributeNS(null,"transform",`${b(I)} scale(${p(X)}, -1)`),S.txtElement.setAttributeNS(i,"xml:space","preserve"),S.txtElement.append(S.tspan),S.txtgrp.append(S.txtElement),this._ensureTransformGroup().append(S.txtElement)}setLeadingMoveText(y,S){this.setLeading(-S),this.moveText(y,S)}addFontStyle(y){if(!y.data)throw new Error('addFontStyle: No font data available, ensure that the "fontExtraProperties" API parameter is set.');this.cssStyle||(this.cssStyle=this.svgFactory.createElement("svg:style"),this.cssStyle.setAttributeNS(null,"type","text/css"),this.defs.append(this.cssStyle));const S=d(y.data,y.mimetype,this.forceDataSchema);this.cssStyle.textContent+=`@font-face { font-family: "${y.loadedName}"; src: url(${S}); }
`}setFont(y){const S=this.current,D=this.commonObjs.get(y[0]);let F=y[1];S.font=D,this.embedFonts&&!D.missingFile&&!this.embeddedFonts[D.loadedName]&&(this.addFontStyle(D),this.embeddedFonts[D.loadedName]=D),S.fontMatrix=D.fontMatrix||r.FONT_IDENTITY_MATRIX;let B="normal";D.black?B="900":D.bold&&(B="bold");const W=D.italic?"italic":"normal";F<0?(F=-F,S.fontDirection=-1):S.fontDirection=1,S.fontSize=F,S.fontFamily=D.loadedName,S.fontWeight=B,S.fontStyle=W,S.tspan=this.svgFactory.createElement("svg:tspan"),S.tspan.setAttributeNS(null,"y",p(-S.y)),S.xcoords=[],S.ycoords=[]}endText(){const y=this.current;y.textRenderingMode&r.TextRenderingMode.ADD_TO_PATH_FLAG&&y.txtElement?.hasChildNodes()&&(y.element=y.txtElement,this.clip("nonzero"),this.endPath())}setLineWidth(y){y>0&&(this.current.lineWidth=y)}setLineCap(y){this.current.lineCap=f[y]}setLineJoin(y){this.current.lineJoin=c[y]}setMiterLimit(y){this.current.miterLimit=y}setStrokeAlpha(y){this.current.strokeAlpha=y}setStrokeRGBColor(y,S,D){this.current.strokeColor=r.Util.makeHexColor(y,S,D)}setFillAlpha(y){this.current.fillAlpha=y}setFillRGBColor(y,S,D){this.current.fillColor=r.Util.makeHexColor(y,S,D),this.current.tspan=this.svgFactory.createElement("svg:tspan"),this.current.xcoords=[],this.current.ycoords=[]}setStrokeColorN(y){this.current.strokeColor=this._makeColorN_Pattern(y)}setFillColorN(y){this.current.fillColor=this._makeColorN_Pattern(y)}shadingFill(y){const{width:S,height:D}=this.viewport,F=r.Util.inverseTransform(this.transformMatrix),[B,W,z,re]=r.Util.getAxialAlignedBoundingBox([0,0,S,D],F),X=this.svgFactory.createElement("svg:rect");X.setAttributeNS(null,"x",B),X.setAttributeNS(null,"y",W),X.setAttributeNS(null,"width",z-B),X.setAttributeNS(null,"height",re-W),X.setAttributeNS(null,"fill",this._makeShadingPattern(y)),this.current.fillAlpha<1&&X.setAttributeNS(null,"fill-opacity",this.current.fillAlpha),this._ensureTransformGroup().append(X)}_makeColorN_Pattern(y){return y[0]==="TilingPattern"?this._makeTilingPattern(y):this._makeShadingPattern(y)}_makeTilingPattern(y){const S=y[1],D=y[2],F=y[3]||r.IDENTITY_MATRIX,[B,W,z,re]=y[4],X=y[5],ne=y[6],ie=y[7],te=`shading${v++}`,[H,P,C,I]=r.Util.normalizeRect([...r.Util.applyTransform([B,W],F),...r.Util.applyTransform([z,re],F)]),[R,L]=r.Util.singularValueDecompose2dScale(F),G=X*R,j=ne*L,M=this.svgFactory.createElement("svg:pattern");M.setAttributeNS(null,"id",te),M.setAttributeNS(null,"patternUnits","userSpaceOnUse"),M.setAttributeNS(null,"width",G),M.setAttributeNS(null,"height",j),M.setAttributeNS(null,"x",`${H}`),M.setAttributeNS(null,"y",`${P}`);const E=this.svg,w=this.transformMatrix,O=this.current.fillColor,k=this.current.strokeColor,U=this.svgFactory.create(C-H,I-P);if(this.svg=U,this.transformMatrix=F,ie===2){const q=r.Util.makeHexColor(...S);this.current.fillColor=q,this.current.strokeColor=q}return this.executeOpTree(this.convertOpList(D)),this.svg=E,this.transformMatrix=w,this.current.fillColor=O,this.current.strokeColor=k,M.append(U.childNodes[0]),this.defs.append(M),`url(#${te})`}_makeShadingPattern(y){switch(typeof y=="string"&&(y=this.objs.get(y)),y[0]){case"RadialAxial":const S=`shading${v++}`,D=y[3];let F;switch(y[1]){case"axial":const B=y[4],W=y[5];F=this.svgFactory.createElement("svg:linearGradient"),F.setAttributeNS(null,"id",S),F.setAttributeNS(null,"gradientUnits","userSpaceOnUse"),F.setAttributeNS(null,"x1",B[0]),F.setAttributeNS(null,"y1",B[1]),F.setAttributeNS(null,"x2",W[0]),F.setAttributeNS(null,"y2",W[1]);break;case"radial":const z=y[4],re=y[5],X=y[6],ne=y[7];F=this.svgFactory.createElement("svg:radialGradient"),F.setAttributeNS(null,"id",S),F.setAttributeNS(null,"gradientUnits","userSpaceOnUse"),F.setAttributeNS(null,"cx",re[0]),F.setAttributeNS(null,"cy",re[1]),F.setAttributeNS(null,"r",ne),F.setAttributeNS(null,"fx",z[0]),F.setAttributeNS(null,"fy",z[1]),F.setAttributeNS(null,"fr",X);break;default:throw new Error(`Unknown RadialAxial type: ${y[1]}`)}for(const B of D){const W=this.svgFactory.createElement("svg:stop");W.setAttributeNS(null,"offset",B[0]),W.setAttributeNS(null,"stop-color",B[1]),F.append(W)}return this.defs.append(F),`url(#${S})`;case"Mesh":return(0,r.warn)("Unimplemented pattern Mesh"),null;case"Dummy":return"hotpink";default:throw new Error(`Unknown IR type: ${y[0]}`)}}setDash(y,S){this.current.dashArray=y,this.current.dashPhase=S}constructPath(y,S){const D=this.current;let F=D.x,B=D.y,W=[],z=0;for(const re of y)switch(re|0){case r.OPS.rectangle:F=S[z++],B=S[z++];const X=S[z++],ne=S[z++],ie=F+X,te=B+ne;W.push("M",p(F),p(B),"L",p(ie),p(B),"L",p(ie),p(te),"L",p(F),p(te),"Z");break;case r.OPS.moveTo:F=S[z++],B=S[z++],W.push("M",p(F),p(B));break;case r.OPS.lineTo:F=S[z++],B=S[z++],W.push("L",p(F),p(B));break;case r.OPS.curveTo:F=S[z+4],B=S[z+5],W.push("C",p(S[z]),p(S[z+1]),p(S[z+2]),p(S[z+3]),p(F),p(B)),z+=6;break;case r.OPS.curveTo2:W.push("C",p(F),p(B),p(S[z]),p(S[z+1]),p(S[z+2]),p(S[z+3])),F=S[z+2],B=S[z+3],z+=4;break;case r.OPS.curveTo3:F=S[z+2],B=S[z+3],W.push("C",p(S[z]),p(S[z+1]),p(F),p(B),p(F),p(B)),z+=4;break;case r.OPS.closePath:W.push("Z");break}W=W.join(" "),D.path&&y.length>0&&y[0]!==r.OPS.rectangle&&y[0]!==r.OPS.moveTo?W=D.path.getAttributeNS(null,"d")+W:(D.path=this.svgFactory.createElement("svg:path"),this._ensureTransformGroup().append(D.path)),D.path.setAttributeNS(null,"d",W),D.path.setAttributeNS(null,"fill","none"),D.element=D.path,D.setCurrentPoint(F,B)}endPath(){const y=this.current;if(y.path=null,!this.pendingClip)return;if(!y.element){this.pendingClip=null;return}const S=`clippath${A++}`,D=this.svgFactory.createElement("svg:clipPath");D.setAttributeNS(null,"id",S),D.setAttributeNS(null,"transform",b(this.transformMatrix));const F=y.element.cloneNode(!0);if(this.pendingClip==="evenodd"?F.setAttributeNS(null,"clip-rule","evenodd"):F.setAttributeNS(null,"clip-rule","nonzero"),this.pendingClip=null,D.append(F),this.defs.append(D),y.activeClipUrl){y.clipGroup=null;for(const B of this.extraStack)B.clipGroup=null;D.setAttributeNS(null,"clip-path",y.activeClipUrl)}y.activeClipUrl=`url(#${S})`,this.tgrp=null}clip(y){this.pendingClip=y}closePath(){const y=this.current;if(y.path){const S=`${y.path.getAttributeNS(null,"d")}Z`;y.path.setAttributeNS(null,"d",S)}}setLeading(y){this.current.leading=-y}setTextRise(y){this.current.textRise=y}setTextRenderingMode(y){this.current.textRenderingMode=y}setHScale(y){this.current.textHScale=y/100}setRenderingIntent(y){}setFlatness(y){}setGState(y){for(const[S,D]of y)switch(S){case"LW":this.setLineWidth(D);break;case"LC":this.setLineCap(D);break;case"LJ":this.setLineJoin(D);break;case"ML":this.setMiterLimit(D);break;case"D":this.setDash(D[0],D[1]);break;case"RI":this.setRenderingIntent(D);break;case"FL":this.setFlatness(D);break;case"Font":this.setFont(D);break;case"CA":this.setStrokeAlpha(D);break;case"ca":this.setFillAlpha(D);break;default:(0,r.warn)(`Unimplemented graphic state operator ${S}`);break}}fill(){const y=this.current;y.element&&(y.element.setAttributeNS(null,"fill",y.fillColor),y.element.setAttributeNS(null,"fill-opacity",y.fillAlpha),this.endPath())}stroke(){const y=this.current;y.element&&(this._setStrokeAttributes(y.element),y.element.setAttributeNS(null,"fill","none"),this.endPath())}_setStrokeAttributes(y,S=1){const D=this.current;let F=D.dashArray;S!==1&&F.length>0&&(F=F.map(function(B){return S*B})),y.setAttributeNS(null,"stroke",D.strokeColor),y.setAttributeNS(null,"stroke-opacity",D.strokeAlpha),y.setAttributeNS(null,"stroke-miterlimit",p(D.miterLimit)),y.setAttributeNS(null,"stroke-linecap",D.lineCap),y.setAttributeNS(null,"stroke-linejoin",D.lineJoin),y.setAttributeNS(null,"stroke-width",p(S*D.lineWidth)+"px"),y.setAttributeNS(null,"stroke-dasharray",F.map(p).join(" ")),y.setAttributeNS(null,"stroke-dashoffset",p(S*D.dashPhase)+"px")}eoFill(){this.current.element?.setAttributeNS(null,"fill-rule","evenodd"),this.fill()}fillStroke(){this.stroke(),this.fill()}eoFillStroke(){this.current.element?.setAttributeNS(null,"fill-rule","evenodd"),this.fillStroke()}closeStroke(){this.closePath(),this.stroke()}closeFillStroke(){this.closePath(),this.fillStroke()}closeEOFillStroke(){this.closePath(),this.eoFillStroke()}paintSolidColorImageMask(){const y=this.svgFactory.createElement("svg:rect");y.setAttributeNS(null,"x","0"),y.setAttributeNS(null,"y","0"),y.setAttributeNS(null,"width","1px"),y.setAttributeNS(null,"height","1px"),y.setAttributeNS(null,"fill",this.current.fillColor),this._ensureTransformGroup().append(y)}paintImageXObject(y){const S=this.getObject(y);if(!S){(0,r.warn)(`Dependent image with object ID ${y} is not ready yet`);return}this.paintInlineImageXObject(S)}paintInlineImageXObject(y,S){const D=y.width,F=y.height,B=h(y,this.forceDataSchema,!!S),W=this.svgFactory.createElement("svg:rect");W.setAttributeNS(null,"x","0"),W.setAttributeNS(null,"y","0"),W.setAttributeNS(null,"width",p(D)),W.setAttributeNS(null,"height",p(F)),this.current.element=W,this.clip("nonzero");const z=this.svgFactory.createElement("svg:image");z.setAttributeNS(u,"xlink:href",B),z.setAttributeNS(null,"x","0"),z.setAttributeNS(null,"y",p(-F)),z.setAttributeNS(null,"width",p(D)+"px"),z.setAttributeNS(null,"height",p(F)+"px"),z.setAttributeNS(null,"transform",`scale(${p(1/D)} ${p(-1/F)})`),S?S.append(z):this._ensureTransformGroup().append(z)}paintImageMaskXObject(y){const S=this.getObject(y.data,y);if(S.bitmap){(0,r.warn)("paintImageMaskXObject: ImageBitmap support is not implemented, ensure that the `isOffscreenCanvasSupported` API parameter is disabled.");return}const D=this.current,F=S.width,B=S.height,W=D.fillColor;D.maskId=`mask${T++}`;const z=this.svgFactory.createElement("svg:mask");z.setAttributeNS(null,"id",D.maskId);const re=this.svgFactory.createElement("svg:rect");re.setAttributeNS(null,"x","0"),re.setAttributeNS(null,"y","0"),re.setAttributeNS(null,"width",p(F)),re.setAttributeNS(null,"height",p(B)),re.setAttributeNS(null,"fill",W),re.setAttributeNS(null,"mask",`url(#${D.maskId})`),this.defs.append(z),this._ensureTransformGroup().append(re),this.paintInlineImageXObject(S,z)}paintFormXObjectBegin(y,S){if(Array.isArray(y)&&y.length===6&&this.transform(y[0],y[1],y[2],y[3],y[4],y[5]),S){const D=S[2]-S[0],F=S[3]-S[1],B=this.svgFactory.createElement("svg:rect");B.setAttributeNS(null,"x",S[0]),B.setAttributeNS(null,"y",S[1]),B.setAttributeNS(null,"width",p(D)),B.setAttributeNS(null,"height",p(F)),this.current.element=B,this.clip("nonzero"),this.endPath()}}paintFormXObjectEnd(){}_initialize(y){const S=this.svgFactory.create(y.width,y.height),D=this.svgFactory.createElement("svg:defs");S.append(D),this.defs=D;const F=this.svgFactory.createElement("svg:g");return F.setAttributeNS(null,"transform",b(y.transform)),S.append(F),this.svg=F,S}_ensureClipGroup(){if(!this.current.clipGroup){const y=this.svgFactory.createElement("svg:g");y.setAttributeNS(null,"clip-path",this.current.activeClipUrl),this.svg.append(y),this.current.clipGroup=y}return this.current.clipGroup}_ensureTransformGroup(){return this.tgrp||(this.tgrp=this.svgFactory.createElement("svg:g"),this.tgrp.setAttributeNS(null,"transform",b(this.transformMatrix)),this.current.activeClipUrl?this._ensureClipGroup().append(this.tgrp):this.svg.append(this.tgrp)),this.tgrp}}e.SVGGraphics=N},(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.XfaText=void 0;class s{static textContent(r){const a=[],i={items:a,styles:Object.create(null)};function u(f){if(!f)return;let c=null;const d=f.name;if(d==="#text")c=f.value;else if(s.shouldBuildText(d))f?.attributes?.textContent?c=f.attributes.textContent:f.value&&(c=f.value);else return;if(c!==null&&a.push({str:c}),!!f.children)for(const h of f.children)u(h)}return u(r),i}static shouldBuildText(r){return!(r==="textarea"||r==="input"||r==="option"||r==="select")}}e.XfaText=s},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.TextLayerRenderTask=void 0,e.renderTextLayer=b,e.updateTextLayer=A;var n=s(1),r=s(6);const a=1e5,i=30,u=.8,f=new Map;function c(T,v){let N;if(v&&n.FeatureTest.isOffscreenCanvasSupported)N=new OffscreenCanvas(T,T).getContext("2d",{alpha:!1});else{const x=document.createElement("canvas");x.width=x.height=T,N=x.getContext("2d",{alpha:!1})}return N}function d(T,v){const N=f.get(T);if(N)return N;const x=c(i,v);x.font=`${i}px ${T}`;const y=x.measureText("");let S=y.fontBoundingBoxAscent,D=Math.abs(y.fontBoundingBoxDescent);if(S){const B=S/(S+D);return f.set(T,B),x.canvas.width=x.canvas.height=0,B}x.strokeStyle="red",x.clearRect(0,0,i,i),x.strokeText("g",0,0);let F=x.getImageData(0,0,i,i).data;D=0;for(let B=F.length-1-3;B>=0;B-=4)if(F[B]>0){D=Math.ceil(B/4/i);break}x.clearRect(0,0,i,i),x.strokeText("A",0,i),F=x.getImageData(0,0,i,i).data,S=0;for(let B=0,W=F.length;B<W;B+=4)if(F[B]>0){S=i-Math.floor(B/4/i);break}if(x.canvas.width=x.canvas.height=0,S){const B=S/(S+D);return f.set(T,B),B}return f.set(T,u),u}function h(T,v,N){const x=document.createElement("span"),y={angle:0,canvasWidth:0,hasText:v.str!=="",hasEOL:v.hasEOL,fontSize:0};T._textDivs.push(x);const S=n.Util.transform(T._transform,v.transform);let D=Math.atan2(S[1],S[0]);const F=N[v.fontName];F.vertical&&(D+=Math.PI/2);const B=Math.hypot(S[2],S[3]),W=B*d(F.fontFamily,T._isOffscreenCanvasSupported);let z,re;D===0?(z=S[4],re=S[5]-W):(z=S[4]+W*Math.sin(D),re=S[5]-W*Math.cos(D));const X="calc(var(--scale-factor)*",ne=x.style;T._container===T._rootContainer?(ne.left=`${(100*z/T._pageWidth).toFixed(2)}%`,ne.top=`${(100*re/T._pageHeight).toFixed(2)}%`):(ne.left=`${X}${z.toFixed(2)}px)`,ne.top=`${X}${re.toFixed(2)}px)`),ne.fontSize=`${X}${B.toFixed(2)}px)`,ne.fontFamily=F.fontFamily,y.fontSize=B,x.setAttribute("role","presentation"),x.textContent=v.str,x.dir=v.dir,T._fontInspectorEnabled&&(x.dataset.fontName=v.fontName),D!==0&&(y.angle=D*(180/Math.PI));let ie=!1;if(v.str.length>1)ie=!0;else if(v.str!==" "&&v.transform[0]!==v.transform[3]){const te=Math.abs(v.transform[0]),H=Math.abs(v.transform[3]);te!==H&&Math.max(te,H)/Math.min(te,H)>1.5&&(ie=!0)}ie&&(y.canvasWidth=F.vertical?v.height:v.width),T._textDivProperties.set(x,y),T._isReadableStream&&T._layoutText(x)}function m(T){const{div:v,scale:N,properties:x,ctx:y,prevFontSize:S,prevFontFamily:D}=T,{style:F}=v;let B="";if(x.canvasWidth!==0&&x.hasText){const{fontFamily:W}=F,{canvasWidth:z,fontSize:re}=x;(S!==re||D!==W)&&(y.font=`${re*N}px ${W}`,T.prevFontSize=re,T.prevFontFamily=W);const{width:X}=y.measureText(v.textContent);X>0&&(B=`scaleX(${z*N/X})`)}x.angle!==0&&(B=`rotate(${x.angle}deg) ${B}`),B.length>0&&(F.transform=B)}function _(T){if(T._canceled)return;const v=T._textDivs,N=T._capability;if(v.length>a){N.resolve();return}if(!T._isReadableStream)for(const y of v)T._layoutText(y);N.resolve()}class p{constructor({textContentSource:v,container:N,viewport:x,textDivs:y,textDivProperties:S,textContentItemsStr:D,isOffscreenCanvasSupported:F}){this._textContentSource=v,this._isReadableStream=v instanceof ReadableStream,this._container=this._rootContainer=N,this._textDivs=y||[],this._textContentItemsStr=D||[],this._isOffscreenCanvasSupported=F,this._fontInspectorEnabled=!!globalThis.FontInspector?.enabled,this._reader=null,this._textDivProperties=S||new WeakMap,this._canceled=!1,this._capability=new n.PromiseCapability,this._layoutTextParams={prevFontSize:null,prevFontFamily:null,div:null,scale:x.scale*(globalThis.devicePixelRatio||1),properties:null,ctx:c(0,F)};const{pageWidth:B,pageHeight:W,pageX:z,pageY:re}=x.rawDims;this._transform=[1,0,0,-1,-z,re+W],this._pageWidth=B,this._pageHeight=W,(0,r.setLayerDimensions)(N,x),this._capability.promise.finally(()=>{this._layoutTextParams=null}).catch(()=>{})}get promise(){return this._capability.promise}cancel(){this._canceled=!0,this._reader&&(this._reader.cancel(new n.AbortException("TextLayer task cancelled.")).catch(()=>{}),this._reader=null),this._capability.reject(new n.AbortException("TextLayer task cancelled."))}_processItems(v,N){for(const x of v){if(x.str===void 0){if(x.type==="beginMarkedContentProps"||x.type==="beginMarkedContent"){const y=this._container;this._container=document.createElement("span"),this._container.classList.add("markedContent"),x.id!==null&&this._container.setAttribute("id",`${x.id}`),y.append(this._container)}else x.type==="endMarkedContent"&&(this._container=this._container.parentNode);continue}this._textContentItemsStr.push(x.str),h(this,x,N)}}_layoutText(v){const N=this._layoutTextParams.properties=this._textDivProperties.get(v);if(this._layoutTextParams.div=v,m(this._layoutTextParams),N.hasText&&this._container.append(v),N.hasEOL){const x=document.createElement("br");x.setAttribute("role","presentation"),this._container.append(x)}}_render(){const v=new n.PromiseCapability;let N=Object.create(null);if(this._isReadableStream){const x=()=>{this._reader.read().then(({value:y,done:S})=>{if(S){v.resolve();return}Object.assign(N,y.styles),this._processItems(y.items,N),x()},v.reject)};this._reader=this._textContentSource.getReader(),x()}else if(this._textContentSource){const{items:x,styles:y}=this._textContentSource;this._processItems(x,y),v.resolve()}else throw new Error('No "textContentSource" parameter specified.');v.promise.then(()=>{N=null,_(this)},this._capability.reject)}}e.TextLayerRenderTask=p;function b(T){!T.textContentSource&&(T.textContent||T.textContentStream)&&((0,r.deprecated)("The TextLayerRender `textContent`/`textContentStream` parameters will be removed in the future, please use `textContentSource` instead."),T.textContentSource=T.textContent||T.textContentStream);const{container:v,viewport:N}=T,x=getComputedStyle(v),y=x.getPropertyValue("visibility"),S=parseFloat(x.getPropertyValue("--scale-factor"));y==="visible"&&(!S||Math.abs(S-N.scale)>1e-5)&&console.error("The `--scale-factor` CSS-variable must be set, to the same value as `viewport.scale`, either on the `container`-element itself or higher up in the DOM.");const D=new p(T);return D._render(),D}function A({container:T,viewport:v,textDivs:N,textDivProperties:x,isOffscreenCanvasSupported:y,mustRotate:S=!0,mustRescale:D=!0}){if(S&&(0,r.setLayerDimensions)(T,{rotation:v.rotation}),D){const F=c(0,y),W={prevFontSize:null,prevFontFamily:null,div:null,scale:v.scale*(globalThis.devicePixelRatio||1),properties:null,ctx:F};for(const z of N)W.properties=x.get(z),W.div=z,m(W)}}},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.AnnotationEditorLayer=void 0;var n=s(1),r=s(4),a=s(28),i=s(33),u=s(6),f=s(34);class c{#e;#t=!1;#s=null;#n=this.pointerup.bind(this);#i=this.pointerdown.bind(this);#o=new Map;#a=!1;#u=!1;#c=!1;#r;static _initialized=!1;constructor({uiManager:h,pageIndex:m,div:_,accessibilityManager:p,annotationLayer:b,viewport:A,l10n:T}){const v=[a.FreeTextEditor,i.InkEditor,f.StampEditor];if(!c._initialized){c._initialized=!0;for(const N of v)N.initialize(T)}h.registerEditorTypes(v),this.#r=h,this.pageIndex=m,this.div=_,this.#e=p,this.#s=b,this.viewport=A,this.#r.addLayer(this)}get isEmpty(){return this.#o.size===0}updateToolbar(h){this.#r.updateToolbar(h)}updateMode(h=this.#r.getMode()){this.#p(),h===n.AnnotationEditorType.INK?(this.addInkEditorIfNeeded(!1),this.disableClick()):this.enableClick(),h!==n.AnnotationEditorType.NONE&&(this.div.classList.toggle("freeTextEditing",h===n.AnnotationEditorType.FREETEXT),this.div.classList.toggle("inkEditing",h===n.AnnotationEditorType.INK),this.div.classList.toggle("stampEditing",h===n.AnnotationEditorType.STAMP),this.div.hidden=!1)}addInkEditorIfNeeded(h){if(!h&&this.#r.getMode()!==n.AnnotationEditorType.INK)return;if(!h){for(const _ of this.#o.values())if(_.isEmpty()){_.setInBackground();return}}this.#d({offsetX:0,offsetY:0},!1).setInBackground()}setEditingState(h){this.#r.setEditingState(h)}addCommands(h){this.#r.addCommands(h)}enable(){this.div.style.pointerEvents="auto";const h=new Set;for(const _ of this.#o.values())_.enableEditing(),_.annotationElementId&&h.add(_.annotationElementId);if(!this.#s)return;const m=this.#s.getEditableAnnotations();for(const _ of m){if(_.hide(),this.#r.isDeletedAnnotationElement(_.data.id)||h.has(_.data.id))continue;const p=this.deserialize(_);p&&(this.addOrRebuild(p),p.enableEditing())}}disable(){this.#c=!0,this.div.style.pointerEvents="none";const h=new Set;for(const m of this.#o.values()){if(m.disableEditing(),!m.annotationElementId||m.serialize()!==null){h.add(m.annotationElementId);continue}this.getEditableAnnotation(m.annotationElementId)?.show(),m.remove()}if(this.#s){const m=this.#s.getEditableAnnotations();for(const _ of m){const{id:p}=_.data;h.has(p)||this.#r.isDeletedAnnotationElement(p)||_.show()}}this.#p(),this.isEmpty&&(this.div.hidden=!0),this.#c=!1}getEditableAnnotation(h){return this.#s?.getEditableAnnotation(h)||null}setActiveEditor(h){this.#r.getActive()!==h&&this.#r.setActiveEditor(h)}enableClick(){this.div.addEventListener("pointerdown",this.#i),this.div.addEventListener("pointerup",this.#n)}disableClick(){this.div.removeEventListener("pointerdown",this.#i),this.div.removeEventListener("pointerup",this.#n)}attach(h){this.#o.set(h.id,h);const{annotationElementId:m}=h;m&&this.#r.isDeletedAnnotationElement(m)&&this.#r.removeDeletedAnnotationElement(h)}detach(h){this.#o.delete(h.id),this.#e?.removePointerInTextLayer(h.contentDiv),!this.#c&&h.annotationElementId&&this.#r.addDeletedAnnotationElement(h)}remove(h){this.detach(h),this.#r.removeEditor(h),h.div.contains(document.activeElement)&&setTimeout(()=>{this.#r.focusMainContainer()},0),h.div.remove(),h.isAttachedToDOM=!1,this.#u||this.addInkEditorIfNeeded(!1)}changeParent(h){h.parent!==this&&(h.annotationElementId&&(this.#r.addDeletedAnnotationElement(h.annotationElementId),r.AnnotationEditor.deleteAnnotationElement(h),h.annotationElementId=null),this.attach(h),h.parent?.detach(h),h.setParent(this),h.div&&h.isAttachedToDOM&&(h.div.remove(),this.div.append(h.div)))}add(h){if(this.changeParent(h),this.#r.addEditor(h),this.attach(h),!h.isAttachedToDOM){const m=h.render();this.div.append(m),h.isAttachedToDOM=!0}h.fixAndSetPosition(),h.onceAdded(),this.#r.addToAnnotationStorage(h)}moveEditorInDOM(h){if(!h.isAttachedToDOM)return;const{activeElement:m}=document;h.div.contains(m)&&(h._focusEventsAllowed=!1,setTimeout(()=>{h.div.contains(document.activeElement)?h._focusEventsAllowed=!0:(h.div.addEventListener("focusin",()=>{h._focusEventsAllowed=!0},{once:!0}),m.focus())},0)),h._structTreeParentId=this.#e?.moveElementInDOM(this.div,h.div,h.contentDiv,!0)}addOrRebuild(h){h.needsToBeRebuilt()?h.rebuild():this.add(h)}addUndoableEditor(h){const m=()=>h._uiManager.rebuild(h),_=()=>{h.remove()};this.addCommands({cmd:m,undo:_,mustExec:!1})}getNextId(){return this.#r.getId()}#f(h){switch(this.#r.getMode()){case n.AnnotationEditorType.FREETEXT:return new a.FreeTextEditor(h);case n.AnnotationEditorType.INK:return new i.InkEditor(h);case n.AnnotationEditorType.STAMP:return new f.StampEditor(h)}return null}pasteEditor(h,m){this.#r.updateToolbar(h),this.#r.updateMode(h);const{offsetX:_,offsetY:p}=this.#h(),b=this.getNextId(),A=this.#f({parent:this,id:b,x:_,y:p,uiManager:this.#r,isCentered:!0,...m});A&&this.add(A)}deserialize(h){switch(h.annotationType??h.annotationEditorType){case n.AnnotationEditorType.FREETEXT:return a.FreeTextEditor.deserialize(h,this,this.#r);case n.AnnotationEditorType.INK:return i.InkEditor.deserialize(h,this,this.#r);case n.AnnotationEditorType.STAMP:return f.StampEditor.deserialize(h,this,this.#r)}return null}#d(h,m){const _=this.getNextId(),p=this.#f({parent:this,id:_,x:h.offsetX,y:h.offsetY,uiManager:this.#r,isCentered:m});return p&&this.add(p),p}#h(){const{x:h,y:m,width:_,height:p}=this.div.getBoundingClientRect(),b=Math.max(0,h),A=Math.max(0,m),T=Math.min(window.innerWidth,h+_),v=Math.min(window.innerHeight,m+p),N=(b+T)/2-h,x=(A+v)/2-m,[y,S]=this.viewport.rotation%180===0?[N,x]:[x,N];return{offsetX:y,offsetY:S}}addNewEditor(){this.#d(this.#h(),!0)}setSelected(h){this.#r.setSelected(h)}toggleSelected(h){this.#r.toggleSelected(h)}isSelected(h){return this.#r.isSelected(h)}unselect(h){this.#r.unselect(h)}pointerup(h){const{isMac:m}=n.FeatureTest.platform;if(!(h.button!==0||h.ctrlKey&&m)&&h.target===this.div&&this.#a){if(this.#a=!1,!this.#t){this.#t=!0;return}if(this.#r.getMode()===n.AnnotationEditorType.STAMP){this.#r.unselectAll();return}this.#d(h,!1)}}pointerdown(h){if(this.#a){this.#a=!1;return}const{isMac:m}=n.FeatureTest.platform;if(h.button!==0||h.ctrlKey&&m||h.target!==this.div)return;this.#a=!0;const _=this.#r.getActive();this.#t=!_||_.isEmpty()}findNewParent(h,m,_){const p=this.#r.findParent(m,_);return p===null||p===this?!1:(p.changeParent(h),!0)}destroy(){this.#r.getActive()?.parent===this&&(this.#r.commitOrRemove(),this.#r.setActiveEditor(null));for(const h of this.#o.values())this.#e?.removePointerInTextLayer(h.contentDiv),h.setParent(null),h.isAttachedToDOM=!1,h.div.remove();this.div=null,this.#o.clear(),this.#r.removeLayer(this)}#p(){this.#u=!0;for(const h of this.#o.values())h.isEmpty()&&h.remove();this.#u=!1}render({viewport:h}){this.viewport=h,(0,u.setLayerDimensions)(this.div,h);for(const m of this.#r.getEditors(this.pageIndex))this.add(m);this.updateMode()}update({viewport:h}){this.#r.commitOrRemove(),this.viewport=h,(0,u.setLayerDimensions)(this.div,{rotation:h.rotation}),this.updateMode()}get pageDimensions(){const{pageWidth:h,pageHeight:m}=this.viewport.rawDims;return[h,m]}}e.AnnotationEditorLayer=c},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.FreeTextEditor=void 0;var n=s(1),r=s(5),a=s(4),i=s(29);class u extends a.AnnotationEditor{#e=this.editorDivBlur.bind(this);#t=this.editorDivFocus.bind(this);#s=this.editorDivInput.bind(this);#n=this.editorDivKeydown.bind(this);#i;#o="";#a=`${this.id}-editor`;#u;#c=null;static _freeTextDefaultContent="";static _internalPadding=0;static _defaultColor=null;static _defaultFontSize=10;static get _keyboardManager(){const c=u.prototype,d=_=>_.isEmpty(),h=r.AnnotationEditorUIManager.TRANSLATE_SMALL,m=r.AnnotationEditorUIManager.TRANSLATE_BIG;return(0,n.shadow)(this,"_keyboardManager",new r.KeyboardManager([[["ctrl+s","mac+meta+s","ctrl+p","mac+meta+p"],c.commitOrRemove,{bubbles:!0}],[["ctrl+Enter","mac+meta+Enter","Escape","mac+Escape"],c.commitOrRemove],[["ArrowLeft","mac+ArrowLeft"],c._translateEmpty,{args:[-h,0],checker:d}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],c._translateEmpty,{args:[-m,0],checker:d}],[["ArrowRight","mac+ArrowRight"],c._translateEmpty,{args:[h,0],checker:d}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],c._translateEmpty,{args:[m,0],checker:d}],[["ArrowUp","mac+ArrowUp"],c._translateEmpty,{args:[0,-h],checker:d}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],c._translateEmpty,{args:[0,-m],checker:d}],[["ArrowDown","mac+ArrowDown"],c._translateEmpty,{args:[0,h],checker:d}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],c._translateEmpty,{args:[0,m],checker:d}]]))}static _type="freetext";constructor(c){super({...c,name:"freeTextEditor"}),this.#i=c.color||u._defaultColor||a.AnnotationEditor._defaultLineColor,this.#u=c.fontSize||u._defaultFontSize}static initialize(c){a.AnnotationEditor.initialize(c,{strings:["free_text2_default_content","editor_free_text2_aria_label"]});const d=getComputedStyle(document.documentElement);this._internalPadding=parseFloat(d.getPropertyValue("--freetext-padding"))}static updateDefaultParams(c,d){switch(c){case n.AnnotationEditorParamsType.FREETEXT_SIZE:u._defaultFontSize=d;break;case n.AnnotationEditorParamsType.FREETEXT_COLOR:u._defaultColor=d;break}}updateParams(c,d){switch(c){case n.AnnotationEditorParamsType.FREETEXT_SIZE:this.#r(d);break;case n.AnnotationEditorParamsType.FREETEXT_COLOR:this.#f(d);break}}static get defaultPropertiesToUpdate(){return[[n.AnnotationEditorParamsType.FREETEXT_SIZE,u._defaultFontSize],[n.AnnotationEditorParamsType.FREETEXT_COLOR,u._defaultColor||a.AnnotationEditor._defaultLineColor]]}get propertiesToUpdate(){return[[n.AnnotationEditorParamsType.FREETEXT_SIZE,this.#u],[n.AnnotationEditorParamsType.FREETEXT_COLOR,this.#i]]}#r(c){const d=m=>{this.editorDiv.style.fontSize=`calc(${m}px * var(--scale-factor))`,this.translate(0,-(m-this.#u)*this.parentScale),this.#u=m,this.#h()},h=this.#u;this.addCommands({cmd:()=>{d(c)},undo:()=>{d(h)},mustExec:!0,type:n.AnnotationEditorParamsType.FREETEXT_SIZE,overwriteIfSameType:!0,keepUndo:!0})}#f(c){const d=this.#i;this.addCommands({cmd:()=>{this.#i=this.editorDiv.style.color=c},undo:()=>{this.#i=this.editorDiv.style.color=d},mustExec:!0,type:n.AnnotationEditorParamsType.FREETEXT_COLOR,overwriteIfSameType:!0,keepUndo:!0})}_translateEmpty(c,d){this._uiManager.translateSelectedEditors(c,d,!0)}getInitialTranslation(){const c=this.parentScale;return[-u._internalPadding*c,-(u._internalPadding+this.#u)*c]}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.isAttachedToDOM||this.parent.add(this)))}enableEditMode(){this.isInEditMode()||(this.parent.setEditingState(!1),this.parent.updateToolbar(n.AnnotationEditorType.FREETEXT),super.enableEditMode(),this.overlayDiv.classList.remove("enabled"),this.editorDiv.contentEditable=!0,this._isDraggable=!1,this.div.removeAttribute("aria-activedescendant"),this.editorDiv.addEventListener("keydown",this.#n),this.editorDiv.addEventListener("focus",this.#t),this.editorDiv.addEventListener("blur",this.#e),this.editorDiv.addEventListener("input",this.#s))}disableEditMode(){this.isInEditMode()&&(this.parent.setEditingState(!0),super.disableEditMode(),this.overlayDiv.classList.add("enabled"),this.editorDiv.contentEditable=!1,this.div.setAttribute("aria-activedescendant",this.#a),this._isDraggable=!0,this.editorDiv.removeEventListener("keydown",this.#n),this.editorDiv.removeEventListener("focus",this.#t),this.editorDiv.removeEventListener("blur",this.#e),this.editorDiv.removeEventListener("input",this.#s),this.div.focus({preventScroll:!0}),this.isEditing=!1,this.parent.div.classList.add("freeTextEditing"))}focusin(c){this._focusEventsAllowed&&(super.focusin(c),c.target!==this.editorDiv&&this.editorDiv.focus())}onceAdded(){if(this.width){this.#g();return}this.enableEditMode(),this.editorDiv.focus(),this._initialOptions?.isCentered&&this.center(),this._initialOptions=null}isEmpty(){return!this.editorDiv||this.editorDiv.innerText.trim()===""}remove(){this.isEditing=!1,this.parent&&(this.parent.setEditingState(!0),this.parent.div.classList.add("freeTextEditing")),super.remove()}#d(){const c=this.editorDiv.getElementsByTagName("div");if(c.length===0)return this.editorDiv.innerText;const d=[];for(const h of c)d.push(h.innerText.replace(/\r\n?|\n/,""));return d.join(`
`)}#h(){const[c,d]=this.parentDimensions;let h;if(this.isAttachedToDOM)h=this.div.getBoundingClientRect();else{const{currentLayer:m,div:_}=this,p=_.style.display;_.style.display="hidden",m.div.append(this.div),h=_.getBoundingClientRect(),_.remove(),_.style.display=p}this.rotation%180===this.parentRotation%180?(this.width=h.width/c,this.height=h.height/d):(this.width=h.height/c,this.height=h.width/d),this.fixAndSetPosition()}commit(){if(!this.isInEditMode())return;super.commit(),this.disableEditMode();const c=this.#o,d=this.#o=this.#d().trimEnd();if(c===d)return;const h=m=>{if(this.#o=m,!m){this.remove();return}this.#p(),this._uiManager.rebuild(this),this.#h()};this.addCommands({cmd:()=>{h(d)},undo:()=>{h(c)},mustExec:!1}),this.#h()}shouldGetKeyboardEvents(){return this.isInEditMode()}enterInEditMode(){this.enableEditMode(),this.editorDiv.focus()}dblclick(c){this.enterInEditMode()}keydown(c){c.target===this.div&&c.key==="Enter"&&(this.enterInEditMode(),c.preventDefault())}editorDivKeydown(c){u._keyboardManager.exec(this,c)}editorDivFocus(c){this.isEditing=!0}editorDivBlur(c){this.isEditing=!1}editorDivInput(c){this.parent.div.classList.toggle("freeTextEditing",this.isEmpty())}disableEditing(){this.editorDiv.setAttribute("role","comment"),this.editorDiv.removeAttribute("aria-multiline")}enableEditing(){this.editorDiv.setAttribute("role","textbox"),this.editorDiv.setAttribute("aria-multiline",!0)}render(){if(this.div)return this.div;let c,d;this.width&&(c=this.x,d=this.y),super.render(),this.editorDiv=document.createElement("div"),this.editorDiv.className="internal",this.editorDiv.setAttribute("id",this.#a),this.enableEditing(),a.AnnotationEditor._l10nPromise.get("editor_free_text2_aria_label").then(m=>this.editorDiv?.setAttribute("aria-label",m)),a.AnnotationEditor._l10nPromise.get("free_text2_default_content").then(m=>this.editorDiv?.setAttribute("default-content",m)),this.editorDiv.contentEditable=!0;const{style:h}=this.editorDiv;if(h.fontSize=`calc(${this.#u}px * var(--scale-factor))`,h.color=this.#i,this.div.append(this.editorDiv),this.overlayDiv=document.createElement("div"),this.overlayDiv.classList.add("overlay","enabled"),this.div.append(this.overlayDiv),(0,r.bindEvents)(this,this.div,["dblclick","keydown"]),this.width){const[m,_]=this.parentDimensions;if(this.annotationElementId){const{position:p}=this.#c;let[b,A]=this.getInitialTranslation();[b,A]=this.pageTranslationToScreen(b,A);const[T,v]=this.pageDimensions,[N,x]=this.pageTranslation;let y,S;switch(this.rotation){case 0:y=c+(p[0]-N)/T,S=d+this.height-(p[1]-x)/v;break;case 90:y=c+(p[0]-N)/T,S=d-(p[1]-x)/v,[b,A]=[A,-b];break;case 180:y=c-this.width+(p[0]-N)/T,S=d-(p[1]-x)/v,[b,A]=[-b,-A];break;case 270:y=c+(p[0]-N-this.height*v)/T,S=d+(p[1]-x-this.width*T)/v,[b,A]=[-A,b];break}this.setAt(y*m,S*_,b,A)}else this.setAt(c*m,d*_,this.width*m,this.height*_);this.#p(),this._isDraggable=!0,this.editorDiv.contentEditable=!1}else this._isDraggable=!1,this.editorDiv.contentEditable=!0;return this.div}#p(){if(this.editorDiv.replaceChildren(),!!this.#o)for(const c of this.#o.split(`
`)){const d=document.createElement("div");d.append(c?document.createTextNode(c):document.createElement("br")),this.editorDiv.append(d)}}get contentDiv(){return this.editorDiv}static deserialize(c,d,h){let m=null;if(c instanceof i.FreeTextAnnotationElement){const{data:{defaultAppearanceData:{fontSize:p,fontColor:b},rect:A,rotation:T,id:v},textContent:N,textPosition:x,parent:{page:{pageNumber:y}}}=c;if(!N||N.length===0)return null;m=c={annotationType:n.AnnotationEditorType.FREETEXT,color:Array.from(b),fontSize:p,value:N.join(`
`),position:x,pageIndex:y-1,rect:A,rotation:T,id:v,deleted:!1}}const _=super.deserialize(c,d,h);return _.#u=c.fontSize,_.#i=n.Util.makeHexColor(...c.color),_.#o=c.value,_.annotationElementId=c.id||null,_.#c=m,_}serialize(c=!1){if(this.isEmpty())return null;if(this.deleted)return{pageIndex:this.pageIndex,id:this.annotationElementId,deleted:!0};const d=u._internalPadding*this.parentScale,h=this.getRect(d,d),m=a.AnnotationEditor._colorManager.convert(this.isAttachedToDOM?getComputedStyle(this.editorDiv).color:this.#i),_={annotationType:n.AnnotationEditorType.FREETEXT,color:m,fontSize:this.#u,value:this.#o,pageIndex:this.pageIndex,rect:h,rotation:this.rotation,structTreeParentId:this._structTreeParentId};return c?_:this.annotationElementId&&!this.#_(_)?null:(_.id=this.annotationElementId,_)}#_(c){const{value:d,fontSize:h,color:m,rect:_,pageIndex:p}=this.#c;return c.value!==d||c.fontSize!==h||c.rect.some((b,A)=>Math.abs(b-_[A])>=1)||c.color.some((b,A)=>b!==m[A])||c.pageIndex!==p}#g(c=!1){if(!this.annotationElementId)return;if(this.#h(),!c&&(this.width===0||this.height===0)){setTimeout(()=>this.#g(!0),0);return}const d=u._internalPadding*this.parentScale;this.#c.rect=this.getRect(d,d)}}e.FreeTextEditor=u},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.StampAnnotationElement=e.InkAnnotationElement=e.FreeTextAnnotationElement=e.AnnotationLayer=void 0;var n=s(1),r=s(6),a=s(3),i=s(30),u=s(31),f=s(32);const c=1e3,d=9,h=new WeakSet;function m(M){return{width:M[2]-M[0],height:M[3]-M[1]}}class _{static create(E){switch(E.data.annotationType){case n.AnnotationType.LINK:return new b(E);case n.AnnotationType.TEXT:return new A(E);case n.AnnotationType.WIDGET:switch(E.data.fieldType){case"Tx":return new v(E);case"Btn":return E.data.radioButton?new y(E):E.data.checkBox?new x(E):new S(E);case"Ch":return new D(E);case"Sig":return new N(E)}return new T(E);case n.AnnotationType.POPUP:return new F(E);case n.AnnotationType.FREETEXT:return new W(E);case n.AnnotationType.LINE:return new z(E);case n.AnnotationType.SQUARE:return new re(E);case n.AnnotationType.CIRCLE:return new X(E);case n.AnnotationType.POLYLINE:return new ne(E);case n.AnnotationType.CARET:return new te(E);case n.AnnotationType.INK:return new H(E);case n.AnnotationType.POLYGON:return new ie(E);case n.AnnotationType.HIGHLIGHT:return new P(E);case n.AnnotationType.UNDERLINE:return new C(E);case n.AnnotationType.SQUIGGLY:return new I(E);case n.AnnotationType.STRIKEOUT:return new R(E);case n.AnnotationType.STAMP:return new L(E);case n.AnnotationType.FILEATTACHMENT:return new G(E);default:return new p(E)}}}class p{#e=!1;constructor(E,{isRenderable:w=!1,ignoreBorder:O=!1,createQuadrilaterals:k=!1}={}){this.isRenderable=w,this.data=E.data,this.layer=E.layer,this.linkService=E.linkService,this.downloadManager=E.downloadManager,this.imageResourcesPath=E.imageResourcesPath,this.renderForms=E.renderForms,this.svgFactory=E.svgFactory,this.annotationStorage=E.annotationStorage,this.enableScripting=E.enableScripting,this.hasJSActions=E.hasJSActions,this._fieldObjects=E.fieldObjects,this.parent=E.parent,w&&(this.container=this._createContainer(O)),k&&this._createQuadrilaterals()}static _hasPopupData({titleObj:E,contentsObj:w,richText:O}){return!!(E?.str||w?.str||O?.str)}get hasPopupData(){return p._hasPopupData(this.data)}_createContainer(E){const{data:w,parent:{page:O,viewport:k}}=this,U=document.createElement("section");U.setAttribute("data-annotation-id",w.id),this instanceof T||(U.tabIndex=c),U.style.zIndex=this.parent.zIndex++,this.data.popupRef&&U.setAttribute("aria-haspopup","dialog"),w.noRotate&&U.classList.add("norotate");const{pageWidth:q,pageHeight:V,pageX:K,pageY:ue}=k.rawDims;if(!w.rect||this instanceof F){const{rotation:ae}=w;return!w.hasOwnCanvas&&ae!==0&&this.setRotation(ae,U),U}const{width:Q,height:J}=m(w.rect),ee=n.Util.normalizeRect([w.rect[0],O.view[3]-w.rect[1]+O.view[1],w.rect[2],O.view[3]-w.rect[3]+O.view[1]]);if(!E&&w.borderStyle.width>0){U.style.borderWidth=`${w.borderStyle.width}px`;const ae=w.borderStyle.horizontalCornerRadius,ce=w.borderStyle.verticalCornerRadius;if(ae>0||ce>0){const he=`calc(${ae}px * var(--scale-factor)) / calc(${ce}px * var(--scale-factor))`;U.style.borderRadius=he}else if(this instanceof y){const he=`calc(${Q}px * var(--scale-factor)) / calc(${J}px * var(--scale-factor))`;U.style.borderRadius=he}switch(w.borderStyle.style){case n.AnnotationBorderStyleType.SOLID:U.style.borderStyle="solid";break;case n.AnnotationBorderStyleType.DASHED:U.style.borderStyle="dashed";break;case n.AnnotationBorderStyleType.BEVELED:(0,n.warn)("Unimplemented border style: beveled");break;case n.AnnotationBorderStyleType.INSET:(0,n.warn)("Unimplemented border style: inset");break;case n.AnnotationBorderStyleType.UNDERLINE:U.style.borderBottomStyle="solid";break}const de=w.borderColor||null;de?(this.#e=!0,U.style.borderColor=n.Util.makeHexColor(de[0]|0,de[1]|0,de[2]|0)):U.style.borderWidth=0}U.style.left=`${100*(ee[0]-K)/q}%`,U.style.top=`${100*(ee[1]-ue)/V}%`;const{rotation:se}=w;return w.hasOwnCanvas||se===0?(U.style.width=`${100*Q/q}%`,U.style.height=`${100*J/V}%`):this.setRotation(se,U),U}setRotation(E,w=this.container){if(!this.data.rect)return;const{pageWidth:O,pageHeight:k}=this.parent.viewport.rawDims,{width:U,height:q}=m(this.data.rect);let V,K;E%180===0?(V=100*U/O,K=100*q/k):(V=100*q/O,K=100*U/k),w.style.width=`${V}%`,w.style.height=`${K}%`,w.setAttribute("data-main-rotation",(360-E)%360)}get _commonActions(){const E=(w,O,k)=>{const U=k.detail[w],q=U[0],V=U.slice(1);k.target.style[O]=i.ColorConverters[`${q}_HTML`](V),this.annotationStorage.setValue(this.data.id,{[O]:i.ColorConverters[`${q}_rgb`](V)})};return(0,n.shadow)(this,"_commonActions",{display:w=>{const{display:O}=w.detail,k=O%2===1;this.container.style.visibility=k?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noView:k,noPrint:O===1||O===2})},print:w=>{this.annotationStorage.setValue(this.data.id,{noPrint:!w.detail.print})},hidden:w=>{const{hidden:O}=w.detail;this.container.style.visibility=O?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noPrint:O,noView:O})},focus:w=>{setTimeout(()=>w.target.focus({preventScroll:!1}),0)},userName:w=>{w.target.title=w.detail.userName},readonly:w=>{w.target.disabled=w.detail.readonly},required:w=>{this._setRequired(w.target,w.detail.required)},bgColor:w=>{E("bgColor","backgroundColor",w)},fillColor:w=>{E("fillColor","backgroundColor",w)},fgColor:w=>{E("fgColor","color",w)},textColor:w=>{E("textColor","color",w)},borderColor:w=>{E("borderColor","borderColor",w)},strokeColor:w=>{E("strokeColor","borderColor",w)},rotation:w=>{const O=w.detail.rotation;this.setRotation(O),this.annotationStorage.setValue(this.data.id,{rotation:O})}})}_dispatchEventFromSandbox(E,w){const O=this._commonActions;for(const k of Object.keys(w.detail))(E[k]||O[k])?.(w)}_setDefaultPropertiesFromJS(E){if(!this.enableScripting)return;const w=this.annotationStorage.getRawValue(this.data.id);if(!w)return;const O=this._commonActions;for(const[k,U]of Object.entries(w)){const q=O[k];if(q){const V={detail:{[k]:U},target:E};q(V),delete w[k]}}}_createQuadrilaterals(){if(!this.container)return;const{quadPoints:E}=this.data;if(!E)return;const[w,O,k,U]=this.data.rect;if(E.length===1){const[,{x:ce,y:de},{x:he,y:fe}]=E[0];if(k===ce&&U===de&&w===he&&O===fe)return}const{style:q}=this.container;let V;if(this.#e){const{borderColor:ce,borderWidth:de}=q;q.borderWidth=0,V=["url('data:image/svg+xml;utf8,",'<svg xmlns="http://www.w3.org/2000/svg"',' preserveAspectRatio="none" viewBox="0 0 1 1">',`<g fill="transparent" stroke="${ce}" stroke-width="${de}">`],this.container.classList.add("hasBorder")}const K=k-w,ue=U-O,{svgFactory:Q}=this,J=Q.createElement("svg");J.classList.add("quadrilateralsContainer"),J.setAttribute("width",0),J.setAttribute("height",0);const ee=Q.createElement("defs");J.append(ee);const se=Q.createElement("clipPath"),ae=`clippath_${this.data.id}`;se.setAttribute("id",ae),se.setAttribute("clipPathUnits","objectBoundingBox"),ee.append(se);for(const[,{x:ce,y:de},{x:he,y:fe}]of E){const pe=Q.createElement("rect"),ge=(he-w)/K,Se=(U-de)/ue,Ae=(ce-he)/K,Pe=(de-fe)/ue;pe.setAttribute("x",ge),pe.setAttribute("y",Se),pe.setAttribute("width",Ae),pe.setAttribute("height",Pe),se.append(pe),V?.push(`<rect vector-effect="non-scaling-stroke" x="${ge}" y="${Se}" width="${Ae}" height="${Pe}"/>`)}this.#e&&(V.push("</g></svg>')"),q.backgroundImage=V.join("")),this.container.append(J),this.container.style.clipPath=`url(#${ae})`}_createPopup(){const{container:E,data:w}=this;E.setAttribute("aria-haspopup","dialog");const O=new F({data:{color:w.color,titleObj:w.titleObj,modificationDate:w.modificationDate,contentsObj:w.contentsObj,richText:w.richText,parentRect:w.rect,borderStyle:0,id:`popup_${w.id}`,rotation:w.rotation},parent:this.parent,elements:[this]});this.parent.div.append(O.render())}render(){(0,n.unreachable)("Abstract method `AnnotationElement.render` called")}_getElementsByName(E,w=null){const O=[];if(this._fieldObjects){const k=this._fieldObjects[E];if(k)for(const{page:U,id:q,exportValues:V}of k){if(U===-1||q===w)continue;const K=typeof V=="string"?V:null,ue=document.querySelector(`[data-element-id="${q}"]`);if(ue&&!h.has(ue)){(0,n.warn)(`_getElementsByName - element not allowed: ${q}`);continue}O.push({id:q,exportValue:K,domElement:ue})}return O}for(const k of document.getElementsByName(E)){const{exportValue:U}=k,q=k.getAttribute("data-element-id");q!==w&&h.has(k)&&O.push({id:q,exportValue:U,domElement:k})}return O}show(){this.container&&(this.container.hidden=!1),this.popup?.maybeShow()}hide(){this.container&&(this.container.hidden=!0),this.popup?.forceHide()}getElementsToTriggerPopup(){return this.container}addHighlightArea(){const E=this.getElementsToTriggerPopup();if(Array.isArray(E))for(const w of E)w.classList.add("highlightArea");else E.classList.add("highlightArea")}_editOnDoubleClick(){const{annotationEditorType:E,data:{id:w}}=this;this.container.addEventListener("dblclick",()=>{this.linkService.eventBus?.dispatch("switchannotationeditormode",{source:this,mode:E,editId:w})})}}class b extends p{constructor(E,w=null){super(E,{isRenderable:!0,ignoreBorder:!!w?.ignoreBorder,createQuadrilaterals:!0}),this.isTooltipOnly=E.data.isTooltipOnly}render(){const{data:E,linkService:w}=this,O=document.createElement("a");O.setAttribute("data-element-id",E.id);let k=!1;return E.url?(w.addLinkAttributes(O,E.url,E.newWindow),k=!0):E.action?(this._bindNamedAction(O,E.action),k=!0):E.attachment?(this._bindAttachment(O,E.attachment),k=!0):E.setOCGState?(this.#t(O,E.setOCGState),k=!0):E.dest?(this._bindLink(O,E.dest),k=!0):(E.actions&&(E.actions.Action||E.actions["Mouse Up"]||E.actions["Mouse Down"])&&this.enableScripting&&this.hasJSActions&&(this._bindJSAction(O,E),k=!0),E.resetForm?(this._bindResetFormAction(O,E.resetForm),k=!0):this.isTooltipOnly&&!k&&(this._bindLink(O,""),k=!0)),this.container.classList.add("linkAnnotation"),k&&this.container.append(O),this.container}#e(){this.container.setAttribute("data-internal-link","")}_bindLink(E,w){E.href=this.linkService.getDestinationHash(w),E.onclick=()=>(w&&this.linkService.goToDestination(w),!1),(w||w==="")&&this.#e()}_bindNamedAction(E,w){E.href=this.linkService.getAnchorUrl(""),E.onclick=()=>(this.linkService.executeNamedAction(w),!1),this.#e()}_bindAttachment(E,w){E.href=this.linkService.getAnchorUrl(""),E.onclick=()=>(this.downloadManager?.openOrDownloadData(this.container,w.content,w.filename),!1),this.#e()}#t(E,w){E.href=this.linkService.getAnchorUrl(""),E.onclick=()=>(this.linkService.executeSetOCGState(w),!1),this.#e()}_bindJSAction(E,w){E.href=this.linkService.getAnchorUrl("");const O=new Map([["Action","onclick"],["Mouse Up","onmouseup"],["Mouse Down","onmousedown"]]);for(const k of Object.keys(w.actions)){const U=O.get(k);U&&(E[U]=()=>(this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:w.id,name:k}}),!1))}E.onclick||(E.onclick=()=>!1),this.#e()}_bindResetFormAction(E,w){const O=E.onclick;if(O||(E.href=this.linkService.getAnchorUrl("")),this.#e(),!this._fieldObjects){(0,n.warn)('_bindResetFormAction - "resetForm" action not supported, ensure that the `fieldObjects` parameter is provided.'),O||(E.onclick=()=>!1);return}E.onclick=()=>{O?.();const{fields:k,refs:U,include:q}=w,V=[];if(k.length!==0||U.length!==0){const Q=new Set(U);for(const J of k){const ee=this._fieldObjects[J]||[];for(const{id:se}of ee)Q.add(se)}for(const J of Object.values(this._fieldObjects))for(const ee of J)Q.has(ee.id)===q&&V.push(ee)}else for(const Q of Object.values(this._fieldObjects))V.push(...Q);const K=this.annotationStorage,ue=[];for(const Q of V){const{id:J}=Q;switch(ue.push(J),Q.type){case"text":{const se=Q.defaultValue||"";K.setValue(J,{value:se});break}case"checkbox":case"radiobutton":{const se=Q.defaultValue===Q.exportValues;K.setValue(J,{value:se});break}case"combobox":case"listbox":{const se=Q.defaultValue||"";K.setValue(J,{value:se});break}default:continue}const ee=document.querySelector(`[data-element-id="${J}"]`);if(ee){if(!h.has(ee)){(0,n.warn)(`_bindResetFormAction - element not allowed: ${J}`);continue}}else continue;ee.dispatchEvent(new Event("resetform"))}return this.enableScripting&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:"app",ids:ue,name:"ResetForm"}}),!1}}}class A extends p{constructor(E){super(E,{isRenderable:!0})}render(){this.container.classList.add("textAnnotation");const E=document.createElement("img");return E.src=this.imageResourcesPath+"annotation-"+this.data.name.toLowerCase()+".svg",E.alt="[{{type}} Annotation]",E.dataset.l10nId="text_annotation_type",E.dataset.l10nArgs=JSON.stringify({type:this.data.name}),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.append(E),this.container}}class T extends p{render(){return this.data.alternativeText&&(this.container.title=this.data.alternativeText),this.container}showElementAndHideCanvas(E){this.data.hasOwnCanvas&&(E.previousSibling?.nodeName==="CANVAS"&&(E.previousSibling.hidden=!0),E.hidden=!1)}_getKeyModifier(E){const{isWin:w,isMac:O}=n.FeatureTest.platform;return w&&E.ctrlKey||O&&E.metaKey}_setEventListener(E,w,O,k,U){O.includes("mouse")?E.addEventListener(O,q=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:k,value:U(q),shift:q.shiftKey,modifier:this._getKeyModifier(q)}})}):E.addEventListener(O,q=>{if(O==="blur"){if(!w.focused||!q.relatedTarget)return;w.focused=!1}else if(O==="focus"){if(w.focused)return;w.focused=!0}U&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:k,value:U(q)}})})}_setEventListeners(E,w,O,k){for(const[U,q]of O)(q==="Action"||this.data.actions?.[q])&&((q==="Focus"||q==="Blur")&&(w||={focused:!1}),this._setEventListener(E,w,U,q,k),q==="Focus"&&!this.data.actions?.Blur?this._setEventListener(E,w,"blur","Blur",null):q==="Blur"&&!this.data.actions?.Focus&&this._setEventListener(E,w,"focus","Focus",null))}_setBackgroundColor(E){const w=this.data.backgroundColor||null;E.style.backgroundColor=w===null?"transparent":n.Util.makeHexColor(w[0],w[1],w[2])}_setTextStyle(E){const w=["left","center","right"],{fontColor:O}=this.data.defaultAppearanceData,k=this.data.defaultAppearanceData.fontSize||d,U=E.style;let q;const V=2,K=ue=>Math.round(10*ue)/10;if(this.data.multiLine){const ue=Math.abs(this.data.rect[3]-this.data.rect[1]-V),Q=Math.round(ue/(n.LINE_FACTOR*k))||1,J=ue/Q;q=Math.min(k,K(J/n.LINE_FACTOR))}else{const ue=Math.abs(this.data.rect[3]-this.data.rect[1]-V);q=Math.min(k,K(ue/n.LINE_FACTOR))}U.fontSize=`calc(${q}px * var(--scale-factor))`,U.color=n.Util.makeHexColor(O[0],O[1],O[2]),this.data.textAlignment!==null&&(U.textAlign=w[this.data.textAlignment])}_setRequired(E,w){w?E.setAttribute("required",!0):E.removeAttribute("required"),E.setAttribute("aria-required",w)}}class v extends T{constructor(E){const w=E.renderForms||!E.data.hasAppearance&&!!E.data.fieldValue;super(E,{isRenderable:w})}setPropertyOnSiblings(E,w,O,k){const U=this.annotationStorage;for(const q of this._getElementsByName(E.name,E.id))q.domElement&&(q.domElement[w]=O),U.setValue(q.id,{[k]:O})}render(){const E=this.annotationStorage,w=this.data.id;this.container.classList.add("textWidgetAnnotation");let O=null;if(this.renderForms){const k=E.getValue(w,{value:this.data.fieldValue});let U=k.value||"";const q=E.getValue(w,{charLimit:this.data.maxLen}).charLimit;q&&U.length>q&&(U=U.slice(0,q));let V=k.formattedValue||this.data.textContent?.join(`
`)||null;V&&this.data.comb&&(V=V.replaceAll(/\s+/g,""));const K={userValue:U,formattedValue:V,lastCommittedValue:null,commitKey:1,focused:!1};this.data.multiLine?(O=document.createElement("textarea"),O.textContent=V??U,this.data.doNotScroll&&(O.style.overflowY="hidden")):(O=document.createElement("input"),O.type="text",O.setAttribute("value",V??U),this.data.doNotScroll&&(O.style.overflowX="hidden")),this.data.hasOwnCanvas&&(O.hidden=!0),h.add(O),O.setAttribute("data-element-id",w),O.disabled=this.data.readOnly,O.name=this.data.fieldName,O.tabIndex=c,this._setRequired(O,this.data.required),q&&(O.maxLength=q),O.addEventListener("input",Q=>{E.setValue(w,{value:Q.target.value}),this.setPropertyOnSiblings(O,"value",Q.target.value,"value"),K.formattedValue=null}),O.addEventListener("resetform",Q=>{const J=this.data.defaultFieldValue??"";O.value=K.userValue=J,K.formattedValue=null});let ue=Q=>{const{formattedValue:J}=K;J!=null&&(Q.target.value=J),Q.target.scrollLeft=0};if(this.enableScripting&&this.hasJSActions){O.addEventListener("focus",J=>{if(K.focused)return;const{target:ee}=J;K.userValue&&(ee.value=K.userValue),K.lastCommittedValue=ee.value,K.commitKey=1,K.focused=!0}),O.addEventListener("updatefromsandbox",J=>{this.showElementAndHideCanvas(J.target);const ee={value(se){K.userValue=se.detail.value??"",E.setValue(w,{value:K.userValue.toString()}),se.target.value=K.userValue},formattedValue(se){const{formattedValue:ae}=se.detail;K.formattedValue=ae,ae!=null&&se.target!==document.activeElement&&(se.target.value=ae),E.setValue(w,{formattedValue:ae})},selRange(se){se.target.setSelectionRange(...se.detail.selRange)},charLimit:se=>{const{charLimit:ae}=se.detail,{target:ce}=se;if(ae===0){ce.removeAttribute("maxLength");return}ce.setAttribute("maxLength",ae);let de=K.userValue;!de||de.length<=ae||(de=de.slice(0,ae),ce.value=K.userValue=de,E.setValue(w,{value:de}),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:w,name:"Keystroke",value:de,willCommit:!0,commitKey:1,selStart:ce.selectionStart,selEnd:ce.selectionEnd}}))}};this._dispatchEventFromSandbox(ee,J)}),O.addEventListener("keydown",J=>{K.commitKey=1;let ee=-1;if(J.key==="Escape"?ee=0:J.key==="Enter"&&!this.data.multiLine?ee=2:J.key==="Tab"&&(K.commitKey=3),ee===-1)return;const{value:se}=J.target;K.lastCommittedValue!==se&&(K.lastCommittedValue=se,K.userValue=se,this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:w,name:"Keystroke",value:se,willCommit:!0,commitKey:ee,selStart:J.target.selectionStart,selEnd:J.target.selectionEnd}}))});const Q=ue;ue=null,O.addEventListener("blur",J=>{if(!K.focused||!J.relatedTarget)return;K.focused=!1;const{value:ee}=J.target;K.userValue=ee,K.lastCommittedValue!==ee&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:w,name:"Keystroke",value:ee,willCommit:!0,commitKey:K.commitKey,selStart:J.target.selectionStart,selEnd:J.target.selectionEnd}}),Q(J)}),this.data.actions?.Keystroke&&O.addEventListener("beforeinput",J=>{K.lastCommittedValue=null;const{data:ee,target:se}=J,{value:ae,selectionStart:ce,selectionEnd:de}=se;let he=ce,fe=de;switch(J.inputType){case"deleteWordBackward":{const pe=ae.substring(0,ce).match(/\w*[^\w]*$/);pe&&(he-=pe[0].length);break}case"deleteWordForward":{const pe=ae.substring(ce).match(/^[^\w]*\w*/);pe&&(fe+=pe[0].length);break}case"deleteContentBackward":ce===de&&(he-=1);break;case"deleteContentForward":ce===de&&(fe+=1);break}J.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:w,name:"Keystroke",value:ae,change:ee||"",willCommit:!1,selStart:he,selEnd:fe}})}),this._setEventListeners(O,K,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],J=>J.target.value)}if(ue&&O.addEventListener("blur",ue),this.data.comb){const J=(this.data.rect[2]-this.data.rect[0])/q;O.classList.add("comb"),O.style.letterSpacing=`calc(${J}px * var(--scale-factor) - 1ch)`}}else O=document.createElement("div"),O.textContent=this.data.fieldValue,O.style.verticalAlign="middle",O.style.display="table-cell";return this._setTextStyle(O),this._setBackgroundColor(O),this._setDefaultPropertiesFromJS(O),this.container.append(O),this.container}}class N extends T{constructor(E){super(E,{isRenderable:!!E.data.hasOwnCanvas})}}class x extends T{constructor(E){super(E,{isRenderable:E.renderForms})}render(){const E=this.annotationStorage,w=this.data,O=w.id;let k=E.getValue(O,{value:w.exportValue===w.fieldValue}).value;typeof k=="string"&&(k=k!=="Off",E.setValue(O,{value:k})),this.container.classList.add("buttonWidgetAnnotation","checkBox");const U=document.createElement("input");return h.add(U),U.setAttribute("data-element-id",O),U.disabled=w.readOnly,this._setRequired(U,this.data.required),U.type="checkbox",U.name=w.fieldName,k&&U.setAttribute("checked",!0),U.setAttribute("exportValue",w.exportValue),U.tabIndex=c,U.addEventListener("change",q=>{const{name:V,checked:K}=q.target;for(const ue of this._getElementsByName(V,O)){const Q=K&&ue.exportValue===w.exportValue;ue.domElement&&(ue.domElement.checked=Q),E.setValue(ue.id,{value:Q})}E.setValue(O,{value:K})}),U.addEventListener("resetform",q=>{const V=w.defaultFieldValue||"Off";q.target.checked=V===w.exportValue}),this.enableScripting&&this.hasJSActions&&(U.addEventListener("updatefromsandbox",q=>{const V={value(K){K.target.checked=K.detail.value!=="Off",E.setValue(O,{value:K.target.checked})}};this._dispatchEventFromSandbox(V,q)}),this._setEventListeners(U,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],q=>q.target.checked)),this._setBackgroundColor(U),this._setDefaultPropertiesFromJS(U),this.container.append(U),this.container}}class y extends T{constructor(E){super(E,{isRenderable:E.renderForms})}render(){this.container.classList.add("buttonWidgetAnnotation","radioButton");const E=this.annotationStorage,w=this.data,O=w.id;let k=E.getValue(O,{value:w.fieldValue===w.buttonValue}).value;typeof k=="string"&&(k=k!==w.buttonValue,E.setValue(O,{value:k}));const U=document.createElement("input");if(h.add(U),U.setAttribute("data-element-id",O),U.disabled=w.readOnly,this._setRequired(U,this.data.required),U.type="radio",U.name=w.fieldName,k&&U.setAttribute("checked",!0),U.tabIndex=c,U.addEventListener("change",q=>{const{name:V,checked:K}=q.target;for(const ue of this._getElementsByName(V,O))E.setValue(ue.id,{value:!1});E.setValue(O,{value:K})}),U.addEventListener("resetform",q=>{const V=w.defaultFieldValue;q.target.checked=V!=null&&V===w.buttonValue}),this.enableScripting&&this.hasJSActions){const q=w.buttonValue;U.addEventListener("updatefromsandbox",V=>{const K={value:ue=>{const Q=q===ue.detail.value;for(const J of this._getElementsByName(ue.target.name)){const ee=Q&&J.id===O;J.domElement&&(J.domElement.checked=ee),E.setValue(J.id,{value:ee})}}};this._dispatchEventFromSandbox(K,V)}),this._setEventListeners(U,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],V=>V.target.checked)}return this._setBackgroundColor(U),this._setDefaultPropertiesFromJS(U),this.container.append(U),this.container}}class S extends b{constructor(E){super(E,{ignoreBorder:E.data.hasAppearance})}render(){const E=super.render();E.classList.add("buttonWidgetAnnotation","pushButton"),this.data.alternativeText&&(E.title=this.data.alternativeText);const w=E.lastChild;return this.enableScripting&&this.hasJSActions&&w&&(this._setDefaultPropertiesFromJS(w),w.addEventListener("updatefromsandbox",O=>{this._dispatchEventFromSandbox({},O)})),E}}class D extends T{constructor(E){super(E,{isRenderable:E.renderForms})}render(){this.container.classList.add("choiceWidgetAnnotation");const E=this.annotationStorage,w=this.data.id,O=E.getValue(w,{value:this.data.fieldValue}),k=document.createElement("select");h.add(k),k.setAttribute("data-element-id",w),k.disabled=this.data.readOnly,this._setRequired(k,this.data.required),k.name=this.data.fieldName,k.tabIndex=c;let U=this.data.combo&&this.data.options.length>0;this.data.combo||(k.size=this.data.options.length,this.data.multiSelect&&(k.multiple=!0)),k.addEventListener("resetform",Q=>{const J=this.data.defaultFieldValue;for(const ee of k.options)ee.selected=ee.value===J});for(const Q of this.data.options){const J=document.createElement("option");J.textContent=Q.displayValue,J.value=Q.exportValue,O.value.includes(Q.exportValue)&&(J.setAttribute("selected",!0),U=!1),k.append(J)}let q=null;if(U){const Q=document.createElement("option");Q.value=" ",Q.setAttribute("hidden",!0),Q.setAttribute("selected",!0),k.prepend(Q),q=()=>{Q.remove(),k.removeEventListener("input",q),q=null},k.addEventListener("input",q)}const V=Q=>{const J=Q?"value":"textContent",{options:ee,multiple:se}=k;return se?Array.prototype.filter.call(ee,ae=>ae.selected).map(ae=>ae[J]):ee.selectedIndex===-1?null:ee[ee.selectedIndex][J]};let K=V(!1);const ue=Q=>{const J=Q.target.options;return Array.prototype.map.call(J,ee=>({displayValue:ee.textContent,exportValue:ee.value}))};return this.enableScripting&&this.hasJSActions?(k.addEventListener("updatefromsandbox",Q=>{const J={value(ee){q?.();const se=ee.detail.value,ae=new Set(Array.isArray(se)?se:[se]);for(const ce of k.options)ce.selected=ae.has(ce.value);E.setValue(w,{value:V(!0)}),K=V(!1)},multipleSelection(ee){k.multiple=!0},remove(ee){const se=k.options,ae=ee.detail.remove;se[ae].selected=!1,k.remove(ae),se.length>0&&Array.prototype.findIndex.call(se,de=>de.selected)===-1&&(se[0].selected=!0),E.setValue(w,{value:V(!0),items:ue(ee)}),K=V(!1)},clear(ee){for(;k.length!==0;)k.remove(0);E.setValue(w,{value:null,items:[]}),K=V(!1)},insert(ee){const{index:se,displayValue:ae,exportValue:ce}=ee.detail.insert,de=k.children[se],he=document.createElement("option");he.textContent=ae,he.value=ce,de?de.before(he):k.append(he),E.setValue(w,{value:V(!0),items:ue(ee)}),K=V(!1)},items(ee){const{items:se}=ee.detail;for(;k.length!==0;)k.remove(0);for(const ae of se){const{displayValue:ce,exportValue:de}=ae,he=document.createElement("option");he.textContent=ce,he.value=de,k.append(he)}k.options.length>0&&(k.options[0].selected=!0),E.setValue(w,{value:V(!0),items:ue(ee)}),K=V(!1)},indices(ee){const se=new Set(ee.detail.indices);for(const ae of ee.target.options)ae.selected=se.has(ae.index);E.setValue(w,{value:V(!0)}),K=V(!1)},editable(ee){ee.target.disabled=!ee.detail.editable}};this._dispatchEventFromSandbox(J,Q)}),k.addEventListener("input",Q=>{const J=V(!0);E.setValue(w,{value:J}),Q.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:w,name:"Keystroke",value:K,changeEx:J,willCommit:!1,commitKey:1,keyDown:!1}})}),this._setEventListeners(k,null,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"],["input","Action"],["input","Validate"]],Q=>Q.target.value)):k.addEventListener("input",function(Q){E.setValue(w,{value:V(!0)})}),this.data.combo&&this._setTextStyle(k),this._setBackgroundColor(k),this._setDefaultPropertiesFromJS(k),this.container.append(k),this.container}}class F extends p{constructor(E){const{data:w,elements:O}=E;super(E,{isRenderable:p._hasPopupData(w)}),this.elements=O}render(){this.container.classList.add("popupAnnotation");const E=new B({container:this.container,color:this.data.color,titleObj:this.data.titleObj,modificationDate:this.data.modificationDate,contentsObj:this.data.contentsObj,richText:this.data.richText,rect:this.data.rect,parentRect:this.data.parentRect||null,parent:this.parent,elements:this.elements,open:this.data.open}),w=[];for(const O of this.elements)O.popup=E,w.push(O.data.id),O.addHighlightArea();return this.container.setAttribute("aria-controls",w.map(O=>`${n.AnnotationPrefix}${O}`).join(",")),this.container}}class B{#e=null;#t=this.#l.bind(this);#s=this.#y.bind(this);#n=this.#S.bind(this);#i=this.#b.bind(this);#o=null;#a=null;#u=null;#c=null;#r=null;#f=null;#d=!1;#h=null;#p=null;#_=null;#g=null;#m=!1;constructor({container:E,color:w,elements:O,titleObj:k,modificationDate:U,contentsObj:q,richText:V,parent:K,rect:ue,parentRect:Q,open:J}){this.#a=E,this.#g=k,this.#u=q,this.#_=V,this.#r=K,this.#o=w,this.#p=ue,this.#f=Q,this.#c=O;const ee=r.PDFDateString.toDateObject(U);ee&&(this.#e=K.l10n.get("annotation_date_string",{date:ee.toLocaleDateString(),time:ee.toLocaleTimeString()})),this.trigger=O.flatMap(se=>se.getElementsToTriggerPopup());for(const se of this.trigger)se.addEventListener("click",this.#i),se.addEventListener("mouseenter",this.#n),se.addEventListener("mouseleave",this.#s),se.classList.add("popupTriggerArea");for(const se of O)se.container?.addEventListener("keydown",this.#t);this.#a.hidden=!0,J&&this.#b()}render(){if(this.#h)return;const{page:{view:E},viewport:{rawDims:{pageWidth:w,pageHeight:O,pageX:k,pageY:U}}}=this.#r,q=this.#h=document.createElement("div");if(q.className="popup",this.#o){const pe=q.style.outlineColor=n.Util.makeHexColor(...this.#o);CSS.supports("background-color","color-mix(in srgb, red 30%, white)")?q.style.backgroundColor=`color-mix(in srgb, ${pe} 30%, white)`:q.style.backgroundColor=n.Util.makeHexColor(...this.#o.map(Se=>Math.floor(.7*(255-Se)+Se)))}const V=document.createElement("span");V.className="header";const K=document.createElement("h1");if(V.append(K),{dir:K.dir,str:K.textContent}=this.#g,q.append(V),this.#e){const pe=document.createElement("span");pe.classList.add("popupDate"),this.#e.then(ge=>{pe.textContent=ge}),V.append(pe)}const ue=this.#u,Q=this.#_;if(Q?.str&&(!ue?.str||ue.str===Q.str))f.XfaLayer.render({xfaHtml:Q.html,intent:"richText",div:q}),q.lastChild.classList.add("richText","popupContent");else{const pe=this._formatContents(ue);q.append(pe)}let J=!!this.#f,ee=J?this.#f:this.#p;for(const pe of this.#c)if(!ee||n.Util.intersect(pe.data.rect,ee)!==null){ee=pe.data.rect,J=!0;break}const se=n.Util.normalizeRect([ee[0],E[3]-ee[1]+E[1],ee[2],E[3]-ee[3]+E[1]]),ce=J?ee[2]-ee[0]+5:0,de=se[0]+ce,he=se[1],{style:fe}=this.#a;fe.left=`${100*(de-k)/w}%`,fe.top=`${100*(he-U)/O}%`,this.#a.append(q)}_formatContents({str:E,dir:w}){const O=document.createElement("p");O.classList.add("popupContent"),O.dir=w;const k=E.split(/(?:\r\n?|\n)/);for(let U=0,q=k.length;U<q;++U){const V=k[U];O.append(document.createTextNode(V)),U<q-1&&O.append(document.createElement("br"))}return O}#l(E){E.altKey||E.shiftKey||E.ctrlKey||E.metaKey||(E.key==="Enter"||E.key==="Escape"&&this.#d)&&this.#b()}#b(){this.#d=!this.#d,this.#d?(this.#S(),this.#a.addEventListener("click",this.#i),this.#a.addEventListener("keydown",this.#t)):(this.#y(),this.#a.removeEventListener("click",this.#i),this.#a.removeEventListener("keydown",this.#t))}#S(){this.#h||this.render(),this.isVisible?this.#d&&this.#a.classList.add("focused"):(this.#a.hidden=!1,this.#a.style.zIndex=parseInt(this.#a.style.zIndex)+1e3)}#y(){this.#a.classList.remove("focused"),!(this.#d||!this.isVisible)&&(this.#a.hidden=!0,this.#a.style.zIndex=parseInt(this.#a.style.zIndex)-1e3)}forceHide(){this.#m=this.isVisible,this.#m&&(this.#a.hidden=!0)}maybeShow(){this.#m&&(this.#m=!1,this.#a.hidden=!1)}get isVisible(){return this.#a.hidden===!1}}class W extends p{constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0}),this.textContent=E.data.textContent,this.textPosition=E.data.textPosition,this.annotationEditorType=n.AnnotationEditorType.FREETEXT}render(){if(this.container.classList.add("freeTextAnnotation"),this.textContent){const E=document.createElement("div");E.classList.add("annotationTextContent"),E.setAttribute("role","comment");for(const w of this.textContent){const O=document.createElement("span");O.textContent=w,E.append(O)}this.container.append(E)}return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this._editOnDoubleClick(),this.container}}e.FreeTextAnnotationElement=W;class z extends p{#e=null;constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("lineAnnotation");const E=this.data,{width:w,height:O}=m(E.rect),k=this.svgFactory.create(w,O,!0),U=this.#e=this.svgFactory.createElement("svg:line");return U.setAttribute("x1",E.rect[2]-E.lineCoordinates[0]),U.setAttribute("y1",E.rect[3]-E.lineCoordinates[1]),U.setAttribute("x2",E.rect[2]-E.lineCoordinates[2]),U.setAttribute("y2",E.rect[3]-E.lineCoordinates[3]),U.setAttribute("stroke-width",E.borderStyle.width||1),U.setAttribute("stroke","transparent"),U.setAttribute("fill","transparent"),k.append(U),this.container.append(k),!E.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#e}addHighlightArea(){this.container.classList.add("highlightArea")}}class re extends p{#e=null;constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("squareAnnotation");const E=this.data,{width:w,height:O}=m(E.rect),k=this.svgFactory.create(w,O,!0),U=E.borderStyle.width,q=this.#e=this.svgFactory.createElement("svg:rect");return q.setAttribute("x",U/2),q.setAttribute("y",U/2),q.setAttribute("width",w-U),q.setAttribute("height",O-U),q.setAttribute("stroke-width",U||1),q.setAttribute("stroke","transparent"),q.setAttribute("fill","transparent"),k.append(q),this.container.append(k),!E.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#e}addHighlightArea(){this.container.classList.add("highlightArea")}}class X extends p{#e=null;constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("circleAnnotation");const E=this.data,{width:w,height:O}=m(E.rect),k=this.svgFactory.create(w,O,!0),U=E.borderStyle.width,q=this.#e=this.svgFactory.createElement("svg:ellipse");return q.setAttribute("cx",w/2),q.setAttribute("cy",O/2),q.setAttribute("rx",w/2-U/2),q.setAttribute("ry",O/2-U/2),q.setAttribute("stroke-width",U||1),q.setAttribute("stroke","transparent"),q.setAttribute("fill","transparent"),k.append(q),this.container.append(k),!E.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#e}addHighlightArea(){this.container.classList.add("highlightArea")}}class ne extends p{#e=null;constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName="polylineAnnotation",this.svgElementName="svg:polyline"}render(){this.container.classList.add(this.containerClassName);const E=this.data,{width:w,height:O}=m(E.rect),k=this.svgFactory.create(w,O,!0);let U=[];for(const V of E.vertices){const K=V.x-E.rect[0],ue=E.rect[3]-V.y;U.push(K+","+ue)}U=U.join(" ");const q=this.#e=this.svgFactory.createElement(this.svgElementName);return q.setAttribute("points",U),q.setAttribute("stroke-width",E.borderStyle.width||1),q.setAttribute("stroke","transparent"),q.setAttribute("fill","transparent"),k.append(q),this.container.append(k),!E.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#e}addHighlightArea(){this.container.classList.add("highlightArea")}}class ie extends ne{constructor(E){super(E),this.containerClassName="polygonAnnotation",this.svgElementName="svg:polygon"}}class te extends p{constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0})}render(){return this.container.classList.add("caretAnnotation"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container}}class H extends p{#e=[];constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName="inkAnnotation",this.svgElementName="svg:polyline",this.annotationEditorType=n.AnnotationEditorType.INK}render(){this.container.classList.add(this.containerClassName);const E=this.data,{width:w,height:O}=m(E.rect),k=this.svgFactory.create(w,O,!0);for(const U of E.inkLists){let q=[];for(const K of U){const ue=K.x-E.rect[0],Q=E.rect[3]-K.y;q.push(`${ue},${Q}`)}q=q.join(" ");const V=this.svgFactory.createElement(this.svgElementName);this.#e.push(V),V.setAttribute("points",q),V.setAttribute("stroke-width",E.borderStyle.width||1),V.setAttribute("stroke","transparent"),V.setAttribute("fill","transparent"),!E.popupRef&&this.hasPopupData&&this._createPopup(),k.append(V)}return this.container.append(k),this.container}getElementsToTriggerPopup(){return this.#e}addHighlightArea(){this.container.classList.add("highlightArea")}}e.InkAnnotationElement=H;class P extends p{constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("highlightAnnotation"),this.container}}class C extends p{constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("underlineAnnotation"),this.container}}class I extends p{constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("squigglyAnnotation"),this.container}}class R extends p{constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("strikeoutAnnotation"),this.container}}class L extends p{constructor(E){super(E,{isRenderable:!0,ignoreBorder:!0})}render(){return this.container.classList.add("stampAnnotation"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container}}e.StampAnnotationElement=L;class G extends p{#e=null;constructor(E){super(E,{isRenderable:!0});const{filename:w,content:O}=this.data.file;this.filename=(0,r.getFilenameFromUrl)(w,!0),this.content=O,this.linkService.eventBus?.dispatch("fileattachmentannotation",{source:this,filename:w,content:O})}render(){this.container.classList.add("fileAttachmentAnnotation");const{container:E,data:w}=this;let O;w.hasAppearance||w.fillAlpha===0?O=document.createElement("div"):(O=document.createElement("img"),O.src=`${this.imageResourcesPath}annotation-${/paperclip/i.test(w.name)?"paperclip":"pushpin"}.svg`,w.fillAlpha&&w.fillAlpha<1&&(O.style=`filter: opacity(${Math.round(w.fillAlpha*100)}%);`)),O.addEventListener("dblclick",this.#t.bind(this)),this.#e=O;const{isMac:k}=n.FeatureTest.platform;return E.addEventListener("keydown",U=>{U.key==="Enter"&&(k?U.metaKey:U.ctrlKey)&&this.#t()}),!w.popupRef&&this.hasPopupData?this._createPopup():O.classList.add("popupTriggerArea"),E.append(O),E}getElementsToTriggerPopup(){return this.#e}addHighlightArea(){this.container.classList.add("highlightArea")}#t(){this.downloadManager?.openOrDownloadData(this.container,this.content,this.filename)}}class j{#e=null;#t=null;#s=new Map;constructor({div:E,accessibilityManager:w,annotationCanvasMap:O,l10n:k,page:U,viewport:q}){this.div=E,this.#e=w,this.#t=O,this.l10n=k,this.page=U,this.viewport=q,this.zIndex=0,this.l10n||=u.NullL10n}#n(E,w){const O=E.firstChild||E;O.id=`${n.AnnotationPrefix}${w}`,this.div.append(E),this.#e?.moveElementInDOM(this.div,E,O,!1)}async render(E){const{annotations:w}=E,O=this.div;(0,r.setLayerDimensions)(O,this.viewport);const k=new Map,U={data:null,layer:O,linkService:E.linkService,downloadManager:E.downloadManager,imageResourcesPath:E.imageResourcesPath||"",renderForms:E.renderForms!==!1,svgFactory:new r.DOMSVGFactory,annotationStorage:E.annotationStorage||new a.AnnotationStorage,enableScripting:E.enableScripting===!0,hasJSActions:E.hasJSActions,fieldObjects:E.fieldObjects,parent:this,elements:null};for(const q of w){if(q.noHTML)continue;const V=q.annotationType===n.AnnotationType.POPUP;if(V){const Q=k.get(q.id);if(!Q)continue;U.elements=Q}else{const{width:Q,height:J}=m(q.rect);if(Q<=0||J<=0)continue}U.data=q;const K=_.create(U);if(!K.isRenderable)continue;if(!V&&q.popupRef){const Q=k.get(q.popupRef);Q?Q.push(K):k.set(q.popupRef,[K])}K.annotationEditorType>0&&this.#s.set(K.data.id,K);const ue=K.render();q.hidden&&(ue.style.visibility="hidden"),this.#n(ue,q.id)}this.#i(),await this.l10n.translate(O)}update({viewport:E}){const w=this.div;this.viewport=E,(0,r.setLayerDimensions)(w,{rotation:E.rotation}),this.#i(),w.hidden=!1}#i(){if(!this.#t)return;const E=this.div;for(const[w,O]of this.#t){const k=E.querySelector(`[data-annotation-id="${w}"]`);if(!k)continue;const{firstChild:U}=k;U?U.nodeName==="CANVAS"?U.replaceWith(O):U.before(O):k.append(O)}this.#t.clear()}getEditableAnnotations(){return Array.from(this.#s.values())}getEditableAnnotation(E){return this.#s.get(E)}}e.AnnotationLayer=j},(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ColorConverters=void 0;function s(a){return Math.floor(Math.max(0,Math.min(1,a))*255).toString(16).padStart(2,"0")}function n(a){return Math.max(0,Math.min(255,255*a))}class r{static CMYK_G([i,u,f,c]){return["G",1-Math.min(1,.3*i+.59*f+.11*u+c)]}static G_CMYK([i]){return["CMYK",0,0,0,1-i]}static G_RGB([i]){return["RGB",i,i,i]}static G_rgb([i]){return i=n(i),[i,i,i]}static G_HTML([i]){const u=s(i);return`#${u}${u}${u}`}static RGB_G([i,u,f]){return["G",.3*i+.59*u+.11*f]}static RGB_rgb(i){return i.map(n)}static RGB_HTML(i){return`#${i.map(s).join("")}`}static T_HTML(){return"#00000000"}static T_rgb(){return[null]}static CMYK_RGB([i,u,f,c]){return["RGB",1-Math.min(1,i+c),1-Math.min(1,f+c),1-Math.min(1,u+c)]}static CMYK_rgb([i,u,f,c]){return[n(1-Math.min(1,i+c)),n(1-Math.min(1,f+c)),n(1-Math.min(1,u+c))]}static CMYK_HTML(i){const u=this.CMYK_RGB(i).slice(1);return this.RGB_HTML(u)}static RGB_CMYK([i,u,f]){const c=1-i,d=1-u,h=1-f,m=Math.min(c,d,h);return["CMYK",c,d,h,m]}}e.ColorConverters=r},(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.NullL10n=void 0,e.getL10nFallback=n;const s={of_pages:"of {{pagesCount}}",page_of_pages:"({{pageNumber}} of {{pagesCount}})",document_properties_kb:"{{size_kb}} KB ({{size_b}} bytes)",document_properties_mb:"{{size_mb}} MB ({{size_b}} bytes)",document_properties_date_string:"{{date}}, {{time}}",document_properties_page_size_unit_inches:"in",document_properties_page_size_unit_millimeters:"mm",document_properties_page_size_orientation_portrait:"portrait",document_properties_page_size_orientation_landscape:"landscape",document_properties_page_size_name_a3:"A3",document_properties_page_size_name_a4:"A4",document_properties_page_size_name_letter:"Letter",document_properties_page_size_name_legal:"Legal",document_properties_page_size_dimension_string:"{{width}} × {{height}} {{unit}} ({{orientation}})",document_properties_page_size_dimension_name_string:"{{width}} × {{height}} {{unit}} ({{name}}, {{orientation}})",document_properties_linearized_yes:"Yes",document_properties_linearized_no:"No",additional_layers:"Additional Layers",page_landmark:"Page {{page}}",thumb_page_title:"Page {{page}}",thumb_page_canvas:"Thumbnail of Page {{page}}",find_reached_top:"Reached top of document, continued from bottom",find_reached_bottom:"Reached end of document, continued from top","find_match_count[one]":"{{current}} of {{total}} match","find_match_count[other]":"{{current}} of {{total}} matches","find_match_count_limit[one]":"More than {{limit}} match","find_match_count_limit[other]":"More than {{limit}} matches",find_not_found:"Phrase not found",page_scale_width:"Page Width",page_scale_fit:"Page Fit",page_scale_auto:"Automatic Zoom",page_scale_actual:"Actual Size",page_scale_percent:"{{scale}}%",loading_error:"An error occurred while loading the PDF.",invalid_file_error:"Invalid or corrupted PDF file.",missing_file_error:"Missing PDF file.",unexpected_response_error:"Unexpected server response.",rendering_error:"An error occurred while rendering the page.",annotation_date_string:"{{date}}, {{time}}",printing_not_supported:"Warning: Printing is not fully supported by this browser.",printing_not_ready:"Warning: The PDF is not fully loaded for printing.",web_fonts_disabled:"Web fonts are disabled: unable to use embedded PDF fonts.",free_text2_default_content:"Start typing…",editor_free_text2_aria_label:"Text Editor",editor_ink2_aria_label:"Draw Editor",editor_ink_canvas_aria_label:"User-created image",editor_alt_text_button_label:"Alt text",editor_alt_text_edit_button_label:"Edit alt text",editor_alt_text_decorative_tooltip:"Marked as decorative"};s.print_progress_percent="{{progress}}%";function n(i,u){switch(i){case"find_match_count":i=`find_match_count[${u.total===1?"one":"other"}]`;break;case"find_match_count_limit":i=`find_match_count_limit[${u.limit===1?"one":"other"}]`;break}return s[i]||""}function r(i,u){return u?i.replaceAll(/\{\{\s*(\w+)\s*\}\}/g,(f,c)=>c in u?u[c]:"{{"+c+"}}"):i}const a={async getLanguage(){return"en-us"},async getDirection(){return"ltr"},async get(i,u=null,f=n(i,u)){return r(f,u)},async translate(i){}};e.NullL10n=a},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.XfaLayer=void 0;var n=s(25);class r{static setupStorage(i,u,f,c,d){const h=c.getValue(u,{value:null});switch(f.name){case"textarea":if(h.value!==null&&(i.textContent=h.value),d==="print")break;i.addEventListener("input",m=>{c.setValue(u,{value:m.target.value})});break;case"input":if(f.attributes.type==="radio"||f.attributes.type==="checkbox"){if(h.value===f.attributes.xfaOn?i.setAttribute("checked",!0):h.value===f.attributes.xfaOff&&i.removeAttribute("checked"),d==="print")break;i.addEventListener("change",m=>{c.setValue(u,{value:m.target.checked?m.target.getAttribute("xfaOn"):m.target.getAttribute("xfaOff")})})}else{if(h.value!==null&&i.setAttribute("value",h.value),d==="print")break;i.addEventListener("input",m=>{c.setValue(u,{value:m.target.value})})}break;case"select":if(h.value!==null){i.setAttribute("value",h.value);for(const m of f.children)m.attributes.value===h.value?m.attributes.selected=!0:m.attributes.hasOwnProperty("selected")&&delete m.attributes.selected}i.addEventListener("input",m=>{const _=m.target.options,p=_.selectedIndex===-1?"":_[_.selectedIndex].value;c.setValue(u,{value:p})});break}}static setAttributes({html:i,element:u,storage:f=null,intent:c,linkService:d}){const{attributes:h}=u,m=i instanceof HTMLAnchorElement;h.type==="radio"&&(h.name=`${h.name}-${c}`);for(const[_,p]of Object.entries(h))if(p!=null)switch(_){case"class":p.length&&i.setAttribute(_,p.join(" "));break;case"dataId":break;case"id":i.setAttribute("data-element-id",p);break;case"style":Object.assign(i.style,p);break;case"textContent":i.textContent=p;break;default:(!m||_!=="href"&&_!=="newWindow")&&i.setAttribute(_,p)}m&&d.addLinkAttributes(i,h.href,h.newWindow),f&&h.dataId&&this.setupStorage(i,h.dataId,u,f)}static render(i){const u=i.annotationStorage,f=i.linkService,c=i.xfaHtml,d=i.intent||"display",h=document.createElement(c.name);c.attributes&&this.setAttributes({html:h,element:c,intent:d,linkService:f});const m=[[c,-1,h]],_=i.div;if(_.append(h),i.viewport){const b=`matrix(${i.viewport.transform.join(",")})`;_.style.transform=b}d!=="richText"&&_.setAttribute("class","xfaLayer xfaFont");const p=[];for(;m.length>0;){const[b,A,T]=m.at(-1);if(A+1===b.children.length){m.pop();continue}const v=b.children[++m.at(-1)[1]];if(v===null)continue;const{name:N}=v;if(N==="#text"){const y=document.createTextNode(v.value);p.push(y),T.append(y);continue}const x=v?.attributes?.xmlns?document.createElementNS(v.attributes.xmlns,N):document.createElement(N);if(T.append(x),v.attributes&&this.setAttributes({html:x,element:v,storage:u,intent:d,linkService:f}),v.children&&v.children.length>0)m.push([v,-1,x]);else if(v.value){const y=document.createTextNode(v.value);n.XfaText.shouldBuildText(N)&&p.push(y),x.append(y)}}for(const b of _.querySelectorAll(".xfaNonInteractive input, .xfaNonInteractive textarea"))b.setAttribute("readOnly",!0);return{textDivs:p}}static update(i){const u=`matrix(${i.viewport.transform.join(",")})`;i.div.style.transform=u,i.div.hidden=!1}}e.XfaLayer=r},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.InkEditor=void 0;var n=s(1),r=s(4),a=s(29),i=s(6),u=s(5);class f extends r.AnnotationEditor{#e=0;#t=0;#s=this.canvasPointermove.bind(this);#n=this.canvasPointerleave.bind(this);#i=this.canvasPointerup.bind(this);#o=this.canvasPointerdown.bind(this);#a=new Path2D;#u=!1;#c=!1;#r=!1;#f=null;#d=0;#h=0;#p=null;static _defaultColor=null;static _defaultOpacity=1;static _defaultThickness=1;static _type="ink";constructor(d){super({...d,name:"inkEditor"}),this.color=d.color||null,this.thickness=d.thickness||null,this.opacity=d.opacity||null,this.paths=[],this.bezierPath2D=[],this.allRawPaths=[],this.currentPath=[],this.scaleFactor=1,this.translationX=this.translationY=0,this.x=0,this.y=0,this._willKeepAspectRatio=!0}static initialize(d){r.AnnotationEditor.initialize(d,{strings:["editor_ink_canvas_aria_label","editor_ink2_aria_label"]})}static updateDefaultParams(d,h){switch(d){case n.AnnotationEditorParamsType.INK_THICKNESS:f._defaultThickness=h;break;case n.AnnotationEditorParamsType.INK_COLOR:f._defaultColor=h;break;case n.AnnotationEditorParamsType.INK_OPACITY:f._defaultOpacity=h/100;break}}updateParams(d,h){switch(d){case n.AnnotationEditorParamsType.INK_THICKNESS:this.#_(h);break;case n.AnnotationEditorParamsType.INK_COLOR:this.#g(h);break;case n.AnnotationEditorParamsType.INK_OPACITY:this.#m(h);break}}static get defaultPropertiesToUpdate(){return[[n.AnnotationEditorParamsType.INK_THICKNESS,f._defaultThickness],[n.AnnotationEditorParamsType.INK_COLOR,f._defaultColor||r.AnnotationEditor._defaultLineColor],[n.AnnotationEditorParamsType.INK_OPACITY,Math.round(f._defaultOpacity*100)]]}get propertiesToUpdate(){return[[n.AnnotationEditorParamsType.INK_THICKNESS,this.thickness||f._defaultThickness],[n.AnnotationEditorParamsType.INK_COLOR,this.color||f._defaultColor||r.AnnotationEditor._defaultLineColor],[n.AnnotationEditorParamsType.INK_OPACITY,Math.round(100*(this.opacity??f._defaultOpacity))]]}#_(d){const h=this.thickness;this.addCommands({cmd:()=>{this.thickness=d,this.#I()},undo:()=>{this.thickness=h,this.#I()},mustExec:!0,type:n.AnnotationEditorParamsType.INK_THICKNESS,overwriteIfSameType:!0,keepUndo:!0})}#g(d){const h=this.color;this.addCommands({cmd:()=>{this.color=d,this.#T()},undo:()=>{this.color=h,this.#T()},mustExec:!0,type:n.AnnotationEditorParamsType.INK_COLOR,overwriteIfSameType:!0,keepUndo:!0})}#m(d){d/=100;const h=this.opacity;this.addCommands({cmd:()=>{this.opacity=d,this.#T()},undo:()=>{this.opacity=h,this.#T()},mustExec:!0,type:n.AnnotationEditorParamsType.INK_OPACITY,overwriteIfSameType:!0,keepUndo:!0})}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.canvas||(this.#R(),this.#N()),this.isAttachedToDOM||(this.parent.add(this),this.#A()),this.#I()))}remove(){this.canvas!==null&&(this.isEmpty()||this.commit(),this.canvas.width=this.canvas.height=0,this.canvas.remove(),this.canvas=null,this.#f.disconnect(),this.#f=null,super.remove())}setParent(d){!this.parent&&d?this._uiManager.removeShouldRescale(this):this.parent&&d===null&&this._uiManager.addShouldRescale(this),super.setParent(d)}onScaleChanging(){const[d,h]=this.parentDimensions,m=this.width*d,_=this.height*h;this.setDimensions(m,_)}enableEditMode(){this.#u||this.canvas===null||(super.enableEditMode(),this._isDraggable=!1,this.canvas.addEventListener("pointerdown",this.#o))}disableEditMode(){!this.isInEditMode()||this.canvas===null||(super.disableEditMode(),this._isDraggable=!this.isEmpty(),this.div.classList.remove("editing"),this.canvas.removeEventListener("pointerdown",this.#o))}onceAdded(){this._isDraggable=!this.isEmpty()}isEmpty(){return this.paths.length===0||this.paths.length===1&&this.paths[0].length===0}#l(){const{parentRotation:d,parentDimensions:[h,m]}=this;switch(d){case 90:return[0,m,m,h];case 180:return[h,m,h,m];case 270:return[h,0,m,h];default:return[0,0,h,m]}}#b(){const{ctx:d,color:h,opacity:m,thickness:_,parentScale:p,scaleFactor:b}=this;d.lineWidth=_*p/b,d.lineCap="round",d.lineJoin="round",d.miterLimit=10,d.strokeStyle=`${h}${(0,u.opacityToHex)(m)}`}#S(d,h){this.canvas.addEventListener("contextmenu",i.noContextMenu),this.canvas.addEventListener("pointerleave",this.#n),this.canvas.addEventListener("pointermove",this.#s),this.canvas.addEventListener("pointerup",this.#i),this.canvas.removeEventListener("pointerdown",this.#o),this.isEditing=!0,this.#r||(this.#r=!0,this.#A(),this.thickness||=f._defaultThickness,this.color||=f._defaultColor||r.AnnotationEditor._defaultLineColor,this.opacity??=f._defaultOpacity),this.currentPath.push([d,h]),this.#c=!1,this.#b(),this.#p=()=>{this.#k(),this.#p&&window.requestAnimationFrame(this.#p)},window.requestAnimationFrame(this.#p)}#y(d,h){const[m,_]=this.currentPath.at(-1);if(this.currentPath.length>1&&d===m&&h===_)return;const p=this.currentPath;let b=this.#a;if(p.push([d,h]),this.#c=!0,p.length<=2){b.moveTo(...p[0]),b.lineTo(d,h);return}p.length===3&&(this.#a=b=new Path2D,b.moveTo(...p[0])),this.#M(b,...p.at(-3),...p.at(-2),d,h)}#v(){if(this.currentPath.length===0)return;const d=this.currentPath.at(-1);this.#a.lineTo(...d)}#P(d,h){this.#p=null,d=Math.min(Math.max(d,0),this.canvas.width),h=Math.min(Math.max(h,0),this.canvas.height),this.#y(d,h),this.#v();let m;if(this.currentPath.length!==1)m=this.#L();else{const T=[d,h];m=[[T,T.slice(),T.slice(),T]]}const _=this.#a,p=this.currentPath;this.currentPath=[],this.#a=new Path2D;const b=()=>{this.allRawPaths.push(p),this.paths.push(m),this.bezierPath2D.push(_),this.rebuild()},A=()=>{this.allRawPaths.pop(),this.paths.pop(),this.bezierPath2D.pop(),this.paths.length===0?this.remove():(this.canvas||(this.#R(),this.#N()),this.#I())};this.addCommands({cmd:b,undo:A,mustExec:!0})}#k(){if(!this.#c)return;this.#c=!1;const d=Math.ceil(this.thickness*this.parentScale),h=this.currentPath.slice(-3),m=h.map(b=>b[0]),_=h.map(b=>b[1]);Math.min(...m)-d,Math.max(...m)+d,Math.min(..._)-d,Math.max(..._)+d;const{ctx:p}=this;p.save(),p.clearRect(0,0,this.canvas.width,this.canvas.height);for(const b of this.bezierPath2D)p.stroke(b);p.stroke(this.#a),p.restore()}#M(d,h,m,_,p,b,A){const T=(h+_)/2,v=(m+p)/2,N=(_+b)/2,x=(p+A)/2;d.bezierCurveTo(T+2*(_-T)/3,v+2*(p-v)/3,N+2*(_-N)/3,x+2*(p-x)/3,N,x)}#L(){const d=this.currentPath;if(d.length<=2)return[[d[0],d[0],d.at(-1),d.at(-1)]];const h=[];let m,[_,p]=d[0];for(m=1;m<d.length-2;m++){const[y,S]=d[m],[D,F]=d[m+1],B=(y+D)/2,W=(S+F)/2,z=[_+2*(y-_)/3,p+2*(S-p)/3],re=[B+2*(y-B)/3,W+2*(S-W)/3];h.push([[_,p],z,re,[B,W]]),[_,p]=[B,W]}const[b,A]=d[m],[T,v]=d[m+1],N=[_+2*(b-_)/3,p+2*(A-p)/3],x=[T+2*(b-T)/3,v+2*(A-v)/3];return h.push([[_,p],N,x,[T,v]]),h}#T(){if(this.isEmpty()){this.#C();return}this.#b();const{canvas:d,ctx:h}=this;h.setTransform(1,0,0,1,0,0),h.clearRect(0,0,d.width,d.height),this.#C();for(const m of this.bezierPath2D)h.stroke(m)}commit(){this.#u||(super.commit(),this.isEditing=!1,this.disableEditMode(),this.setInForeground(),this.#u=!0,this.div.classList.add("disabled"),this.#I(!0),this.makeResizable(),this.parent.addInkEditorIfNeeded(!0),this.moveInDOM(),this.div.focus({preventScroll:!0}))}focusin(d){this._focusEventsAllowed&&(super.focusin(d),this.enableEditMode())}canvasPointerdown(d){d.button!==0||!this.isInEditMode()||this.#u||(this.setInForeground(),d.preventDefault(),d.type!=="mouse"&&this.div.focus(),this.#S(d.offsetX,d.offsetY))}canvasPointermove(d){d.preventDefault(),this.#y(d.offsetX,d.offsetY)}canvasPointerup(d){d.preventDefault(),this.#D(d)}canvasPointerleave(d){this.#D(d)}#D(d){this.canvas.removeEventListener("pointerleave",this.#n),this.canvas.removeEventListener("pointermove",this.#s),this.canvas.removeEventListener("pointerup",this.#i),this.canvas.addEventListener("pointerdown",this.#o),setTimeout(()=>{this.canvas.removeEventListener("contextmenu",i.noContextMenu)},10),this.#P(d.offsetX,d.offsetY),this.addToAnnotationStorage(),this.setInBackground()}#R(){this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=0,this.canvas.className="inkEditorCanvas",r.AnnotationEditor._l10nPromise.get("editor_ink_canvas_aria_label").then(d=>this.canvas?.setAttribute("aria-label",d)),this.div.append(this.canvas),this.ctx=this.canvas.getContext("2d")}#N(){this.#f=new ResizeObserver(d=>{const h=d[0].contentRect;h.width&&h.height&&this.setDimensions(h.width,h.height)}),this.#f.observe(this.div)}get isResizable(){return!this.isEmpty()&&this.#u}render(){if(this.div)return this.div;let d,h;this.width&&(d=this.x,h=this.y),super.render(),r.AnnotationEditor._l10nPromise.get("editor_ink2_aria_label").then(A=>this.div?.setAttribute("aria-label",A));const[m,_,p,b]=this.#l();if(this.setAt(m,_,0,0),this.setDims(p,b),this.#R(),this.width){const[A,T]=this.parentDimensions;this.setAspectRatio(this.width*A,this.height*T),this.setAt(d*A,h*T,this.width*A,this.height*T),this.#r=!0,this.#A(),this.setDims(this.width*A,this.height*T),this.#T(),this.div.classList.add("disabled")}else this.div.classList.add("editing"),this.enableEditMode();return this.#N(),this.div}#A(){if(!this.#r)return;const[d,h]=this.parentDimensions;this.canvas.width=Math.ceil(this.width*d),this.canvas.height=Math.ceil(this.height*h),this.#C()}setDimensions(d,h){const m=Math.round(d),_=Math.round(h);if(this.#d===m&&this.#h===_)return;this.#d=m,this.#h=_,this.canvas.style.visibility="hidden";const[p,b]=this.parentDimensions;this.width=d/p,this.height=h/b,this.fixAndSetPosition(),this.#u&&this.#w(d,h),this.#A(),this.#T(),this.canvas.style.visibility="visible",this.fixDims()}#w(d,h){const m=this.#x(),_=(d-m)/this.#t,p=(h-m)/this.#e;this.scaleFactor=Math.min(_,p)}#C(){const d=this.#x()/2;this.ctx.setTransform(this.scaleFactor,0,0,this.scaleFactor,this.translationX*this.scaleFactor+d,this.translationY*this.scaleFactor+d)}static#F(d){const h=new Path2D;for(let m=0,_=d.length;m<_;m++){const[p,b,A,T]=d[m];m===0&&h.moveTo(...p),h.bezierCurveTo(b[0],b[1],A[0],A[1],T[0],T[1])}return h}static#$(d,h,m){const[_,p,b,A]=h;switch(m){case 0:for(let T=0,v=d.length;T<v;T+=2)d[T]+=_,d[T+1]=A-d[T+1];break;case 90:for(let T=0,v=d.length;T<v;T+=2){const N=d[T];d[T]=d[T+1]+_,d[T+1]=N+p}break;case 180:for(let T=0,v=d.length;T<v;T+=2)d[T]=b-d[T],d[T+1]+=p;break;case 270:for(let T=0,v=d.length;T<v;T+=2){const N=d[T];d[T]=b-d[T+1],d[T+1]=A-N}break;default:throw new Error("Invalid rotation")}return d}static#B(d,h,m){const[_,p,b,A]=h;switch(m){case 0:for(let T=0,v=d.length;T<v;T+=2)d[T]-=_,d[T+1]=A-d[T+1];break;case 90:for(let T=0,v=d.length;T<v;T+=2){const N=d[T];d[T]=d[T+1]-p,d[T+1]=N-_}break;case 180:for(let T=0,v=d.length;T<v;T+=2)d[T]=b-d[T],d[T+1]-=p;break;case 270:for(let T=0,v=d.length;T<v;T+=2){const N=d[T];d[T]=A-d[T+1],d[T+1]=b-N}break;default:throw new Error("Invalid rotation")}return d}#U(d,h,m,_){const p=[],b=this.thickness/2,A=d*h+b,T=d*m+b;for(const v of this.paths){const N=[],x=[];for(let y=0,S=v.length;y<S;y++){const[D,F,B,W]=v[y],z=d*D[0]+A,re=d*D[1]+T,X=d*F[0]+A,ne=d*F[1]+T,ie=d*B[0]+A,te=d*B[1]+T,H=d*W[0]+A,P=d*W[1]+T;y===0&&(N.push(z,re),x.push(z,re)),N.push(X,ne,ie,te,H,P),x.push(X,ne),y===S-1&&x.push(H,P)}p.push({bezier:f.#$(N,_,this.rotation),points:f.#$(x,_,this.rotation)})}return p}#O(){let d=1/0,h=-1/0,m=1/0,_=-1/0;for(const p of this.paths)for(const[b,A,T,v]of p){const N=n.Util.bezierBoundingBox(...b,...A,...T,...v);d=Math.min(d,N[0]),m=Math.min(m,N[1]),h=Math.max(h,N[2]),_=Math.max(_,N[3])}return[d,m,h,_]}#x(){return this.#u?Math.ceil(this.thickness*this.parentScale):0}#I(d=!1){if(this.isEmpty())return;if(!this.#u){this.#T();return}const h=this.#O(),m=this.#x();this.#t=Math.max(r.AnnotationEditor.MIN_SIZE,h[2]-h[0]),this.#e=Math.max(r.AnnotationEditor.MIN_SIZE,h[3]-h[1]);const _=Math.ceil(m+this.#t*this.scaleFactor),p=Math.ceil(m+this.#e*this.scaleFactor),[b,A]=this.parentDimensions;this.width=_/b,this.height=p/A,this.setAspectRatio(_,p);const T=this.translationX,v=this.translationY;this.translationX=-h[0],this.translationY=-h[1],this.#A(),this.#T(),this.#d=_,this.#h=p,this.setDims(_,p);const N=d?m/this.scaleFactor/2:0;this.translate(T-this.translationX-N,v-this.translationY-N)}static deserialize(d,h,m){if(d instanceof a.InkAnnotationElement)return null;const _=super.deserialize(d,h,m);_.thickness=d.thickness,_.color=n.Util.makeHexColor(...d.color),_.opacity=d.opacity;const[p,b]=_.pageDimensions,A=_.width*p,T=_.height*b,v=_.parentScale,N=d.thickness/2;_.#u=!0,_.#d=Math.round(A),_.#h=Math.round(T);const{paths:x,rect:y,rotation:S}=d;for(let{bezier:F}of x){F=f.#B(F,y,S);const B=[];_.paths.push(B);let W=v*(F[0]-N),z=v*(F[1]-N);for(let X=2,ne=F.length;X<ne;X+=6){const ie=v*(F[X]-N),te=v*(F[X+1]-N),H=v*(F[X+2]-N),P=v*(F[X+3]-N),C=v*(F[X+4]-N),I=v*(F[X+5]-N);B.push([[W,z],[ie,te],[H,P],[C,I]]),W=C,z=I}const re=this.#F(B);_.bezierPath2D.push(re)}const D=_.#O();return _.#t=Math.max(r.AnnotationEditor.MIN_SIZE,D[2]-D[0]),_.#e=Math.max(r.AnnotationEditor.MIN_SIZE,D[3]-D[1]),_.#w(A,T),_}serialize(){if(this.isEmpty())return null;const d=this.getRect(0,0),h=r.AnnotationEditor._colorManager.convert(this.ctx.strokeStyle);return{annotationType:n.AnnotationEditorType.INK,color:h,thickness:this.thickness,opacity:this.opacity,paths:this.#U(this.scaleFactor/this.parentScale,this.translationX,this.translationY,d),pageIndex:this.pageIndex,rect:d,rotation:this.rotation,structTreeParentId:this._structTreeParentId}}}e.InkEditor=f},(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.StampEditor=void 0;var n=s(1),r=s(4),a=s(6),i=s(29);class u extends r.AnnotationEditor{#e=null;#t=null;#s=null;#n=null;#i=null;#o=null;#a=null;#u=null;#c=!1;#r=!1;static _type="stamp";constructor(c){super({...c,name:"stampEditor"}),this.#n=c.bitmapUrl,this.#i=c.bitmapFile}static initialize(c){r.AnnotationEditor.initialize(c)}static get supportedTypes(){const c=["apng","avif","bmp","gif","jpeg","png","svg+xml","webp","x-icon"];return(0,n.shadow)(this,"supportedTypes",c.map(d=>`image/${d}`))}static get supportedTypesStr(){return(0,n.shadow)(this,"supportedTypesStr",this.supportedTypes.join(","))}static isHandlingMimeForPasting(c){return this.supportedTypes.includes(c)}static paste(c,d){d.pasteEditor(n.AnnotationEditorType.STAMP,{bitmapFile:c.getAsFile()})}#f(c,d=!1){if(!c){this.remove();return}this.#e=c.bitmap,d||(this.#t=c.id,this.#c=c.isSvg),this.#p()}#d(){this.#s=null,this._uiManager.enableWaiting(!1),this.#o&&this.div.focus()}#h(){if(this.#t){this._uiManager.enableWaiting(!0),this._uiManager.imageManager.getFromId(this.#t).then(d=>this.#f(d,!0)).finally(()=>this.#d());return}if(this.#n){const d=this.#n;this.#n=null,this._uiManager.enableWaiting(!0),this.#s=this._uiManager.imageManager.getFromUrl(d).then(h=>this.#f(h)).finally(()=>this.#d());return}if(this.#i){const d=this.#i;this.#i=null,this._uiManager.enableWaiting(!0),this.#s=this._uiManager.imageManager.getFromFile(d).then(h=>this.#f(h)).finally(()=>this.#d());return}const c=document.createElement("input");c.type="file",c.accept=u.supportedTypesStr,this.#s=new Promise(d=>{c.addEventListener("change",async()=>{if(!c.files||c.files.length===0)this.remove();else{this._uiManager.enableWaiting(!0);const h=await this._uiManager.imageManager.getFromFile(c.files[0]);this.#f(h)}d()}),c.addEventListener("cancel",()=>{this.remove(),d()})}).finally(()=>this.#d()),c.click()}remove(){this.#t&&(this.#e=null,this._uiManager.imageManager.deleteId(this.#t),this.#o?.remove(),this.#o=null,this.#a?.disconnect(),this.#a=null),super.remove()}rebuild(){if(!this.parent){this.#t&&this.#h();return}super.rebuild(),this.div!==null&&(this.#t&&this.#h(),this.isAttachedToDOM||this.parent.add(this))}onceAdded(){this._isDraggable=!0,this.div.focus()}isEmpty(){return!(this.#s||this.#e||this.#n||this.#i)}get isResizable(){return!0}render(){if(this.div)return this.div;let c,d;if(this.width&&(c=this.x,d=this.y),super.render(),this.div.hidden=!0,this.#e?this.#p():this.#h(),this.width){const[h,m]=this.parentDimensions;this.setAt(c*h,d*m,this.width*h,this.height*m)}return this.div}#p(){const{div:c}=this;let{width:d,height:h}=this.#e;const[m,_]=this.pageDimensions,p=.75;if(this.width)d=this.width*m,h=this.height*_;else if(d>p*m||h>p*_){const v=Math.min(p*m/d,p*_/h);d*=v,h*=v}const[b,A]=this.parentDimensions;this.setDims(d*b/m,h*A/_),this._uiManager.enableWaiting(!1);const T=this.#o=document.createElement("canvas");c.append(T),c.hidden=!1,this.#m(d,h),this.#b(),this.#r||(this.parent.addUndoableEditor(this),this.#r=!0),this._uiManager._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",subtype:this.editorType,data:{action:"inserted_image"}}}),this.addAltTextButton()}#_(c,d){const[h,m]=this.parentDimensions;this.width=c/h,this.height=d/m,this.setDims(c,d),this._initialOptions?.isCentered?this.center():this.fixAndSetPosition(),this._initialOptions=null,this.#u!==null&&clearTimeout(this.#u);const _=200;this.#u=setTimeout(()=>{this.#u=null,this.#m(c,d)},_)}#g(c,d){const{width:h,height:m}=this.#e;let _=h,p=m,b=this.#e;for(;_>2*c||p>2*d;){const A=_,T=p;_>2*c&&(_=_>=16384?Math.floor(_/2)-1:Math.ceil(_/2)),p>2*d&&(p=p>=16384?Math.floor(p/2)-1:Math.ceil(p/2));const v=new OffscreenCanvas(_,p);v.getContext("2d").drawImage(b,0,0,A,T,0,0,_,p),b=v.transferToImageBitmap()}return b}#m(c,d){c=Math.ceil(c),d=Math.ceil(d);const h=this.#o;if(!h||h.width===c&&h.height===d)return;h.width=c,h.height=d;const m=this.#c?this.#e:this.#g(c,d),_=h.getContext("2d");_.filter=this._uiManager.hcmFilter,_.drawImage(m,0,0,m.width,m.height,0,0,c,d)}#l(c){if(c){if(this.#c){const m=this._uiManager.imageManager.getSvgUrl(this.#t);if(m)return m}const d=document.createElement("canvas");return{width:d.width,height:d.height}=this.#e,d.getContext("2d").drawImage(this.#e,0,0),d.toDataURL()}if(this.#c){const[d,h]=this.pageDimensions,m=Math.round(this.width*d*a.PixelsPerInch.PDF_TO_CSS_UNITS),_=Math.round(this.height*h*a.PixelsPerInch.PDF_TO_CSS_UNITS),p=new OffscreenCanvas(m,_);return p.getContext("2d").drawImage(this.#e,0,0,this.#e.width,this.#e.height,0,0,m,_),p.transferToImageBitmap()}return structuredClone(this.#e)}#b(){this.#a=new ResizeObserver(c=>{const d=c[0].contentRect;d.width&&d.height&&this.#_(d.width,d.height)}),this.#a.observe(this.div)}static deserialize(c,d,h){if(c instanceof i.StampAnnotationElement)return null;const m=super.deserialize(c,d,h),{rect:_,bitmapUrl:p,bitmapId:b,isSvg:A,accessibilityData:T}=c;b&&h.imageManager.isValidId(b)?m.#t=b:m.#n=p,m.#c=A;const[v,N]=m.pageDimensions;return m.width=(_[2]-_[0])/v,m.height=(_[3]-_[1])/N,T&&(m.altTextData=T),m}serialize(c=!1,d=null){if(this.isEmpty())return null;const h={annotationType:n.AnnotationEditorType.STAMP,bitmapId:this.#t,pageIndex:this.pageIndex,rect:this.getRect(0,0),rotation:this.rotation,isSvg:this.#c,structTreeParentId:this._structTreeParentId};if(c)return h.bitmapUrl=this.#l(!0),h.accessibilityData=this.altTextData,h;const{decorative:m,altText:_}=this.altTextData;if(!m&&_&&(h.accessibilityData={type:"Figure",alt:_}),d===null)return h;d.stamps||=new Map;const p=this.#c?(h.rect[2]-h.rect[0])*(h.rect[3]-h.rect[1]):null;if(!d.stamps.has(this.#t))d.stamps.set(this.#t,{area:p,serialized:h}),h.bitmap=this.#l(!1);else if(this.#c){const b=d.stamps.get(this.#t);p>b.area&&(b.area=p,b.serialized.bitmap.close(),b.serialized.bitmap=this.#l(!1))}return h}}e.StampEditor=u}],__webpack_module_cache__={};function __w_pdfjs_require__(t){var e=__webpack_module_cache__[t];if(e!==void 0)return e.exports;var s=__webpack_module_cache__[t]={exports:{}};return __webpack_modules__[t](s,s.exports,__w_pdfjs_require__),s.exports}var __webpack_exports__={};return(()=>{var t=__webpack_exports__;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"AbortException",{enumerable:!0,get:function(){return e.AbortException}}),Object.defineProperty(t,"AnnotationEditorLayer",{enumerable:!0,get:function(){return a.AnnotationEditorLayer}}),Object.defineProperty(t,"AnnotationEditorParamsType",{enumerable:!0,get:function(){return e.AnnotationEditorParamsType}}),Object.defineProperty(t,"AnnotationEditorType",{enumerable:!0,get:function(){return e.AnnotationEditorType}}),Object.defineProperty(t,"AnnotationEditorUIManager",{enumerable:!0,get:function(){return i.AnnotationEditorUIManager}}),Object.defineProperty(t,"AnnotationLayer",{enumerable:!0,get:function(){return u.AnnotationLayer}}),Object.defineProperty(t,"AnnotationMode",{enumerable:!0,get:function(){return e.AnnotationMode}}),Object.defineProperty(t,"CMapCompressionType",{enumerable:!0,get:function(){return e.CMapCompressionType}}),Object.defineProperty(t,"DOMSVGFactory",{enumerable:!0,get:function(){return n.DOMSVGFactory}}),Object.defineProperty(t,"FeatureTest",{enumerable:!0,get:function(){return e.FeatureTest}}),Object.defineProperty(t,"GlobalWorkerOptions",{enumerable:!0,get:function(){return f.GlobalWorkerOptions}}),Object.defineProperty(t,"ImageKind",{enumerable:!0,get:function(){return e.ImageKind}}),Object.defineProperty(t,"InvalidPDFException",{enumerable:!0,get:function(){return e.InvalidPDFException}}),Object.defineProperty(t,"MissingPDFException",{enumerable:!0,get:function(){return e.MissingPDFException}}),Object.defineProperty(t,"OPS",{enumerable:!0,get:function(){return e.OPS}}),Object.defineProperty(t,"PDFDataRangeTransport",{enumerable:!0,get:function(){return s.PDFDataRangeTransport}}),Object.defineProperty(t,"PDFDateString",{enumerable:!0,get:function(){return n.PDFDateString}}),Object.defineProperty(t,"PDFWorker",{enumerable:!0,get:function(){return s.PDFWorker}}),Object.defineProperty(t,"PasswordResponses",{enumerable:!0,get:function(){return e.PasswordResponses}}),Object.defineProperty(t,"PermissionFlag",{enumerable:!0,get:function(){return e.PermissionFlag}}),Object.defineProperty(t,"PixelsPerInch",{enumerable:!0,get:function(){return n.PixelsPerInch}}),Object.defineProperty(t,"PromiseCapability",{enumerable:!0,get:function(){return e.PromiseCapability}}),Object.defineProperty(t,"RenderingCancelledException",{enumerable:!0,get:function(){return n.RenderingCancelledException}}),Object.defineProperty(t,"SVGGraphics",{enumerable:!0,get:function(){return s.SVGGraphics}}),Object.defineProperty(t,"UnexpectedResponseException",{enumerable:!0,get:function(){return e.UnexpectedResponseException}}),Object.defineProperty(t,"Util",{enumerable:!0,get:function(){return e.Util}}),Object.defineProperty(t,"VerbosityLevel",{enumerable:!0,get:function(){return e.VerbosityLevel}}),Object.defineProperty(t,"XfaLayer",{enumerable:!0,get:function(){return c.XfaLayer}}),Object.defineProperty(t,"build",{enumerable:!0,get:function(){return s.build}}),Object.defineProperty(t,"createValidAbsoluteUrl",{enumerable:!0,get:function(){return e.createValidAbsoluteUrl}}),Object.defineProperty(t,"getDocument",{enumerable:!0,get:function(){return s.getDocument}}),Object.defineProperty(t,"getFilenameFromUrl",{enumerable:!0,get:function(){return n.getFilenameFromUrl}}),Object.defineProperty(t,"getPdfFilenameFromUrl",{enumerable:!0,get:function(){return n.getPdfFilenameFromUrl}}),Object.defineProperty(t,"getXfaPageViewport",{enumerable:!0,get:function(){return n.getXfaPageViewport}}),Object.defineProperty(t,"isDataScheme",{enumerable:!0,get:function(){return n.isDataScheme}}),Object.defineProperty(t,"isPdfFile",{enumerable:!0,get:function(){return n.isPdfFile}}),Object.defineProperty(t,"loadScript",{enumerable:!0,get:function(){return n.loadScript}}),Object.defineProperty(t,"noContextMenu",{enumerable:!0,get:function(){return n.noContextMenu}}),Object.defineProperty(t,"normalizeUnicode",{enumerable:!0,get:function(){return e.normalizeUnicode}}),Object.defineProperty(t,"renderTextLayer",{enumerable:!0,get:function(){return r.renderTextLayer}}),Object.defineProperty(t,"setLayerDimensions",{enumerable:!0,get:function(){return n.setLayerDimensions}}),Object.defineProperty(t,"shadow",{enumerable:!0,get:function(){return e.shadow}}),Object.defineProperty(t,"updateTextLayer",{enumerable:!0,get:function(){return r.updateTextLayer}}),Object.defineProperty(t,"version",{enumerable:!0,get:function(){return s.version}});var e=__w_pdfjs_require__(1),s=__w_pdfjs_require__(2),n=__w_pdfjs_require__(6),r=__w_pdfjs_require__(26),a=__w_pdfjs_require__(27),i=__w_pdfjs_require__(5),u=__w_pdfjs_require__(29),f=__w_pdfjs_require__(14),c=__w_pdfjs_require__(32)})(),__webpack_exports__})())})(pdf$1);var pdfExports=pdf$1.exports;const pdf=getDefaultExportFromCjs(pdfExports),PDFJS=_mergeNamespaces({__proto__:null,default:pdf},[pdfExports]),pdfjsWorker=new URL("pdfjs-dist/build/pdf.worker.js",self.location.href).toString();pdfExports.GlobalWorkerOptions.workerSrc=pdfjsWorker;const pdfDist=PDFJS,getPdf=async t=>{const e=pdfDist.getDocument({data:t,useWorkerFetch:!1,isEvalSupported:!1,useSystemFonts:!0});return e.onPassword=n=>{const r=prompt("Enter the password: ");if(!r)throw new Error("Password required to open the PDF.");n(r)},await e.promise},isTweet=t=>{const e=/twitter\.com\/[a-zA-Z0-9_]+\/status\/[0-9]+/g,s=/x\.com\/[a-zA-Z0-9_]+\/status\/[0-9]+/g;return e.test(t)||s.test(t)},isTwitterTimeline=t=>t==="https://twitter.com/home"||t==="https://x.com/home",parseTwitterTimeline=t=>{const e=load(t),s=e("[data-testid=tweetText]"),n=e("[data-testid=User-Name]");return s.map((a,i)=>{const u=e(i).text();return{author:e(n[a]).text(),post:u}}).get().map(a=>`## Author: ${a.author}

${a.post}

---

`).filter((a,i,u)=>u.indexOf(a)===i).join(`
`)},parseTweet=t=>{const e=load(t),s=e("[data-testid=tweetText]"),n=e("[data-testid=User-Name]");return s.map((a,i)=>{const u=e(i).text();return{author:e(n[a]).text(),post:u,isReply:a!==0}}).get().map(a=>`##Author: ${a.author}

${a.isReply?"Reply:":"Post:"} ${a.post}

---

`).join(`
`)},isGoogleDocs=t=>/docs\.google\.com\/document/g.test(t),getGoogleDocs=()=>{try{const e=function(s,n,r,a=Object.getOwnPropertyNames(s)){const i=new Set,u=[];let f=0;const c=(d,h,m,_=0)=>{if(f++,d==="prototype"||h instanceof Window||_>r)return;const p=[...m,d];try{if(n(d,h)){u.push({path:p,value:h});return}}catch{}h!=null&&!i.has(h)&&(i.add(h),Array.isArray(h)?h.forEach((b,A)=>{try{c(A.toString(),b,p,_+1)}catch{}}):h instanceof Object&&(h&&h.nodeType===1&&typeof h.nodeName=="string"?Object.getOwnPropertyNames(s):Object.getOwnPropertyNames(h)).forEach(A=>{try{c(A,h[A],p,_+1)}catch{}}))};return a.forEach(d=>{try{c(d,s[d],[])}catch{}}),{results:u,iterations:f}}(window.KX_kixApp,(s,n)=>n&&n.toString().charAt(0)==="",5);return e.results?.[0]?.value?{content:e.results[0].value}:{content:null}}catch{return{content:null}}},parseGoogleDocs=async()=>{const t=new Promise(s=>{chrome.tabs.query({active:!0,currentWindow:!0},async n=>{const r=n[0],a=await chrome.scripting.executeScript({target:{tabId:r.id},world:"MAIN",func:getGoogleDocs});a.length>0&&s(a[0].result)})}),{content:e}=await t;return e},cleanUnwantedUnicode=t=>{const e=/[\u200B-\u200D\uFEFF]/g;return t.replace(e,"").trim()};var base64Js={},hasRequiredBase64Js;function requireBase64Js(){if(hasRequiredBase64Js)return base64Js;hasRequiredBase64Js=1,base64Js.byteLength=u,base64Js.toByteArray=c,base64Js.fromByteArray=m;for(var t=[],e=[],s=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=0,a=n.length;r<a;++r)t[r]=n[r],e[n.charCodeAt(r)]=r;e[45]=62,e[95]=63;function i(_){var p=_.length;if(p%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var b=_.indexOf("=");b===-1&&(b=p);var A=b===p?0:4-b%4;return[b,A]}function u(_){var p=i(_),b=p[0],A=p[1];return(b+A)*3/4-A}function f(_,p,b){return(p+b)*3/4-b}function c(_){var p,b=i(_),A=b[0],T=b[1],v=new s(f(_,A,T)),N=0,x=T>0?A-4:A,y;for(y=0;y<x;y+=4)p=e[_.charCodeAt(y)]<<18|e[_.charCodeAt(y+1)]<<12|e[_.charCodeAt(y+2)]<<6|e[_.charCodeAt(y+3)],v[N++]=p>>16&255,v[N++]=p>>8&255,v[N++]=p&255;return T===2&&(p=e[_.charCodeAt(y)]<<2|e[_.charCodeAt(y+1)]>>4,v[N++]=p&255),T===1&&(p=e[_.charCodeAt(y)]<<10|e[_.charCodeAt(y+1)]<<4|e[_.charCodeAt(y+2)]>>2,v[N++]=p>>8&255,v[N++]=p&255),v}function d(_){return t[_>>18&63]+t[_>>12&63]+t[_>>6&63]+t[_&63]}function h(_,p,b){for(var A,T=[],v=p;v<b;v+=3)A=(_[v]<<16&16711680)+(_[v+1]<<8&65280)+(_[v+2]&255),T.push(d(A));return T.join("")}function m(_){for(var p,b=_.length,A=b%3,T=[],v=16383,N=0,x=b-A;N<x;N+=v)T.push(h(_,N,N+v>x?x:N+v));return A===1?(p=_[b-1],T.push(t[p>>2]+t[p<<4&63]+"==")):A===2&&(p=(_[b-2]<<8)+_[b-1],T.push(t[p>>10]+t[p>>4&63]+t[p<<2&63]+"=")),T.join("")}return base64Js}const _getHtml=()=>{const t=window.location.href,e=document.title,s=document.querySelector('link[rel="icon"]')?.getAttribute("href")||document.querySelector('link[rel="shortcut icon"]')?.getAttribute("href")||`${window.location.origin}/favicon.ico`;return document.contentType==="application/pdf"?{url:t,title:e,content:"",type:"pdf",favicon:s}:{content:document.documentElement.outerHTML,url:t,title:e,type:"html",favicon:s}},getDataFromSpecificTab=async t=>{logger$1.debug("开始获取指定标签页内容",{tabId:t});const e=await new Promise((f,c)=>{try{logger$1.debug("使用 Chrome/Edge API 获取指定标签页内容",{tabId:t}),chrome.scripting.executeScript({target:{tabId:t},func:_getHtml}).then(d=>{d&&d.length>0?(logger$1.debug("成功执行内容脚本获取HTML",{tabId:t,resultType:d[0].result.type,contentLength:d[0].result.content?.length}),f(d[0].result)):(logger$1.error("内容脚本执行结果为空",{tabId:t}),c(new Error("内容脚本执行结果为空")))}).catch(d=>{logger$1.error("执行内容脚本失败",{tabId:t,error:d}),c(d)})}catch(d){logger$1.error("获取指定标签页内容时发生异常",{tabId:t,error:d}),c(d)}});logger$1.debug("成功获取指定标签页基本数据",{tabId:t,url:e.url,title:e.title,type:e.type});const{content:s,type:n,url:r,title:a,favicon:i}=e;if(n==="pdf"){logger$1.debug("检测到PDF文件，开始处理PDF内容",{tabId:t,url:r});try{const f=await fetch(r);if(!f.ok)throw logger$1.error("获取PDF文件失败",{tabId:t,status:f.status,statusText:f.statusText}),new Error(`获取PDF文件失败: ${f.status} ${f.statusText}`);const c=await f.arrayBuffer();logger$1.debug("成功获取PDF文件数据",{tabId:t,dataSize:c.byteLength});let d=[];const h=await getPdf(c);logger$1.info("成功解析PDF文件",{tabId:t,numPages:h.numPages});for(let m=1;m<=h.numPages;m+=1){logger$1.debug(`处理PDF第${m}页`,{tabId:t});const p=await(await h.getPage(m)).getTextContent();if(!p||p.items.length===0){logger$1.debug(`PDF第${m}页没有文本内容，跳过`,{tabId:t});continue}const b=p.items.map(A=>A.str).join(`
`).replace(/\x00/g,"").trim();d.push({content:b,page:m}),logger$1.debug(`成功提取PDF第${m}页文本`,{tabId:t,textLength:b.length})}return logger$1.info("PDF处理完成",{tabId:t,totalPages:d.length}),{url:r,title:a,content:"",pdf:d,type:"pdf",favicon:i}}catch(f){return logger$1.error("处理PDF文件时出错",{tabId:t,error:f}),{url:r,title:a,content:"PDF处理失败，无法提取内容",pdf:[],type:"pdf",favicon:i}}}if(isTwitterTimeline(r)){logger$1.debug("检测到Twitter时间线页面，使用专用解析器",{tabId:t,url:r});const f=parseTwitterTimeline(s);return logger$1.info("成功解析Twitter时间线内容",{tabId:t,contentLength:f?.length}),{url:r,title:a,content:f,type:"html",pdf:[],favicon:i}}else if(isTweet(r)){logger$1.debug("检测到Twitter推文页面，使用专用解析器",{tabId:t,url:r});const f=parseTweet(s);return logger$1.info("成功解析Twitter推文内容",{tabId:t,contentLength:f?.length}),{url:r,title:a,content:f,type:"html",pdf:[],favicon:i}}else if(isGoogleDocs(r)){logger$1.debug("检测到Google Docs文档，使用专用解析器",{tabId:t,url:r});try{const f=await parseGoogleDocs();if(f){const c=cleanUnwantedUnicode(f);return logger$1.info("成功解析Google Docs内容",{tabId:t,contentLength:c?.length}),{url:r,title:a,content:c,type:"html",pdf:[],favicon:i}}else logger$1.warn("Google Docs解析返回空内容",{tabId:t})}catch(f){logger$1.error("解析Google Docs内容失败",{tabId:t,error:f})}}logger$1.debug("使用默认内容提取器处理页面",{tabId:t,url:r,contentLength:s?.length});const u=defaultExtractContent(s);return logger$1.info("成功提取页面内容",{tabId:t,extractedContentLength:u?.length}),{url:r,title:a,content:u,type:n,pdf:[],favicon:i}},getDataFromCurrentTab=async()=>{logger$1.debug("开始获取当前标签页内容");const t=await new Promise((u,f)=>{logger$1.debug("使用 Chrome/Edge API 获取标签页内容"),chrome.tabs.query({active:!0,currentWindow:!0},async c=>{if(!c||c.length===0){logger$1.error("无法获取当前标签页"),f(new Error("无法获取当前标签页"));return}const d=c[0];if(logger$1.debug("获取到当前标签页",{tabId:d.id,url:d.url}),!d.id){logger$1.error("标签页ID无效"),f(new Error("标签页ID无效"));return}try{const h=await chrome.scripting.executeScript({target:{tabId:d.id},func:_getHtml});h&&h.length>0?(logger$1.debug("成功执行内容脚本获取HTML",{resultType:h[0].result.type,contentLength:h[0].result.content?.length}),u(h[0].result)):(logger$1.error("内容脚本执行结果为空"),f(new Error("内容脚本执行结果为空")))}catch(h){logger$1.error("执行内容脚本失败",h),f(h)}})});logger$1.debug("成功获取页面基本数据",{url:t.url,title:t.title,type:t.type});const{content:e,type:s,url:n,title:r,favicon:a}=t;if(s==="pdf"){logger$1.debug("检测到PDF文件，开始处理PDF内容",{url:n});try{const u=await fetch(n);if(!u.ok)throw logger$1.error("获取PDF文件失败",{status:u.status,statusText:u.statusText}),new Error(`获取PDF文件失败: ${u.status} ${u.statusText}`);const f=await u.arrayBuffer();logger$1.debug("成功获取PDF文件数据",{dataSize:f.byteLength});let c=[];const d=await getPdf(f);logger$1.info("成功解析PDF文件",{numPages:d.numPages});for(let h=1;h<=d.numPages;h+=1){logger$1.debug(`处理PDF第${h}页`);const _=await(await d.getPage(h)).getTextContent();if(!_||_.items.length===0){logger$1.debug(`PDF第${h}页没有文本内容，跳过`);continue}const p=_.items.map(b=>b.str).join(`
`).replace(/\x00/g,"").trim();c.push({content:p,page:h}),logger$1.debug(`成功提取PDF第${h}页文本`,{textLength:p.length})}return logger$1.info("PDF处理完成",{totalPages:c.length}),{url:n,title:r,content:"",pdf:c,type:"pdf",favicon:a}}catch(u){return logger$1.error("处理PDF文件时出错",u),{url:n,title:r,content:"PDF处理失败，无法提取内容",pdf:[],type:"pdf",favicon:a}}}if(isTwitterTimeline(n)){logger$1.debug("检测到Twitter时间线页面，使用专用解析器",{url:n});const u=parseTwitterTimeline(e);return logger$1.info("成功解析Twitter时间线内容",{contentLength:u?.length}),{url:n,title:r,content:u,type:"html",pdf:[],favicon:a}}else if(isTweet(n)){logger$1.debug("检测到Twitter推文页面，使用专用解析器",{url:n});const u=parseTweet(e);return logger$1.info("成功解析Twitter推文内容",{contentLength:u?.length}),{url:n,title:r,content:u,type:"html",pdf:[],favicon:a}}else if(isGoogleDocs(n)){logger$1.debug("检测到Google Docs文档，使用专用解析器",{url:n});try{const u=await parseGoogleDocs();if(u){const f=cleanUnwantedUnicode(u);return logger$1.info("成功解析Google Docs内容",{contentLength:f?.length}),{url:n,title:r,content:f,type:"html",pdf:[],favicon:a}}else logger$1.warn("Google Docs解析返回空内容")}catch(u){logger$1.error("解析Google Docs内容失败",u)}}logger$1.debug("使用默认内容提取器处理页面",{url:n,contentLength:e?.length});const i=defaultExtractContent(e);return logger$1.info("成功提取页面内容",{extractedContentLength:i?.length}),{url:n,title:r,content:i,type:s,pdf:[],favicon:a}};class ScreenshotThrottler{queue=[];isProcessing=!1;lastCaptureTime=0;maxRequestsPerSecond=2;requestInterval=Math.ceil(1e3/this.maxRequestsPerSecond);enqueue(e,s){return new Promise((n,r)=>{const a={tabId:e,options:s,resolve:n,reject:r,timestamp:Date.now()};this.queue.push(a),logger$1.debug("截图请求已加入队列",{queueLength:this.queue.length}),this.isProcessing||this.processQueue()})}async processQueue(){if(this.queue.length===0){this.isProcessing=!1;return}this.isProcessing=!0;const e=this.queue.shift();if(!e){this.isProcessing=!1;return}const n=Date.now()-this.lastCaptureTime,r=Math.max(0,this.requestInterval-n);r>0&&(logger$1.debug(`等待 ${r}ms 后执行截图请求，以避免超过配额限制`),await new Promise(a=>setTimeout(a,r)));try{const a=await this.captureVisibleTab(e.tabId,e.options);this.lastCaptureTime=Date.now(),e.resolve(a)}catch(a){logger$1.error("截图请求失败",a),e.reject(a instanceof Error?a:new Error(String(a)))}finally{setTimeout(()=>this.processQueue(),0)}}captureVisibleTab(e,s){return new Promise((n,r)=>{logger$1.debug("执行截图操作",{tabId:e,options:s}),chrome.tabs.captureVisibleTab(e,s,a=>{if(chrome.runtime.lastError){logger$1.error("Chrome 截图捕获失败",chrome.runtime.lastError),r(new Error(`截图捕获失败: ${chrome.runtime.lastError.message}`));return}if(!a){logger$1.error("截图数据为空"),r(new Error("截图数据为空"));return}logger$1.debug("成功捕获截图",{dataUrlLength:a.length}),n(a)})})}}const screenshotThrottler=new ScreenshotThrottler,captureSpecificTab=async t=>{logger$1.debug("开始捕获指定标签页截图",{tabId:t});try{logger$1.debug("通过截图节流管理器请求截图",{tabId:t});const e=await screenshotThrottler.enqueue(t,{format:"png"});return logger$1.debug("成功获取截图",{tabId:t,dataUrlLength:e.length}),e}catch(e){throw logger$1.error("截图过程中出错",{tabId:t,error:e}),e}},captureVisibleTab=async()=>{logger$1.debug("开始捕获当前标签页截图");try{let t;if(t=await new Promise(n=>{chrome.tabs.query({active:!0,currentWindow:!0},r=>{n(r)})}),!t||t.length===0)throw logger$1.error("无法获取当前标签页"),new Error("无法获取当前标签页");const e=t[0];logger$1.debug("获取到当前标签页",{tabId:e.id,url:e.url}),logger$1.debug("通过截图节流管理器请求截图");const s=await screenshotThrottler.enqueue(null,{format:"png"});return logger$1.debug("成功获取截图",{dataUrlLength:s.length}),s}catch(t){throw logger$1.error("截图过程中出错",t),t}},getScreenshotFromSpecificTab=async t=>{logger$1.info("开始获取指定标签页截图",{tabId:t});try{const e=await captureSpecificTab(t);return logger$1.info("成功获取截图",{tabId:t,dataUrlLength:e.length}),{success:!0,screenshot:e,error:null}}catch(e){const s=e instanceof Error?e.message:"截图捕获失败",n=s.includes("MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND");return n?logger$1.warn("截图配额限制错误，已通过节流管理器处理",{tabId:t,error:s}):logger$1.error("获取截图失败",{tabId:t,error:s}),{success:!1,screenshot:null,error:s,isQuotaError:n}}},getScreenshotFromCurrentTab=async()=>{logger$1.info("开始获取当前标签页截图");try{const t=await captureVisibleTab();return logger$1.info("成功获取截图",{dataUrlLength:t.length}),{success:!0,screenshot:t,error:null}}catch(t){const e=t instanceof Error?t.message:"截图捕获失败",s=e.includes("MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND");return s?logger$1.warn("截图配额限制错误，已通过节流管理器处理",{error:e}):logger$1.error("获取截图失败",{error:e}),{success:!1,screenshot:null,error:e,isQuotaError:s}}},DB_NAME="page-assist-saved-pages",DB_VERSION=1,STORE_NAME="pages",generateID=()=>"page_xxxx-xxxx-xxx-xxxx".replace(/[x]/g,()=>Math.floor(Math.random()*16).toString(16)),openDatabase=()=>(logger$1.debug(`正在打开数据库: ${DB_NAME}, 版本: ${DB_VERSION}`),new Promise((t,e)=>{const s=indexedDB.open(DB_NAME,DB_VERSION);s.onerror=n=>{const r=s.error;logger$1.error("打开数据库失败",{errorName:r?.name,errorMessage:r?.message}),e(new Error(`无法打开数据库: ${r?.message||"未知错误"}`))},s.onsuccess=n=>{logger$1.debug("数据库连接成功打开"),t(s.result)},s.onupgradeneeded=n=>{logger$1.info(`数据库升级: 从版本 ${n.oldVersion} 到 ${n.newVersion}`);const r=s.result;if(!r.objectStoreNames.contains(STORE_NAME)){logger$1.info(`创建存储对象: ${STORE_NAME}`);const a=r.createObjectStore(STORE_NAME,{keyPath:"id"});logger$1.debug("创建数据库索引"),a.createIndex("url","url",{unique:!1}),a.createIndex("createdAt","createdAt",{unique:!1}),a.createIndex("updatedAt","updatedAt",{unique:!1}),a.createIndex("tags","tags",{unique:!1,multiEntry:!0}),logger$1.info("数据库结构初始化完成")}}}));class SavedPagesDB{async savePage(e){logger$1.debug("开始保存页面到数据库",{title:e.title,url:e.url,type:e.type,contentLength:e.content?.length,htmlLength:e.html?.length,hasScreenshot:!!e.screenshot});try{const s=await this.getPageByUrl(e.url);if(s){logger$1.info("URL已存在，将更新现有记录",{url:e.url,existingId:s.id});const r=await this.updatePage(s.id,{title:e.title,tags:e.tags,notes:e.notes,summary:e.summary,rating:e.rating,content:e.content,html:e.html,type:e.type,favicon:e.favicon,screenshot:e.screenshot});return logger$1.info("成功更新现有页面",{id:r.id,url:r.url}),r}const n=await openDatabase();return new Promise((r,a)=>{const i=n.transaction([STORE_NAME],"readwrite"),u=i.objectStore(STORE_NAME);i.onerror=m=>{const _=i.error;logger$1.error("数据库事务错误",{errorName:_?.name,errorMessage:_?.message}),a(new Error(`数据库事务错误: ${_?.message||"未知错误"}`))};const f=Date.now(),c=generateID();logger$1.debug(`生成页面ID: ${c}`);const d={id:c,title:e.title,url:e.url,content:e.content,html:e.html,type:e.type,tags:e.tags||[],notes:e.notes||"",summary:e.summary,rating:e.rating,createdAt:f,updatedAt:f,favicon:e.favicon,screenshot:e.screenshot};logger$1.debug("准备添加新页面到数据库",{id:d.id});const h=u.add(d);h.onsuccess=()=>{logger$1.info("新页面成功保存到数据库",{id:d.id,title:d.title}),syncHooks.page.afterCreate(d),r(d)},h.onerror=()=>{const m=h.error;logger$1.error("保存页面失败",{errorName:m?.name,errorMessage:m?.message}),a(new Error(`保存页面失败: ${m?.message||"未知错误"}`))},i.oncomplete=()=>{logger$1.debug("数据库事务完成，关闭数据库连接"),n.close()}})}catch(s){throw logger$1.error("保存页面过程中发生错误",s),s}}async getAllPages(e){const s=await openDatabase();return new Promise((n,r)=>{const a=s.transaction([STORE_NAME],"readonly"),f=a.objectStore(STORE_NAME).index("updatedAt").openCursor(null,"prev"),c=[];f.onsuccess=d=>{const h=f.result;if(h){const m=h.value;let _=!0;if(e&&(e.tags&&e.tags.length>0&&(_=e.tags.some(p=>m.tags.includes(p))),_&&e.searchText)){const p=e.searchText.toLowerCase();_=m.title.toLowerCase().includes(p)||m.content.toLowerCase().includes(p)||m.notes.toLowerCase().includes(p)}_&&c.push(m),h.continue()}else if(e&&(e.offset!==void 0||e.limit!==void 0)){const m=e.offset||0,_=e.limit||c.length;n(c.slice(m,m+_))}else n(c)},f.onerror=()=>{r(new Error("获取页面失败"))},a.oncomplete=()=>{s.close()}})}async getPageById(e){const s=await openDatabase();return new Promise((n,r)=>{const a=s.transaction([STORE_NAME],"readonly"),u=a.objectStore(STORE_NAME).get(e);u.onsuccess=()=>{n(u.result||null)},u.onerror=()=>{r(new Error("获取页面失败"))},a.oncomplete=()=>{s.close()}})}async getPageByUrl(e){logger$1.debug("根据URL查找页面",{url:e});try{const n=(await this.getAllPages()).find(r=>r.url===e);return n?(logger$1.debug("找到完全匹配的页面",{id:n.id,url:e}),n):(logger$1.debug("未找到匹配的页面",{url:e}),null)}catch(s){return logger$1.error("根据URL查找页面失败",s),null}}async updatePage(e,s){const n=await openDatabase();return new Promise(async(r,a)=>{const i=n.transaction([STORE_NAME],"readwrite"),u=i.objectStore(STORE_NAME),f=u.get(e);f.onsuccess=()=>{if(!f.result){a(new Error("页面不存在"));return}const d={...f.result,...s,updatedAt:Date.now()},h=u.put(d);h.onsuccess=()=>{syncHooks.page.afterUpdate(d),r(d)},h.onerror=()=>{a(new Error("更新页面失败"))}},f.onerror=()=>{a(new Error("获取页面失败"))},i.oncomplete=()=>{n.close()}})}async deletePage(e){const s=await openDatabase();return new Promise((n,r)=>{const a=s.transaction([STORE_NAME],"readwrite"),u=a.objectStore(STORE_NAME).delete(e);u.onsuccess=()=>{syncHooks.page.afterDelete(e),n()},u.onerror=()=>{r(new Error("删除页面失败"))},a.oncomplete=()=>{s.close()}})}async getAllTags(){const e=await this.getAllPages(),s=new Set;return e.forEach(n=>{n.tags.forEach(r=>s.add(r))}),Array.from(s)}async getPageCount(e){logger$1.debug("获取页面计数",{filter:e});try{const s={};return e&&e.tags&&(s.tags=Array.isArray(e.tags)?e.tags:[e.tags]),e&&e.searchText&&(s.searchText=e.searchText),(await this.getAllPages(s)).length}catch(s){throw logger$1.error("获取页面计数失败",s),s}}async getPagesForSync(e,s,n=!1){logger$1.debug("获取需要同步的页面",{lastSyncTime:e,maxRecords:s,metadataOnly:n});try{const r=await openDatabase();return new Promise((a,i)=>{const u=r.transaction([STORE_NAME],"readonly"),c=u.objectStore(STORE_NAME).index("updatedAt"),d=IDBKeyRange.lowerBound(e,!1),h=c.openCursor(d),m=[];h.onsuccess=_=>{const p=h.result;if(p){const b=p.value;n?m.push({id:b.id,title:b.title,url:b.url,tags:b.tags,createdAt:b.createdAt,updatedAt:b.updatedAt}):m.push(b),m.length<s?p.continue():(logger$1.debug(`已达到最大记录数 ${s}，停止获取更多记录`),a(m))}else logger$1.debug(`获取到 ${m.length} 条需要同步的页面`),a(m)},h.onerror=()=>{const _=h.error;logger$1.error("获取需要同步的页面失败",{errorName:_?.name,errorMessage:_?.message}),i(new Error(`获取需要同步的页面失败: ${_?.message||"未知错误"}`))},u.oncomplete=()=>{logger$1.debug("数据库事务完成，关闭数据库连接"),r.close()}})}catch(r){throw logger$1.error("获取需要同步的页面过程中发生错误",r),r}}}const savedPagesDB=new SavedPagesDB;var decamelize=function(t,e){if(typeof t!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,t.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const snakeCase=getDefaultExportFromCjs(decamelize);var camelcase={exports:{}};const UPPERCASE=/[\p{Lu}]/u,LOWERCASE=/[\p{Ll}]/u,LEADING_CAPITAL=/^[\p{Lu}](?![\p{Lu}])/gu,IDENTIFIER=/([\p{Alpha}\p{N}_]|$)/u,SEPARATORS=/[_.\- ]+/,LEADING_SEPARATORS=new RegExp("^"+SEPARATORS.source),SEPARATORS_AND_IDENTIFIER=new RegExp(SEPARATORS.source+IDENTIFIER.source,"gu"),NUMBERS_AND_IDENTIFIER=new RegExp("\\d+"+IDENTIFIER.source,"gu"),preserveCamelCase=(t,e,s)=>{let n=!1,r=!1,a=!1;for(let i=0;i<t.length;i++){const u=t[i];n&&UPPERCASE.test(u)?(t=t.slice(0,i)+"-"+t.slice(i),n=!1,a=r,r=!0,i++):r&&a&&LOWERCASE.test(u)?(t=t.slice(0,i-1)+"-"+t.slice(i-1),a=r,r=!1,n=!0):(n=e(u)===u&&s(u)!==u,a=r,r=s(u)===u&&e(u)!==u)}return t},preserveConsecutiveUppercase=(t,e)=>(LEADING_CAPITAL.lastIndex=0,t.replace(LEADING_CAPITAL,s=>e(s))),postProcess=(t,e)=>(SEPARATORS_AND_IDENTIFIER.lastIndex=0,NUMBERS_AND_IDENTIFIER.lastIndex=0,t.replace(SEPARATORS_AND_IDENTIFIER,(s,n)=>e(n)).replace(NUMBERS_AND_IDENTIFIER,s=>e(s))),camelCase=(t,e)=>{if(!(typeof t=="string"||Array.isArray(t)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(t)?t=t.map(a=>a.trim()).filter(a=>a.length).join("-"):t=t.trim(),t.length===0)return"";const s=e.locale===!1?a=>a.toLowerCase():a=>a.toLocaleLowerCase(e.locale),n=e.locale===!1?a=>a.toUpperCase():a=>a.toLocaleUpperCase(e.locale);return t.length===1?e.pascalCase?n(t):s(t):(t!==s(t)&&(t=preserveCamelCase(t,s,n)),t=t.replace(LEADING_SEPARATORS,""),e.preserveConsecutiveUppercase?t=preserveConsecutiveUppercase(t,s):t=s(t),e.pascalCase&&(t=n(t.charAt(0))+t.slice(1)),postProcess(t,n))};camelcase.exports=camelCase,camelcase.exports.default=camelCase;function keyToJson(t,e){return e?.[t]||snakeCase(t)}function mapKeys(t,e,s){const n={};for(const r in t)Object.hasOwn(t,r)&&(n[e(r,s)]=t[r]);return n}function shallowCopy(t){return Array.isArray(t)?[...t]:{...t}}function replaceSecrets(t,e){const s=shallowCopy(t);for(const[n,r]of Object.entries(e)){const[a,...i]=n.split(".").reverse();let u=s;for(const f of i.reverse()){if(u[f]===void 0)break;u[f]=shallowCopy(u[f]),u=u[f]}u[a]!==void 0&&(u[a]={lc:1,type:"secret",id:[r]})}return s}function get_lc_unique_name(t){const e=Object.getPrototypeOf(t);return typeof t.lc_name=="function"&&(typeof e.lc_name!="function"||t.lc_name()!==e.lc_name())?t.lc_name():t.name}class Serializable{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,get_lc_unique_name(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...s){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Serializable||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},s={},n=Object.keys(this.lc_kwargs).reduce((r,a)=>(r[a]=a in this?this[a]:this.lc_kwargs[a],r),{});for(let r=Object.getPrototypeOf(this);r;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r,"lc_aliases",this)),Object.assign(s,Reflect.get(r,"lc_secrets",this)),Object.assign(n,Reflect.get(r,"lc_attributes",this));return Object.keys(s).forEach(r=>{let a=this,i=n;const[u,...f]=r.split(".").reverse();for(const c of f.reverse()){if(!(c in a)||a[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof a[c]=="object"&&a[c]!=null?i[c]={}:Array.isArray(a[c])&&(i[c]=[])),a=a[c],i=i[c]}u in a&&a[u]!==void 0&&(i[u]=i[u]||a[u])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:mapKeys(Object.keys(s).length?replaceSecrets(n,s):n,keyToJson,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function mergeContent(t,e){return typeof t=="string"?typeof e=="string"?t+e:[{type:"text",text:t},...e]:Array.isArray(e)?[...t,...e]:[...t,{type:"text",text:e}]}class BaseMessage extends Serializable{get lc_aliases(){return{additional_kwargs:"additional_kwargs"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,s){typeof e=="string"&&(e={content:e,additional_kwargs:s}),e.additional_kwargs||(e.additional_kwargs={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}toChunk(){const e=this._getType();if(e==="human")return new HumanMessageChunk({...this});if(e==="ai")return new AIMessageChunk({...this});if(e==="system")return new SystemMessageChunk({...this});if(e==="function")return new FunctionMessageChunk({...this});if(ChatMessage.isInstance(this))return new ChatMessageChunk({...this});throw new Error("Unknown message type.")}}function isOpenAIToolCallArray(t){return Array.isArray(t)&&t.every(e=>typeof e.index=="number")}class BaseMessageChunk extends BaseMessage{static _mergeAdditionalKwargs(e,s){const n={...e};for(const[r,a]of Object.entries(s))if(n[r]===void 0)n[r]=a;else{if(typeof n[r]!=typeof a)throw new Error(`additional_kwargs[${r}] already exists in the message chunk, but with a different type.`);if(typeof n[r]=="string")n[r]=n[r]+a;else if(!Array.isArray(n[r])&&typeof n[r]=="object")n[r]=this._mergeAdditionalKwargs(n[r],a);else if(r==="tool_calls"&&isOpenAIToolCallArray(n[r])&&isOpenAIToolCallArray(a))for(const i of a)n[r]?.[i.index]!==void 0?n[r]=n[r]?.map((u,f)=>f!==i.index?u:{...u,...i,function:{name:i.function.name??u.function.name,arguments:(u.function.arguments??"")+(i.function.arguments??"")}}):n[r][i.index]=i;else throw new Error(`additional_kwargs[${r}] already exists in this message chunk.`)}return n}}class HumanMessage extends BaseMessage{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class HumanMessageChunk extends BaseMessageChunk{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new HumanMessageChunk({content:mergeContent(this.content,e.content),additional_kwargs:HumanMessageChunk._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class AIMessage extends BaseMessage{static lc_name(){return"AIMessage"}_getType(){return"ai"}}class AIMessageChunk extends BaseMessageChunk{static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){return new AIMessageChunk({content:mergeContent(this.content,e.content),additional_kwargs:AIMessageChunk._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class SystemMessage extends BaseMessage{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class SystemMessageChunk extends BaseMessageChunk{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new SystemMessageChunk({content:mergeContent(this.content,e.content),additional_kwargs:SystemMessageChunk._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class FunctionMessageChunk extends BaseMessageChunk{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new FunctionMessageChunk({content:mergeContent(this.content,e.content),additional_kwargs:FunctionMessageChunk._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),name:this.name??""})}}class ToolMessageChunk extends BaseMessageChunk{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new ToolMessageChunk({content:mergeContent(this.content,e.content),additional_kwargs:ToolMessageChunk._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),tool_call_id:this.tool_call_id})}}class ChatMessage extends BaseMessage{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return ChatMessage}constructor(e,s){typeof e=="string"&&(e={content:e,role:s}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}}function isBaseMessage(t){return typeof t?._getType=="function"}function isBaseMessageChunk(t){return isBaseMessage(t)&&typeof t.concat=="function"}function coerceMessageLikeToMessage(t){if(typeof t=="string")return new HumanMessage(t);if(isBaseMessage(t))return t;const[e,s]=t;if(e==="human"||e==="user")return new HumanMessage({content:s});if(e==="ai"||e==="assistant")return new AIMessage({content:s});if(e==="system")return new SystemMessage({content:s});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}class ChatMessageChunk extends BaseMessageChunk{static lc_name(){return"ChatMessageChunk"}constructor(e,s){typeof e=="string"&&(e={content:e,role:s}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new ChatMessageChunk({content:mergeContent(this.content,e.content),additional_kwargs:ChatMessageChunk._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),role:this.role})}}function getBufferString(t,e="Human",s="AI"){const n=[];for(const r of t){let a;if(r._getType()==="human")a=e;else if(r._getType()==="ai")a=s;else if(r._getType()==="system")a="System";else if(r._getType()==="function")a="Function";else if(r._getType()==="tool")a="Tool";else if(r._getType()==="generic")a=r.role;else throw new Error(`Got unsupported message type: ${r._getType()}`);const i=r.name?`${r.name}, `:"";n.push(`${a}: ${i}${r.content}`)}return n.join(`
`)}const RUN_KEY="__run";class GenerationChunk{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new GenerationChunk({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class ChatGenerationChunk extends GenerationChunk{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new ChatGenerationChunk({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */var root=typeof window=="object"?window:{},HEX_CHARS="0123456789abcdef".split(""),EXTRA=[-2147483648,8388608,32768,128],SHIFT=[24,16,8,0],blocks=[];function Sha1(t){t?(blocks[0]=blocks[16]=blocks[1]=blocks[2]=blocks[3]=blocks[4]=blocks[5]=blocks[6]=blocks[7]=blocks[8]=blocks[9]=blocks[10]=blocks[11]=blocks[12]=blocks[13]=blocks[14]=blocks[15]=0,this.blocks=blocks):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Sha1.prototype.update=function(t){if(!this.finalized){var e=typeof t!="string";e&&t.constructor===root.ArrayBuffer&&(t=new Uint8Array(t));for(var s,n=0,r,a=t.length||0,i=this.blocks;n<a;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(r=this.start;n<a&&r<64;++n)i[r>>2]|=t[n]<<SHIFT[r++&3];else for(r=this.start;n<a&&r<64;++n)s=t.charCodeAt(n),s<128?i[r>>2]|=s<<SHIFT[r++&3]:s<2048?(i[r>>2]|=(192|s>>6)<<SHIFT[r++&3],i[r>>2]|=(128|s&63)<<SHIFT[r++&3]):s<55296||s>=57344?(i[r>>2]|=(224|s>>12)<<SHIFT[r++&3],i[r>>2]|=(128|s>>6&63)<<SHIFT[r++&3],i[r>>2]|=(128|s&63)<<SHIFT[r++&3]):(s=65536+((s&1023)<<10|t.charCodeAt(++n)&1023),i[r>>2]|=(240|s>>18)<<SHIFT[r++&3],i[r>>2]|=(128|s>>12&63)<<SHIFT[r++&3],i[r>>2]|=(128|s>>6&63)<<SHIFT[r++&3],i[r>>2]|=(128|s&63)<<SHIFT[r++&3]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=i[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Sha1.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>2]|=EXTRA[e&3],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}},Sha1.prototype.hash=function(){var t=this.h0,e=this.h1,s=this.h2,n=this.h3,r=this.h4,a,i,u,f=this.blocks;for(i=16;i<80;++i)u=f[i-3]^f[i-8]^f[i-14]^f[i-16],f[i]=u<<1|u>>>31;for(i=0;i<20;i+=5)a=e&s|~e&n,u=t<<5|t>>>27,r=u+a+r+1518500249+f[i]<<0,e=e<<30|e>>>2,a=t&e|~t&s,u=r<<5|r>>>27,n=u+a+n+1518500249+f[i+1]<<0,t=t<<30|t>>>2,a=r&t|~r&e,u=n<<5|n>>>27,s=u+a+s+1518500249+f[i+2]<<0,r=r<<30|r>>>2,a=n&r|~n&t,u=s<<5|s>>>27,e=u+a+e+1518500249+f[i+3]<<0,n=n<<30|n>>>2,a=s&n|~s&r,u=e<<5|e>>>27,t=u+a+t+1518500249+f[i+4]<<0,s=s<<30|s>>>2;for(;i<40;i+=5)a=e^s^n,u=t<<5|t>>>27,r=u+a+r+1859775393+f[i]<<0,e=e<<30|e>>>2,a=t^e^s,u=r<<5|r>>>27,n=u+a+n+1859775393+f[i+1]<<0,t=t<<30|t>>>2,a=r^t^e,u=n<<5|n>>>27,s=u+a+s+1859775393+f[i+2]<<0,r=r<<30|r>>>2,a=n^r^t,u=s<<5|s>>>27,e=u+a+e+1859775393+f[i+3]<<0,n=n<<30|n>>>2,a=s^n^r,u=e<<5|e>>>27,t=u+a+t+1859775393+f[i+4]<<0,s=s<<30|s>>>2;for(;i<60;i+=5)a=e&s|e&n|s&n,u=t<<5|t>>>27,r=u+a+r-1894007588+f[i]<<0,e=e<<30|e>>>2,a=t&e|t&s|e&s,u=r<<5|r>>>27,n=u+a+n-1894007588+f[i+1]<<0,t=t<<30|t>>>2,a=r&t|r&e|t&e,u=n<<5|n>>>27,s=u+a+s-1894007588+f[i+2]<<0,r=r<<30|r>>>2,a=n&r|n&t|r&t,u=s<<5|s>>>27,e=u+a+e-1894007588+f[i+3]<<0,n=n<<30|n>>>2,a=s&n|s&r|n&r,u=e<<5|e>>>27,t=u+a+t-1894007588+f[i+4]<<0,s=s<<30|s>>>2;for(;i<80;i+=5)a=e^s^n,u=t<<5|t>>>27,r=u+a+r-899497514+f[i]<<0,e=e<<30|e>>>2,a=t^e^s,u=r<<5|r>>>27,n=u+a+n-899497514+f[i+1]<<0,t=t<<30|t>>>2,a=r^t^e,u=n<<5|n>>>27,s=u+a+s-899497514+f[i+2]<<0,r=r<<30|r>>>2,a=n^r^t,u=s<<5|s>>>27,e=u+a+e-899497514+f[i+3]<<0,n=n<<30|n>>>2,a=s^n^r,u=e<<5|e>>>27,t=u+a+t-899497514+f[i+4]<<0,s=s<<30|s>>>2;this.h0=this.h0+t<<0,this.h1=this.h1+e<<0,this.h2=this.h2+s<<0,this.h3=this.h3+n<<0,this.h4=this.h4+r<<0},Sha1.prototype.hex=function(){this.finalize();var t=this.h0,e=this.h1,s=this.h2,n=this.h3,r=this.h4;return HEX_CHARS[t>>28&15]+HEX_CHARS[t>>24&15]+HEX_CHARS[t>>20&15]+HEX_CHARS[t>>16&15]+HEX_CHARS[t>>12&15]+HEX_CHARS[t>>8&15]+HEX_CHARS[t>>4&15]+HEX_CHARS[t&15]+HEX_CHARS[e>>28&15]+HEX_CHARS[e>>24&15]+HEX_CHARS[e>>20&15]+HEX_CHARS[e>>16&15]+HEX_CHARS[e>>12&15]+HEX_CHARS[e>>8&15]+HEX_CHARS[e>>4&15]+HEX_CHARS[e&15]+HEX_CHARS[s>>28&15]+HEX_CHARS[s>>24&15]+HEX_CHARS[s>>20&15]+HEX_CHARS[s>>16&15]+HEX_CHARS[s>>12&15]+HEX_CHARS[s>>8&15]+HEX_CHARS[s>>4&15]+HEX_CHARS[s&15]+HEX_CHARS[n>>28&15]+HEX_CHARS[n>>24&15]+HEX_CHARS[n>>20&15]+HEX_CHARS[n>>16&15]+HEX_CHARS[n>>12&15]+HEX_CHARS[n>>8&15]+HEX_CHARS[n>>4&15]+HEX_CHARS[n&15]+HEX_CHARS[r>>28&15]+HEX_CHARS[r>>24&15]+HEX_CHARS[r>>20&15]+HEX_CHARS[r>>16&15]+HEX_CHARS[r>>12&15]+HEX_CHARS[r>>8&15]+HEX_CHARS[r>>4&15]+HEX_CHARS[r&15]},Sha1.prototype.toString=Sha1.prototype.hex,Sha1.prototype.digest=function(){this.finalize();var t=this.h0,e=this.h1,s=this.h2,n=this.h3,r=this.h4;return[t>>24&255,t>>16&255,t>>8&255,t&255,e>>24&255,e>>16&255,e>>8&255,e&255,s>>24&255,s>>16&255,s>>8&255,s&255,n>>24&255,n>>16&255,n>>8&255,n&255,r>>24&255,r>>16&255,r>>8&255,r&255]},Sha1.prototype.array=Sha1.prototype.digest,Sha1.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(20),e=new DataView(t);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),t};const insecureHash=t=>new Sha1(!0).update(t).hex(),getCacheKey=(...t)=>insecureHash(t.join("_"));class BaseCache{}const GLOBAL_MAP=new Map;class InMemoryCache extends BaseCache{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,s){return Promise.resolve(this.cache.get(getCacheKey(e,s))??null)}async update(e,s,n){this.cache.set(getCacheKey(e,s),n)}static global(){return new InMemoryCache(GLOBAL_MAP)}}class BasePromptValue extends Serializable{}class StringPromptValue extends BasePromptValue{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new HumanMessage(this.value)]}}class ChatPromptValue extends BasePromptValue{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return getBufferString(this.messages)}toChatMessages(){return this.messages}}var pRetry$2={exports:{}},retry$2={};function RetryOperation(t,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(t)),this._timeouts=t,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var retry_operation=RetryOperation;RetryOperation.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},RetryOperation.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},RetryOperation.prototype.retry=function(t){if(this._timeout&&clearTimeout(this._timeout),!t)return!1;var e=new Date().getTime();if(t&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(t),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(t);var s=this._timeouts.shift();if(s===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),s=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},s),this._options.unref&&this._timer.unref(),!0},RetryOperation.prototype.attempt=function(t,e){this._fn=t,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var s=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){s._operationTimeoutCb()},s._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},RetryOperation.prototype.try=function(t){console.log("Using RetryOperation.try() is deprecated"),this.attempt(t)},RetryOperation.prototype.start=function(t){console.log("Using RetryOperation.start() is deprecated"),this.attempt(t)},RetryOperation.prototype.start=RetryOperation.prototype.try,RetryOperation.prototype.errors=function(){return this._errors},RetryOperation.prototype.attempts=function(){return this._attempts},RetryOperation.prototype.mainError=function(){if(this._errors.length===0)return null;for(var t={},e=null,s=0,n=0;n<this._errors.length;n++){var r=this._errors[n],a=r.message,i=(t[a]||0)+1;t[a]=i,i>=s&&(e=r,s=i)}return e},function(t){var e=retry_operation;t.operation=function(s){var n=t.timeouts(s);return new e(n,{forever:s&&(s.forever||s.retries===1/0),unref:s&&s.unref,maxRetryTime:s&&s.maxRetryTime})},t.timeouts=function(s){if(s instanceof Array)return[].concat(s);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var r in s)n[r]=s[r];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],i=0;i<n.retries;i++)a.push(this.createTimeout(i,n));return s&&s.forever&&!a.length&&a.push(this.createTimeout(i,n)),a.sort(function(u,f){return u-f}),a},t.createTimeout=function(s,n){var r=n.randomize?Math.random()+1:1,a=Math.round(r*Math.max(n.minTimeout,1)*Math.pow(n.factor,s));return a=Math.min(a,n.maxTimeout),a},t.wrap=function(s,n,r){if(n instanceof Array&&(r=n,n=null),!r){r=[];for(var a in s)typeof s[a]=="function"&&r.push(a)}for(var i=0;i<r.length;i++){var u=r[i],f=s[u];s[u]=function(d){var h=t.operation(n),m=Array.prototype.slice.call(arguments,1),_=m.pop();m.push(function(p){h.retry(p)||(p&&(arguments[0]=h.mainError()),_.apply(this,arguments))}),h.attempt(function(){d.apply(s,m)})}.bind(s,f),s[u].options=n}}}(retry$2);var retry$1=retry$2;const retry=retry$1,networkErrorMsgs=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class AbortError extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const decorateErrorWithCounts=(t,e,s)=>{const n=s.retries-(e-1);return t.attemptNumber=e,t.retriesLeft=n,t},isNetworkError=t=>networkErrorMsgs.includes(t),pRetry=(t,e)=>new Promise((s,n)=>{e={onFailedAttempt:()=>{},retries:10,...e};const r=retry.operation(e);r.attempt(async a=>{try{s(await t(a))}catch(i){if(!(i instanceof Error)){n(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof AbortError)r.stop(),n(i.originalError);else if(i instanceof TypeError&&!isNetworkError(i.message))r.stop(),n(i);else{decorateErrorWithCounts(i,a,e);try{await e.onFailedAttempt(i)}catch(u){n(u);return}r.retry(i)||n(r.mainError())}}})});pRetry$2.exports=pRetry,pRetry$2.exports.default=pRetry,pRetry$2.exports.AbortError=AbortError;var pRetryExports=pRetry$2.exports;const pRetry$1=getDefaultExportFromCjs(pRetryExports);var dist={},eventemitter3={exports:{}};(function(t){var e=Object.prototype.hasOwnProperty,s="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(s=!1));function r(f,c,d){this.fn=f,this.context=c,this.once=d||!1}function a(f,c,d,h,m){if(typeof d!="function")throw new TypeError("The listener must be a function");var _=new r(d,h||f,m),p=s?s+c:c;return f._events[p]?f._events[p].fn?f._events[p]=[f._events[p],_]:f._events[p].push(_):(f._events[p]=_,f._eventsCount++),f}function i(f,c){--f._eventsCount===0?f._events=new n:delete f._events[c]}function u(){this._events=new n,this._eventsCount=0}u.prototype.eventNames=function(){var c=[],d,h;if(this._eventsCount===0)return c;for(h in d=this._events)e.call(d,h)&&c.push(s?h.slice(1):h);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(d)):c},u.prototype.listeners=function(c){var d=s?s+c:c,h=this._events[d];if(!h)return[];if(h.fn)return[h.fn];for(var m=0,_=h.length,p=new Array(_);m<_;m++)p[m]=h[m].fn;return p},u.prototype.listenerCount=function(c){var d=s?s+c:c,h=this._events[d];return h?h.fn?1:h.length:0},u.prototype.emit=function(c,d,h,m,_,p){var b=s?s+c:c;if(!this._events[b])return!1;var A=this._events[b],T=arguments.length,v,N;if(A.fn){switch(A.once&&this.removeListener(c,A.fn,void 0,!0),T){case 1:return A.fn.call(A.context),!0;case 2:return A.fn.call(A.context,d),!0;case 3:return A.fn.call(A.context,d,h),!0;case 4:return A.fn.call(A.context,d,h,m),!0;case 5:return A.fn.call(A.context,d,h,m,_),!0;case 6:return A.fn.call(A.context,d,h,m,_,p),!0}for(N=1,v=new Array(T-1);N<T;N++)v[N-1]=arguments[N];A.fn.apply(A.context,v)}else{var x=A.length,y;for(N=0;N<x;N++)switch(A[N].once&&this.removeListener(c,A[N].fn,void 0,!0),T){case 1:A[N].fn.call(A[N].context);break;case 2:A[N].fn.call(A[N].context,d);break;case 3:A[N].fn.call(A[N].context,d,h);break;case 4:A[N].fn.call(A[N].context,d,h,m);break;default:if(!v)for(y=1,v=new Array(T-1);y<T;y++)v[y-1]=arguments[y];A[N].fn.apply(A[N].context,v)}}return!0},u.prototype.on=function(c,d,h){return a(this,c,d,h,!1)},u.prototype.once=function(c,d,h){return a(this,c,d,h,!0)},u.prototype.removeListener=function(c,d,h,m){var _=s?s+c:c;if(!this._events[_])return this;if(!d)return i(this,_),this;var p=this._events[_];if(p.fn)p.fn===d&&(!m||p.once)&&(!h||p.context===h)&&i(this,_);else{for(var b=0,A=[],T=p.length;b<T;b++)(p[b].fn!==d||m&&!p[b].once||h&&p[b].context!==h)&&A.push(p[b]);A.length?this._events[_]=A.length===1?A[0]:A:i(this,_)}return this},u.prototype.removeAllListeners=function(c){var d;return c?(d=s?s+c:c,this._events[d]&&i(this,d)):(this._events=new n,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=s,u.EventEmitter=u,t.exports=u})(eventemitter3);var eventemitter3Exports=eventemitter3.exports,pTimeout$1={exports:{}},pFinally$1=(t,e)=>(e=e||(()=>{}),t.then(s=>new Promise(n=>{n(e())}).then(()=>s),s=>new Promise(n=>{n(e())}).then(()=>{throw s})));const pFinally=pFinally$1;class TimeoutError extends Error{constructor(e){super(e),this.name="TimeoutError"}}const pTimeout=(t,e,s)=>new Promise((n,r)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){n(t);return}const a=setTimeout(()=>{if(typeof s=="function"){try{n(s())}catch(f){r(f)}return}const i=typeof s=="string"?s:`Promise timed out after ${e} milliseconds`,u=s instanceof Error?s:new TimeoutError(i);typeof t.cancel=="function"&&t.cancel(),r(u)},e);pFinally(t.then(n,r),()=>{clearTimeout(a)})});pTimeout$1.exports=pTimeout,pTimeout$1.exports.default=pTimeout,pTimeout$1.exports.TimeoutError=TimeoutError;var pTimeoutExports=pTimeout$1.exports,priorityQueue={},lowerBound$1={};Object.defineProperty(lowerBound$1,"__esModule",{value:!0});function lowerBound(t,e,s){let n=0,r=t.length;for(;r>0;){const a=r/2|0;let i=n+a;s(t[i],e)<=0?(n=++i,r-=a+1):r=a}return n}lowerBound$1.default=lowerBound,Object.defineProperty(priorityQueue,"__esModule",{value:!0});const lower_bound_1=lowerBound$1;class PriorityQueue{constructor(){this._queue=[]}enqueue(e,s){s=Object.assign({priority:0},s);const n={priority:s.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=s.priority){this._queue.push(n);return}const r=lower_bound_1.default(this._queue,n,(a,i)=>i.priority-a.priority);this._queue.splice(r,0,n)}dequeue(){const e=this._queue.shift();return e?.run}filter(e){return this._queue.filter(s=>s.priority===e.priority).map(s=>s.run)}get size(){return this._queue.length}}priorityQueue.default=PriorityQueue,Object.defineProperty(dist,"__esModule",{value:!0});const EventEmitter=eventemitter3Exports,p_timeout_1=pTimeoutExports,priority_queue_1=priorityQueue,empty=()=>{},timeoutError=new p_timeout_1.TimeoutError;class PQueue extends EventEmitter{constructor(e){var s,n,r,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=empty,this._resolveIdle=empty,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:priority_queue_1.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(s=e.intervalCap)===null||s===void 0?void 0:s.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(a=(r=e.interval)===null||r===void 0?void 0:r.toString())!==null&&a!==void 0?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=empty,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=empty,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const s=this._intervalEnd-e;if(s<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},s)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const s=this._queue.dequeue();return s?(this.emit("active"),s(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,s={}){return new Promise((n,r)=>{const a=async()=>{this._pendingCount++,this._intervalCount++;try{const i=this._timeout===void 0&&s.timeout===void 0?e():p_timeout_1.default(Promise.resolve(e()),s.timeout===void 0?this._timeout:s.timeout,()=>{(s.throwOnTimeout===void 0?this._throwOnTimeout:s.throwOnTimeout)&&r(timeoutError)});n(await i)}catch(i){r(i)}this._next()};this._queue.enqueue(a,s),this._tryToStartAnother(),this.emit("add")})}async addAll(e,s){return Promise.all(e.map(async n=>this.add(n,s)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const s=this._resolveEmpty;this._resolveEmpty=()=>{s(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const s=this._resolveIdle;this._resolveIdle=()=>{s(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var _default=dist.default=PQueue;const STATUS_NO_RETRY$1=[400,401,402,403,404,405,406,407,409],defaultFailedAttemptHandler=t=>{if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||t?.code==="ECONNABORTED")throw t;const e=t?.response?.status??t?.status;if(e&&STATUS_NO_RETRY$1.includes(+e))throw t;if(t?.error?.code==="insufficient_quota"){const s=new Error(t?.message);throw s.name="InsufficientQuotaError",s}};let AsyncCaller$1=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??defaultFailedAttemptHandler;const s="default"in _default?_default.default:_default;this.queue=new s({concurrency:this.maxConcurrency})}call(e,...s){return this.queue.add(()=>pRetry$1(()=>e(...s).catch(n=>{throw n instanceof Error?n:new Error(n)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,s,...n){return e.signal?Promise.race([this.call(s,...n),new Promise((r,a)=>{e.signal?.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(s,...n)}fetch(...e){return this.call(()=>fetch(...e).then(s=>s.ok?s:Promise.reject(s)))}};var base64JsExports=requireBase64Js();const base64=getDefaultExportFromCjs(base64JsExports);var __defProp=Object.defineProperty,__defNormalProp=(t,e,s)=>e in t?__defProp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,__publicField=(t,e,s)=>(__defNormalProp(t,typeof e!="symbol"?e+"":e,s),s);function bytePairMerge(t,e){let s=Array.from({length:t.length},(n,r)=>({start:r,end:r+1}));for(;s.length>1;){let n=null;for(let r=0;r<s.length-1;r++){const a=t.slice(s[r].start,s[r+1].end),i=e.get(a.join(","));i!=null&&(n==null||i<n[0])&&(n=[i,r])}if(n!=null){const r=n[1];s[r]={start:s[r].start,end:s[r+1].end},s.splice(r+1,1)}else break}return s}function bytePairEncode(t,e){return t.length===1?[e.get(t.join(","))]:bytePairMerge(t,e).map(s=>e.get(t.slice(s.start,s.end).join(","))).filter(s=>s!=null)}function escapeRegex(t){return t.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var _Tiktoken=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(t,e){this.patStr=t.pat_str;const s=t.bpe_ranks.split(`
`).filter(Boolean).reduce((n,r)=>{const[a,i,...u]=r.split(" "),f=Number.parseInt(i,10);return u.forEach((c,d)=>n[c]=f+d),n},{});for(const[n,r]of Object.entries(s)){const a=base64.toByteArray(n);this.rankMap.set(a.join(","),r),this.textMap.set(r,a)}this.specialTokens={...t.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[r,a])=>(n[a]=this.textEncoder.encode(r),n),{})}encode(t,e=[],s="all"){const n=new RegExp(this.patStr,"ug"),r=_Tiktoken.specialTokenRegex(Object.keys(this.specialTokens)),a=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),u=new Set(s==="all"?Object.keys(this.specialTokens).filter(c=>!i.has(c)):s);if(u.size>0){const c=_Tiktoken.specialTokenRegex([...u]),d=t.match(c);if(d!=null)throw new Error(`The text contains a special token that is not allowed: ${d[0]}`)}let f=0;for(;;){let c=null,d=f;for(;r.lastIndex=d,c=r.exec(t),!(c==null||i.has(c[0]));)d=c.index+1;const h=c?.index??t.length;for(const _ of t.substring(f,h).matchAll(n)){const p=this.textEncoder.encode(_[0]),b=this.rankMap.get(p.join(","));if(b!=null){a.push(b);continue}a.push(...bytePairEncode(p,this.rankMap))}if(c==null)break;let m=this.specialTokens[c[0]];a.push(m),f=c.index+c[0].length}return a}decode(t){const e=[];let s=0;for(let a=0;a<t.length;++a){const i=t[a],u=this.textMap.get(i)??this.inverseSpecialTokens[i];u!=null&&(e.push(u),s+=u.length)}const n=new Uint8Array(s);let r=0;for(const a of e)n.set(a,r),r+=a.length;return this.textDecoder.decode(n)}},Tiktoken=_Tiktoken;__publicField(Tiktoken,"specialTokenRegex",t=>new RegExp(t.map(e=>escapeRegex(e)).join("|"),"g"));function getEncodingNameForModel(t){switch(t){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";default:throw new Error("Unknown model")}}const cache={},caller=new AsyncCaller$1({});async function getEncoding(t){return t in cache||(cache[t]=caller.fetch(`https://tiktoken.pages.dev/js/${t}.json`).then(e=>e.json()).then(e=>new Tiktoken(e)).catch(e=>{throw delete cache[t],e})),await cache[t]}async function encodingForModel(t){return getEncoding(getEncodingNameForModel(t))}var util;(function(t){t.assertEqual=r=>{};function e(r){}t.assertIs=e;function s(r){throw new Error}t.assertNever=s,t.arrayToEnum=r=>{const a={};for(const i of r)a[i]=i;return a},t.getValidEnumValues=r=>{const a=t.objectKeys(r).filter(u=>typeof r[r[u]]!="number"),i={};for(const u of a)i[u]=r[u];return t.objectValues(i)},t.objectValues=r=>t.objectKeys(r).map(function(a){return r[a]}),t.objectKeys=typeof Object.keys=="function"?r=>Object.keys(r):r=>{const a=[];for(const i in r)Object.prototype.hasOwnProperty.call(r,i)&&a.push(i);return a},t.find=(r,a)=>{for(const i of r)if(a(i))return i},t.isInteger=typeof Number.isInteger=="function"?r=>Number.isInteger(r):r=>typeof r=="number"&&Number.isFinite(r)&&Math.floor(r)===r;function n(r,a=" | "){return r.map(i=>typeof i=="string"?`'${i}'`:i).join(a)}t.joinValues=n,t.jsonStringifyReplacer=(r,a)=>typeof a=="bigint"?a.toString():a})(util||(util={}));var objectUtil;(function(t){t.mergeShapes=(e,s)=>({...e,...s})})(objectUtil||(objectUtil={}));const ZodParsedType=util.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),getParsedType=t=>{switch(typeof t){case"undefined":return ZodParsedType.undefined;case"string":return ZodParsedType.string;case"number":return Number.isNaN(t)?ZodParsedType.nan:ZodParsedType.number;case"boolean":return ZodParsedType.boolean;case"function":return ZodParsedType.function;case"bigint":return ZodParsedType.bigint;case"symbol":return ZodParsedType.symbol;case"object":return Array.isArray(t)?ZodParsedType.array:t===null?ZodParsedType.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?ZodParsedType.promise:typeof Map<"u"&&t instanceof Map?ZodParsedType.map:typeof Set<"u"&&t instanceof Set?ZodParsedType.set:typeof Date<"u"&&t instanceof Date?ZodParsedType.date:ZodParsedType.object;default:return ZodParsedType.unknown}},ZodIssueCode=util.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class ZodError extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const s=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,s):this.__proto__=s,this.name="ZodError",this.issues=e}format(e){const s=e||function(a){return a.message},n={_errors:[]},r=a=>{for(const i of a.issues)if(i.code==="invalid_union")i.unionErrors.map(r);else if(i.code==="invalid_return_type")r(i.returnTypeError);else if(i.code==="invalid_arguments")r(i.argumentsError);else if(i.path.length===0)n._errors.push(s(i));else{let u=n,f=0;for(;f<i.path.length;){const c=i.path[f];f===i.path.length-1?(u[c]=u[c]||{_errors:[]},u[c]._errors.push(s(i))):u[c]=u[c]||{_errors:[]},u=u[c],f++}}};return r(this),n}static assert(e){if(!(e instanceof ZodError))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,util.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=s=>s.message){const s={},n=[];for(const r of this.issues)r.path.length>0?(s[r.path[0]]=s[r.path[0]]||[],s[r.path[0]].push(e(r))):n.push(e(r));return{formErrors:n,fieldErrors:s}}get formErrors(){return this.flatten()}}ZodError.create=t=>new ZodError(t);const errorMap=(t,e)=>{let s;switch(t.code){case ZodIssueCode.invalid_type:t.received===ZodParsedType.undefined?s="Required":s=`Expected ${t.expected}, received ${t.received}`;break;case ZodIssueCode.invalid_literal:s=`Invalid literal value, expected ${JSON.stringify(t.expected,util.jsonStringifyReplacer)}`;break;case ZodIssueCode.unrecognized_keys:s=`Unrecognized key(s) in object: ${util.joinValues(t.keys,", ")}`;break;case ZodIssueCode.invalid_union:s="Invalid input";break;case ZodIssueCode.invalid_union_discriminator:s=`Invalid discriminator value. Expected ${util.joinValues(t.options)}`;break;case ZodIssueCode.invalid_enum_value:s=`Invalid enum value. Expected ${util.joinValues(t.options)}, received '${t.received}'`;break;case ZodIssueCode.invalid_arguments:s="Invalid function arguments";break;case ZodIssueCode.invalid_return_type:s="Invalid function return type";break;case ZodIssueCode.invalid_date:s="Invalid date";break;case ZodIssueCode.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(s=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(s=`${s} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?s=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?s=`Invalid input: must end with "${t.validation.endsWith}"`:util.assertNever(t.validation):t.validation!=="regex"?s=`Invalid ${t.validation}`:s="Invalid";break;case ZodIssueCode.too_small:t.type==="array"?s=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?s=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?s=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?s=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:s="Invalid input";break;case ZodIssueCode.too_big:t.type==="array"?s=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?s=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?s=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?s=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?s=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:s="Invalid input";break;case ZodIssueCode.custom:s="Invalid input";break;case ZodIssueCode.invalid_intersection_types:s="Intersection results could not be merged";break;case ZodIssueCode.not_multiple_of:s=`Number must be a multiple of ${t.multipleOf}`;break;case ZodIssueCode.not_finite:s="Number must be finite";break;default:s=e.defaultError,util.assertNever(t)}return{message:s}};let overrideErrorMap=errorMap;function getErrorMap(){return overrideErrorMap}const makeIssue=t=>{const{data:e,path:s,errorMaps:n,issueData:r}=t,a=[...s,...r.path||[]],i={...r,path:a};if(r.message!==void 0)return{...r,path:a,message:r.message};let u="";const f=n.filter(c=>!!c).slice().reverse();for(const c of f)u=c(i,{data:e,defaultError:u}).message;return{...r,path:a,message:u}};function addIssueToContext(t,e){const s=getErrorMap(),n=makeIssue({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,s,s===errorMap?void 0:errorMap].filter(r=>!!r)});t.common.issues.push(n)}class ParseStatus{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,s){const n=[];for(const r of s){if(r.status==="aborted")return INVALID;r.status==="dirty"&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,s){const n=[];for(const r of s){const a=await r.key,i=await r.value;n.push({key:a,value:i})}return ParseStatus.mergeObjectSync(e,n)}static mergeObjectSync(e,s){const n={};for(const r of s){const{key:a,value:i}=r;if(a.status==="aborted"||i.status==="aborted")return INVALID;a.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof i.value<"u"||r.alwaysSet)&&(n[a.value]=i.value)}return{status:e.value,value:n}}}const INVALID=Object.freeze({status:"aborted"}),DIRTY=t=>({status:"dirty",value:t}),OK=t=>({status:"valid",value:t}),isAborted=t=>t.status==="aborted",isDirty=t=>t.status==="dirty",isValid=t=>t.status==="valid",isAsync=t=>typeof Promise<"u"&&t instanceof Promise;var errorUtil;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e?.message})(errorUtil||(errorUtil={}));var __classPrivateFieldGet$7=function(t,e,s,n){if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?n:s==="a"?n.call(t):n?n.value:e.get(t)},__classPrivateFieldSet$6=function(t,e,s,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(t,s):r?r.value=s:e.set(t,s),s},_ZodEnum_cache,_ZodNativeEnum_cache;class ParseInputLazyPath{constructor(e,s,n,r){this._cachedPath=[],this.parent=e,this.data=s,this._path=n,this._key=r}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const handleResult=(t,e)=>{if(isValid(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const s=new ZodError(t.common.issues);return this._error=s,this._error}}};function processCreateParams(t){if(!t)return{};const{errorMap:e,invalid_type_error:s,required_error:n,description:r}=t;if(e&&(s||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:r}:{errorMap:(i,u)=>{const{message:f}=t;return i.code==="invalid_enum_value"?{message:f??u.defaultError}:typeof u.data>"u"?{message:f??n??u.defaultError}:i.code!=="invalid_type"?{message:u.defaultError}:{message:f??s??u.defaultError}},description:r}}class ZodType{get description(){return this._def.description}_getType(e){return getParsedType(e.data)}_getOrReturnCtx(e,s){return s||{common:e.parent.common,data:e.data,parsedType:getParsedType(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new ParseStatus,ctx:{common:e.parent.common,data:e.data,parsedType:getParsedType(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const s=this._parse(e);if(isAsync(s))throw new Error("Synchronous parse encountered promise.");return s}_parseAsync(e){const s=this._parse(e);return Promise.resolve(s)}parse(e,s){const n=this.safeParse(e,s);if(n.success)return n.data;throw n.error}safeParse(e,s){const n={common:{issues:[],async:s?.async??!1,contextualErrorMap:s?.errorMap},path:s?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:getParsedType(e)},r=this._parseSync({data:e,path:n.path,parent:n});return handleResult(n,r)}"~validate"(e){const s={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:getParsedType(e)};if(!this["~standard"].async)try{const n=this._parseSync({data:e,path:[],parent:s});return isValid(n)?{value:n.value}:{issues:s.common.issues}}catch(n){n?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),s.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:s}).then(n=>isValid(n)?{value:n.value}:{issues:s.common.issues})}async parseAsync(e,s){const n=await this.safeParseAsync(e,s);if(n.success)return n.data;throw n.error}async safeParseAsync(e,s){const n={common:{issues:[],contextualErrorMap:s?.errorMap,async:!0},path:s?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:getParsedType(e)},r=this._parse({data:e,path:n.path,parent:n}),a=await(isAsync(r)?r:Promise.resolve(r));return handleResult(n,a)}refine(e,s){const n=r=>typeof s=="string"||typeof s>"u"?{message:s}:typeof s=="function"?s(r):s;return this._refinement((r,a)=>{const i=e(r),u=()=>a.addIssue({code:ZodIssueCode.custom,...n(r)});return typeof Promise<"u"&&i instanceof Promise?i.then(f=>f?!0:(u(),!1)):i?!0:(u(),!1)})}refinement(e,s){return this._refinement((n,r)=>e(n)?!0:(r.addIssue(typeof s=="function"?s(n,r):s),!1))}_refinement(e){return new ZodEffects({schema:this,typeName:ZodFirstPartyTypeKind.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:s=>this["~validate"](s)}}optional(){return ZodOptional.create(this,this._def)}nullable(){return ZodNullable.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return ZodArray.create(this)}promise(){return ZodPromise.create(this,this._def)}or(e){return ZodUnion.create([this,e],this._def)}and(e){return ZodIntersection.create(this,e,this._def)}transform(e){return new ZodEffects({...processCreateParams(this._def),schema:this,typeName:ZodFirstPartyTypeKind.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const s=typeof e=="function"?e:()=>e;return new ZodDefault({...processCreateParams(this._def),innerType:this,defaultValue:s,typeName:ZodFirstPartyTypeKind.ZodDefault})}brand(){return new ZodBranded({typeName:ZodFirstPartyTypeKind.ZodBranded,type:this,...processCreateParams(this._def)})}catch(e){const s=typeof e=="function"?e:()=>e;return new ZodCatch({...processCreateParams(this._def),innerType:this,catchValue:s,typeName:ZodFirstPartyTypeKind.ZodCatch})}describe(e){const s=this.constructor;return new s({...this._def,description:e})}pipe(e){return ZodPipeline.create(this,e)}readonly(){return ZodReadonly.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const cuidRegex=/^c[^\s-]{8,}$/i,cuid2Regex=/^[0-9a-z]+$/,ulidRegex=/^[0-9A-HJKMNP-TV-Z]{26}$/i,uuidRegex=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,nanoidRegex=/^[a-z0-9_-]{21}$/i,jwtRegex=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,durationRegex=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,emailRegex=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,_emojiRegex="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let emojiRegex;const ipv4Regex=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4CidrRegex=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6Regex=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,ipv6CidrRegex=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64Regex=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64urlRegex=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,dateRegexSource="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",dateRegex=new RegExp(`^${dateRegexSource}$`);function timeRegexSource(t){let e="[0-5]\\d";t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`);const s=t.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${s}`}function timeRegex(t){return new RegExp(`^${timeRegexSource(t)}$`)}function datetimeRegex(t){let e=`${dateRegexSource}T${timeRegexSource(t)}`;const s=[];return s.push(t.local?"Z?":"Z"),t.offset&&s.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${s.join("|")})`,new RegExp(`^${e}$`)}function isValidIP(t,e){return!!((e==="v4"||!e)&&ipv4Regex.test(t)||(e==="v6"||!e)&&ipv6Regex.test(t))}function isValidJWT(t,e){if(!jwtRegex.test(t))return!1;try{const[s]=t.split("."),n=s.replace(/-/g,"+").replace(/_/g,"/").padEnd(s.length+(4-s.length%4)%4,"="),r=JSON.parse(atob(n));return!(typeof r!="object"||r===null||"typ"in r&&r?.typ!=="JWT"||!r.alg||e&&r.alg!==e)}catch{return!1}}function isValidCidr(t,e){return!!((e==="v4"||!e)&&ipv4CidrRegex.test(t)||(e==="v6"||!e)&&ipv6CidrRegex.test(t))}class ZodString extends ZodType{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==ZodParsedType.string){const a=this._getOrReturnCtx(e);return addIssueToContext(a,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.string,received:a.parsedType}),INVALID}const n=new ParseStatus;let r;for(const a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:ZodIssueCode.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),n.dirty());else if(a.kind==="max")e.data.length>a.value&&(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:ZodIssueCode.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),n.dirty());else if(a.kind==="length"){const i=e.data.length>a.value,u=e.data.length<a.value;(i||u)&&(r=this._getOrReturnCtx(e,r),i?addIssueToContext(r,{code:ZodIssueCode.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):u&&addIssueToContext(r,{code:ZodIssueCode.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),n.dirty())}else if(a.kind==="email")emailRegex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"email",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty());else if(a.kind==="emoji")emojiRegex||(emojiRegex=new RegExp(_emojiRegex,"u")),emojiRegex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"emoji",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty());else if(a.kind==="uuid")uuidRegex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"uuid",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty());else if(a.kind==="nanoid")nanoidRegex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"nanoid",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty());else if(a.kind==="cuid")cuidRegex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"cuid",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty());else if(a.kind==="cuid2")cuid2Regex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"cuid2",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty());else if(a.kind==="ulid")ulidRegex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"ulid",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"url",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"regex",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:ZodIssueCode.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),n.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:ZodIssueCode.invalid_string,validation:{startsWith:a.value},message:a.message}),n.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:ZodIssueCode.invalid_string,validation:{endsWith:a.value},message:a.message}),n.dirty()):a.kind==="datetime"?datetimeRegex(a).test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:ZodIssueCode.invalid_string,validation:"datetime",message:a.message}),n.dirty()):a.kind==="date"?dateRegex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:ZodIssueCode.invalid_string,validation:"date",message:a.message}),n.dirty()):a.kind==="time"?timeRegex(a).test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:ZodIssueCode.invalid_string,validation:"time",message:a.message}),n.dirty()):a.kind==="duration"?durationRegex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"duration",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty()):a.kind==="ip"?isValidIP(e.data,a.version)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"ip",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty()):a.kind==="jwt"?isValidJWT(e.data,a.alg)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"jwt",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty()):a.kind==="cidr"?isValidCidr(e.data,a.version)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"cidr",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty()):a.kind==="base64"?base64Regex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"base64",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty()):a.kind==="base64url"?base64urlRegex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"base64url",code:ZodIssueCode.invalid_string,message:a.message}),n.dirty()):util.assertNever(a);return{status:n.value,value:e.data}}_regex(e,s,n){return this.refinement(r=>e.test(r),{validation:s,code:ZodIssueCode.invalid_string,...errorUtil.errToObj(n)})}_addCheck(e){return new ZodString({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...errorUtil.errToObj(e)})}url(e){return this._addCheck({kind:"url",...errorUtil.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...errorUtil.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...errorUtil.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...errorUtil.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...errorUtil.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...errorUtil.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...errorUtil.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...errorUtil.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...errorUtil.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...errorUtil.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...errorUtil.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...errorUtil.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...errorUtil.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...errorUtil.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...errorUtil.errToObj(e)})}regex(e,s){return this._addCheck({kind:"regex",regex:e,...errorUtil.errToObj(s)})}includes(e,s){return this._addCheck({kind:"includes",value:e,position:s?.position,...errorUtil.errToObj(s?.message)})}startsWith(e,s){return this._addCheck({kind:"startsWith",value:e,...errorUtil.errToObj(s)})}endsWith(e,s){return this._addCheck({kind:"endsWith",value:e,...errorUtil.errToObj(s)})}min(e,s){return this._addCheck({kind:"min",value:e,...errorUtil.errToObj(s)})}max(e,s){return this._addCheck({kind:"max",value:e,...errorUtil.errToObj(s)})}length(e,s){return this._addCheck({kind:"length",value:e,...errorUtil.errToObj(s)})}nonempty(e){return this.min(1,errorUtil.errToObj(e))}trim(){return new ZodString({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new ZodString({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new ZodString({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const s of this._def.checks)s.kind==="min"&&(e===null||s.value>e)&&(e=s.value);return e}get maxLength(){let e=null;for(const s of this._def.checks)s.kind==="max"&&(e===null||s.value<e)&&(e=s.value);return e}}ZodString.create=t=>new ZodString({checks:[],typeName:ZodFirstPartyTypeKind.ZodString,coerce:t?.coerce??!1,...processCreateParams(t)});function floatSafeRemainder(t,e){const s=(t.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,r=s>n?s:n,a=Number.parseInt(t.toFixed(r).replace(".","")),i=Number.parseInt(e.toFixed(r).replace(".",""));return a%i/10**r}class ZodNumber extends ZodType{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==ZodParsedType.number){const a=this._getOrReturnCtx(e);return addIssueToContext(a,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.number,received:a.parsedType}),INVALID}let n;const r=new ParseStatus;for(const a of this._def.checks)a.kind==="int"?util.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),addIssueToContext(n,{code:ZodIssueCode.invalid_type,expected:"integer",received:"float",message:a.message}),r.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(n=this._getOrReturnCtx(e,n),addIssueToContext(n,{code:ZodIssueCode.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(n=this._getOrReturnCtx(e,n),addIssueToContext(n,{code:ZodIssueCode.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):a.kind==="multipleOf"?floatSafeRemainder(e.data,a.value)!==0&&(n=this._getOrReturnCtx(e,n),addIssueToContext(n,{code:ZodIssueCode.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),addIssueToContext(n,{code:ZodIssueCode.not_finite,message:a.message}),r.dirty()):util.assertNever(a);return{status:r.value,value:e.data}}gte(e,s){return this.setLimit("min",e,!0,errorUtil.toString(s))}gt(e,s){return this.setLimit("min",e,!1,errorUtil.toString(s))}lte(e,s){return this.setLimit("max",e,!0,errorUtil.toString(s))}lt(e,s){return this.setLimit("max",e,!1,errorUtil.toString(s))}setLimit(e,s,n,r){return new ZodNumber({...this._def,checks:[...this._def.checks,{kind:e,value:s,inclusive:n,message:errorUtil.toString(r)}]})}_addCheck(e){return new ZodNumber({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:errorUtil.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:errorUtil.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:errorUtil.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:errorUtil.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:errorUtil.toString(e)})}multipleOf(e,s){return this._addCheck({kind:"multipleOf",value:e,message:errorUtil.toString(s)})}finite(e){return this._addCheck({kind:"finite",message:errorUtil.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:errorUtil.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:errorUtil.toString(e)})}get minValue(){let e=null;for(const s of this._def.checks)s.kind==="min"&&(e===null||s.value>e)&&(e=s.value);return e}get maxValue(){let e=null;for(const s of this._def.checks)s.kind==="max"&&(e===null||s.value<e)&&(e=s.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&util.isInteger(e.value))}get isFinite(){let e=null,s=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(s===null||n.value>s)&&(s=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(s)&&Number.isFinite(e)}}ZodNumber.create=t=>new ZodNumber({checks:[],typeName:ZodFirstPartyTypeKind.ZodNumber,coerce:t?.coerce||!1,...processCreateParams(t)});class ZodBigInt extends ZodType{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==ZodParsedType.bigint)return this._getInvalidInput(e);let n;const r=new ParseStatus;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(n=this._getOrReturnCtx(e,n),addIssueToContext(n,{code:ZodIssueCode.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(n=this._getOrReturnCtx(e,n),addIssueToContext(n,{code:ZodIssueCode.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),addIssueToContext(n,{code:ZodIssueCode.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):util.assertNever(a);return{status:r.value,value:e.data}}_getInvalidInput(e){const s=this._getOrReturnCtx(e);return addIssueToContext(s,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.bigint,received:s.parsedType}),INVALID}gte(e,s){return this.setLimit("min",e,!0,errorUtil.toString(s))}gt(e,s){return this.setLimit("min",e,!1,errorUtil.toString(s))}lte(e,s){return this.setLimit("max",e,!0,errorUtil.toString(s))}lt(e,s){return this.setLimit("max",e,!1,errorUtil.toString(s))}setLimit(e,s,n,r){return new ZodBigInt({...this._def,checks:[...this._def.checks,{kind:e,value:s,inclusive:n,message:errorUtil.toString(r)}]})}_addCheck(e){return new ZodBigInt({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:errorUtil.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:errorUtil.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:errorUtil.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:errorUtil.toString(e)})}multipleOf(e,s){return this._addCheck({kind:"multipleOf",value:e,message:errorUtil.toString(s)})}get minValue(){let e=null;for(const s of this._def.checks)s.kind==="min"&&(e===null||s.value>e)&&(e=s.value);return e}get maxValue(){let e=null;for(const s of this._def.checks)s.kind==="max"&&(e===null||s.value<e)&&(e=s.value);return e}}ZodBigInt.create=t=>new ZodBigInt({checks:[],typeName:ZodFirstPartyTypeKind.ZodBigInt,coerce:t?.coerce??!1,...processCreateParams(t)});class ZodBoolean extends ZodType{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==ZodParsedType.boolean){const n=this._getOrReturnCtx(e);return addIssueToContext(n,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.boolean,received:n.parsedType}),INVALID}return OK(e.data)}}ZodBoolean.create=t=>new ZodBoolean({typeName:ZodFirstPartyTypeKind.ZodBoolean,coerce:t?.coerce||!1,...processCreateParams(t)});class ZodDate extends ZodType{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==ZodParsedType.date){const a=this._getOrReturnCtx(e);return addIssueToContext(a,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.date,received:a.parsedType}),INVALID}if(Number.isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return addIssueToContext(a,{code:ZodIssueCode.invalid_date}),INVALID}const n=new ParseStatus;let r;for(const a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:ZodIssueCode.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),n.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:ZodIssueCode.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),n.dirty()):util.assertNever(a);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new ZodDate({...this._def,checks:[...this._def.checks,e]})}min(e,s){return this._addCheck({kind:"min",value:e.getTime(),message:errorUtil.toString(s)})}max(e,s){return this._addCheck({kind:"max",value:e.getTime(),message:errorUtil.toString(s)})}get minDate(){let e=null;for(const s of this._def.checks)s.kind==="min"&&(e===null||s.value>e)&&(e=s.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const s of this._def.checks)s.kind==="max"&&(e===null||s.value<e)&&(e=s.value);return e!=null?new Date(e):null}}ZodDate.create=t=>new ZodDate({checks:[],coerce:t?.coerce||!1,typeName:ZodFirstPartyTypeKind.ZodDate,...processCreateParams(t)});class ZodSymbol extends ZodType{_parse(e){if(this._getType(e)!==ZodParsedType.symbol){const n=this._getOrReturnCtx(e);return addIssueToContext(n,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.symbol,received:n.parsedType}),INVALID}return OK(e.data)}}ZodSymbol.create=t=>new ZodSymbol({typeName:ZodFirstPartyTypeKind.ZodSymbol,...processCreateParams(t)});class ZodUndefined extends ZodType{_parse(e){if(this._getType(e)!==ZodParsedType.undefined){const n=this._getOrReturnCtx(e);return addIssueToContext(n,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.undefined,received:n.parsedType}),INVALID}return OK(e.data)}}ZodUndefined.create=t=>new ZodUndefined({typeName:ZodFirstPartyTypeKind.ZodUndefined,...processCreateParams(t)});class ZodNull extends ZodType{_parse(e){if(this._getType(e)!==ZodParsedType.null){const n=this._getOrReturnCtx(e);return addIssueToContext(n,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.null,received:n.parsedType}),INVALID}return OK(e.data)}}ZodNull.create=t=>new ZodNull({typeName:ZodFirstPartyTypeKind.ZodNull,...processCreateParams(t)});class ZodAny extends ZodType{constructor(){super(...arguments),this._any=!0}_parse(e){return OK(e.data)}}ZodAny.create=t=>new ZodAny({typeName:ZodFirstPartyTypeKind.ZodAny,...processCreateParams(t)});class ZodUnknown extends ZodType{constructor(){super(...arguments),this._unknown=!0}_parse(e){return OK(e.data)}}ZodUnknown.create=t=>new ZodUnknown({typeName:ZodFirstPartyTypeKind.ZodUnknown,...processCreateParams(t)});class ZodNever extends ZodType{_parse(e){const s=this._getOrReturnCtx(e);return addIssueToContext(s,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.never,received:s.parsedType}),INVALID}}ZodNever.create=t=>new ZodNever({typeName:ZodFirstPartyTypeKind.ZodNever,...processCreateParams(t)});class ZodVoid extends ZodType{_parse(e){if(this._getType(e)!==ZodParsedType.undefined){const n=this._getOrReturnCtx(e);return addIssueToContext(n,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.void,received:n.parsedType}),INVALID}return OK(e.data)}}ZodVoid.create=t=>new ZodVoid({typeName:ZodFirstPartyTypeKind.ZodVoid,...processCreateParams(t)});class ZodArray extends ZodType{_parse(e){const{ctx:s,status:n}=this._processInputParams(e),r=this._def;if(s.parsedType!==ZodParsedType.array)return addIssueToContext(s,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.array,received:s.parsedType}),INVALID;if(r.exactLength!==null){const i=s.data.length>r.exactLength.value,u=s.data.length<r.exactLength.value;(i||u)&&(addIssueToContext(s,{code:i?ZodIssueCode.too_big:ZodIssueCode.too_small,minimum:u?r.exactLength.value:void 0,maximum:i?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty())}if(r.minLength!==null&&s.data.length<r.minLength.value&&(addIssueToContext(s,{code:ZodIssueCode.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),r.maxLength!==null&&s.data.length>r.maxLength.value&&(addIssueToContext(s,{code:ZodIssueCode.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),s.common.async)return Promise.all([...s.data].map((i,u)=>r.type._parseAsync(new ParseInputLazyPath(s,i,s.path,u)))).then(i=>ParseStatus.mergeArray(n,i));const a=[...s.data].map((i,u)=>r.type._parseSync(new ParseInputLazyPath(s,i,s.path,u)));return ParseStatus.mergeArray(n,a)}get element(){return this._def.type}min(e,s){return new ZodArray({...this._def,minLength:{value:e,message:errorUtil.toString(s)}})}max(e,s){return new ZodArray({...this._def,maxLength:{value:e,message:errorUtil.toString(s)}})}length(e,s){return new ZodArray({...this._def,exactLength:{value:e,message:errorUtil.toString(s)}})}nonempty(e){return this.min(1,e)}}ZodArray.create=(t,e)=>new ZodArray({type:t,minLength:null,maxLength:null,exactLength:null,typeName:ZodFirstPartyTypeKind.ZodArray,...processCreateParams(e)});function deepPartialify(t){if(t instanceof ZodObject){const e={};for(const s in t.shape){const n=t.shape[s];e[s]=ZodOptional.create(deepPartialify(n))}return new ZodObject({...t._def,shape:()=>e})}else return t instanceof ZodArray?new ZodArray({...t._def,type:deepPartialify(t.element)}):t instanceof ZodOptional?ZodOptional.create(deepPartialify(t.unwrap())):t instanceof ZodNullable?ZodNullable.create(deepPartialify(t.unwrap())):t instanceof ZodTuple?ZodTuple.create(t.items.map(e=>deepPartialify(e))):t}class ZodObject extends ZodType{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),s=util.objectKeys(e);return this._cached={shape:e,keys:s},this._cached}_parse(e){if(this._getType(e)!==ZodParsedType.object){const c=this._getOrReturnCtx(e);return addIssueToContext(c,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.object,received:c.parsedType}),INVALID}const{status:n,ctx:r}=this._processInputParams(e),{shape:a,keys:i}=this._getCached(),u=[];if(!(this._def.catchall instanceof ZodNever&&this._def.unknownKeys==="strip"))for(const c in r.data)i.includes(c)||u.push(c);const f=[];for(const c of i){const d=a[c],h=r.data[c];f.push({key:{status:"valid",value:c},value:d._parse(new ParseInputLazyPath(r,h,r.path,c)),alwaysSet:c in r.data})}if(this._def.catchall instanceof ZodNever){const c=this._def.unknownKeys;if(c==="passthrough")for(const d of u)f.push({key:{status:"valid",value:d},value:{status:"valid",value:r.data[d]}});else if(c==="strict")u.length>0&&(addIssueToContext(r,{code:ZodIssueCode.unrecognized_keys,keys:u}),n.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const d of u){const h=r.data[d];f.push({key:{status:"valid",value:d},value:c._parse(new ParseInputLazyPath(r,h,r.path,d)),alwaysSet:d in r.data})}}return r.common.async?Promise.resolve().then(async()=>{const c=[];for(const d of f){const h=await d.key,m=await d.value;c.push({key:h,value:m,alwaysSet:d.alwaysSet})}return c}).then(c=>ParseStatus.mergeObjectSync(n,c)):ParseStatus.mergeObjectSync(n,f)}get shape(){return this._def.shape()}strict(e){return errorUtil.errToObj,new ZodObject({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(s,n)=>{const r=this._def.errorMap?.(s,n).message??n.defaultError;return s.code==="unrecognized_keys"?{message:errorUtil.errToObj(e).message??r}:{message:r}}}:{}})}strip(){return new ZodObject({...this._def,unknownKeys:"strip"})}passthrough(){return new ZodObject({...this._def,unknownKeys:"passthrough"})}extend(e){return new ZodObject({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new ZodObject({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:ZodFirstPartyTypeKind.ZodObject})}setKey(e,s){return this.augment({[e]:s})}catchall(e){return new ZodObject({...this._def,catchall:e})}pick(e){const s={};for(const n of util.objectKeys(e))e[n]&&this.shape[n]&&(s[n]=this.shape[n]);return new ZodObject({...this._def,shape:()=>s})}omit(e){const s={};for(const n of util.objectKeys(this.shape))e[n]||(s[n]=this.shape[n]);return new ZodObject({...this._def,shape:()=>s})}deepPartial(){return deepPartialify(this)}partial(e){const s={};for(const n of util.objectKeys(this.shape)){const r=this.shape[n];e&&!e[n]?s[n]=r:s[n]=r.optional()}return new ZodObject({...this._def,shape:()=>s})}required(e){const s={};for(const n of util.objectKeys(this.shape))if(e&&!e[n])s[n]=this.shape[n];else{let a=this.shape[n];for(;a instanceof ZodOptional;)a=a._def.innerType;s[n]=a}return new ZodObject({...this._def,shape:()=>s})}keyof(){return createZodEnum(util.objectKeys(this.shape))}}ZodObject.create=(t,e)=>new ZodObject({shape:()=>t,unknownKeys:"strip",catchall:ZodNever.create(),typeName:ZodFirstPartyTypeKind.ZodObject,...processCreateParams(e)}),ZodObject.strictCreate=(t,e)=>new ZodObject({shape:()=>t,unknownKeys:"strict",catchall:ZodNever.create(),typeName:ZodFirstPartyTypeKind.ZodObject,...processCreateParams(e)}),ZodObject.lazycreate=(t,e)=>new ZodObject({shape:t,unknownKeys:"strip",catchall:ZodNever.create(),typeName:ZodFirstPartyTypeKind.ZodObject,...processCreateParams(e)});class ZodUnion extends ZodType{_parse(e){const{ctx:s}=this._processInputParams(e),n=this._def.options;function r(a){for(const u of a)if(u.result.status==="valid")return u.result;for(const u of a)if(u.result.status==="dirty")return s.common.issues.push(...u.ctx.common.issues),u.result;const i=a.map(u=>new ZodError(u.ctx.common.issues));return addIssueToContext(s,{code:ZodIssueCode.invalid_union,unionErrors:i}),INVALID}if(s.common.async)return Promise.all(n.map(async a=>{const i={...s,common:{...s.common,issues:[]},parent:null};return{result:await a._parseAsync({data:s.data,path:s.path,parent:i}),ctx:i}})).then(r);{let a;const i=[];for(const f of n){const c={...s,common:{...s.common,issues:[]},parent:null},d=f._parseSync({data:s.data,path:s.path,parent:c});if(d.status==="valid")return d;d.status==="dirty"&&!a&&(a={result:d,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(a)return s.common.issues.push(...a.ctx.common.issues),a.result;const u=i.map(f=>new ZodError(f));return addIssueToContext(s,{code:ZodIssueCode.invalid_union,unionErrors:u}),INVALID}}get options(){return this._def.options}}ZodUnion.create=(t,e)=>new ZodUnion({options:t,typeName:ZodFirstPartyTypeKind.ZodUnion,...processCreateParams(e)});function mergeValues(t,e){const s=getParsedType(t),n=getParsedType(e);if(t===e)return{valid:!0,data:t};if(s===ZodParsedType.object&&n===ZodParsedType.object){const r=util.objectKeys(e),a=util.objectKeys(t).filter(u=>r.indexOf(u)!==-1),i={...t,...e};for(const u of a){const f=mergeValues(t[u],e[u]);if(!f.valid)return{valid:!1};i[u]=f.data}return{valid:!0,data:i}}else if(s===ZodParsedType.array&&n===ZodParsedType.array){if(t.length!==e.length)return{valid:!1};const r=[];for(let a=0;a<t.length;a++){const i=t[a],u=e[a],f=mergeValues(i,u);if(!f.valid)return{valid:!1};r.push(f.data)}return{valid:!0,data:r}}else return s===ZodParsedType.date&&n===ZodParsedType.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}class ZodIntersection extends ZodType{_parse(e){const{status:s,ctx:n}=this._processInputParams(e),r=(a,i)=>{if(isAborted(a)||isAborted(i))return INVALID;const u=mergeValues(a.value,i.value);return u.valid?((isDirty(a)||isDirty(i))&&s.dirty(),{status:s.value,value:u.data}):(addIssueToContext(n,{code:ZodIssueCode.invalid_intersection_types}),INVALID)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([a,i])=>r(a,i)):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}ZodIntersection.create=(t,e,s)=>new ZodIntersection({left:t,right:e,typeName:ZodFirstPartyTypeKind.ZodIntersection,...processCreateParams(s)});class ZodTuple extends ZodType{_parse(e){const{status:s,ctx:n}=this._processInputParams(e);if(n.parsedType!==ZodParsedType.array)return addIssueToContext(n,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.array,received:n.parsedType}),INVALID;if(n.data.length<this._def.items.length)return addIssueToContext(n,{code:ZodIssueCode.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),INVALID;!this._def.rest&&n.data.length>this._def.items.length&&(addIssueToContext(n,{code:ZodIssueCode.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),s.dirty());const a=[...n.data].map((i,u)=>{const f=this._def.items[u]||this._def.rest;return f?f._parse(new ParseInputLazyPath(n,i,n.path,u)):null}).filter(i=>!!i);return n.common.async?Promise.all(a).then(i=>ParseStatus.mergeArray(s,i)):ParseStatus.mergeArray(s,a)}get items(){return this._def.items}rest(e){return new ZodTuple({...this._def,rest:e})}}ZodTuple.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new ZodTuple({items:t,typeName:ZodFirstPartyTypeKind.ZodTuple,rest:null,...processCreateParams(e)})};class ZodMap extends ZodType{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:s,ctx:n}=this._processInputParams(e);if(n.parsedType!==ZodParsedType.map)return addIssueToContext(n,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.map,received:n.parsedType}),INVALID;const r=this._def.keyType,a=this._def.valueType,i=[...n.data.entries()].map(([u,f],c)=>({key:r._parse(new ParseInputLazyPath(n,u,n.path,[c,"key"])),value:a._parse(new ParseInputLazyPath(n,f,n.path,[c,"value"]))}));if(n.common.async){const u=new Map;return Promise.resolve().then(async()=>{for(const f of i){const c=await f.key,d=await f.value;if(c.status==="aborted"||d.status==="aborted")return INVALID;(c.status==="dirty"||d.status==="dirty")&&s.dirty(),u.set(c.value,d.value)}return{status:s.value,value:u}})}else{const u=new Map;for(const f of i){const c=f.key,d=f.value;if(c.status==="aborted"||d.status==="aborted")return INVALID;(c.status==="dirty"||d.status==="dirty")&&s.dirty(),u.set(c.value,d.value)}return{status:s.value,value:u}}}}ZodMap.create=(t,e,s)=>new ZodMap({valueType:e,keyType:t,typeName:ZodFirstPartyTypeKind.ZodMap,...processCreateParams(s)});class ZodSet extends ZodType{_parse(e){const{status:s,ctx:n}=this._processInputParams(e);if(n.parsedType!==ZodParsedType.set)return addIssueToContext(n,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.set,received:n.parsedType}),INVALID;const r=this._def;r.minSize!==null&&n.data.size<r.minSize.value&&(addIssueToContext(n,{code:ZodIssueCode.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),s.dirty()),r.maxSize!==null&&n.data.size>r.maxSize.value&&(addIssueToContext(n,{code:ZodIssueCode.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),s.dirty());const a=this._def.valueType;function i(f){const c=new Set;for(const d of f){if(d.status==="aborted")return INVALID;d.status==="dirty"&&s.dirty(),c.add(d.value)}return{status:s.value,value:c}}const u=[...n.data.values()].map((f,c)=>a._parse(new ParseInputLazyPath(n,f,n.path,c)));return n.common.async?Promise.all(u).then(f=>i(f)):i(u)}min(e,s){return new ZodSet({...this._def,minSize:{value:e,message:errorUtil.toString(s)}})}max(e,s){return new ZodSet({...this._def,maxSize:{value:e,message:errorUtil.toString(s)}})}size(e,s){return this.min(e,s).max(e,s)}nonempty(e){return this.min(1,e)}}ZodSet.create=(t,e)=>new ZodSet({valueType:t,minSize:null,maxSize:null,typeName:ZodFirstPartyTypeKind.ZodSet,...processCreateParams(e)});class ZodLazy extends ZodType{get schema(){return this._def.getter()}_parse(e){const{ctx:s}=this._processInputParams(e);return this._def.getter()._parse({data:s.data,path:s.path,parent:s})}}ZodLazy.create=(t,e)=>new ZodLazy({getter:t,typeName:ZodFirstPartyTypeKind.ZodLazy,...processCreateParams(e)});class ZodLiteral extends ZodType{_parse(e){if(e.data!==this._def.value){const s=this._getOrReturnCtx(e);return addIssueToContext(s,{received:s.data,code:ZodIssueCode.invalid_literal,expected:this._def.value}),INVALID}return{status:"valid",value:e.data}}get value(){return this._def.value}}ZodLiteral.create=(t,e)=>new ZodLiteral({value:t,typeName:ZodFirstPartyTypeKind.ZodLiteral,...processCreateParams(e)});function createZodEnum(t,e){return new ZodEnum({values:t,typeName:ZodFirstPartyTypeKind.ZodEnum,...processCreateParams(e)})}class ZodEnum extends ZodType{constructor(){super(...arguments),_ZodEnum_cache.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const s=this._getOrReturnCtx(e),n=this._def.values;return addIssueToContext(s,{expected:util.joinValues(n),received:s.parsedType,code:ZodIssueCode.invalid_type}),INVALID}if(__classPrivateFieldGet$7(this,_ZodEnum_cache,"f")||__classPrivateFieldSet$6(this,_ZodEnum_cache,new Set(this._def.values),"f"),!__classPrivateFieldGet$7(this,_ZodEnum_cache,"f").has(e.data)){const s=this._getOrReturnCtx(e),n=this._def.values;return addIssueToContext(s,{received:s.data,code:ZodIssueCode.invalid_enum_value,options:n}),INVALID}return OK(e.data)}get options(){return this._def.values}get enum(){const e={};for(const s of this._def.values)e[s]=s;return e}get Values(){const e={};for(const s of this._def.values)e[s]=s;return e}get Enum(){const e={};for(const s of this._def.values)e[s]=s;return e}extract(e,s=this._def){return ZodEnum.create(e,{...this._def,...s})}exclude(e,s=this._def){return ZodEnum.create(this.options.filter(n=>!e.includes(n)),{...this._def,...s})}}_ZodEnum_cache=new WeakMap,ZodEnum.create=createZodEnum;class ZodNativeEnum extends ZodType{constructor(){super(...arguments),_ZodNativeEnum_cache.set(this,void 0)}_parse(e){const s=util.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==ZodParsedType.string&&n.parsedType!==ZodParsedType.number){const r=util.objectValues(s);return addIssueToContext(n,{expected:util.joinValues(r),received:n.parsedType,code:ZodIssueCode.invalid_type}),INVALID}if(__classPrivateFieldGet$7(this,_ZodNativeEnum_cache,"f")||__classPrivateFieldSet$6(this,_ZodNativeEnum_cache,new Set(util.getValidEnumValues(this._def.values)),"f"),!__classPrivateFieldGet$7(this,_ZodNativeEnum_cache,"f").has(e.data)){const r=util.objectValues(s);return addIssueToContext(n,{received:n.data,code:ZodIssueCode.invalid_enum_value,options:r}),INVALID}return OK(e.data)}get enum(){return this._def.values}}_ZodNativeEnum_cache=new WeakMap,ZodNativeEnum.create=(t,e)=>new ZodNativeEnum({values:t,typeName:ZodFirstPartyTypeKind.ZodNativeEnum,...processCreateParams(e)});class ZodPromise extends ZodType{unwrap(){return this._def.type}_parse(e){const{ctx:s}=this._processInputParams(e);if(s.parsedType!==ZodParsedType.promise&&s.common.async===!1)return addIssueToContext(s,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.promise,received:s.parsedType}),INVALID;const n=s.parsedType===ZodParsedType.promise?s.data:Promise.resolve(s.data);return OK(n.then(r=>this._def.type.parseAsync(r,{path:s.path,errorMap:s.common.contextualErrorMap})))}}ZodPromise.create=(t,e)=>new ZodPromise({type:t,typeName:ZodFirstPartyTypeKind.ZodPromise,...processCreateParams(e)});class ZodEffects extends ZodType{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===ZodFirstPartyTypeKind.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:s,ctx:n}=this._processInputParams(e),r=this._def.effect||null,a={addIssue:i=>{addIssueToContext(n,i),i.fatal?s.abort():s.dirty()},get path(){return n.path}};if(a.addIssue=a.addIssue.bind(a),r.type==="preprocess"){const i=r.transform(n.data,a);if(n.common.async)return Promise.resolve(i).then(async u=>{if(s.value==="aborted")return INVALID;const f=await this._def.schema._parseAsync({data:u,path:n.path,parent:n});return f.status==="aborted"?INVALID:f.status==="dirty"||s.value==="dirty"?DIRTY(f.value):f});{if(s.value==="aborted")return INVALID;const u=this._def.schema._parseSync({data:i,path:n.path,parent:n});return u.status==="aborted"?INVALID:u.status==="dirty"||s.value==="dirty"?DIRTY(u.value):u}}if(r.type==="refinement"){const i=u=>{const f=r.refinement(u,a);if(n.common.async)return Promise.resolve(f);if(f instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return u};if(n.common.async===!1){const u=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return u.status==="aborted"?INVALID:(u.status==="dirty"&&s.dirty(),i(u.value),{status:s.value,value:u.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(u=>u.status==="aborted"?INVALID:(u.status==="dirty"&&s.dirty(),i(u.value).then(()=>({status:s.value,value:u.value}))))}if(r.type==="transform")if(n.common.async===!1){const i=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!isValid(i))return i;const u=r.transform(i.value,a);if(u instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:s.value,value:u}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(i=>isValid(i)?Promise.resolve(r.transform(i.value,a)).then(u=>({status:s.value,value:u})):i);util.assertNever(r)}}ZodEffects.create=(t,e,s)=>new ZodEffects({schema:t,typeName:ZodFirstPartyTypeKind.ZodEffects,effect:e,...processCreateParams(s)}),ZodEffects.createWithPreprocess=(t,e,s)=>new ZodEffects({schema:e,effect:{type:"preprocess",transform:t},typeName:ZodFirstPartyTypeKind.ZodEffects,...processCreateParams(s)});class ZodOptional extends ZodType{_parse(e){return this._getType(e)===ZodParsedType.undefined?OK(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ZodOptional.create=(t,e)=>new ZodOptional({innerType:t,typeName:ZodFirstPartyTypeKind.ZodOptional,...processCreateParams(e)});class ZodNullable extends ZodType{_parse(e){return this._getType(e)===ZodParsedType.null?OK(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ZodNullable.create=(t,e)=>new ZodNullable({innerType:t,typeName:ZodFirstPartyTypeKind.ZodNullable,...processCreateParams(e)});class ZodDefault extends ZodType{_parse(e){const{ctx:s}=this._processInputParams(e);let n=s.data;return s.parsedType===ZodParsedType.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:s.path,parent:s})}removeDefault(){return this._def.innerType}}ZodDefault.create=(t,e)=>new ZodDefault({innerType:t,typeName:ZodFirstPartyTypeKind.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...processCreateParams(e)});class ZodCatch extends ZodType{_parse(e){const{ctx:s}=this._processInputParams(e),n={...s,common:{...s.common,issues:[]}},r=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return isAsync(r)?r.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new ZodError(n.common.issues)},input:n.data})})):{status:"valid",value:r.status==="valid"?r.value:this._def.catchValue({get error(){return new ZodError(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}ZodCatch.create=(t,e)=>new ZodCatch({innerType:t,typeName:ZodFirstPartyTypeKind.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...processCreateParams(e)});class ZodNaN extends ZodType{_parse(e){if(this._getType(e)!==ZodParsedType.nan){const n=this._getOrReturnCtx(e);return addIssueToContext(n,{code:ZodIssueCode.invalid_type,expected:ZodParsedType.nan,received:n.parsedType}),INVALID}return{status:"valid",value:e.data}}}ZodNaN.create=t=>new ZodNaN({typeName:ZodFirstPartyTypeKind.ZodNaN,...processCreateParams(t)});class ZodBranded extends ZodType{_parse(e){const{ctx:s}=this._processInputParams(e),n=s.data;return this._def.type._parse({data:n,path:s.path,parent:s})}unwrap(){return this._def.type}}class ZodPipeline extends ZodType{_parse(e){const{status:s,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return a.status==="aborted"?INVALID:a.status==="dirty"?(s.dirty(),DIRTY(a.value)):this._def.out._parseAsync({data:a.value,path:n.path,parent:n})})();{const r=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return r.status==="aborted"?INVALID:r.status==="dirty"?(s.dirty(),{status:"dirty",value:r.value}):this._def.out._parseSync({data:r.value,path:n.path,parent:n})}}static create(e,s){return new ZodPipeline({in:e,out:s,typeName:ZodFirstPartyTypeKind.ZodPipeline})}}class ZodReadonly extends ZodType{_parse(e){const s=this._def.innerType._parse(e),n=r=>(isValid(r)&&(r.value=Object.freeze(r.value)),r);return isAsync(s)?s.then(r=>n(r)):n(s)}unwrap(){return this._def.innerType}}ZodReadonly.create=(t,e)=>new ZodReadonly({innerType:t,typeName:ZodFirstPartyTypeKind.ZodReadonly,...processCreateParams(e)}),ZodObject.lazycreate;var ZodFirstPartyTypeKind;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})(ZodFirstPartyTypeKind||(ZodFirstPartyTypeKind={}));const stringType=ZodString.create,anyType=ZodAny.create;ZodNever.create,ZodArray.create;const objectType=ZodObject.create;ZodObject.strictCreate,ZodUnion.create,ZodIntersection.create,ZodTuple.create,ZodEnum.create,ZodPromise.create,ZodOptional.create,ZodNullable.create;let getRandomValues;const rnds8=new Uint8Array(16);function rng(){if(!getRandomValues&&(getRandomValues=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!getRandomValues))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}const REGEX=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function validate$1(t){return typeof t=="string"&&REGEX.test(t)}const byteToHex=[];for(let t=0;t<256;++t)byteToHex.push((t+256).toString(16).slice(1));function unsafeStringify(t,e=0){return byteToHex[t[e+0]]+byteToHex[t[e+1]]+byteToHex[t[e+2]]+byteToHex[t[e+3]]+"-"+byteToHex[t[e+4]]+byteToHex[t[e+5]]+"-"+byteToHex[t[e+6]]+byteToHex[t[e+7]]+"-"+byteToHex[t[e+8]]+byteToHex[t[e+9]]+"-"+byteToHex[t[e+10]]+byteToHex[t[e+11]]+byteToHex[t[e+12]]+byteToHex[t[e+13]]+byteToHex[t[e+14]]+byteToHex[t[e+15]]}const randomUUID=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),native={randomUUID};function v4(t,e,s){if(native.randomUUID&&!e&&!t)return native.randomUUID();t=t||{};const n=t.random||(t.rng||rng)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){s=s||0;for(let r=0;r<16;++r)e[s+r]=n[r];return e}return unsafeStringify(n)}const isBrowser$1=()=>typeof window<"u"&&typeof window.document<"u",isWebWorker$1=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",isJsDom$1=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),isDeno$1=()=>typeof Deno<"u",isNode$1=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!isDeno$1(),getEnv$1=()=>{let t;return isBrowser$1()?t="browser":isNode$1()?t="node":isWebWorker$1()?t="webworker":isJsDom$1()?t="jsdom":isDeno$1()?t="deno":t="other",t};let runtimeEnvironment$1;async function getRuntimeEnvironment$1(){return runtimeEnvironment$1===void 0&&(runtimeEnvironment$1={library:"langchain-js",runtime:getEnv$1()}),runtimeEnvironment$1}function getEnvironmentVariable$1(t){try{return typeof process<"u"?process.env?.[t]:void 0}catch{return}}class BaseCallbackHandlerMethodsClass{}class BaseCallbackHandler extends BaseCallbackHandlerMethodsClass{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,get_lc_unique_name(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:getEnvironmentVariable$1("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.awaitHandlers=e._awaitHandler??this.awaitHandlers)}copy(){return new this.constructor(this)}toJSON(){return Serializable.prototype.toJSON.call(this)}toJSONNotImplemented(){return Serializable.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class s extends BaseCallbackHandler{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:v4()}),Object.assign(this,e)}}return new s}}var ansiStyles={exports:{}};ansiStyles.exports,function(t){const s=(a=0)=>i=>`\x1B[${38+a};5;${i}m`,n=(a=0)=>(i,u,f)=>`\x1B[${38+a};2;${i};${u};${f}m`;function r(){const a=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[u,f]of Object.entries(i)){for(const[c,d]of Object.entries(f))i[c]={open:`\x1B[${d[0]}m`,close:`\x1B[${d[1]}m`},f[c]=i[c],a.set(d[0],d[1]);Object.defineProperty(i,u,{value:f,enumerable:!1})}return Object.defineProperty(i,"codes",{value:a,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",i.color.ansi256=s(),i.color.ansi16m=n(),i.bgColor.ansi256=s(10),i.bgColor.ansi16m=n(10),Object.defineProperties(i,{rgbToAnsi256:{value:(u,f,c)=>u===f&&f===c?u<8?16:u>248?231:Math.round((u-8)/247*24)+232:16+36*Math.round(u/255*5)+6*Math.round(f/255*5)+Math.round(c/255*5),enumerable:!1},hexToRgb:{value:u=>{const f=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(u.toString(16));if(!f)return[0,0,0];let{colorString:c}=f.groups;c.length===3&&(c=c.split("").map(h=>h+h).join(""));const d=Number.parseInt(c,16);return[d>>16&255,d>>8&255,d&255]},enumerable:!1},hexToAnsi256:{value:u=>i.rgbToAnsi256(...i.hexToRgb(u)),enumerable:!1}}),i}Object.defineProperty(t,"exports",{enumerable:!0,get:r})}(ansiStyles);var ansiStylesExports=ansiStyles.exports;const styles=getDefaultExportFromCjs(ansiStylesExports);function _coerceToDict$1(t,e){return t&&!Array.isArray(t)&&typeof t=="object"?t:{[e]:t}}function stripNonAlphanumeric(t){return t.replace(/[-:.]/g,"")}function convertToDottedOrderFormat(t,e){return stripNonAlphanumeric(`${new Date(t).toISOString().slice(0,-1)}000Z`)+e}class BaseTracer extends BaseCallbackHandler{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,s){e.child_runs.push(s)}async _startTrace(e){const s=convertToDottedOrderFormat(e.start_time,e.id),n={...e};if(n.parent_run_id!==void 0){const r=this.runMap.get(n.parent_run_id);r&&(this._addChildRun(r,n),r.child_execution_order=Math.max(r.child_execution_order,n.child_execution_order),n.trace_id=r.trace_id,r.dotted_order!==void 0&&(n.dotted_order=[r.dotted_order,s].join(".")))}else n.trace_id=n.id,n.dotted_order=s;this.runMap.set(n.id,n),await this.onRunCreate?.(n)}async _endTrace(e){const s=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);s?s.child_execution_order=Math.max(s.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){const s=e!==void 0&&this.runMap.get(e);return s?s.child_execution_order+1:1}async handleLLMStart(e,s,n,r,a,i,u,f){const c=this._getExecutionOrder(r),d=Date.now(),h=u?{...a,metadata:u}:a,m={id:n,name:f??e.id[e.id.length-1],parent_run_id:r,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:{prompts:s},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:h??{},tags:i||[]};return await this._startTrace(m),await this.onLLMStart?.(m),m}async handleChatModelStart(e,s,n,r,a,i,u,f){const c=this._getExecutionOrder(r),d=Date.now(),h=u?{...a,metadata:u}:a,m={id:n,name:f??e.id[e.id.length-1],parent_run_id:r,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:{messages:s},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:h??{},tags:i||[]};return await this._startTrace(m),await this.onLLMStart?.(m),m}async handleLLMEnd(e,s){const n=this.runMap.get(s);if(!n||n?.run_type!=="llm")throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await this.onLLMEnd?.(n),await this._endTrace(n),n}async handleLLMError(e,s){const n=this.runMap.get(s);if(!n||n?.run_type!=="llm")throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await this.onLLMError?.(n),await this._endTrace(n),n}async handleChainStart(e,s,n,r,a,i,u,f){const c=this._getExecutionOrder(r),d=Date.now(),h={id:n,name:f??e.id[e.id.length-1],parent_run_id:r,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:s,execution_order:c,child_execution_order:c,run_type:u??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(h),await this.onChainStart?.(h),h}async handleChainEnd(e,s,n,r,a){const i=this.runMap.get(s);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=_coerceToDict$1(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),a?.inputs!==void 0&&(i.inputs=_coerceToDict$1(a.inputs,"input")),await this.onChainEnd?.(i),await this._endTrace(i),i}async handleChainError(e,s,n,r,a){const i=this.runMap.get(s);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),a?.inputs!==void 0&&(i.inputs=_coerceToDict$1(a.inputs,"input")),await this.onChainError?.(i),await this._endTrace(i),i}async handleToolStart(e,s,n,r,a,i,u){const f=this._getExecutionOrder(r),c=Date.now(),d={id:n,name:u??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:s},execution_order:f,child_execution_order:f,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(d),await this.onToolStart?.(d),d}async handleToolEnd(e,s){const n=this.runMap.get(s);if(!n||n?.run_type!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await this.onToolEnd?.(n),await this._endTrace(n),n}async handleToolError(e,s){const n=this.runMap.get(s);if(!n||n?.run_type!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await this.onToolError?.(n),await this._endTrace(n),n}async handleAgentAction(e,s){const n=this.runMap.get(s);if(!n||n?.run_type!=="chain")return;const r=n;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(n)}async handleAgentEnd(e,s){const n=this.runMap.get(s);!n||n?.run_type!=="chain"||(n.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(n))}async handleRetrieverStart(e,s,n,r,a,i,u){const f=this._getExecutionOrder(r),c=Date.now(),d={id:n,name:u??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:s},execution_order:f,child_execution_order:f,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(d),await this.onRetrieverStart?.(d),d}async handleRetrieverEnd(e,s){const n=this.runMap.get(s);if(!n||n?.run_type!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await this.onRetrieverEnd?.(n),await this._endTrace(n),n}async handleRetrieverError(e,s){const n=this.runMap.get(s);if(!n||n?.run_type!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await this.onRetrieverError?.(n),await this._endTrace(n),n}async handleText(e,s){const n=this.runMap.get(s);!n||n?.run_type!=="chain"||(n.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(n))}async handleLLMNewToken(e,s,n,r,a,i){const u=this.runMap.get(n);if(!u||u?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return u.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:s,chunk:i?.chunk}}),await this.onLLMNewToken?.(u,e,{chunk:i?.chunk}),u}}function wrap(t,e){return`${t.open}${e}${t.close}`}function tryJsonStringify(t,e){try{return JSON.stringify(t,null,2)}catch{return e}}function elapsed(t){if(!t.end_time)return"";const e=t.end_time-t.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color}=styles;class ConsoleCallbackHandler extends BaseTracer{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const s=[];let n=e;for(;n.parent_run_id;){const r=this.runMap.get(n.parent_run_id);if(r)s.push(r),n=r;else break}return s}getBreadcrumbs(e){const n=[...this.getParents(e).reverse(),e].map((r,a,i)=>{const u=`${r.execution_order}:${r.run_type}:${r.name}`;return a===i.length-1?wrap(styles.bold,u):u}).join(" > ");return wrap(color.grey,n)}onChainStart(e){const s=this.getBreadcrumbs(e);console.log(`${wrap(color.green,"[chain/start]")} [${s}] Entering Chain run with input: ${tryJsonStringify(e.inputs,"[inputs]")}`)}onChainEnd(e){const s=this.getBreadcrumbs(e);console.log(`${wrap(color.cyan,"[chain/end]")} [${s}] [${elapsed(e)}] Exiting Chain run with output: ${tryJsonStringify(e.outputs,"[outputs]")}`)}onChainError(e){const s=this.getBreadcrumbs(e);console.log(`${wrap(color.red,"[chain/error]")} [${s}] [${elapsed(e)}] Chain run errored with error: ${tryJsonStringify(e.error,"[error]")}`)}onLLMStart(e){const s=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map(r=>r.trim())}:e.inputs;console.log(`${wrap(color.green,"[llm/start]")} [${s}] Entering LLM run with input: ${tryJsonStringify(n,"[inputs]")}`)}onLLMEnd(e){const s=this.getBreadcrumbs(e);console.log(`${wrap(color.cyan,"[llm/end]")} [${s}] [${elapsed(e)}] Exiting LLM run with output: ${tryJsonStringify(e.outputs,"[response]")}`)}onLLMError(e){const s=this.getBreadcrumbs(e);console.log(`${wrap(color.red,"[llm/error]")} [${s}] [${elapsed(e)}] LLM run errored with error: ${tryJsonStringify(e.error,"[error]")}`)}onToolStart(e){const s=this.getBreadcrumbs(e);console.log(`${wrap(color.green,"[tool/start]")} [${s}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){const s=this.getBreadcrumbs(e);console.log(`${wrap(color.cyan,"[tool/end]")} [${s}] [${elapsed(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){const s=this.getBreadcrumbs(e);console.log(`${wrap(color.red,"[tool/error]")} [${s}] [${elapsed(e)}] Tool run errored with error: ${tryJsonStringify(e.error,"[error]")}`)}onRetrieverStart(e){const s=this.getBreadcrumbs(e);console.log(`${wrap(color.green,"[retriever/start]")} [${s}] Entering Retriever run with input: ${tryJsonStringify(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const s=this.getBreadcrumbs(e);console.log(`${wrap(color.cyan,"[retriever/end]")} [${s}] [${elapsed(e)}] Exiting Retriever run with output: ${tryJsonStringify(e.outputs,"[outputs]")}`)}onRetrieverError(e){const s=this.getBreadcrumbs(e);console.log(`${wrap(color.red,"[retriever/error]")} [${s}] [${elapsed(e)}] Retriever run errored with error: ${tryJsonStringify(e.error,"[error]")}`)}onAgentAction(e){const s=e,n=this.getBreadcrumbs(e);console.log(`${wrap(color.blue,"[agent/action]")} [${n}] Agent selected action: ${tryJsonStringify(s.actions[s.actions.length-1],"[action]")}`)}}const STATUS_NO_RETRY=[400,401,403,404,405,406,407,408],STATUS_IGNORE=[409];class AsyncCaller{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;const s="default"in _default?_default.default:_default;this.queue=new s({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...s){const n=this.onFailedResponseHook;return this.queue.add(()=>pRetry$1(()=>e(...s).catch(r=>{throw r instanceof Error?r:new Error(r)}),{async onFailedAttempt(r){if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||r?.code==="ECONNABORTED")throw r;const a=r?.response,i=a?.status;if(i){if(STATUS_NO_RETRY.includes(+i))throw r;if(STATUS_IGNORE.includes(+i))return;n&&await n(a)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,s,...n){return e.signal?Promise.race([this.call(s,...n),new Promise((r,a)=>{e.signal?.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(s,...n)}fetch(...e){return this.call(()=>fetch(...e).then(s=>s.ok?s:Promise.reject(s)))}}function isLangChainMessage(t){return typeof t?._getType=="function"}function convertLangChainMessageToExample(t){const e={type:t._getType(),data:{content:t.content}};return t?.additional_kwargs&&Object.keys(t.additional_kwargs).length>0&&(e.data.additional_kwargs={...t.additional_kwargs}),e}let globalEnv;const isBrowser=()=>typeof window<"u"&&typeof window.document<"u",isWebWorker=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",isJsDom=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),isDeno=()=>typeof Deno<"u",isNode=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!isDeno(),getEnv=()=>globalEnv||(isBrowser()?globalEnv="browser":isNode()?globalEnv="node":isWebWorker()?globalEnv="webworker":isJsDom()?globalEnv="jsdom":isDeno()?globalEnv="deno":globalEnv="other",globalEnv);let runtimeEnvironment;async function getRuntimeEnvironment(){if(runtimeEnvironment===void 0){const t=getEnv(),e=getShas();runtimeEnvironment={library:"langsmith",runtime:t,sdk:"langsmith-js",sdk_version:__version__,...e}}return runtimeEnvironment}function getLangChainEnvVarsMetadata(){const t=getEnvironmentVariables()||{},e={},s=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[n,r]of Object.entries(t))n.startsWith("LANGCHAIN_")&&typeof r=="string"&&!s.includes(n)&&!n.toLowerCase().includes("key")&&!n.toLowerCase().includes("secret")&&!n.toLowerCase().includes("token")&&(n==="LANGCHAIN_REVISION_ID"?e.revision_id=r:e[n]=r);return e}function getEnvironmentVariables(){try{return typeof process<"u"&&process.env?Object.entries(process.env).reduce((t,[e,s])=>(t[e]=String(s),t),{}):void 0}catch{return}}function getEnvironmentVariable(t){try{return typeof process<"u"?process.env?.[t]:void 0}catch{return}}let cachedCommitSHAs;function getShas(){if(cachedCommitSHAs!==void 0)return cachedCommitSHAs;const t=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const s of t){const n=getEnvironmentVariable(s);n!==void 0&&(e[s]=n)}return cachedCommitSHAs=e,e}async function mergeRuntimeEnvIntoRunCreates(t){const e=await getRuntimeEnvironment(),s=getLangChainEnvVarsMetadata();return t.map(n=>{const r=n.extra??{},a=r.metadata;return n.extra={...r,runtime:{...e,...r?.runtime},metadata:{...s,...s.revision_id||n.revision_id?{revision_id:n.revision_id??s.revision_id}:{},...a}},n})}const getTracingSamplingRate=()=>{const t=getEnvironmentVariable("LANGCHAIN_TRACING_SAMPLING_RATE");if(t===void 0)return;const e=parseFloat(t);if(e<0||e>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},isLocalhost=t=>{const s=t.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return s==="localhost"||s==="127.0.0.1"||s==="::1"},raiseForStatus=async(t,e)=>{const s=await t.text();if(!t.ok)throw new Error(`Failed to ${e}: ${t.status} ${t.statusText} ${s}`)};async function toArray(t){const e=[];for await(const s of t)e.push(s);return e}function trimQuotes(t){if(t!==void 0)return t.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function assertUuid(t){if(!validate$1(t))throw new Error(`Invalid UUID: ${t}`)}const handle429=async t=>{if(t?.status===429){const e=parseInt(t.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(s=>setTimeout(s,e)),!0}return!1};class Queue{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise(s=>{this.items.push([e,s])})}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");const s=[];for(;s.length<e&&this.items.length;){const n=this.items.shift();if(n)s.push(n);else break}return[s.map(n=>n[0]),()=>s.forEach(n=>n[1]())]}}const DEFAULT_BATCH_SIZE_LIMIT_BYTES=20971520;class Client{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Queue}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const s=Client.getDefaultClientConfig();this.tracingSampleRate=getTracingSamplingRate(),this.apiUrl=trimQuotes(e.apiUrl??s.apiUrl)??"",this.apiKey=trimQuotes(e.apiKey??s.apiKey),this.webUrl=trimQuotes(e.webUrl??s.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new AsyncCaller(e.callerOptions??{}),this.batchIngestCaller=new AsyncCaller({...e.callerOptions??{},onFailedResponseHook:handle429}),this.hideInputs=e.hideInputs??s.hideInputs,this.hideOutputs=e.hideOutputs??s.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){const e=getEnvironmentVariable("LANGCHAIN_API_KEY"),s=getEnvironmentVariable("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",n=getEnvironmentVariable("LANGCHAIN_HIDE_INPUTS")==="true",r=getEnvironmentVariable("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:s,apiKey:e,webUrl:void 0,hideInputs:n,hideOutputs:r}}getHostUrl(){return this.webUrl?this.webUrl:isLocalhost(this.apiUrl)?(this.webUrl="http://localhost","http://localhost"):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com","https://dev.smith.langchain.com"):(this.webUrl="https://smith.langchain.com","https://smith.langchain.com")}get headers(){const e={"User-Agent":`langsmith-js/${__version__}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const s={...e};return s.inputs!==void 0&&(s.inputs=this.processInputs(s.inputs)),s.outputs!==void 0&&(s.outputs=this.processOutputs(s.outputs)),s}async _getResponse(e,s){const n=s?.toString()??"",r=`${this.apiUrl}${e}?${n}`,a=await this.caller.call(fetch,r,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok)throw new Error(`Failed to fetch ${e}: ${a.status} ${a.statusText}`);return a}async _get(e,s){return(await this._getResponse(e,s)).json()}async*_getPaginated(e,s=new URLSearchParams){let n=Number(s.get("offset"))||0;const r=Number(s.get("limit"))||100;for(;;){s.set("offset",String(n)),s.set("limit",String(r));const a=`${this.apiUrl}${e}?${s}`,i=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);const u=await i.json();if(u.length===0||(yield u,u.length<r))break;n+=u.length}}async*_getCursorPaginatedList(e,s=null,n="POST",r="runs"){const a=s?{...s}:{};for(;;){const u=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)})).json();if(!u||!u[r])break;yield u[r];const f=u.cursors;if(!f||!f.next)break;a.cursor=f.next}}_filterForSampling(e,s=!1){if(this.tracingSampleRate===void 0)return e;if(s){const n=[];for(const r of e)this.sampledPostUuids.has(r.id)&&(n.push(r),this.sampledPostUuids.delete(r.id));return n}else{const n=[];for(const r of e)Math.random()<this.tracingSampleRate&&(n.push(r),this.sampledPostUuids.add(r.id));return n}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){const[e,s]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length){s();return}try{await this.batchIngestRuns({runCreates:e.filter(n=>n.action==="create").map(n=>n.item),runUpdates:e.filter(n=>n.action==="update").map(n=>n.item)})}finally{s()}}}async processRunOperation(e,s){const n=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;const r=this.autoBatchQueue.push(e);return(s||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},n?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),r}async _getServerInfo(){const e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch{return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;const s={...this.headers,"Content-Type":"application/json"},n=e.project_name;delete e.project_name;const r=this.prepareRunCreateOrUpdateInputs({session_name:n,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){this.processRunOperation({action:"create",item:r}).catch(console.error);return}const a=await mergeRuntimeEnvIntoRunCreates([r]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:s,body:JSON.stringify(a[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:s}){if(e===void 0&&s===void 0)return;let n=e?.map(c=>this.prepareRunCreateOrUpdateInputs(c))??[],r=s?.map(c=>this.prepareRunCreateOrUpdateInputs(c))??[];if(n.length>0&&r.length>0){const c=n.reduce((h,m)=>(m.id&&(h[m.id]=m),h),{}),d=[];for(const h of r)h.id!==void 0&&c[h.id]?c[h.id]={...c[h.id],...h}:d.push(h);n=Object.values(c),r=d}const a={post:this._filterForSampling(n),patch:this._filterForSampling(r,!0)};if(!a.post.length&&!a.patch.length)return;if(n=await mergeRuntimeEnvIntoRunCreates(n),this.batchEndpointSupported===void 0&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(const c of a.post)await this.createRun(c);for(const c of a.patch)c.id!==void 0&&await this.updateRun(c.id,c);return}const i=this.serverInfo?.batch_ingest_config?.size_limit_bytes??DEFAULT_BATCH_SIZE_LIMIT_BYTES,u={post:[],patch:[]};let f=0;for(const c of["post","patch"]){const d=c,h=a[d].reverse();let m=h.pop();for(;m!==void 0;){const _=JSON.stringify(m);f>0&&f+_.length>i&&(await this._postBatchIngestRuns(JSON.stringify(u)),f=0,u.post=[],u.patch=[]),f+=_.length,u[d].push(m),m=h.pop()}}(u.post.length>0||u.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(u))}async _postBatchIngestRuns(e){const s={...this.headers,"Content-Type":"application/json",Accept:"application/json"},n=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:s,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(n,"batch create run")}async updateRun(e,s){assertUuid(e),s.inputs&&(s.inputs=this.processInputs(s.inputs)),s.outputs&&(s.outputs=this.processOutputs(s.outputs));const n={...s,id:e};if(!this._filterForSampling([n],!0).length)return;if(this.autoBatchTracing&&n.trace_id!==void 0&&n.dotted_order!==void 0){if(s.end_time!==void 0&&n.parent_run_id===void 0){await this.processRunOperation({action:"update",item:n},!0);return}else this.processRunOperation({action:"update",item:n}).catch(console.error);return}const r={...this.headers,"Content-Type":"application/json"},a=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(a,"update run")}async readRun(e,{loadChildRuns:s}={loadChildRuns:!1}){assertUuid(e);let n=await this._get(`/runs/${e}`);return s&&n.child_run_ids&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:s,projectOpts:n}){if(s!==void 0){let r;s.session_id?r=s.session_id:n?.projectName?r=(await this.readProject({projectName:n?.projectName})).id:n?.projectId?r=n?.projectId:r=(await this.readProject({projectName:getEnvironmentVariable("LANGCHAIN_PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r}/r/${s.id}?poll=true`}else if(e!==void 0){const r=await this.readRun(e);if(!r.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${r.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const s=await toArray(this.listRuns({id:e.child_run_ids})),n={},r={};s.sort((a,i)=>(a?.dotted_order??"").localeCompare(i?.dotted_order??""));for(const a of s){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);a.parent_run_id in n||(n[a.parent_run_id]=[]),n[a.parent_run_id].push(a),r[a.id]=a}e.child_runs=n[e.id]||[];for(const a in n)a!==e.id&&(r[a].child_runs=n[a]);return e}async*listRuns(e){const{projectId:s,projectName:n,parentRunId:r,traceId:a,referenceExampleId:i,startTime:u,executionOrder:f,runType:c,error:d,id:h,query:m,filter:_,traceFilter:p,treeFilter:b,limit:A}=e;let T=[];if(s&&(T=Array.isArray(s)?s:[s]),n){const N=Array.isArray(n)?n:[n],x=await Promise.all(N.map(y=>this.readProject({projectName:y}).then(S=>S.id)));T.push(...x)}const v={session:T.length?T:null,run_type:c,reference_example:i,query:m,filter:_,trace_filter:p,tree_filter:b,execution_order:f,parent_run:r,start_time:u?u.toISOString():null,error:d,id:h,limit:A,trace:a};for await(const N of this._getCursorPaginatedList("/runs/query",v))yield*N}async shareRun(e,{shareId:s}={}){const n={run_id:e,share_token:s||v4()};assertUuid(e);const a=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){assertUuid(e);const s=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(s,"unshare run")}async readRunSharedLink(e){assertUuid(e);const n=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(n===null||!("share_token"in n)))return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:s}={}){const n=new URLSearchParams({share_token:e});if(s!==void 0)for(const i of s)n.append("id",i);return assertUuid(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,s){if(!e&&!s)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:s})).id),assertUuid(e);const r=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,s){if(!e&&!s)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:s})).id);const n={dataset_id:e};assertUuid(e);const a=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){assertUuid(e);const s=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(s,"unshare dataset")}async readSharedDataset(e){return assertUuid(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createProject({projectName:e,description:s=null,metadata:n=null,upsert:r=!1,projectExtra:a=null,referenceDatasetId:i=null}){const u=r?"?upsert=true":"",f=`${this.apiUrl}/sessions${u}`,c=a||{};n&&(c.metadata=n);const d={name:e,extra:c,description:s};i!==null&&(d.reference_dataset_id=i);const h=await this.caller.call(fetch,f,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(d),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),m=await h.json();if(!h.ok)throw new Error(`Failed to create session ${e}: ${h.status} ${h.statusText}`);return m}async updateProject(e,{name:s=null,description:n=null,metadata:r=null,projectExtra:a=null,endTime:i=null}){const u=`${this.apiUrl}/sessions/${e}`;let f=a;r&&(f={...f||{},metadata:r});const c={name:s,extra:f,description:n,end_time:i?new Date(i).toISOString():null},d=await this.caller.call(fetch,u,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),h=await d.json();if(!d.ok)throw new Error(`Failed to update project ${e}: ${d.status} ${d.statusText}`);return h}async hasProject({projectId:e,projectName:s}){let n="/sessions";const r=new URLSearchParams;if(e!==void 0&&s!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)assertUuid(e),n+=`/${e}`;else if(s!==void 0)r.append("name",s);else throw new Error("Must provide projectName or projectId");const a=await this.caller.call(fetch,`${this.apiUrl}${n}?${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const i=await a.json();return a.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:s,includeStats:n}){let r="/sessions";const a=new URLSearchParams;if(e!==void 0&&s!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)assertUuid(e),r+=`/${e}`;else if(s!==void 0)a.append("name",s);else throw new Error("Must provide projectName or projectId");n!==void 0&&a.append("include_stats",n.toString());const i=await this._get(r,a);let u;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${s}] not found`);u=i[0]}else u=i;return u}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const s of this._getPaginated("/sessions",e))return this._tenantId=s[0].tenant_id,s[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:s,nameContains:n,referenceDatasetId:r,referenceDatasetName:a,referenceFree:i}={}){const u=new URLSearchParams;if(e!==void 0)for(const f of e)u.append("id",f);if(s!==void 0&&u.append("name",s),n!==void 0&&u.append("name_contains",n),r!==void 0)u.append("reference_dataset",r);else if(a!==void 0){const f=await this.readDataset({datasetName:a});u.append("reference_dataset",f.id)}i!==void 0&&u.append("reference_free",i.toString());for await(const f of this._getPaginated("/sessions",u))yield*f}async deleteProject({projectId:e,projectName:s}){let n;if(e===void 0&&s===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&s!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?n=(await this.readProject({projectName:s})).id:n=e,assertUuid(n);const r=await this.caller.call(fetch,`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(r,`delete session ${n} (${s})`)}async uploadCsv({csvFile:e,fileName:s,inputKeys:n,outputKeys:r,description:a,dataType:i,name:u}){const f=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,s),n.forEach(m=>{c.append("input_keys",m)}),r.forEach(m=>{c.append("output_keys",m)}),a&&c.append("description",a),i&&c.append("data_type",i),u&&c.append("name",u);const d=await this.caller.call(fetch,f,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!d.ok){const m=await d.json();throw m.detail&&m.detail.includes("already exists")?new Error(`Dataset ${s} already exists`):new Error(`Failed to upload CSV: ${d.status} ${d.statusText}`)}return await d.json()}async createDataset(e,{description:s,dataType:n}={}){const r={name:e,description:s};n&&(r.data_type=n);const a=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok){const u=await a.json();throw u.detail&&u.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${a.status} ${a.statusText}`)}return await a.json()}async readDataset({datasetId:e,datasetName:s}){let n="/datasets";const r=new URLSearchParams({limit:"1"});if(e!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)assertUuid(e),n+=`/${e}`;else if(s!==void 0)r.append("name",s);else throw new Error("Must provide datasetName or datasetId");const a=await this._get(n,r);let i;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${e}, name=${s}] not found`);i=a[0]}else i=a;return i}async diffDatasetVersions({datasetId:e,datasetName:s,fromVersion:n,toVersion:r}){let a=e;if(a===void 0&&s===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:s})).id);const i=new URLSearchParams({from_version:typeof n=="string"?n:n.toISOString(),to_version:typeof r=="string"?r:r.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:s}){const n="/datasets";if(e===void 0)if(s!==void 0)e=(await this.readDataset({datasetName:s})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${n}/${e}/openai_ft`)).text()).trim().split(`
`).map(u=>JSON.parse(u))}async*listDatasets({limit:e=100,offset:s=0,datasetIds:n,datasetName:r,datasetNameContains:a}={}){const i="/datasets",u=new URLSearchParams({limit:e.toString(),offset:s.toString()});if(n!==void 0)for(const f of n)u.append("id",f);r!==void 0&&u.append("name",r),a!==void 0&&u.append("name_contains",a);for await(const f of this._getPaginated(i,u))yield*f}async deleteDataset({datasetId:e,datasetName:s}){let n="/datasets",r=e;if(e!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(s!==void 0&&(r=(await this.readDataset({datasetName:s})).id),r!==void 0)assertUuid(r),n+=`/${r}`;else throw new Error("Must provide datasetName or datasetId");const a=await this.caller.call(fetch,this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok)throw new Error(`Failed to delete ${n}: ${a.status} ${a.statusText}`);await a.json()}async createExample(e,s,{datasetId:n,datasetName:r,createdAt:a,exampleId:i}){let u=n;if(u===void 0&&r===void 0)throw new Error("Must provide either datasetName or datasetId");if(u!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");u===void 0&&(u=(await this.readDataset({datasetName:r})).id);const c={dataset_id:u,inputs:e,outputs:s,created_at:(a||new Date)?.toISOString(),id:i},d=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!d.ok)throw new Error(`Failed to create example: ${d.status} ${d.statusText}`);return await d.json()}async createExamples(e){const{inputs:s,outputs:n,sourceRunIds:r,exampleIds:a,datasetId:i,datasetName:u}=e;let f=i;if(f===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(f!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");f===void 0&&(f=(await this.readDataset({datasetName:u})).id);const c=s.map((m,_)=>({dataset_id:f,inputs:m,outputs:n?n[_]:void 0,id:a?a[_]:void 0,source_run_id:r?r[_]:void 0})),d=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!d.ok)throw new Error(`Failed to create examples: ${d.status} ${d.statusText}`);return await d.json()}async createLLMExample(e,s,n){return this.createExample({input:e},{output:s},n)}async createChatExample(e,s,n){const r=e.map(i=>isLangChainMessage(i)?convertLangChainMessageToExample(i):i),a=isLangChainMessage(s)?convertLangChainMessageToExample(s):s;return this.createExample({input:r},{output:a},n)}async readExample(e){assertUuid(e);const s=`/examples/${e}`;return await this._get(s)}async*listExamples({datasetId:e,datasetName:s,exampleIds:n,asOf:r,inlineS3Urls:a}={}){let i;if(e!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)i=e;else if(s!==void 0)i=(await this.readDataset({datasetName:s})).id;else throw new Error("Must provide a datasetName or datasetId");const u=new URLSearchParams({dataset:i}),f=r?typeof r=="string"?r:r?.toISOString():void 0;f&&u.append("as_of",f);const c=a??!0;if(u.append("inline_s3_urls",c.toString()),n!==void 0)for(const d of n)u.append("id",d);for await(const d of this._getPaginated("/examples",u))yield*d}async deleteExample(e){assertUuid(e);const s=`/examples/${e}`,n=await this.caller.call(fetch,this.apiUrl+s,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to delete ${s}: ${n.status} ${n.statusText}`);await n.json()}async updateExample(e,s){assertUuid(e);const n=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to update example ${e}: ${n.status} ${n.statusText}`);return await n.json()}async evaluateRun(e,s,{sourceInfo:n,loadChildRuns:r,referenceExample:a}={loadChildRuns:!1}){let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:r});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(a=await this.readExample(i.reference_example_id));const u=await s.evaluateRun(i,a);let f=n??{};u.evaluatorInfo&&(f={...f,...u.evaluatorInfo});const c=u.targetRunId??i.id;return await this.createFeedback(c,u.key,{score:u?.score,value:u?.value,comment:u?.comment,correction:u?.correction,sourceInfo:f,feedbackSourceType:"model",sourceRunId:u?.sourceRunId})}async createFeedback(e,s,{score:n,value:r,correction:a,comment:i,sourceInfo:u,feedbackSourceType:f="api",sourceRunId:c,feedbackId:d,feedbackConfig:h}){const m={type:f??"api",metadata:u??{}};c!==void 0&&m?.metadata!==void 0&&!m.metadata.__run&&(m.metadata.__run={run_id:c}),m?.metadata!==void 0&&m.metadata.__run?.run_id!==void 0&&assertUuid(m.metadata.__run.run_id);const _={id:d??v4(),run_id:e,key:s,score:n,value:r,correction:a,comment:i,feedback_source:m,feedbackConfig:h},p=`${this.apiUrl}/feedback`,b=await this.caller.call(fetch,p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(_),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await raiseForStatus(b,"create feedback"),_}async updateFeedback(e,{score:s,value:n,correction:r,comment:a}){const i={};s!=null&&(i.score=s),n!=null&&(i.value=n),r!=null&&(i.correction=r),a!=null&&(i.comment=a),assertUuid(e);const u=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(u,"update feedback")}async readFeedback(e){assertUuid(e);const s=`/feedback/${e}`;return await this._get(s)}async deleteFeedback(e){assertUuid(e);const s=`/feedback/${e}`,n=await this.caller.call(fetch,this.apiUrl+s,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to delete ${s}: ${n.status} ${n.statusText}`);await n.json()}async*listFeedback({runIds:e,feedbackKeys:s,feedbackSourceTypes:n}={}){const r=new URLSearchParams;if(e&&r.append("run",e.join(",")),s)for(const a of s)r.append("key",a);if(n)for(const a of n)r.append("source",a);for await(const a of this._getPaginated("/feedback",r))yield*a}async createPresignedFeedbackToken(e,s,{expiration:n,feedbackConfig:r}={}){const a={run_id:e,feedback_key:s,feedback_config:r};return n?typeof n=="string"?a.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(a.expires_in=n):a.expires_in={hours:3},await(await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){assertUuid(e);const s=new URLSearchParams({run_id:e});for await(const n of this._getPaginated("/feedback/tokens",s))yield*n}}const __version__="0.1.14";class LangChainTracer extends BaseTracer{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:s,projectName:n,client:r}=e;this.projectName=n??getEnvironmentVariable$1("LANGCHAIN_PROJECT")??getEnvironmentVariable$1("LANGCHAIN_SESSION"),this.exampleId=s,this.client=r??new Client({})}async _convertToCreate(e,s=void 0){return{...e,extra:{...e.extra,runtime:await getRuntimeEnvironment$1()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:s}}async persistRun(e){}async onRunCreate(e){const s=await this._convertToCreate(e,this.exampleId);await this.client.createRun(s)}async onRunUpdate(e){const s={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,s)}getRun(e){return this.runMap.get(e)}}async function getTracingV2CallbackHandler(){return new LangChainTracer}let queue;function createQueue(){const t="default"in _default?_default.default:_default;return new t({autoStart:!0,concurrency:1})}async function consumeCallback(t,e){e===!0?await t():(typeof queue>"u"&&(queue=createQueue()),queue.add(t))}class BaseCallbackManager{setHandler(e){return this.setHandlers([e])}}class BaseRunManager{constructor(e,s,n,r,a,i,u,f){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:f})}async handleText(e){await Promise.all(this.handlers.map(s=>consumeCallback(async()=>{try{await s.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(n){console.error(`Error in handler ${s.constructor.name}, handleText: ${n}`)}},s.awaitHandlers)))}}class CallbackManagerForRetrieverRun extends BaseRunManager{getChild(e){const s=new CallbackManager(this.runId);return s.setHandlers(this.inheritableHandlers),s.addTags(this.inheritableTags),s.addMetadata(this.inheritableMetadata),e&&s.addTags([e],!1),s}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(s=>consumeCallback(async()=>{if(!s.ignoreRetriever)try{await s.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch{console.error(`Error in handler ${s.constructor.name}, handleRetriever`)}},s.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(s=>consumeCallback(async()=>{if(!s.ignoreRetriever)try{await s.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(n){console.error(`Error in handler ${s.constructor.name}, handleRetrieverError: ${n}`)}},s.awaitHandlers)))}}class CallbackManagerForLLMRun extends BaseRunManager{async handleLLMNewToken(e,s,n,r,a,i){await Promise.all(this.handlers.map(u=>consumeCallback(async()=>{if(!u.ignoreLLM)try{await u.handleLLMNewToken?.(e,s??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i)}catch(f){console.error(`Error in handler ${u.constructor.name}, handleLLMNewToken: ${f}`)}},u.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(s=>consumeCallback(async()=>{if(!s.ignoreLLM)try{await s.handleLLMError?.(e,this.runId,this._parentRunId,this.tags)}catch(n){console.error(`Error in handler ${s.constructor.name}, handleLLMError: ${n}`)}},s.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(s=>consumeCallback(async()=>{if(!s.ignoreLLM)try{await s.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){console.error(`Error in handler ${s.constructor.name}, handleLLMEnd: ${n}`)}},s.awaitHandlers)))}}class CallbackManagerForChainRun extends BaseRunManager{getChild(e){const s=new CallbackManager(this.runId);return s.setHandlers(this.inheritableHandlers),s.addTags(this.inheritableTags),s.addMetadata(this.inheritableMetadata),e&&s.addTags([e],!1),s}async handleChainError(e,s,n,r,a){await Promise.all(this.handlers.map(i=>consumeCallback(async()=>{if(!i.ignoreChain)try{await i.handleChainError?.(e,this.runId,this._parentRunId,this.tags,a)}catch(u){console.error(`Error in handler ${i.constructor.name}, handleChainError: ${u}`)}},i.awaitHandlers)))}async handleChainEnd(e,s,n,r,a){await Promise.all(this.handlers.map(i=>consumeCallback(async()=>{if(!i.ignoreChain)try{await i.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,a)}catch(u){console.error(`Error in handler ${i.constructor.name}, handleChainEnd: ${u}`)}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(s=>consumeCallback(async()=>{if(!s.ignoreAgent)try{await s.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(n){console.error(`Error in handler ${s.constructor.name}, handleAgentAction: ${n}`)}},s.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(s=>consumeCallback(async()=>{if(!s.ignoreAgent)try{await s.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){console.error(`Error in handler ${s.constructor.name}, handleAgentEnd: ${n}`)}},s.awaitHandlers)))}}class CallbackManagerForToolRun extends BaseRunManager{getChild(e){const s=new CallbackManager(this.runId);return s.setHandlers(this.inheritableHandlers),s.addTags(this.inheritableTags),s.addMetadata(this.inheritableMetadata),e&&s.addTags([e],!1),s}async handleToolError(e){await Promise.all(this.handlers.map(s=>consumeCallback(async()=>{if(!s.ignoreAgent)try{await s.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(n){console.error(`Error in handler ${s.constructor.name}, handleToolError: ${n}`)}},s.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(s=>consumeCallback(async()=>{if(!s.ignoreAgent)try{await s.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){console.error(`Error in handler ${s.constructor.name}, handleToolEnd: ${n}`)}},s.awaitHandlers)))}}class CallbackManager extends BaseCallbackManager{constructor(e,s){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=s?.handlers??this.handlers,this.inheritableHandlers=s?.inheritableHandlers??this.inheritableHandlers,this.tags=s?.tags??this.tags,this.inheritableTags=s?.inheritableTags??this.inheritableTags,this.metadata=s?.metadata??this.metadata,this.inheritableMetadata=s?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,s,n=void 0,r=void 0,a=void 0,i=void 0,u=void 0,f=void 0){return Promise.all(s.map(async c=>{const d=v4();return await Promise.all(this.handlers.map(h=>consumeCallback(async()=>{if(!h.ignoreLLM)try{await h.handleLLMStart?.(e,[c],d,this._parentRunId,a,this.tags,this.metadata,f)}catch(m){console.error(`Error in handler ${h.constructor.name}, handleLLMStart: ${m}`)}},h.awaitHandlers))),new CallbackManagerForLLMRun(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,s,n=void 0,r=void 0,a=void 0,i=void 0,u=void 0,f=void 0){return Promise.all(s.map(async c=>{const d=v4();return await Promise.all(this.handlers.map(h=>consumeCallback(async()=>{if(!h.ignoreLLM)try{if(h.handleChatModelStart)await h.handleChatModelStart?.(e,[c],d,this._parentRunId,a,this.tags,this.metadata,f);else if(h.handleLLMStart){const m=getBufferString(c);await h.handleLLMStart?.(e,[m],d,this._parentRunId,a,this.tags,this.metadata,f)}}catch(m){console.error(`Error in handler ${h.constructor.name}, handleLLMStart: ${m}`)}},h.awaitHandlers))),new CallbackManagerForLLMRun(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,s,n=v4(),r=void 0,a=void 0,i=void 0,u=void 0){return await Promise.all(this.handlers.map(f=>consumeCallback(async()=>{if(!f.ignoreChain)try{await f.handleChainStart?.(e,s,n,this._parentRunId,this.tags,this.metadata,r,u)}catch(c){console.error(`Error in handler ${f.constructor.name}, handleChainStart: ${c}`)}},f.awaitHandlers))),new CallbackManagerForChainRun(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,s,n=v4(),r=void 0,a=void 0,i=void 0,u=void 0){return await Promise.all(this.handlers.map(f=>consumeCallback(async()=>{if(!f.ignoreAgent)try{await f.handleToolStart?.(e,s,n,this._parentRunId,this.tags,this.metadata,u)}catch(c){console.error(`Error in handler ${f.constructor.name}, handleToolStart: ${c}`)}},f.awaitHandlers))),new CallbackManagerForToolRun(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,s,n=v4(),r=void 0,a=void 0,i=void 0,u=void 0){return await Promise.all(this.handlers.map(f=>consumeCallback(async()=>{if(!f.ignoreRetriever)try{await f.handleRetrieverStart?.(e,s,n,this._parentRunId,this.tags,this.metadata,u)}catch(c){console.error(`Error in handler ${f.constructor.name}, handleRetrieverStart: ${c}`)}},f.awaitHandlers))),new CallbackManagerForRetrieverRun(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,s=!0){this.handlers.push(e),s&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(s=>s!==e),this.inheritableHandlers=this.inheritableHandlers.filter(s=>s!==e)}setHandlers(e,s=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,s)}addTags(e,s=!0){this.removeTags(e),this.tags.push(...e),s&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(s=>!e.includes(s)),this.inheritableTags=this.inheritableTags.filter(s=>!e.includes(s))}addMetadata(e,s=!0){this.metadata={...this.metadata,...e},s&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const s of Object.keys(e))delete this.metadata[s],delete this.inheritableMetadata[s]}copy(e=[],s=!0){const n=new CallbackManager(this._parentRunId);for(const r of this.handlers){const a=this.inheritableHandlers.includes(r);n.addHandler(r,a)}for(const r of this.tags){const a=this.inheritableTags.includes(r);n.addTags([r],a)}for(const r of Object.keys(this.metadata)){const a=Object.keys(this.inheritableMetadata).includes(r);n.addMetadata({[r]:this.metadata[r]},a)}for(const r of e)n.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===r.name)||n.addHandler(r,s);return n}static fromHandlers(e){class s extends BaseCallbackHandler{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:v4()}),Object.assign(this,e)}}const n=new this;return n.addHandler(new s),n}static async configure(e,s,n,r,a,i,u){let f;(e||s)&&(Array.isArray(e)||!e?(f=new CallbackManager,f.setHandlers(e?.map(ensureHandler)??[],!0)):f=e,f=f.copy(Array.isArray(s)?s.map(ensureHandler):s?.handlers,!1));const c=getEnvironmentVariable$1("LANGCHAIN_VERBOSE")==="true"||u?.verbose,d=getEnvironmentVariable$1("LANGCHAIN_TRACING_V2")==="true",h=d||(getEnvironmentVariable$1("LANGCHAIN_TRACING")??!1);if(c||h){if(f||(f=new CallbackManager),c&&!f.handlers.some(m=>m.name===ConsoleCallbackHandler.prototype.name)){const m=new ConsoleCallbackHandler;f.addHandler(m,!0)}h&&!f.handlers.some(m=>m.name==="langchain_tracer")&&d&&f.addHandler(await getTracingV2CallbackHandler(),!0)}return(n||r)&&f&&(f.addTags(n??[]),f.addTags(r??[],!1)),(a||i)&&f&&(f.addMetadata(a??{}),f.addMetadata(i??{},!1)),f}}function ensureHandler(t){return"name"in t?t:BaseCallbackHandler.fromMethods(t)}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const _hasOwnProperty=Object.prototype.hasOwnProperty;function hasOwnProperty(t,e){return _hasOwnProperty.call(t,e)}function _objectKeys(t){if(Array.isArray(t)){const s=new Array(t.length);for(let n=0;n<s.length;n++)s[n]=""+n;return s}if(Object.keys)return Object.keys(t);let e=[];for(let s in t)hasOwnProperty(t,s)&&e.push(s);return e}function _deepClone(t){switch(typeof t){case"object":return JSON.parse(JSON.stringify(t));case"undefined":return null;default:return t}}function isInteger(t){let e=0;const s=t.length;let n;for(;e<s;){if(n=t.charCodeAt(e),n>=48&&n<=57){e++;continue}return!1}return!0}function escapePathComponent(t){return t.indexOf("/")===-1&&t.indexOf("~")===-1?t:t.replace(/~/g,"~0").replace(/\//g,"~1")}function unescapePathComponent(t){return t.replace(/~1/g,"/").replace(/~0/g,"~")}function hasUndefined(t){if(t===void 0)return!0;if(t){if(Array.isArray(t)){for(let s=0,n=t.length;s<n;s++)if(hasUndefined(t[s]))return!0}else if(typeof t=="object"){const s=_objectKeys(t),n=s.length;for(var e=0;e<n;e++)if(hasUndefined(t[s[e]]))return!0}}return!1}function patchErrorMessageFormatter(t,e){const s=[t];for(const n in e){const r=typeof e[n]=="object"?JSON.stringify(e[n],null,2):e[n];typeof r<"u"&&s.push(`${n}: ${r}`)}return s.join(`
`)}class PatchError extends Error{constructor(e,s,n,r,a){super(patchErrorMessageFormatter(e,{name:s,index:n,operation:r,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=patchErrorMessageFormatter(e,{name:s,index:n,operation:r,tree:a})}}const JsonPatchError=PatchError,objOps={add:function(t,e,s){return t[e]=this.value,{newDocument:s}},remove:function(t,e,s){var n=t[e];return delete t[e],{newDocument:s,removed:n}},replace:function(t,e,s){var n=t[e];return t[e]=this.value,{newDocument:s,removed:n}},move:function(t,e,s){let n=getValueByPointer(s,this.path);n&&(n=_deepClone(n));const r=applyOperation(s,{op:"remove",path:this.from}).removed;return applyOperation(s,{op:"add",path:this.path,value:r}),{newDocument:s,removed:n}},copy:function(t,e,s){const n=getValueByPointer(s,this.from);return applyOperation(s,{op:"add",path:this.path,value:_deepClone(n)}),{newDocument:s}},test:function(t,e,s){return{newDocument:s,test:_areEquals(t[e],this.value)}},_get:function(t,e,s){return this.value=t[e],{newDocument:s}}};var arrOps={add:function(t,e,s){return isInteger(e)?t.splice(e,0,this.value):t[e]=this.value,{newDocument:s,index:e}},remove:function(t,e,s){var n=t.splice(e,1);return{newDocument:s,removed:n[0]}},replace:function(t,e,s){var n=t[e];return t[e]=this.value,{newDocument:s,removed:n}},move:objOps.move,copy:objOps.copy,test:objOps.test,_get:objOps._get};function getValueByPointer(t,e){if(e=="")return t;var s={op:"_get",path:e};return applyOperation(t,s),s.value}function applyOperation(t,e,s=!1,n=!0,r=!0,a=0){if(s&&(typeof s=="function"?s(e,0,t,e.path):validator(e,0)),e.path===""){let i={newDocument:t};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=t,i;if(e.op==="move"||e.op==="copy")return i.newDocument=getValueByPointer(t,e.from),e.op==="move"&&(i.removed=t),i;if(e.op==="test"){if(i.test=_areEquals(t,e.value),i.test===!1)throw new JsonPatchError("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return i.newDocument=t,i}else{if(e.op==="remove")return i.removed=t,i.newDocument=null,i;if(e.op==="_get")return e.value=t,i;if(s)throw new JsonPatchError("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,e,t);return i}}else{n||(t=_deepClone(t));const u=(e.path||"").split("/");let f=t,c=1,d=u.length,h,m,_;for(typeof s=="function"?_=s:_=validator;;){if(m=u[c],m&&m.indexOf("~")!=-1&&(m=unescapePathComponent(m)),r&&(m=="__proto__"||m=="prototype"&&c>0&&u[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(s&&h===void 0&&(f[m]===void 0?h=u.slice(0,c).join("/"):c==d-1&&(h=e.path),h!==void 0&&_(e,0,t,h)),c++,Array.isArray(f)){if(m==="-")m=f.length;else{if(s&&!isInteger(m))throw new JsonPatchError("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,e,t);isInteger(m)&&(m=~~m)}if(c>=d){if(s&&e.op==="add"&&m>f.length)throw new JsonPatchError("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,e,t);const p=arrOps[e.op].call(e,f,m,t);if(p.test===!1)throw new JsonPatchError("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return p}}else if(c>=d){const p=objOps[e.op].call(e,f,m,t);if(p.test===!1)throw new JsonPatchError("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return p}if(f=f[m],s&&c<d&&(!f||typeof f!="object"))throw new JsonPatchError("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,e,t)}}}function applyPatch(t,e,s,n=!0,r=!0){if(s&&!Array.isArray(e))throw new JsonPatchError("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(t=_deepClone(t));const a=new Array(e.length);for(let i=0,u=e.length;i<u;i++)a[i]=applyOperation(t,e[i],s,!0,r,i),t=a[i].newDocument;return a.newDocument=t,a}function validator(t,e,s,n){if(typeof t!="object"||t===null||Array.isArray(t))throw new JsonPatchError("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,t,s);if(objOps[t.op]){if(typeof t.path!="string")throw new JsonPatchError("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,t,s);if(t.path.indexOf("/")!==0&&t.path.length>0)throw new JsonPatchError('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,t,s);if((t.op==="move"||t.op==="copy")&&typeof t.from!="string")throw new JsonPatchError("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,t,s);if((t.op==="add"||t.op==="replace"||t.op==="test")&&t.value===void 0)throw new JsonPatchError("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,t,s);if((t.op==="add"||t.op==="replace"||t.op==="test")&&hasUndefined(t.value))throw new JsonPatchError("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,t,s);if(s){if(t.op=="add"){var r=t.path.split("/").length,a=n.split("/").length;if(r!==a+1&&r!==a)throw new JsonPatchError("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,t,s)}else if(t.op==="replace"||t.op==="remove"||t.op==="_get"){if(t.path!==n)throw new JsonPatchError("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,t,s)}else if(t.op==="move"||t.op==="copy"){var i={op:"_get",path:t.from,value:void 0},u=validate([i],s);if(u&&u.name==="OPERATION_PATH_UNRESOLVABLE")throw new JsonPatchError("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,t,s)}}}else throw new JsonPatchError("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,t,s)}function validate(t,e,s){try{if(!Array.isArray(t))throw new JsonPatchError("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)applyPatch(_deepClone(e),_deepClone(t),s||!0);else{s=s||validator;for(var n=0;n<t.length;n++)s(t[n],n,e,void 0)}}catch(r){if(r instanceof JsonPatchError)return r;throw r}}function _areEquals(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){var s=Array.isArray(t),n=Array.isArray(e),r,a,i;if(s&&n){if(a=t.length,a!=e.length)return!1;for(r=a;r--!==0;)if(!_areEquals(t[r],e[r]))return!1;return!0}if(s!=n)return!1;var u=Object.keys(t);if(a=u.length,a!==Object.keys(e).length)return!1;for(r=a;r--!==0;)if(!e.hasOwnProperty(u[r]))return!1;for(r=a;r--!==0;)if(i=u[r],!_areEquals(t[i],e[i]))return!1;return!0}return t!==t&&e!==e}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2013-2021 Joachim Wester
 * MIT license
 */function _generate(t,e,s,n,r){if(e!==t){typeof e.toJSON=="function"&&(e=e.toJSON());for(var a=_objectKeys(e),i=_objectKeys(t),u=!1,f=i.length-1;f>=0;f--){var c=i[f],d=t[c];if(hasOwnProperty(e,c)&&!(e[c]===void 0&&d!==void 0&&Array.isArray(e)===!1)){var h=e[c];typeof d=="object"&&d!=null&&typeof h=="object"&&h!=null&&Array.isArray(d)===Array.isArray(h)?_generate(d,h,s,n+"/"+escapePathComponent(c),r):d!==h&&(r&&s.push({op:"test",path:n+"/"+escapePathComponent(c),value:_deepClone(d)}),s.push({op:"replace",path:n+"/"+escapePathComponent(c),value:_deepClone(h)}))}else Array.isArray(t)===Array.isArray(e)?(r&&s.push({op:"test",path:n+"/"+escapePathComponent(c),value:_deepClone(d)}),s.push({op:"remove",path:n+"/"+escapePathComponent(c)}),u=!0):(r&&s.push({op:"test",path:n,value:t}),s.push({op:"replace",path:n,value:e}))}if(!(!u&&a.length==i.length))for(var f=0;f<a.length;f++){var c=a[f];!hasOwnProperty(t,c)&&e[c]!==void 0&&s.push({op:"add",path:n+"/"+escapePathComponent(c),value:_deepClone(e[c])})}}}function compare(t,e,s=!1){var n=[];return _generate(t,e,n,"",s),n}class IterableReadableStream extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const s=this.reader.cancel();this.reader.releaseLock(),await s}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const s=e.getReader();return new IterableReadableStream({start(n){return r();function r(){return s.read().then(({done:a,value:i})=>{if(a){n.close();return}return n.enqueue(i),r()})}},cancel(){s.releaseLock()}})}static fromAsyncGenerator(e){return new IterableReadableStream({async pull(s){const{value:n,done:r}=await e.next();r&&s.close(),s.enqueue(n)},async cancel(s){await e.return(s)}})}}function atee(t,e=2){const s=Array.from({length:e},()=>[]);return s.map(async function*(r){for(;;)if(r.length===0){const a=await t.next();for(const i of s)i.push(a)}else{if(r[0].done)return;yield r.shift().value}})}function concat(t,e){if(Array.isArray(t)&&Array.isArray(e))return t.concat(e);if(typeof t=="string"&&typeof e=="string")return t+e;if(typeof t=="number"&&typeof e=="number")return t+e;if("concat"in t&&typeof t.concat=="function")return t.concat(e);if(typeof t=="object"&&typeof e=="object"){const s={...t};for(const[n,r]of Object.entries(e))n in s&&!Array.isArray(s[n])?s[n]=concat(s[n],r):s[n]=r;return s}else throw new Error(`Cannot concat ${typeof t} and ${typeof e}`)}class AsyncGeneratorWithSetup{constructor(e,s){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise((n,r)=>{this.firstResult=e.next(),s?this.firstResult.then(s).then(n,r):this.firstResult.then(a=>n(void 0),r)})}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}async function pipeGeneratorWithSetup(t,e,s,...n){const r=new AsyncGeneratorWithSetup(e,s),a=await r.setup;return{output:t(r,a,...n),setup:a}}class RunLogPatch{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const s=this.ops.concat(e.ops),n=applyPatch({},s);return new RunLog({ops:s,state:n[n.length-1].newDocument})}}class RunLog extends RunLogPatch{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const s=this.ops.concat(e.ops),n=applyPatch(this.state,e.ops);return new RunLog({ops:s,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){const s=applyPatch({},e.ops);return new RunLog({ops:e.ops,state:s[s.length-1].newDocument})}}async function _getStandardizedInputs(t,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:s}=t;if(["retriever","llm","prompt"].includes(t.run_type))return s;if(!(Object.keys(s).length===1&&s?.input===""))return s.input}async function _getStandardizedOutputs(t,e){const{outputs:s}=t;return e==="original"||["retriever","llm","prompt"].includes(t.run_type)?s:s!==void 0&&Object.keys(s).length===1&&s?.output!==void 0?s.output:s}function isChatGenerationChunk(t){return t!==void 0&&t.message!==void 0}class LogStreamCallbackHandler extends BaseTracer{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=IterableReadableStream.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const s=e.tags??[];let n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(n=n||s.find(r=>this.includeTags?.includes(r))!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(n=n&&s.every(r=>!this.excludeTags?.includes(r))),n}async*tapOutputIterable(e,s){for await(const n of s){if(e!==this.rootId){const r=this.keyMapByRunId[e];r&&await this.writer.write(new RunLogPatch({ops:[{op:"add",path:`/logs/${r}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new RunLogPatch({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const s=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=s===1?e.name:`${e.name}:${s}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(n.inputs=await _getStandardizedInputs(e,this._schemaFormat)),await this.writer.write(new RunLogPatch({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const s=this.keyMapByRunId[e.id];if(s===void 0)return;const n=[];this._schemaFormat==="streaming_events"&&n.push({op:"replace",path:`/logs/${s}/inputs`,value:await _getStandardizedInputs(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${s}/final_output`,value:await _getStandardizedOutputs(e,this._schemaFormat)}),e.end_time!==void 0&&n.push({op:"add",path:`/logs/${s}/end_time`,value:new Date(e.end_time).toISOString()});const r=new RunLogPatch({ops:n});await this.writer.write(r)}finally{if(e.id===this.rootId){const s=new RunLogPatch({ops:[{op:"replace",path:"/final_output",value:await _getStandardizedOutputs(e,this._schemaFormat)}]});await this.writer.write(s),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,s,n){const r=this.keyMapByRunId[e.id];if(r===void 0)return;const a=e.inputs.messages!==void 0;let i;a?isChatGenerationChunk(n?.chunk)?i=n?.chunk:i=new AIMessageChunk(s):i=s;const u=new RunLogPatch({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:s},{op:"add",path:`/logs/${r}/streamed_output/-`,value:i}]});await this.writer.write(u)}}class MockAsyncLocalStorage{getStore(){}run(e,s){s()}}class AsyncLocalStorageProvider{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new MockAsyncLocalStorage}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}}const AsyncLocalStorageProviderSingleton=new AsyncLocalStorageProvider,DEFAULT_RECURSION_LIMIT=25;async function getCallbackManagerForConfig(t){return CallbackManager.configure(t?.callbacks,void 0,t?.tags,void 0,t?.metadata)}function mergeConfigs(...t){const e=ensureConfig();for(const s of t.filter(n=>!!n))for(const n of Object.keys(s))if(n==="metadata")e[n]={...e[n],...s[n]};else if(n==="tags")e[n]=[...new Set(e[n].concat(s[n]??[]))];else if(n==="configurable")e[n]={...e[n],...s[n]};else if(n==="callbacks"){const r=e.callbacks,a=s.callbacks;if(Array.isArray(a))if(!r)e.callbacks=a;else if(Array.isArray(r))e.callbacks=r.concat(a);else{const i=r.copy();for(const u of a)i.addHandler(ensureHandler(u),!0);e.callbacks=i}else if(a)if(!r)e.callbacks=a;else if(Array.isArray(r)){const i=a.copy();for(const u of r)i.addHandler(ensureHandler(u),!0);e.callbacks=i}else e.callbacks=new CallbackManager(a._parentRunId,{handlers:r.handlers.concat(a.handlers),inheritableHandlers:r.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(r.tags.concat(a.tags))),inheritableTags:Array.from(new Set(r.inheritableTags.concat(a.inheritableTags))),metadata:{...r.metadata,...a.metadata}})}else{const r=n;e[r]=s[r]??e[r]}return e}const PRIMITIVES=new Set(["string","number","boolean"]);function ensureConfig(t){const e=t??AsyncLocalStorageProviderSingleton.getInstance().getStore();let s={tags:[],metadata:{},callbacks:void 0,recursionLimit:25};if(e&&(s={...s,...e}),e?.configurable)for(const n of Object.keys(e.configurable))PRIMITIVES.has(typeof e.configurable[n])&&!s.metadata?.[n]&&(s.metadata||(s.metadata={}),s.metadata[n]=e.configurable[n]);return s}function patchConfig(t={},{callbacks:e,maxConcurrency:s,recursionLimit:n,runName:r,configurable:a}={}){const i=ensureConfig(t);return e!==void 0&&(delete i.runName,i.callbacks=e),n!==void 0&&(i.recursionLimit=n),s!==void 0&&(i.maxConcurrency=s),r!==void 0&&(i.runName=r),a!==void 0&&(i.configurable={...i.configurable,...a}),i}class RootListenersTracer extends BaseTracer{constructor({config:e,onStart:s,onEnd:n,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=s,this.argOnEnd=n,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}}function isRunnableInterface(t){return t?t.lc_runnable:!1}class _RootEventFilter{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,s){let n=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const r=e.tags??[];return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(s)),this.includeTags!==void 0&&(n=n||r.some(a=>this.includeTags?.includes(a))),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(s)),this.excludeTags!==void 0&&(n=n&&r.every(a=>!this.excludeTags?.includes(a))),n}}function addErrorMessage(t,e,s,n){n?.errorMessages&&s&&(t.errorMessage={...t.errorMessage,[e]:s})}function setResponseValueAndErrors(t,e,s,n,r){t[e]=s,addErrorMessage(t,e,n,r)}const ignoreOverride=Symbol("Let zodToJsonSchema decide on which parser to use"),defaultOptions={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",emailStrategy:"format:email"},getDefaultOptions=t=>typeof t=="string"?{...defaultOptions,name:t}:{...defaultOptions,...t};function parseAnyDef(){return{}}function parseArrayDef(t,e){const s={type:"array"};return t.type?._def?.typeName!==ZodFirstPartyTypeKind.ZodAny&&(s.items=parseDef(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&setResponseValueAndErrors(s,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&setResponseValueAndErrors(s,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(setResponseValueAndErrors(s,"minItems",t.exactLength.value,t.exactLength.message,e),setResponseValueAndErrors(s,"maxItems",t.exactLength.value,t.exactLength.message,e)),s}function parseBigintDef(t,e){const s={type:"integer",format:"int64"};if(!t.checks)return s;for(const n of t.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?setResponseValueAndErrors(s,"minimum",n.value,n.message,e):setResponseValueAndErrors(s,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(s.exclusiveMinimum=!0),setResponseValueAndErrors(s,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?setResponseValueAndErrors(s,"maximum",n.value,n.message,e):setResponseValueAndErrors(s,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(s.exclusiveMaximum=!0),setResponseValueAndErrors(s,"maximum",n.value,n.message,e));break;case"multipleOf":setResponseValueAndErrors(s,"multipleOf",n.value,n.message,e);break}return s}function parseBooleanDef(){return{type:"boolean"}}function parseBrandedDef(t,e){return parseDef(t.type._def,e)}const parseCatchDef=(t,e)=>parseDef(t.innerType._def,e);function parseDateDef(t,e,s){const n=s??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((r,a)=>parseDateDef(t,e,r))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return integerDateParser(t,e)}}const integerDateParser=(t,e)=>{const s={type:"integer",format:"unix-time"};if(e.target==="openApi3")return s;for(const n of t.checks)switch(n.kind){case"min":setResponseValueAndErrors(s,"minimum",n.value,n.message,e);break;case"max":setResponseValueAndErrors(s,"maximum",n.value,n.message,e);break}return s};function parseDefaultDef(t,e){return{...parseDef(t.innerType._def,e),default:t.defaultValue()}}function parseEffectsDef(t,e){return e.effectStrategy==="input"?parseDef(t.schema._def,e):{}}function parseEnumDef(t){return{type:"string",enum:t.values}}const isJsonSchema7AllOfType=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function parseIntersectionDef(t,e){const s=[parseDef(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),parseDef(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const r=[];return s.forEach(a=>{if(isJsonSchema7AllOfType(a))r.push(...a.allOf),a.unevaluatedProperties===void 0&&(n=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:u,...f}=a;i=f}else n=void 0;r.push(i)}}),r.length?{allOf:r,...n}:void 0}function parseLiteralDef(t,e){const s=typeof t.value;return s!=="bigint"&&s!=="number"&&s!=="boolean"&&s!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:s==="bigint"?"integer":s,enum:[t.value]}:{type:s==="bigint"?"integer":s,const:t.value}}const zodPatterns={cuid:"^[cC][^\\s-]{8,}$",cuid2:"^[a-z][a-z0-9]*$",ulid:"^[0-9A-HJKMNP-TV-Z]{26}$",email:"^(?!\\.)(?!.*\\.\\.)([a-zA-Z0-9_+-\\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\\-]*\\.)+[a-zA-Z]{2,}$",emoji:"^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",uuid:"^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$",ipv4:"^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$",ipv6:"^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$"};function parseStringDef(t,e){const s={type:"string"};function n(r){return e.patternStrategy==="escape"?escapeNonAlphaNumeric(r):r}if(t.checks)for(const r of t.checks)switch(r.kind){case"min":setResponseValueAndErrors(s,"minLength",typeof s.minLength=="number"?Math.max(s.minLength,r.value):r.value,r.message,e);break;case"max":setResponseValueAndErrors(s,"maxLength",typeof s.maxLength=="number"?Math.min(s.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":addFormat(s,"email",r.message,e);break;case"format:idn-email":addFormat(s,"idn-email",r.message,e);break;case"pattern:zod":addPattern(s,zodPatterns.email,r.message,e);break}break;case"url":addFormat(s,"uri",r.message,e);break;case"uuid":addFormat(s,"uuid",r.message,e);break;case"regex":addPattern(s,r.regex.source,r.message,e);break;case"cuid":addPattern(s,zodPatterns.cuid,r.message,e);break;case"cuid2":addPattern(s,zodPatterns.cuid2,r.message,e);break;case"startsWith":addPattern(s,"^"+n(r.value),r.message,e);break;case"endsWith":addPattern(s,n(r.value)+"$",r.message,e);break;case"datetime":addFormat(s,"date-time",r.message,e);break;case"length":setResponseValueAndErrors(s,"minLength",typeof s.minLength=="number"?Math.max(s.minLength,r.value):r.value,r.message,e),setResponseValueAndErrors(s,"maxLength",typeof s.maxLength=="number"?Math.min(s.maxLength,r.value):r.value,r.message,e);break;case"includes":{addPattern(s,n(r.value),r.message,e);break}case"ip":{r.version!=="v6"&&addFormat(s,"ipv4",r.message,e),r.version!=="v4"&&addFormat(s,"ipv6",r.message,e);break}case"emoji":addPattern(s,zodPatterns.emoji,r.message,e);break;case"ulid":{addPattern(s,zodPatterns.ulid,r.message,e);break}}return s}const escapeNonAlphaNumeric=t=>Array.from(t).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),addFormat=(t,e,s,n)=>{t.format||t.anyOf?.some(r=>r.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&n.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...s&&n.errorMessages&&{errorMessage:{format:s}}})):setResponseValueAndErrors(t,"format",e,s,n)},addPattern=(t,e,s,n)=>{t.pattern||t.allOf?.some(r=>r.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&n.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:e,...s&&n.errorMessages&&{errorMessage:{pattern:s}}})):setResponseValueAndErrors(t,"pattern",e,s,n)};function parseRecordDef(t,e){if(e.target==="openApi3"&&t.keyType?._def.typeName===ZodFirstPartyTypeKind.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((n,r)=>({...n,[r]:parseDef(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",r]})??{}}),{}),additionalProperties:!1};const s={type:"object",additionalProperties:parseDef(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return s;if(t.keyType?._def.typeName===ZodFirstPartyTypeKind.ZodString&&t.keyType._def.checks?.length){const n=Object.entries(parseStringDef(t.keyType._def,e)).reduce((r,[a,i])=>a==="type"?r:{...r,[a]:i},{});return{...s,propertyNames:n}}else if(t.keyType?._def.typeName===ZodFirstPartyTypeKind.ZodEnum)return{...s,propertyNames:{enum:t.keyType._def.values}};return s}function parseMapDef(t,e){if(e.mapStrategy==="record")return parseRecordDef(t,e);const s=parseDef(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},n=parseDef(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[s,n],minItems:2,maxItems:2}}}function parseNativeEnumDef(t){const e=t.values,n=Object.keys(t.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),r=Array.from(new Set(n.map(a=>typeof a)));return{type:r.length===1?r[0]==="string"?"string":"number":["string","number"],enum:n}}function parseNeverDef(){return{not:{}}}function parseNullDef(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const primitiveMappings={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function parseUnionDef(t,e){if(e.target==="openApi3")return asAnyOf(t,e);const s=t.options instanceof Map?Array.from(t.options.values()):t.options;if(s.every(n=>n._def.typeName in primitiveMappings&&(!n._def.checks||!n._def.checks.length))){const n=s.reduce((r,a)=>{const i=primitiveMappings[a._def.typeName];return i&&!r.includes(i)?[...r,i]:r},[]);return{type:n.length>1?n:n[0]}}else if(s.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=s.reduce((r,a)=>{const i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...r,i];case"bigint":return[...r,"integer"];case"object":if(a._def.value===null)return[...r,"null"];case"symbol":case"undefined":case"function":default:return r}},[]);if(n.length===s.length){const r=n.filter((a,i,u)=>u.indexOf(a)===i);return{type:r.length>1?r:r[0],enum:s.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(s.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:s.reduce((n,r)=>[...n,...r._def.values.filter(a=>!n.includes(a))],[])};return asAnyOf(t,e)}const asAnyOf=(t,e)=>{const s=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((n,r)=>parseDef(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${r}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return s.length?{anyOf:s}:void 0};function parseNullableDef(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"?{type:primitiveMappings[t.innerType._def.typeName],nullable:!0}:{type:[primitiveMappings[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=parseDef(t.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const s=parseDef(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return s&&{anyOf:[s,{type:"null"}]}}function parseNumberDef(t,e){const s={type:"number"};if(!t.checks)return s;for(const n of t.checks)switch(n.kind){case"int":s.type="integer",addErrorMessage(s,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?setResponseValueAndErrors(s,"minimum",n.value,n.message,e):setResponseValueAndErrors(s,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(s.exclusiveMinimum=!0),setResponseValueAndErrors(s,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?setResponseValueAndErrors(s,"maximum",n.value,n.message,e):setResponseValueAndErrors(s,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(s.exclusiveMaximum=!0),setResponseValueAndErrors(s,"maximum",n.value,n.message,e));break;case"multipleOf":setResponseValueAndErrors(s,"multipleOf",n.value,n.message,e);break}return s}function decideAdditionalProperties(t,e){return e.removeAdditionalStrategy==="strict"?t.catchall._def.typeName==="ZodNever"?t.unknownKeys!=="strict":parseDef(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:t.catchall._def.typeName==="ZodNever"?t.unknownKeys==="passthrough":parseDef(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function parseObjectDef(t,e){const s={type:"object",...Object.entries(t.shape()).reduce((n,[r,a])=>{if(a===void 0||a._def===void 0)return n;const i=parseDef(a._def,{...e,currentPath:[...e.currentPath,"properties",r],propertyPath:[...e.currentPath,"properties",r]});return i===void 0?n:{properties:{...n.properties,[r]:i},required:a.isOptional()?n.required:[...n.required,r]}},{properties:{},required:[]}),additionalProperties:decideAdditionalProperties(t,e)};return s.required.length||delete s.required,s}const parseOptionalDef=(t,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return parseDef(t.innerType._def,e);const s=parseDef(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return s?{anyOf:[{not:{}},s]}:{}},parsePipelineDef=(t,e)=>{if(e.pipeStrategy==="input")return parseDef(t.in._def,e);if(e.pipeStrategy==="output")return parseDef(t.out._def,e);const s=parseDef(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=parseDef(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",s?"1":"0"]});return{allOf:[s,n].filter(r=>r!==void 0)}};function parsePromiseDef(t,e){return parseDef(t.type._def,e)}function parseSetDef(t,e){const n={type:"array",uniqueItems:!0,items:parseDef(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&setResponseValueAndErrors(n,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&setResponseValueAndErrors(n,"maxItems",t.maxSize.value,t.maxSize.message,e),n}function parseTupleDef(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((s,n)=>parseDef(s._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((s,n)=>n===void 0?s:[...s,n],[]),additionalItems:parseDef(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((s,n)=>parseDef(s._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((s,n)=>n===void 0?s:[...s,n],[])}}function parseUndefinedDef(){return{not:{}}}function parseUnknownDef(){return{}}const parseReadonlyDef=(t,e)=>parseDef(t.innerType._def,e);function parseDef(t,e,s=!1){const n=e.seen.get(t);if(e.override){const i=e.override?.(t,e,n,s);if(i!==ignoreOverride)return i}if(n&&!s){const i=get$ref(n,e);if(i!==void 0)return i}const r={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,r);const a=selectParser(t,t.typeName,e);return a&&addMeta(t,e,a),r.jsonSchema=a,a}const get$ref=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"relative":return{$ref:getRelativePath(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((s,n)=>e.currentPath[n]===s)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},getRelativePath=(t,e)=>{let s=0;for(;s<t.length&&s<e.length&&t[s]===e[s];s++);return[(t.length-s).toString(),...e.slice(s)].join("/")},selectParser=(t,e,s)=>{switch(e){case ZodFirstPartyTypeKind.ZodString:return parseStringDef(t,s);case ZodFirstPartyTypeKind.ZodNumber:return parseNumberDef(t,s);case ZodFirstPartyTypeKind.ZodObject:return parseObjectDef(t,s);case ZodFirstPartyTypeKind.ZodBigInt:return parseBigintDef(t,s);case ZodFirstPartyTypeKind.ZodBoolean:return parseBooleanDef();case ZodFirstPartyTypeKind.ZodDate:return parseDateDef(t,s);case ZodFirstPartyTypeKind.ZodUndefined:return parseUndefinedDef();case ZodFirstPartyTypeKind.ZodNull:return parseNullDef(s);case ZodFirstPartyTypeKind.ZodArray:return parseArrayDef(t,s);case ZodFirstPartyTypeKind.ZodUnion:case ZodFirstPartyTypeKind.ZodDiscriminatedUnion:return parseUnionDef(t,s);case ZodFirstPartyTypeKind.ZodIntersection:return parseIntersectionDef(t,s);case ZodFirstPartyTypeKind.ZodTuple:return parseTupleDef(t,s);case ZodFirstPartyTypeKind.ZodRecord:return parseRecordDef(t,s);case ZodFirstPartyTypeKind.ZodLiteral:return parseLiteralDef(t,s);case ZodFirstPartyTypeKind.ZodEnum:return parseEnumDef(t);case ZodFirstPartyTypeKind.ZodNativeEnum:return parseNativeEnumDef(t);case ZodFirstPartyTypeKind.ZodNullable:return parseNullableDef(t,s);case ZodFirstPartyTypeKind.ZodOptional:return parseOptionalDef(t,s);case ZodFirstPartyTypeKind.ZodMap:return parseMapDef(t,s);case ZodFirstPartyTypeKind.ZodSet:return parseSetDef(t,s);case ZodFirstPartyTypeKind.ZodLazy:return parseDef(t.getter()._def,s);case ZodFirstPartyTypeKind.ZodPromise:return parsePromiseDef(t,s);case ZodFirstPartyTypeKind.ZodNaN:case ZodFirstPartyTypeKind.ZodNever:return parseNeverDef();case ZodFirstPartyTypeKind.ZodEffects:return parseEffectsDef(t,s);case ZodFirstPartyTypeKind.ZodAny:return parseAnyDef();case ZodFirstPartyTypeKind.ZodUnknown:return parseUnknownDef();case ZodFirstPartyTypeKind.ZodDefault:return parseDefaultDef(t,s);case ZodFirstPartyTypeKind.ZodBranded:return parseBrandedDef(t,s);case ZodFirstPartyTypeKind.ZodReadonly:return parseReadonlyDef(t,s);case ZodFirstPartyTypeKind.ZodCatch:return parseCatchDef(t,s);case ZodFirstPartyTypeKind.ZodPipeline:return parsePipelineDef(t,s);case ZodFirstPartyTypeKind.ZodFunction:case ZodFirstPartyTypeKind.ZodVoid:case ZodFirstPartyTypeKind.ZodSymbol:return;default:return(n=>{})()}},addMeta=(t,e,s)=>(t.description&&(s.description=t.description,e.markdownDescription&&(s.markdownDescription=t.description)),s),getRefs=t=>{const e=getDefaultOptions(t),s=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:s,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([n,r])=>[r._def,{def:r._def,path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}},zodToJsonSchema=(t,e)=>{const s=getRefs(e),n=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((u,[f,c])=>({...u,[f]:parseDef(c._def,{...s,currentPath:[...s.basePath,s.definitionPath,f]},!0)??{}}),{}):void 0,r=typeof e=="string"?e:e?.name,a=parseDef(t._def,r===void 0?s:{...s,currentPath:[...s.basePath,s.definitionPath,r]},!1)??{},i=r===void 0?n?{...a,[s.definitionPath]:n}:a:{$ref:[...s.$refStrategy==="relative"?[]:s.basePath,s.definitionPath,r].join("/"),[s.definitionPath]:{...n,[r]:a}};return s.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":s.target==="jsonSchema2019-09"&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),i};function nodeDataJson(t){return isRunnableInterface(t.data)?{type:"runnable",data:{id:t.data.lc_id,name:t.data.getName()}}:{type:"schema",data:{...zodToJsonSchema(t.data.schema),title:t.data.name}}}class Graph{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){const e={};return Object.values(this.nodes).forEach((s,n)=>{e[s.id]=validate$1(s.id)?n:s.id}),{nodes:Object.values(this.nodes).map(s=>({id:e[s.id],...nodeDataJson(s)})),edges:this.edges.map(s=>s.data?{source:e[s.source],target:e[s.target],data:s.data}:{source:e[s.source],target:e[s.target]})}}addNode(e,s){if(s!==void 0&&this.nodes[s]!==void 0)throw new Error(`Node with id ${s} already exists`);const n=s||v4(),r={id:n,data:e};return this.nodes[n]=r,r}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(s=>s.source!==e.id&&s.target!==e.id)}addEdge(e,s,n){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[s.id]===void 0)throw new Error(`Target node ${s.id} not in graph`);const r={source:e.id,target:s.id,data:n};return this.edges.push(r),r}firstNode(){const e=new Set(this.edges.map(n=>n.target)),s=[];return Object.values(this.nodes).forEach(n=>{e.has(n.id)||s.push(n)}),s[0]}lastNode(){const e=new Set(this.edges.map(n=>n.source)),s=[];return Object.values(this.nodes).forEach(n=>{e.has(n.id)||s.push(n)}),s[0]}extend(e){Object.entries(e.nodes).forEach(([s,n])=>{this.nodes[s]=n}),this.edges=[...this.edges,...e.edges]}trimFirstNode(){const e=this.firstNode();if(e){const s=this.edges.filter(n=>n.source===e.id);(Object.keys(this.nodes).length===1||s.length===1)&&this.removeNode(e)}}trimLastNode(){const e=this.lastNode();if(e){const s=this.edges.filter(n=>n.target===e.id);(Object.keys(this.nodes).length===1||s.length===1)&&this.removeNode(e)}}}function _coerceToDict(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}class Runnable extends Serializable{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const s=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${s}${e}`:s}bind(e){return new RunnableBinding({bound:this,kwargs:e,config:{}})}map(){return new RunnableEach({bound:this})}withRetry(e){return new RunnableRetry({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new RunnableBinding({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new RunnableWithFallbacks({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,s=0){if(Array.isArray(e)){if(e.length!==s)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${s} inputs`);return e.map(ensureConfig)}return Array.from({length:s},()=>ensureConfig(e))}async batch(e,s,n){const r=this._getOptionsList(s??{},e.length),a=r[0]?.maxConcurrency??n?.maxConcurrency,i=new AsyncCaller$1({maxConcurrency:a,onFailedAttempt:f=>{throw f}}),u=e.map((f,c)=>i.call(async()=>{try{return await this.invoke(f,r[c])}catch(d){if(n?.returnExceptions)return d;throw d}}));return Promise.all(u)}async*_streamIterator(e,s){yield this.invoke(e,s)}async stream(e,s){const n=new AsyncGeneratorWithSetup(this._streamIterator(e,ensureConfig(s)));return await n.setup,IterableReadableStream.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(e={}){const s=ensureConfig({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency}),n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,[s,n]}async _callWithConfig(e,s,n){const r=ensureConfig(n),i=await(await getCallbackManagerForConfig(r))?.handleChainStart(this.toJSON(),_coerceToDict(s,"input"),void 0,r?.runType,void 0,void 0,r?.runName??this.getName());let u;try{u=await e.call(this,s,r,i)}catch(f){throw await i?.handleChainError(f),f}return await i?.handleChainEnd(_coerceToDict(u,"output")),u}async _batchWithConfig(e,s,n,r){const a=this._getOptionsList(n??{},s.length),i=await Promise.all(a.map(getCallbackManagerForConfig)),u=await Promise.all(i.map((c,d)=>c?.handleChainStart(this.toJSON(),_coerceToDict(s[d],"input"),void 0,a[d].runType,void 0,void 0,a[d].runName??this.getName())));let f;try{f=await e.call(this,s,a,u,r)}catch(c){throw await Promise.all(u.map(d=>d?.handleChainError(c))),c}return await Promise.all(u.map(c=>c?.handleChainEnd(_coerceToDict(f,"output")))),f}async*_transformStreamWithConfig(e,s,n){let r,a=!0,i,u=!0;const f=ensureConfig(n),c=await getCallbackManagerForConfig(f);async function*d(){for await(const m of e){if(a)if(r===void 0)r=m;else try{r=concat(r,m)}catch{r=void 0,a=!1}yield m}}let h;try{const m=await pipeGeneratorWithSetup(s.bind(this),d(),async()=>c?.handleChainStart(this.toJSON(),{input:""},void 0,f?.runType,void 0,void 0,f?.runName??this.getName()),f);h=m.setup;const _=A=>A.name==="log_stream_tracer",p=h?.handlers.find(_);let b=m.output;p!==void 0&&h!==void 0&&(b=await p.tapOutputIterable(h.runId,m.output));for await(const A of b)if(yield A,u)if(i===void 0)i=A;else try{i=concat(i,A)}catch{i=void 0,u=!1}}catch(m){throw await h?.handleChainError(m,void 0,void 0,void 0,{inputs:_coerceToDict(r,"input")}),m}await h?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:_coerceToDict(r,"input")})}getGraph(e){const s=new Graph,n=s.addNode({name:`${this.getName()}Input`,schema:anyType()}),r=s.addNode(this),a=s.addNode({name:`${this.getName()}Output`,schema:anyType()});return s.addEdge(n,r),s.addEdge(r,a),s}pipe(e){return new RunnableSequence({first:this,last:_coerceToRunnable(e)})}pick(e){return this.pipe(new RunnablePick(e))}assign(e){return this.pipe(new RunnableAssign(new RunnableMap({steps:e})))}async*transform(e,s){let n;for await(const r of e)n===void 0?n=r:n=concat(n,r);yield*this._streamIterator(n,ensureConfig(s))}async*streamLog(e,s,n){const r=new LogStreamCallbackHandler({...n,autoClose:!1,_schemaFormat:"original"}),a=ensureConfig(s);yield*this._streamLog(e,r,a)}async*_streamLog(e,s,n){const{callbacks:r}=n;if(r===void 0)n.callbacks=[s];else if(Array.isArray(r))n.callbacks=r.concat([s]);else{const f=r.copy();f.inheritableHandlers.push(s),n.callbacks=f}const a=this.stream(e,n);async function i(){try{const f=await a;for await(const c of f){const d=new RunLogPatch({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await s.writer.write(d)}}finally{await s.writer.close()}}const u=i();try{for await(const f of s)yield f}finally{await u}}async*streamEvents(e,s,n){if(s.version!=="v1")throw new Error('Only version "v1" of the events schema is currently supported.');let r,a=!1;const i=ensureConfig(s),u=i.tags??[],f=i.metadata??{},c=i.runName??this.getName(),d=new LogStreamCallbackHandler({...n,autoClose:!1,_schemaFormat:"streaming_events"}),h=new _RootEventFilter({...n}),m=this._streamLog(e,d,i);for await(const p of m){if(r?r=r.concat(p):r=RunLog.fromRunLogPatch(p),r.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const v={...r.state},N={run_id:v.id,event:`on_${v.type}_start`,name:c,tags:u,metadata:f,data:{input:e}};h.includeEvent(N,v.type)&&(yield N)}const b=p.ops.filter(v=>v.path.startsWith("/logs/")).map(v=>v.path.split("/")[2]),A=[...new Set(b)];for(const v of A){let N,x={};const y=r.state.logs[v];if(y.end_time===void 0?y.streamed_output.length>0?N="stream":N="start":N="end",N==="start")y.inputs!==void 0&&(x.input=y.inputs);else if(N==="end")y.inputs!==void 0&&(x.input=y.inputs),x.output=y.final_output;else if(N==="stream"){const S=y.streamed_output.length;if(S!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${S} instead. Encountered in: "${y.name}"`);x={chunk:y.streamed_output[0]},y.streamed_output=[]}yield{event:`on_${y.type}_${N}`,name:y.name,run_id:y.id,tags:y.tags,metadata:y.metadata,data:x}}const{state:T}=r;if(T.streamed_output.length>0){const v=T.streamed_output.length;if(v!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${v} instead. Encountered in: "${T.name}"`);const N={chunk:T.streamed_output[0]};T.streamed_output=[];const x={event:`on_${T.type}_stream`,run_id:T.id,tags:u,metadata:f,name:c,data:N};h.includeEvent(x,T.type)&&(yield x)}}const _=r?.state;if(_!==void 0){const p={event:`on_${_.type}_end`,name:c,run_id:_.id,tags:u,metadata:f,data:{output:_.final_output}};h.includeEvent(p,_.type)&&(yield p)}}static isRunnable(e){return isRunnableInterface(e)}withListeners({onStart:e,onEnd:s,onError:n}){return new RunnableBinding({bound:this,config:{},configFactories:[r=>({callbacks:[new RootListenersTracer({config:r,onStart:e,onEnd:s,onError:n})]})]})}}class RunnableBinding extends Runnable{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const s=mergeConfigs(this.config,...e);return mergeConfigs(s,...this.configFactories?await Promise.all(this.configFactories.map(async n=>await n(s))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,s){return this.bound.invoke(e,await this._mergeConfig(s,this.kwargs))}async batch(e,s,n){const r=Array.isArray(s)?await Promise.all(s.map(async a=>this._mergeConfig(a,this.kwargs))):await this._mergeConfig(s,this.kwargs);return this.bound.batch(e,r,n)}async*_streamIterator(e,s){yield*this.bound._streamIterator(e,await this._mergeConfig(s,this.kwargs))}async stream(e,s){return this.bound.stream(e,await this._mergeConfig(s,this.kwargs))}async*transform(e,s){yield*this.bound.transform(e,await this._mergeConfig(s,this.kwargs))}async*streamEvents(e,s,n){yield*this.bound.streamEvents(e,{...await this._mergeConfig(s,this.kwargs),version:s.version},n)}static isRunnableBinding(e){return e.bound&&Runnable.isRunnable(e.bound)}withListeners({onStart:e,onEnd:s,onError:n}){return new RunnableBinding({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[r=>({callbacks:[new RootListenersTracer({config:r,onStart:e,onEnd:s,onError:n})]})]})}}class RunnableEach extends Runnable{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new RunnableEach({bound:this.bound.bind(e)})}async invoke(e,s){return this._callWithConfig(this._invoke,e,s)}async _invoke(e,s,n){return this.bound.batch(e,patchConfig(s,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:s,onError:n}){return new RunnableEach({bound:this.bound.withListeners({onStart:e,onEnd:s,onError:n})})}}class RunnableRetry extends RunnableBinding{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,s,n){const r=e>1?`retry:attempt:${e}`:void 0;return patchConfig(s,{callbacks:n?.getChild(r)})}async _invoke(e,s,n){return pRetry$1(r=>super.invoke(e,this._patchConfigForRetry(r,s,n)),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,s){return this._callWithConfig(this._invoke,e,s)}async _batch(e,s,n,r){const a={};try{await pRetry$1(async i=>{const u=e.map((m,_)=>_).filter(m=>a[m.toString()]===void 0||a[m.toString()]instanceof Error),f=u.map(m=>e[m]),c=u.map(m=>this._patchConfigForRetry(i,s?.[m],n?.[m])),d=await super.batch(f,c,{...r,returnExceptions:!0});let h;for(let m=0;m<d.length;m+=1){const _=d[m],p=u[m];_ instanceof Error&&h===void 0&&(h=_),a[p.toString()]=_}if(h)throw h;return d},{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if(r?.returnExceptions!==!0)throw i}return Object.keys(a).sort((i,u)=>parseInt(i,10)-parseInt(u,10)).map(i=>a[parseInt(i,10)])}async batch(e,s,n){return this._batchWithConfig(this._batch.bind(this),e,s,n)}}class RunnableSequence extends Runnable{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,s){const n=ensureConfig(s),a=await(await getCallbackManagerForConfig(n))?.handleChainStart(this.toJSON(),_coerceToDict(e,"input"),void 0,void 0,void 0,void 0,n?.runName);let i=e,u;try{const f=[this.first,...this.middle];for(let c=0;c<f.length;c+=1)i=await f[c].invoke(i,patchConfig(n,{callbacks:a?.getChild(`seq:step:${c+1}`)}));u=await this.last.invoke(i,patchConfig(n,{callbacks:a?.getChild(`seq:step:${this.steps.length}`)}))}catch(f){throw await a?.handleChainError(f),f}return await a?.handleChainEnd(_coerceToDict(u,"output")),u}async batch(e,s,n){const r=this._getOptionsList(s??{},e.length),a=await Promise.all(r.map(getCallbackManagerForConfig)),i=await Promise.all(a.map((f,c)=>f?.handleChainStart(this.toJSON(),_coerceToDict(e[c],"input"),void 0,void 0,void 0,void 0,r[c].runName)));let u=e;try{for(let f=0;f<this.steps.length;f+=1)u=await this.steps[f].batch(u,i.map((d,h)=>{const m=d?.getChild(`seq:step:${f+1}`);return patchConfig(r[h],{callbacks:m})}),n)}catch(f){throw await Promise.all(i.map(c=>c?.handleChainError(f))),f}return await Promise.all(i.map(f=>f?.handleChainEnd(_coerceToDict(u,"output")))),u}async*_streamIterator(e,s){const r=await(await getCallbackManagerForConfig(s))?.handleChainStart(this.toJSON(),_coerceToDict(e,"input"),void 0,void 0,void 0,void 0,s?.runName),a=[this.first,...this.middle,this.last];let i=!0,u;async function*f(){yield e}try{let c=a[0].transform(f(),patchConfig(s,{callbacks:r?.getChild("seq:step:1")}));for(let d=1;d<a.length;d+=1)c=await a[d].transform(c,patchConfig(s,{callbacks:r?.getChild(`seq:step:${d+1}`)}));for await(const d of c)if(yield d,i)if(u===void 0)u=d;else try{u=concat(u,d)}catch{u=void 0,i=!1}}catch(c){throw await r?.handleChainError(c),c}await r?.handleChainEnd(_coerceToDict(u,"output"))}getGraph(e){const s=new Graph;let n=null;return this.steps.forEach((r,a)=>{const i=r.getGraph(e);a!==0&&i.trimFirstNode(),a!==this.steps.length-1&&i.trimLastNode(),s.extend(i);const u=i.firstNode();if(!u)throw new Error(`Runnable ${r} has no first node`);n&&s.addEdge(n,u),n=i.lastNode()}),s}pipe(e){return RunnableSequence.isRunnableSequence(e)?new RunnableSequence({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new RunnableSequence({first:this.first,middle:[...this.middle,this.last],last:_coerceToRunnable(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&Runnable.isRunnable(e)}static from([e,...s],n){return new RunnableSequence({first:_coerceToRunnable(e),middle:s.slice(0,-1).map(_coerceToRunnable),last:_coerceToRunnable(s[s.length-1]),name:n})}}class RunnableMap extends Runnable{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[s,n]of Object.entries(e.steps))this.steps[s]=_coerceToRunnable(n)}static from(e){return new RunnableMap({steps:e})}async invoke(e,s){const n=ensureConfig(s),a=await(await getCallbackManagerForConfig(n))?.handleChainStart(this.toJSON(),{input:e},void 0,void 0,void 0,void 0,n?.runName),i={};try{await Promise.all(Object.entries(this.steps).map(async([u,f])=>{i[u]=await f.invoke(e,patchConfig(n,{callbacks:a?.getChild(`map:key:${u}`)}))}))}catch(u){throw await a?.handleChainError(u),u}return await a?.handleChainEnd(i),i}async*_transform(e,s,n){const r={...this.steps},a=atee(e,Object.keys(r).length),i=new Map(Object.entries(r).map(([u,f],c)=>{const d=f.transform(a[c],patchConfig(n,{callbacks:s?.getChild(`map:key:${u}`)}));return[u,d.next().then(h=>({key:u,gen:d,result:h}))]}));for(;i.size;){const{key:u,result:f,gen:c}=await Promise.race(i.values());i.delete(u),f.done||(yield{[u]:f.value},i.set(u,c.next().then(d=>({key:u,gen:c,result:d}))))}}transform(e,s){return this._transformStreamWithConfig(e,this._transform.bind(this),s)}async stream(e,s){async function*n(){yield e}const r=new AsyncGeneratorWithSetup(this.transform(n(),s));return await r.setup,IterableReadableStream.fromAsyncGenerator(r)}}class RunnableLambda extends Runnable{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new RunnableLambda({func:e})}async _invoke(e,s,n){return new Promise((r,a)=>{const i=patchConfig(s,{callbacks:n?.getChild(),recursionLimit:(s?.recursionLimit??DEFAULT_RECURSION_LIMIT)-1});AsyncLocalStorageProviderSingleton.getInstance().run(i,async()=>{try{let u=await this.func(e,{...i,config:i});if(u&&Runnable.isRunnable(u)){if(s?.recursionLimit===0)throw new Error("Recursion limit reached.");u=await u.invoke(e,{...i,recursionLimit:(i.recursionLimit??DEFAULT_RECURSION_LIMIT)-1})}r(u)}catch(u){a(u)}})})}async invoke(e,s){return this._callWithConfig(this._invoke,e,s)}async*_transform(e,s,n){let r;for await(const i of e)if(r===void 0)r=i;else try{r=concat(r,i)}catch{r=i}const a=await new Promise((i,u)=>{AsyncLocalStorageProviderSingleton.getInstance().run(n,async()=>{try{const f=await this.func(r,{...n,config:n});i(f)}catch(f){u(f)}})});if(a&&Runnable.isRunnable(a)){if(n?.recursionLimit===0)throw new Error("Recursion limit reached.");const i=await a.stream(r,patchConfig(n,{callbacks:s?.getChild(),recursionLimit:(n?.recursionLimit??DEFAULT_RECURSION_LIMIT)-1}));for await(const u of i)yield u}else yield a}transform(e,s){return this._transformStreamWithConfig(e,this._transform.bind(this),s)}async stream(e,s){async function*n(){yield e}const r=new AsyncGeneratorWithSetup(this.transform(n(),s));return await r.setup,IterableReadableStream.fromAsyncGenerator(r)}}class RunnableWithFallbacks extends Runnable{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,s){const r=await(await CallbackManager.configure(s?.callbacks,void 0,s?.tags,void 0,s?.metadata))?.handleChainStart(this.toJSON(),_coerceToDict(e,"input"),void 0,void 0,void 0,void 0,s?.runName);let a;for(const i of this.runnables())try{const u=await i.invoke(e,patchConfig(s,{callbacks:r?.getChild()}));return await r?.handleChainEnd(_coerceToDict(u,"output")),u}catch(u){a===void 0&&(a=u)}throw a===void 0?new Error("No error stored at end of fallback."):(await r?.handleChainError(a),a)}async batch(e,s,n){if(n?.returnExceptions)throw new Error("Not implemented.");const r=this._getOptionsList(s??{},e.length),a=await Promise.all(r.map(f=>CallbackManager.configure(f?.callbacks,void 0,f?.tags,void 0,f?.metadata))),i=await Promise.all(a.map((f,c)=>f?.handleChainStart(this.toJSON(),_coerceToDict(e[c],"input"),void 0,void 0,void 0,void 0,r[c].runName)));let u;for(const f of this.runnables())try{const c=await f.batch(e,i.map((d,h)=>patchConfig(r[h],{callbacks:d?.getChild()})),n);return await Promise.all(i.map((d,h)=>d?.handleChainEnd(_coerceToDict(c[h],"output")))),c}catch(c){u===void 0&&(u=c)}throw u?(await Promise.all(i.map(f=>f?.handleChainError(u))),u):new Error("No error stored at end of fallbacks.")}}function _coerceToRunnable(t){if(typeof t=="function")return new RunnableLambda({func:t});if(Runnable.isRunnable(t))return t;if(!Array.isArray(t)&&typeof t=="object"){const e={};for(const[s,n]of Object.entries(t))e[s]=_coerceToRunnable(n);return new RunnableMap({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class RunnableAssign extends Runnable{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof RunnableMap&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,s){const n=await this.mapper.invoke(e,s);return{...e,...n}}async*_transform(e,s,n){const r=this.mapper.getStepsKeys(),[a,i]=atee(e),u=this.mapper.transform(i,patchConfig(n,{callbacks:s?.getChild()})),f=u.next();for await(const c of a){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const d=Object.fromEntries(Object.entries(c).filter(([h])=>!r.includes(h)));Object.keys(d).length>0&&(yield d)}yield(await f).value;for await(const c of u)yield c}transform(e,s){return this._transformStreamWithConfig(e,this._transform.bind(this),s)}async stream(e,s){async function*n(){yield e}const r=new AsyncGeneratorWithSetup(this.transform(n(),s));return await r.setup,IterableReadableStream.fromAsyncGenerator(r)}}class RunnablePick extends Runnable{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const s=this.keys.map(n=>[n,e[n]]).filter(n=>n[1]!==void 0);return s.length===0?void 0:Object.fromEntries(s)}}async invoke(e,s){return this._callWithConfig(this._pick.bind(this),e,s)}async*_transform(e){for await(const s of e){const n=await this._pick(s);n!==void 0&&(yield n)}}transform(e,s){return this._transformStreamWithConfig(e,this._transform.bind(this),s)}async stream(e,s){async function*n(){yield e}const r=new AsyncGeneratorWithSetup(this.transform(n(),s));return await r.setup,IterableReadableStream.fromAsyncGenerator(r)}}const getModelNameForTiktoken=t=>t.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":t.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":t.startsWith("gpt-4-32k")?"gpt-4-32k":t.startsWith("gpt-4-")?"gpt-4":t,getVerbosity=()=>!1;class BaseLangChain extends Runnable{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??getVerbosity(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class BaseLanguageModel extends BaseLangChain{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:s,...n}){super({callbacks:e??s,...n}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof n.cache=="object"?this.cache=n.cache:n.cache?this.cache=InMemoryCache.global():this.cache=void 0,this.caller=new AsyncCaller$1(n??{})}async getNumTokens(e){if(typeof e!="string")return 0;let s=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await encodingForModel("modelName"in this?getModelNameForTiktoken(this.modelName):"gpt2")}catch(n){console.warn("Failed to calculate number of tokens, falling back to approximate count",n)}if(this._encoding)try{s=this._encoding.encode(e).length}catch(n){console.warn("Failed to calculate number of tokens, falling back to approximate count",n)}return s}static _convertInputToPromptValue(e){return typeof e=="string"?new StringPromptValue(e):Array.isArray(e)?new ChatPromptValue(e.map(coerceMessageLikeToMessage)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall(e){const s={...this._identifyingParams(),...e,_type:this._llmType(),_model:this._modelType()};return Object.entries(s).filter(([a,i])=>i!==void 0).map(([a,i])=>`${a}:${JSON.stringify(i)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class BaseChatModel extends BaseLanguageModel{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){const[s,n]=super._separateRunnableConfigFromCallOptions(e);return n?.timeout&&!n.signal&&(n.signal=AbortSignal.timeout(n.timeout)),[s,n]}async invoke(e,s){const n=BaseChatModel._convertInputToPromptValue(e);return(await this.generatePrompt([n],s,s?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,s,n){throw new Error("Not implemented.")}async*_streamIterator(e,s){if(this._streamResponseChunks===BaseChatModel.prototype._streamResponseChunks)yield this.invoke(e,s);else{const r=BaseChatModel._convertInputToPromptValue(e).toChatMessages(),[a,i]=this._separateRunnableConfigFromCallOptions(s),u=await CallbackManager.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),f={options:i,invocation_params:this?.invocationParams(i),batch_size:1},c=await u?.handleChatModelStart(this.toJSON(),[r],void 0,void 0,f,void 0,void 0,a.runName);let d;try{for await(const h of this._streamResponseChunks(r,i,c?.[0]))yield h.message,d?d=d.concat(h):d=h}catch(h){throw await Promise.all((c??[]).map(m=>m?.handleLLMError(h))),h}await Promise.all((c??[]).map(h=>h?.handleLLMEnd({generations:[[d]]})))}}async _generateUncached(e,s,n){const r=e.map(m=>m.map(coerceMessageLikeToMessage)),a=await CallbackManager.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),i={options:s,invocation_params:this?.invocationParams(s),batch_size:1},u=await a?.handleChatModelStart(this.toJSON(),r,void 0,void 0,i,void 0,void 0,n.runName),f=await Promise.allSettled(r.map((m,_)=>this._generate(m,{...s,promptIndex:_},u?.[_]))),c=[],d=[];await Promise.all(f.map(async(m,_)=>{if(m.status==="fulfilled"){const p=m.value;return c[_]=p.generations,d[_]=p.llmOutput,u?.[_]?.handleLLMEnd({generations:[p.generations],llmOutput:p.llmOutput})}else return await u?.[_]?.handleLLMError(m.reason),Promise.reject(m.reason)}));const h={generations:c,llmOutput:d.length?this._combineLLMOutput?.(...d):void 0};return Object.defineProperty(h,RUN_KEY,{value:u?{runIds:u?.map(m=>m.runId)}:void 0,configurable:!0}),h}async _generateCached({messages:e,cache:s,llmStringKey:n,parsedOptions:r,handledOptions:a}){const i=e.map(b=>b.map(coerceMessageLikeToMessage)),u=await CallbackManager.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),f={options:r,invocation_params:this?.invocationParams(r),batch_size:1,cached:!0},c=await u?.handleChatModelStart(this.toJSON(),i,void 0,void 0,f,void 0,void 0,a.runName),d=[],m=(await Promise.allSettled(i.map(async(b,A)=>{const T=BaseChatModel._convertInputToPromptValue(b).toString(),v=await s.lookup(T,n);return v==null&&d.push(A),v}))).map((b,A)=>({result:b,runManager:c?.[A]})).filter(({result:b})=>b.status==="fulfilled"&&b.value!=null||b.status==="rejected"),_=[];await Promise.all(m.map(async({result:b,runManager:A},T)=>{if(b.status==="fulfilled"){const v=b.value;return _[T]=v,v.length&&await A?.handleLLMNewToken(v[0].text),A?.handleLLMEnd({generations:[v]})}else return await A?.handleLLMError(b.reason),Promise.reject(b.reason)}));const p={generations:_,missingPromptIndices:d};return Object.defineProperty(p,RUN_KEY,{value:c?{runIds:c?.map(b=>b.runId)}:void 0,configurable:!0}),p}async generate(e,s,n){let r;Array.isArray(s)?r={stop:s}:r=s;const a=e.map(_=>_.map(coerceMessageLikeToMessage)),[i,u]=this._separateRunnableConfigFromCallOptions(r);if(i.callbacks=i.callbacks??n,!this.cache)return this._generateUncached(a,u,i);const{cache:f}=this,c=this._getSerializedCacheKeyParametersForCall(u),{generations:d,missingPromptIndices:h}=await this._generateCached({messages:a,cache:f,llmStringKey:c,parsedOptions:u,handledOptions:i});let m={};if(h.length>0){const _=await this._generateUncached(h.map(p=>a[p]),u,i);await Promise.all(_.generations.map(async(p,b)=>{const A=h[b];d[A]=p;const T=BaseChatModel._convertInputToPromptValue(a[A]).toString();return f.update(T,c,p)})),m=_.llmOutput??{}}return{generations:d,llmOutput:m}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,s,n){const r=e.map(a=>a.toChatMessages());return this.generate(r,s,n)}async call(e,s,n){return(await this.generate([e.map(coerceMessageLikeToMessage)],s,n)).generations[0][0].message}async callPrompt(e,s,n){const r=e.toChatMessages();return this.call(r,s,n)}async predictMessages(e,s,n){return this.call(e,s,n)}async predict(e,s,n){const r=new HumanMessage(e),a=await this.call([r],s,n);if(typeof a.content!="string")throw new Error("Cannot use predict when output is not a string.");return a.content}}class SimpleChatModel extends BaseChatModel{async _generate(e,s,n){const r=await this._call(e,s,n),a=new AIMessage(r);if(typeof a.content!="string")throw new Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:a.content,message:a}]}}}const messages=Object.freeze(Object.defineProperty({__proto__:null,AIMessage,AIMessageChunk,BaseMessage,BaseMessageChunk,ChatMessage,ChatMessageChunk,FunctionMessageChunk,HumanMessage,HumanMessageChunk,SystemMessage,SystemMessageChunk,ToolMessageChunk,coerceMessageLikeToMessage,getBufferString,isBaseMessage,isBaseMessageChunk},Symbol.toStringTag,{value:"Module"}));async function*createOllamaStream(t,e,s){let n=t;n.startsWith("http://localhost:")&&(n=n.replace("http://localhost:","http://127.0.0.1:"));const r=await getCustomOllamaHeaders(),a=await fetch(n,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json",...s.headers,...r},signal:s.signal});if(!a.ok){let c;const d=await a.text();try{const h=JSON.parse(d);c=new Error(`Ollama call failed with status code ${a.status}: ${h.error}`)}catch{c=new Error(`Ollama call failed with status code ${a.status}: ${d}`)}throw c.response=a,c}if(!a.body)throw new Error("Could not begin Ollama stream. Please check the given URL and try again.");const i=IterableReadableStream.fromReadableStream(a.body),u=new TextDecoder;let f="";for await(const c of i){const h=(f+u.decode(c)).split(`
`);f=h.pop()||"";for(const m of h)try{yield JSON.parse(m)}catch{console.warn(`Received a non-JSON parseable chunk: ${m}`)}}}async function*createOllamaGenerateStream(t,e,s){yield*createOllamaStream(`${t}/api/generate`,e,s)}async function*createOllamaChatStream(t,e,s){yield*createOllamaStream(`${t}/api/chat`,e,s)}const parseKeepAlive=t=>t==="-1"?-1:t;class ChatOllama extends SimpleChatModel{static lc_name(){return"ChatOllama"}lc_serializable=!0;model="llama2";baseUrl="http://localhost:11434";keepAlive;embeddingOnly;f16KV;frequencyPenalty;headers;logitsAll;lowVram;mainGpu;mirostat;mirostatEta;mirostatTau;numBatch;numCtx;numGpu;numGqa;numKeep;numPredict;numThread;penalizeNewline;presencePenalty;repeatLastN;repeatPenalty;ropeFrequencyBase;ropeFrequencyScale;temperature;stop;tfsZ;topK;topP;minP;typicalP;useMLock;useMMap;useMlock;vocabOnly;seed;format;constructor(e){super(e),this.model=e.model??this.model,this.baseUrl=e.baseUrl?.endsWith("/")?e.baseUrl.slice(0,-1):e.baseUrl??this.baseUrl,this.keepAlive=parseKeepAlive(e.keepAlive),this.embeddingOnly=e.embeddingOnly,this.f16KV=e.f16KV,this.frequencyPenalty=e.frequencyPenalty,this.headers=e.headers,this.logitsAll=e.logitsAll,this.lowVram=e.lowVram,this.mainGpu=e.mainGpu,this.mirostat=e.mirostat,this.mirostatEta=e.mirostatEta,this.mirostatTau=e.mirostatTau,this.numBatch=e.numBatch,this.numCtx=e.numCtx,this.numGpu=e.numGpu===null?void 0:e.numGpu,this.numGqa=e.numGqa,this.numKeep=e.numKeep,this.numPredict=e.numPredict,this.numThread=e.numThread,this.penalizeNewline=e.penalizeNewline,this.presencePenalty=e.presencePenalty,this.repeatLastN=e.repeatLastN,this.repeatPenalty=e.repeatPenalty,this.ropeFrequencyBase=e.ropeFrequencyBase,this.ropeFrequencyScale=e.ropeFrequencyScale,this.temperature=e.temperature,this.stop=e.stop,this.tfsZ=e.tfsZ,this.topK=e.topK,this.topP=e.topP,this.minP=e.minP,this.typicalP=e.typicalP,this.useMLock=e.useMLock,this.useMMap=e.useMMap,this.useMlock=e.useMlock,this.vocabOnly=e.vocabOnly,this.format=e.format,this.seed=e.seed}getLsParams(e){const s=this.invocationParams(e);return{ls_provider:"ollama",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.temperature??void 0,ls_stop:this.stop,ls_max_tokens:s.options.num_predict}}_llmType(){return"ollama"}invocationParams(e){return{model:this.model,format:this.format,keep_alive:this.keepAlive,options:{embedding_only:this.embeddingOnly,f16_kv:this.f16KV,frequency_penalty:this.frequencyPenalty,logits_all:this.logitsAll,low_vram:this.lowVram,main_gpu:this.mainGpu,mirostat:this.mirostat,mirostat_eta:this.mirostatEta,mirostat_tau:this.mirostatTau,num_batch:this.numBatch,num_ctx:this.numCtx,num_gpu:this.numGpu,num_gqa:this.numGqa,num_keep:this.numKeep,num_predict:this.numPredict,num_thread:this.numThread,penalize_newline:this.penalizeNewline,presence_penalty:this.presencePenalty,repeat_last_n:this.repeatLastN,repeat_penalty:this.repeatPenalty,rope_frequency_base:this.ropeFrequencyBase,rope_frequency_scale:this.ropeFrequencyScale,temperature:this.temperature,stop:e?.stop??this.stop,tfs_z:this.tfsZ,top_k:this.topK,top_p:this.topP,min_p:this.minP,typical_p:this.typicalP,use_mlock:this.useMlock,use_mmap:this.useMMap,vocab_only:this.vocabOnly,seed:this.seed}}}_combineLLMOutput(){return{}}async*_streamResponseChunksLegacy(e,s,n){const r=createOllamaGenerateStream(this.baseUrl,{...this.invocationParams(s),prompt:this._formatMessagesAsPrompt(e)},{...s,headers:this.headers});for await(const a of r)a.done?yield new ChatGenerationChunk({text:"",message:new AIMessageChunk({content:""}),generationInfo:{model:a.model,total_duration:a.total_duration,load_duration:a.load_duration,prompt_eval_count:a.prompt_eval_count,prompt_eval_duration:a.prompt_eval_duration,eval_count:a.eval_count,eval_duration:a.eval_duration}}):(yield new ChatGenerationChunk({text:a.response,message:new AIMessageChunk({content:a.response})}),await n?.handleLLMNewToken(a.response??""))}async*_streamResponseChunks(e,s,n){try{const r=await this.caller.call(async()=>createOllamaChatStream(this.baseUrl,{...this.invocationParams(s),messages:this._convertMessagesToOllamaMessages(e)},{...s,headers:this.headers}));for await(const a of r)a.done?yield new ChatGenerationChunk({text:"",message:new AIMessageChunk({content:""}),generationInfo:{model:a.model,total_duration:a.total_duration,load_duration:a.load_duration,prompt_eval_count:a.prompt_eval_count,prompt_eval_duration:a.prompt_eval_duration,eval_count:a.eval_count,eval_duration:a.eval_duration}}):(yield new ChatGenerationChunk({text:a.message.content,message:new AIMessageChunk({content:a.message.content})}),await n?.handleLLMNewToken(a.message.content??""))}catch(r){if(r.response?.status===404)console.warn("[WARNING]: It seems you are using a legacy version of Ollama. Please upgrade to a newer version for better chat support."),yield*this._streamResponseChunksLegacy(e,s,n);else throw r}}_convertMessagesToOllamaMessages(e){return e.map(s=>{let n;if(s._getType()==="human")n="user";else if(s._getType()==="ai")n="assistant";else if(s._getType()==="system")n="system";else throw new Error(`Unsupported message type for Ollama: ${s._getType()}`);let r="";const a=[];if(typeof s.content=="string")r=s.content;else for(const i of s.content)if(i.type==="text")r=`${r}
${i.text}`;else if(i.type==="image_url"&&typeof i.image_url=="string"){const u=i.image_url.split(",");a.push(u[1]??u[0])}else throw new Error('Unsupported message content type. Must either have type "text" or type "image_url" with a string "image_url" field.');return{role:n,content:r,images:a}})}_formatMessagesAsPrompt(e){return e.map(n=>{let r;return n._getType()==="human"?r=`[INST] ${n.content} [/INST]`:n._getType()==="ai"?r=n.content:n._getType()==="system"?r=`<<SYS>> ${n.content} <</SYS>>`:ChatMessage.isInstance(n)?r=`

${n.role[0].toUpperCase()}${n.role.slice(1)}: ${n.content}`:(console.warn(`Unsupported message type passed to Ollama: "${n._getType()}"`),r=""),r}).join(`
`)}async _call(e,s,n){const r=[];for await(const a of this._streamResponseChunks(e,s,n))r.push(a.message.content);return r.join("")}}const default_format="RFC3986",formatters={RFC1738:t=>String(t).replace(/%20/g,"+"),RFC3986:t=>String(t)},RFC1738="RFC1738",is_array$1=Array.isArray,hex_table=(()=>{const t=[];for(let e=0;e<256;++e)t.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return t})(),limit=1024,encode=(t,e,s,n,r)=>{if(t.length===0)return t;let a=t;if(typeof t=="symbol"?a=Symbol.prototype.toString.call(t):typeof t!="string"&&(a=String(t)),s==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(u){return"%26%23"+parseInt(u.slice(2),16)+"%3B"});let i="";for(let u=0;u<a.length;u+=limit){const f=a.length>=limit?a.slice(u,u+limit):a,c=[];for(let d=0;d<f.length;++d){let h=f.charCodeAt(d);if(h===45||h===46||h===95||h===126||h>=48&&h<=57||h>=65&&h<=90||h>=97&&h<=122||r===RFC1738&&(h===40||h===41)){c[c.length]=f.charAt(d);continue}if(h<128){c[c.length]=hex_table[h];continue}if(h<2048){c[c.length]=hex_table[192|h>>6]+hex_table[128|h&63];continue}if(h<55296||h>=57344){c[c.length]=hex_table[224|h>>12]+hex_table[128|h>>6&63]+hex_table[128|h&63];continue}d+=1,h=65536+((h&1023)<<10|f.charCodeAt(d)&1023),c[c.length]=hex_table[240|h>>18]+hex_table[128|h>>12&63]+hex_table[128|h>>6&63]+hex_table[128|h&63]}i+=c.join("")}return i};function is_buffer(t){return!t||typeof t!="object"?!1:!!(t.constructor&&t.constructor.isBuffer&&t.constructor.isBuffer(t))}function maybe_map(t,e){if(is_array$1(t)){const s=[];for(let n=0;n<t.length;n+=1)s.push(e(t[n]));return s}return e(t)}const has=Object.prototype.hasOwnProperty,array_prefix_generators={brackets(t){return String(t)+"[]"},comma:"comma",indices(t,e){return String(t)+"["+e+"]"},repeat(t){return String(t)}},is_array=Array.isArray,push=Array.prototype.push,push_to_array=function(t,e){push.apply(t,is_array(e)?e:[e])},to_ISO=Date.prototype.toISOString,defaults={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:encode,encodeValuesOnly:!1,format:default_format,formatter:formatters[default_format],indices:!1,serializeDate(t){return to_ISO.call(t)},skipNulls:!1,strictNullHandling:!1};function is_non_nullish_primitive(t){return typeof t=="string"||typeof t=="number"||typeof t=="boolean"||typeof t=="symbol"||typeof t=="bigint"}const sentinel={};function inner_stringify(t,e,s,n,r,a,i,u,f,c,d,h,m,_,p,b,A,T){let v=t,N=T,x=0,y=!1;for(;(N=N.get(sentinel))!==void 0&&!y;){const W=N.get(t);if(x+=1,typeof W<"u"){if(W===x)throw new RangeError("Cyclic object value");y=!0}typeof N.get(sentinel)>"u"&&(x=0)}if(typeof c=="function"?v=c(e,v):v instanceof Date?v=m?.(v):s==="comma"&&is_array(v)&&(v=maybe_map(v,function(W){return W instanceof Date?m?.(W):W})),v===null){if(a)return f&&!b?f(e,defaults.encoder,A,"key",_):e;v=""}if(is_non_nullish_primitive(v)||is_buffer(v)){if(f){const W=b?e:f(e,defaults.encoder,A,"key",_);return[p?.(W)+"="+p?.(f(v,defaults.encoder,A,"value",_))]}return[p?.(e)+"="+p?.(String(v))]}const S=[];if(typeof v>"u")return S;let D;if(s==="comma"&&is_array(v))b&&f&&(v=maybe_map(v,f)),D=[{value:v.length>0?v.join(",")||null:void 0}];else if(is_array(c))D=c;else{const W=Object.keys(v);D=d?W.sort(d):W}const F=u?String(e).replace(/\./g,"%2E"):String(e),B=n&&is_array(v)&&v.length===1?F+"[]":F;if(r&&is_array(v)&&v.length===0)return B+"[]";for(let W=0;W<D.length;++W){const z=D[W],re=typeof z=="object"&&typeof z.value<"u"?z.value:v[z];if(i&&re===null)continue;const X=h&&u?z.replace(/\./g,"%2E"):z,ne=is_array(v)?typeof s=="function"?s(B,X):B:B+(h?"."+X:"["+X+"]");T.set(t,x);const ie=new WeakMap;ie.set(sentinel,T),push_to_array(S,inner_stringify(re,ne,s,n,r,a,i,u,s==="comma"&&b&&is_array(v)?null:f,c,d,h,m,_,p,b,A,ie))}return S}function normalize_stringify_options(t=defaults){if(typeof t.allowEmptyArrays<"u"&&typeof t.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof t.encodeDotInKeys<"u"&&typeof t.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(t.encoder!==null&&typeof t.encoder<"u"&&typeof t.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=t.charset||defaults.charset;if(typeof t.charset<"u"&&t.charset!=="utf-8"&&t.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let s=default_format;if(typeof t.format<"u"){if(!has.call(formatters,t.format))throw new TypeError("Unknown format option provided.");s=t.format}const n=formatters[s];let r=defaults.filter;(typeof t.filter=="function"||is_array(t.filter))&&(r=t.filter);let a;if(t.arrayFormat&&t.arrayFormat in array_prefix_generators?a=t.arrayFormat:"indices"in t?a=t.indices?"indices":"repeat":a=defaults.arrayFormat,"commaRoundTrip"in t&&typeof t.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=typeof t.allowDots>"u"?t.encodeDotInKeys?!0:defaults.allowDots:!!t.allowDots;return{addQueryPrefix:typeof t.addQueryPrefix=="boolean"?t.addQueryPrefix:defaults.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof t.allowEmptyArrays=="boolean"?!!t.allowEmptyArrays:defaults.allowEmptyArrays,arrayFormat:a,charset:e,charsetSentinel:typeof t.charsetSentinel=="boolean"?t.charsetSentinel:defaults.charsetSentinel,commaRoundTrip:!!t.commaRoundTrip,delimiter:typeof t.delimiter>"u"?defaults.delimiter:t.delimiter,encode:typeof t.encode=="boolean"?t.encode:defaults.encode,encodeDotInKeys:typeof t.encodeDotInKeys=="boolean"?t.encodeDotInKeys:defaults.encodeDotInKeys,encoder:typeof t.encoder=="function"?t.encoder:defaults.encoder,encodeValuesOnly:typeof t.encodeValuesOnly=="boolean"?t.encodeValuesOnly:defaults.encodeValuesOnly,filter:r,format:s,formatter:n,serializeDate:typeof t.serializeDate=="function"?t.serializeDate:defaults.serializeDate,skipNulls:typeof t.skipNulls=="boolean"?t.skipNulls:defaults.skipNulls,sort:typeof t.sort=="function"?t.sort:null,strictNullHandling:typeof t.strictNullHandling=="boolean"?t.strictNullHandling:defaults.strictNullHandling}}function stringify(t,e={}){let s=t;const n=normalize_stringify_options(e);let r,a;typeof n.filter=="function"?(a=n.filter,s=a("",s)):is_array(n.filter)&&(a=n.filter,r=a);const i=[];if(typeof s!="object"||s===null)return"";const u=array_prefix_generators[n.arrayFormat],f=u==="comma"&&n.commaRoundTrip;r||(r=Object.keys(s)),n.sort&&r.sort(n.sort);const c=new WeakMap;for(let m=0;m<r.length;++m){const _=r[m];n.skipNulls&&s[_]===null||push_to_array(i,inner_stringify(s[_],_,u,f,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,c))}const d=i.join(n.delimiter);let h=n.addQueryPrefix===!0?"?":"";return n.charsetSentinel&&(n.charset==="iso-8859-1"?h+="utf8=%26%2310003%3B&":h+="utf8=%E2%9C%93&"),d.length>0?h+d:""}const VERSION="4.95.1";let auto=!1,kind,fetch$1,FormData$1,File$1,ReadableStream$1,getMultipartRequestOptions,getDefaultAgent,fileFromPath,isFsReadStream;function setShims(t,e={auto:!1}){if(auto)throw new Error(`you must \`import 'openai/shims/${t.kind}'\` before importing anything else from openai`);if(kind)throw new Error(`can't \`import 'openai/shims/${t.kind}'\` after \`import 'openai/shims/${kind}'\``);auto=e.auto,kind=t.kind,fetch$1=t.fetch,t.Request,t.Response,t.Headers,FormData$1=t.FormData,t.Blob,File$1=t.File,ReadableStream$1=t.ReadableStream,getMultipartRequestOptions=t.getMultipartRequestOptions,getDefaultAgent=t.getDefaultAgent,fileFromPath=t.fileFromPath,isFsReadStream=t.isFsReadStream}class MultipartBody{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function getRuntime({manuallyImported:t}={}){const e=t?"You may need to use polyfills":"Add one of these imports before your first `import … from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let s,n,r,a;try{s=fetch,n=Request,r=Response,a=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:s,Request:n,Response:r,Headers:a,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,u)=>({...u,body:new MultipartBody(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}const init=()=>{kind||setShims(getRuntime(),{auto:!0})};init();class OpenAIError extends Error{}class APIError extends OpenAIError{constructor(e,s,n,r){super(`${APIError.makeMessage(e,s,n)}`),this.status=e,this.headers=r,this.request_id=r?.["x-request-id"],this.error=s;const a=s;this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,s,n){const r=s?.message?typeof s.message=="string"?s.message:JSON.stringify(s.message):s?JSON.stringify(s):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,s,n,r){if(!e||!r)return new APIConnectionError({message:n,cause:castToError(s)});const a=s?.error;return e===400?new BadRequestError(e,a,n,r):e===401?new AuthenticationError(e,a,n,r):e===403?new PermissionDeniedError(e,a,n,r):e===404?new NotFoundError(e,a,n,r):e===409?new ConflictError(e,a,n,r):e===422?new UnprocessableEntityError(e,a,n,r):e===429?new RateLimitError(e,a,n,r):e>=500?new InternalServerError(e,a,n,r):new APIError(e,a,n,r)}}class APIUserAbortError extends APIError{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class APIConnectionError extends APIError{constructor({message:e,cause:s}){super(void 0,void 0,e||"Connection error.",void 0),s&&(this.cause=s)}}class APIConnectionTimeoutError extends APIConnectionError{constructor({message:e}={}){super({message:e??"Request timed out."})}}class BadRequestError extends APIError{}class AuthenticationError extends APIError{}class PermissionDeniedError extends APIError{}class NotFoundError extends APIError{}class ConflictError extends APIError{}class UnprocessableEntityError extends APIError{}class RateLimitError extends APIError{}class InternalServerError extends APIError{}class LengthFinishReasonError extends OpenAIError{constructor(){super("Could not parse response content as the length limit was reached")}}class ContentFilterFinishReasonError extends OpenAIError{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var __classPrivateFieldSet$5=function(t,e,s,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(t,s):r?r.value=s:e.set(t,s),s},__classPrivateFieldGet$6=function(t,e,s,n){if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?n:s==="a"?n.call(t):n?n.value:e.get(t)},_LineDecoder_carriageReturnIndex;class LineDecoder{constructor(){_LineDecoder_carriageReturnIndex.set(this,void 0),this.buffer=new Uint8Array,__classPrivateFieldSet$5(this,_LineDecoder_carriageReturnIndex,null,"f")}decode(e){if(e==null)return[];const s=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let n=new Uint8Array(this.buffer.length+s.length);n.set(this.buffer),n.set(s,this.buffer.length),this.buffer=n;const r=[];let a;for(;(a=findNewlineIndex(this.buffer,__classPrivateFieldGet$6(this,_LineDecoder_carriageReturnIndex,"f")))!=null;){if(a.carriage&&__classPrivateFieldGet$6(this,_LineDecoder_carriageReturnIndex,"f")==null){__classPrivateFieldSet$5(this,_LineDecoder_carriageReturnIndex,a.index,"f");continue}if(__classPrivateFieldGet$6(this,_LineDecoder_carriageReturnIndex,"f")!=null&&(a.index!==__classPrivateFieldGet$6(this,_LineDecoder_carriageReturnIndex,"f")+1||a.carriage)){r.push(this.decodeText(this.buffer.slice(0,__classPrivateFieldGet$6(this,_LineDecoder_carriageReturnIndex,"f")-1))),this.buffer=this.buffer.slice(__classPrivateFieldGet$6(this,_LineDecoder_carriageReturnIndex,"f")),__classPrivateFieldSet$5(this,_LineDecoder_carriageReturnIndex,null,"f");continue}const i=__classPrivateFieldGet$6(this,_LineDecoder_carriageReturnIndex,"f")!==null?a.preceding-1:a.preceding,u=this.decodeText(this.buffer.slice(0,i));r.push(u),this.buffer=this.buffer.slice(a.index),__classPrivateFieldSet$5(this,_LineDecoder_carriageReturnIndex,null,"f")}return r}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new OpenAIError(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new OpenAIError(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new OpenAIError("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}_LineDecoder_carriageReturnIndex=new WeakMap,LineDecoder.NEWLINE_CHARS=new Set([`
`,"\r"]),LineDecoder.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function findNewlineIndex(t,e){for(let r=e??0;r<t.length;r++){if(t[r]===10)return{preceding:r,index:r+1,carriage:!1};if(t[r]===13)return{preceding:r,index:r+1,carriage:!0}}return null}function findDoubleNewlineIndex(t){for(let n=0;n<t.length-1;n++){if(t[n]===10&&t[n+1]===10||t[n]===13&&t[n+1]===13)return n+2;if(t[n]===13&&t[n+1]===10&&n+3<t.length&&t[n+2]===13&&t[n+3]===10)return n+4}return-1}function ReadableStreamToAsyncIterable(t){if(t[Symbol.asyncIterator])return t;const e=t.getReader();return{async next(){try{const s=await e.read();return s?.done&&e.releaseLock(),s}catch(s){throw e.releaseLock(),s}},async return(){const s=e.cancel();return e.releaseLock(),await s,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class Stream{constructor(e,s){this.iterator=e,this.controller=s}static fromSSEResponse(e,s){let n=!1;async function*r(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let a=!1;try{for await(const i of _iterSSEMessages(e,s))if(!a){if(i.data.startsWith("[DONE]")){a=!0;continue}if(i.event===null||i.event.startsWith("response.")||i.event.startsWith("transcript.")){let u;try{u=JSON.parse(i.data)}catch(f){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),f}if(u&&u.error)throw new APIError(void 0,u.error,void 0,createResponseHeaders(e.headers));yield u}else{let u;try{u=JSON.parse(i.data)}catch(f){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),f}if(i.event=="error")throw new APIError(void 0,u.error,u.message,void 0);yield{event:i.event,data:u}}}a=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{a||s.abort()}}return new Stream(r,s)}static fromReadableStream(e,s){let n=!1;async function*r(){const i=new LineDecoder,u=ReadableStreamToAsyncIterable(e);for await(const f of u)for(const c of i.decode(f))yield c;for(const f of i.flush())yield f}async function*a(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let i=!1;try{for await(const u of r())i||u&&(yield JSON.parse(u));i=!0}catch(u){if(u instanceof Error&&u.name==="AbortError")return;throw u}finally{i||s.abort()}}return new Stream(a,s)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],s=[],n=this.iterator(),r=a=>({next:()=>{if(a.length===0){const i=n.next();e.push(i),s.push(i)}return a.shift()}});return[new Stream(()=>r(e),this.controller),new Stream(()=>r(s),this.controller)]}toReadableStream(){const e=this;let s;const n=new TextEncoder;return new ReadableStream$1({async start(){s=e[Symbol.asyncIterator]()},async pull(r){try{const{value:a,done:i}=await s.next();if(i)return r.close();const u=n.encode(JSON.stringify(a)+`
`);r.enqueue(u)}catch(a){r.error(a)}},async cancel(){await s.return?.()}})}}async function*_iterSSEMessages(t,e){if(!t.body)throw e.abort(),new OpenAIError("Attempted to iterate over a response with no body");const s=new SSEDecoder,n=new LineDecoder,r=ReadableStreamToAsyncIterable(t.body);for await(const a of iterSSEChunks(r))for(const i of n.decode(a)){const u=s.decode(i);u&&(yield u)}for(const a of n.flush()){const i=s.decode(a);i&&(yield i)}}async function*iterSSEChunks(t){let e=new Uint8Array;for await(const s of t){if(s==null)continue;const n=s instanceof ArrayBuffer?new Uint8Array(s):typeof s=="string"?new TextEncoder().encode(s):s;let r=new Uint8Array(e.length+n.length);r.set(e),r.set(n,e.length),e=r;let a;for(;(a=findDoubleNewlineIndex(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}class SSEDecoder{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[s,n,r]=partition(e,":");return r.startsWith(" ")&&(r=r.substring(1)),s==="event"?this.event=r:s==="data"&&this.data.push(r),null}}function partition(t,e){const s=t.indexOf(e);return s!==-1?[t.substring(0,s),e,t.substring(s+e.length)]:[t,"",""]}const isResponseLike=t=>t!=null&&typeof t=="object"&&typeof t.url=="string"&&typeof t.blob=="function",isFileLike=t=>t!=null&&typeof t=="object"&&typeof t.name=="string"&&typeof t.lastModified=="number"&&isBlobLike(t),isBlobLike=t=>t!=null&&typeof t=="object"&&typeof t.size=="number"&&typeof t.type=="string"&&typeof t.text=="function"&&typeof t.slice=="function"&&typeof t.arrayBuffer=="function",isUploadable=t=>isFileLike(t)||isResponseLike(t)||isFsReadStream(t);async function toFile(t,e,s){if(t=await t,isFileLike(t))return t;if(isResponseLike(t)){const r=await t.blob();e||(e=new URL(t.url).pathname.split(/[\\/]/).pop()??"unknown_file");const a=isBlobLike(r)?[await r.arrayBuffer()]:[r];return new File$1(a,e,s)}const n=await getBytes(t);if(e||(e=getName(t)??"unknown_file"),!s?.type){const r=n[0]?.type;typeof r=="string"&&(s={...s,type:r})}return new File$1(n,e,s)}async function getBytes(t){let e=[];if(typeof t=="string"||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)e.push(t);else if(isBlobLike(t))e.push(await t.arrayBuffer());else if(isAsyncIterableIterator(t))for await(const s of t)e.push(s);else throw new Error(`Unexpected data type: ${typeof t}; constructor: ${t?.constructor?.name}; props: ${propsForError(t)}`);return e}function propsForError(t){return`[${Object.getOwnPropertyNames(t).map(s=>`"${s}"`).join(", ")}]`}function getName(t){return getStringFromMaybeBuffer(t.name)||getStringFromMaybeBuffer(t.filename)||getStringFromMaybeBuffer(t.path)?.split(/[\\/]/).pop()}const getStringFromMaybeBuffer=t=>{if(typeof t=="string")return t;if(typeof Buffer<"u"&&t instanceof Buffer)return String(t)},isAsyncIterableIterator=t=>t!=null&&typeof t=="object"&&typeof t[Symbol.asyncIterator]=="function",isMultipartBody=t=>t&&typeof t=="object"&&t.body&&t[Symbol.toStringTag]==="MultipartBody",multipartFormRequestOptions=async t=>{const e=await createForm(t.body);return getMultipartRequestOptions(e,t)},createForm=async t=>{const e=new FormData$1;return await Promise.all(Object.entries(t||{}).map(([s,n])=>addFormValue(e,s,n))),e},addFormValue=async(t,e,s)=>{if(s!==void 0){if(s==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof s=="string"||typeof s=="number"||typeof s=="boolean")t.append(e,String(s));else if(isUploadable(s)){const n=await toFile(s);t.append(e,n)}else if(Array.isArray(s))await Promise.all(s.map(n=>addFormValue(t,e+"[]",n)));else if(typeof s=="object")await Promise.all(Object.entries(s).map(([n,r])=>addFormValue(t,`${e}[${n}]`,r)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${s} instead`)}};var __classPrivateFieldSet$4=function(t,e,s,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(t,s):r?r.value=s:e.set(t,s),s},__classPrivateFieldGet$5=function(t,e,s,n){if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?n:s==="a"?n.call(t):n?n.value:e.get(t)},_AbstractPage_client;init();async function defaultParseResponse(t){const{response:e}=t;if(t.options.stream)return debug("response",e.status,e.url,e.headers,e.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(e,t.controller):Stream.fromSSEResponse(e,t.controller);if(e.status===204)return null;if(t.options.__binaryResponse)return e;const n=e.headers.get("content-type")?.split(";")[0]?.trim();if(n?.includes("application/json")||n?.endsWith("+json")){const i=await e.json();return debug("response",e.status,e.url,e.headers,i),_addRequestID(i,e)}const a=await e.text();return debug("response",e.status,e.url,e.headers,a),a}function _addRequestID(t,e){return!t||typeof t!="object"||Array.isArray(t)?t:Object.defineProperty(t,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}class APIPromise extends Promise{constructor(e,s=defaultParseResponse){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=s}_thenUnwrap(e){return new APIPromise(this.responsePromise,async s=>_addRequestID(e(await this.parseResponse(s),s),s.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,s]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:s,request_id:s.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,s){return this.parse().then(e,s)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class APIClient{constructor({baseURL:e,maxRetries:s=2,timeout:n=6e5,httpAgent:r,fetch:a}){this.baseURL=e,this.maxRetries=validatePositiveInteger("maxRetries",s),this.timeout=validatePositiveInteger("timeout",n),this.httpAgent=r,this.fetch=a??fetch$1}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...getPlatformHeaders(),...this.authHeaders(e)}}validateHeaders(e,s){}defaultIdempotencyKey(){return`stainless-node-retry-${uuid4()}`}get(e,s){return this.methodRequest("get",e,s)}post(e,s){return this.methodRequest("post",e,s)}patch(e,s){return this.methodRequest("patch",e,s)}put(e,s){return this.methodRequest("put",e,s)}delete(e,s){return this.methodRequest("delete",e,s)}methodRequest(e,s,n){return this.request(Promise.resolve(n).then(async r=>{const a=r&&isBlobLike(r?.body)?new DataView(await r.body.arrayBuffer()):r?.body instanceof DataView?r.body:r?.body instanceof ArrayBuffer?new DataView(r.body):r&&ArrayBuffer.isView(r?.body)?new DataView(r.body.buffer):r?.body;return{method:e,path:s,...r,body:a}}))}getAPIList(e,s,n){return this.requestAPIList(s,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:s=0}={}){const n={...e},{method:r,path:a,query:i,headers:u={}}=n,f=ArrayBuffer.isView(n.body)||n.__binaryRequest&&typeof n.body=="string"?n.body:isMultipartBody(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,c=this.calculateContentLength(f),d=this.buildURL(a,i);"timeout"in n&&validatePositiveInteger("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const h=n.httpAgent??this.httpAgent??getDefaultAgent(d),m=n.timeout+1e3;typeof h?.options?.timeout=="number"&&m>(h.options.timeout??0)&&(h.options.timeout=m),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),u[this.idempotencyHeader]=e.idempotencyKey);const _=this.buildHeaders({options:n,headers:u,contentLength:c,retryCount:s});return{req:{method:r,...f&&{body:f},headers:_,...h&&{agent:h},signal:n.signal??null},url:d,timeout:n.timeout}}buildHeaders({options:e,headers:s,contentLength:n,retryCount:r}){const a={};n&&(a["content-length"]=n);const i=this.defaultHeaders(e);return applyHeadersMut(a,i),applyHeadersMut(a,s),isMultipartBody(e.body)&&kind!=="node"&&delete a["content-type"],getHeader(i,"x-stainless-retry-count")===void 0&&getHeader(s,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(r)),getHeader(i,"x-stainless-timeout")===void 0&&getHeader(s,"x-stainless-timeout")===void 0&&e.timeout&&(a["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(a,s),a}async prepareOptions(e){}async prepareRequest(e,{url:s,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(s=>[...s])):{...e}:{}}makeStatusError(e,s,n,r){return APIError.generate(e,s,n,r)}request(e,s=null){return new APIPromise(this.makeRequest(e,s))}async makeRequest(e,s){const n=await e,r=n.maxRetries??this.maxRetries;s==null&&(s=r),await this.prepareOptions(n);const{req:a,url:i,timeout:u}=this.buildRequest(n,{retryCount:r-s});if(await this.prepareRequest(a,{url:i,options:n}),debug("request",i,n,a.headers),n.signal?.aborted)throw new APIUserAbortError;const f=new AbortController,c=await this.fetchWithTimeout(i,a,u,f).catch(castToError);if(c instanceof Error){if(n.signal?.aborted)throw new APIUserAbortError;if(s)return this.retryRequest(n,s);throw c.name==="AbortError"?new APIConnectionTimeoutError:new APIConnectionError({cause:c})}const d=createResponseHeaders(c.headers);if(!c.ok){if(s&&this.shouldRetry(c)){const A=`retrying, ${s} attempts remaining`;return debug(`response (error; ${A})`,c.status,i,d),this.retryRequest(n,s,d)}const h=await c.text().catch(A=>castToError(A).message),m=safeJSON(h),_=m?void 0:h;throw debug(`response (error; ${s?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,d,_),this.makeStatusError(c.status,m,_,d)}return{response:c,options:n,controller:f}}requestAPIList(e,s){const n=this.makeRequest(s,null);return new PagePromise(this,n,e)}buildURL(e,s){const n=isAbsoluteURL(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return isEmptyObj(r)||(s={...r,...s}),typeof s=="object"&&s&&!Array.isArray(s)&&(n.search=this.stringifyQuery(s)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([s,n])=>typeof n<"u").map(([s,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(s)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(s)}=`;throw new OpenAIError(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,s,n,r){const{signal:a,...i}=s||{};a&&a.addEventListener("abort",()=>r.abort());const u=setTimeout(()=>r.abort(),n),f={signal:r.signal,...i};return f.method&&(f.method=f.method.toUpperCase()),this.fetch.call(void 0,e,f).finally(()=>{clearTimeout(u)})}shouldRetry(e){const s=e.headers.get("x-should-retry");return s==="true"?!0:s==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,s,n){let r;const a=n?.["retry-after-ms"];if(a){const u=parseFloat(a);Number.isNaN(u)||(r=u)}const i=n?.["retry-after"];if(i&&!r){const u=parseFloat(i);Number.isNaN(u)?r=Date.parse(i)-Date.now():r=u*1e3}if(!(r&&0<=r&&r<6e4)){const u=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(s,u)}return await sleep(r),this.makeRequest(e,s-1)}calculateDefaultRetryTimeoutMillis(e,s){const a=s-e,i=Math.min(.5*Math.pow(2,a),8),u=1-Math.random()*.25;return i*u*1e3}getUserAgent(){return`${this.constructor.name}/JS ${VERSION}`}}class AbstractPage{constructor(e,s,n,r){_AbstractPage_client.set(this,void 0),__classPrivateFieldSet$4(this,_AbstractPage_client,e,"f"),this.options=r,this.response=s,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new OpenAIError("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const s={...this.options};if("params"in e&&typeof s.query=="object")s.query={...s.query,...e.params};else if("url"in e){const n=[...Object.entries(s.query||{}),...e.url.searchParams.entries()];for(const[r,a]of n)e.url.searchParams.set(r,a);s.query=void 0,s.path=e.url.toString()}return await __classPrivateFieldGet$5(this,_AbstractPage_client,"f").requestAPIList(this.constructor,s)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(_AbstractPage_client=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const s of e.getPaginatedItems())yield s}}class PagePromise extends APIPromise{constructor(e,s,n){super(s,async r=>new n(e,r.response,await defaultParseResponse(r),r.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const s of e)yield s}}const createResponseHeaders=t=>new Proxy(Object.fromEntries(t.entries()),{get(e,s){const n=s.toString();return e[n.toLowerCase()]||e[n]}}),requestOptionsKeys={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},isRequestOptions=t=>typeof t=="object"&&t!==null&&!isEmptyObj(t)&&Object.keys(t).every(e=>hasOwn(requestOptionsKeys,e)),getPlatformProperties=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":VERSION,"X-Stainless-OS":normalizePlatform(Deno.build.os),"X-Stainless-Arch":normalizeArch(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":VERSION,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":VERSION,"X-Stainless-OS":normalizePlatform(process.platform),"X-Stainless-Arch":normalizeArch(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const t=getBrowserInfo();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":VERSION,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":VERSION,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function getBrowserInfo(){if(typeof navigator>"u"||!navigator)return null;const t=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:s}of t){const n=s.exec(navigator.userAgent);if(n){const r=n[1]||0,a=n[2]||0,i=n[3]||0;return{browser:e,version:`${r}.${a}.${i}`}}}return null}const normalizeArch=t=>t==="x32"?"x32":t==="x86_64"||t==="x64"?"x64":t==="arm"?"arm":t==="aarch64"||t==="arm64"?"arm64":t?`other:${t}`:"unknown",normalizePlatform=t=>(t=t.toLowerCase(),t.includes("ios")?"iOS":t==="android"?"Android":t==="darwin"?"MacOS":t==="win32"?"Windows":t==="freebsd"?"FreeBSD":t==="openbsd"?"OpenBSD":t==="linux"?"Linux":t?`Other:${t}`:"Unknown");let _platformHeaders;const getPlatformHeaders=()=>_platformHeaders??(_platformHeaders=getPlatformProperties()),safeJSON=t=>{try{return JSON.parse(t)}catch{return}},startsWithSchemeRegexp=/^[a-z][a-z0-9+.-]*:/i,isAbsoluteURL=t=>startsWithSchemeRegexp.test(t),sleep=t=>new Promise(e=>setTimeout(e,t)),validatePositiveInteger=(t,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new OpenAIError(`${t} must be an integer`);if(e<0)throw new OpenAIError(`${t} must be a positive integer`);return e},castToError=t=>{if(t instanceof Error)return t;if(typeof t=="object"&&t!==null)try{return new Error(JSON.stringify(t))}catch{}return new Error(t)},readEnv=t=>{if(typeof process<"u")return process.env?.[t]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(t)?.trim()};function isEmptyObj(t){if(!t)return!0;for(const e in t)return!1;return!0}function hasOwn(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function applyHeadersMut(t,e){for(const s in e){if(!hasOwn(e,s))continue;const n=s.toLowerCase();if(!n)continue;const r=e[s];r===null?delete t[n]:r!==void 0&&(t[n]=r)}}const SENSITIVE_HEADERS=new Set(["authorization","api-key"]);function debug(t,...e){if(typeof process<"u"&&process?.env?.DEBUG==="true"){const s=e.map(n=>{if(!n)return n;if(n.headers){const a={...n,headers:{...n.headers}};for(const i in n.headers)SENSITIVE_HEADERS.has(i.toLowerCase())&&(a.headers[i]="REDACTED");return a}let r=null;for(const a in n)SENSITIVE_HEADERS.has(a.toLowerCase())&&(r??(r={...n}),r[a]="REDACTED");return r??n});console.log(`OpenAI:DEBUG:${t}`,...s)}}const uuid4=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)}),isRunningInBrowser=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",isHeadersProtocol=t=>typeof t?.get=="function",getHeader=(t,e)=>{const s=e.toLowerCase();if(isHeadersProtocol(t)){const n=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(r,a,i)=>a+i.toUpperCase());for(const r of[e,s,e.toUpperCase(),n]){const a=t.get(r);if(a)return a}}for(const[n,r]of Object.entries(t))if(n.toLowerCase()===s)return Array.isArray(r)?(r.length<=1||console.warn(`Received ${r.length} entries for the ${e} header, using the first entry.`),r[0]):r},toFloat32Array=t=>{if(typeof Buffer<"u"){const e=Buffer.from(t,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(t),s=e.length,n=new Uint8Array(s);for(let r=0;r<s;r++)n[r]=e.charCodeAt(r);return Array.from(new Float32Array(n.buffer))}};function isObj(t){return t!=null&&typeof t=="object"&&!Array.isArray(t)}class Page extends AbstractPage{constructor(e,s,n,r){super(e,s,n,r),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class CursorPage extends AbstractPage{constructor(e,s,n,r){super(e,s,n,r),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const s=Object.fromEntries(e.url.searchParams);return Object.keys(s).length?s:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const s=e[e.length-1]?.id;return s?{params:{after:s}}:null}}class APIResource{constructor(e){this._client=e}}let Messages$1=class extends APIResource{list(e,s={},n){return isRequestOptions(s)?this.list(e,{},s):this._client.getAPIList(`/chat/completions/${e}/messages`,ChatCompletionStoreMessagesPage,{query:s,...n})}},Completions$2=class extends APIResource{constructor(){super(...arguments),this.messages=new Messages$1(this._client)}create(e,s){return this._client.post("/chat/completions",{body:e,...s,stream:e.stream??!1})}retrieve(e,s){return this._client.get(`/chat/completions/${e}`,s)}update(e,s,n){return this._client.post(`/chat/completions/${e}`,{body:s,...n})}list(e={},s){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/chat/completions",ChatCompletionsPage,{query:e,...s})}del(e,s){return this._client.delete(`/chat/completions/${e}`,s)}};class ChatCompletionsPage extends CursorPage{}class ChatCompletionStoreMessagesPage extends CursorPage{}Completions$2.ChatCompletionsPage=ChatCompletionsPage,Completions$2.Messages=Messages$1;let Chat$1=class extends APIResource{constructor(){super(...arguments),this.completions=new Completions$2(this._client)}};Chat$1.Completions=Completions$2,Chat$1.ChatCompletionsPage=ChatCompletionsPage;class Speech extends APIResource{create(e,s){return this._client.post("/audio/speech",{body:e,...s,headers:{Accept:"application/octet-stream",...s?.headers},__binaryResponse:!0})}}class Transcriptions extends APIResource{create(e,s){return this._client.post("/audio/transcriptions",multipartFormRequestOptions({body:e,...s,stream:e.stream??!1,__metadata:{model:e.model}}))}}class Translations extends APIResource{create(e,s){return this._client.post("/audio/translations",multipartFormRequestOptions({body:e,...s,__metadata:{model:e.model}}))}}class Audio extends APIResource{constructor(){super(...arguments),this.transcriptions=new Transcriptions(this._client),this.translations=new Translations(this._client),this.speech=new Speech(this._client)}}Audio.Transcriptions=Transcriptions,Audio.Translations=Translations,Audio.Speech=Speech;class Batches extends APIResource{create(e,s){return this._client.post("/batches",{body:e,...s})}retrieve(e,s){return this._client.get(`/batches/${e}`,s)}list(e={},s){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/batches",BatchesPage,{query:e,...s})}cancel(e,s){return this._client.post(`/batches/${e}/cancel`,s)}}class BatchesPage extends CursorPage{}Batches.BatchesPage=BatchesPage;class Assistants extends APIResource{create(e,s){return this._client.post("/assistants",{body:e,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}retrieve(e,s){return this._client.get(`/assistants/${e}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}update(e,s,n){return this._client.post(`/assistants/${e}`,{body:s,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},s){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/assistants",AssistantsPage,{query:e,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}del(e,s){return this._client.delete(`/assistants/${e}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}}class AssistantsPage extends CursorPage{}Assistants.AssistantsPage=AssistantsPage;function isRunnableFunctionWithParse(t){return typeof t.parse=="function"}const isAssistantMessage=t=>t?.role==="assistant",isFunctionMessage=t=>t?.role==="function",isToolMessage=t=>t?.role==="tool";var __classPrivateFieldSet$3=function(t,e,s,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(t,s):r?r.value=s:e.set(t,s),s},__classPrivateFieldGet$4=function(t,e,s,n){if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?n:s==="a"?n.call(t):n?n.value:e.get(t)},_EventStream_instances,_EventStream_connectedPromise,_EventStream_resolveConnectedPromise,_EventStream_rejectConnectedPromise,_EventStream_endPromise,_EventStream_resolveEndPromise,_EventStream_rejectEndPromise,_EventStream_listeners,_EventStream_ended,_EventStream_errored,_EventStream_aborted,_EventStream_catchingPromiseCreated,_EventStream_handleError;class EventStream{constructor(){_EventStream_instances.add(this),this.controller=new AbortController,_EventStream_connectedPromise.set(this,void 0),_EventStream_resolveConnectedPromise.set(this,()=>{}),_EventStream_rejectConnectedPromise.set(this,()=>{}),_EventStream_endPromise.set(this,void 0),_EventStream_resolveEndPromise.set(this,()=>{}),_EventStream_rejectEndPromise.set(this,()=>{}),_EventStream_listeners.set(this,{}),_EventStream_ended.set(this,!1),_EventStream_errored.set(this,!1),_EventStream_aborted.set(this,!1),_EventStream_catchingPromiseCreated.set(this,!1),__classPrivateFieldSet$3(this,_EventStream_connectedPromise,new Promise((e,s)=>{__classPrivateFieldSet$3(this,_EventStream_resolveConnectedPromise,e,"f"),__classPrivateFieldSet$3(this,_EventStream_rejectConnectedPromise,s,"f")}),"f"),__classPrivateFieldSet$3(this,_EventStream_endPromise,new Promise((e,s)=>{__classPrivateFieldSet$3(this,_EventStream_resolveEndPromise,e,"f"),__classPrivateFieldSet$3(this,_EventStream_rejectEndPromise,s,"f")}),"f"),__classPrivateFieldGet$4(this,_EventStream_connectedPromise,"f").catch(()=>{}),__classPrivateFieldGet$4(this,_EventStream_endPromise,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},__classPrivateFieldGet$4(this,_EventStream_instances,"m",_EventStream_handleError).bind(this))},0)}_connected(){this.ended||(__classPrivateFieldGet$4(this,_EventStream_resolveConnectedPromise,"f").call(this),this._emit("connect"))}get ended(){return __classPrivateFieldGet$4(this,_EventStream_ended,"f")}get errored(){return __classPrivateFieldGet$4(this,_EventStream_errored,"f")}get aborted(){return __classPrivateFieldGet$4(this,_EventStream_aborted,"f")}abort(){this.controller.abort()}on(e,s){return(__classPrivateFieldGet$4(this,_EventStream_listeners,"f")[e]||(__classPrivateFieldGet$4(this,_EventStream_listeners,"f")[e]=[])).push({listener:s}),this}off(e,s){const n=__classPrivateFieldGet$4(this,_EventStream_listeners,"f")[e];if(!n)return this;const r=n.findIndex(a=>a.listener===s);return r>=0&&n.splice(r,1),this}once(e,s){return(__classPrivateFieldGet$4(this,_EventStream_listeners,"f")[e]||(__classPrivateFieldGet$4(this,_EventStream_listeners,"f")[e]=[])).push({listener:s,once:!0}),this}emitted(e){return new Promise((s,n)=>{__classPrivateFieldSet$3(this,_EventStream_catchingPromiseCreated,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,s)})}async done(){__classPrivateFieldSet$3(this,_EventStream_catchingPromiseCreated,!0,"f"),await __classPrivateFieldGet$4(this,_EventStream_endPromise,"f")}_emit(e,...s){if(__classPrivateFieldGet$4(this,_EventStream_ended,"f"))return;e==="end"&&(__classPrivateFieldSet$3(this,_EventStream_ended,!0,"f"),__classPrivateFieldGet$4(this,_EventStream_resolveEndPromise,"f").call(this));const n=__classPrivateFieldGet$4(this,_EventStream_listeners,"f")[e];if(n&&(__classPrivateFieldGet$4(this,_EventStream_listeners,"f")[e]=n.filter(r=>!r.once),n.forEach(({listener:r})=>r(...s))),e==="abort"){const r=s[0];!__classPrivateFieldGet$4(this,_EventStream_catchingPromiseCreated,"f")&&!n?.length&&Promise.reject(r),__classPrivateFieldGet$4(this,_EventStream_rejectConnectedPromise,"f").call(this,r),__classPrivateFieldGet$4(this,_EventStream_rejectEndPromise,"f").call(this,r),this._emit("end");return}if(e==="error"){const r=s[0];!__classPrivateFieldGet$4(this,_EventStream_catchingPromiseCreated,"f")&&!n?.length&&Promise.reject(r),__classPrivateFieldGet$4(this,_EventStream_rejectConnectedPromise,"f").call(this,r),__classPrivateFieldGet$4(this,_EventStream_rejectEndPromise,"f").call(this,r),this._emit("end")}}_emitFinal(){}}_EventStream_connectedPromise=new WeakMap,_EventStream_resolveConnectedPromise=new WeakMap,_EventStream_rejectConnectedPromise=new WeakMap,_EventStream_endPromise=new WeakMap,_EventStream_resolveEndPromise=new WeakMap,_EventStream_rejectEndPromise=new WeakMap,_EventStream_listeners=new WeakMap,_EventStream_ended=new WeakMap,_EventStream_errored=new WeakMap,_EventStream_aborted=new WeakMap,_EventStream_catchingPromiseCreated=new WeakMap,_EventStream_instances=new WeakSet,_EventStream_handleError=function t(e){if(__classPrivateFieldSet$3(this,_EventStream_errored,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new APIUserAbortError),e instanceof APIUserAbortError)return __classPrivateFieldSet$3(this,_EventStream_aborted,!0,"f"),this._emit("abort",e);if(e instanceof OpenAIError)return this._emit("error",e);if(e instanceof Error){const s=new OpenAIError(e.message);return s.cause=e,this._emit("error",s)}return this._emit("error",new OpenAIError(String(e)))};function isAutoParsableResponseFormat(t){return t?.$brand==="auto-parseable-response-format"}function isAutoParsableTool$1(t){return t?.$brand==="auto-parseable-tool"}function maybeParseChatCompletion(t,e){return!e||!hasAutoParseableInput$1(e)?{...t,choices:t.choices.map(s=>({...s,message:{...s.message,parsed:null,...s.message.tool_calls?{tool_calls:s.message.tool_calls}:void 0}}))}:parseChatCompletion(t,e)}function parseChatCompletion(t,e){const s=t.choices.map(n=>{if(n.finish_reason==="length")throw new LengthFinishReasonError;if(n.finish_reason==="content_filter")throw new ContentFilterFinishReasonError;return{...n,message:{...n.message,...n.message.tool_calls?{tool_calls:n.message.tool_calls?.map(r=>parseToolCall$1(e,r))??void 0}:void 0,parsed:n.message.content&&!n.message.refusal?parseResponseFormat(e,n.message.content):null}}});return{...t,choices:s}}function parseResponseFormat(t,e){return t.response_format?.type!=="json_schema"?null:t.response_format?.type==="json_schema"?"$parseRaw"in t.response_format?t.response_format.$parseRaw(e):JSON.parse(e):null}function parseToolCall$1(t,e){const s=t.tools?.find(n=>n.function?.name===e.function.name);return{...e,function:{...e.function,parsed_arguments:isAutoParsableTool$1(s)?s.$parseRaw(e.function.arguments):s?.function.strict?JSON.parse(e.function.arguments):null}}}function shouldParseToolCall(t,e){if(!t)return!1;const s=t.tools?.find(n=>n.function?.name===e.function.name);return isAutoParsableTool$1(s)||s?.function.strict||!1}function hasAutoParseableInput$1(t){return isAutoParsableResponseFormat(t.response_format)?!0:t.tools?.some(e=>isAutoParsableTool$1(e)||e.type==="function"&&e.function.strict===!0)??!1}function validateInputTools(t){for(const e of t??[]){if(e.type!=="function")throw new OpenAIError(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new OpenAIError(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var __classPrivateFieldGet$3=function(t,e,s,n){if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?n:s==="a"?n.call(t):n?n.value:e.get(t)},_AbstractChatCompletionRunner_instances,_AbstractChatCompletionRunner_getFinalContent,_AbstractChatCompletionRunner_getFinalMessage,_AbstractChatCompletionRunner_getFinalFunctionCall,_AbstractChatCompletionRunner_getFinalFunctionCallResult,_AbstractChatCompletionRunner_calculateTotalUsage,_AbstractChatCompletionRunner_validateParams,_AbstractChatCompletionRunner_stringifyFunctionCallResult;const DEFAULT_MAX_CHAT_COMPLETIONS=10;class AbstractChatCompletionRunner extends EventStream{constructor(){super(...arguments),_AbstractChatCompletionRunner_instances.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const s=e.choices[0]?.message;return s&&this._addMessage(s),e}_addMessage(e,s=!0){if("content"in e||(e.content=null),this.messages.push(e),s){if(this._emit("message",e),(isFunctionMessage(e)||isToolMessage(e))&&e.content)this._emit("functionCallResult",e.content);else if(isAssistantMessage(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(isAssistantMessage(e)&&e.tool_calls)for(const n of e.tool_calls)n.type==="function"&&this._emit("functionCall",n.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new OpenAIError("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_getFinalContent).call(this)}async finalMessage(){return await this.done(),__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_getFinalMessage).call(this)}async finalFunctionCall(){return await this.done(),__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_getFinalFunctionCall).call(this)}async finalFunctionCallResult(){return await this.done(),__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_getFinalFunctionCallResult).call(this)}async totalUsage(){return await this.done(),__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_calculateTotalUsage).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const s=__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_getFinalMessage).call(this);s&&this._emit("finalMessage",s);const n=__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_getFinalContent).call(this);n&&this._emit("finalContent",n);const r=__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_getFinalFunctionCall).call(this);r&&this._emit("finalFunctionCall",r);const a=__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_getFinalFunctionCallResult).call(this);a!=null&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_calculateTotalUsage).call(this))}async _createChatCompletion(e,s,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_validateParams).call(this,s);const a=await e.chat.completions.create({...s,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(parseChatCompletion(a,s))}async _runChatCompletion(e,s,n){for(const r of s.messages)this._addMessage(r,!1);return await this._createChatCompletion(e,s,n)}async _runFunctions(e,s,n){const r="function",{function_call:a="auto",stream:i,...u}=s,f=typeof a!="string"&&a?.name,{maxChatCompletions:c=DEFAULT_MAX_CHAT_COMPLETIONS}=n||{},d={};for(const m of s.functions)d[m.name||m.function.name]=m;const h=s.functions.map(m=>({name:m.name||m.function.name,parameters:m.parameters,description:m.description}));for(const m of s.messages)this._addMessage(m,!1);for(let m=0;m<c;++m){const p=(await this._createChatCompletion(e,{...u,function_call:a,functions:h,messages:[...this.messages]},n)).choices[0]?.message;if(!p)throw new OpenAIError("missing message in ChatCompletion response");if(!p.function_call)return;const{name:b,arguments:A}=p.function_call,T=d[b];if(T){if(f&&f!==b){const y=`Invalid function_call: ${JSON.stringify(b)}. ${JSON.stringify(f)} requested. Please try again`;this._addMessage({role:r,name:b,content:y});continue}}else{const y=`Invalid function_call: ${JSON.stringify(b)}. Available options are: ${h.map(S=>JSON.stringify(S.name)).join(", ")}. Please try again`;this._addMessage({role:r,name:b,content:y});continue}let v;try{v=isRunnableFunctionWithParse(T)?await T.parse(A):A}catch(y){this._addMessage({role:r,name:b,content:y instanceof Error?y.message:String(y)});continue}const N=await T.function(v,this),x=__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_stringifyFunctionCallResult).call(this,N);if(this._addMessage({role:r,name:b,content:x}),f)return}}async _runTools(e,s,n){const r="tool",{tool_choice:a="auto",stream:i,...u}=s,f=typeof a!="string"&&a?.function?.name,{maxChatCompletions:c=DEFAULT_MAX_CHAT_COMPLETIONS}=n||{},d=s.tools.map(_=>{if(isAutoParsableTool$1(_)){if(!_.$callback)throw new OpenAIError("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:_.$callback,name:_.function.name,description:_.function.description||"",parameters:_.function.parameters,parse:_.$parseRaw,strict:!0}}}return _}),h={};for(const _ of d)_.type==="function"&&(h[_.function.name||_.function.function.name]=_.function);const m="tools"in s?d.map(_=>_.type==="function"?{type:"function",function:{name:_.function.name||_.function.function.name,parameters:_.function.parameters,description:_.function.description,strict:_.function.strict}}:_):void 0;for(const _ of s.messages)this._addMessage(_,!1);for(let _=0;_<c;++_){const b=(await this._createChatCompletion(e,{...u,tool_choice:a,tools:m,messages:[...this.messages]},n)).choices[0]?.message;if(!b)throw new OpenAIError("missing message in ChatCompletion response");if(!b.tool_calls?.length)return;for(const A of b.tool_calls){if(A.type!=="function")continue;const T=A.id,{name:v,arguments:N}=A.function,x=h[v];if(x){if(f&&f!==v){const F=`Invalid tool_call: ${JSON.stringify(v)}. ${JSON.stringify(f)} requested. Please try again`;this._addMessage({role:r,tool_call_id:T,content:F});continue}}else{const F=`Invalid tool_call: ${JSON.stringify(v)}. Available options are: ${Object.keys(h).map(B=>JSON.stringify(B)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:T,content:F});continue}let y;try{y=isRunnableFunctionWithParse(x)?await x.parse(N):N}catch(F){const B=F instanceof Error?F.message:String(F);this._addMessage({role:r,tool_call_id:T,content:B});continue}const S=await x.function(y,this),D=__classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_stringifyFunctionCallResult).call(this,S);if(this._addMessage({role:r,tool_call_id:T,content:D}),f)return}}}}_AbstractChatCompletionRunner_instances=new WeakSet,_AbstractChatCompletionRunner_getFinalContent=function t(){return __classPrivateFieldGet$3(this,_AbstractChatCompletionRunner_instances,"m",_AbstractChatCompletionRunner_getFinalMessage).call(this).content??null},_AbstractChatCompletionRunner_getFinalMessage=function t(){let e=this.messages.length;for(;e-- >0;){const s=this.messages[e];if(isAssistantMessage(s)){const{function_call:n,...r}=s,a={...r,content:s.content??null,refusal:s.refusal??null};return n&&(a.function_call=n),a}}throw new OpenAIError("stream ended without producing a ChatCompletionMessage with role=assistant")},_AbstractChatCompletionRunner_getFinalFunctionCall=function t(){for(let e=this.messages.length-1;e>=0;e--){const s=this.messages[e];if(isAssistantMessage(s)&&s?.function_call)return s.function_call;if(isAssistantMessage(s)&&s?.tool_calls?.length)return s.tool_calls.at(-1)?.function}},_AbstractChatCompletionRunner_getFinalFunctionCallResult=function t(){for(let e=this.messages.length-1;e>=0;e--){const s=this.messages[e];if(isFunctionMessage(s)&&s.content!=null||isToolMessage(s)&&s.content!=null&&typeof s.content=="string"&&this.messages.some(n=>n.role==="assistant"&&n.tool_calls?.some(r=>r.type==="function"&&r.id===s.tool_call_id)))return s.content}},_AbstractChatCompletionRunner_calculateTotalUsage=function t(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:s}of this._chatCompletions)s&&(e.completion_tokens+=s.completion_tokens,e.prompt_tokens+=s.prompt_tokens,e.total_tokens+=s.total_tokens);return e},_AbstractChatCompletionRunner_validateParams=function t(e){if(e.n!=null&&e.n>1)throw new OpenAIError("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},_AbstractChatCompletionRunner_stringifyFunctionCallResult=function t(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class ChatCompletionRunner extends AbstractChatCompletionRunner{static runFunctions(e,s,n){const r=new ChatCompletionRunner,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run(()=>r._runFunctions(e,s,a)),r}static runTools(e,s,n){const r=new ChatCompletionRunner,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,s,a)),r}_addMessage(e,s=!0){super._addMessage(e,s),isAssistantMessage(e)&&e.content&&this._emit("content",e.content)}}const STR=1,NUM=2,ARR=4,OBJ=8,NULL=16,BOOL=32,NAN=64,INFINITY=128,MINUS_INFINITY=256,INF=INFINITY|MINUS_INFINITY,SPECIAL=NULL|BOOL|INF|NAN,ATOM=STR|NUM|SPECIAL,COLLECTION=ARR|OBJ,ALL=ATOM|COLLECTION,Allow={STR,NUM,ARR,OBJ,NULL,BOOL,NAN,INFINITY,MINUS_INFINITY,INF,SPECIAL,ATOM,COLLECTION,ALL};class PartialJSON extends Error{}class MalformedJSON extends Error{}function parseJSON(t,e=Allow.ALL){if(typeof t!="string")throw new TypeError(`expecting str, got ${typeof t}`);if(!t.trim())throw new Error(`${t} is empty`);return _parseJSON(t.trim(),e)}const _parseJSON=(t,e)=>{const s=t.length;let n=0;const r=m=>{throw new PartialJSON(`${m} at position ${n}`)},a=m=>{throw new MalformedJSON(`${m} at position ${n}`)},i=()=>(h(),n>=s&&r("Unexpected end of input"),t[n]==='"'?u():t[n]==="{"?f():t[n]==="["?c():t.substring(n,n+4)==="null"||Allow.NULL&e&&s-n<4&&"null".startsWith(t.substring(n))?(n+=4,null):t.substring(n,n+4)==="true"||Allow.BOOL&e&&s-n<4&&"true".startsWith(t.substring(n))?(n+=4,!0):t.substring(n,n+5)==="false"||Allow.BOOL&e&&s-n<5&&"false".startsWith(t.substring(n))?(n+=5,!1):t.substring(n,n+8)==="Infinity"||Allow.INFINITY&e&&s-n<8&&"Infinity".startsWith(t.substring(n))?(n+=8,1/0):t.substring(n,n+9)==="-Infinity"||Allow.MINUS_INFINITY&e&&1<s-n&&s-n<9&&"-Infinity".startsWith(t.substring(n))?(n+=9,-1/0):t.substring(n,n+3)==="NaN"||Allow.NAN&e&&s-n<3&&"NaN".startsWith(t.substring(n))?(n+=3,NaN):d()),u=()=>{const m=n;let _=!1;for(n++;n<s&&(t[n]!=='"'||_&&t[n-1]==="\\");)_=t[n]==="\\"?!_:!1,n++;if(t.charAt(n)=='"')try{return JSON.parse(t.substring(m,++n-Number(_)))}catch(p){a(String(p))}else if(Allow.STR&e)try{return JSON.parse(t.substring(m,n-Number(_))+'"')}catch{return JSON.parse(t.substring(m,t.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},f=()=>{n++,h();const m={};try{for(;t[n]!=="}";){if(h(),n>=s&&Allow.OBJ&e)return m;const _=u();h(),n++;try{const p=i();Object.defineProperty(m,_,{value:p,writable:!0,enumerable:!0,configurable:!0})}catch(p){if(Allow.OBJ&e)return m;throw p}h(),t[n]===","&&n++}}catch{if(Allow.OBJ&e)return m;r("Expected '}' at end of object")}return n++,m},c=()=>{n++;const m=[];try{for(;t[n]!=="]";)m.push(i()),h(),t[n]===","&&n++}catch{if(Allow.ARR&e)return m;r("Expected ']' at end of array")}return n++,m},d=()=>{if(n===0){t==="-"&&Allow.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(t)}catch(_){if(Allow.NUM&e)try{return t[t.length-1]==="."?JSON.parse(t.substring(0,t.lastIndexOf("."))):JSON.parse(t.substring(0,t.lastIndexOf("e")))}catch{}a(String(_))}}const m=n;for(t[n]==="-"&&n++;t[n]&&!",]}".includes(t[n]);)n++;n==s&&!(Allow.NUM&e)&&r("Unterminated number literal");try{return JSON.parse(t.substring(m,n))}catch{t.substring(m,n)==="-"&&Allow.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(t.substring(m,t.lastIndexOf("e")))}catch(p){a(String(p))}}},h=()=>{for(;n<s&&` 
\r	`.includes(t[n]);)n++};return i()},partialParse=t=>parseJSON(t,Allow.ALL^Allow.NUM);var __classPrivateFieldSet$2=function(t,e,s,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(t,s):r?r.value=s:e.set(t,s),s},__classPrivateFieldGet$2=function(t,e,s,n){if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?n:s==="a"?n.call(t):n?n.value:e.get(t)},_ChatCompletionStream_instances,_ChatCompletionStream_params,_ChatCompletionStream_choiceEventStates,_ChatCompletionStream_currentChatCompletionSnapshot,_ChatCompletionStream_beginRequest,_ChatCompletionStream_getChoiceEventState,_ChatCompletionStream_addChunk,_ChatCompletionStream_emitToolCallDoneEvent,_ChatCompletionStream_emitContentDoneEvents,_ChatCompletionStream_endRequest,_ChatCompletionStream_getAutoParseableResponseFormat,_ChatCompletionStream_accumulateChatCompletion;class ChatCompletionStream extends AbstractChatCompletionRunner{constructor(e){super(),_ChatCompletionStream_instances.add(this),_ChatCompletionStream_params.set(this,void 0),_ChatCompletionStream_choiceEventStates.set(this,void 0),_ChatCompletionStream_currentChatCompletionSnapshot.set(this,void 0),__classPrivateFieldSet$2(this,_ChatCompletionStream_params,e,"f"),__classPrivateFieldSet$2(this,_ChatCompletionStream_choiceEventStates,[],"f")}get currentChatCompletionSnapshot(){return __classPrivateFieldGet$2(this,_ChatCompletionStream_currentChatCompletionSnapshot,"f")}static fromReadableStream(e){const s=new ChatCompletionStream(null);return s._run(()=>s._fromReadableStream(e)),s}static createChatCompletion(e,s,n){const r=new ChatCompletionStream(s);return r._run(()=>r._runChatCompletion(e,{...s,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createChatCompletion(e,s,n){super._createChatCompletion;const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_beginRequest).call(this);const a=await e.chat.completions.create({...s,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const i of a)__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_addChunk).call(this,i);if(a.controller.signal?.aborted)throw new APIUserAbortError;return this._addChatCompletion(__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_endRequest).call(this))}async _fromReadableStream(e,s){const n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_beginRequest).call(this),this._connected();const r=Stream.fromReadableStream(e,this.controller);let a;for await(const i of r)a&&a!==i.id&&this._addChatCompletion(__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_endRequest).call(this)),__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_addChunk).call(this,i),a=i.id;if(r.controller.signal?.aborted)throw new APIUserAbortError;return this._addChatCompletion(__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_endRequest).call(this))}[(_ChatCompletionStream_params=new WeakMap,_ChatCompletionStream_choiceEventStates=new WeakMap,_ChatCompletionStream_currentChatCompletionSnapshot=new WeakMap,_ChatCompletionStream_instances=new WeakSet,_ChatCompletionStream_beginRequest=function(){this.ended||__classPrivateFieldSet$2(this,_ChatCompletionStream_currentChatCompletionSnapshot,void 0,"f")},_ChatCompletionStream_getChoiceEventState=function(s){let n=__classPrivateFieldGet$2(this,_ChatCompletionStream_choiceEventStates,"f")[s.index];return n||(n={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},__classPrivateFieldGet$2(this,_ChatCompletionStream_choiceEventStates,"f")[s.index]=n,n)},_ChatCompletionStream_addChunk=function(s){if(this.ended)return;const n=__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_accumulateChatCompletion).call(this,s);this._emit("chunk",s,n);for(const r of s.choices){const a=n.choices[r.index];r.delta.content!=null&&a.message?.role==="assistant"&&a.message?.content&&(this._emit("content",r.delta.content,a.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:a.message.content,parsed:a.message.parsed})),r.delta.refusal!=null&&a.message?.role==="assistant"&&a.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:a.message.refusal}),r.logprobs?.content!=null&&a.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:a.logprobs?.content??[]}),r.logprobs?.refusal!=null&&a.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:a.logprobs?.refusal??[]});const i=__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_getChoiceEventState).call(this,a);a.finish_reason&&(__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_emitContentDoneEvents).call(this,a),i.current_tool_call_index!=null&&__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_emitToolCallDoneEvent).call(this,a,i.current_tool_call_index));for(const u of r.delta.tool_calls??[])i.current_tool_call_index!==u.index&&(__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_emitContentDoneEvents).call(this,a),i.current_tool_call_index!=null&&__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_emitToolCallDoneEvent).call(this,a,i.current_tool_call_index)),i.current_tool_call_index=u.index;for(const u of r.delta.tool_calls??[]){const f=a.message.tool_calls?.[u.index];f?.type&&(f?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:f.function?.name,index:u.index,arguments:f.function.arguments,parsed_arguments:f.function.parsed_arguments,arguments_delta:u.function?.arguments??""}):(f?.type,void 0))}}},_ChatCompletionStream_emitToolCallDoneEvent=function(s,n){if(__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_getChoiceEventState).call(this,s).done_tool_calls.has(n))return;const a=s.message.tool_calls?.[n];if(!a)throw new Error("no tool call snapshot");if(!a.type)throw new Error("tool call snapshot missing `type`");if(a.type==="function"){const i=__classPrivateFieldGet$2(this,_ChatCompletionStream_params,"f")?.tools?.find(u=>u.type==="function"&&u.function.name===a.function.name);this._emit("tool_calls.function.arguments.done",{name:a.function.name,index:n,arguments:a.function.arguments,parsed_arguments:isAutoParsableTool$1(i)?i.$parseRaw(a.function.arguments):i?.function.strict?JSON.parse(a.function.arguments):null})}else a.type},_ChatCompletionStream_emitContentDoneEvents=function(s){const n=__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_getChoiceEventState).call(this,s);if(s.message.content&&!n.content_done){n.content_done=!0;const r=__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_getAutoParseableResponseFormat).call(this);this._emit("content.done",{content:s.message.content,parsed:r?r.$parseRaw(s.message.content):null})}s.message.refusal&&!n.refusal_done&&(n.refusal_done=!0,this._emit("refusal.done",{refusal:s.message.refusal})),s.logprobs?.content&&!n.logprobs_content_done&&(n.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:s.logprobs.content})),s.logprobs?.refusal&&!n.logprobs_refusal_done&&(n.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:s.logprobs.refusal}))},_ChatCompletionStream_endRequest=function(){if(this.ended)throw new OpenAIError("stream has ended, this shouldn't happen");const s=__classPrivateFieldGet$2(this,_ChatCompletionStream_currentChatCompletionSnapshot,"f");if(!s)throw new OpenAIError("request ended without sending any chunks");return __classPrivateFieldSet$2(this,_ChatCompletionStream_currentChatCompletionSnapshot,void 0,"f"),__classPrivateFieldSet$2(this,_ChatCompletionStream_choiceEventStates,[],"f"),finalizeChatCompletion(s,__classPrivateFieldGet$2(this,_ChatCompletionStream_params,"f"))},_ChatCompletionStream_getAutoParseableResponseFormat=function(){const s=__classPrivateFieldGet$2(this,_ChatCompletionStream_params,"f")?.response_format;return isAutoParsableResponseFormat(s)?s:null},_ChatCompletionStream_accumulateChatCompletion=function(s){var n,r,a,i;let u=__classPrivateFieldGet$2(this,_ChatCompletionStream_currentChatCompletionSnapshot,"f");const{choices:f,...c}=s;u?Object.assign(u,c):u=__classPrivateFieldSet$2(this,_ChatCompletionStream_currentChatCompletionSnapshot,{...c,choices:[]},"f");for(const{delta:d,finish_reason:h,index:m,logprobs:_=null,...p}of s.choices){let b=u.choices[m];if(b||(b=u.choices[m]={finish_reason:h,index:m,message:{},logprobs:_,...p}),_)if(!b.logprobs)b.logprobs=Object.assign({},_);else{const{content:S,refusal:D,...F}=_;Object.assign(b.logprobs,F),S&&((n=b.logprobs).content??(n.content=[]),b.logprobs.content.push(...S)),D&&((r=b.logprobs).refusal??(r.refusal=[]),b.logprobs.refusal.push(...D))}if(h&&(b.finish_reason=h,__classPrivateFieldGet$2(this,_ChatCompletionStream_params,"f")&&hasAutoParseableInput$1(__classPrivateFieldGet$2(this,_ChatCompletionStream_params,"f")))){if(h==="length")throw new LengthFinishReasonError;if(h==="content_filter")throw new ContentFilterFinishReasonError}if(Object.assign(b,p),!d)continue;const{content:A,refusal:T,function_call:v,role:N,tool_calls:x,...y}=d;if(Object.assign(b.message,y),T&&(b.message.refusal=(b.message.refusal||"")+T),N&&(b.message.role=N),v&&(b.message.function_call?(v.name&&(b.message.function_call.name=v.name),v.arguments&&((a=b.message.function_call).arguments??(a.arguments=""),b.message.function_call.arguments+=v.arguments)):b.message.function_call=v),A&&(b.message.content=(b.message.content||"")+A,!b.message.refusal&&__classPrivateFieldGet$2(this,_ChatCompletionStream_instances,"m",_ChatCompletionStream_getAutoParseableResponseFormat).call(this)&&(b.message.parsed=partialParse(b.message.content))),x){b.message.tool_calls||(b.message.tool_calls=[]);for(const{index:S,id:D,type:F,function:B,...W}of x){const z=(i=b.message.tool_calls)[S]??(i[S]={});Object.assign(z,W),D&&(z.id=D),F&&(z.type=F),B&&(z.function??(z.function={name:B.name??"",arguments:""})),B?.name&&(z.function.name=B.name),B?.arguments&&(z.function.arguments+=B.arguments,shouldParseToolCall(__classPrivateFieldGet$2(this,_ChatCompletionStream_params,"f"),z)&&(z.function.parsed_arguments=partialParse(z.function.arguments)))}}}return u},Symbol.asyncIterator)](){const e=[],s=[];let n=!1;return this.on("chunk",r=>{const a=s.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{n=!0;for(const r of s)r.resolve(void 0);s.length=0}),this.on("abort",r=>{n=!0;for(const a of s)a.reject(r);s.length=0}),this.on("error",r=>{n=!0;for(const a of s)a.reject(r);s.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((a,i)=>s.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Stream(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function finalizeChatCompletion(t,e){const{id:s,choices:n,created:r,model:a,system_fingerprint:i,...u}=t,f={...u,id:s,choices:n.map(({message:c,finish_reason:d,index:h,logprobs:m,..._})=>{if(!d)throw new OpenAIError(`missing finish_reason for choice ${h}`);const{content:p=null,function_call:b,tool_calls:A,...T}=c,v=c.role;if(!v)throw new OpenAIError(`missing role for choice ${h}`);if(b){const{arguments:N,name:x}=b;if(N==null)throw new OpenAIError(`missing function_call.arguments for choice ${h}`);if(!x)throw new OpenAIError(`missing function_call.name for choice ${h}`);return{..._,message:{content:p,function_call:{arguments:N,name:x},role:v,refusal:c.refusal??null},finish_reason:d,index:h,logprobs:m}}return A?{..._,index:h,finish_reason:d,logprobs:m,message:{...T,role:v,content:p,refusal:c.refusal??null,tool_calls:A.map((N,x)=>{const{function:y,type:S,id:D,...F}=N,{arguments:B,name:W,...z}=y||{};if(D==null)throw new OpenAIError(`missing choices[${h}].tool_calls[${x}].id
${str(t)}`);if(S==null)throw new OpenAIError(`missing choices[${h}].tool_calls[${x}].type
${str(t)}`);if(W==null)throw new OpenAIError(`missing choices[${h}].tool_calls[${x}].function.name
${str(t)}`);if(B==null)throw new OpenAIError(`missing choices[${h}].tool_calls[${x}].function.arguments
${str(t)}`);return{...F,id:D,type:S,function:{...z,name:W,arguments:B}}})}}:{..._,message:{...T,content:p,role:v,refusal:c.refusal??null},finish_reason:d,index:h,logprobs:m}}),created:r,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return maybeParseChatCompletion(f,e)}function str(t){return JSON.stringify(t)}function assertNever(t){}class ChatCompletionStreamingRunner extends ChatCompletionStream{static fromReadableStream(e){const s=new ChatCompletionStreamingRunner(null);return s._run(()=>s._fromReadableStream(e)),s}static runFunctions(e,s,n){const r=new ChatCompletionStreamingRunner(null),a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run(()=>r._runFunctions(e,s,a)),r}static runTools(e,s,n){const r=new ChatCompletionStreamingRunner(s),a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,s,a)),r}}let Completions$1=class extends APIResource{parse(e,s){return validateInputTools(e.tools),this._client.chat.completions.create(e,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(n=>parseChatCompletion(n,e))}runFunctions(e,s){return e.stream?ChatCompletionStreamingRunner.runFunctions(this._client,e,s):ChatCompletionRunner.runFunctions(this._client,e,s)}runTools(e,s){return e.stream?ChatCompletionStreamingRunner.runTools(this._client,e,s):ChatCompletionRunner.runTools(this._client,e,s)}stream(e,s){return ChatCompletionStream.createChatCompletion(this._client,e,s)}};class Chat extends APIResource{constructor(){super(...arguments),this.completions=new Completions$1(this._client)}}(function(t){t.Completions=Completions$1})(Chat||(Chat={}));class Sessions extends APIResource{create(e,s){return this._client.post("/realtime/sessions",{body:e,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}}class TranscriptionSessions extends APIResource{create(e,s){return this._client.post("/realtime/transcription_sessions",{body:e,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}}class Realtime extends APIResource{constructor(){super(...arguments),this.sessions=new Sessions(this._client),this.transcriptionSessions=new TranscriptionSessions(this._client)}}Realtime.Sessions=Sessions,Realtime.TranscriptionSessions=TranscriptionSessions;var __classPrivateFieldGet$1=function(t,e,s,n){if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?n:s==="a"?n.call(t):n?n.value:e.get(t)},__classPrivateFieldSet$1=function(t,e,s,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(t,s):r?r.value=s:e.set(t,s),s},_AssistantStream_instances,_AssistantStream_events,_AssistantStream_runStepSnapshots,_AssistantStream_messageSnapshots,_AssistantStream_messageSnapshot,_AssistantStream_finalRun,_AssistantStream_currentContentIndex,_AssistantStream_currentContent,_AssistantStream_currentToolCallIndex,_AssistantStream_currentToolCall,_AssistantStream_currentEvent,_AssistantStream_currentRunSnapshot,_AssistantStream_currentRunStepSnapshot,_AssistantStream_addEvent,_AssistantStream_endRequest,_AssistantStream_handleMessage,_AssistantStream_handleRunStep,_AssistantStream_handleEvent,_AssistantStream_accumulateRunStep,_AssistantStream_accumulateMessage,_AssistantStream_accumulateContent,_AssistantStream_handleRun;class AssistantStream extends EventStream{constructor(){super(...arguments),_AssistantStream_instances.add(this),_AssistantStream_events.set(this,[]),_AssistantStream_runStepSnapshots.set(this,{}),_AssistantStream_messageSnapshots.set(this,{}),_AssistantStream_messageSnapshot.set(this,void 0),_AssistantStream_finalRun.set(this,void 0),_AssistantStream_currentContentIndex.set(this,void 0),_AssistantStream_currentContent.set(this,void 0),_AssistantStream_currentToolCallIndex.set(this,void 0),_AssistantStream_currentToolCall.set(this,void 0),_AssistantStream_currentEvent.set(this,void 0),_AssistantStream_currentRunSnapshot.set(this,void 0),_AssistantStream_currentRunStepSnapshot.set(this,void 0)}[(_AssistantStream_events=new WeakMap,_AssistantStream_runStepSnapshots=new WeakMap,_AssistantStream_messageSnapshots=new WeakMap,_AssistantStream_messageSnapshot=new WeakMap,_AssistantStream_finalRun=new WeakMap,_AssistantStream_currentContentIndex=new WeakMap,_AssistantStream_currentContent=new WeakMap,_AssistantStream_currentToolCallIndex=new WeakMap,_AssistantStream_currentToolCall=new WeakMap,_AssistantStream_currentEvent=new WeakMap,_AssistantStream_currentRunSnapshot=new WeakMap,_AssistantStream_currentRunStepSnapshot=new WeakMap,_AssistantStream_instances=new WeakSet,Symbol.asyncIterator)](){const e=[],s=[];let n=!1;return this.on("event",r=>{const a=s.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{n=!0;for(const r of s)r.resolve(void 0);s.length=0}),this.on("abort",r=>{n=!0;for(const a of s)a.reject(r);s.length=0}),this.on("error",r=>{n=!0;for(const a of s)a.reject(r);s.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((a,i)=>s.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const s=new AssistantStream;return s._run(()=>s._fromReadableStream(e)),s}async _fromReadableStream(e,s){const n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const r=Stream.fromReadableStream(e,this.controller);for await(const a of r)__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_addEvent).call(this,a);if(r.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_endRequest).call(this))}toReadableStream(){return new Stream(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,s,n,r,a){const i=new AssistantStream;return i._run(()=>i._runToolAssistantStream(e,s,n,r,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,s,n,r,a){const i=a?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const u={...r,stream:!0},f=await e.submitToolOutputs(s,n,u,{...a,signal:this.controller.signal});this._connected();for await(const c of f)__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_addEvent).call(this,c);if(f.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_endRequest).call(this))}static createThreadAssistantStream(e,s,n){const r=new AssistantStream;return r._run(()=>r._threadAssistantStream(e,s,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}static createAssistantStream(e,s,n,r){const a=new AssistantStream;return a._run(()=>a._runAssistantStream(e,s,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return __classPrivateFieldGet$1(this,_AssistantStream_currentEvent,"f")}currentRun(){return __classPrivateFieldGet$1(this,_AssistantStream_currentRunSnapshot,"f")}currentMessageSnapshot(){return __classPrivateFieldGet$1(this,_AssistantStream_messageSnapshot,"f")}currentRunStepSnapshot(){return __classPrivateFieldGet$1(this,_AssistantStream_currentRunStepSnapshot,"f")}async finalRunSteps(){return await this.done(),Object.values(__classPrivateFieldGet$1(this,_AssistantStream_runStepSnapshots,"f"))}async finalMessages(){return await this.done(),Object.values(__classPrivateFieldGet$1(this,_AssistantStream_messageSnapshots,"f"))}async finalRun(){if(await this.done(),!__classPrivateFieldGet$1(this,_AssistantStream_finalRun,"f"))throw Error("Final run was not received.");return __classPrivateFieldGet$1(this,_AssistantStream_finalRun,"f")}async _createThreadAssistantStream(e,s,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...s,stream:!0},i=await e.createAndRun(a,{...n,signal:this.controller.signal});this._connected();for await(const u of i)__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_addEvent).call(this,u);if(i.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_endRequest).call(this))}async _createAssistantStream(e,s,n,r){const a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...n,stream:!0},u=await e.create(s,i,{...r,signal:this.controller.signal});this._connected();for await(const f of u)__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_addEvent).call(this,f);if(u.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_endRequest).call(this))}static accumulateDelta(e,s){for(const[n,r]of Object.entries(s)){if(!e.hasOwnProperty(n)){e[n]=r;continue}let a=e[n];if(a==null){e[n]=r;continue}if(n==="index"||n==="type"){e[n]=r;continue}if(typeof a=="string"&&typeof r=="string")a+=r;else if(typeof a=="number"&&typeof r=="number")a+=r;else if(isObj(a)&&isObj(r))a=this.accumulateDelta(a,r);else if(Array.isArray(a)&&Array.isArray(r)){if(a.every(i=>typeof i=="string"||typeof i=="number")){a.push(...r);continue}for(const i of r){if(!isObj(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);const u=i.index;if(u==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof u!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${u}`);const f=a[u];f==null?a.push(i):a[u]=this.accumulateDelta(f,i)}continue}else throw Error(`Unhandled record type: ${n}, deltaValue: ${r}, accValue: ${a}`);e[n]=a}return e}_addRun(e){return e}async _threadAssistantStream(e,s,n){return await this._createThreadAssistantStream(s,e,n)}async _runAssistantStream(e,s,n,r){return await this._createAssistantStream(s,e,n,r)}async _runToolAssistantStream(e,s,n,r,a){return await this._createToolAssistantStream(n,e,s,r,a)}}_AssistantStream_addEvent=function t(e){if(!this.ended)switch(__classPrivateFieldSet$1(this,_AssistantStream_currentEvent,e,"f"),__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_handleEvent).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_handleRun).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_handleRunStep).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_handleMessage).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},_AssistantStream_endRequest=function t(){if(this.ended)throw new OpenAIError("stream has ended, this shouldn't happen");if(!__classPrivateFieldGet$1(this,_AssistantStream_finalRun,"f"))throw Error("Final run has not been received");return __classPrivateFieldGet$1(this,_AssistantStream_finalRun,"f")},_AssistantStream_handleMessage=function t(e){const[s,n]=__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_accumulateMessage).call(this,e,__classPrivateFieldGet$1(this,_AssistantStream_messageSnapshot,"f"));__classPrivateFieldSet$1(this,_AssistantStream_messageSnapshot,s,"f"),__classPrivateFieldGet$1(this,_AssistantStream_messageSnapshots,"f")[s.id]=s;for(const r of n){const a=s.content[r.index];a?.type=="text"&&this._emit("textCreated",a.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,s),e.data.delta.content)for(const r of e.data.delta.content){if(r.type=="text"&&r.text){let a=r.text,i=s.content[r.index];if(i&&i.type=="text")this._emit("textDelta",a,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=__classPrivateFieldGet$1(this,_AssistantStream_currentContentIndex,"f")){if(__classPrivateFieldGet$1(this,_AssistantStream_currentContent,"f"))switch(__classPrivateFieldGet$1(this,_AssistantStream_currentContent,"f").type){case"text":this._emit("textDone",__classPrivateFieldGet$1(this,_AssistantStream_currentContent,"f").text,__classPrivateFieldGet$1(this,_AssistantStream_messageSnapshot,"f"));break;case"image_file":this._emit("imageFileDone",__classPrivateFieldGet$1(this,_AssistantStream_currentContent,"f").image_file,__classPrivateFieldGet$1(this,_AssistantStream_messageSnapshot,"f"));break}__classPrivateFieldSet$1(this,_AssistantStream_currentContentIndex,r.index,"f")}__classPrivateFieldSet$1(this,_AssistantStream_currentContent,s.content[r.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(__classPrivateFieldGet$1(this,_AssistantStream_currentContentIndex,"f")!==void 0){const r=e.data.content[__classPrivateFieldGet$1(this,_AssistantStream_currentContentIndex,"f")];if(r)switch(r.type){case"image_file":this._emit("imageFileDone",r.image_file,__classPrivateFieldGet$1(this,_AssistantStream_messageSnapshot,"f"));break;case"text":this._emit("textDone",r.text,__classPrivateFieldGet$1(this,_AssistantStream_messageSnapshot,"f"));break}}__classPrivateFieldGet$1(this,_AssistantStream_messageSnapshot,"f")&&this._emit("messageDone",e.data),__classPrivateFieldSet$1(this,_AssistantStream_messageSnapshot,void 0,"f")}},_AssistantStream_handleRunStep=function t(e){const s=__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_accumulateRunStep).call(this,e);switch(__classPrivateFieldSet$1(this,_AssistantStream_currentRunStepSnapshot,s,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&n.step_details.type=="tool_calls"&&n.step_details.tool_calls&&s.step_details.type=="tool_calls")for(const a of n.step_details.tool_calls)a.index==__classPrivateFieldGet$1(this,_AssistantStream_currentToolCallIndex,"f")?this._emit("toolCallDelta",a,s.step_details.tool_calls[a.index]):(__classPrivateFieldGet$1(this,_AssistantStream_currentToolCall,"f")&&this._emit("toolCallDone",__classPrivateFieldGet$1(this,_AssistantStream_currentToolCall,"f")),__classPrivateFieldSet$1(this,_AssistantStream_currentToolCallIndex,a.index,"f"),__classPrivateFieldSet$1(this,_AssistantStream_currentToolCall,s.step_details.tool_calls[a.index],"f"),__classPrivateFieldGet$1(this,_AssistantStream_currentToolCall,"f")&&this._emit("toolCallCreated",__classPrivateFieldGet$1(this,_AssistantStream_currentToolCall,"f")));this._emit("runStepDelta",e.data.delta,s);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":__classPrivateFieldSet$1(this,_AssistantStream_currentRunStepSnapshot,void 0,"f"),e.data.step_details.type=="tool_calls"&&__classPrivateFieldGet$1(this,_AssistantStream_currentToolCall,"f")&&(this._emit("toolCallDone",__classPrivateFieldGet$1(this,_AssistantStream_currentToolCall,"f")),__classPrivateFieldSet$1(this,_AssistantStream_currentToolCall,void 0,"f")),this._emit("runStepDone",e.data,s);break}},_AssistantStream_handleEvent=function t(e){__classPrivateFieldGet$1(this,_AssistantStream_events,"f").push(e),this._emit("event",e)},_AssistantStream_accumulateRunStep=function t(e){switch(e.event){case"thread.run.step.created":return __classPrivateFieldGet$1(this,_AssistantStream_runStepSnapshots,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let s=__classPrivateFieldGet$1(this,_AssistantStream_runStepSnapshots,"f")[e.data.id];if(!s)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const r=AssistantStream.accumulateDelta(s,n.delta);__classPrivateFieldGet$1(this,_AssistantStream_runStepSnapshots,"f")[e.data.id]=r}return __classPrivateFieldGet$1(this,_AssistantStream_runStepSnapshots,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":__classPrivateFieldGet$1(this,_AssistantStream_runStepSnapshots,"f")[e.data.id]=e.data;break}if(__classPrivateFieldGet$1(this,_AssistantStream_runStepSnapshots,"f")[e.data.id])return __classPrivateFieldGet$1(this,_AssistantStream_runStepSnapshots,"f")[e.data.id];throw new Error("No snapshot available")},_AssistantStream_accumulateMessage=function t(e,s){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!s)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const a of r.delta.content)if(a.index in s.content){let i=s.content[a.index];s.content[a.index]=__classPrivateFieldGet$1(this,_AssistantStream_instances,"m",_AssistantStream_accumulateContent).call(this,a,i)}else s.content[a.index]=a,n.push(a);return[s,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(s)return[s,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},_AssistantStream_accumulateContent=function t(e,s){return AssistantStream.accumulateDelta(s,e)},_AssistantStream_handleRun=function t(e){switch(__classPrivateFieldSet$1(this,_AssistantStream_currentRunSnapshot,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":__classPrivateFieldSet$1(this,_AssistantStream_finalRun,e.data,"f"),__classPrivateFieldGet$1(this,_AssistantStream_currentToolCall,"f")&&(this._emit("toolCallDone",__classPrivateFieldGet$1(this,_AssistantStream_currentToolCall,"f")),__classPrivateFieldSet$1(this,_AssistantStream_currentToolCall,void 0,"f"));break}};class Messages extends APIResource{create(e,s,n){return this._client.post(`/threads/${e}/messages`,{body:s,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,s,n){return this._client.get(`/threads/${e}/messages/${s}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,s,n,r){return this._client.post(`/threads/${e}/messages/${s}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,s={},n){return isRequestOptions(s)?this.list(e,{},s):this._client.getAPIList(`/threads/${e}/messages`,MessagesPage,{query:s,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,s,n){return this._client.delete(`/threads/${e}/messages/${s}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class MessagesPage extends CursorPage{}Messages.MessagesPage=MessagesPage;class Steps extends APIResource{retrieve(e,s,n,r={},a){return isRequestOptions(r)?this.retrieve(e,s,n,{},r):this._client.get(`/threads/${e}/runs/${s}/steps/${n}`,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,s,n={},r){return isRequestOptions(n)?this.list(e,s,{},n):this._client.getAPIList(`/threads/${e}/runs/${s}/steps`,RunStepsPage,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class RunStepsPage extends CursorPage{}Steps.RunStepsPage=RunStepsPage;let Runs$1=class extends APIResource{constructor(){super(...arguments),this.steps=new Steps(this._client)}create(e,s,n){const{include:r,...a}=s;return this._client.post(`/threads/${e}/runs`,{query:{include:r},body:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:s.stream??!1})}retrieve(e,s,n){return this._client.get(`/threads/${e}/runs/${s}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,s,n,r){return this._client.post(`/threads/${e}/runs/${s}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,s={},n){return isRequestOptions(s)?this.list(e,{},s):this._client.getAPIList(`/threads/${e}/runs`,RunsPage,{query:s,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,s,n){return this._client.post(`/threads/${e}/runs/${s}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,s,n){const r=await this.create(e,s,n);return await this.poll(e,r.id,n)}createAndStream(e,s,n){return AssistantStream.createAssistantStream(e,this._client.beta.threads.runs,s,n)}async poll(e,s,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,s,{...n,headers:{...n?.headers,...r}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let u=5e3;if(n?.pollIntervalMs)u=n.pollIntervalMs;else{const f=i.headers.get("openai-poll-after-ms");if(f){const c=parseInt(f);isNaN(c)||(u=c)}}await sleep(u);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,s,n){return AssistantStream.createAssistantStream(e,this._client.beta.threads.runs,s,n)}submitToolOutputs(e,s,n,r){return this._client.post(`/threads/${e}/runs/${s}/submit_tool_outputs`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,s,n,r){const a=await this.submitToolOutputs(e,s,n,r);return await this.poll(e,a.id,r)}submitToolOutputsStream(e,s,n,r){return AssistantStream.createToolAssistantStream(e,s,this._client.beta.threads.runs,n,r)}};class RunsPage extends CursorPage{}Runs$1.RunsPage=RunsPage,Runs$1.Steps=Steps,Runs$1.RunStepsPage=RunStepsPage;class Threads extends APIResource{constructor(){super(...arguments),this.runs=new Runs$1(this._client),this.messages=new Messages(this._client)}create(e={},s){return isRequestOptions(e)?this.create({},e):this._client.post("/threads",{body:e,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}retrieve(e,s){return this._client.get(`/threads/${e}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}update(e,s,n){return this._client.post(`/threads/${e}`,{body:s,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,s){return this._client.delete(`/threads/${e}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}createAndRun(e,s){return this._client.post("/threads/runs",{body:e,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers},stream:e.stream??!1})}async createAndRunPoll(e,s){const n=await this.createAndRun(e,s);return await this.runs.poll(n.thread_id,n.id,s)}createAndRunStream(e,s){return AssistantStream.createThreadAssistantStream(e,this._client.beta.threads,s)}}Threads.Runs=Runs$1,Threads.RunsPage=RunsPage,Threads.Messages=Messages,Threads.MessagesPage=MessagesPage;class Beta extends APIResource{constructor(){super(...arguments),this.realtime=new Realtime(this._client),this.chat=new Chat(this._client),this.assistants=new Assistants(this._client),this.threads=new Threads(this._client)}}Beta.Realtime=Realtime,Beta.Assistants=Assistants,Beta.AssistantsPage=AssistantsPage,Beta.Threads=Threads;class Completions extends APIResource{create(e,s){return this._client.post("/completions",{body:e,...s,stream:e.stream??!1})}}class Embeddings extends APIResource{create(e,s){const n=!!e.encoding_format;let r=n?e.encoding_format:"base64";n&&debug("Request","User defined encoding_format:",e.encoding_format);const a=this._client.post("/embeddings",{body:{...e,encoding_format:r},...s});return n?a:(debug("response","Decoding base64 embeddings to float32 array"),a._thenUnwrap(i=>(i&&i.data&&i.data.forEach(u=>{const f=u.embedding;u.embedding=toFloat32Array(f)}),i)))}}class OutputItems extends APIResource{retrieve(e,s,n,r){return this._client.get(`/evals/${e}/runs/${s}/output_items/${n}`,r)}list(e,s,n={},r){return isRequestOptions(n)?this.list(e,s,{},n):this._client.getAPIList(`/evals/${e}/runs/${s}/output_items`,OutputItemListResponsesPage,{query:n,...r})}}class OutputItemListResponsesPage extends CursorPage{}OutputItems.OutputItemListResponsesPage=OutputItemListResponsesPage;class Runs extends APIResource{constructor(){super(...arguments),this.outputItems=new OutputItems(this._client)}create(e,s,n){return this._client.post(`/evals/${e}/runs`,{body:s,...n})}retrieve(e,s,n){return this._client.get(`/evals/${e}/runs/${s}`,n)}list(e,s={},n){return isRequestOptions(s)?this.list(e,{},s):this._client.getAPIList(`/evals/${e}/runs`,RunListResponsesPage,{query:s,...n})}del(e,s,n){return this._client.delete(`/evals/${e}/runs/${s}`,n)}cancel(e,s,n){return this._client.post(`/evals/${e}/runs/${s}`,n)}}class RunListResponsesPage extends CursorPage{}Runs.RunListResponsesPage=RunListResponsesPage,Runs.OutputItems=OutputItems,Runs.OutputItemListResponsesPage=OutputItemListResponsesPage;class Evals extends APIResource{constructor(){super(...arguments),this.runs=new Runs(this._client)}create(e,s){return this._client.post("/evals",{body:e,...s})}retrieve(e,s){return this._client.get(`/evals/${e}`,s)}update(e,s,n){return this._client.post(`/evals/${e}`,{body:s,...n})}list(e={},s){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/evals",EvalListResponsesPage,{query:e,...s})}del(e,s){return this._client.delete(`/evals/${e}`,s)}}class EvalListResponsesPage extends CursorPage{}Evals.EvalListResponsesPage=EvalListResponsesPage,Evals.Runs=Runs,Evals.RunListResponsesPage=RunListResponsesPage;let Files$1=class extends APIResource{create(e,s){return this._client.post("/files",multipartFormRequestOptions({body:e,...s}))}retrieve(e,s){return this._client.get(`/files/${e}`,s)}list(e={},s){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/files",FileObjectsPage,{query:e,...s})}del(e,s){return this._client.delete(`/files/${e}`,s)}content(e,s){return this._client.get(`/files/${e}/content`,{...s,headers:{Accept:"application/binary",...s?.headers},__binaryResponse:!0})}retrieveContent(e,s){return this._client.get(`/files/${e}/content`,s)}async waitForProcessing(e,{pollInterval:s=5e3,maxWait:n=30*60*1e3}={}){const r=new Set(["processed","error","deleted"]),a=Date.now();let i=await this.retrieve(e);for(;!i.status||!r.has(i.status);)if(await sleep(s),i=await this.retrieve(e),Date.now()-a>n)throw new APIConnectionTimeoutError({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return i}};class FileObjectsPage extends CursorPage{}Files$1.FileObjectsPage=FileObjectsPage;class Permissions extends APIResource{create(e,s,n){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,PermissionCreateResponsesPage,{body:s,method:"post",...n})}retrieve(e,s={},n){return isRequestOptions(s)?this.retrieve(e,{},s):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:s,...n})}del(e,s){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions`,s)}}class PermissionCreateResponsesPage extends Page{}Permissions.PermissionCreateResponsesPage=PermissionCreateResponsesPage;let Checkpoints$1=class extends APIResource{constructor(){super(...arguments),this.permissions=new Permissions(this._client)}};Checkpoints$1.Permissions=Permissions,Checkpoints$1.PermissionCreateResponsesPage=PermissionCreateResponsesPage;class Checkpoints extends APIResource{list(e,s={},n){return isRequestOptions(s)?this.list(e,{},s):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,FineTuningJobCheckpointsPage,{query:s,...n})}}class FineTuningJobCheckpointsPage extends CursorPage{}Checkpoints.FineTuningJobCheckpointsPage=FineTuningJobCheckpointsPage;class Jobs extends APIResource{constructor(){super(...arguments),this.checkpoints=new Checkpoints(this._client)}create(e,s){return this._client.post("/fine_tuning/jobs",{body:e,...s})}retrieve(e,s){return this._client.get(`/fine_tuning/jobs/${e}`,s)}list(e={},s){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",FineTuningJobsPage,{query:e,...s})}cancel(e,s){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,s)}listEvents(e,s={},n){return isRequestOptions(s)?this.listEvents(e,{},s):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,FineTuningJobEventsPage,{query:s,...n})}}class FineTuningJobsPage extends CursorPage{}class FineTuningJobEventsPage extends CursorPage{}Jobs.FineTuningJobsPage=FineTuningJobsPage,Jobs.FineTuningJobEventsPage=FineTuningJobEventsPage,Jobs.Checkpoints=Checkpoints,Jobs.FineTuningJobCheckpointsPage=FineTuningJobCheckpointsPage;class FineTuning extends APIResource{constructor(){super(...arguments),this.jobs=new Jobs(this._client),this.checkpoints=new Checkpoints$1(this._client)}}FineTuning.Jobs=Jobs,FineTuning.FineTuningJobsPage=FineTuningJobsPage,FineTuning.FineTuningJobEventsPage=FineTuningJobEventsPage,FineTuning.Checkpoints=Checkpoints$1;class Images extends APIResource{createVariation(e,s){return this._client.post("/images/variations",multipartFormRequestOptions({body:e,...s}))}edit(e,s){return this._client.post("/images/edits",multipartFormRequestOptions({body:e,...s}))}generate(e,s){return this._client.post("/images/generations",{body:e,...s})}}class Models extends APIResource{retrieve(e,s){return this._client.get(`/models/${e}`,s)}list(e){return this._client.getAPIList("/models",ModelsPage,e)}del(e,s){return this._client.delete(`/models/${e}`,s)}}class ModelsPage extends Page{}Models.ModelsPage=ModelsPage;class Moderations extends APIResource{create(e,s){return this._client.post("/moderations",{body:e,...s})}}function maybeParseResponse(t,e){return!e||!hasAutoParseableInput(e)?{...t,output_parsed:null,output:t.output.map(s=>s.type==="function_call"?{...s,parsed_arguments:null}:s.type==="message"?{...s,content:s.content.map(n=>({...n,parsed:null}))}:s)}:parseResponse(t,e)}function parseResponse(t,e){const s=t.output.map(r=>{if(r.type==="function_call")return{...r,parsed_arguments:parseToolCall(e,r)};if(r.type==="message"){const a=r.content.map(i=>i.type==="output_text"?{...i,parsed:parseTextFormat(e,i.text)}:i);return{...r,content:a}}return r}),n=Object.assign({},t,{output:s});return Object.getOwnPropertyDescriptor(t,"output_text")||addOutputText(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const r of n.output)if(r.type==="message"){for(const a of r.content)if(a.type==="output_text"&&a.parsed!==null)return a.parsed}return null}}),n}function parseTextFormat(t,e){return t.text?.format?.type!=="json_schema"?null:"$parseRaw"in t.text?.format?(t.text?.format).$parseRaw(e):JSON.parse(e)}function hasAutoParseableInput(t){return!!isAutoParsableResponseFormat(t.text?.format)}function isAutoParsableTool(t){return t?.$brand==="auto-parseable-tool"}function getInputToolByName(t,e){return t.find(s=>s.type==="function"&&s.name===e)}function parseToolCall(t,e){const s=getInputToolByName(t.tools??[],e.name);return{...e,...e,parsed_arguments:isAutoParsableTool(s)?s.$parseRaw(e.arguments):s?.strict?JSON.parse(e.arguments):null}}function addOutputText(t){const e=[];for(const s of t.output)if(s.type==="message")for(const n of s.content)n.type==="output_text"&&e.push(n.text);t.output_text=e.join("")}class InputItems extends APIResource{list(e,s={},n){return isRequestOptions(s)?this.list(e,{},s):this._client.getAPIList(`/responses/${e}/input_items`,ResponseItemsPage,{query:s,...n})}}var __classPrivateFieldSet=function(t,e,s,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(t,s):r?r.value=s:e.set(t,s),s},__classPrivateFieldGet=function(t,e,s,n){if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?n:s==="a"?n.call(t):n?n.value:e.get(t)},_ResponseStream_instances,_ResponseStream_params,_ResponseStream_currentResponseSnapshot,_ResponseStream_finalResponse,_ResponseStream_beginRequest,_ResponseStream_addEvent,_ResponseStream_endRequest,_ResponseStream_accumulateResponse;class ResponseStream extends EventStream{constructor(e){super(),_ResponseStream_instances.add(this),_ResponseStream_params.set(this,void 0),_ResponseStream_currentResponseSnapshot.set(this,void 0),_ResponseStream_finalResponse.set(this,void 0),__classPrivateFieldSet(this,_ResponseStream_params,e,"f")}static createResponse(e,s,n){const r=new ResponseStream(s);return r._run(()=>r._createResponse(e,s,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createResponse(e,s,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),__classPrivateFieldGet(this,_ResponseStream_instances,"m",_ResponseStream_beginRequest).call(this);const a=await e.responses.create({...s,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const i of a)__classPrivateFieldGet(this,_ResponseStream_instances,"m",_ResponseStream_addEvent).call(this,i);if(a.controller.signal?.aborted)throw new APIUserAbortError;return __classPrivateFieldGet(this,_ResponseStream_instances,"m",_ResponseStream_endRequest).call(this)}[(_ResponseStream_params=new WeakMap,_ResponseStream_currentResponseSnapshot=new WeakMap,_ResponseStream_finalResponse=new WeakMap,_ResponseStream_instances=new WeakSet,_ResponseStream_beginRequest=function(){this.ended||__classPrivateFieldSet(this,_ResponseStream_currentResponseSnapshot,void 0,"f")},_ResponseStream_addEvent=function(s){if(this.ended)return;const n=__classPrivateFieldGet(this,_ResponseStream_instances,"m",_ResponseStream_accumulateResponse).call(this,s);switch(this._emit("event",s),s.type){case"response.output_text.delta":{const r=n.output[s.output_index];if(!r)throw new OpenAIError(`missing output at index ${s.output_index}`);if(r.type==="message"){const a=r.content[s.content_index];if(!a)throw new OpenAIError(`missing content at index ${s.content_index}`);if(a.type!=="output_text")throw new OpenAIError(`expected content to be 'output_text', got ${a.type}`);this._emit("response.output_text.delta",{...s,snapshot:a.text})}break}case"response.function_call_arguments.delta":{const r=n.output[s.output_index];if(!r)throw new OpenAIError(`missing output at index ${s.output_index}`);r.type==="function_call"&&this._emit("response.function_call_arguments.delta",{...s,snapshot:r.arguments});break}default:this._emit(s.type,s);break}},_ResponseStream_endRequest=function(){if(this.ended)throw new OpenAIError("stream has ended, this shouldn't happen");const s=__classPrivateFieldGet(this,_ResponseStream_currentResponseSnapshot,"f");if(!s)throw new OpenAIError("request ended without sending any events");__classPrivateFieldSet(this,_ResponseStream_currentResponseSnapshot,void 0,"f");const n=finalizeResponse(s,__classPrivateFieldGet(this,_ResponseStream_params,"f"));return __classPrivateFieldSet(this,_ResponseStream_finalResponse,n,"f"),n},_ResponseStream_accumulateResponse=function(s){let n=__classPrivateFieldGet(this,_ResponseStream_currentResponseSnapshot,"f");if(!n){if(s.type!=="response.created")throw new OpenAIError(`When snapshot hasn't been set yet, expected 'response.created' event, got ${s.type}`);return n=__classPrivateFieldSet(this,_ResponseStream_currentResponseSnapshot,s.response,"f"),n}switch(s.type){case"response.output_item.added":{n.output.push(s.item);break}case"response.content_part.added":{const r=n.output[s.output_index];if(!r)throw new OpenAIError(`missing output at index ${s.output_index}`);r.type==="message"&&r.content.push(s.part);break}case"response.output_text.delta":{const r=n.output[s.output_index];if(!r)throw new OpenAIError(`missing output at index ${s.output_index}`);if(r.type==="message"){const a=r.content[s.content_index];if(!a)throw new OpenAIError(`missing content at index ${s.content_index}`);if(a.type!=="output_text")throw new OpenAIError(`expected content to be 'output_text', got ${a.type}`);a.text+=s.delta}break}case"response.function_call_arguments.delta":{const r=n.output[s.output_index];if(!r)throw new OpenAIError(`missing output at index ${s.output_index}`);r.type==="function_call"&&(r.arguments+=s.delta);break}case"response.completed":{__classPrivateFieldSet(this,_ResponseStream_currentResponseSnapshot,s.response,"f");break}}return n},Symbol.asyncIterator)](){const e=[],s=[];let n=!1;return this.on("event",r=>{const a=s.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{n=!0;for(const r of s)r.resolve(void 0);s.length=0}),this.on("abort",r=>{n=!0;for(const a of s)a.reject(r);s.length=0}),this.on("error",r=>{n=!0;for(const a of s)a.reject(r);s.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((a,i)=>s.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=__classPrivateFieldGet(this,_ResponseStream_finalResponse,"f");if(!e)throw new OpenAIError("stream ended without producing a ChatCompletion");return e}}function finalizeResponse(t,e){return maybeParseResponse(t,e)}class Responses extends APIResource{constructor(){super(...arguments),this.inputItems=new InputItems(this._client)}create(e,s){return this._client.post("/responses",{body:e,...s,stream:e.stream??!1})._thenUnwrap(n=>("object"in n&&n.object==="response"&&addOutputText(n),n))}retrieve(e,s={},n){return isRequestOptions(s)?this.retrieve(e,{},s):this._client.get(`/responses/${e}`,{query:s,...n})}del(e,s){return this._client.delete(`/responses/${e}`,{...s,headers:{Accept:"*/*",...s?.headers}})}parse(e,s){return this._client.responses.create(e,s)._thenUnwrap(n=>parseResponse(n,e))}stream(e,s){return ResponseStream.createResponse(this._client,e,s)}}class ResponseItemsPage extends CursorPage{}Responses.InputItems=InputItems;class Parts extends APIResource{create(e,s,n){return this._client.post(`/uploads/${e}/parts`,multipartFormRequestOptions({body:s,...n}))}}class Uploads extends APIResource{constructor(){super(...arguments),this.parts=new Parts(this._client)}create(e,s){return this._client.post("/uploads",{body:e,...s})}cancel(e,s){return this._client.post(`/uploads/${e}/cancel`,s)}complete(e,s,n){return this._client.post(`/uploads/${e}/complete`,{body:s,...n})}}Uploads.Parts=Parts;const allSettledWithThrow=async t=>{const e=await Promise.allSettled(t),s=e.filter(r=>r.status==="rejected");if(s.length){for(const r of s)console.error(r.reason);throw new Error(`${s.length} promise(s) failed - see the above errors`)}const n=[];for(const r of e)r.status==="fulfilled"&&n.push(r.value);return n};class Files extends APIResource{create(e,s,n){return this._client.post(`/vector_stores/${e}/files`,{body:s,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,s,n){return this._client.get(`/vector_stores/${e}/files/${s}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,s,n,r){return this._client.post(`/vector_stores/${e}/files/${s}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,s={},n){return isRequestOptions(s)?this.list(e,{},s):this._client.getAPIList(`/vector_stores/${e}/files`,VectorStoreFilesPage,{query:s,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,s,n){return this._client.delete(`/vector_stores/${e}/files/${s}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,s,n){const r=await this.create(e,s,n);return await this.poll(e,r.id,n)}async poll(e,s,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const a=await this.retrieve(e,s,{...n,headers:r}).withResponse(),i=a.data;switch(i.status){case"in_progress":let u=5e3;if(n?.pollIntervalMs)u=n.pollIntervalMs;else{const f=a.response.headers.get("openai-poll-after-ms");if(f){const c=parseInt(f);isNaN(c)||(u=c)}}await sleep(u);break;case"failed":case"completed":return i}}}async upload(e,s,n){const r=await this._client.files.create({file:s,purpose:"assistants"},n);return this.create(e,{file_id:r.id},n)}async uploadAndPoll(e,s,n){const r=await this.upload(e,s,n);return await this.poll(e,r.id,n)}content(e,s,n){return this._client.getAPIList(`/vector_stores/${e}/files/${s}/content`,FileContentResponsesPage,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class VectorStoreFilesPage extends CursorPage{}class FileContentResponsesPage extends Page{}Files.VectorStoreFilesPage=VectorStoreFilesPage,Files.FileContentResponsesPage=FileContentResponsesPage;class FileBatches extends APIResource{create(e,s,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:s,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,s,n){return this._client.get(`/vector_stores/${e}/file_batches/${s}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,s,n){return this._client.post(`/vector_stores/${e}/file_batches/${s}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,s,n){const r=await this.create(e,s);return await this.poll(e,r.id,n)}listFiles(e,s,n={},r){return isRequestOptions(n)?this.listFiles(e,s,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${s}/files`,VectorStoreFilesPage,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,s,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,s,{...n,headers:r}).withResponse();switch(a.status){case"in_progress":let u=5e3;if(n?.pollIntervalMs)u=n.pollIntervalMs;else{const f=i.headers.get("openai-poll-after-ms");if(f){const c=parseInt(f);isNaN(c)||(u=c)}}await sleep(u);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:s,fileIds:n=[]},r){if(s==null||s.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=r?.maxConcurrency??5,i=Math.min(a,s.length),u=this._client,f=s.values(),c=[...n];async function d(m){for(let _ of m){const p=await u.files.create({file:_,purpose:"assistants"},r);c.push(p.id)}}const h=Array(i).fill(f).map(d);return await allSettledWithThrow(h),await this.createAndPoll(e,{file_ids:c})}}class VectorStores extends APIResource{constructor(){super(...arguments),this.files=new Files(this._client),this.fileBatches=new FileBatches(this._client)}create(e,s){return this._client.post("/vector_stores",{body:e,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}retrieve(e,s){return this._client.get(`/vector_stores/${e}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}update(e,s,n){return this._client.post(`/vector_stores/${e}`,{body:s,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},s){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/vector_stores",VectorStoresPage,{query:e,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}del(e,s){return this._client.delete(`/vector_stores/${e}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}search(e,s,n){return this._client.getAPIList(`/vector_stores/${e}/search`,VectorStoreSearchResponsesPage,{body:s,method:"post",...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class VectorStoresPage extends CursorPage{}class VectorStoreSearchResponsesPage extends Page{}VectorStores.VectorStoresPage=VectorStoresPage,VectorStores.VectorStoreSearchResponsesPage=VectorStoreSearchResponsesPage,VectorStores.Files=Files,VectorStores.VectorStoreFilesPage=VectorStoreFilesPage,VectorStores.FileContentResponsesPage=FileContentResponsesPage,VectorStores.FileBatches=FileBatches;var _a;class OpenAI extends APIClient{constructor({baseURL:e=readEnv("OPENAI_BASE_URL"),apiKey:s=readEnv("OPENAI_API_KEY"),organization:n=readEnv("OPENAI_ORG_ID")??null,project:r=readEnv("OPENAI_PROJECT_ID")??null,...a}={}){if(s===void 0)throw new OpenAIError("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:s,organization:n,project:r,...a,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&isRunningInBrowser())throw new OpenAIError(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new Completions(this),this.chat=new Chat$1(this),this.embeddings=new Embeddings(this),this.files=new Files$1(this),this.images=new Images(this),this.audio=new Audio(this),this.moderations=new Moderations(this),this.models=new Models(this),this.fineTuning=new FineTuning(this),this.vectorStores=new VectorStores(this),this.beta=new Beta(this),this.batches=new Batches(this),this.uploads=new Uploads(this),this.responses=new Responses(this),this.evals=new Evals(this),this._options=i,this.apiKey=s,this.organization=n,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return stringify(e,{arrayFormat:"brackets"})}}_a=OpenAI,OpenAI.OpenAI=_a,OpenAI.DEFAULT_TIMEOUT=6e5,OpenAI.OpenAIError=OpenAIError,OpenAI.APIError=APIError,OpenAI.APIConnectionError=APIConnectionError,OpenAI.APIConnectionTimeoutError=APIConnectionTimeoutError,OpenAI.APIUserAbortError=APIUserAbortError,OpenAI.NotFoundError=NotFoundError,OpenAI.ConflictError=ConflictError,OpenAI.RateLimitError=RateLimitError,OpenAI.BadRequestError=BadRequestError,OpenAI.AuthenticationError=AuthenticationError,OpenAI.InternalServerError=InternalServerError,OpenAI.PermissionDeniedError=PermissionDeniedError,OpenAI.UnprocessableEntityError=UnprocessableEntityError,OpenAI.toFile=toFile,OpenAI.fileFromPath=fileFromPath,OpenAI.Completions=Completions,OpenAI.Chat=Chat$1,OpenAI.ChatCompletionsPage=ChatCompletionsPage,OpenAI.Embeddings=Embeddings,OpenAI.Files=Files$1,OpenAI.FileObjectsPage=FileObjectsPage,OpenAI.Images=Images,OpenAI.Audio=Audio,OpenAI.Moderations=Moderations,OpenAI.Models=Models,OpenAI.ModelsPage=ModelsPage,OpenAI.FineTuning=FineTuning,OpenAI.VectorStores=VectorStores,OpenAI.VectorStoresPage=VectorStoresPage,OpenAI.VectorStoreSearchResponsesPage=VectorStoreSearchResponsesPage,OpenAI.Beta=Beta,OpenAI.Batches=Batches,OpenAI.BatchesPage=BatchesPage,OpenAI.Uploads=Uploads,OpenAI.Responses=Responses,OpenAI.Evals=Evals,OpenAI.EvalListResponsesPage=EvalListResponsesPage;function convertToOpenAIFunction(t){return{name:t.name,description:t.description,parameters:zodToJsonSchema(t.schema)}}function convertToOpenAITool(t){return{type:"function",function:convertToOpenAIFunction(t)}}class RunnablePassthrough extends Runnable{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,s){const n=ensureConfig(s);return this.func&&await this.func(e,n),this._callWithConfig(r=>Promise.resolve(r),e,n)}async*transform(e,s){const n=ensureConfig(s);let r,a=!0;for await(const i of this._transformStreamWithConfig(e,u=>u,n))if(yield i,a)if(r===void 0)r=i;else try{r=concat(r,i)}catch{r=void 0,a=!1}this.func&&r!==void 0&&await this.func(r,n)}static assign(e){return new RunnableAssign(new RunnableMap({steps:e}))}}class BaseLLMOutputParser extends Runnable{parseResultWithPrompt(e,s,n){return this.parseResult(e,n)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,s){return typeof e=="string"?this._callWithConfig(async n=>this.parseResult([{text:n}]),e,{...s,runType:"parser"}):this._callWithConfig(async n=>this.parseResult([{message:n,text:this._baseMessageToString(n)}]),e,{...s,runType:"parser"})}}class BaseOutputParser extends BaseLLMOutputParser{parseResult(e,s){return this.parse(e[0].text,s)}async parseWithPrompt(e,s,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class OutputParserException extends Error{constructor(e,s,n,r=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=s,this.observation=n,this.sendToLLM=r,r&&(n===void 0||s===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}}function deepCompareStrict(t,e){const s=typeof t;if(s!==typeof e)return!1;if(Array.isArray(t)){if(!Array.isArray(e))return!1;const n=t.length;if(n!==e.length)return!1;for(let r=0;r<n;r++)if(!deepCompareStrict(t[r],e[r]))return!1;return!0}if(s==="object"){if(!t||!e)return t===e;const n=Object.keys(t),r=Object.keys(e);if(n.length!==r.length)return!1;for(const i of n)if(!deepCompareStrict(t[i],e[i]))return!1;return!0}return t===e}class BaseTransformOutputParser extends BaseOutputParser{async*_transform(e){for await(const s of e)typeof s=="string"?yield this.parseResult([{text:s}]):yield this.parseResult([{message:s,text:this._baseMessageToString(s)}])}async*transform(e,s){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...s,runType:"parser"})}}class BaseCumulativeTransformOutputParser extends BaseTransformOutputParser{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let s,n;for await(const r of e){if(typeof r!="string"&&typeof r.content!="string")throw new Error("Cannot handle non-string output.");let a;if(isBaseMessageChunk(r)){if(typeof r.content!="string")throw new Error("Cannot handle non-string message output.");a=new ChatGenerationChunk({message:r,text:r.content})}else if(isBaseMessage(r)){if(typeof r.content!="string")throw new Error("Cannot handle non-string message output.");a=new ChatGenerationChunk({message:r.toChunk(),text:r.content})}else a=new GenerationChunk({text:r});n===void 0?n=a:n=n.concat(a);const i=await this.parsePartialResult([n]);i!=null&&!deepCompareStrict(i,s)&&(this.diff?yield this._diff(s,i):yield i,s=i)}}}class StructuredOutputParser extends BaseOutputParser{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const s=objectType(Object.fromEntries(Object.entries(e).map(([n,r])=>[n,stringType().describe(r)])));return new this(s)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(zodToJsonSchema(this.schema))}
\`\`\`
`}async parse(e){try{const s=e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim();return await this.schema.parseAsync(JSON.parse(s))}catch(s){throw new OutputParserException(`Failed to parse. Text: "${e}". Error: ${s}`,e)}}}class JsonOutputParser extends BaseCumulativeTransformOutputParser{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,s){if(s)return e?compare(e,s):[{op:"replace",path:"",value:s}]}async parsePartialResult(e){return parseJsonMarkdown(e[0].text)}async parse(e){return parseJsonMarkdown(e,JSON.parse)}getFormatInstructions(){return""}}function parseJsonMarkdown(t,e=parsePartialJson){t=t.trim();const s=/```(json)?(.*)```/s.exec(t);return e(s?s[2]:t)}function parsePartialJson(t){if(typeof t>"u")return null;try{return JSON.parse(t)}catch{}let e="";const s=[];let n=!1,r=!1;for(let a of t){if(n)a==='"'&&!r?n=!1:a===`
`&&!r?a="\\n":a==="\\"?r=!r:r=!1;else if(a==='"')n=!0,r=!1;else if(a==="{")s.push("}");else if(a==="[")s.push("]");else if(a==="}"||a==="]")if(s&&s[s.length-1]===a)s.pop();else return null;e+=a}n&&(e+='"');for(let a=s.length-1;a>=0;a-=1)e+=s[a];try{return JSON.parse(e)}catch{return null}}class JsonOutputToolsParser extends BaseLLMOutputParser{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}async parseResult(e){const s=e[0].message.additional_kwargs.tool_calls;if(!s)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);const n=JSON.parse(JSON.stringify(s)),r=[];for(const a of n)if(a.function!==void 0){const i={type:a.function.name,args:JSON.parse(a.function.arguments)};this.returnId&&(i.id=a.id),Object.defineProperty(i,"name",{get(){return this.type}}),Object.defineProperty(i,"arguments",{get(){return this.args}}),r.push(i)}return r}}class JsonOutputKeyToolsParser extends BaseLLMOutputParser{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new JsonOutputToolsParser(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;const s=await this.zodSchema.safeParseAsync(e);if(s.success)return s.data;throw new OutputParserException(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(s.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const n=(await this.initialParser.parseResult(e)).filter(i=>i.type===this.keyName);let r=n;return this.returnId||(r=n.map(i=>i.args)),this.returnSingle?this._validateResult(r[0]):await Promise.all(r.map(i=>this._validateResult(i)))}}function wrapOpenAIClientError(t){let e;return t.constructor.name===APIConnectionTimeoutError.name?(e=new Error(t.message),e.name="TimeoutError"):t.constructor.name===APIUserAbortError.name?(e=new Error(t.message),e.name="AbortError"):e=t,e}function getEndpoint(t){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:s,azureOpenAIApiKey:n,azureOpenAIBasePath:r,baseURL:a}=t;if(n&&r&&e)return`${r}/${e}`;if(n){if(!s)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${s}.openai.azure.com/openai/deployments/${e}`}return a}class CustomAIMessageChunk{content;name;additional_kwargs;constructor(e){e.additional_kwargs||(e.additional_kwargs={}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs}static _mergeAdditionalKwargs(e,s){const n={...e};for(const[r,a]of Object.entries(s))if(n[r]===void 0)n[r]=a;else if(typeof n[r]=="string")n[r]=n[r]+a;else if(!Array.isArray(n[r])&&typeof n[r]=="object")n[r]=this._mergeAdditionalKwargs(n[r],a);else throw new Error(`additional_kwargs[${r}] already exists in this message chunk.`);return n}concat(e){return new CustomAIMessageChunk({content:this.content+e.content,additional_kwargs:CustomAIMessageChunk._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}function extractGenericMessageCustomRole(t){return t.role!=="system"&&t.role!=="assistant"&&t.role!=="user"&&t.role!=="function"&&t.role!=="tool"&&console.warn(`Unknown message role: ${t.role}`),t.role}function messageToOpenAIRole(t){const e=t._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!ChatMessage.isInstance(t))throw new Error("Invalid generic chat message");return extractGenericMessageCustomRole(t)}default:return e}}function openAIResponseToChatMessage(t){switch(t.role){case"assistant":return new AIMessage(t.content||"",{});default:return new ChatMessage(t.content||"",t.role??"unknown")}}function _convertDeltaToMessageChunk(t,e){const s=t.role??e,n=t.content??"",r=t?.reasoning_content??void 0;let a;return t.function_call?a={function_call:t.function_call}:t.tool_calls?a={tool_calls:t.tool_calls}:a={},s==="user"?new HumanMessageChunk({content:n}):s==="assistant"?new CustomAIMessageChunk({content:n,additional_kwargs:{...a,reasoning_content:r}}):s==="system"?new SystemMessageChunk({content:n}):s==="function"?new FunctionMessageChunk({content:n,additional_kwargs:a,name:t.name}):s==="tool"?new ToolMessageChunk({content:n,additional_kwargs:a,tool_call_id:t.tool_call_id}):new ChatMessageChunk({content:n,role:s})}function convertMessagesToOpenAIParams(t){return t.map(e=>{const s={role:messageToOpenAIRole(e),content:e.content};return e.name!=null&&(s.name=e.name),s})}class CustomChatOpenAI extends BaseChatModel{temperature=1;topP=1;frequencyPenalty=0;presencePenalty=0;n=1;logitBias;modelName="gpt-3.5-turbo";model="gpt-3.5-turbo";modelKwargs;stop;stopSequences;user;timeout;streaming=!1;streamUsage=!0;maxTokens;logprobs;topLogprobs;openAIApiKey;apiKey;azureOpenAIApiVersion;azureOpenAIApiKey;azureADTokenProvider;azureOpenAIApiInstanceName;azureOpenAIApiDeploymentName;azureOpenAIBasePath;organization;reasoning_effort;client;clientConfig;static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,s){super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.openAIApiKey??getEnvironmentVariable$1("OPENAI_API_KEY"),this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.reasoning_effort=e?.reasoning_effort??null,this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:s?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:s?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:s?.baseOptions?.params??e?.configuration?.baseOptions?.params,...s,...e?.configuration}}invocationParams(e){function s(r){return r!==void 0&&r.every(a=>Array.isArray(a.lc_namespace))}return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stop,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:s(e?.tools)?e?.tools.map(convertToOpenAITool):e?.tools,tool_choice:e?.tool_choice,response_format:e?.response_format,seed:e?.seed,reasoning:this.reasoning_effort?{method:this.reasoning_effort}:void 0,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this?.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,s,n){const r=convertMessagesToOpenAIParams(e),a={...this.invocationParams(s),messages:r,stream:!0};let i;const u=await this.completionWithRetry(a,s);for await(const f of u){const c=f?.choices[0];if(!c)continue;const{delta:d}=c;if(!d)continue;const h=_convertDeltaToMessageChunk(d,i);i=d.role??i;const m={prompt:s?.promptIndex??0,completion:c.index??0};if(typeof h.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const _={...m};c.finish_reason!==void 0&&(_.finish_reason=c.finish_reason),this.logprobs&&(_.logprobs=c.logprobs);const p=new ChatGenerationChunk({message:h,text:h.content,generationInfo:_});yield p,n?.handleLLMNewToken(p.text??"",m,void 0,void 0,void 0,{chunk:p})}if(s.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,s,n){const r={},a=this.invocationParams(s),i=convertMessagesToOpenAIParams(e);if(a.stream){const u=this._streamResponseChunks(e,s,n),f={};for await(const p of u){p.message.response_metadata={...p.generationInfo,...p.message.response_metadata};const b=p.generationInfo?.completion??0;f[b]===void 0?f[b]=p:f[b]=f[b].concat(p)}const c=Object.entries(f).sort(([p],[b])=>parseInt(p,10)-parseInt(b,10)).map(([p,b])=>b),{functions:d,function_call:h}=this.invocationParams(s),m=await this.getEstimatedTokenCountFromPrompt(e,d,h),_=await this.getNumTokensFromGenerations(c);return r.promptTokens=m,r.completionTokens=_,r.totalTokens=m+_,{generations:c,llmOutput:{estimatedTokenUsage:r}}}else{const u=await this.completionWithRetry({...a,stream:!1,messages:i},{signal:s?.signal,...s?.options}),{completion_tokens:f,prompt_tokens:c,total_tokens:d}=u?.usage??{};f&&(r.completionTokens=(r.completionTokens??0)+f),c&&(r.promptTokens=(r.promptTokens??0)+c),d&&(r.totalTokens=(r.totalTokens??0)+d);const h=[];for(const m of u?.choices??[]){const p={text:m.message?.content??"",message:openAIResponseToChatMessage(m.message??{role:"assistant"})};p.generationInfo={...m.finish_reason?{finish_reason:m.finish_reason}:{},...m.logprobs?{logprobs:m.logprobs}:{}},h.push(p)}return{generations:h,llmOutput:{tokenUsage:r}}}}async getEstimatedTokenCountFromPrompt(e,s,n){let r=(await this.getNumTokensFromMessages(e)).totalCount;return s&&e.find(a=>a._getType()==="system")&&(r-=4),n==="none"?r+=1:typeof n=="object"&&(r+=await this.getNumTokens(n.name)+4),r}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async n=>n.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([n.message])).countPerMessage[0]:await this.getNumTokens(n.message.content)))).reduce((n,r)=>n+r,0)}async getNumTokensFromMessages(e){let s=0,n=0,r=0;this.modelName==="gpt-3.5-turbo-0301"?(n=4,r=-1):(n=3,r=1);const a=await Promise.all(e.map(async i=>{const u=await this.getNumTokens(i.content),f=await this.getNumTokens(messageToOpenAIRole(i)),c=i.name!==void 0?r+await this.getNumTokens(i.name):0;let d=u+n+f+c;const h=i;if(h._getType()==="function"&&(d-=2),h.additional_kwargs?.function_call&&(d+=3),h?.additional_kwargs.function_call?.name&&(d+=await this.getNumTokens(h.additional_kwargs.function_call?.name)),h.additional_kwargs.function_call?.arguments)try{d+=await this.getNumTokens(JSON.stringify(JSON.parse(h.additional_kwargs.function_call?.arguments)))}catch(m){console.error("Error parsing function arguments",m,JSON.stringify(h.additional_kwargs.function_call)),d+=await this.getNumTokens(h.additional_kwargs.function_call?.arguments)}return s+=d,d}));return s+=3,{totalCount:s,countPerMessage:a}}async completionWithRetry(e,s){const n=this._getClientOptions(s);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,n)}catch(r){throw wrapOpenAIClientError(r)}})}_getClientOptions(e){if(!this.client){const n={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},r=getEndpoint(n),a={...this.clientConfig,baseURL:r,timeout:this.timeout,maxRetries:0};a.baseURL||delete a.baseURL,this.client=new OpenAI(a)}const s={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(s.headers={"api-key":this.azureOpenAIApiKey,...s.headers},s.query={"api-version":this.azureOpenAIApiVersion,...s.query}),s}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((s,n)=>(n&&n.tokenUsage&&(s.tokenUsage.completionTokens+=n.tokenUsage.completionTokens??0,s.tokenUsage.promptTokens+=n.tokenUsage.promptTokens??0,s.tokenUsage.totalTokens+=n.tokenUsage.totalTokens??0),s),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,s){let n,r,a,i;isStructuredOutputMethodParams(e)?(n=e.schema,r=e.name,a=e.method,i=e.includeRaw):(n=e,r=s?.name,a=s?.method,i=s?.includeRaw);let u,f;if(a==="jsonMode")u=this.bind({}),isZodSchema(n)?f=StructuredOutputParser.fromZodSchema(n):f=new JsonOutputParser;else{let m=r??"extract";typeof n.name=="string"&&typeof n.parameters=="object"&&n.parameters!=null?m=n.name:(n.title,n.description),u=this.bind({}),f=new JsonOutputKeyToolsParser({returnSingle:!0,keyName:m})}if(!i)return u.pipe(f);const c=RunnablePassthrough.assign({parsed:(m,_)=>f.invoke(m.raw,_)}),d=RunnablePassthrough.assign({parsed:()=>null}),h=c.withFallbacks({fallbacks:[d]});return RunnableSequence.from([{raw:u},h])}}function isZodSchema(t){return typeof t?.parse=="function"}function isStructuredOutputMethodParams(t){return t!==void 0&&typeof t.schema=="object"}const getLLMModel=async()=>{try{const t=await getSelectedModel();if(!t)throw new Error("未选择模型");if(isCustomModel(t)){const s=await getModelInfo(t),n=await getOpenAIConfigById(s.provider_id);if(isOllamaModel(t)){const r=await getOllamaURL();return new ChatOllama({model:s.model_id,baseUrl:cleanUrl(r),temperature:.3})}else return new CustomChatOpenAI({modelName:s.model_id,temperature:.3,openAIApiKey:n.apiKey,configuration:{baseURL:n.baseUrl,apiKey:n.apiKey,baseOptions:{headers:n.headers?.reduce((r,a)=>(r[a.key]=a.value,r),{})}}})}else{const s=await getOllamaURL();return new ChatOllama({model:t,baseUrl:cleanUrl(s),temperature:.3})}}catch(t){throw logger$1.error("获取LLM模型实例失败",t),new Error(`获取LLM模型实例失败: ${t instanceof Error?t.message:String(t)}`)}},generateSummary=async(t,e,s)=>{logger$1.info("开始生成页面摘要",{title:e,url:s,contentLength:t?.length});try{const n=await getLLMModel(),r=`
你是一个专业的内容分析助手。请分析以下网页内容，并提供以下信息：

1. 简洁摘要（不超过150字）
2. 5-8个关键词（以逗号分隔）
3. 内容质量评分（1-5星，其中5星表示质量最高）

网页标题：${e}
网页URL：${s}

网页内容：
${t.length>8e3?t.substring(0,8e3)+"...":t}

请以JSON格式返回结果，格式如下：
{
  "summary": "内容摘要...",
  "keywords": ["关键词1", "关键词2", "关键词3", ...],
  "rating": 评分数字(1-5)
}

只返回JSON格式的结果，不要有其他内容。
`;logger$1.debug("调用LLM模型生成摘要",{modelName:n._llmType()});const{HumanMessage:a}=await Promise.resolve().then(()=>messages),i=[new a({content:r})],u=await n.invoke(i);logger$1.debug("LLM模型返回响应",{responseLength:u.content?.length});try{const f=u.content,c=f.match(/\{[\s\S]*\}/),d=c?c[0]:f,h=JSON.parse(d);if(!h.summary||!Array.isArray(h.keywords)||typeof h.rating!="number")throw new Error("LLM返回的结果格式不正确");return h.rating=Math.max(1,Math.min(5,Math.round(h.rating))),logger$1.info("成功生成页面摘要",{summaryLength:h.summary.length,keywordsCount:h.keywords.length,rating:h.rating}),h}catch(f){return logger$1.error("解析LLM响应失败",f),{summary:"无法生成摘要。",keywords:[],rating:3}}}catch(n){return logger$1.error("生成页面摘要失败",n),{summary:"无法生成摘要。",keywords:[],rating:3}}},STORAGE_KEY="auto_save_settings",TASKS_STORAGE_KEY="auto_save_tasks",saveTasks=new Map,storage=new g({area:"local"}),HEARTBEAT_INTERVAL=5*60*1e3;let lastHeartbeat=Date.now(),heartbeatIntervalId;const isUrlMatchPattern=(t,e)=>{if(e==="*")return logger$1.debug(`URL匹配: ${t} 匹配全局通配符 *`),!0;try{let s;try{!t.startsWith("http://")&&!t.startsWith("https://")&&(t="https://"+t),s=new URL(t)}catch{return logger$1.error("无效的URL格式:",t),!1}const n=s.hostname,r=s.pathname,a=s.href;if(logger$1.debug(`URL解析: ${t} => 主机名=${n}, 路径=${r}, 完整URL=${a}`),e.startsWith("*.")){const i=e.substring(2),u=n===i||n.endsWith("."+i);return logger$1.debug(`域名通配符匹配: ${n} 与 ${e} => ${u?"匹配":"不匹配"}`),logger$1.debug(`匹配详情: domain=${i}, 检查条件1=${n===i}, 检查条件2=${n.endsWith("."+i)}`),u}else if(e.endsWith("/*")){const i=e.substring(0,e.length-2);let u=!1;return i.includes("://")?u=a.startsWith(i):u=a.includes("://"+i),logger$1.debug(`路径通配符匹配: ${a} 与 ${e} => ${u?"匹配":"不匹配"}`),u}else if(e.includes("*")){const i=e.replace(/\./g,"\\.").replace(/\*/g,".*"),u=new RegExp(`^${i}$`),f=u.test(a),c=u.test(n),d=u.test(r),h=f||c||d;return logger$1.debug(`正则表达式匹配: ${t} 与 ${e} (正则=${i}) => ${h?"匹配":"不匹配"}`),logger$1.debug(`匹配详情: 完整URL=${f}, 主机名=${c}, 路径=${d}`),h}else{const i=a.includes(e)||n.includes(e);return logger$1.debug(`精确匹配: ${a} 是否包含 ${e} => ${i?"匹配":"不匹配"}`),i}}catch(s){return logger$1.error("URL匹配规则解析错误:",s),!1}},shouldAutoSaveUrlWithRule=async(t,e)=>{if(!t)return logger$1.debug("URL为空，不会自动保存"),{shouldSave:!1,matchedRule:""};try{let s=t;if(!s.startsWith("http://")&&!s.startsWith("https://")&&(s="https://"+s,logger$1.debug(`URL格式标准化: ${t} => ${s}`)),e||(e=await storage.get(STORAGE_KEY),logger$1.debug("从存储中获取自动保存设置",{enabled:e?.enabled,paused:e?.paused,rulesCount:e?.websites?.length})),!e||!e.enabled)return logger$1.debug("自动保存功能未启用，不会自动保存",{url:s}),{shouldSave:!1,matchedRule:""};if(e.paused)return logger$1.debug("自动保存功能已暂停，不会自动保存",{url:s}),{shouldSave:!1,matchedRule:""};const n=e.websites.filter(u=>u.enabled);if(logger$1.debug("获取启用的规则",{url:s,enabledRulesCount:n.length,rules:n.map(u=>u.pattern)}),n.length===0)return logger$1.debug("没有启用的规则，不会自动保存",{url:s}),{shouldSave:!1,matchedRule:""};logger$1.debug("开始按优先级检查规则",{url:s});const r=n.filter(u=>u.pattern.startsWith("!"));logger$1.debug("检查排除规则",{url:s,excludeRulesCount:r.length});for(const u of r){const f=u.pattern.substring(1);if(logger$1.debug(`检查排除规则: ${s} 与 ${f}`),isUrlMatchPattern(s,f))return logger$1.info(`URL ${s} 匹配排除规则 ${u.pattern}，不会自动保存`),{shouldSave:!1,matchedRule:u.pattern}}const a=n.filter(u=>!u.pattern.startsWith("!")&&!u.pattern.includes("*"));logger$1.debug("检查精确匹配规则",{url:s,exactRulesCount:a.length});for(const u of a)if(logger$1.debug(`检查精确规则: ${s} 与 ${u.pattern}`),isUrlMatchPattern(s,u.pattern))return logger$1.info(`URL ${s} 匹配精确规则 ${u.pattern}，将自动保存`),{shouldSave:!0,matchedRule:u.pattern};const i=n.filter(u=>!u.pattern.startsWith("!")&&u.pattern.includes("*"));logger$1.debug("检查通配符规则",{url:s,wildcardRulesCount:i.length});for(const u of i)if(logger$1.debug(`检查通配符规则: ${s} 与 ${u.pattern}`),isUrlMatchPattern(s,u.pattern))return logger$1.info(`URL ${s} 匹配通配符规则 ${u.pattern}，将自动保存`),{shouldSave:!0,matchedRule:u.pattern};return logger$1.debug(`URL ${s} 不匹配任何规则，不会自动保存`),{shouldSave:!1,matchedRule:""}}catch(s){return logger$1.error("检查URL是否应该自动保存时出错:",s),{shouldSave:!1,matchedRule:""}}},shouldAutoSaveUrl=async(t,e)=>(await shouldAutoSaveUrlWithRule(t,e)).shouldSave,isUrlAlreadySaved=async t=>{try{return(await getAllSavedPages({searchText:t})).some(s=>s.url===t)}catch(e){return logger$1.error("检查URL是否已保存时出错:",e),!1}},isMaxPageLimitReached=async t=>{try{return t||(t=await storage.get(STORAGE_KEY)),!t||!t.maxPages?!1:(await getAllSavedPages()).length>=t.maxPages}catch(e){return logger$1.error("检查最大页面数量限制时出错:",e),!1}},autoSavePage=async t=>{try{const e=saveTasks.get(t);e&&(e.status="saving",e.steps||(e.steps=[]),e.steps.push({step:"初始化",timestamp:Date.now(),status:"in_progress",message:"开始保存页面"}),saveTasks.set(t,e),await persistTasks());const s=await browser.tabs.get(t),n=s.url,r=s.title||"";if(!n||n.startsWith("chrome://")||n.startsWith("edge://")||n.startsWith("about:")){logger$1.debug("跳过保存浏览器内部页面:",n),e&&(e.status="failed",e.error="无法保存浏览器内部页面",e.steps?.push({step:"验证URL",timestamp:Date.now(),status:"failed",message:"无法保存浏览器内部页面"}),saveTasks.set(t,e),await persistTasks());return}if(await isUrlAlreadySaved(n)){logger$1.info(`URL已经保存过，跳过自动保存: ${n}`),e&&(e.status="completed",e.steps?.push({step:"检查URL是否已保存",timestamp:Date.now(),status:"success",message:"URL已经保存过，跳过重复保存"}),saveTasks.set(t,e),await persistTasks());const h=(await getAllSavedPages({searchText:n})).find(m=>m.url===n);if(h)return h;logger$1.warn(`URL已存在但未找到精确匹配的页面，将继续保存流程: ${n}`)}const i=await storage.get(STORAGE_KEY);if(logger$1.debug("检查URL是否应该自动保存",{url:n,title:r,enabled:i?.enabled,paused:i?.paused}),!i||!i.enabled){logger$1.debug("自动保存功能未启用，跳过自动保存:",n),e&&(e.status="failed",e.error="自动保存功能未启用",e.steps?.push({step:"检查设置",timestamp:Date.now(),status:"failed",message:"自动保存功能未启用"}),saveTasks.set(t,e),await persistTasks());return}if(i.paused){logger$1.debug("自动保存功能已暂停，跳过自动保存:",n),e&&(e.status="failed",e.error="自动保存功能已暂停",e.steps?.push({step:"检查设置",timestamp:Date.now(),status:"failed",message:"自动保存功能已暂停"}),saveTasks.set(t,e),await persistTasks());return}if(e&&(e.steps?.push({step:"检查设置",timestamp:Date.now(),status:"success",message:"自动保存功能已启用"}),saveTasks.set(t,e),await persistTasks()),!await shouldAutoSaveUrl(n,i)){logger$1.debug("URL不符合自动保存规则，跳过自动保存:",n),e&&(e.status="failed",e.error="URL不符合自动保存规则",e.steps?.push({step:"检查URL规则",timestamp:Date.now(),status:"failed",message:"URL不符合自动保存规则"}),saveTasks.set(t,e),await persistTasks());return}if(e&&(e.steps?.push({step:"检查URL规则",timestamp:Date.now(),status:"success",message:"URL符合自动保存规则"}),saveTasks.set(t,e),await persistTasks()),await isMaxPageLimitReached(i)){logger$1.warn(`已达到最大保存页面数量限制(${i?.maxPages}页)，跳过自动保存:`,n),e&&(e.status="failed",e.error=`已达到最大保存页面数量限制(${i?.maxPages}页)`,e.steps?.push({step:"检查页面数量限制",timestamp:Date.now(),status:"failed",message:`已达到最大保存页面数量限制(${i?.maxPages}页)`}),saveTasks.set(t,e),await persistTasks());return}e&&(e.steps?.push({step:"检查页面数量限制",timestamp:Date.now(),status:"success",message:"未达到最大保存页面数量限制"}),saveTasks.set(t,e),await persistTasks()),e&&(e.steps?.push({step:"保存页面",timestamp:Date.now(),status:"in_progress",message:"正在保存页面内容"}),saveTasks.set(t,e),await persistTasks());const c=await saveCurrentPage({tags:["auto-save"],notes:e?.sourceInfo||"自动保存的页面",title:r,tabId:t,source:e?.source||"auto_rule",sourceInfo:e?.sourceInfo});return logger$1.info("自动保存页面成功:",n),e&&(e.status="completed",e.steps?.push({step:"保存页面",timestamp:Date.now(),status:"success",message:"页面保存成功"}),saveTasks.set(t,e),await persistTasks()),c}catch(e){logger$1.error("自动保存页面失败:",e);const s=saveTasks.get(t);throw s&&(s.status="failed",s.error=e instanceof Error?e.message:String(e),s.steps?.push({step:"保存页面",timestamp:Date.now(),status:"failed",message:e instanceof Error?e.message:String(e)}),saveTasks.set(t,s),await persistTasks()),e}},setupAutoSaveTask=async(t,e,s="auto_rule",n)=>{try{const r=await storage.get(STORAGE_KEY);if(!r||!r.enabled||r.paused){logger$1.debug("自动保存功能未启用或已暂停，不设置任务");return}const a=await browser.tabs.get(t),i=a.url||"",u=a.title||"";if(logger$1.debug(`setupAutoSaveTask: 为标签页 ${t} 设置自动保存任务`,{url:i,title:u,source:s,sourceInfo:n}),!i){logger$1.debug(`标签页 ${t} 没有URL，不设置任务`);return}if(i.startsWith("chrome://")||i.startsWith("chrome-extension://")||i.startsWith("edge://")||i.startsWith("about:")||i.startsWith("moz-extension://")||i.startsWith("firefox:")||i.startsWith("brave:")){logger$1.debug(`标签页 ${t} 是浏览器内部页面，不设置任务`,{url:i}),await recordFilteredUrl(t,i,u,"浏览器内部页面",s,n||"浏览器内部页面不允许保存");return}if(await isUrlAlreadySaved(i)){logger$1.debug(`URL ${i} 已经保存过，不再设置任务`),await recordFilteredUrl(t,i,u,"页面已保存",s,n||"页面已经存在于保存列表中");return}if(await isMaxPageLimitReached(r)){logger$1.debug(`已达到最大保存页面数量限制 (${r.maxPages})，不设置任务`),await recordFilteredUrl(t,i,u,"达到最大保存数量",s,n||`已达到最大保存页面数量限制 (${r.maxPages})`);return}const{shouldSave:d,matchedRule:h}=await shouldAutoSaveUrlWithRule(i,r);if(!d){logger$1.debug(`URL ${i} 不符合自动保存规则，不设置任务`),await recordFilteredUrl(t,i,u,"不符合保存规则",s,n||(h?`匹配排除规则: ${h}`:"不匹配任何包含规则"));return}const m=r.saveDelay||1,_=m*60*1e3;await clearAutoSaveTask(t);const p=setTimeout(async()=>{try{const A=saveTasks.get(t);A&&(A.status="saving",saveTasks.set(t,A),await persistTasks());const T=await browser.tabs.get(t),v=T.url||"",N=T.title||"";await autoSavePage(t);const x=saveTasks.get(t);x&&(x.status="completed",saveTasks.set(t,x),await persistTasks()),logger$1.info(`自动保存任务成功完成: ${N} (${v})`)}catch(A){logger$1.error("自动保存任务执行失败:",A);const T=saveTasks.get(t);T&&(T.status="failed",T.error=A instanceof Error?A.message:String(A),saveTasks.set(t,T),await persistTasks())}},e?0:_),b={tabId:t,url:i,title:u,timeoutId:p,createdAt:Date.now(),scheduledAt:Date.now()+_,status:"waiting",matchedRule:h||void 0,source:s,sourceInfo:n};saveTasks.set(t,b),await persistTasks(),logger$1.info(`设置了自动保存任务: ${u} (${i}), 将在 ${m} 分钟后保存`)}catch(r){logger$1.error("设置自动保存任务失败:",r)}},recordFilteredUrl=async(t,e,s,n,r="unknown",a)=>{try{const i={tabId:t,url:e,title:s,timeoutId:-1,createdAt:Date.now(),scheduledAt:Date.now(),status:"waiting",source:r,sourceInfo:a};saveTasks.set(t,i),await persistTasks(),logger$1.debug(`记录了被过滤的URL: ${s} (${e}), 原因: ${n}`)}catch(i){logger$1.error("记录被过滤的URL失败:",i)}},clearAutoSaveTask=async t=>{const e=saveTasks.get(t);if(e){if(typeof e.timeoutId=="number"&&e.timeoutId>0)clearTimeout(e.timeoutId);else if(e.timeoutId)try{clearTimeout(e.timeoutId)}catch(s){logger$1.error(`清除定时器失败: ${s}`)}saveTasks.delete(t),logger$1.debug(`已清除标签页 ${t} 的自动保存任务`);try{const s=await storage.get(TASKS_STORAGE_KEY);s&&s.tasks&&(s.tasks=s.tasks.filter(n=>n.tabId!==t||n.filtered),s.lastUpdated=Date.now(),await storage.set(TASKS_STORAGE_KEY,s),logger$1.debug(`已从持久化存储中删除标签页 ${t} 的自动保存任务`))}catch(s){logger$1.error(`从持久化存储中删除标签页 ${t} 的自动保存任务失败:`,s)}}},persistTasks=async()=>{try{const t=[];for(const[r,a]of saveTasks.entries()){const i=a.timeoutId===-1,u={tabId:a.tabId,url:a.url,title:a.title,createdAt:a.createdAt,scheduledAt:a.scheduledAt,status:a.status,error:a.error,matchedRule:a.matchedRule,filtered:i,filterReason:i?a.sourceInfo||"未知原因":void 0,source:a.source,sourceInfo:a.sourceInfo};t.push(u)}const e=await storage.get(TASKS_STORAGE_KEY);let s=[];e&&e.tasks&&(s=e.tasks.filter(r=>(r.status==="completed"||r.status==="failed")&&!saveTasks.has(r.tabId)));const n={tasks:[...t,...s],lastUpdated:Date.now(),version:"1.2"};await storage.set(TASKS_STORAGE_KEY,n),logger$1.debug(`保存了 ${t.length} 个当前任务和 ${s.length} 个历史任务到持久化存储`)}catch(t){logger$1.error("保存任务到持久化存储失败:",t)}},loadTasks=async()=>{try{const t=await storage.get(TASKS_STORAGE_KEY);if(!t||!t.tasks){logger$1.debug("存储中没有保存的任务状态");return}const e=t.tasks.filter(s=>!s.filtered);logger$1.info(`从存储加载了 ${e.length} 个自动保存任务`),saveTasks.forEach((s,n)=>{const r=saveTasks.get(n);if(r&&r.timeoutId)try{typeof r.timeoutId=="number"&&r.timeoutId>0,clearTimeout(r.timeoutId)}catch{}}),saveTasks.clear();for(const s of e)try{const n=await browser.tabs.get(s.tabId);if(!n||!n.url)continue;s.status==="waiting"&&s.scheduledAt>Date.now()?setupAutoSaveTask(s.tabId,s):s.status==="waiting"&&s.scheduledAt<=Date.now()&&autoSavePage(s.tabId)}catch{logger$1.debug(`标签页 ${s.tabId} 不存在，忽略恢复任务`,{url:s.url})}}catch(t){logger$1.error("从存储加载任务状态失败:",t)}},checkAllTabs=async()=>{try{const t=await storage.get(STORAGE_KEY);if(t?.enabled&&!t.paused){const e=await browser.tabs.query({});logger$1.info(`检查所有标签页，共 ${e.length} 个标签页`);for(const s of e)s.id&&await setupAutoSaveTask(s.id)}}catch(t){logger$1.error("检查所有标签页时出错:",t)}},manualCheckAllTabs=async()=>{try{const t=await browser.tabs.query({});let e=0,s=0,n=0;const r=await storage.get(STORAGE_KEY);if(!r||!r.enabled||r.paused)return{checked:0,setup:0,filtered:0};for(const a of t){if(!a.id||!a.url)continue;e++,(await shouldAutoSaveUrlWithRule(a.url,r)).shouldSave?(await setupAutoSaveTask(a.id),s++):(await recordFilteredUrl(a.id,a.url,a.title||"","手动检查：不匹配任何规则"),n++)}return{checked:e,setup:s,filtered:n}}catch(t){return logger$1.error("手动检查所有标签页时出错:",t),{checked:0,setup:0,filtered:0}}},startHeartbeat=()=>{heartbeatIntervalId&&clearInterval(heartbeatIntervalId),heartbeatIntervalId=setInterval(()=>{const t=Date.now(),e=t-lastHeartbeat;e>HEARTBEAT_INTERVAL*2&&(logger$1.info("检测到可能的系统休眠，重新初始化自动保存功能",{timeSinceLastHeartbeat:Math.floor(e/1e3)+"秒"}),loadTasks().then(()=>{checkAllTabs()})),lastHeartbeat=t},HEARTBEAT_INTERVAL),logger$1.debug("已启动自动保存心跳检查机制")},updateAutoSaveStatus=async t=>{try{const e=await storage.get(STORAGE_KEY);!e||!e.enabled?(browser.action.setBadgeText({text:"OFF"}),browser.action.setBadgeBackgroundColor({color:"#F44336"}),browser.action.setTitle({title:"自动保存功能已禁用"})):e.paused?(browser.action.setBadgeText({text:"PAUSE"}),browser.action.setBadgeBackgroundColor({color:"#FFC107"}),browser.action.setTitle({title:"自动保存功能已暂停"})):(browser.action.setBadgeText({text:"ON"}),browser.action.setBadgeBackgroundColor({color:"#4CAF50"}),browser.action.setTitle({title:"自动保存功能已启用"})),t&&browser.action.setBadgeText({text:t})}catch(e){logger$1.error("更新自动保存状态指示器失败:",e)}},initAutoSave=()=>{loadTasks().then(()=>{logger$1.info("已从存储加载自动保存任务状态")}),startHeartbeat(),updateAutoSaveStatus(),browser.tabs.onUpdated.addListener((t,e,s)=>{e.status==="complete"&&s.url&&(setupAutoSaveTask(t),lastHeartbeat=Date.now())}),browser.tabs.onRemoved.addListener(t=>{clearAutoSaveTask(t),lastHeartbeat=Date.now()}),storage.watch({[STORAGE_KEY]:async t=>{const e=t?.newValue,s=t?.oldValue;if(logger$1.debug("自动保存设置已变更",{oldEnabled:s?.enabled,oldPaused:s?.paused,newEnabled:e?.enabled,newPaused:e?.paused}),updateAutoSaveStatus(),e?.enabled&&!e.paused&&(!s||!s.enabled||s.paused)){const n=await browser.tabs.query({});logger$1.info(`自动保存功能已启用或恢复，为 ${n.length} 个标签页设置自动保存任务`);for(const r of n)r.id&&await setupAutoSaveTask(r.id)}if(s?.enabled&&(!e||!e.enabled)||s?.enabled&&!s.paused&&e?.enabled&&e.paused){const n=saveTasks.size;logger$1.info(`清除所有自动保存任务，共 ${n} 个任务`);for(const r of Array.from(saveTasks.values()))await clearAutoSaveTask(r.tabId);e?.paused?logger$1.info("自动保存功能已暂停，所有保存任务已清除"):logger$1.info("自动保存功能已禁用，所有保存任务已清除")}}}),browser.runtime.onStartup.addListener(()=>{logger$1.info("浏览器启动，初始化自动保存功能"),loadTasks().then(()=>{checkAllTabs()})}),browser.runtime.onInstalled.addListener(()=>{logger$1.info("扩展安装或更新，初始化自动保存功能"),loadTasks().then(()=>{checkAllTabs()})}),(async()=>{try{const t=await storage.get(STORAGE_KEY);if(t?.enabled&&!t.paused){const e=await browser.tabs.query({});logger$1.info(`初始化自动保存功能，为 ${e.length} 个标签页检查自动保存规则`);for(const s of e)s.id&&await setupAutoSaveTask(s.id)}}catch(t){logger$1.error("初始化自动保存任务时出错:",t)}})(),logger$1.info("自动保存功能已初始化")};var StatusType=(t=>(t.SUCCESS="success",t.ERROR="error",t.INFO="info",t.WARNING="warning",t))(StatusType||{});const showStatusNotification=(t,e,s="info")=>{browser.notifications.create({type:"basic",iconUrl:browser.runtime.getURL("assets/icon-128.png"),title:t,message:e})},showSaveProgress=(t,e)=>{let s="info";t.includes("错误")?s="error":t.includes("完成")?s="success":(t.includes("等待")||t.includes("队列"))&&(s="warning");const n=`保存页面 - ${t}`;showStatusNotification(n,e,s)},showSaveSuccess=t=>{showStatusNotification("页面已保存",`已成功保存页面: ${t}`,"success")},showSaveError=t=>{showStatusNotification("保存页面失败",`无法保存当前页面: ${t}`,"error")},showNotification=(t,e,s="info")=>{showStatusNotification(t,e,s)},statusIndicator={showStatusNotification,showSaveSuccess,showSaveError,showSaveProgress,showNotification,StatusType},updateSaveStatus=(t,e,s,n)=>{setBadgeText({text:t}),setBadgeBackgroundColor({color:e}),setBadgeTextColor({color:"#FFFFFF"});let r=n||"";if(s&&(r=`${s}: ${r}`),setTitle({title:r}),s&&n){let a=n;if(t.includes("/")){const[i,u]=t.split("/").map(Number);if(!isNaN(i)&&!isNaN(u)&&u>0){const f=Math.round(i/u*100);a=`${a} (${f}%)`}}statusIndicator.showSaveProgress(s,a)}(t==="✓"||t==="✗")&&setTimeout(()=>{setBadgeText({text:""}),setTitle({title:""})},5e3)},saveCurrentPage=async t=>{logger$1.info("开始保存当前页面",t),updateSaveStatus("...","#3498db","准备中","正在初始化保存过程...");try{logger$1.debug("正在获取页面内容",t?.tabId?{tabId:t.tabId}:{}),updateSaveStatus("1/3","#3498db","第1步","正在获取页面内容...");let e;if(t?.tabId?e=await getDataFromSpecificTab(t.tabId).catch(S=>{throw logger$1.error("获取指定标签页内容失败",{tabId:t.tabId,error:S}),updateSaveStatus("✗","#e74c3c","错误",`获取页面内容失败: ${S.message||"未知错误"}`),new Error(`获取页面内容失败: ${S.message||"未知错误"}`)}):e=await getDataFromCurrentTab().catch(S=>{throw logger$1.error("获取页面内容失败",S),updateSaveStatus("✗","#e74c3c","错误",`获取页面内容失败: ${S.message||"未知错误"}`),new Error(`获取页面内容失败: ${S.message||"未知错误"}`)}),!e)throw logger$1.error("获取页面内容返回空结果"),updateSaveStatus("✗","#e74c3c","错误","获取页面内容返回空结果"),new Error("获取页面内容返回空结果");const{url:s,title:n,content:r,type:a,pdf:i,favicon:u}=e;if(logger$1.info("成功获取页面内容",{url:s,title:n,contentLength:r?.length,type:a}),await isUrlAlreadySaved(s)){logger$1.info("URL已经存在，跳过保存:",s),updateSaveStatus("✓","#2ecc71","完成","页面已存在，跳过重复保存！"),statusIndicator.showNotification("页面已存在","该URL已经保存过，跳过重复保存",statusIndicator.StatusType.INFO);const D=(await getAllSavedPages({searchText:s})).find(F=>F.url===s);if(D)return D;logger$1.warn("URL已存在但未找到精确匹配的页面，将继续保存流程:",s)}logger$1.debug("正在获取页面截图",t?.tabId?{tabId:t.tabId}:{}),updateSaveStatus("2/3","#3498db","第2步","正在获取页面截图...");let c;t?.tabId?c=await getScreenshotFromSpecificTab(t.tabId).catch(S=>{const D=S instanceof Error?S.message:String(S);return D.includes("MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND")?(logger$1.warn("截图请求超过配额限制，已加入队列处理",{tabId:t.tabId,error:D}),updateSaveStatus("2/3","#f39c12","第2步","截图请求已加入队列，正在等待处理..."),{success:!1,screenshot:void 0,error:D,isQuotaError:!0}):(logger$1.error("获取页面截图失败",{tabId:t.tabId,error:S}),{success:!1,screenshot:void 0,error:D})}):c=await getScreenshotFromCurrentTab().catch(S=>{const D=S instanceof Error?S.message:String(S);return D.includes("MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND")?(logger$1.warn("截图请求超过配额限制，已加入队列处理",{error:D}),updateSaveStatus("2/3","#f39c12","第2步","截图请求已加入队列，正在等待处理..."),{success:!1,screenshot:void 0,error:D,isQuotaError:!0}):(logger$1.error("获取页面截图失败",S),{success:!1,screenshot:void 0,error:D})});const{success:d,screenshot:h,error:m,isQuotaError:_}=c;d?logger$1.info("成功获取页面截图",{screenshotLength:h?.length}):_?(logger$1.warn("截图请求已加入队列，但当前保存操作将继续进行",{error:m}),statusIndicator.showNotification("截图请求已加入队列","由于浏览器限制，截图请求已加入队列。页面将保存，但可能不包含截图。")):logger$1.warn("获取页面截图失败，将继续保存页面",m),logger$1.debug("正在使用LLM生成摘要和关键词");let p="",b=[],A=0;try{const S=await generateSummary(r,n,s);p=S.summary,b=S.keywords,A=S.rating,logger$1.info("成功生成摘要和关键词",{summaryLength:p.length,tagsCount:b.length,rating:A})}catch(S){if(S instanceof Error&&S.message.includes("未选择模型")){logger$1.warn("未选择LLM模型，将打开侧边栏让用户配置",S);try{throw await browser.runtime.sendMessage({type:"open_sidebar_for_model_config"}),updateSaveStatus("✗","#e74c3c","错误","请先在侧边栏中配置LLM模型，然后再尝试保存页面"),new Error("请先在侧边栏中配置LLM模型，然后再尝试保存页面")}catch(D){throw logger$1.error("发送打开侧边栏消息失败",D),updateSaveStatus("✗","#e74c3c","错误","未选择LLM模型，请先配置模型后再尝试保存页面"),new Error("未选择LLM模型，请先配置模型后再尝试保存页面")}}logger$1.warn("生成摘要和关键词失败，将继续保存页面",S)}logger$1.debug("正在保存页面到数据库"),updateSaveStatus("3/3","#3498db","第3步","正在保存页面到数据库...");const T=t?.title||n;let v=b||[];t?.tags&&t.tags.length>0&&(v=[...new Set([...v,...t.tags])]);const N=t?.notes||"",x=t?.sourceInfo?`

Source: ${t?.sourceInfo}`:"",y=await savedPagesDB.savePage({url:s,title:T,content:r,html:i||"",type:a,tags:v,notes:N+x,summary:p,rating:A,favicon:u});return logger$1.info("页面保存成功",{id:y.id,url:s,title:T}),updateSaveStatus("✓","#2ecc71","完成","页面保存成功！"),statusIndicator.showSaveSuccess(T),y}catch(e){const s=e instanceof Error?e.message:String(e);throw logger$1.error("保存页面失败",{error:s}),updateSaveStatus("✗","#e74c3c","错误",`保存页面失败: ${s}`),statusIndicator.showSaveError(s),e}},getAllSavedPages=async t=>{try{return await savedPagesDB.getAllPages({tags:t?.tags,searchText:t?.searchText,limit:t?.limit,offset:t?.offset})}catch(e){throw console.error("获取保存的页面失败:",e),new Error("获取保存的页面失败")}},getAllStorageData=async()=>new Promise(t=>{chrome.storage.local.get(null,e=>{chrome.runtime.lastError?(logger$1.error("获取存储数据失败",chrome.runtime.lastError),t({})):(logger$1.info("成功获取存储数据",{keysCount:Object.keys(e).length}),t(e))})}),getStorageItem=async t=>new Promise(e=>{chrome.storage.local.get(t,s=>{chrome.runtime.lastError?(logger$1.error(`获取存储项 ${t} 失败`,chrome.runtime.lastError),e(void 0)):(logger$1.info(`成功获取存储项 ${t}`,{value:s[t]}),e(s[t]))})}),watchStorageChanges=t=>{const e=(s,n)=>{n==="local"&&(logger$1.debug("检测到存储变化",{changedKeys:Object.keys(s)}),t(s))};return chrome.storage.onChanged.addListener(e),()=>{chrome.storage.onChanged.removeListener(e)}},logStorageData=async t=>{const e=await getAllStorageData();if(t){const s={};Object.keys(e).forEach(n=>{n.includes(t)&&(s[n]=e[n])}),logger$1.info(`存储数据 (过滤: ${t})`,s),console.table(s)}else logger$1.info("所有存储数据",e),console.table(e)},storageViewer={getAllStorageData,getStorageItem,watchStorageChanges,logStorageData},initDebugCommands=()=>{const t={storage:{getAll:async()=>{const e=await storageViewer.getAllStorageData();return console.log("所有存储数据:",e),e},get:async e=>{const s=await storageViewer.getStorageItem(e);return console.log(`存储项 ${e}:`,s),s},log:async e=>{await storageViewer.logStorageData(e)}},logger:{setLevel:e=>{const s={debug:0,info:1,warn:2,error:3,none:4};logger$1.setLogLevel(s[e]),console.log(`日志级别已设置为: ${e}`)}},openDebugPage:()=>{chrome.tabs.create({url:chrome.runtime.getURL("pages/debug.html")})}};try{globalThis.pageAssistDebug=t,logger$1.info("调试命令已初始化，可在控制台中使用 pageAssistDebug 对象")}catch(e){logger$1.error("初始化调试命令失败",e)}};async function getDocument(t,e){return{data:null}}async function getDocuments(t){return{data:[]}}async function getModel(t,e){return{data:null}}async function getModels(t){return{data:[]}}async function getMessage(t,e){return{data:null}}async function getMessages(t){return{data:[]}}const SERVICE_NAME="DataProviderAPI";function initDataProviderAPI(){chrome.runtime.onMessageExternal.hasListener(externalApiRequestListener)?logger$1.warn(`[${SERVICE_NAME}] External API request listener already registered.`):(chrome.runtime.onMessageExternal.addListener(externalApiRequestListener),logger$1.info(`[${SERVICE_NAME}] External API request listener registered.`));const t=typeof self<"u"?self:typeof window<"u"?window:global;t&&(t.handleDataProviderRequest=handleDataProviderRequest,logger$1.debug(`[${SERVICE_NAME}] API handler exposed to global scope for debugging.`))}function externalApiRequestListener(t,e,s){if(logger$1.debug(`[${SERVICE_NAME}] Received external request`,{sender:e,request:t}),!t||typeof t.type!="string"||typeof t.entityType!="string")return logger$1.error(`[${SERVICE_NAME}] Invalid request structure:`,t),s({success:!1,error:{code:"invalid_request",message:"Invalid request structure. 'type' and 'entityType' are required."},meta:{serverTime:Date.now()}}),!1;const n=t;return(async()=>{try{const r=await handleDataProviderRequest(n,e);s(r)}catch(r){logger$1.error(`[${SERVICE_NAME}] Unhandled error processing request:`,r),s({success:!1,error:{code:"internal_error",message:r.message||"An unexpected error occurred."},meta:{serverTime:Date.now()}})}})(),!0}async function handleDataProviderRequest(t,e){const s=await getDataProviderConfig(),n={serverTime:Date.now(),clientId:t.clientId};if(!s.enabled)return logger$1.warn(`[${SERVICE_NAME}] API is disabled. Rejecting request.`),{success:!1,error:{code:"api_disabled",message:"Data Provider API is disabled."},meta:n};if(typeof t.accessToken!="string"||!await validateAccessToken(t.accessToken))return logger$1.warn(`[${SERVICE_NAME}] Invalid access token. Rejecting request.`),{success:!1,error:{code:"auth_invalid_token",message:"Invalid access token."},meta:n};if(!s.filters.allowedEntityTypes.includes(t.entityType))return logger$1.warn(`[${SERVICE_NAME}] Entity type '${t.entityType}' not allowed. Rejecting request.`),{success:!1,error:{code:"entity_type_not_allowed",message:`Access to entity type '${t.entityType}' is not allowed.`},meta:n};switch(s.logging.enabled&&logger$1.info(`[${SERVICE_NAME}] Processing request for entity '${t.entityType}', type '${t.type}' from sender '${e.id||e.url||"unknown"}`),t.entityType){case"page":return handlePageRequest(t,s);case"document":return handleDocumentRequest(t,s);case"model":return handleModelRequest(t,s);case"knowledge":return handleKnowledgeRequest(t);case"vector":return handleVectorRequest(t);case"message":return handleMessageRequest(t,s);default:return logger$1.warn(`[${SERVICE_NAME}] Unsupported entity type: '${t.entityType}'`),{success:!1,error:{code:"unsupported_entity_type",message:`Entity type '${t.entityType}' is not supported.`},meta:n}}}async function handlePageRequest(t,e){const s=new SavedPagesDB,n={serverTime:Date.now(),clientId:t.clientId};try{switch(t.type){case"get":{if(typeof t.id!="string"||!t.id)return{success:!1,error:{code:"invalid_request",message:"'id' is required and must be a string for 'get' requests."},meta:n};const r=await s.getPageById(t.id);return r?{success:!0,data:filterPageContent(r,e),meta:n}:{success:!1,error:{code:"entity_not_found",message:`Page with id '${t.id}' not found.`},meta:n}}case"list":{const{filter:r,page:a=1,pageSize:i=e.sync.batchSize||10,sort:u,search:f,fields:c}=t.query||{},d=Number(a),h=Number(i),m=await s.getAllPages({filter:r,page:d,pageSize:h,sort:u,search:f}),_=await s.getPageCount(r),p=Math.ceil(_/h);return{success:!0,data:m.map(A=>filterPageContent(A,e,c)),meta:{...n,total:_,page:d,pageSize:h,pageCount:p}}}case"count":{const{filter:r}=t.query||{};return{success:!0,data:{count:await s.getPageCount(r)},meta:n}}case"sync":{const{lastSyncTime:r,fullSync:a,maxRecords:i=e.sync.batchSize}=t.sync||{},u=Number(i),f=Number(r)||0;if(typeof s.getPagesForSync!="function")return logger$1.error(`[${SERVICE_NAME}] db.getPagesForSync is not implemented!`),{success:!1,error:{code:"not_implemented",message:"Sync functionality (getPagesForSync) is not implemented in DB."},meta:n};const d=(await s.getPagesForSync(a?0:f,u)).map(h=>({id:h.id,entityType:"page",changeType:h.createdAt&&h.updatedAt&&h.createdAt===h.updatedAt?"create":"update",timestamp:h.updatedAt,data:filterPageContent(h,e)}));return{success:!0,data:{changes:d},meta:{...n,syncTime:Date.now(),hasMore:d.length>=u}}}case"changes":{const{lastSyncTime:r,maxRecords:a=e.sync.batchSize}=t.sync||{},i=Number(a),u=Number(r)||0;if(typeof s.getPagesForSync!="function")return logger$1.error(`[${SERVICE_NAME}] db.getPagesForSync is not implemented for 'changes' tracking!`),{success:!1,error:{code:"not_implemented",message:"Changes tracking (getPagesForSync) is not implemented in DB."},meta:n};const c=(await s.getPagesForSync(u,i,!0)).map(d=>({id:d.id,entityType:"page",changeType:d.createdAt&&d.updatedAt&&d.createdAt===d.updatedAt?"create":"update",timestamp:d.updatedAt}));return{success:!0,data:{changes:c},meta:{...n,syncTime:Date.now(),hasMore:c.length>=i}}}default:return logger$1.warn(`[${SERVICE_NAME}] Unsupported request type '${t.type}' for 'page' entity.`),{success:!1,error:{code:"unsupported_request_type",message:`Request type '${t.type}' not supported for 'page' entity.`},meta:n}}}catch(r){return logger$1.error(`[${SERVICE_NAME}] Error processing 'page' request:`,r),{success:!1,error:{code:"internal_db_error",message:r.message||"Database operation failed."},meta:n}}}function filterPageContent(t,e,s){let n={...t};if(e.filters.allowFullContent||(delete n.content,delete n.html,delete n.textContent),s&&s.length>0){const r={};t.id&&!s.includes("-id")&&(r.id=t.id);for(const a of s)a.startsWith("-")||a in n&&(r[a]=n[a]);return r}return n}async function handleDocumentRequest(t,e){const s={serverTime:Date.now(),clientId:t.clientId};try{switch(t.type){case"get":{if(typeof t.id!="string"||!t.id)return{success:!1,error:{code:"invalid_request",message:"'id' is required and must be a string for 'get' requests."},meta:s};const n=await getDocument(t.id,t.query?.fields);return n.data?{success:!0,data:n.data,meta:s}:{success:!1,error:{code:"entity_not_found",message:`Document with id '${t.id}' not found.`},meta:s}}case"list":{const{filter:n,page:r=1,pageSize:a=e.sync.batchSize||10,sort:i,search:u,fields:f}=t.query||{},c=await getDocuments({filter:n,page:r,pageSize:a,sort:i,search:u,fields:f});return{success:!0,data:c.data,meta:{...s,...c.meta}}}case"count":return{success:!1,error:{code:"not_implemented",message:"Document count functionality is not implemented yet."},meta:s};case"sync":case"changes":return{success:!1,error:{code:"not_implemented",message:`Document ${t.type} functionality is not implemented yet.`},meta:s};default:return{success:!1,error:{code:"unsupported_request_type",message:`Request type '${t.type}' not supported for 'document' entity.`},meta:s}}}catch(n){return logger$1.error(`[${SERVICE_NAME}] Error processing 'document' request:`,n),{success:!1,error:{code:"internal_error",message:n.message||"An error occurred while processing the document request."},meta:s}}}async function handleModelRequest(t,e){const s={serverTime:Date.now(),clientId:t.clientId};try{switch(t.type){case"get":{if(typeof t.id!="string"||!t.id)return{success:!1,error:{code:"invalid_request",message:"'id' is required and must be a string for 'get' requests."},meta:s};const n=await getModel(t.id,t.query?.fields);return n.data?{success:!0,data:n.data,meta:s}:{success:!1,error:{code:"entity_not_found",message:`Model with id '${t.id}' not found.`},meta:s}}case"list":{const{filter:n,page:r=1,pageSize:a=e.sync.batchSize||10,sort:i,search:u,fields:f}=t.query||{},c=await getModels({filter:n,page:r,pageSize:a,sort:i,search:u,fields:f});return{success:!0,data:c.data,meta:{...s,...c.meta}}}case"count":case"sync":case"changes":return{success:!1,error:{code:"not_implemented",message:`Model ${t.type} functionality is not implemented yet.`},meta:s};default:return{success:!1,error:{code:"unsupported_request_type",message:`Request type '${t.type}' not supported for 'model' entity.`},meta:s}}}catch(n){return logger$1.error(`[${SERVICE_NAME}] Error processing 'model' request:`,n),{success:!1,error:{code:"internal_error",message:n.message||"An error occurred while processing the model request."},meta:s}}}async function handleKnowledgeRequest(t,e){const s={serverTime:Date.now(),clientId:t.clientId};try{return{success:!1,error:{code:"not_implemented",message:`Knowledge base ${t.type} functionality is not implemented yet.`},meta:s}}catch(n){return logger$1.error(`[${SERVICE_NAME}] Error processing 'knowledge' request:`,n),{success:!1,error:{code:"internal_error",message:n.message||"An error occurred while processing the knowledge request."},meta:s}}}async function handleVectorRequest(t,e){const s={serverTime:Date.now(),clientId:t.clientId};try{return{success:!1,error:{code:"not_implemented",message:`Vector ${t.type} functionality is not implemented yet.`},meta:s}}catch(n){return logger$1.error(`[${SERVICE_NAME}] Error processing 'vector' request:`,n),{success:!1,error:{code:"internal_error",message:n.message||"An error occurred while processing the vector request."},meta:s}}}async function handleMessageRequest(t,e){const s={serverTime:Date.now(),clientId:t.clientId};try{switch(t.type){case"get":{if(typeof t.id!="string"||!t.id)return{success:!1,error:{code:"invalid_request",message:"'id' is required and must be a string for 'get' requests."},meta:s};const n=await getMessage(t.id,t.query?.fields);return n.data?{success:!0,data:n.data,meta:s}:{success:!1,error:{code:"entity_not_found",message:`Message with id '${t.id}' not found.`},meta:s}}case"list":{const{filter:n,page:r=1,pageSize:a=e.sync.batchSize||10,sort:i,search:u,fields:f}=t.query||{},c=await getMessages({filter:n,page:r,pageSize:a,sort:i,search:u,fields:f});return{success:!0,data:c.data,meta:{...s,...c.meta}}}case"count":case"sync":case"changes":return{success:!1,error:{code:"not_implemented",message:`Message ${t.type} functionality is not implemented yet.`},meta:s};default:return{success:!1,error:{code:"unsupported_request_type",message:`Request type '${t.type}' not supported for 'message' entity.`},meta:s}}}catch(n){return logger$1.error(`[${SERVICE_NAME}] Error processing 'message' request:`,n),{success:!1,error:{code:"internal_error",message:n.message||"An error occurred while processing the message request."},meta:s}}}logger$1.info(`[${SERVICE_NAME}] Service module loaded.`);const definition=defineBackground({main(){const t=new g({area:"local"});let e=!1,s="webui",n="sidePanel";const r={webui:"open-web-ui-pa",sidePanel:"open-side-panel-pa"};initDebugCommands(),initAutoSave(),updateAutoSaveStatus(),logger$1.info("截图节流管理器已初始化，将限制截图请求频率以避免超过浏览器配额限制");const a=async()=>{try{try{browser.contextMenus.removeAll(),console.log("已清除所有现有上下文菜单项")}catch(f){console.error("清除上下文菜单时出错:",f)}t.watch({actionIconClick:f=>{const c=f?.oldValue||"webui",d=f?.newValue||"webui";c!==d&&(s=d)},contextMenuClick:f=>{const c=f?.oldValue||"sidePanel",d=f?.newValue||"sidePanel";if(c!==d){n=d;try{browser.contextMenus.remove(r[c]),browser.contextMenus.create({id:r[d],title:i[d],contexts:["page","selection"]})}catch(h){console.error("更新上下文菜单时出错:",h)}}}});const u=await getInitialConfig();n=u.contextMenuClick,s=u.actionIconClick,console.log("开始创建上下文菜单项");try{browser.contextMenus.create({id:r[n],title:i[n],contexts:["page","selection"]}),console.log(`已创建主菜单项: ${r[n]}`)}catch(f){console.error(`创建主菜单项时出错: ${r[n]}`,f)}try{browser.contextMenus.create({id:"summarize-pa",title:browser.i18n.getMessage("contextSummarize"),contexts:["selection"]}),console.log("已创建摘要菜单项")}catch(f){console.error("创建摘要菜单项时出错:",f)}try{browser.contextMenus.create({id:"explain-pa",title:browser.i18n.getMessage("contextExplain"),contexts:["selection"]}),console.log("已创建解释菜单项")}catch(f){console.error("创建解释菜单项时出错:",f)}try{browser.contextMenus.create({id:"rephrase-pa",title:browser.i18n.getMessage("contextRephrase"),contexts:["selection"]}),console.log("已创建改写菜单项")}catch(f){console.error("创建改写菜单项时出错:",f)}try{browser.contextMenus.create({id:"translate-pg",title:browser.i18n.getMessage("contextTranslate"),contexts:["selection"]}),console.log("已创建翻译菜单项")}catch(f){console.error("创建翻译菜单项时出错:",f)}try{browser.contextMenus.create({id:"custom-pg",title:browser.i18n.getMessage("contextCustom"),contexts:["selection"]}),console.log("已创建自定义菜单项")}catch(f){console.error("创建自定义菜单项时出错:",f)}try{browser.contextMenus.create({id:"save-page-pa",title:browser.i18n.getMessage("saveCurrentPage"),contexts:["page"]}),console.log("已创建保存页面菜单项")}catch(f){console.error("创建保存页面菜单项时出错:",f)}try{browser.contextMenus.create({id:"view-saved-pages-pa",title:browser.i18n.getMessage("viewSavedPages"),contexts:["page"]}),console.log("已创建查看已保存网页菜单项")}catch(f){console.error("创建查看已保存网页菜单项时出错:",f)}console.log("所有上下文菜单项创建完成");try{console.log("正在初始化数据同步服务...");const f=syncService.getStatus();console.log(`数据同步服务初始化完成，当前状态: ${f}`)}catch(f){console.error("初始化数据同步服务失败:",f)}try{console.log("正在初始化数据提供者API服务..."),initDataProviderAPI(),console.log("数据提供者API服务初始化完成")}catch(f){console.error("初始化数据提供者API服务失败:",f)}}catch(u){console.error("初始化过程中出错:",u)}};browser.runtime.onMessage.addListener(async u=>{if(u.type==="sidepanel"||u.type==="open_sidebar_for_model_config")await browser.sidebarAction.open();else if(u.type==="pull_model"){const f=await getOllamaURL();await isOllamaRunning()||(setBadgeText({text:"E"}),setBadgeBackgroundColor({color:"#FF0000"}),setTitle({title:"Ollama is not running"}),setTimeout(()=>{clearBadge()},5e3)),await streamDownload(f,u.modelName)}else if(u.type==="check_all_tabs"){const{checked:f,setup:c,filtered:d}=await manualCheckAllTabs();return{checked:f,setup:c,filtered:d}}}),browser.runtime.onConnect.addListener(u=>{u.name==="pgCopilot"&&(e=!0,u.onDisconnect.addListener(()=>{e=!1}))}),chrome.action.onClicked.addListener(u=>{s==="webui"?chrome.tabs.create({url:chrome.runtime.getURL("/options.html")}):chrome.sidePanel.open({tabId:u.id})});const i={webui:browser.i18n.getMessage("openOptionToChat"),sidePanel:browser.i18n.getMessage("openSidePanelToChat")};browser.contextMenus.onClicked.addListener(async(u,f)=>{if(u.menuItemId==="open-side-panel-pa")chrome.sidePanel.open({tabId:f.id});else if(u.menuItemId==="open-web-ui-pa")browser.tabs.create({url:browser.runtime.getURL("/options.html")});else if(u.menuItemId==="summarize-pa")chrome.sidePanel.open({tabId:f.id}),setTimeout(async()=>{await browser.runtime.sendMessage({from:"background",type:"summary",text:u.selectionText})},e?0:5e3);else if(u.menuItemId==="rephrase-pa")chrome.sidePanel.open({tabId:f.id}),setTimeout(async()=>{await browser.runtime.sendMessage({type:"rephrase",from:"background",text:u.selectionText})},e?0:5e3);else if(u.menuItemId==="translate-pg")chrome.sidePanel.open({tabId:f.id}),setTimeout(async()=>{await browser.runtime.sendMessage({type:"translate",from:"background",text:u.selectionText})},e?0:5e3);else if(u.menuItemId==="explain-pa")chrome.sidePanel.open({tabId:f.id}),setTimeout(async()=>{await browser.runtime.sendMessage({type:"explain",from:"background",text:u.selectionText})},e?0:5e3);else if(u.menuItemId==="custom-pg")chrome.sidePanel.open({tabId:f.id}),setTimeout(async()=>{await browser.runtime.sendMessage({type:"custom",from:"background",text:u.selectionText})},e?0:5e3);else if(u.menuItemId==="save-page-pa"){console.log("右键菜单：开始保存当前页面",{tabId:f?.id,url:f?.url});try{statusIndicator.showSaveProgress("准备中","正在初始化保存过程..."),console.log("调用 saveCurrentPage 函数");const c=await saveCurrentPage();console.log("页面保存成功",c),statusIndicator.showSaveSuccess(c.title),await storageViewer.logStorageData("page_"),console.log(`已成功保存页面：${c.title}`)}catch(c){console.error("保存页面失败",c),statusIndicator.showSaveError(c instanceof Error?c.message:String(c))}}else u.menuItemId==="view-saved-pages-pa"&&(console.log("右键菜单：查看已保存的网页"),browser.tabs.create({url:browser.runtime.getURL("/options.html?route=/settings/saved-pages")}),setTimeout(()=>{browser.runtime.sendMessage({type:"navigate_to_saved_pages",from:"background"})},500))}),browser.commands.onCommand.addListener(u=>{switch(u){case"execute_side_panel":chrome.tabs.query({active:!0,currentWindow:!0},async f=>{const c=f[0];chrome.sidePanel.open({tabId:c.id})});break}}),a()},persistent:!0});function initPlugins(){}function print(t,...e){}const logger={debug:(...t)=>print(console.debug,...t),log:(...t)=>print(console.log,...t),warn:(...t)=>print(console.warn,...t),error:(...t)=>print(console.error,...t)};let result;try{result=definition.main(),result instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(t){throw logger.error("The background crashed on startup!"),t}const result$1=result;return result$1}();
_background;
