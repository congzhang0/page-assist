<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Assist APIå†…éƒ¨æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #333;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.debug {
            background-color: #2196F3;
        }
        button.debug:hover {
            background-color: #0b7dda;
        }
        pre {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            margin-top: 10px;
            max-height: 300px;
            overflow: auto;
        }
        .note {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin: 10px 0;
        }
        .error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 10px;
            margin: 10px 0;
        }
        .panel {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            margin-bottom: -1px;
        }
        .tab {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            background-color: #f8f9fa;
            margin-right: 5px;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
        }
        .tab-content {
            border: 1px solid #ddd;
            border-radius: 0 4px 4px 4px;
            padding: 15px;
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>Page Assist æ•°æ®æä¾›è€…APIå†…éƒ¨æµ‹è¯•</h1>
    
    <div class="note">
        <p>è¿™ä¸ªå·¥å…·è®¾è®¡ç”¨äºåœ¨Page Assistæ‰©å±•å†…éƒ¨æµ‹è¯•æ•°æ®æä¾›è€…APIåŠŸèƒ½ï¼Œé¿å…è·¨åŸŸé—®é¢˜ã€‚</p>
    </div>

    <div class="panel">
        <h2>1. ç¯å¢ƒæ£€æŸ¥</h2>
        <button id="checkEnvironment" class="debug">æ£€æŸ¥æ‰©å±•ç¯å¢ƒ</button>
        <button id="checkApiHandler" class="debug">æ£€æŸ¥APIå¤„ç†å‡½æ•°</button>
        <button id="injectMock" class="debug">æ³¨å…¥æ¨¡æ‹ŸAPIå¤„ç†å‡½æ•°</button>
        <div id="envResult"></div>
    </div>

    <div class="panel">
        <h2>2. APIåŠŸèƒ½æµ‹è¯•</h2>
        <div class="tabs">
            <div class="tab active" data-tab="basic">åŸºæœ¬æµ‹è¯•</div>
            <div class="tab" data-tab="advanced">é«˜çº§æµ‹è¯•</div>
        </div>
        
        <div class="tab-content active" data-tab="basic">
            <button id="testCount">è·å–é¡µé¢è®¡æ•°</button>
            <button id="testList">è·å–é¡µé¢åˆ—è¡¨</button>
            <button id="testTags">è·å–æ ‡ç­¾åˆ—è¡¨</button>
        </div>
        
        <div class="tab-content" data-tab="advanced">
            <p>è®¿é—®ä»¤ç‰Œ: <input type="text" id="accessToken" value="cmSL9iyrPfHAYpQx6qCdvtbBwKvBCL1m" style="width: 300px;"></p>
            <div>
                <label for="apiType">è¯·æ±‚ç±»å‹:</label>
                <select id="apiType">
                    <option value="count">count</option>
                    <option value="list">list</option>
                    <option value="get">get</option>
                    <option value="tags">tags</option>
                    <option value="sync">sync</option>
                    <option value="changes">changes</option>
                </select>
                <button id="testCustom">å‘é€è¯·æ±‚</button>
            </div>
            <div>
                <h3>è‡ªå®šä¹‰å‚æ•° (JSONæ ¼å¼):</h3>
                <textarea id="customParams" rows="5" style="width: 100%;" placeholder='{
    "entityType": "page",
    "query": { "filter": {} }
}'></textarea>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>3. æµ‹è¯•ç»“æœ</h2>
        <pre id="results">// æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</pre>
    </div>

    <div class="panel">
        <h2>4. è¯Šæ–­å’Œä¿®å¤</h2>
        <button id="installLogger" class="debug">å®‰è£…èƒŒæ™¯é¡µæ—¥å¿—å™¨</button>
        <button id="checkListeners" class="debug">æ£€æŸ¥æ¶ˆæ¯ç›‘å¬å™¨</button>
        <button id="checkConnectable" class="debug">æ£€æŸ¥externally_connectable</button>
        <button id="testMockApi" class="debug">æµ‹è¯•æ¨¡æ‹ŸAPI</button>
        <pre id="diagnosticResults">// è¯Šæ–­ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</pre>
    </div>

    <script>
        // è®¿é—®ä»¤ç‰Œ
        let ACCESS_TOKEN = 'cmSL9iyrPfHAYpQx6qCdvtbBwKvBCL1m';
        
        // å®¢æˆ·ç«¯ID
        const CLIENT_ID = 'client_internal_test_' + Math.random().toString(36).substring(2, 15);
        
        // æ˜¾ç¤ºç»“æœ
        function displayResult(result, elementId = 'results') {
            const resultsElement = document.getElementById(elementId);
            if (typeof result === 'object') {
                resultsElement.textContent = JSON.stringify(result, null, 2);
            } else {
                resultsElement.textContent = result;
            }
        }
        
        // åˆ›å»ºçŠ¶æ€ä¿¡æ¯
        function createStatusMessage(type, message) {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            return div;
        }
        
        // æ£€æŸ¥ç¯å¢ƒ
        async function checkEnvironment() {
            const envResultDiv = document.getElementById('envResult');
            envResultDiv.innerHTML = '';
            
            // æ£€æŸ¥chromeå¯¹è±¡
            if (typeof chrome === 'undefined') {
                envResultDiv.appendChild(createStatusMessage('error', 'âŒ chromeå¯¹è±¡ä¸å­˜åœ¨'));
                return false;
            }
            envResultDiv.appendChild(createStatusMessage('success', 'âœ… chromeå¯¹è±¡å­˜åœ¨'));
            
            // æ£€æŸ¥chrome.runtime
            if (!chrome.runtime) {
                envResultDiv.appendChild(createStatusMessage('error', 'âŒ chrome.runtimeä¸å­˜åœ¨'));
                return false;
            }
            envResultDiv.appendChild(createStatusMessage('success', 'âœ… chrome.runtimeå­˜åœ¨'));
            
            // æ£€æŸ¥chrome.runtime.id
            if (!chrome.runtime.id) {
                envResultDiv.appendChild(createStatusMessage('error', 'âŒ ä¸åœ¨æ‰©å±•ç¯å¢ƒä¸­è¿è¡Œ'));
                return false;
            }
            envResultDiv.appendChild(createStatusMessage('success', `âœ… æ­£åœ¨æ‰©å±•ç¯å¢ƒä¸­è¿è¡Œ (ID: ${chrome.runtime.id})`));
            
            // æ£€æŸ¥æ¶ˆæ¯ç›‘å¬å™¨
            try {
                if (chrome.runtime.onMessage.hasListeners()) {
                    envResultDiv.appendChild(createStatusMessage('success', 'âœ… æœ‰å†…éƒ¨æ¶ˆæ¯ç›‘å¬å™¨'));
                } else {
                    envResultDiv.appendChild(createStatusMessage('error', 'âŒ æ²¡æœ‰å†…éƒ¨æ¶ˆæ¯ç›‘å¬å™¨'));
                }
                
                if (chrome.runtime.onMessageExternal.hasListeners()) {
                    envResultDiv.appendChild(createStatusMessage('success', 'âœ… æœ‰å¤–éƒ¨æ¶ˆæ¯ç›‘å¬å™¨'));
                } else {
                    envResultDiv.appendChild(createStatusMessage('error', 'âŒ æ²¡æœ‰å¤–éƒ¨æ¶ˆæ¯ç›‘å¬å™¨'));
                }
            } catch (e) {
                envResultDiv.appendChild(createStatusMessage('error', `âŒ æ£€æŸ¥ç›‘å¬å™¨æ—¶å‡ºé”™: ${e.message}`));
            }
            
            return true;
        }
        
        // æ£€æŸ¥APIå¤„ç†å‡½æ•°
        async function checkApiHandler() {
            try {
                let backgroundPage = null;
                
                // å°è¯•è·å–èƒŒæ™¯é¡µ
                if (chrome.runtime.getBackgroundPage) {
                    backgroundPage = await new Promise(resolve => {
                        chrome.runtime.getBackgroundPage(bg => resolve(bg));
                    });
                }
                
                if (!backgroundPage) {
                    return "âŒ æ— æ³•è·å–èƒŒæ™¯é¡µï¼Œå¯èƒ½æ˜¯å› ä¸ºåœ¨Service Workerä¸­è¿è¡Œ";
                }
                
                // æ£€æŸ¥èƒŒæ™¯é¡µä¸­æ˜¯å¦æœ‰APIå¤„ç†å‡½æ•°
                const results = [];
                
                if (typeof backgroundPage.handleDataProviderRequest === 'function') {
                    results.push('âœ… handleDataProviderRequestå‡½æ•°å­˜åœ¨');
                } else {
                    results.push('âŒ handleDataProviderRequestå‡½æ•°ä¸å­˜åœ¨');
                    
                    // æŸ¥æ‰¾å¯èƒ½çš„å¤„ç†å‡½æ•°
                    const possibleHandlers = Object.keys(backgroundPage).filter(key => 
                        typeof backgroundPage[key] === 'function' && 
                        (key.toLowerCase().includes('api') || 
                         key.toLowerCase().includes('provider') || 
                         key.toLowerCase().includes('data') || 
                         key.toLowerCase().includes('handle') || 
                         key.toLowerCase().includes('request'))
                    );
                    
                    if (possibleHandlers.length > 0) {
                        results.push('ğŸ” å¯èƒ½çš„APIå¤„ç†å‡½æ•°: ' + possibleHandlers.join(', '));
                    } else {
                        results.push('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•å¯èƒ½çš„APIå¤„ç†å‡½æ•°');
                    }
                }
                
                return results.join('\n');
            } catch (e) {
                return `âŒ æ£€æŸ¥APIå¤„ç†å‡½æ•°æ—¶å‡ºé”™: ${e.message}`;
            }
        }
        
        // æ³¨å…¥æ¨¡æ‹ŸAPIå¤„ç†å‡½æ•°
        async function injectMockApiHandler() {
            try {
                let backgroundPage = null;
                
                // å°è¯•è·å–èƒŒæ™¯é¡µ
                if (chrome.runtime.getBackgroundPage) {
                    backgroundPage = await new Promise(resolve => {
                        chrome.runtime.getBackgroundPage(bg => resolve(bg));
                    });
                }
                
                if (!backgroundPage) {
                    return "âŒ æ— æ³•è·å–èƒŒæ™¯é¡µï¼Œå¯èƒ½æ˜¯å› ä¸ºåœ¨Service Workerä¸­è¿è¡Œ";
                }
                
                // å‘èƒŒæ™¯é¡µæ³¨å…¥æ¨¡æ‹ŸAPIå¤„ç†å‡½æ•°
                if (typeof backgroundPage.handleDataProviderRequest !== 'function') {
                    backgroundPage.handleDataProviderRequest = async function(request, sender) {
                        console.log('ğŸ“¡ æ¨¡æ‹Ÿçš„handleDataProviderRequestè¢«è°ƒç”¨:', request);
                        
                        // éªŒè¯ä»¤ç‰Œ
                        if (!request.accessToken || request.accessToken !== ACCESS_TOKEN) {
                            return {
                                success: false,
                                error: {
                                    code: 'auth_invalid_token',
                                    message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ'
                                },
                                meta: {
                                    serverTime: Date.now()
                                }
                            };
                        }
                        
                        // æ ¹æ®è¯·æ±‚ç±»å‹è¿”å›æ¨¡æ‹Ÿå“åº”
                        switch(request.type) {
                            case 'count':
                                return {
                                    success: true,
                                    data: {
                                        count: 42 // æ¨¡æ‹Ÿæ•°æ®
                                    },
                                    meta: {
                                        serverTime: Date.now()
                                    }
                                };
                                
                            case 'list':
                                return {
                                    success: true,
                                    data: [
                                        {
                                            id: 'page_1',
                                            title: 'æ¨¡æ‹Ÿé¡µé¢ 1',
                                            url: 'https://example.com/page1',
                                            tags: ['æ ‡ç­¾1', 'æ ‡ç­¾2'],
                                            createdAt: Date.now() - 86400000,
                                            updatedAt: Date.now() - 3600000
                                        },
                                        {
                                            id: 'page_2',
                                            title: 'æ¨¡æ‹Ÿé¡µé¢ 2',
                                            url: 'https://example.com/page2',
                                            tags: ['æ ‡ç­¾1'],
                                            createdAt: Date.now() - 172800000,
                                            updatedAt: Date.now() - 7200000
                                        }
                                    ],
                                    meta: {
                                        total: 2,
                                        page: 1,
                                        pageSize: 10,
                                        pageCount: 1,
                                        serverTime: Date.now()
                                    }
                                };
                                
                            case 'get':
                                return {
                                    success: true,
                                    data: {
                                        id: request.id || 'page_1',
                                        title: 'æ¨¡æ‹Ÿé¡µé¢è¯¦æƒ…',
                                        url: 'https://example.com/page-detail',
                                        content: 'è¿™æ˜¯æ¨¡æ‹Ÿçš„é¡µé¢å†…å®¹',
                                        html: '<div>è¿™æ˜¯æ¨¡æ‹Ÿçš„HTMLå†…å®¹</div>',
                                        tags: ['æ ‡ç­¾1', 'æ ‡ç­¾2', 'æ ‡ç­¾3'],
                                        createdAt: Date.now() - 86400000,
                                        updatedAt: Date.now() - 3600000
                                    },
                                    meta: {
                                        serverTime: Date.now()
                                    }
                                };
                                
                            case 'tags':
                                return {
                                    success: true,
                                    data: ['æ ‡ç­¾1', 'æ ‡ç­¾2', 'æ ‡ç­¾3', 'é‡è¦', 'å¾…è¯»'],
                                    meta: {
                                        serverTime: Date.now()
                                    }
                                };
                                
                            case 'sync':
                            case 'changes':
                                return {
                                    success: true,
                                    data: {
                                        changes: [
                                            {
                                                id: 'page_1',
                                                changeType: 'update',
                                                timestamp: Date.now() - 3600000,
                                                data: {
                                                    id: 'page_1',
                                                    title: 'æ›´æ–°çš„æ¨¡æ‹Ÿé¡µé¢',
                                                    tags: ['æ ‡ç­¾1', 'æ–°æ ‡ç­¾']
                                                }
                                            }
                                        ],
                                        hasMore: false
                                    },
                                    meta: {
                                        syncTime: Date.now(),
                                        serverTime: Date.now()
                                    }
                                };
                                
                            default:
                                return {
                                    success: false,
                                    error: {
                                        code: 'invalid_request_type',
                                        message: `ä¸æ”¯æŒçš„è¯·æ±‚ç±»å‹: ${request.type}`
                                    },
                                    meta: {
                                        serverTime: Date.now()
                                    }
                                };
                        }
                    };
                    
                    // æ£€æŸ¥å¤–éƒ¨æ¶ˆæ¯ç›‘å¬å™¨
                    if (!chrome.runtime.onMessageExternal.hasListeners()) {
                        chrome.runtime.onMessageExternal.addListener((request, sender, sendResponse) => {
                            console.log('ğŸ“© æ”¶åˆ°å¤–éƒ¨æ¶ˆæ¯:', request);
                            
                            if (request && request.accessToken) {
                                backgroundPage.handleDataProviderRequest(request, sender)
                                    .then(response => sendResponse(response))
                                    .catch(error => sendResponse({
                                        success: false,
                                        error: {
                                            code: 'internal_error',
                                            message: error.message
                                        }
                                    }));
                                return true; // å¼‚æ­¥å‘é€å“åº”
                            }
                        });
                    }
                    
                    return "âœ… æ¨¡æ‹ŸAPIå¤„ç†å‡½æ•°æ³¨å…¥æˆåŠŸ";
                } else {
                    return "â„¹ï¸ handleDataProviderRequestå‡½æ•°å·²å­˜åœ¨ï¼Œæ— éœ€æ³¨å…¥";
                }
            } catch (e) {
                return `âŒ æ³¨å…¥æ¨¡æ‹ŸAPIå¤„ç†å‡½æ•°æ—¶å‡ºé”™: ${e.message}`;
            }
        }
        
        // å‘é€APIè¯·æ±‚
        async function sendApiRequest(request) {
            return new Promise((resolve, reject) => {
                // æ›´æ–°è®¿é—®ä»¤ç‰Œ
                ACCESS_TOKEN = document.getElementById('accessToken').value;
                
                // æ„å»ºå®Œæ•´è¯·æ±‚
                const fullRequest = {
                    ...request,
                    accessToken: ACCESS_TOKEN,
                    clientId: CLIENT_ID
                };
                
                console.log('ğŸ“¤ å‘é€è¯·æ±‚:', fullRequest);
                
                // å‘é€æ¶ˆæ¯
                chrome.runtime.sendMessage(fullRequest, response => {
                    if (chrome.runtime.lastError) {
                        reject(new Error(`APIè¯·æ±‚å¤±è´¥: ${chrome.runtime.lastError.message}`));
                    } else {
                        console.log('ğŸ“¥ æ”¶åˆ°å“åº”:', response);
                        resolve(response);
                    }
                });
            });
        }
        
        // APIæµ‹è¯•å‡½æ•°
        async function testCount() {
            try {
                const response = await sendApiRequest({
                    type: 'count',
                    entityType: 'page',
                    query: { filter: {} }
                });
                displayResult(response);
            } catch (error) {
                displayResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
        
        async function testList() {
            try {
                const response = await sendApiRequest({
                    type: 'list',
                    entityType: 'page',
                    query: {
                        filter: {},
                        page: 1,
                        pageSize: 10
                    }
                });
                displayResult(response);
            } catch (error) {
                displayResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
        
        async function testTags() {
            try {
                const response = await sendApiRequest({
                    type: 'tags',
                    entityType: 'page'
                });
                displayResult(response);
            } catch (error) {
                displayResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
        
        async function testCustomRequest() {
            try {
                const type = document.getElementById('apiType').value;
                let customParams = {};
                
                // è§£æè‡ªå®šä¹‰å‚æ•°
                const customParamsText = document.getElementById('customParams').value.trim();
                if (customParamsText) {
                    try {
                        customParams = JSON.parse(customParamsText);
                    } catch (e) {
                        throw new Error(`è‡ªå®šä¹‰å‚æ•°JSONè§£æé”™è¯¯: ${e.message}`);
                    }
                } else {
                    // é»˜è®¤å‚æ•°
                    switch (type) {
                        case 'count':
                        case 'list':
                            customParams = {
                                entityType: 'page',
                                query: { filter: {} }
                            };
                            break;
                        case 'get':
                            customParams = {
                                entityType: 'page',
                                id: 'page_1'
                            };
                            break;
                        case 'tags':
                            customParams = {
                                entityType: 'page'
                            };
                            break;
                        case 'sync':
                        case 'changes':
                            customParams = {
                                entityType: 'page',
                                sync: {
                                    lastSyncTime: 0,
                                    fullSync: true
                                }
                            };
                            break;
                    }
                }
                
                // æ„å»ºå®Œæ•´è¯·æ±‚
                const request = {
                    type,
                    ...customParams
                };
                
                const response = await sendApiRequest(request);
                displayResult(response);
            } catch (error) {
                displayResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
        
        // å®‰è£…èƒŒæ™¯é¡µæ—¥å¿—å™¨
        async function installBackgroundLogger() {
            try {
                let backgroundPage = null;
                
                // å°è¯•è·å–èƒŒæ™¯é¡µ
                if (chrome.runtime.getBackgroundPage) {
                    backgroundPage = await new Promise(resolve => {
                        chrome.runtime.getBackgroundPage(bg => resolve(bg));
                    });
                }
                
                if (!backgroundPage) {
                    return "âŒ æ— æ³•è·å–èƒŒæ™¯é¡µï¼Œå¯èƒ½æ˜¯å› ä¸ºåœ¨Service Workerä¸­è¿è¡Œ";
                }
                
                // ä»å½“å‰é¡µé¢è·å–background-page-logger.jsçš„å†…å®¹
                const response = await fetch('background-page-logger.js');
                if (!response.ok) {
                    return `âŒ æ— æ³•è·å–background-page-logger.js: ${response.statusText}`;
                }
                
                const loggerCode = await response.text();
                
                // åœ¨èƒŒæ™¯é¡µä¸­æ‰§è¡Œä»£ç 
                try {
                    backgroundPage.eval(loggerCode);
                    return "âœ… èƒŒæ™¯é¡µæ—¥å¿—å™¨å®‰è£…æˆåŠŸ";
                } catch (e) {
                    return `âŒ åœ¨èƒŒæ™¯é¡µä¸­æ‰§è¡Œä»£ç å¤±è´¥: ${e.message}`;
                }
            } catch (e) {
                return `âŒ å®‰è£…èƒŒæ™¯é¡µæ—¥å¿—å™¨æ—¶å‡ºé”™: ${e.message}`;
            }
        }
        
        // æ£€æŸ¥æ¶ˆæ¯ç›‘å¬å™¨
        async function checkMessageListeners() {
            try {
                let backgroundPage = null;
                
                // å°è¯•è·å–èƒŒæ™¯é¡µ
                if (chrome.runtime.getBackgroundPage) {
                    backgroundPage = await new Promise(resolve => {
                        chrome.runtime.getBackgroundPage(bg => resolve(bg));
                    });
                }
                
                if (!backgroundPage) {
                    return "âŒ æ— æ³•è·å–èƒŒæ™¯é¡µï¼Œå¯èƒ½æ˜¯å› ä¸ºåœ¨Service Workerä¸­è¿è¡Œ";
                }
                
                // è°ƒç”¨èƒŒæ™¯é¡µçš„inspectMessageListenerså‡½æ•°
                if (typeof backgroundPage.inspectMessageListeners === 'function') {
                    backgroundPage.inspectMessageListeners();
                    return "âœ… å·²åœ¨èƒŒæ™¯é¡µæ§åˆ¶å°ä¸­æ˜¾ç¤ºç›‘å¬å™¨ä¿¡æ¯";
                } else {
                    return "âŒ èƒŒæ™¯é¡µä¸­æœªæ‰¾åˆ°inspectMessageListenerså‡½æ•°ï¼Œè¯·å…ˆå®‰è£…èƒŒæ™¯é¡µæ—¥å¿—å™¨";
                }
            } catch (e) {
                return `âŒ æ£€æŸ¥æ¶ˆæ¯ç›‘å¬å™¨æ—¶å‡ºé”™: ${e.message}`;
            }
        }
        
        // æ£€æŸ¥externally_connectableé…ç½®
        async function checkExternallyConnectable() {
            try {
                let backgroundPage = null;
                
                // å°è¯•è·å–èƒŒæ™¯é¡µ
                if (chrome.runtime.getBackgroundPage) {
                    backgroundPage = await new Promise(resolve => {
                        chrome.runtime.getBackgroundPage(bg => resolve(bg));
                    });
                }
                
                if (!backgroundPage) {
                    return "âŒ æ— æ³•è·å–èƒŒæ™¯é¡µï¼Œå¯èƒ½æ˜¯å› ä¸ºåœ¨Service Workerä¸­è¿è¡Œ";
                }
                
                // è°ƒç”¨èƒŒæ™¯é¡µçš„checkExternallyConnectableå‡½æ•°
                if (typeof backgroundPage.checkExternallyConnectable === 'function') {
                    backgroundPage.checkExternallyConnectable();
                    return "âœ… å·²åœ¨èƒŒæ™¯é¡µæ§åˆ¶å°ä¸­æ˜¾ç¤ºexternally_connectableé…ç½®ä¿¡æ¯";
                } else {
                    return "âŒ èƒŒæ™¯é¡µä¸­æœªæ‰¾åˆ°checkExternallyConnectableå‡½æ•°ï¼Œè¯·å…ˆå®‰è£…èƒŒæ™¯é¡µæ—¥å¿—å™¨";
                }
            } catch (e) {
                return `âŒ æ£€æŸ¥externally_connectableé…ç½®æ—¶å‡ºé”™: ${e.message}`;
            }
        }
        
        // æµ‹è¯•æ¨¡æ‹ŸAPI
        async function testMockApi() {
            try {
                let backgroundPage = null;
                
                // å°è¯•è·å–èƒŒæ™¯é¡µ
                if (chrome.runtime.getBackgroundPage) {
                    backgroundPage = await new Promise(resolve => {
                        chrome.runtime.getBackgroundPage(bg => resolve(bg));
                    });
                }
                
                if (!backgroundPage) {
                    return "âŒ æ— æ³•è·å–èƒŒæ™¯é¡µï¼Œå¯èƒ½æ˜¯å› ä¸ºåœ¨Service Workerä¸­è¿è¡Œ";
                }
                
                // è°ƒç”¨èƒŒæ™¯é¡µçš„testDataProviderAPIå‡½æ•°
                if (typeof backgroundPage.testDataProviderAPI === 'function') {
                    backgroundPage.testDataProviderAPI();
                    return "âœ… å·²åœ¨èƒŒæ™¯é¡µæ§åˆ¶å°ä¸­è¿è¡Œæµ‹è¯•";
                } else if (typeof backgroundPage.quickTest === 'function') {
                    backgroundPage.quickTest();
                    return "âœ… å·²åœ¨èƒŒæ™¯é¡µæ§åˆ¶å°ä¸­è¿è¡Œæµ‹è¯•";
                } else {
                    return "âŒ èƒŒæ™¯é¡µä¸­æœªæ‰¾åˆ°æµ‹è¯•å‡½æ•°ï¼Œè¯·å…ˆå®‰è£…èƒŒæ™¯é¡µæ—¥å¿—å™¨";
                }
            } catch (e) {
                return `âŒ æµ‹è¯•æ¨¡æ‹ŸAPIæ—¶å‡ºé”™: ${e.message}`;
            }
        }
        
        // åˆ‡æ¢é€‰é¡¹å¡
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    // æ¿€æ´»é€‰é¡¹å¡
                    document.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    tab.classList.add('active');
                    
                    // æ˜¾ç¤ºå¯¹åº”å†…å®¹
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.add('active');
                });
            });
        }
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®é€‰é¡¹å¡
            setupTabs();
            
            // ç¯å¢ƒæ£€æŸ¥
            document.getElementById('checkEnvironment').addEventListener('click', async () => {
                await checkEnvironment();
            });
            
            document.getElementById('checkApiHandler').addEventListener('click', async () => {
                const result = await checkApiHandler();
                displayResult(result, 'envResult');
            });
            
            document.getElementById('injectMock').addEventListener('click', async () => {
                const result = await injectMockApiHandler();
                displayResult(result, 'envResult');
            });
            
            // APIæµ‹è¯•
            document.getElementById('testCount').addEventListener('click', testCount);
            document.getElementById('testList').addEventListener('click', testList);
            document.getElementById('testTags').addEventListener('click', testTags);
            document.getElementById('testCustom').addEventListener('click', testCustomRequest);
            
            // è¯Šæ–­å’Œä¿®å¤
            document.getElementById('installLogger').addEventListener('click', async () => {
                const result = await installBackgroundLogger();
                displayResult(result, 'diagnosticResults');
            });
            
            document.getElementById('checkListeners').addEventListener('click', async () => {
                const result = await checkMessageListeners();
                displayResult(result, 'diagnosticResults');
            });
            
            document.getElementById('checkConnectable').addEventListener('click', async () => {
                const result = await checkExternallyConnectable();
                displayResult(result, 'diagnosticResults');
            });
            
            document.getElementById('testMockApi').addEventListener('click', async () => {
                const result = await testMockApi();
                displayResult(result, 'diagnosticResults');
            });
            
            // è‡ªåŠ¨è¿è¡Œç¯å¢ƒæ£€æŸ¥
            checkEnvironment();
        });
    </script>
</body>
</html> 